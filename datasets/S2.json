{"kind":"concurrent","endContent":"# 5000x faster CRDTs: An Adventure in Optimization\n\n<span class=post-meta>July 31 2021</span>\n\nA few years ago I was really bothered by an academic paper.\n\nSome researchers in France put together a comparison showing lots of ways you could implement realtime collaborative editing (like Google Docs). They implemented lots of algorithms - CRDTs and OT algorithms and stuff. And they benchmarked them all to see how they perform. (Cool!!) Some algorithms worked reasonably well. But others took upwards of 3 seconds to process simple paste operations from their editing sessions. Yikes!\n\nWhich algorithm was that? Well, this is awkward but .. it was mine. I mean, I didn't invent it - but it was the algorithm I was using for ShareJS. The algorithm we used for Google Wave. The algorithm which - hang on - I knew for a fact didn't take 3 seconds to process large paste events. Whats going on here?\n\nI took a closer look at the paper. In their implementation when a user pasted a big chunk of text (like 1000 characters), instead of creating 1 operation with 1000 characters, their code split the insert into 1000 individual operations. And each of those operations needed to be processed separately. Do'h - of course it'll be slow if you do that! This isn't a problem with the operational transformation algorithm. This is just a problem with *their particular implementation*.\n\nThe infuriating part was that several people sent me links to the paper and (pointedly) asked me what I think about it. Written up as a Published Science Paper, these speed comparisons seemed like a Fact About The Universe. And not what they really were - implementation details of some java code, written by a probably overstretched grad student. One of a whole bunch of implementations that they needed to code up.\n\n\"Nooo! The peer reviewed science isn't right everybody! Please believe me!\". But I didn't have a published paper justifying my claims. I had working code but it felt like none of the smart computer science people cared about that. Who was I? I was nobody.\n\n---\n\nEven talking about this stuff we have a language problem. We describe each system as an \"algorithm\". Jupiter is an Algorithm. RGA is an Algorithm. But really there are two very separate aspects:\n\n1. The black-box *behaviour* of concurrent edits. When two clients edit the same region of text at the same time, what happens? Are they merged, and if so in what order? What are the rules?\n2. The white-box *implementation* of the system. What programming language are we using? What data structures? How well optimized is the code?\n\nIf some academic's code runs slowly, what does that actually teach us? Maybe it's like tests. A passing test suite *suggests*, but can never *prove* that there are no bugs. Likewise a slow implementation suggests, but can never prove that every implementation of the system will be slow. If you wait long enough, somebody will find more bugs. And, maybe, someone out there can design a faster implementation.\n\nYears ago I translated my old text OT code into C, Javascript, Go, Rust and Swift. Each implementation has the same behaviour, and the same algorithm. But the performance is not even close. In javascript my transform function ran about 100 000 times per second. Not bad! But the same function in C does 20M iterations per second. That's 200x faster. Wow!\n\nWere the academics testing a slow version or the fast version of this code? Maybe, without noticing, they had fast versions of some algorithms and slow versions of others. It's impossible to tell from the paper!\n\n\n## Making CRDTs fast\n\nSo as you may know, I've been getting interested in CRDTs lately. For the uninitiated, CRDTs [(Conflict-Free Replicated Data types)](https://en.wikipedia.org/wiki/Conflict-free_replicated_data_type) are fancy programming tools which let multiple users edit the same data at the same time. They let you work locally with no lag. (You don't even have to be online). And when you do sync up with other users & devices, everything just magically syncs up and becomes eventually consistent. The best part of CRDTs is that they can do all that without even needing a centralized computer in the cloud to monitor and control everything.\n\nI want Google Docs without google. I want my apps to seamlessly share data between all my devices, without me needing to rely on some [flakey startup](https://ourincrediblejourney.tumblr.com/)'s servers to still be around in another decade. I think they're the [future of collaborative editing](https://josephg.com/blog/crdts-are-the-future/). And maybe the future of all software - but I'm not ready to talk about that yet.\n\nBut most CRDTs you read about in academic papers are crazy slow. A decade ago I decided to stop reading academic papers and dismissed them. I assumed CRDTs had some inherent problem. A GUID for every character? Nought but madness comes from those strange lands! But - and this is awkward to admit - I think I've been making the same mistake as those researchers. I was reading papers which described the *behaviour* of different systems. And I assumed that meant we knew how the best way to *implement* those systems. And wow, I was super wrong.\n\nHow wrong? Well. Running [this editing trace](https://github.com/automerge/automerge-perf/), [Automerge](https://github.com/automerge/automerge/) (a popular CRDT, written by [a popular researcher](https://martin.kleppmann.com/)) takes nearly 5 minutes to run. I have a [new implementation](https://github.com/josephg/diamond-types) that can process the same editing trace in 56 milliseconds. Thats 0.056 seconds, which is over 5000x faster. It's the largest speed up I've ever gotten from optimization work - and I'm utterly delighted by it.\n\nLets talk about why automerge is currently slow, and I'll take you through all the steps toward making it super fast.\n\nWait, no. First we need to start with:\n\n\n### What is automerge?\n\nAutomerge is a library to help you do collaborative editing. It's written by Martin Kleppmann, who's a little bit famous from his book and [excellent talks](https://martin.kleppmann.com/2020/07/06/crdt-hard-parts-hydra.html). Automerge is based on an algorithm called RGA, which you can read about in an academic paper if you're into that sort of thing.\n\nMartin explains automerge far better than I will in this talk from 2020:\n\n<iframe class=\"youtube\" src=\"https://www.youtube-nocookie.com/embed/x7drE24geUw?start=1237\" title=\"YouTube video player\" frameborder=\"0\" allow=\"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture\" allowfullscreen></iframe>\n\nAutomerge (and Yjs and other CRDTs) think of a shared document as a list of characters. Each character in the document gets a unique ID, and whenever you insert into the document, you name what you're inserting after.\n\nImagine I type \"abc\" into an empty document. Automerge creates 3 items:\n\n- Insert *'a'* id `(seph, 0)` after `ROOT`\n  - Insert *'b'* id `(seph, 1)` after `(seph, 0)`\n    - Insert *'c'* id `(seph, 2)` after `(seph, 1)`\n\nWe can draw this as a tree!\n\n![tree with \"abc\" inserts](automerge1.drawio.svg)\n\nLets say Mike inserts an 'X' between *a* and *b*, so we get \"aXbc\". Then we have:\n\n- Insert *'a'* id `(seph, 0)` after `ROOT`\n  - Insert *'X'* id `(mike, 0)` after `(seph, 0)`\n  - Insert *'b'* id `(seph, 1)` after `(seph, 0)`\n    - Insert *'c'* id `(seph, 2)` after `(seph, 1)`\n\n![tree with \"aXbc\"](automerge2.drawio.svg)\n\nNote the 'X' and 'b' both share the same parent. This will happen when users type concurrently in the same location in the document. But how do we figure out which character goes first? We could just sort using their agent IDs or something. But argh, if we do that the document could end up as *abcX*, even though Mike inserted *X* before the *b*. That would be really confusing.\n\nAutomerge (RGA) solves this with a neat hack. It adds an extra integer to each item called a *sequence number*. Whenever you insert something, you set the new item's sequence number to be 1 bigger than the biggest sequence number you've ever seen:\n\n- Insert *'a'* id `(seph, 0)` after `ROOT`, seq: *0*\n  - Insert *'X'* id `(mike, 0)` after `(seph, 0)`, seq: *3*\n  - Insert *'b'* id `(seph, 1)` after `(seph, 0)`, seq: *1*\n    - Insert *'c'* id `(seph, 2)` after `(seph, 1)`, seq: *2*\n\nThis is the algorithmic version of \"Wow I saw a sequence number, and it was *this big!*\" \"Yeah? Mine is *even bigger!*\"\n\nThe rule is that children are sorted first based on their sequence numbers (bigger sequence number first). If the sequence numbers match, the changes must be concurrent. In that case we can sort them arbitrarily based on their agent IDs. (We do it this way so all peers end up with the same resulting document.)\n\nYjs - which we'll see more of later - implements a CRDT called YATA. YATA is identical to RGA, except that it solves this problem with a slightly different hack. But the difference isn't really important here.\n\nAutomerge (RGA)'s *behaviour* is defined by this algorithm:\n\n- Build the tree, connecting each item to its parent\n- When an item has multiple children, sort them by sequence number then by their ID.\n- The resulting list (or text document) can be made by flattening the tree with a depth-first traversal.\n\nSo how should you *implement* automerge? The automerge library does it in the obvious way, which is to store all the data as a tree. (At least I think so - after typing \"abc\" [this is automerge's internal state](https://gist.github.com/josephg/0522c4aec5021cc1dddb60e778828dbe). Uh, uhm, I have no idea whats going on here. And what are all those Uint8Arrays doing all over the place? Whatever.) The automerge library works by building a tree of items.\n\nFor a simple benchmark, I'm going to test automerge using [an editing trace Martin himself made](https://github.com/automerge/automerge-perf/). This is a character by character recording of Martin typing up an academic paper. There aren't any concurrent edits in this trace, but users almost never actually put their cursors at exactly the same place and type anyway, so I'm not too worried about that. I'm also only counting the time taken to apply this trace *locally*, which isn't ideal but it'll do. Kevin Jahns (Yjs's author) has a much more [extensive benchmarking suite here](https://github.com/dmonad/crdt-benchmarks) if you're into that sort of thing. All the benchmarks here are done on my chonky ryzen 5800x workstation, with Nodejs v16.1 and rust 1.52 when that becomes appropriate. (Spoilers!)\n\nThe editing trace has 260 000 edits, and the final document size is about 100 000 characters.\n\nAs I said above, automerge takes a little under 5 minutes to process this trace. Thats just shy of 900 edits per second, which is probably fine. But by the time it's done, automerge is using 880 MB of RAM. Whoa! That's 10kb of ram *per key press*. At peak, automerge was using 2.6 GB of RAM!\n\nTo get a sense of how much overhead there is, I'll compare this to [a baseline benchmark](https://gist.github.com/josephg/13efc1444660c07870fcbd0b3e917638#file-js_baseline-js) where we just splice all the edits directly into a javascript string. This throws away all the information we need to do collaborative editing, but it gives us a sense of how fast javascript is capable of going. It turns out javascript running on V8 is *fast*:\n\n| Test                              | Time taken | RAM usage |\n|:--------------------------        | ----------:| ---------:|\n| **automerge (v1.0.0-preview2)**   |  291s      | 880 MB    |\n| *Plain string edits in JS*        | 0.61s      | 0.1 MB    |\n\nThis is a chart showing the time taken to process each operation throughout the test, averaged in groups of 1000 operations. I think those spikes are V8's garbage collector trying to free up memory.\n\n![automerge performance chart](am_perf1.svg)\n\nIn the slowest spike near the end, a single edit took *1.8 seconds* to process. Oof. In a real application, the whole app (or browser tab) would freeze up for a couple of seconds sometimes while you're in the middle of typing.\n\nThe chart is easier to read when we average everything out a bit and zoom the Y axis. We can see the average performance gets gradually (roughly linearly) worse over time.\n\n![automerge performance chart smoothed out](am_perf1_smooth.svg)\n\n### Why is automerge slow though?\n\nAutomerge is slow for a whole slew of reasons:\n\n1. Automerge's core tree based data structure gets big and slow as the document grows.\n2. Automerge makes heavy use of [Immutablejs](https://immutable-js.github.io/). Immutablejs is a library which gives you clojure-like copy-on-write semantics for javascript objects. This is a cool set of functionality, but the V8 optimizer & GC struggles to optimize code that uses immutablejs. As a result, it increases memory usage and decreases performance.\n3. Automerge treats each inserted character as a separate item. Remember that paper I talked about earlier, where copy+paste operations are slow? Automerge does that too!\n\nAutomerge was just never written with performance in mind. Their team is working on a replacement [rust implementation of the algorithm](https://github.com/automerge/automerge-rs/) to run through wasm, but at the time of writing it hasn't landed yet. I got the master branch working, but they have some kinks to work out before it's ready. Switching to the automerge-rs backend doesn't make average performance in this test any faster. (Although it does halve memory usage and smooth out performance.)\n\n---\n\nThere's an old saying with performance tuning:\n\n> You can't make the computer faster. You can only make it do less work.\n\nHow do we make the computer do less work here? There's lots of performance wins to be had from going through the code and improving lots of small things. But the automerge team has the right approach. It's always best to start with macro optimizations. Fix the core algorithm and data structures before moving to optimizing individual methods. There's no point optimizing a function when you're about to throw it away in a rewrite.\n\nBy far, Automerge's biggest problem is its complex tree based data structure. And we can replace it with something faster.\n\n\n## Improving the data structure\n\nLuckily, there's a better way to implement CRDTs, pioneered in [Yjs](https://github.com/yjs/yjs). Yjs is another (competing) opensource CRDT implementation made by Kevin Jahns. It's fast, well documented and well made. If I were going to build software which supports collaborative editing today, I'd use Yjs.\n\nYjs doesn't need a whole blog post talking about how to make it fast because it's already pretty fast, as we'll see soon. It got there by using a clever, obvious data structure \"trick\" that I don't think anyone else in the field has noticed. Instead of implementing the CRDT as a tree like automerge does:\n\n```javascript\nstate = {\n  { item: 'a', id: ['seph', 0], seq: 0, children: [\n    { item: 'X', id, seq, children: []},\n    { item: 'b', id, seq, children: [\n      { item: 'c', id, seq, children: []}\n    ]}\n  ]}\n}\n```\n\nYjs just puts all the items in a single flat list:\n\n```javascript\nstate = [\n  { item: 'a', id: ['seph', 0], seq: 0, parent: null },\n  { item: 'X', id, seq, parent: ['seph', 0] },\n  { item: 'b', id, seq, parent: ['seph', 0] },\n  { item: 'c', id, seq, parent: [..] }\n]\n```\n\nThat looks simple, but how do you insert a new item into a list? With automerge it's easy:\n\n1. Find the parent item\n2. Insert the new item into the right location in the parents' list of children\n\nBut with this list approach it's more complicated:\n\n1. Find the parent item\n2. Starting right after the parent item, iterate through the list until we find the location where the new item should be inserted (?)\n3. Insert it there, splicing into the array\n\nEssentially, this approach is just a fancy insertion sort. We're implementing a list CRDT with a list. Genius!\n\nThis sounds complicated - how do you figure out where the new item should go? But it's complicated in the same way *math* is complicated. It's hard to understand, but once you understand it, you can implement the whole insert function in about 20 lines of code:\n\n(But don't be alarmed if this looks confusing - we could probably fit everyone on the planet who understands this code today into a small meeting room.)\n\n```javascript\nconst automergeInsert = (doc, newItem) => {\n  const parentIdx = findItem(doc, newItem.parent) // (1)\n\n  // Scan to find the insert location\n  let i\n  for (i = parentIdx + 1; i < doc.content.length; i++) {\n    let o = doc.content[i]\n    if (newItem.seq > o.seq) break // Optimization.\n    let oparentIdx = findItem(doc, o.parent)\n\n    // Should we insert here? (Warning: Black magic part)\n    if (oparentIdx < parentIdx\n      || (oparentIdx === parentIdx\n        && newItem.seq === o.seq\n        && newItem.id[0] < o.id[0])\n    ) break\n  }\n  // We've found the position. Insert at position *i*.\n  doc.content.splice(i, 0, newItem) // (2)\n\n  // .. And do various bookkeeping.\n}\n```\n\nI implemented both Yjs's CRDT (YATA) and Automerge using this approach in my experimental [*reference-crdts*](https://github.com/josephg/reference-crdts/blob/main/crdts.ts) codebase. [Here's the insert function, with a few more comments](https://github.com/josephg/reference-crdts/blob/fed747255df9d457e11f36575de555b39f07e909/crdts.ts#L401-L459). The Yjs version of this function is in the same file, if you want to have a look. Despite being very different papers, the logic for inserting is almost identical. And even though my code is very different, this approach is *semantically* identical to the actual automerge, and Yjs and sync9 codebases. ([Fuzzer verified (TM)](https://github.com/josephg/reference-crdts/blob/main/reference_test.ts)).\n\nIf you're interested in going deeper on this, I gave [a talk about this approach](https://invisiblecollege.s3-us-west-1.amazonaws.com/braid-meeting-10.mp4#t=300) at a [braid](https://braid.org/) meeting a few weeks ago.\n\nThe important point is this approach is better:\n\n1. We can use a flat array to store everything, rather than an unbalanced tree. This makes everything smaller and faster for the computer to process.\n2. The code is really simple. Being faster *and* simpler moves the [Pareto efficiency frontier](https://en.wikipedia.org/wiki/Pareto_efficiency). Ideas which do this are rare and truly golden.\n3. You can implement lots of CRDTs like this. Yjs, Automerge, Sync9 and others work. You can implement many list CRDTs in the same codebase. In my reference-crdts codebase I have an implementation of both RGA (automerge) and YATA (Yjs). They share most of their code (everything except this one function) and their performance in this test is identical.\n\nTheoretically this algorithm can slow down when there are concurrent inserts in the same location in the document. But that's really rare in practice - you almost always just insert right after the parent item.\n\nUsing this approach, my implementation of automerge's algorithm is about 10x faster than the real automerge. And it's 30x more memory-efficient:\n\n| Test                              | Time taken | RAM usage |\n|:--------------------------        | ----------:| ---------:|\n| automerge (v1.0.0-preview2)       |  291s      | 880 MB    |\n| **reference-crdts (automerge / Yjs)** |   31s      |  28 MB    |\n| *Plain string edits in JS*        | 0.61s      | 0.1 MB    |\n\nI wish I could attribute *all* of that difference to this sweet and simple data structure. But a lot of the difference here is probably just immutablejs gumming automerge up.\n\nIt's a lot faster than automerge:\n\n![Automerge is much slower than reference-crdts](ref_vs_am_perf.svg)\n\n\n## Death by 1000 scans\n\nWe're using a clean and fast core data abstraction now, but the implementation is still not *fast*. There are two big performance bottlenecks in this codebase we need to fix:\n\n1. Finding the location to insert, and\n2. Actually inserting into the array\n\n(These lines are marked *(1)* and *(2)* in the code listing above).\n\nTo understand why this code is necessary, lets say we have a document, which is a list of items.\n\n```javascript\nstate = [\n  { item: 'a', isDeleted: false, id: ['seph', 0], seq, parent: null },\n  { item: 'X', isDeleted: false, id, seq, parent: ['seph', 0] },\n  { item: 'b', isDeleted: true,  id, seq, parent: ['seph', 0] },\n  { item: 'c', isDeleted: false, id, seq, parent: ['seph', 1] },\n  ...\n]\n```\n\nAnd some of those items might have been deleted. I've added an `isDeleted` flag to mark which ones. (Unfortunately we can't just remove them from the array because other inserts might depend on them. Drat! But that's a problem for another day.)\n\nImagine the document has 150 000 array items in it, representing 100 000 characters which haven't been deleted. If the user types an 'a' in the middle of the document (at *document position* 50 000), what index does that correspond to in our array? To find out, we need to scan through the document (skipping deleted items) to figure out the right array location.\n\nSo if the user inserts at position 50 000, we'll probably have to linearly scan past 75 000 items or something to find the insert position. Yikes!\n\nAnd then when we actually insert, the code does this, which is double yikes:\n\n```javascript\ndoc.content.splice(destIdx, 0, newItem)\n```\n\nIf the array currently has 150 000 items, javascript will need to move every single item *after* the new item once space forward in the array. This part happens in native code, but it's still probably slow when we're moving so many items. (Aside: V8 is actually suspiciously fast at this part, so maybe v8 isn't using an array internally to implement Arrays? Who knows!)\n\nBut in general, inserting an item into a document with *n* items will take about *n* steps. Wait, no - it's worse than that because deleted items stick around. Inserting into a document where there have *ever been* *n* items will take *n* steps. This algorithm is reasonably fast, but it gets slower with every keystroke. Inserting *n* characters will take *O(n^2)*.\n\nYou can see this if we zoom in on the diagram above. There's a lot going on here because Martin's editing position bounced around the document. But there's a strong linear trend up and to the right, which is what we would expect when inserts take *O(n)* time:\n\n![reference crdts implementation zoomed in](ref_perf3.svg)\n\nAnd why this shape in particular? And why does performance get better near the end? If we simply graph *where* each edit happened throughout the editing trace, with the same bucketing and smoothing, the result is a very familiar curve:\n\n![Edit position throughout document](inspos.svg)\n\nIt looks like the time spent applying changes is dominated by the time it takes to scan through the document's array.\n\n## Changing the data structure\n\nCan we fix this? Yes we can! And by \"we\", I mean Kevin fixed these problems in Yjs. How did he manage that?\n\nSo remember, there are two problems to fix:\n\n1. How do we find a specific insert position?\n2. How do we efficiently insert content at that location?\n\nKevin solved the first problem by thinking about how humans actually edit text documents. Usually while we're typing, we don't actually bounce around a document very much. Rather than scanning the document each time an edit happens, Yjs caches the last *(index, position)* pair where the user made an edit. The next edit will probably be pretty close to the previous edit, so Kevin just scans forwards or backwards from the last editing position. This sounds a little bit dodgy to me - I mean, thats a big assumption to make! What if edits happen randomly?! But people don't actually edit documents randomly, so it works great in practice.\n\n(What if two users are editing different parts of a document at the same time? Yjs actually stores a whole set of cached locations, so there's almost always a cached cursor location near each user no matter where they're making changes in the document.)\n\nOnce Yjs finds the target insert location, it needs to insert efficiently, without copying all the existing items. Yjs solves that by using a bidirectional linked list instead of an array. So long as we have an insert position, linked lists allow inserts in constant time.\n\nYjs does one more thing to improve performance. Humans usually type in runs of characters. So when we type \"hello\" in a document, instead of storing:\n\n```javascript\nstate = [\n  { item: 'h', isDeleted: false, id: ['seph', 0], seq, parent: null },\n  { item: 'e', isDeleted: false, id: ['seph', 1], seq, parent: ['seph', 0] },\n  { item: 'l', isDeleted: false, id: ['seph', 2], seq, parent: ['seph', 1] },\n  { item: 'l', isDeleted: false, id: ['seph', 3], seq, parent: ['seph', 2] },\n  { item: 'o', isDeleted: false, id: ['seph', 4], seq, parent: ['seph', 3] },\n]\n```\n\nYjs just stores:\n\n```javascript\nstate = [\n  { item: 'hello', isDeleted: false, id: ['seph', 0], seq, parent: null },\n]\n```\n\nFinally those pesky paste events will be fast too!\n\nThis is the same information, just stored more compactly. Unfortunately we can't collapse the whole document into a single item or something like that using this trick. The algorithm can only collapse inserts when the IDs and parents line up sequentially - but that happens whenever a user types a run of characters without moving their cursor. And that happens a lot.\n\nIn this data set, using spans reduces the number of array entries by 14x. (180k entries down to 12k).\n\nHow fast is it now? This blows me away - Yjs is 30x faster than my reference-crdts implementation in this test. And it only uses about 10% as much RAM. It's *300x faster than automerge!*.\n\n| Test                              | Time taken | RAM usage |\n|:--------------------------        | ----------:| ---------:|\n| automerge (v1.0.0-preview2)       |  291s      | 880 MB    |\n| reference-crdts (automerge / Yjs) |   31s      |  28 MB    |\n| **Yjs (v13.5.5)**                 | 0.97s      | 3.3 MB    |\n| *Plain string edits in JS*        | 0.61s      | 0.1 MB    |\n\nHonestly I'm shocked and a little suspicious of how little ram Yjs uses in this test. I'm sure there's some wizardry in V8 making this possible. It's extremely impressive.\n\nKevin says he wrote and rewrote parts of Yjs 12 times in order to make this code run so fast. If there was a programmer version of the speedrunning community, they would adore Kevin. I can't even put Yjs on the same scale as the other algorithms because it's so fast:\n\n![Yjs performance vs other algorithms](yjs_perf4.svg)\n\nIf we isolate Yjs, you can see it has *mostly* flat performance. Unlike the other algorithms, it doesn't get slower over time, as the document grows:\n\n![Yjs performance isolated](yjs_perf5.svg)\n\nBut I have no idea what those spikes are near the end. They're pretty small in *absolute* terms, but it's still weird! Maybe they happen when the user moves their cursor around the document? Or when the user deletes chunks? I have no idea.\n\nThis is neat, but the real question is: Can we go *even faster*? Honestly I doubt I can make pure javascript run this test any faster than Kevin managed here. But maybe.. just maybe we can be...\n\n## Faster than Javascript\n\nWhen I told Kevin that I thought I could make a CRDT implementation that's way faster than Yjs, he didn't believe me. He said Yjs was already so well optimized, going a lot faster probably wasn't possible. \"Maybe a little faster if you just port it to Rust. But not a lot faster! V8 is really fast these days!!\"\n\nBut I knew something Kevin didn't know: I knew about memory fragmentation and caches. Rust isn't just *faster*. It's also a lower level language, and that gives us the tools we need to control allocations and memory layout.\n\n> Kevin knows this now too, and he's working on [Yrs](https://github.com/yjs/y-crdt) to see if he can claim the performance crown back.\n\nImagine one of our document items in javascript:\n\n```javascript\nvar item = {\n  content: 'hello',\n  isDeleted: false,\n  id: ['seph', 10],\n  seq: 5,\n  parent: ['mike', 2]\n}\n```\n\nThis object is actually a mess like this in memory:\n\n![javascript objects fragmented in memory](mem-frag.drawio.svg)\n\nBad news: *Your computer hates this.*\n\nThis is terrible because all the data is fragmented. It's all separated by pointers.\n\n> And yes, I know, V8 tries its hardest to prevent this sort of thing when it can. But its not magic.\n\nTo arrange data like this, the computer has to allocate memory one by one for each item. This is slow. Then the garbage collector needs extra data to track all of those objects, which is also slow. Later we'll need to read that data. To read it, your computer will often need to go fetch it from main memory, which - you guessed it - is slow as well.\n\nHow slow are main memory reads? [At human scale](https://gist.github.com/hellerbarde/2843375) each L1 cache read takes 0.5 seconds. And a read from main memory takes close to 2 minutes! This is the difference between a single heartbeat, and the time it takes to brush your teeth.\n\nArranging memory like javascript does would be like writing a shopping list. But instead of \"Cheese, Milk, Bread\", your list is actually a scavenger hunt: \"Under the couch\", \"On top of the fridge\", and so on. Under the couch is a little note mentioning you need toothpaste. Needless to say, this makes doing the grocery shopping a lot of work.\n\nTo go faster, we need to squish all the data together so the computer can fetch more information with each read of main memory. (We want a single read of my grocery list to tell us everything we need to know). Linked lists are rarely used in the real world for exactly this reason - *memory fragmentation ruins performance*. I also want to move away from linked lists because the user *does* sometimes hop around the document, which in Yjs has a linear performance cost. Thats probably not a big deal in text editing, but I want this code to be fast in other use cases too. I don't want the program to *ever* need those slow scans.\n\nWe can't fix this in javascript. The problem with fancy data structures in javascript is that you end up needing a lot of exotic objects (like fixed size arrays). All those extra objects make fragmentation worse, so as a result of all your work, your programs often end up running slower anyway. This is the same limitation immutablejs has, and why its performance hasn't improved much in the decade since it was released. The V8 optimizer is very clever, but it's not magic and clever tricks only get us so far.\n\nBut we're not limited to javascript. Even when making webpages, we have WebAssembly these days. We can code this up in *anything*.\n\nTo see how fast we can *really* go, I've been quietly building a CRDT implementation in rust called [Diamond types](https://github.com/josephg/diamond-types). Diamond is almost identical to Yjs, but it uses a [range tree](https://en.wikipedia.org/wiki/Range_tree) instead of a linked list internally to store all of the items.\n\nUnder the hood, my range tree is just a slightly modified b-tree. But usually when people talk about b-trees they mean a [BTreeMap](https://doc.rust-lang.org/std/collections/struct.BTreeMap.html). Thats not what I'm doing here. Instead of storing keys, each internal node of the b-tree stores the total number of characters (recursively) in that item's children. So we can look up any item in the document by character position, or insert or delete anywhere in the document in *log(n)* time.\n\nThis example shows the tree storing a document which currently has 1000 characters:\n\n![b-tree diagram](btree.drawio.svg)\n\n> This is a range tree, right? The [wikipedia article on range trees](https://en.wikipedia.org/wiki/Range_tree) is a pretty weak description of what I'm doing here.\n\nThis solves both of our linear scanning problems from earlier:\n\n- When we want to find the item at position 200, we can just traverse across and down the tree. In the example above, the item with position 350 must be in the middle leaf node here. Trees are very tidy - we can store Martin's editing trace in just 3 levels in our tree, which means in this benchmark we can find any item in about 3 reads from main memory. In practice, most of these reads will already be in your CPU's cache.\n- Updating the tree is fast too. We update a leaf, then update the character counts at its parent, and its parent, all the way up to the root. So again, after 3 or so steps we're done. Much better than shuffling everything in a javascript array.\n\nWe never merge edits from remote peers in this test, but I made that fast too anyway. When merging remote edits we also need to find items by their ID (eg *['seph', 100]*). Diamond has little index to search the b-tree by ID. That codepath doesn't get benchmarked here though. It's fast but for now you'll have to take my word for it.\n\nI'm not using Yjs's trick of caching the last edit location - at least not yet. It might help. I just haven't tried it yet.\n\nRust gives us total control over the memory layout, so we can pack everything in tightly. Unlike in the diagram, each leaf node in my b-tree stores a block of 32 entries, packed in a fixed size array in memory. Inserting with a structure like this results in a little bit of memcpy-ing, but a little bit of memcpy is fine. Memcpy is always faster than I think it will be - CPUs can copy several bytes per clock cycle. Its not the epic hunt of a main memory lookup.\n\nAnd why 32 entries? I ran this benchmark with a bunch of different bucket sizes and 32 worked well. I have no idea why that worked out to be the best.\n\nSpeaking of fast, how fast does it go?\n\nIf we [compile this code to webassembly](https://github.com/josephg/diamond-js) and drive it from javascript like in the other tests, we can now process the whole editing trace in 193 milliseconds. Thats 5x faster than Yjs. And remarkably 3x faster than our baseline test editing a native javascript string, despite doing all the work to support collaborative editing!\n\nJavascript and WASM is now a bottleneck. If we skip javascript and run the benchmark [directly in rust](https://github.com/josephg/diamond-types/blob/42a8bc8fb4d44671147ccaf341eee18d77b2d532/benches/yjs.rs), we can process all 260k edits in this editing trace in just *56 milliseconds*. That's over 5000x faster than where we started with automerge. It can process 4.6 *million* operations every second.\n\n| Test                              | Time taken | RAM usage |\n|:--------------------------        | ----------:| ---------:|\n| automerge (v1.0.0-preview2)       |  291s      | 880 MB    |\n| reference-crdts (automerge / Yjs) |   31s      |  28 MB    |\n| Yjs (v13.5.5)                     | 0.97s      | 3.3 MB    |\n| *Plain string edits in JS*        | 0.61s      | 0.1 MB    |\n| **Diamond (wasm via nodejs)**     | 0.19s      | ???       |\n| **Diamond (native)**              | 0.056s     | 1.1 MB    |\n\nPerformance is smooth as butter. A b-tree doesn't care where edits happen. This system is uniformly fast across the whole document. Rust doesn't need a garbage collector to track memory allocations, so there's no mysterious GC spikes. And because memory is so tightly packed, processing this entire data set (all 260 000) only results in 1394 calls to malloc.\n\n![rust implementation in wasm vs Yjs](rust_perf6.svg)\n\nOh, what a pity. Its so fast you can barely see it next to yjs (*fleexxxx*). Lets zoom in a bit there and bask in that flat line:\n\n![rust implementation in wasm](rust_perf7.svg)\n\nWell, a nearly flat line.\n\nAnd remember, this chart shows the *slow* version. This chart is generated from javascript, calling into rust through WASM. If I run this benchmark natively its another ~4x faster again.\n\nWhy is WASM 4x slower than native execution? Are javascript calls to the WASM VM really that slow? Does LLVM optimize native x86 code better? Or do WASM's memory bounds checks slow it down? I'm so curious!\n\n\n## Struct of arrays or Array of structs?\n\nThis implementation has another small, important change - and I'm not sure if I like it.\n\nIn rust I'm actually doing something like this:\n\n```javascript\ndoc = {\n  textContent: RopeyRope { 'hello' },\n\n  clients: ['seph', 'mike'],\n\n  items: BTree {[\n    // Note: No string content!\n    { len:  5, id: [0, 0], seq, parent: ROOT },\n    { len: -5, id: [1, 0], seq, parent: [0, 0] }, // negative len means the content was deleted\n    ...\n  ]},\n}\n```\n\nNotice the document's text content doesn't live in the list of items anymore. Now it's in a separate data structure. I'm using a rust library for this called [Ropey](https://crates.io/crates/ropey). Ropey implements *another* b-tree to efficiently manage just the document's text content.\n\nThis isn't universally a win. We have unfortunately arrived at the Land of Uncomfortable Engineering Tradeoffs:\n\n- Ropey can to do text-specific byte packing. So with ropey, we use less RAM.\n- When inserting we need to update 2 data structures instead of 1. This makes everything more than twice as slow, and it makes the wasm bundle twice as big  (60kb -> 120kb).\n- For lots of use cases we'll end up storing the document content somewhere else anyway. For example, if you hook this CRDT up to VS Code, the editor will keep a copy of the document at all times anyway. So there's no need to store the document in my CRDT structures as well, at all. This implementation approach makes it easy to just turn that part of the code off.\n\nSo I'm still not sure whether I like this approach.\n\nBut regardless, my CRDT implementation is so fast at this point that most of the algorithm's time is spent updating the document contents in ropey. Ropey on its own takes 29ms to process this editing trace. What happens if I just ... turn ropey off? How fast can this puppy can really go?\n\n| Test                              | Time taken | RAM usage | Data structure |\n|:--------------------------        | ----------:| ---------:|:---------------|\n| automerge (v1.0.0-preview2)       |  291s      | 880 MB    | Naive tree     |\n| reference-crdts (automerge / Yjs) |   31s      |  28 MB    | Array          |\n| Yjs (v13.5.5)                     | 0.97s      | 3.3 MB    | Linked list    |\n| *Plain string edits in JS*        | 0.61s      | 0.1 MB    | *(none)*       |\n| Diamond (wasm via nodejs)         | 0.20s      | ???       | B-Tree         |\n| Diamond (native)                  | 0.056s     | 1.1 MB    | B-Tree         |\n| *Ropey (rust) baseline*           | 0.029s     | 0.2 MB    | *(none)*       |\n| **Diamond (native, no doc content)** | 0.023s  | 0.96 MB   | B-Tree         |\n\nBoom. This is kind of useless, but it's now 14000x faster than automerge. We're processing 260 000 operations in 23ms. Thats 11 million operations per second. I could saturate my home internet connection with keystrokes and I'd still have CPU to spare.\n\n---\n\nWe can calculate the average speed each algorithm processes edits:\n\n![](totals.svg)\n\nBut these numbers are misleading. Remember, automerge and ref-crdts aren't steady. They're fast at first, then slow down as the document grows. Even though automerge can process about 900 edits per second *on average* (which is fast enough that users won't notice), the slowest edit during this benchmark run stalled V8 for a full 1.8 seconds.\n\nWe can put everything in a single, pretty chart if I use a log scale. It's remarkable how tidy this looks:\n\n![all data in one chart](all_perf.svg)\n\n> Huh - look at the bottom two lines. The jitteryness of yjs and diamond mirror each other. Periods when yjs gets slower, diamond gets faster. I wonder whats going on there!\n\nBut log scales are junk food for your intuition. On a linear scale the data looks like this:\n\n![all data in one chart, with a linear scale](all_perf_linear.svg)\n\nThat, my friends, is how you make the computer do a lot less work.\n\n\n## Conclusion\n\nThat silly academic paper I read all those years ago says some CRDTs and OT algorithms are slow. And everyone believed the paper, because it was Published Science. But the paper was wrong. As I've shown, we *can* make CRDTs fast. We can make them *crazy fast* if we get creative with our implementation strategies. With the right approach, we can make CRDTs so fast that we can compete with the performance of native strings. The performance numbers in that paper weren't just wrong. They were \"a billionaire guessing a banana costs $1000\" kind of wrong.\n\nBut you know what? I sort of appreciate that paper now. Their mistake is ok. It's *human*. I used to feel inadequate around academics - maybe I'll never be that smart! But this whole thing made me realise something obvious: Scientists aren't gods, sent from the heavens with the gift of Truth. No, they're beautiful, flawed *people* just like the rest of us mooks. Great at whatever we obsess over, but kind of middling everywhere else. I can optimize code pretty well, but I still get zucchini and cucumber mixed up. And, no matter the teasing I get from my friends, thats ok.\n\nA decade ago Google Wave really needed a good quality list CRDT. I got super excited when the papers for CRDTs started to emerge. [LOGOOT](https://hal.inria.fr/inria-00432368/document) and [WOOT](https://hal.inria.fr/inria-00445975/document) seemed like a big deal! But that excitement died when I realised the algorithms were too slow and inefficient to be practically useful. And I made a big mistake - I assumed if the academics couldn't make them fast, nobody could.\n\nBut sometimes the best work comes out of a collaboration between people with different skills. I'm terrible at academic papers, I'm pretty good at making code run fast. And yet here, in my own field, I didn't even try to help. The researchers were doing their part to make P2P collaborative editing work. And I just thumbed my nose at them all and kept working on Operational Transform. If I helped out, maybe we would have had fast, workable CRDTs for text editing a decade ago. Oops! It turned out collaborative editing needed a collaboration between all of us. How ironic! Who could have guessed?!\n\nWell, it took a decade, some hard work and some great ideas from a bunch of clever folks. The binary encoding system Martin invented for Automerge is brilliant. The system of avoiding UUIDs by using incrementing (agent id, sequence) tuples is genius. I have no idea who came up with that, but I love it. And of course, Kevin's list representation + insertion approach I describe here makes everything so much faster and simpler. I bet 100 smart people must have walked right past that idea over the last decade without any of them noticing it. I doubt I would have thought of it either. My contribution is using run-length encoded b-trees and clever indexing. And showing Kevin's fast list representation can be adapted to any CRDT algorithm. I don't think anyone noticed that before.\n\nAnd now, after a decade of waiting, we finally figured out how to make fast, lightweight list CRDT implementations. Practical decentralized realtime collaborative editing? We're coming for you next.\n\n\n## Appendix A: I want to use a CRDT for my application. What should I do?\n\nIf you're building a document based collaborative application today, you should use [Yjs](https://github.com/yjs/yjs). Yjs has solid performance, low memory usage and great support. If you want help implementing Yjs in your application, Kevin Jahns sometimes accepts money in exchange for help integrating Yjs into various applications. He uses this to fund working on Yjs (and adjacent work) full time. Yjs already runs fast and soon it should become even faster.\n\nThe automerge team is also fantastic. I've had some great conversations with them about these issues. They're making performance the #1 issue of 2021 and they're planning on using a lot of these tricks to make automerge fast. It might already be much faster by the time you're reading this.\n\nDiamond is *really* fast, but there's a lot of work before I have feature parity with Yjs and Automerge. There is a lot more that goes into a good CRDT library than operation speed. CRDT libraries also need to support binary encoding, network protocols, non-list data structures, presence (cursor positions), editor bindings and so on. At the time of writing, diamond does almost none of this.\n\nIf you want database semantics instead of document semantics, as far as I know nobody has done this well on top of CRDTs yet. You can use [ShareDB](https://github.com/share/sharedb/), which uses OT. I wrote ShareDB years ago, and it's well used, well maintained and battle tested.\n\nLooking forward, I'm excited for [Redwood](https://github.com/redwood/redwood) - which supports P2P editing and has planned full CRDT support.\n\n\n## Appending B: Lies, damned lies and benchmarks\n\nIs this for real? Yes. But performance is complicated and I'm not telling the full picture here.\n\nFirst, if you want to play with any of the benchmarks I ran yourself, you can. But everything is a bit of a mess.\n\nThe benchmark code for the JS plain string editing baseline, Yjs, automerge and reference-crdts tests is all in [this github gist](https://gist.github.com/josephg/13efc1444660c07870fcbd0b3e917638). It's a mess; but messy code is better than missing code.\n\nYou'll also need `automerge-paper.json.gz` from [josephg/crdt-benchmarks](https://github.com/josephg/crdt-benchmarks) in order to run most of these tests. The reference-crdts benchmark depends on [crdts.ts from josephg/reference-crdts, at this version](https://github.com/josephg/reference-crdts/tree/fed747255df9d457e11f36575de555b39f07e909).\n\nDiamond's benchmarks come from [josephg/diamond-types, at this version](https://github.com/josephg/diamond-types/tree/42a8bc8fb4d44671147ccaf341eee18d77b2d532). Benchmark by running ` RUSTFLAGS='-C target-cpu=native' cargo criterion yjs`. The inline rope structure updates can be enabled or disabled by editing [the constant at the top of src/list/doc.rs](https://github.com/josephg/diamond-types/blob/42a8bc8fb4d44671147ccaf341eee18d77b2d532/src/list/doc.rs#L15). You can look at memory statistics by running `cargo run --release --features memusage --example stats`.\n\nDiamond is compiled to wasm using [this wrapper](https://github.com/josephg/diamond-js/tree/6e8a95670b651c0aaa7701a1a763778d3a486b0c), hardcoded to point to a local copy of diamond-types from git. The wasm bundle is optimized with wasm-opt.\n\nThe charts were made on [ObservableHQ](https://observablehq.com/@josephg/crdt-algorithm-performance-benchmarks).\n\n\n### Are Automerge and Yjs doing the same thing?\n\nThroughout this post I've been comparing the performance of implementations of RGA (automerge) and YATA (Yjs + my rust implementation) interchangeably.\n\nDoing this rests on the assumption that the concurrent merging behaviour for YATA and RGA are basically the same, and that you can swap between CRDT behaviour without changing your implementation, or your implementation performance. This is a novel idea that I think nobody has looked at before.\n\nI feel confident in this claim because I demonstrated it in my [reference CRDT implementation](https://github.com/josephg/reference-crdts), which has identical performance (and an almost identical codepath) when using Yjs or automerge's behaviour. There might be some performance differences with conflict-heavy editing traces - but that's extremely rare in practice.\n\nI'm also confident you could modify Yjs to implement RGA's behaviour if you wanted to, without changing Yjs's performance. You would just need to:\n\n- Change Yjs's *integrate* method (or make an alternative) which used slightly different logic for concurrent edits\n- Store *seq* instead of *originRight* in each *Item*\n- Store *maxSeq* in the document, and keep it up to date and\n- Change Yjs's binary encoding format.\n\nI talked to Kevin about this, and he doesn't see any point in adding RGA support into his library. It's not something anybody actually asks for. And RGA can have weird [interleaving](https://www.cl.cam.ac.uk/~arb33/papers/KleppmannEtAl-InterleavingAnomalies-PaPoC2019.pdf) when prepending items.\n\nFor diamond, I make my code accept a type parameter for switching between Yjs and automerge's behaviour. I'm not sure if I want to. Kevin is probably right - I don't think this is something people ask for.\n\n---\n\nWell, there is one way in which Yjs has a definite edge over automerge: Yjs doesn't record *when* each item in a document has been deleted. Only whether each item has been deleted or not. This has some weird implications:\n\n- Storing when each delete happened has a weirdly large impact on memory usage and on-disk storage size. Adding this data doubles diamond's memory usage from 1.12mb to 2.34mb, and makes the system about 5% slower.\n- Yjs doesn't store enough information to implement per-keystroke editing replays or other fancy stuff like that. (Maybe thats what people want? Is it weird to have every errant keystroke recorded?)\n- Yjs needs to encode information about which items have been deleted into the *version* field. In diamond, versions are tens of bytes. In yjs, versions are ~4kb. And they grow over time as the document grows. Kevin assures me that this information is basically always small in practice. He might be right but this still makes me weirdly nervous.\n\nFor now, the master branch of diamond includes temporal deletes. But all benchmarks in this blog post use a [yjs-style branch of diamond-types](https://github.com/josephg/diamond-types/tree/yjs-style), which matches how Yjs works instead. This makes for a fairer comparison with yjs, but diamond 1.0 might have a slightly different performance profile. (There's plenty of puns here about diamond not being polished yet, but I'm not sharp enough for those right now.)\n\n\n### These benchmarks measure the wrong thing\n\nThis post only measures the time taken to replay a local editing trace. And I'm measuring the resulting RAM usage. Arguably accepting incoming changes from the user only needs to happen fast *enough*. Fingers simply don't type very fast. Once a CRDT can handle any local user edit in under about 1ms, going faster probably doesn't matter much. (And automerge usually performs that well already, barring some unlucky GC pauses.)\n\nThe *actually important* metrics are:\n\n- How many bytes does a document take on disk or over the network\n- How much time does the document take to save and load\n- How much time it takes to update a document stored at rest (more below)\n\nThe editing trace I'm using here also only has a single user making edits. There could be pathological performance cases lurking in the shadows when users make concurrent edits.\n\nI did it this way because I haven't implemented a binary format in my reference-crdts implementation or diamond yet. If I did, I'd probably copy Yjs & automerge's binary formats because they're so compact. So I expect the resulting binary size would be similar between all of these implementations, except for delete operations. Performance for loading and saving will probably approximately mirror the benchmarks I showed above. Maybe. Or maybe I'm wrong. I've been wrong before. It would be fun to find out.\n\n---\n\nThere's one other performance measure I think nobody is taking seriously enough at the moment. And that is, how we update a document at rest (in a database). Most applications aren't collaborative text editors. Usually applications are actually interacting with databases full of tiny objects. Each of those objects is very rarely written to.\n\nIf you want to update a single object in a database using Yjs or automerge today you need to:\n\n1. Load the whole document into RAM\n2. Make your change\n3. Save the whole document back to disk again\n\nThis is going to be awfully slow. There are better approaches for this - but as far as I know, nobody is working on this at all. We could use your help!\n\n> Edit: Kevin says you can adapt Yjs's providers to implement this in a reasonable way. I'd love to see that in action.\n\n---\n\nThere's another approach to making CRDTs fast, which I haven't mentioned here at all and that is *pruning*. By default, list CRDTs like these only ever grow over time (since we have to keep tombstones for all deleted items). A lot of the performance and memory cost of CRDTs comes from loading, storing and searching that growing data set. There are some approaches which solve this problem by finding ways to shed some of this data entirely. For example, Yjs's GC algorithm, or [Antimatter](https://braid.org/antimatter). That said, git repositories only ever grow over time and nobody seems mind too much. Maybe it doesn't matter so long as the underlying system is fast enough?\n\nBut pruning is orthogonal to everything I've listed above. Any good pruning system should also work with all of the algorithms I've talked about here.\n\n\n### Each step in this journey changes too many variables\n\nEach step in this optimization journey involves changes to multiple variables and I'm not isolating those changes. For example, moving from automerge to my reference-crdts implementation changed:\n\n- The core data structure (tree to list)\n- Removed immutablejs\n- Removed automerge's frontend / backend protocol. And all those Uint8Arrays that pop up throughout automerge for whatever reason are gone too, obviously.\n- The javascript style is totally different. (FP javascript -> imperative)\n\nWe got 10x performance from all this. But I'm only guessing how that 10x speedup should be distributed amongst all those changes.\n\nThe jump from reference-crdts to Yjs, and from Yjs to diamond are similarly monolithic. How much of the speed difference between diamond and Yjs has nothing to do with memory layout, and everything to do with LLVM's optimizer?\n\nThe fact that automerge-rs isn't faster than automerge gives me some confidence that diamond's performance isn't just thanks to rust. But I honestly don't know.\n\nSo, yes. This is a reasonable criticism of my approach. If this problem bothers you, I'd *love* for someone to pull apart each of the performance differences between implementations I show here and tease apart a more detailed breakdown. I'd read the heck out of that. I love benchmarking stories. That's normal, right?\n\n\n## Appendix C: I still don't get it - why is automerge's javascript so slow?\n\nBecause it's not trying to be fast. Look at this code [from automerge](https://github.com/automerge/automerge/blob/d2e7ca2e141de0a72f540ddd738907bcde234183/backend/op_set.js#L649-L659):\n\n```javascript\nfunction lamportCompare(op1, op2) {\n  return opIdCompare(op1.get('opId'), op2.get('opId'))\n}\n\nfunction insertionsAfter(opSet, objectId, parentId, childId) {\n  let childKey = null\n  if (childId) childKey = Map({opId: childId})\n\n  return opSet\n    .getIn(['byObject', objectId, '_following', parentId], List())\n    .filter(op => op.get('insert') && (!childKey || lamportCompare(op, childKey) < 0))\n    .sort(lamportCompare)\n    .reverse() // descending order\n    .map(op => op.get('opId'))\n}\n```\n\nThis is called on each insert, to figure out how the children of an item should be sorted. I don't know how hot it is, but there are *so many things* slow about this:\n\n- I can spot 7 allocations in this function. (Though the 2 closures should be hoisted). (Can you find them all?)\n- The items are already sorted reverse-lamportCompare before this method is called. Sorting an anti-sorted list is the slowest way to sort anything. Rather than sorting, then reverse()'ing, this code should just invert the arguments in `lamportCompare` (or negate the return value).\n- The goal is to insert a new item into an already sorted list. You can do that much faster with a for loop.\n- This code wraps childId into an immutablejs Map, just so the argument matches `lamportCompare` - which then unwraps it again. Stop - I'm dying!\n\nBut in practice this code is going to be replaced by WASM calls through to [automerge-rs](https://github.com/automerge/automerge-rs). Maybe it already has been replaced with automerge-rs by the time you're reading this! So it doesn't matter. Try not to think about it. Definitely don't submit any PRs to fix all the low hanging fruit. *twitch.*\n\n\n## Acknowledgements\n\nThis post is part of the [Braid project](https://braid.org/) and funded by the [Invisible College](https://invisible.college/). If this is the sort of work you want to contribute towards, get in touch. We're hiring.\n\nThankyou to everyone who gave feedback before this post went live.\n\nAnd special thanks to Martin Kleppmann and Kevin Jahns for their work on Automerge and Yjs. Diamond stands on the shoulders of giants.\n\n[Comments on Hacker News](https://news.ycombinator.com/item?id=28017204)\n\n<footer>\n\n[2021 Seph Gentle](https://josephg.com/)\n\n[https://github.com/josephg/](https://github.com/josephg/)\n\n</footer># 5000x faster CRDTs: An Adventure in Optimization\n\n<span class=post-meta>July 31 2021</span>\n\nA few years ago I was really bothered by an academic paper.\n\nSome researchers in France put together a comparison showing lots of ways you could implement realtime collaborative editing (like Google Docs). They implemented lots of algorithms - CRDTs and OT algorithms and stuff. And they benchmarked them all to see how they perform. (Cool!!) Some algorithms worked reasonably well. But others took upwards of 3 seconds to process simple paste operations from their editing sessions. Yikes!\n\nWhich algorithm was that? Well, this is awkward but .. it was mine. I mean, I didn't invent it - but it was the algorithm I was using for ShareJS. The algorithm we used for Google Wave. The algorithm which - hang on - I knew for a fact didn't take 3 seconds to process large paste events. Whats going on here?\n\nI took a closer look at the paper. In their implementation when a user pasted a big chunk of text (like 1000 characters), instead of creating 1 operation with 1000 characters, their code split the insert into 1000 individual operations. And each of those operations needed to be processed separately. Do'h - of course it'll be slow if you do that! This isn't a problem with the operational transformation algorithm. This is just a problem with *their particular implementation*.\n\nThe infuriating part was that several people sent me links to the paper and (pointedly) asked me what I think about it. Written up as a Published Science Paper, these speed comparisons seemed like a Fact About The Universe. And not what they really were - implementation details of some java code, written by a probably overstretched grad student. One of a whole bunch of implementations that they needed to code up.\n\n\"Nooo! The peer reviewed science isn't right everybody! Please believe me!\". But I didn't have a published paper justifying my claims. I had working code but it felt like none of the smart computer science people cared about that. Who was I? I was nobody.\n\n---\n\nEven talking about this stuff we have a language problem. We describe each system as an \"algorithm\". Jupiter is an Algorithm. RGA is an Algorithm. But really there are two very separate aspects:\n\n1. The black-box *behaviour* of concurrent edits. When two clients edit the same region of text at the same time, what happens? Are they merged, and if so in what order? What are the rules?\n2. The white-box *implementation* of the system. What programming language are we using? What data structures? How well optimized is the code?\n\nIf some academic's code runs slowly, what does that actually teach us? Maybe it's like tests. A passing test suite *suggests*, but can never *prove* that there are no bugs. Likewise a slow implementation suggests, but can never prove that every implementation of the system will be slow. If you wait long enough, somebody will find more bugs. And, maybe, someone out there can design a faster implementation.\n\nYears ago I translated my old text OT code into C, Javascript, Go, Rust and Swift. Each implementation has the same behaviour, and the same algorithm. But the performance is not even close. In javascript my transform function ran about 100 000 times per second. Not bad! But the same function in C does 20M iterations per second. That's 200x faster. Wow!\n\nWere the academics testing a slow version or the fast version of this code? Maybe, without noticing, they had fast versions of some algorithms and slow versions of others. It's impossible to tell from the paper!\n\n\n## Making CRDTs fast\n\nSo as you may know, I've been getting interested in CRDTs lately. For the uninitiated, CRDTs [(Conflict-Free Replicated Data types)](https://en.wikipedia.org/wiki/Conflict-free_replicated_data_type) are fancy programming tools which let multiple users edit the same data at the same time. They let you work locally with no lag. (You don't even have to be online). And when you do sync up with other users & devices, everything just magically syncs up and becomes eventually consistent. The best part of CRDTs is that they can do all that without even needing a centralized computer in the cloud to monitor and control everything.\n\nI want Google Docs without google. I want my apps to seamlessly share data between all my devices, without me needing to rely on some [flakey startup](https://ourincrediblejourney.tumblr.com/)'s servers to still be around in another decade. I think they're the [future of collaborative editing](https://josephg.com/blog/crdts-are-the-future/). And maybe the future of all software - but I'm not ready to talk about that yet.\n\nBut most CRDTs you read about in academic papers are crazy slow. A decade ago I decided to stop reading academic papers and dismissed them. I assumed CRDTs had some inherent problem. A GUID for every character? Nought but madness comes from those strange lands! But - and this is awkward to admit - I think I've been making the same mistake as those researchers. I was reading papers which described the *behaviour* of different systems. And I assumed that meant we knew how the best way to *implement* those systems. And wow, I was super wrong.\n\nHow wrong? Well. Running [this editing trace](https://github.com/automerge/automerge-perf/), [Automerge](https://github.com/automerge/automerge/) (a popular CRDT, written by [a popular researcher](https://martin.kleppmann.com/)) takes nearly 5 minutes to run. I have a [new implementation](https://github.com/josephg/diamond-types) that can process the same editing trace in 56 milliseconds. Thats 0.056 seconds, which is over 5000x faster. It's the largest speed up I've ever gotten from optimization work - and I'm utterly delighted by it.\n\nLets talk about why automerge is currently slow, and I'll take you through all the steps toward making it super fast.\n\nWait, no. First we need to start with:\n\n\n### What is automerge?\n\nAutomerge is a library to help you do collaborative editing. It's written by Martin Kleppmann, who's a little bit famous from his book and [excellent talks](https://martin.kleppmann.com/2020/07/06/crdt-hard-parts-hydra.html). Automerge is based on an algorithm called RGA, which you can read about in an academic paper if you're into that sort of thing.\n\nMartin explains automerge far better than I will in this talk from 2020:\n\n<iframe class=\"youtube\" src=\"https://www.youtube-nocookie.com/embed/x7drE24geUw?start=1237\" title=\"YouTube video player\" frameborder=\"0\" allow=\"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture\" allowfullscreen></iframe>\n\nAutomerge (and Yjs and other CRDTs) think of a shared document as a list of characters. Each character in the document gets a unique ID, and whenever you insert into the document, you name what you're inserting after.\n\nImagine I type \"abc\" into an empty document. Automerge creates 3 items:\n\n- Insert *'a'* id `(seph, 0)` after `ROOT`\n  - Insert *'b'* id `(seph, 1)` after `(seph, 0)`\n    - Insert *'c'* id `(seph, 2)` after `(seph, 1)`\n\nWe can draw this as a tree!\n\n![tree with \"abc\" inserts](automerge1.drawio.svg)\n\nLets say Mike inserts an 'X' between *a* and *b*, so we get \"aXbc\". Then we have:\n\n- Insert *'a'* id `(seph, 0)` after `ROOT`\n  - Insert *'X'* id `(mike, 0)` after `(seph, 0)`\n  - Insert *'b'* id `(seph, 1)` after `(seph, 0)`\n    - Insert *'c'* id `(seph, 2)` after `(seph, 1)`\n\n![tree with \"aXbc\"](automerge2.drawio.svg)\n\nNote the 'X' and 'b' both share the same parent. This will happen when users type concurrently in the same location in the document. But how do we figure out which character goes first? We could just sort using their agent IDs or something. But argh, if we do that the document could end up as *abcX*, even though Mike inserted *X* before the *b*. That would be really confusing.\n\nAutomerge (RGA) solves this with a neat hack. It adds an extra integer to each item called a *sequence number*. Whenever you insert something, you set the new item's sequence number to be 1 bigger than the biggest sequence number you've ever seen:\n\n- Insert *'a'* id `(seph, 0)` after `ROOT`, seq: *0*\n  - Insert *'X'* id `(mike, 0)` after `(seph, 0)`, seq: *3*\n  - Insert *'b'* id `(seph, 1)` after `(seph, 0)`, seq: *1*\n    - Insert *'c'* id `(seph, 2)` after `(seph, 1)`, seq: *2*\n\nThis is the algorithmic version of \"Wow I saw a sequence number, and it was *this big!*\" \"Yeah? Mine is *even bigger!*\"\n\nThe rule is that children are sorted first based on their sequence numbers (bigger sequence number first). If the sequence numbers match, the changes must be concurrent. In that case we can sort them arbitrarily based on their agent IDs. (We do it this way so all peers end up with the same resulting document.)\n\nYjs - which we'll see more of later - implements a CRDT called YATA. YATA is identical to RGA, except that it solves this problem with a slightly different hack. But the difference isn't really important here.\n\nAutomerge (RGA)'s *behaviour* is defined by this algorithm:\n\n- Build the tree, connecting each item to its parent\n- When an item has multiple children, sort them by sequence number then by their ID.\n- The resulting list (or text document) can be made by flattening the tree with a depth-first traversal.\n\nSo how should you *implement* automerge? The automerge library does it in the obvious way, which is to store all the data as a tree. (At least I think so - after typing \"abc\" [this is automerge's internal state](https://gist.github.com/josephg/0522c4aec5021cc1dddb60e778828dbe). Uh, uhm, I have no idea whats going on here. And what are all those Uint8Arrays doing all over the place? Whatever.) The automerge library works by building a tree of items.\n\nFor a simple benchmark, I'm going to test automerge using [an editing trace Martin himself made](https://github.com/automerge/automerge-perf/). This is a character by character recording of Martin typing up an academic paper. There aren't any concurrent edits in this trace, but users almost never actually put their cursors at exactly the same place and type anyway, so I'm not too worried about that. I'm also only counting the time taken to apply this trace *locally*, which isn't ideal but it'll do. Kevin Jahns (Yjs's author) has a much more [extensive benchmarking suite here](https://github.com/dmonad/crdt-benchmarks) if you're into that sort of thing. All the benchmarks here are done on my chonky ryzen 5800x workstation, with Nodejs v16.1 and rust 1.52 when that becomes appropriate. (Spoilers!)\n\nThe editing trace has 260 000 edits, and the final document size is about 100 000 characters.\n\nAs I said above, automerge takes a little under 5 minutes to process this trace. Thats just shy of 900 edits per second, which is probably fine. But by the time it's done, automerge is using 880 MB of RAM. Whoa! That's 10kb of ram *per key press*. At peak, automerge was using 2.6 GB of RAM!\n\nTo get a sense of how much overhead there is, I'll compare this to [a baseline benchmark](https://gist.github.com/josephg/13efc1444660c07870fcbd0b3e917638#file-js_baseline-js) where we just splice all the edits directly into a javascript string. This throws away all the information we need to do collaborative editing, but it gives us a sense of how fast javascript is capable of going. It turns out javascript running on V8 is *fast*:\n\n| Test                              | Time taken | RAM usage |\n|:--------------------------        | ----------:| ---------:|\n| **automerge (v1.0.0-preview2)**   |  291s      | 880 MB    |\n| *Plain string edits in JS*        | 0.61s      | 0.1 MB    |\n\nThis is a chart showing the time taken to process each operation throughout the test, averaged in groups of 1000 operations. I think those spikes are V8's garbage collector trying to free up memory.\n\n![automerge performance chart](am_perf1.svg)\n\nIn the slowest spike near the end, a single edit took *1.8 seconds* to process. Oof. In a real application, the whole app (or browser tab) would freeze up for a couple of seconds sometimes while you're in the middle of typing.\n\nThe chart is easier to read when we average everything out a bit and zoom the Y axis. We can see the average performance gets gradually (roughly linearly) worse over time.\n\n![automerge performance chart smoothed out](am_perf1_smooth.svg)\n\n### Why is automerge slow though?\n\nAutomerge is slow for a whole slew of reasons:\n\n1. Automerge's core tree based data structure gets big and slow as the document grows.\n2. Automerge makes heavy use of [Immutablejs](https://immutable-js.github.io/). Immutablejs is a library which gives you clojure-like copy-on-write semantics for javascript objects. This is a cool set of functionality, but the V8 optimizer & GC struggles to optimize code that uses immutablejs. As a result, it increases memory usage and decreases performance.\n3. Automerge treats each inserted character as a separate item. Remember that paper I talked about earlier, where copy+paste operations are slow? Automerge does that too!\n\nAutomerge was just never written with performance in mind. Their team is working on a replacement [rust implementation of the algorithm](https://github.com/automerge/automerge-rs/) to run through wasm, but at the time of writing it hasn't landed yet. I got the master branch working, but they have some kinks to work out before it's ready. Switching to the automerge-rs backend doesn't make average performance in this test any faster. (Although it does halve memory usage and smooth out performance.)\n\n---\n\nThere's an old saying with performance tuning:\n\n> You can't make the computer faster. You can only make it do less work.\n\nHow do we make the computer do less work here? There's lots of performance wins to be had from going through the code and improving lots of small things. But the automerge team has the right approach. It's always best to start with macro optimizations. Fix the core algorithm and data structures before moving to optimizing individual methods. There's no point optimizing a function when you're about to throw it away in a rewrite.\n\nBy far, Automerge's biggest problem is its complex tree based data structure. And we can replace it with something faster.\n\n\n## Improving the data structure\n\nLuckily, there's a better way to implement CRDTs, pioneered in [Yjs](https://github.com/yjs/yjs). Yjs is another (competing) opensource CRDT implementation made by Kevin Jahns. It's fast, well documented and well made. If I were going to build software which supports collaborative editing today, I'd use Yjs.\n\nYjs doesn't need a whole blog post talking about how to make it fast because it's already pretty fast, as we'll see soon. It got there by using a clever, obvious data structure \"trick\" that I don't think anyone else in the field has noticed. Instead of implementing the CRDT as a tree like automerge does:\n\n```javascript\nstate = {\n  { item: 'a', id: ['seph', 0], seq: 0, children: [\n    { item: 'X', id, seq, children: []},\n    { item: 'b', id, seq, children: [\n      { item: 'c', id, seq, children: []}\n    ]}\n  ]}\n}\n```\n\nYjs just puts all the items in a single flat list:\n\n```javascript\nstate = [\n  { item: 'a', id: ['seph', 0], seq: 0, parent: null },\n  { item: 'X', id, seq, parent: ['seph', 0] },\n  { item: 'b', id, seq, parent: ['seph', 0] },\n  { item: 'c', id, seq, parent: [..] }\n]\n```\n\nThat looks simple, but how do you insert a new item into a list? With automerge it's easy:\n\n1. Find the parent item\n2. Insert the new item into the right location in the parents' list of children\n\nBut with this list approach it's more complicated:\n\n1. Find the parent item\n2. Starting right after the parent item, iterate through the list until we find the location where the new item should be inserted (?)\n3. Insert it there, splicing into the array\n\nEssentially, this approach is just a fancy insertion sort. We're implementing a list CRDT with a list. Genius!\n\nThis sounds complicated - how do you figure out where the new item should go? But it's complicated in the same way *math* is complicated. It's hard to understand, but once you understand it, you can implement the whole insert function in about 20 lines of code:\n\n(But don't be alarmed if this looks confusing - we could probably fit everyone on the planet who understands this code today into a small meeting room.)\n\n```javascript\nconst automergeInsert = (doc, newItem) => {\n  const parentIdx = findItem(doc, newItem.parent) // (1)\n\n  // Scan to find the insert location\n  let i\n  for (i = parentIdx + 1; i < doc.content.length; i++) {\n    let o = doc.content[i]\n    if (newItem.seq > o.seq) break // Optimization.\n    let oparentIdx = findItem(doc, o.parent)\n\n    // Should we insert here? (Warning: Black magic part)\n    if (oparentIdx < parentIdx\n      || (oparentIdx === parentIdx\n        && newItem.seq === o.seq\n        && newItem.id[0] < o.id[0])\n    ) break\n  }\n  // We've found the position. Insert at position *i*.\n  doc.content.splice(i, 0, newItem) // (2)\n\n  // .. And do various bookkeeping.\n}\n```\n\nI implemented both Yjs's CRDT (YATA) and Automerge using this approach in my experimental [*reference-crdts*](https://github.com/josephg/reference-crdts/blob/main/crdts.ts) codebase. [Here's the insert function, with a few more comments](https://github.com/josephg/reference-crdts/blob/fed747255df9d457e11f36575de555b39f07e909/crdts.ts#L401-L459). The Yjs version of this function is in the same file, if you want to have a look. Despite being very different papers, the logic for inserting is almost identical. And even though my code is very different, this approach is *semantically* identical to the actual automerge, and Yjs and sync9 codebases. ([Fuzzer verified (TM)](https://github.com/josephg/reference-crdts/blob/main/reference_test.ts)).\n\nIf you're interested in going deeper on this, I gave [a talk about this approach](https://invisiblecollege.s3-us-west-1.amazonaws.com/braid-meeting-10.mp4#t=300) at a [braid](https://braid.org/) meeting a few weeks ago.\n\nThe important point is this approach is better:\n\n1. We can use a flat array to store everything, rather than an unbalanced tree. This makes everything smaller and faster for the computer to process.\n2. The code is really simple. Being faster *and* simpler moves the [Pareto efficiency frontier](https://en.wikipedia.org/wiki/Pareto_efficiency). Ideas which do this are rare and truly golden.\n3. You can implement lots of CRDTs like this. Yjs, Automerge, Sync9 and others work. You can implement many list CRDTs in the same codebase. In my reference-crdts codebase I have an implementation of both RGA (automerge) and YATA (Yjs). They share most of their code (everything except this one function) and their performance in this test is identical.\n\nTheoretically this algorithm can slow down when there are concurrent inserts in the same location in the document. But that's really rare in practice - you almost always just insert right after the parent item.\n\nUsing this approach, my implementation of automerge's algorithm is about 10x faster than the real automerge. And it's 30x more memory-efficient:\n\n| Test                              | Time taken | RAM usage |\n|:--------------------------        | ----------:| ---------:|\n| automerge (v1.0.0-preview2)       |  291s      | 880 MB    |\n| **reference-crdts (automerge / Yjs)** |   31s      |  28 MB    |\n| *Plain string edits in JS*        | 0.61s      | 0.1 MB    |\n\nI wish I could attribute *all* of that difference to this sweet and simple data structure. But a lot of the difference here is probably just immutablejs gumming automerge up.\n\nIt's a lot faster than automerge:\n\n![Automerge is much slower than reference-crdts](ref_vs_am_perf.svg)\n\n\n## Death by 1000 scans\n\nWe're using a clean and fast core data abstraction now, but the implementation is still not *fast*. There are two big performance bottlenecks in this codebase we need to fix:\n\n1. Finding the location to insert, and\n2. Actually inserting into the array\n\n(These lines are marked *(1)* and *(2)* in the code listing above).\n\nTo understand why this code is necessary, lets say we have a document, which is a list of items.\n\n```javascript\nstate = [\n  { item: 'a', isDeleted: false, id: ['seph', 0], seq, parent: null },\n  { item: 'X', isDeleted: false, id, seq, parent: ['seph', 0] },\n  { item: 'b', isDeleted: true,  id, seq, parent: ['seph', 0] },\n  { item: 'c', isDeleted: false, id, seq, parent: ['seph', 1] },\n  ...\n]\n```\n\nAnd some of those items might have been deleted. I've added an `isDeleted` flag to mark which ones. (Unfortunately we can't just remove them from the array because other inserts might depend on them. Drat! But that's a problem for another day.)\n\nImagine the document has 150 000 array items in it, representing 100 000 characters which haven't been deleted. If the user types an 'a' in the middle of the document (at *document position* 50 000), what index does that correspond to in our array? To find out, we need to scan through the document (skipping deleted items) to figure out the right array location.\n\nSo if the user inserts at position 50 000, we'll probably have to linearly scan past 75 000 items or something to find the insert position. Yikes!\n\nAnd then when we actually insert, the code does this, which is double yikes:\n\n```javascript\ndoc.content.splice(destIdx, 0, newItem)\n```\n\nIf the array currently has 150 000 items, javascript will need to move every single item *after* the new item once space forward in the array. This part happens in native code, but it's still probably slow when we're moving so many items. (Aside: V8 is actually suspiciously fast at this part, so maybe v8 isn't using an array internally to implement Arrays? Who knows!)\n\nBut in general, inserting an item into a document with *n* items will take about *n* steps. Wait, no - it's worse than that because deleted items stick around. Inserting into a document where there have *ever been* *n* items will take *n* steps. This algorithm is reasonably fast, but it gets slower with every keystroke. Inserting *n* characters will take *O(n^2)*.\n\nYou can see this if we zoom in on the diagram above. There's a lot going on here because Martin's editing position bounced around the document. But there's a strong linear trend up and to the right, which is what we would expect when inserts take *O(n)* time:\n\n![reference crdts implementation zoomed in](ref_perf3.svg)\n\nAnd why this shape in particular? And why does performance get better near the end? If we simply graph *where* each edit happened throughout the editing trace, with the same bucketing and smoothing, the result is a very familiar curve:\n\n![Edit position throughout document](inspos.svg)\n\nIt looks like the time spent applying changes is dominated by the time it takes to scan through the document's array.\n\n## Changing the data structure\n\nCan we fix this? Yes we can! And by \"we\", I mean Kevin fixed these problems in Yjs. How did he manage that?\n\nSo remember, there are two problems to fix:\n\n1. How do we find a specific insert position?\n2. How do we efficiently insert content at that location?\n\nKevin solved the first problem by thinking about how humans actually edit text documents. Usually while we're typing, we don't actually bounce around a document very much. Rather than scanning the document each time an edit happens, Yjs caches the last *(index, position)* pair where the user made an edit. The next edit will probably be pretty close to the previous edit, so Kevin just scans forwards or backwards from the last editing position. This sounds a little bit dodgy to me - I mean, thats a big assumption to make! What if edits happen randomly?! But people don't actually edit documents randomly, so it works great in practice.\n\n(What if two users are editing different parts of a document at the same time? Yjs actually stores a whole set of cached locations, so there's almost always a cached cursor location near each user no matter where they're making changes in the document.)\n\nOnce Yjs finds the target insert location, it needs to insert efficiently, without copying all the existing items. Yjs solves that by using a bidirectional linked list instead of an array. So long as we have an insert position, linked lists allow inserts in constant time.\n\nYjs does one more thing to improve performance. Humans usually type in runs of characters. So when we type \"hello\" in a document, instead of storing:\n\n```javascript\nstate = [\n  { item: 'h', isDeleted: false, id: ['seph', 0], seq, parent: null },\n  { item: 'e', isDeleted: false, id: ['seph', 1], seq, parent: ['seph', 0] },\n  { item: 'l', isDeleted: false, id: ['seph', 2], seq, parent: ['seph', 1] },\n  { item: 'l', isDeleted: false, id: ['seph', 3], seq, parent: ['seph', 2] },\n  { item: 'o', isDeleted: false, id: ['seph', 4], seq, parent: ['seph', 3] },\n]\n```\n\nYjs just stores:\n\n```javascript\nstate = [\n  { item: 'hello', isDeleted: false, id: ['seph', 0], seq, parent: null },\n]\n```\n\nFinally those pesky paste events will be fast too!\n\nThis is the same information, just stored more compactly. Unfortunately we can't collapse the whole document into a single item or something like that using this trick. The algorithm can only collapse inserts when the IDs and parents line up sequentially - but that happens whenever a user types a run of characters without moving their cursor. And that happens a lot.\n\nIn this data set, using spans reduces the number of array entries by 14x. (180k entries down to 12k).\n\nHow fast is it now? This blows me away - Yjs is 30x faster than my reference-crdts implementation in this test. And it only uses about 10% as much RAM. It's *300x faster than automerge!*.\n\n| Test                              | Time taken | RAM usage |\n|:--------------------------        | ----------:| ---------:|\n| automerge (v1.0.0-preview2)       |  291s      | 880 MB    |\n| reference-crdts (automerge / Yjs) |   31s      |  28 MB    |\n| **Yjs (v13.5.5)**                 | 0.97s      | 3.3 MB    |\n| *Plain string edits in JS*        | 0.61s      | 0.1 MB    |\n\nHonestly I'm shocked and a little suspicious of how little ram Yjs uses in this test. I'm sure there's some wizardry in V8 making this possible. It's extremely impressive.\n\nKevin says he wrote and rewrote parts of Yjs 12 times in order to make this code run so fast. If there was a programmer version of the speedrunning community, they would adore Kevin. I can't even put Yjs on the same scale as the other algorithms because it's so fast:\n\n![Yjs performance vs other algorithms](yjs_perf4.svg)\n\nIf we isolate Yjs, you can see it has *mostly* flat performance. Unlike the other algorithms, it doesn't get slower over time, as the document grows:\n\n![Yjs performance isolated](yjs_perf5.svg)\n\nBut I have no idea what those spikes are near the end. They're pretty small in *absolute* terms, but it's still weird! Maybe they happen when the user moves their cursor around the document? Or when the user deletes chunks? I have no idea.\n\nThis is neat, but the real question is: Can we go *even faster*? Honestly I doubt I can make pure javascript run this test any faster than Kevin managed here. But maybe.. just maybe we can be...\n\n## Faster than Javascript\n\nWhen I told Kevin that I thought I could make a CRDT implementation that's way faster than Yjs, he didn't believe me. He said Yjs was already so well optimized, going a lot faster probably wasn't possible. \"Maybe a little faster if you just port it to Rust. But not a lot faster! V8 is really fast these days!!\"\n\nBut I knew something Kevin didn't know: I knew about memory fragmentation and caches. Rust isn't just *faster*. It's also a lower level language, and that gives us the tools we need to control allocations and memory layout.\n\n> Kevin knows this now too, and he's working on [Yrs](https://github.com/yjs/y-crdt) to see if he can claim the performance crown back.\n\nImagine one of our document items in javascript:\n\n```javascript\nvar item = {\n  content: 'hello',\n  isDeleted: false,\n  id: ['seph', 10],\n  seq: 5,\n  parent: ['mike', 2]\n}\n```\n\nThis object is actually a mess like this in memory:\n\n![javascript objects fragmented in memory](mem-frag.drawio.svg)\n\nBad news: *Your computer hates this.*\n\nThis is terrible because all the data is fragmented. It's all separated by pointers.\n\n> And yes, I know, V8 tries its hardest to prevent this sort of thing when it can. But its not magic.\n\nTo arrange data like this, the computer has to allocate memory one by one for each item. This is slow. Then the garbage collector needs extra data to track all of those objects, which is also slow. Later we'll need to read that data. To read it, your computer will often need to go fetch it from main memory, which - you guessed it - is slow as well.\n\nHow slow are main memory reads? [At human scale](https://gist.github.com/hellerbarde/2843375) each L1 cache read takes 0.5 seconds. And a read from main memory takes close to 2 minutes! This is the difference between a single heartbeat, and the time it takes to brush your teeth.\n\nArranging memory like javascript does would be like writing a shopping list. But instead of \"Cheese, Milk, Bread\", your list is actually a scavenger hunt: \"Under the couch\", \"On top of the fridge\", and so on. Under the couch is a little note mentioning you need toothpaste. Needless to say, this makes doing the grocery shopping a lot of work.\n\nTo go faster, we need to squish all the data together so the computer can fetch more information with each read of main memory. (We want a single read of my grocery list to tell us everything we need to know). Linked lists are rarely used in the real world for exactly this reason - *memory fragmentation ruins performance*. I also want to move away from linked lists because the user *does* sometimes hop around the document, which in Yjs has a linear performance cost. Thats probably not a big deal in text editing, but I want this code to be fast in other use cases too. I don't want the program to *ever* need those slow scans.\n\nWe can't fix this in javascript. The problem with fancy data structures in javascript is that you end up needing a lot of exotic objects (like fixed size arrays). All those extra objects make fragmentation worse, so as a result of all your work, your programs often end up running slower anyway. This is the same limitation immutablejs has, and why its performance hasn't improved much in the decade since it was released. The V8 optimizer is very clever, but it's not magic and clever tricks only get us so far.\n\nBut we're not limited to javascript. Even when making webpages, we have WebAssembly these days. We can code this up in *anything*.\n\nTo see how fast we can *really* go, I've been quietly building a CRDT implementation in rust called [Diamond types](https://github.com/josephg/diamond-types). Diamond is almost identical to Yjs, but it uses a [range tree](https://en.wikipedia.org/wiki/Range_tree) instead of a linked list internally to store all of the items.\n\nUnder the hood, my range tree is just a slightly modified b-tree. But usually when people talk about b-trees they mean a [BTreeMap](https://doc.rust-lang.org/std/collections/struct.BTreeMap.html). Thats not what I'm doing here. Instead of storing keys, each internal node of the b-tree stores the total number of characters (recursively) in that item's children. So we can look up any item in the document by character position, or insert or delete anywhere in the document in *log(n)* time.\n\nThis example shows the tree storing a document which currently has 1000 characters:\n\n![b-tree diagram](btree.drawio.svg)\n\n> This is a range tree, right? The [wikipedia article on range trees](https://en.wikipedia.org/wiki/Range_tree) is a pretty weak description of what I'm doing here.\n\nThis solves both of our linear scanning problems from earlier:\n\n- When we want to find the item at position 200, we can just traverse across and down the tree. In the example above, the item with position 350 must be in the middle leaf node here. Trees are very tidy - we can store Martin's editing trace in just 3 levels in our tree, which means in this benchmark we can find any item in about 3 reads from main memory. In practice, most of these reads will already be in your CPU's cache.\n- Updating the tree is fast too. We update a leaf, then update the character counts at its parent, and its parent, all the way up to the root. So again, after 3 or so steps we're done. Much better than shuffling everything in a javascript array.\n\nWe never merge edits from remote peers in this test, but I made that fast too anyway. When merging remote edits we also need to find items by their ID (eg *['seph', 100]*). Diamond has little index to search the b-tree by ID. That codepath doesn't get benchmarked here though. It's fast but for now you'll have to take my word for it.\n\nI'm not using Yjs's trick of caching the last edit location - at least not yet. It might help. I just haven't tried it yet.\n\nRust gives us total control over the memory layout, so we can pack everything in tightly. Unlike in the diagram, each leaf node in my b-tree stores a block of 32 entries, packed in a fixed size array in memory. Inserting with a structure like this results in a little bit of memcpy-ing, but a little bit of memcpy is fine. Memcpy is always faster than I think it will be - CPUs can copy several bytes per clock cycle. Its not the epic hunt of a main memory lookup.\n\nAnd why 32 entries? I ran this benchmark with a bunch of different bucket sizes and 32 worked well. I have no idea why that worked out to be the best.\n\nSpeaking of fast, how fast does it go?\n\nIf we [compile this code to webassembly](https://github.com/josephg/diamond-js) and drive it from javascript like in the other tests, we can now process the whole editing trace in 193 milliseconds. Thats 5x faster than Yjs. And remarkably 3x faster than our baseline test editing a native javascript string, despite doing all the work to support collaborative editing!\n\nJavascript and WASM is now a bottleneck. If we skip javascript and run the benchmark [directly in rust](https://github.com/josephg/diamond-types/blob/42a8bc8fb4d44671147ccaf341eee18d77b2d532/benches/yjs.rs), we can process all 260k edits in this editing trace in just *56 milliseconds*. That's over 5000x faster than where we started with automerge. It can process 4.6 *million* operations every second.\n\n| Test                              | Time taken | RAM usage |\n|:--------------------------        | ----------:| ---------:|\n| automerge (v1.0.0-preview2)       |  291s      | 880 MB    |\n| reference-crdts (automerge / Yjs) |   31s      |  28 MB    |\n| Yjs (v13.5.5)                     | 0.97s      | 3.3 MB    |\n| *Plain string edits in JS*        | 0.61s      | 0.1 MB    |\n| **Diamond (wasm via nodejs)**     | 0.19s      | ???       |\n| **Diamond (native)**              | 0.056s     | 1.1 MB    |\n\nPerformance is smooth as butter. A b-tree doesn't care where edits happen. This system is uniformly fast across the whole document. Rust doesn't need a garbage collector to track memory allocations, so there's no mysterious GC spikes. And because memory is so tightly packed, processing this entire data set (all 260 000) only results in 1394 calls to malloc.\n\n![rust implementation in wasm vs Yjs](rust_perf6.svg)\n\nOh, what a pity. Its so fast you can barely see it next to yjs (*fleexxxx*). Lets zoom in a bit there and bask in that flat line:\n\n![rust implementation in wasm](rust_perf7.svg)\n\nWell, a nearly flat line.\n\nAnd remember, this chart shows the *slow* version. This chart is generated from javascript, calling into rust through WASM. If I run this benchmark natively its another ~4x faster again.\n\nWhy is WASM 4x slower than native execution? Are javascript calls to the WASM VM really that slow? Does LLVM optimize native x86 code better? Or do WASM's memory bounds checks slow it down? I'm so curious!\n\n\n## Struct of arrays or Array of structs?\n\nThis implementation has another small, important change - and I'm not sure if I like it.\n\nIn rust I'm actually doing something like this:\n\n```javascript\ndoc = {\n  textContent: RopeyRope { 'hello' },\n\n  clients: ['seph', 'mike'],\n\n  items: BTree {[\n    // Note: No string content!\n    { len:  5, id: [0, 0], seq, parent: ROOT },\n    { len: -5, id: [1, 0], seq, parent: [0, 0] }, // negative len means the content was deleted\n    ...\n  ]},\n}\n```\n\nNotice the document's text content doesn't live in the list of items anymore. Now it's in a separate data structure. I'm using a rust library for this called [Ropey](https://crates.io/crates/ropey). Ropey implements *another* b-tree to efficiently manage just the document's text content.\n\nThis isn't universally a win. We have unfortunately arrived at the Land of Uncomfortable Engineering Tradeoffs:\n\n- Ropey can to do text-specific byte packing. So with ropey, we use less RAM.\n- When inserting we need to update 2 data structures instead of 1. This makes everything more than twice as slow, and it makes the wasm bundle twice as big  (60kb -> 120kb).\n- For lots of use cases we'll end up storing the document content somewhere else anyway. For example, if you hook this CRDT up to VS Code, the editor will keep a copy of the document at all times anyway. So there's no need to store the document in my CRDT structures as well, at all. This implementation approach makes it easy to just turn that part of the code off.\n\nSo I'm still not sure whether I like this approach.\n\nBut regardless, my CRDT implementation is so fast at this point that most of the algorithm's time is spent updating the document contents in ropey. Ropey on its own takes 29ms to process this editing trace. What happens if I just ... turn ropey off? How fast can this puppy can really go?\n\n| Test                              | Time taken | RAM usage | Data structure |\n|:--------------------------        | ----------:| ---------:|:---------------|\n| automerge (v1.0.0-preview2)       |  291s      | 880 MB    | Naive tree     |\n| reference-crdts (automerge / Yjs) |   31s      |  28 MB    | Array          |\n| Yjs (v13.5.5)                     | 0.97s      | 3.3 MB    | Linked list    |\n| *Plain string edits in JS*        | 0.61s      | 0.1 MB    | *(none)*       |\n| Diamond (wasm via nodejs)         | 0.20s      | ???       | B-Tree         |\n| Diamond (native)                  | 0.056s     | 1.1 MB    | B-Tree         |\n| *Ropey (rust) baseline*           | 0.029s     | 0.2 MB    | *(none)*       |\n| **Diamond (native, no doc content)** | 0.023s  | 0.96 MB   | B-Tree         |\n\nBoom. This is kind of useless, but it's now 14000x faster than automerge. We're processing 260 000 operations in 23ms. Thats 11 million operations per second. I could saturate my home internet connection with keystrokes and I'd still have CPU to spare.\n\n---\n\nWe can calculate the average speed each algorithm processes edits:\n\n![](totals.svg)\n\nBut these numbers are misleading. Remember, automerge and ref-crdts aren't steady. They're fast at first, then slow down as the document grows. Even though automerge can process about 900 edits per second *on average* (which is fast enough that users won't notice), the slowest edit during this benchmark run stalled V8 for a full 1.8 seconds.\n\nWe can put everything in a single, pretty chart if I use a log scale. It's remarkable how tidy this looks:\n\n![all data in one chart](all_perf.svg)\n\n> Huh - look at the bottom two lines. The jitteryness of yjs and diamond mirror each other. Periods when yjs gets slower, diamond gets faster. I wonder whats going on there!\n\nBut log scales are junk food for your intuition. On a linear scale the data looks like this:\n\n![all data in one chart, with a linear scale](all_perf_linear.svg)\n\nThat, my friends, is how you make the computer do a lot less work.\n\n\n## Conclusion\n\nThat silly academic paper I read all those years ago says some CRDTs and OT algorithms are slow. And everyone believed the paper, because it was Published Science. But the paper was wrong. As I've shown, we *can* make CRDTs fast. We can make them *crazy fast* if we get creative with our implementation strategies. With the right approach, we can make CRDTs so fast that we can compete with the performance of native strings. The performance numbers in that paper weren't just wrong. They were \"a billionaire guessing a banana costs $1000\" kind of wrong.\n\nBut you know what? I sort of appreciate that paper now. Their mistake is ok. It's *human*. I used to feel inadequate around academics - maybe I'll never be that smart! But this whole thing made me realise something obvious: Scientists aren't gods, sent from the heavens with the gift of Truth. No, they're beautiful, flawed *people* just like the rest of us mooks. Great at whatever we obsess over, but kind of middling everywhere else. I can optimize code pretty well, but I still get zucchini and cucumber mixed up. And, no matter the teasing I get from my friends, thats ok.\n\nA decade ago Google Wave really needed a good quality list CRDT. I got super excited when the papers for CRDTs started to emerge. [LOGOOT](https://hal.inria.fr/inria-00432368/document) and [WOOT](https://hal.inria.fr/inria-00445975/document) seemed like a big deal! But that excitement died when I realised the algorithms were too slow and inefficient to be practically useful. And I made a big mistake - I assumed if the academics couldn't make them fast, nobody could.\n\nBut sometimes the best work comes out of a collaboration between people with different skills. I'm terrible at academic papers, I'm pretty good at making code run fast. And yet here, in my own field, I didn't even try to help. The researchers were doing their part to make P2P collaborative editing work. And I just thumbed my nose at them all and kept working on Operational Transform. If I helped out, maybe we would have had fast, workable CRDTs for text editing a decade ago. Oops! It turned out collaborative editing needed a collaboration between all of us. How ironic! Who could have guessed?!\n\nWell, it took a decade, some hard work and some great ideas from a bunch of clever folks. The binary encoding system Martin invented for Automerge is brilliant. The system of avoiding UUIDs by using incrementing (agent id, sequence) tuples is genius. I have no idea who came up with that, but I love it. And of course, Kevin's list representation + insertion approach I describe here makes everything so much faster and simpler. I bet 100 smart people must have walked right past that idea over the last decade without any of them noticing it. I doubt I would have thought of it either. My contribution is using run-length encoded b-trees and clever indexing. And showing Kevin's fast list representation can be adapted to any CRDT algorithm. I don't think anyone noticed that before.\n\nAnd now, after a decade of waiting, we finally figured out how to make fast, lightweight list CRDT implementations. Practical decentralized realtime collaborative editing? We're coming for you next.\n\n\n## Appendix A: I want to use a CRDT for my application. What should I do?\n\nIf you're building a document based collaborative application today, you should use [Yjs](https://github.com/yjs/yjs). Yjs has solid performance, low memory usage and great support. If you want help implementing Yjs in your application, Kevin Jahns sometimes accepts money in exchange for help integrating Yjs into various applications. He uses this to fund working on Yjs (and adjacent work) full time. Yjs already runs fast and soon it should become even faster.\n\nThe automerge team is also fantastic. I've had some great conversations with them about these issues. They're making performance the #1 issue of 2021 and they're planning on using a lot of these tricks to make automerge fast. It might already be much faster by the time you're reading this.\n\nDiamond is *really* fast, but there's a lot of work before I have feature parity with Yjs and Automerge. There is a lot more that goes into a good CRDT library than operation speed. CRDT libraries also need to support binary encoding, network protocols, non-list data structures, presence (cursor positions), editor bindings and so on. At the time of writing, diamond does almost none of this.\n\nIf you want database semantics instead of document semantics, as far as I know nobody has done this well on top of CRDTs yet. You can use [ShareDB](https://github.com/share/sharedb/), which uses OT. I wrote ShareDB years ago, and it's well used, well maintained and battle tested.\n\nLooking forward, I'm excited for [Redwood](https://github.com/redwood/redwood) - which supports P2P editing and has planned full CRDT support.\n\n\n## Appending B: Lies, damned lies and benchmarks\n\nIs this for real? Yes. But performance is complicated and I'm not telling the full picture here.\n\nFirst, if you want to play with any of the benchmarks I ran yourself, you can. But everything is a bit of a mess.\n\nThe benchmark code for the JS plain string editing baseline, Yjs, automerge and reference-crdts tests is all in [this github gist](https://gist.github.com/josephg/13efc1444660c07870fcbd0b3e917638). It's a mess; but messy code is better than missing code.\n\nYou'll also need `automerge-paper.json.gz` from [josephg/crdt-benchmarks](https://github.com/josephg/crdt-benchmarks) in order to run most of these tests. The reference-crdts benchmark depends on [crdts.ts from josephg/reference-crdts, at this version](https://github.com/josephg/reference-crdts/tree/fed747255df9d457e11f36575de555b39f07e909).\n\nDiamond's benchmarks come from [josephg/diamond-types, at this version](https://github.com/josephg/diamond-types/tree/42a8bc8fb4d44671147ccaf341eee18d77b2d532). Benchmark by running ` RUSTFLAGS='-C target-cpu=native' cargo criterion yjs`. The inline rope structure updates can be enabled or disabled by editing [the constant at the top of src/list/doc.rs](https://github.com/josephg/diamond-types/blob/42a8bc8fb4d44671147ccaf341eee18d77b2d532/src/list/doc.rs#L15). You can look at memory statistics by running `cargo run --release --features memusage --example stats`.\n\nDiamond is compiled to wasm using [this wrapper](https://github.com/josephg/diamond-js/tree/6e8a95670b651c0aaa7701a1a763778d3a486b0c), hardcoded to point to a local copy of diamond-types from git. The wasm bundle is optimized with wasm-opt.\n\nThe charts were made on [ObservableHQ](https://observablehq.com/@josephg/crdt-algorithm-performance-benchmarks).\n\n\n### Are Automerge and Yjs doing the same thing?\n\nThroughout this post I've been comparing the performance of implementations of RGA (automerge) and YATA (Yjs + my rust implementation) interchangeably.\n\nDoing this rests on the assumption that the concurrent merging behaviour for YATA and RGA are basically the same, and that you can swap between CRDT behaviour without changing your implementation, or your implementation performance. This is a novel idea that I think nobody has looked at before.\n\nI feel confident in this claim because I demonstrated it in my [reference CRDT implementation](https://github.com/josephg/reference-crdts), which has identical performance (and an almost identical codepath) when using Yjs or automerge's behaviour. There might be some performance differences with conflict-heavy editing traces - but that's extremely rare in practice.\n\nI'm also confident you could modify Yjs to implement RGA's behaviour if you wanted to, without changing Yjs's performance. You would just need to:\n\n- Change Yjs's *integrate* method (or make an alternative) which used slightly different logic for concurrent edits\n- Store *seq* instead of *originRight* in each *Item*\n- Store *maxSeq* in the document, and keep it up to date and\n- Change Yjs's binary encoding format.\n\nI talked to Kevin about this, and he doesn't see any point in adding RGA support into his library. It's not something anybody actually asks for. And RGA can have weird [interleaving](https://www.cl.cam.ac.uk/~arb33/papers/KleppmannEtAl-InterleavingAnomalies-PaPoC2019.pdf) when prepending items.\n\nFor diamond, I make my code accept a type parameter for switching between Yjs and automerge's behaviour. I'm not sure if I want to. Kevin is probably right - I don't think this is something people ask for.\n\n---\n\nWell, there is one way in which Yjs has a definite edge over automerge: Yjs doesn't record *when* each item in a document has been deleted. Only whether each item has been deleted or not. This has some weird implications:\n\n- Storing when each delete happened has a weirdly large impact on memory usage and on-disk storage size. Adding this data doubles diamond's memory usage from 1.12mb to 2.34mb, and makes the system about 5% slower.\n- Yjs doesn't store enough information to implement per-keystroke editing replays or other fancy stuff like that. (Maybe thats what people want? Is it weird to have every errant keystroke recorded?)\n- Yjs needs to encode information about which items have been deleted into the *version* field. In diamond, versions are tens of bytes. In yjs, versions are ~4kb. And they grow over time as the document grows. Kevin assures me that this information is basically always small in practice. He might be right but this still makes me weirdly nervous.\n\nFor now, the master branch of diamond includes temporal deletes. But all benchmarks in this blog post use a [yjs-style branch of diamond-types](https://github.com/josephg/diamond-types/tree/yjs-style), which matches how Yjs works instead. This makes for a fairer comparison with yjs, but diamond 1.0 might have a slightly different performance profile. (There's plenty of puns here about diamond not being polished yet, but I'm not sharp enough for those right now.)\n\n\n### These benchmarks measure the wrong thing\n\nThis post only measures the time taken to replay a local editing trace. And I'm measuring the resulting RAM usage. Arguably accepting incoming changes from the user only needs to happen fast *enough*. Fingers simply don't type very fast. Once a CRDT can handle any local user edit in under about 1ms, going faster probably doesn't matter much. (And automerge usually performs that well already, barring some unlucky GC pauses.)\n\nThe *actually important* metrics are:\n\n- How many bytes does a document take on disk or over the network\n- How much time does the document take to save and load\n- How much time it takes to update a document stored at rest (more below)\n\nThe editing trace I'm using here also only has a single user making edits. There could be pathological performance cases lurking in the shadows when users make concurrent edits.\n\nI did it this way because I haven't implemented a binary format in my reference-crdts implementation or diamond yet. If I did, I'd probably copy Yjs & automerge's binary formats because they're so compact. So I expect the resulting binary size would be similar between all of these implementations, except for delete operations. Performance for loading and saving will probably approximately mirror the benchmarks I showed above. Maybe. Or maybe I'm wrong. I've been wrong before. It would be fun to find out.\n\n---\n\nThere's one other performance measure I think nobody is taking seriously enough at the moment. And that is, how we update a document at rest (in a database). Most applications aren't collaborative text editors. Usually applications are actually interacting with databases full of tiny objects. Each of those objects is very rarely written to.\n\nIf you want to update a single object in a database using Yjs or automerge today you need to:\n\n1. Load the whole document into RAM\n2. Make your change\n3. Save the whole document back to disk again\n\nThis is going to be awfully slow. There are better approaches for this - but as far as I know, nobody is working on this at all. We could use your help!\n\n> Edit: Kevin says you can adapt Yjs's providers to implement this in a reasonable way. I'd love to see that in action.\n\n---\n\nThere's another approach to making CRDTs fast, which I haven't mentioned here at all and that is *pruning*. By default, list CRDTs like these only ever grow over time (since we have to keep tombstones for all deleted items). A lot of the performance and memory cost of CRDTs comes from loading, storing and searching that growing data set. There are some approaches which solve this problem by finding ways to shed some of this data entirely. For example, Yjs's GC algorithm, or [Antimatter](https://braid.org/antimatter). That said, git repositories only ever grow over time and nobody seems mind too much. Maybe it doesn't matter so long as the underlying system is fast enough?\n\nBut pruning is orthogonal to everything I've listed above. Any good pruning system should also work with all of the algorithms I've talked about here.\n\n\n### Each step in this journey changes too many variables\n\nEach step in this optimization journey involves changes to multiple variables and I'm not isolating those changes. For example, moving from automerge to my reference-crdts implementation changed:\n\n- The core data structure (tree to list)\n- Removed immutablejs\n- Removed automerge's frontend / backend protocol. And all those Uint8Arrays that pop up throughout automerge for whatever reason are gone too, obviously.\n- The javascript style is totally different. (FP javascript -> imperative)\n\nWe got 10x performance from all this. But I'm only guessing how that 10x speedup should be distributed amongst all those changes.\n\nThe jump from reference-crdts to Yjs, and from Yjs to diamond are similarly monolithic. How much of the speed difference between diamond and Yjs has nothing to do with memory layout, and everything to do with LLVM's optimizer?\n\nThe fact that automerge-rs isn't faster than automerge gives me some confidence that diamond's performance isn't just thanks to rust. But I honestly don't know.\n\nSo, yes. This is a reasonable criticism of my approach. If this problem bothers you, I'd *love* for someone to pull apart each of the performance differences between implementations I show here and tease apart a more detailed breakdown. I'd read the heck out of that. I love benchmarking stories. That's normal, right?\n\n\n## Appendix C: I still don't get it - why is automerge's javascript so slow?\n\nBecause it's not trying to be fast. Look at this code [from automerge](https://github.com/automerge/automerge/blob/d2e7ca2e141de0a72f540ddd738907bcde234183/backend/op_set.js#L649-L659):\n\n```javascript\nfunction lamportCompare(op1, op2) {\n  return opIdCompare(op1.get('opId'), op2.get('opId'))\n}\n\nfunction insertionsAfter(opSet, objectId, parentId, childId) {\n  let childKey = null\n  if (childId) childKey = Map({opId: childId})\n\n  return opSet\n    .getIn(['byObject', objectId, '_following', parentId], List())\n    .filter(op => op.get('insert') && (!childKey || lamportCompare(op, childKey) < 0))\n    .sort(lamportCompare)\n    .reverse() // descending order\n    .map(op => op.get('opId'))\n}\n```\n\nThis is called on each insert, to figure out how the children of an item should be sorted. I don't know how hot it is, but there are *so many things* slow about this:\n\n- I can spot 7 allocations in this function. (Though the 2 closures should be hoisted). (Can you find them all?)\n- The items are already sorted reverse-lamportCompare before this method is called. Sorting an anti-sorted list is the slowest way to sort anything. Rather than sorting, then reverse()'ing, this code should just invert the arguments in `lamportCompare` (or negate the return value).\n- The goal is to insert a new item into an already sorted list. You can do that much faster with a for loop.\n- This code wraps childId into an immutablejs Map, just so the argument matches `lamportCompare` - which then unwraps it again. Stop - I'm dying!\n\nBut in practice this code is going to be replaced by WASM calls through to [automerge-rs](https://github.com/automerge/automerge-rs). Maybe it already has been replaced with automerge-rs by the time you're reading this! So it doesn't matter. Try not to think about it. Definitely don't submit any PRs to fix all the low hanging fruit. *twitch.*\n\n\n## Acknowledgements\n\nThis post is part of the [Braid project](https://braid.org/) and funded by the [Invisible College](https://invisible.college/). If this is the sort of work you want to contribute towards, get in touch. We're hiring.\n\nThankyou to everyone who gave feedback before this post went live.\n\nAnd special thanks to Martin Kleppmann and Kevin Jahns for their work on Automerge and Yjs. Diamond stands on the shoulders of giants.\n\n[Comments on Hacker News](https://news.ycombinator.com/item?id=28017204)\n\n<footer>\n\n[2021 Seph Gentle](https://josephg.com/)\n\n[https://github.com/josephg/](https://github.com/josephg/)\n\n</footer># 5000x faster CRDTs: An Adventure in Optimization\n\n<span class=post-meta>July 31 2021</span>\n\nA few years ago I was really bothered by an academic paper.\n\nSome researchers in France put together a comparison showing lots of ways you could implement realtime collaborative editing (like Google Docs). They implemented lots of algorithms - CRDTs and OT algorithms and stuff. And they benchmarked them all to see how they perform. (Cool!!) Some algorithms worked reasonably well. But others took upwards of 3 seconds to process simple paste operations from their editing sessions. Yikes!\n\nWhich algorithm was that? Well, this is awkward but .. it was mine. I mean, I didn't invent it - but it was the algorithm I was using for ShareJS. The algorithm we used for Google Wave. The algorithm which - hang on - I knew for a fact didn't take 3 seconds to process large paste events. Whats going on here?\n\nI took a closer look at the paper. In their implementation when a user pasted a big chunk of text (like 1000 characters), instead of creating 1 operation with 1000 characters, their code split the insert into 1000 individual operations. And each of those operations needed to be processed separately. Do'h - of course it'll be slow if you do that! This isn't a problem with the operational transformation algorithm. This is just a problem with *their particular implementation*.\n\nThe infuriating part was that several people sent me links to the paper and (pointedly) asked me what I think about it. Written up as a Published Science Paper, these speed comparisons seemed like a Fact About The Universe. And not what they really were - implementation details of some java code, written by a probably overstretched grad student. One of a whole bunch of implementations that they needed to code up.\n\n\"Nooo! The peer reviewed science isn't right everybody! Please believe me!\". But I didn't have a published paper justifying my claims. I had working code but it felt like none of the smart computer science people cared about that. Who was I? I was nobody.\n\n---\n\nEven talking about this stuff we have a language problem. We describe each system as an \"algorithm\". Jupiter is an Algorithm. RGA is an Algorithm. But really there are two very separate aspects:\n\n1. The black-box *behaviour* of concurrent edits. When two clients edit the same region of text at the same time, what happens? Are they merged, and if so in what order? What are the rules?\n2. The white-box *implementation* of the system. What programming language are we using? What data structures? How well optimized is the code?\n\nIf some academic's code runs slowly, what does that actually teach us? Maybe it's like tests. A passing test suite *suggests*, but can never *prove* that there are no bugs. Likewise a slow implementation suggests, but can never prove that every implementation of the system will be slow. If you wait long enough, somebody will find more bugs. And, maybe, someone out there can design a faster implementation.\n\nYears ago I translated my old text OT code into C, Javascript, Go, Rust and Swift. Each implementation has the same behaviour, and the same algorithm. But the performance is not even close. In javascript my transform function ran about 100 000 times per second. Not bad! But the same function in C does 20M iterations per second. That's 200x faster. Wow!\n\nWere the academics testing a slow version or the fast version of this code? Maybe, without noticing, they had fast versions of some algorithms and slow versions of others. It's impossible to tell from the paper!\n\n\n## Making CRDTs fast\n\nSo as you may know, I've been getting interested in CRDTs lately. For the uninitiated, CRDTs [(Conflict-Free Replicated Data types)](https://en.wikipedia.org/wiki/Conflict-free_replicated_data_type) are fancy programming tools which let multiple users edit the same data at the same time. They let you work locally with no lag. (You don't even have to be online). And when you do sync up with other users & devices, everything just magically syncs up and becomes eventually consistent. The best part of CRDTs is that they can do all that without even needing a centralized computer in the cloud to monitor and control everything.\n\nI want Google Docs without google. I want my apps to seamlessly share data between all my devices, without me needing to rely on some [flakey startup](https://ourincrediblejourney.tumblr.com/)'s servers to still be around in another decade. I think they're the [future of collaborative editing](https://josephg.com/blog/crdts-are-the-future/). And maybe the future of all software - but I'm not ready to talk about that yet.\n\nBut most CRDTs you read about in academic papers are crazy slow. A decade ago I decided to stop reading academic papers and dismissed them. I assumed CRDTs had some inherent problem. A GUID for every character? Nought but madness comes from those strange lands! But - and this is awkward to admit - I think I've been making the same mistake as those researchers. I was reading papers which described the *behaviour* of different systems. And I assumed that meant we knew how the best way to *implement* those systems. And wow, I was super wrong.\n\nHow wrong? Well. Running [this editing trace](https://github.com/automerge/automerge-perf/), [Automerge](https://github.com/automerge/automerge/) (a popular CRDT, written by [a popular researcher](https://martin.kleppmann.com/)) takes nearly 5 minutes to run. I have a [new implementation](https://github.com/josephg/diamond-types) that can process the same editing trace in 56 milliseconds. Thats 0.056 seconds, which is over 5000x faster. It's the largest speed up I've ever gotten from optimization work - and I'm utterly delighted by it.\n\nLets talk about why automerge is currently slow, and I'll take you through all the steps toward making it super fast.\n\nWait, no. First we need to start with:\n\n\n### What is automerge?\n\nAutomerge is a library to help you do collaborative editing. It's written by Martin Kleppmann, who's a little bit famous from his book and [excellent talks](https://martin.kleppmann.com/2020/07/06/crdt-hard-parts-hydra.html). Automerge is based on an algorithm called RGA, which you can read about in an academic paper if you're into that sort of thing.\n\nMartin explains automerge far better than I will in this talk from 2020:\n\n<iframe class=\"youtube\" src=\"https://www.youtube-nocookie.com/embed/x7drE24geUw?start=1237\" title=\"YouTube video player\" frameborder=\"0\" allow=\"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture\" allowfullscreen></iframe>\n\nAutomerge (and Yjs and other CRDTs) think of a shared document as a list of characters. Each character in the document gets a unique ID, and whenever you insert into the document, you name what you're inserting after.\n\nImagine I type \"abc\" into an empty document. Automerge creates 3 items:\n\n- Insert *'a'* id `(seph, 0)` after `ROOT`\n  - Insert *'b'* id `(seph, 1)` after `(seph, 0)`\n    - Insert *'c'* id `(seph, 2)` after `(seph, 1)`\n\nWe can draw this as a tree!\n\n![tree with \"abc\" inserts](automerge1.drawio.svg)\n\nLets say Mike inserts an 'X' between *a* and *b*, so we get \"aXbc\". Then we have:\n\n- Insert *'a'* id `(seph, 0)` after `ROOT`\n  - Insert *'X'* id `(mike, 0)` after `(seph, 0)`\n  - Insert *'b'* id `(seph, 1)` after `(seph, 0)`\n    - Insert *'c'* id `(seph, 2)` after `(seph, 1)`\n\n![tree with \"aXbc\"](automerge2.drawio.svg)\n\nNote the 'X' and 'b' both share the same parent. This will happen when users type concurrently in the same location in the document. But how do we figure out which character goes first? We could just sort using their agent IDs or something. But argh, if we do that the document could end up as *abcX*, even though Mike inserted *X* before the *b*. That would be really confusing.\n\nAutomerge (RGA) solves this with a neat hack. It adds an extra integer to each item called a *sequence number*. Whenever you insert something, you set the new item's sequence number to be 1 bigger than the biggest sequence number you've ever seen:\n\n- Insert *'a'* id `(seph, 0)` after `ROOT`, seq: *0*\n  - Insert *'X'* id `(mike, 0)` after `(seph, 0)`, seq: *3*\n  - Insert *'b'* id `(seph, 1)` after `(seph, 0)`, seq: *1*\n    - Insert *'c'* id `(seph, 2)` after `(seph, 1)`, seq: *2*\n\nThis is the algorithmic version of \"Wow I saw a sequence number, and it was *this big!*\" \"Yeah? Mine is *even bigger!*\"\n\nThe rule is that children are sorted first based on their sequence numbers (bigger sequence number first). If the sequence numbers match, the changes must be concurrent. In that case we can sort them arbitrarily based on their agent IDs. (We do it this way so all peers end up with the same resulting document.)\n\nYjs - which we'll see more of later - implements a CRDT called YATA. YATA is identical to RGA, except that it solves this problem with a slightly different hack. But the difference isn't really important here.\n\nAutomerge (RGA)'s *behaviour* is defined by this algorithm:\n\n- Build the tree, connecting each item to its parent\n- When an item has multiple children, sort them by sequence number then by their ID.\n- The resulting list (or text document) can be made by flattening the tree with a depth-first traversal.\n\nSo how should you *implement* automerge? The automerge library does it in the obvious way, which is to store all the data as a tree. (At least I think so - after typing \"abc\" [this is automerge's internal state](https://gist.github.com/josephg/0522c4aec5021cc1dddb60e778828dbe). Uh, uhm, I have no idea whats going on here. And what are all those Uint8Arrays doing all over the place? Whatever.) The automerge library works by building a tree of items.\n\nFor a simple benchmark, I'm going to test automerge using [an editing trace Martin himself made](https://github.com/automerge/automerge-perf/). This is a character by character recording of Martin typing up an academic paper. There aren't any concurrent edits in this trace, but users almost never actually put their cursors at exactly the same place and type anyway, so I'm not too worried about that. I'm also only counting the time taken to apply this trace *locally*, which isn't ideal but it'll do. Kevin Jahns (Yjs's author) has a much more [extensive benchmarking suite here](https://github.com/dmonad/crdt-benchmarks) if you're into that sort of thing. All the benchmarks here are done on my chonky ryzen 5800x workstation, with Nodejs v16.1 and rust 1.52 when that becomes appropriate. (Spoilers!)\n\nThe editing trace has 260 000 edits, and the final document size is about 100 000 characters.\n\nAs I said above, automerge takes a little under 5 minutes to process this trace. Thats just shy of 900 edits per second, which is probably fine. But by the time it's done, automerge is using 880 MB of RAM. Whoa! That's 10kb of ram *per key press*. At peak, automerge was using 2.6 GB of RAM!\n\nTo get a sense of how much overhead there is, I'll compare this to [a baseline benchmark](https://gist.github.com/josephg/13efc1444660c07870fcbd0b3e917638#file-js_baseline-js) where we just splice all the edits directly into a javascript string. This throws away all the information we need to do collaborative editing, but it gives us a sense of how fast javascript is capable of going. It turns out javascript running on V8 is *fast*:\n\n| Test                              | Time taken | RAM usage |\n|:--------------------------        | ----------:| ---------:|\n| **automerge (v1.0.0-preview2)**   |  291s      | 880 MB    |\n| *Plain string edits in JS*        | 0.61s      | 0.1 MB    |\n\nThis is a chart showing the time taken to process each operation throughout the test, averaged in groups of 1000 operations. I think those spikes are V8's garbage collector trying to free up memory.\n\n![automerge performance chart](am_perf1.svg)\n\nIn the slowest spike near the end, a single edit took *1.8 seconds* to process. Oof. In a real application, the whole app (or browser tab) would freeze up for a couple of seconds sometimes while you're in the middle of typing.\n\nThe chart is easier to read when we average everything out a bit and zoom the Y axis. We can see the average performance gets gradually (roughly linearly) worse over time.\n\n![automerge performance chart smoothed out](am_perf1_smooth.svg)\n\n### Why is automerge slow though?\n\nAutomerge is slow for a whole slew of reasons:\n\n1. Automerge's core tree based data structure gets big and slow as the document grows.\n2. Automerge makes heavy use of [Immutablejs](https://immutable-js.github.io/). Immutablejs is a library which gives you clojure-like copy-on-write semantics for javascript objects. This is a cool set of functionality, but the V8 optimizer & GC struggles to optimize code that uses immutablejs. As a result, it increases memory usage and decreases performance.\n3. Automerge treats each inserted character as a separate item. Remember that paper I talked about earlier, where copy+paste operations are slow? Automerge does that too!\n\nAutomerge was just never written with performance in mind. Their team is working on a replacement [rust implementation of the algorithm](https://github.com/automerge/automerge-rs/) to run through wasm, but at the time of writing it hasn't landed yet. I got the master branch working, but they have some kinks to work out before it's ready. Switching to the automerge-rs backend doesn't make average performance in this test any faster. (Although it does halve memory usage and smooth out performance.)\n\n---\n\nThere's an old saying with performance tuning:\n\n> You can't make the computer faster. You can only make it do less work.\n\nHow do we make the computer do less work here? There's lots of performance wins to be had from going through the code and improving lots of small things. But the automerge team has the right approach. It's always best to start with macro optimizations. Fix the core algorithm and data structures before moving to optimizing individual methods. There's no point optimizing a function when you're about to throw it away in a rewrite.\n\nBy far, Automerge's biggest problem is its complex tree based data structure. And we can replace it with something faster.\n\n\n## Improving the data structure\n\nLuckily, there's a better way to implement CRDTs, pioneered in [Yjs](https://github.com/yjs/yjs). Yjs is another (competing) opensource CRDT implementation made by Kevin Jahns. It's fast, well documented and well made. If I were going to build software which supports collaborative editing today, I'd use Yjs.\n\nYjs doesn't need a whole blog post talking about how to make it fast because it's already pretty fast, as we'll see soon. It got there by using a clever, obvious data structure \"trick\" that I don't think anyone else in the field has noticed. Instead of implementing the CRDT as a tree like automerge does:\n\n```javascript\nstate = {\n  { item: 'a', id: ['seph', 0], seq: 0, children: [\n    { item: 'X', id, seq, children: []},\n    { item: 'b', id, seq, children: [\n      { item: 'c', id, seq, children: []}\n    ]}\n  ]}\n}\n```\n\nYjs just puts all the items in a single flat list:\n\n```javascript\nstate = [\n  { item: 'a', id: ['seph', 0], seq: 0, parent: null },\n  { item: 'X', id, seq, parent: ['seph', 0] },\n  { item: 'b', id, seq, parent: ['seph', 0] },\n  { item: 'c', id, seq, parent: [..] }\n]\n```\n\nThat looks simple, but how do you insert a new item into a list? With automerge it's easy:\n\n1. Find the parent item\n2. Insert the new item into the right location in the parents' list of children\n\nBut with this list approach it's more complicated:\n\n1. Find the parent item\n2. Starting right after the parent item, iterate through the list until we find the location where the new item should be inserted (?)\n3. Insert it there, splicing into the array\n\nEssentially, this approach is just a fancy insertion sort. We're implementing a list CRDT with a list. Genius!\n\nThis sounds complicated - how do you figure out where the new item should go? But it's complicated in the same way *math* is complicated. It's hard to understand, but once you understand it, you can implement the whole insert function in about 20 lines of code:\n\n(But don't be alarmed if this looks confusing - we could probably fit everyone on the planet who understands this code today into a small meeting room.)\n\n```javascript\nconst automergeInsert = (doc, newItem) => {\n  const parentIdx = findItem(doc, newItem.parent) // (1)\n\n  // Scan to find the insert location\n  let i\n  for (i = parentIdx + 1; i < doc.content.length; i++) {\n    let o = doc.content[i]\n    if (newItem.seq > o.seq) break // Optimization.\n    let oparentIdx = findItem(doc, o.parent)\n\n    // Should we insert here? (Warning: Black magic part)\n    if (oparentIdx < parentIdx\n      || (oparentIdx === parentIdx\n        && newItem.seq === o.seq\n        && newItem.id[0] < o.id[0])\n    ) break\n  }\n  // We've found the position. Insert at position *i*.\n  doc.content.splice(i, 0, newItem) // (2)\n\n  // .. And do various bookkeeping.\n}\n```\n\nI implemented both Yjs's CRDT (YATA) and Automerge using this approach in my experimental [*reference-crdts*](https://github.com/josephg/reference-crdts/blob/main/crdts.ts) codebase. [Here's the insert function, with a few more comments](https://github.com/josephg/reference-crdts/blob/fed747255df9d457e11f36575de555b39f07e909/crdts.ts#L401-L459). The Yjs version of this function is in the same file, if you want to have a look. Despite being very different papers, the logic for inserting is almost identical. And even though my code is very different, this approach is *semantically* identical to the actual automerge, and Yjs and sync9 codebases. ([Fuzzer verified (TM)](https://github.com/josephg/reference-crdts/blob/main/reference_test.ts)).\n\nIf you're interested in going deeper on this, I gave [a talk about this approach](https://invisiblecollege.s3-us-west-1.amazonaws.com/braid-meeting-10.mp4#t=300) at a [braid](https://braid.org/) meeting a few weeks ago.\n\nThe important point is this approach is better:\n\n1. We can use a flat array to store everything, rather than an unbalanced tree. This makes everything smaller and faster for the computer to process.\n2. The code is really simple. Being faster *and* simpler moves the [Pareto efficiency frontier](https://en.wikipedia.org/wiki/Pareto_efficiency). Ideas which do this are rare and truly golden.\n3. You can implement lots of CRDTs like this. Yjs, Automerge, Sync9 and others work. You can implement many list CRDTs in the same codebase. In my reference-crdts codebase I have an implementation of both RGA (automerge) and YATA (Yjs). They share most of their code (everything except this one function) and their performance in this test is identical.\n\nTheoretically this algorithm can slow down when there are concurrent inserts in the same location in the document. But that's really rare in practice - you almost always just insert right after the parent item.\n\nUsing this approach, my implementation of automerge's algorithm is about 10x faster than the real automerge. And it's 30x more memory-efficient:\n\n| Test                              | Time taken | RAM usage |\n|:--------------------------        | ----------:| ---------:|\n| automerge (v1.0.0-preview2)       |  291s      | 880 MB    |\n| **reference-crdts (automerge / Yjs)** |   31s      |  28 MB    |\n| *Plain string edits in JS*        | 0.61s      | 0.1 MB    |\n\nI wish I could attribute *all* of that difference to this sweet and simple data structure. But a lot of the difference here is probably just immutablejs gumming automerge up.\n\nIt's a lot faster than automerge:\n\n![Automerge is much slower than reference-crdts](ref_vs_am_perf.svg)\n\n\n## Death by 1000 scans\n\nWe're using a clean and fast core data abstraction now, but the implementation is still not *fast*. There are two big performance bottlenecks in this codebase we need to fix:\n\n1. Finding the location to insert, and\n2. Actually inserting into the array\n\n(These lines are marked *(1)* and *(2)* in the code listing above).\n\nTo understand why this code is necessary, lets say we have a document, which is a list of items.\n\n```javascript\nstate = [\n  { item: 'a', isDeleted: false, id: ['seph', 0], seq, parent: null },\n  { item: 'X', isDeleted: false, id, seq, parent: ['seph', 0] },\n  { item: 'b', isDeleted: true,  id, seq, parent: ['seph', 0] },\n  { item: 'c', isDeleted: false, id, seq, parent: ['seph', 1] },\n  ...\n]\n```\n\nAnd some of those items might have been deleted. I've added an `isDeleted` flag to mark which ones. (Unfortunately we can't just remove them from the array because other inserts might depend on them. Drat! But that's a problem for another day.)\n\nImagine the document has 150 000 array items in it, representing 100 000 characters which haven't been deleted. If the user types an 'a' in the middle of the document (at *document position* 50 000), what index does that correspond to in our array? To find out, we need to scan through the document (skipping deleted items) to figure out the right array location.\n\nSo if the user inserts at position 50 000, we'll probably have to linearly scan past 75 000 items or something to find the insert position. Yikes!\n\nAnd then when we actually insert, the code does this, which is double yikes:\n\n```javascript\ndoc.content.splice(destIdx, 0, newItem)\n```\n\nIf the array currently has 150 000 items, javascript will need to move every single item *after* the new item once space forward in the array. This part happens in native code, but it's still probably slow when we're moving so many items. (Aside: V8 is actually suspiciously fast at this part, so maybe v8 isn't using an array internally to implement Arrays? Who knows!)\n\nBut in general, inserting an item into a document with *n* items will take about *n* steps. Wait, no - it's worse than that because deleted items stick around. Inserting into a document where there have *ever been* *n* items will take *n* steps. This algorithm is reasonably fast, but it gets slower with every keystroke. Inserting *n* characters will take *O(n^2)*.\n\nYou can see this if we zoom in on the diagram above. There's a lot going on here because Martin's editing position bounced around the document. But there's a strong linear trend up and to the right, which is what we would expect when inserts take *O(n)* time:\n\n![reference crdts implementation zoomed in](ref_perf3.svg)\n\nAnd why this shape in particular? And why does performance get better near the end? If we simply graph *where* each edit happened throughout the editing trace, with the same bucketing and smoothing, the result is a very familiar curve:\n\n![Edit position throughout document](inspos.svg)\n\nIt looks like the time spent applying changes is dominated by the time it takes to scan through the document's array.\n\n## Changing the data structure\n\nCan we fix this? Yes we can! And by \"we\", I mean Kevin fixed these problems in Yjs. How did he manage that?\n\nSo remember, there are two problems to fix:\n\n1. How do we find a specific insert position?\n2. How do we efficiently insert content at that location?\n\nKevin solved the first problem by thinking about how humans actually edit text documents. Usually while we're typing, we don't actually bounce around a document very much. Rather than scanning the document each time an edit happens, Yjs caches the last *(index, position)* pair where the user made an edit. The next edit will probably be pretty close to the previous edit, so Kevin just scans forwards or backwards from the last editing position. This sounds a little bit dodgy to me - I mean, thats a big assumption to make! What if edits happen randomly?! But people don't actually edit documents randomly, so it works great in practice.\n\n(What if two users are editing different parts of a document at the same time? Yjs actually stores a whole set of cached locations, so there's almost always a cached cursor location near each user no matter where they're making changes in the document.)\n\nOnce Yjs finds the target insert location, it needs to insert efficiently, without copying all the existing items. Yjs solves that by using a bidirectional linked list instead of an array. So long as we have an insert position, linked lists allow inserts in constant time.\n\nYjs does one more thing to improve performance. Humans usually type in runs of characters. So when we type \"hello\" in a document, instead of storing:\n\n```javascript\nstate = [\n  { item: 'h', isDeleted: false, id: ['seph', 0], seq, parent: null },\n  { item: 'e', isDeleted: false, id: ['seph', 1], seq, parent: ['seph', 0] },\n  { item: 'l', isDeleted: false, id: ['seph', 2], seq, parent: ['seph', 1] },\n  { item: 'l', isDeleted: false, id: ['seph', 3], seq, parent: ['seph', 2] },\n  { item: 'o', isDeleted: false, id: ['seph', 4], seq, parent: ['seph', 3] },\n]\n```\n\nYjs just stores:\n\n```javascript\nstate = [\n  { item: 'hello', isDeleted: false, id: ['seph', 0], seq, parent: null },\n]\n```\n\nFinally those pesky paste events will be fast too!\n\nThis is the same information, just stored more compactly. Unfortunately we can't collapse the whole document into a single item or something like that using this trick. The algorithm can only collapse inserts when the IDs and parents line up sequentially - but that happens whenever a user types a run of characters without moving their cursor. And that happens a lot.\n\nIn this data set, using spans reduces the number of array entries by 14x. (180k entries down to 12k).\n\nHow fast is it now? This blows me away - Yjs is 30x faster than my reference-crdts implementation in this test. And it only uses about 10% as much RAM. It's *300x faster than automerge!*.\n\n| Test                              | Time taken | RAM usage |\n|:--------------------------        | ----------:| ---------:|\n| automerge (v1.0.0-preview2)       |  291s      | 880 MB    |\n| reference-crdts (automerge / Yjs) |   31s      |  28 MB    |\n| **Yjs (v13.5.5)**                 | 0.97s      | 3.3 MB    |\n| *Plain string edits in JS*        | 0.61s      | 0.1 MB    |\n\nHonestly I'm shocked and a little suspicious of how little ram Yjs uses in this test. I'm sure there's some wizardry in V8 making this possible. It's extremely impressive.\n\nKevin says he wrote and rewrote parts of Yjs 12 times in order to make this code run so fast. If there was a programmer version of the speedrunning community, they would adore Kevin. I can't even put Yjs on the same scale as the other algorithms because it's so fast:\n\n![Yjs performance vs other algorithms](yjs_perf4.svg)\n\nIf we isolate Yjs, you can see it has *mostly* flat performance. Unlike the other algorithms, it doesn't get slower over time, as the document grows:\n\n![Yjs performance isolated](yjs_perf5.svg)\n\nBut I have no idea what those spikes are near the end. They're pretty small in *absolute* terms, but it's still weird! Maybe they happen when the user moves their cursor around the document? Or when the user deletes chunks? I have no idea.\n\nThis is neat, but the real question is: Can we go *even faster*? Honestly I doubt I can make pure javascript run this test any faster than Kevin managed here. But maybe.. just maybe we can be...\n\n## Faster than Javascript\n\nWhen I told Kevin that I thought I could make a CRDT implementation that's way faster than Yjs, he didn't believe me. He said Yjs was already so well optimized, going a lot faster probably wasn't possible. \"Maybe a little faster if you just port it to Rust. But not a lot faster! V8 is really fast these days!!\"\n\nBut I knew something Kevin didn't know: I knew about memory fragmentation and caches. Rust isn't just *faster*. It's also a lower level language, and that gives us the tools we need to control allocations and memory layout.\n\n> Kevin knows this now too, and he's working on [Yrs](https://github.com/yjs/y-crdt) to see if he can claim the performance crown back.\n\nImagine one of our document items in javascript:\n\n```javascript\nvar item = {\n  content: 'hello',\n  isDeleted: false,\n  id: ['seph', 10],\n  seq: 5,\n  parent: ['mike', 2]\n}\n```\n\nThis object is actually a mess like this in memory:\n\n![javascript objects fragmented in memory](mem-frag.drawio.svg)\n\nBad news: *Your computer hates this.*\n\nThis is terrible because all the data is fragmented. It's all separated by pointers.\n\n> And yes, I know, V8 tries its hardest to prevent this sort of thing when it can. But its not magic.\n\nTo arrange data like this, the computer has to allocate memory one by one for each item. This is slow. Then the garbage collector needs extra data to track all of those objects, which is also slow. Later we'll need to read that data. To read it, your computer will often need to go fetch it from main memory, which - you guessed it - is slow as well.\n\nHow slow are main memory reads? [At human scale](https://gist.github.com/hellerbarde/2843375) each L1 cache read takes 0.5 seconds. And a read from main memory takes close to 2 minutes! This is the difference between a single heartbeat, and the time it takes to brush your teeth.\n\nArranging memory like javascript does would be like writing a shopping list. But instead of \"Cheese, Milk, Bread\", your list is actually a scavenger hunt: \"Under the couch\", \"On top of the fridge\", and so on. Under the couch is a little note mentioning you need toothpaste. Needless to say, this makes doing the grocery shopping a lot of work.\n\nTo go faster, we need to squish all the data together so the computer can fetch more information with each read of main memory. (We want a single read of my grocery list to tell us everything we need to know). Linked lists are rarely used in the real world for exactly this reason - *memory fragmentation ruins performance*. I also want to move away from linked lists because the user *does* sometimes hop around the document, which in Yjs has a linear performance cost. Thats probably not a big deal in text editing, but I want this code to be fast in other use cases too. I don't want the program to *ever* need those slow scans.\n\nWe can't fix this in javascript. The problem with fancy data structures in javascript is that you end up needing a lot of exotic objects (like fixed size arrays). All those extra objects make fragmentation worse, so as a result of all your work, your programs often end up running slower anyway. This is the same limitation immutablejs has, and why its performance hasn't improved much in the decade since it was released. The V8 optimizer is very clever, but it's not magic and clever tricks only get us so far.\n\nBut we're not limited to javascript. Even when making webpages, we have WebAssembly these days. We can code this up in *anything*.\n\nTo see how fast we can *really* go, I've been quietly building a CRDT implementation in rust called [Diamond types](https://github.com/josephg/diamond-types). Diamond is almost identical to Yjs, but it uses a [range tree](https://en.wikipedia.org/wiki/Range_tree) instead of a linked list internally to store all of the items.\n\nUnder the hood, my range tree is just a slightly modified b-tree. But usually when people talk about b-trees they mean a [BTreeMap](https://doc.rust-lang.org/std/collections/struct.BTreeMap.html). Thats not what I'm doing here. Instead of storing keys, each internal node of the b-tree stores the total number of characters (recursively) in that item's children. So we can look up any item in the document by character position, or insert or delete anywhere in the document in *log(n)* time.\n\nThis example shows the tree storing a document which currently has 1000 characters:\n\n![b-tree diagram](btree.drawio.svg)\n\n> This is a range tree, right? The [wikipedia article on range trees](https://en.wikipedia.org/wiki/Range_tree) is a pretty weak description of what I'm doing here.\n\nThis solves both of our linear scanning problems from earlier:\n\n- When we want to find the item at position 200, we can just traverse across and down the tree. In the example above, the item with position 350 must be in the middle leaf node here. Trees are very tidy - we can store Martin's editing trace in just 3 levels in our tree, which means in this benchmark we can find any item in about 3 reads from main memory. In practice, most of these reads will already be in your CPU's cache.\n- Updating the tree is fast too. We update a leaf, then update the character counts at its parent, and its parent, all the way up to the root. So again, after 3 or so steps we're done. Much better than shuffling everything in a javascript array.\n\nWe never merge edits from remote peers in this test, but I made that fast too anyway. When merging remote edits we also need to find items by their ID (eg *['seph', 100]*). Diamond has little index to search the b-tree by ID. That codepath doesn't get benchmarked here though. It's fast but for now you'll have to take my word for it.\n\nI'm not using Yjs's trick of caching the last edit location - at least not yet. It might help. I just haven't tried it yet.\n\nRust gives us total control over the memory layout, so we can pack everything in tightly. Unlike in the diagram, each leaf node in my b-tree stores a block of 32 entries, packed in a fixed size array in memory. Inserting with a structure like this results in a little bit of memcpy-ing, but a little bit of memcpy is fine. Memcpy is always faster than I think it will be - CPUs can copy several bytes per clock cycle. Its not the epic hunt of a main memory lookup.\n\nAnd why 32 entries? I ran this benchmark with a bunch of different bucket sizes and 32 worked well. I have no idea why that worked out to be the best.\n\nSpeaking of fast, how fast does it go?\n\nIf we [compile this code to webassembly](https://github.com/josephg/diamond-js) and drive it from javascript like in the other tests, we can now process the whole editing trace in 193 milliseconds. Thats 5x faster than Yjs. And remarkably 3x faster than our baseline test editing a native javascript string, despite doing all the work to support collaborative editing!\n\nJavascript and WASM is now a bottleneck. If we skip javascript and run the benchmark [directly in rust](https://github.com/josephg/diamond-types/blob/42a8bc8fb4d44671147ccaf341eee18d77b2d532/benches/yjs.rs), we can process all 260k edits in this editing trace in just *56 milliseconds*. That's over 5000x faster than where we started with automerge. It can process 4.6 *million* operations every second.\n\n| Test                              | Time taken | RAM usage |\n|:--------------------------        | ----------:| ---------:|\n| automerge (v1.0.0-preview2)       |  291s      | 880 MB    |\n| reference-crdts (automerge / Yjs) |   31s      |  28 MB    |\n| Yjs (v13.5.5)                     | 0.97s      | 3.3 MB    |\n| *Plain string edits in JS*        | 0.61s      | 0.1 MB    |\n| **Diamond (wasm via nodejs)**     | 0.19s      | ???       |\n| **Diamond (native)**              | 0.056s     | 1.1 MB    |\n\nPerformance is smooth as butter. A b-tree doesn't care where edits happen. This system is uniformly fast across the whole document. Rust doesn't need a garbage collector to track memory allocations, so there's no mysterious GC spikes. And because memory is so tightly packed, processing this entire data set (all 260 000) only results in 1394 calls to malloc.\n\n![rust implementation in wasm vs Yjs](rust_perf6.svg)\n\nOh, what a pity. Its so fast you can barely see it next to yjs (*fleexxxx*). Lets zoom in a bit there and bask in that flat line:\n\n![rust implementation in wasm](rust_perf7.svg)\n\nWell, a nearly flat line.\n\nAnd remember, this chart shows the *slow* version. This chart is generated from javascript, calling into rust through WASM. If I run this benchmark natively its another ~4x faster again.\n\nWhy is WASM 4x slower than native execution? Are javascript calls to the WASM VM really that slow? Does LLVM optimize native x86 code better? Or do WASM's memory bounds checks slow it down? I'm so curious!\n\n\n## Struct of arrays or Array of structs?\n\nThis implementation has another small, important change - and I'm not sure if I like it.\n\nIn rust I'm actually doing something like this:\n\n```javascript\ndoc = {\n  textContent: RopeyRope { 'hello' },\n\n  clients: ['seph', 'mike'],\n\n  items: BTree {[\n    // Note: No string content!\n    { len:  5, id: [0, 0], seq, parent: ROOT },\n    { len: -5, id: [1, 0], seq, parent: [0, 0] }, // negative len means the content was deleted\n    ...\n  ]},\n}\n```\n\nNotice the document's text content doesn't live in the list of items anymore. Now it's in a separate data structure. I'm using a rust library for this called [Ropey](https://crates.io/crates/ropey). Ropey implements *another* b-tree to efficiently manage just the document's text content.\n\nThis isn't universally a win. We have unfortunately arrived at the Land of Uncomfortable Engineering Tradeoffs:\n\n- Ropey can to do text-specific byte packing. So with ropey, we use less RAM.\n- When inserting we need to update 2 data structures instead of 1. This makes everything more than twice as slow, and it makes the wasm bundle twice as big  (60kb -> 120kb).\n- For lots of use cases we'll end up storing the document content somewhere else anyway. For example, if you hook this CRDT up to VS Code, the editor will keep a copy of the document at all times anyway. So there's no need to store the document in my CRDT structures as well, at all. This implementation approach makes it easy to just turn that part of the code off.\n\nSo I'm still not sure whether I like this approach.\n\nBut regardless, my CRDT implementation is so fast at this point that most of the algorithm's time is spent updating the document contents in ropey. Ropey on its own takes 29ms to process this editing trace. What happens if I just ... turn ropey off? How fast can this puppy can really go?\n\n| Test                              | Time taken | RAM usage | Data structure |\n|:--------------------------        | ----------:| ---------:|:---------------|\n| automerge (v1.0.0-preview2)       |  291s      | 880 MB    | Naive tree     |\n| reference-crdts (automerge / Yjs) |   31s      |  28 MB    | Array          |\n| Yjs (v13.5.5)                     | 0.97s      | 3.3 MB    | Linked list    |\n| *Plain string edits in JS*        | 0.61s      | 0.1 MB    | *(none)*       |\n| Diamond (wasm via nodejs)         | 0.20s      | ???       | B-Tree         |\n| Diamond (native)                  | 0.056s     | 1.1 MB    | B-Tree         |\n| *Ropey (rust) baseline*           | 0.029s     | 0.2 MB    | *(none)*       |\n| **Diamond (native, no doc content)** | 0.023s  | 0.96 MB   | B-Tree         |\n\nBoom. This is kind of useless, but it's now 14000x faster than automerge. We're processing 260 000 operations in 23ms. Thats 11 million operations per second. I could saturate my home internet connection with keystrokes and I'd still have CPU to spare.\n\n---\n\nWe can calculate the average speed each algorithm processes edits:\n\n![](totals.svg)\n\nBut these numbers are misleading. Remember, automerge and ref-crdts aren't steady. They're fast at first, then slow down as the document grows. Even though automerge can process about 900 edits per second *on average* (which is fast enough that users won't notice), the slowest edit during this benchmark run stalled V8 for a full 1.8 seconds.\n\nWe can put everything in a single, pretty chart if I use a log scale. It's remarkable how tidy this looks:\n\n![all data in one chart](all_perf.svg)\n\n> Huh - look at the bottom two lines. The jitteryness of yjs and diamond mirror each other. Periods when yjs gets slower, diamond gets faster. I wonder whats going on there!\n\nBut log scales are junk food for your intuition. On a linear scale the data looks like this:\n\n![all data in one chart, with a linear scale](all_perf_linear.svg)\n\nThat, my friends, is how you make the computer do a lot less work.\n\n\n## Conclusion\n\nThat silly academic paper I read all those years ago says some CRDTs and OT algorithms are slow. And everyone believed the paper, because it was Published Science. But the paper was wrong. As I've shown, we *can* make CRDTs fast. We can make them *crazy fast* if we get creative with our implementation strategies. With the right approach, we can make CRDTs so fast that we can compete with the performance of native strings. The performance numbers in that paper weren't just wrong. They were \"a billionaire guessing a banana costs $1000\" kind of wrong.\n\nBut you know what? I sort of appreciate that paper now. Their mistake is ok. It's *human*. I used to feel inadequate around academics - maybe I'll never be that smart! But this whole thing made me realise something obvious: Scientists aren't gods, sent from the heavens with the gift of Truth. No, they're beautiful, flawed *people* just like the rest of us mooks. Great at whatever we obsess over, but kind of middling everywhere else. I can optimize code pretty well, but I still get zucchini and cucumber mixed up. And, no matter the teasing I get from my friends, thats ok.\n\nA decade ago Google Wave really needed a good quality list CRDT. I got super excited when the papers for CRDTs started to emerge. [LOGOOT](https://hal.inria.fr/inria-00432368/document) and [WOOT](https://hal.inria.fr/inria-00445975/document) seemed like a big deal! But that excitement died when I realised the algorithms were too slow and inefficient to be practically useful. And I made a big mistake - I assumed if the academics couldn't make them fast, nobody could.\n\nBut sometimes the best work comes out of a collaboration between people with different skills. I'm terrible at academic papers, I'm pretty good at making code run fast. And yet here, in my own field, I didn't even try to help. The researchers were doing their part to make P2P collaborative editing work. And I just thumbed my nose at them all and kept working on Operational Transform. If I helped out, maybe we would have had fast, workable CRDTs for text editing a decade ago. Oops! It turned out collaborative editing needed a collaboration between all of us. How ironic! Who could have guessed?!\n\nWell, it took a decade, some hard work and some great ideas from a bunch of clever folks. The binary encoding system Martin invented for Automerge is brilliant. The system of avoiding UUIDs by using incrementing (agent id, sequence) tuples is genius. I have no idea who came up with that, but I love it. And of course, Kevin's list representation + insertion approach I describe here makes everything so much faster and simpler. I bet 100 smart people must have walked right past that idea over the last decade without any of them noticing it. I doubt I would have thought of it either. My contribution is using run-length encoded b-trees and clever indexing. And showing Kevin's fast list representation can be adapted to any CRDT algorithm. I don't think anyone noticed that before.\n\nAnd now, after a decade of waiting, we finally figured out how to make fast, lightweight list CRDT implementations. Practical decentralized realtime collaborative editing? We're coming for you next.\n\n\n## Appendix A: I want to use a CRDT for my application. What should I do?\n\nIf you're building a document based collaborative application today, you should use [Yjs](https://github.com/yjs/yjs). Yjs has solid performance, low memory usage and great support. If you want help implementing Yjs in your application, Kevin Jahns sometimes accepts money in exchange for help integrating Yjs into various applications. He uses this to fund working on Yjs (and adjacent work) full time. Yjs already runs fast and soon it should become even faster.\n\nThe automerge team is also fantastic. I've had some great conversations with them about these issues. They're making performance the #1 issue of 2021 and they're planning on using a lot of these tricks to make automerge fast. It might already be much faster by the time you're reading this.\n\nDiamond is *really* fast, but there's a lot of work before I have feature parity with Yjs and Automerge. There is a lot more that goes into a good CRDT library than operation speed. CRDT libraries also need to support binary encoding, network protocols, non-list data structures, presence (cursor positions), editor bindings and so on. At the time of writing, diamond does almost none of this.\n\nIf you want database semantics instead of document semantics, as far as I know nobody has done this well on top of CRDTs yet. You can use [ShareDB](https://github.com/share/sharedb/), which uses OT. I wrote ShareDB years ago, and it's well used, well maintained and battle tested.\n\nLooking forward, I'm excited for [Redwood](https://github.com/redwood/redwood) - which supports P2P editing and has planned full CRDT support.\n\n\n## Appending B: Lies, damned lies and benchmarks\n\nIs this for real? Yes. But performance is complicated and I'm not telling the full picture here.\n\nFirst, if you want to play with any of the benchmarks I ran yourself, you can. But everything is a bit of a mess.\n\nThe benchmark code for the JS plain string editing baseline, Yjs, automerge and reference-crdts tests is all in [this github gist](https://gist.github.com/josephg/13efc1444660c07870fcbd0b3e917638). It's a mess; but messy code is better than missing code.\n\nYou'll also need `automerge-paper.json.gz` from [josephg/crdt-benchmarks](https://github.com/josephg/crdt-benchmarks) in order to run most of these tests. The reference-crdts benchmark depends on [crdts.ts from josephg/reference-crdts, at this version](https://github.com/josephg/reference-crdts/tree/fed747255df9d457e11f36575de555b39f07e909).\n\nDiamond's benchmarks come from [josephg/diamond-types, at this version](https://github.com/josephg/diamond-types/tree/42a8bc8fb4d44671147ccaf341eee18d77b2d532). Benchmark by running ` RUSTFLAGS='-C target-cpu=native' cargo criterion yjs`. The inline rope structure updates can be enabled or disabled by editing [the constant at the top of src/list/doc.rs](https://github.com/josephg/diamond-types/blob/42a8bc8fb4d44671147ccaf341eee18d77b2d532/src/list/doc.rs#L15). You can look at memory statistics by running `cargo run --release --features memusage --example stats`.\n\nDiamond is compiled to wasm using [this wrapper](https://github.com/josephg/diamond-js/tree/6e8a95670b651c0aaa7701a1a763778d3a486b0c), hardcoded to point to a local copy of diamond-types from git. The wasm bundle is optimized with wasm-opt.\n\nThe charts were made on [ObservableHQ](https://observablehq.com/@josephg/crdt-algorithm-performance-benchmarks).\n\n\n### Are Automerge and Yjs doing the same thing?\n\nThroughout this post I've been comparing the performance of implementations of RGA (automerge) and YATA (Yjs + my rust implementation) interchangeably.\n\nDoing this rests on the assumption that the concurrent merging behaviour for YATA and RGA are basically the same, and that you can swap between CRDT behaviour without changing your implementation, or your implementation performance. This is a novel idea that I think nobody has looked at before.\n\nI feel confident in this claim because I demonstrated it in my [reference CRDT implementation](https://github.com/josephg/reference-crdts), which has identical performance (and an almost identical codepath) when using Yjs or automerge's behaviour. There might be some performance differences with conflict-heavy editing traces - but that's extremely rare in practice.\n\nI'm also confident you could modify Yjs to implement RGA's behaviour if you wanted to, without changing Yjs's performance. You would just need to:\n\n- Change Yjs's *integrate* method (or make an alternative) which used slightly different logic for concurrent edits\n- Store *seq* instead of *originRight* in each *Item*\n- Store *maxSeq* in the document, and keep it up to date and\n- Change Yjs's binary encoding format.\n\nI talked to Kevin about this, and he doesn't see any point in adding RGA support into his library. It's not something anybody actually asks for. And RGA can have weird [interleaving](https://www.cl.cam.ac.uk/~arb33/papers/KleppmannEtAl-InterleavingAnomalies-PaPoC2019.pdf) when prepending items.\n\nFor diamond, I make my code accept a type parameter for switching between Yjs and automerge's behaviour. I'm not sure if I want to. Kevin is probably right - I don't think this is something people ask for.\n\n---\n\nWell, there is one way in which Yjs has a definite edge over automerge: Yjs doesn't record *when* each item in a document has been deleted. Only whether each item has been deleted or not. This has some weird implications:\n\n- Storing when each delete happened has a weirdly large impact on memory usage and on-disk storage size. Adding this data doubles diamond's memory usage from 1.12mb to 2.34mb, and makes the system about 5% slower.\n- Yjs doesn't store enough information to implement per-keystroke editing replays or other fancy stuff like that. (Maybe thats what people want? Is it weird to have every errant keystroke recorded?)\n- Yjs needs to encode information about which items have been deleted into the *version* field. In diamond, versions are tens of bytes. In yjs, versions are ~4kb. And they grow over time as the document grows. Kevin assures me that this information is basically always small in practice. He might be right but this still makes me weirdly nervous.\n\nFor now, the master branch of diamond includes temporal deletes. But all benchmarks in this blog post use a [yjs-style branch of diamond-types](https://github.com/josephg/diamond-types/tree/yjs-style), which matches how Yjs works instead. This makes for a fairer comparison with yjs, but diamond 1.0 might have a slightly different performance profile. (There's plenty of puns here about diamond not being polished yet, but I'm not sharp enough for those right now.)\n\n\n### These benchmarks measure the wrong thing\n\nThis post only measures the time taken to replay a local editing trace. And I'm measuring the resulting RAM usage. Arguably accepting incoming changes from the user only needs to happen fast *enough*. Fingers simply don't type very fast. Once a CRDT can handle any local user edit in under about 1ms, going faster probably doesn't matter much. (And automerge usually performs that well already, barring some unlucky GC pauses.)\n\nThe *actually important* metrics are:\n\n- How many bytes does a document take on disk or over the network\n- How much time does the document take to save and load\n- How much time it takes to update a document stored at rest (more below)\n\nThe editing trace I'm using here also only has a single user making edits. There could be pathological performance cases lurking in the shadows when users make concurrent edits.\n\nI did it this way because I haven't implemented a binary format in my reference-crdts implementation or diamond yet. If I did, I'd probably copy Yjs & automerge's binary formats because they're so compact. So I expect the resulting binary size would be similar between all of these implementations, except for delete operations. Performance for loading and saving will probably approximately mirror the benchmarks I showed above. Maybe. Or maybe I'm wrong. I've been wrong before. It would be fun to find out.\n\n---\n\nThere's one other performance measure I think nobody is taking seriously enough at the moment. And that is, how we update a document at rest (in a database). Most applications aren't collaborative text editors. Usually applications are actually interacting with databases full of tiny objects. Each of those objects is very rarely written to.\n\nIf you want to update a single object in a database using Yjs or automerge today you need to:\n\n1. Load the whole document into RAM\n2. Make your change\n3. Save the whole document back to disk again\n\nThis is going to be awfully slow. There are better approaches for this - but as far as I know, nobody is working on this at all. We could use your help!\n\n> Edit: Kevin says you can adapt Yjs's providers to implement this in a reasonable way. I'd love to see that in action.\n\n---\n\nThere's another approach to making CRDTs fast, which I haven't mentioned here at all and that is *pruning*. By default, list CRDTs like these only ever grow over time (since we have to keep tombstones for all deleted items). A lot of the performance and memory cost of CRDTs comes from loading, storing and searching that growing data set. There are some approaches which solve this problem by finding ways to shed some of this data entirely. For example, Yjs's GC algorithm, or [Antimatter](https://braid.org/antimatter). That said, git repositories only ever grow over time and nobody seems mind too much. Maybe it doesn't matter so long as the underlying system is fast enough?\n\nBut pruning is orthogonal to everything I've listed above. Any good pruning system should also work with all of the algorithms I've talked about here.\n\n\n### Each step in this journey changes too many variables\n\nEach step in this optimization journey involves changes to multiple variables and I'm not isolating those changes. For example, moving from automerge to my reference-crdts implementation changed:\n\n- The core data structure (tree to list)\n- Removed immutablejs\n- Removed automerge's frontend / backend protocol. And all those Uint8Arrays that pop up throughout automerge for whatever reason are gone too, obviously.\n- The javascript style is totally different. (FP javascript -> imperative)\n\nWe got 10x performance from all this. But I'm only guessing how that 10x speedup should be distributed amongst all those changes.\n\nThe jump from reference-crdts to Yjs, and from Yjs to diamond are similarly monolithic. How much of the speed difference between diamond and Yjs has nothing to do with memory layout, and everything to do with LLVM's optimizer?\n\nThe fact that automerge-rs isn't faster than automerge gives me some confidence that diamond's performance isn't just thanks to rust. But I honestly don't know.\n\nSo, yes. This is a reasonable criticism of my approach. If this problem bothers you, I'd *love* for someone to pull apart each of the performance differences between implementations I show here and tease apart a more detailed breakdown. I'd read the heck out of that. I love benchmarking stories. That's normal, right?\n\n\n## Appendix C: I still don't get it - why is automerge's javascript so slow?\n\nBecause it's not trying to be fast. Look at this code [from automerge](https://github.com/automerge/automerge/blob/d2e7ca2e141de0a72f540ddd738907bcde234183/backend/op_set.js#L649-L659):\n\n```javascript\nfunction lamportCompare(op1, op2) {\n  return opIdCompare(op1.get('opId'), op2.get('opId'))\n}\n\nfunction insertionsAfter(opSet, objectId, parentId, childId) {\n  let childKey = null\n  if (childId) childKey = Map({opId: childId})\n\n  return opSet\n    .getIn(['byObject', objectId, '_following', parentId], List())\n    .filter(op => op.get('insert') && (!childKey || lamportCompare(op, childKey) < 0))\n    .sort(lamportCompare)\n    .reverse() // descending order\n    .map(op => op.get('opId'))\n}\n```\n\nThis is called on each insert, to figure out how the children of an item should be sorted. I don't know how hot it is, but there are *so many things* slow about this:\n\n- I can spot 7 allocations in this function. (Though the 2 closures should be hoisted). (Can you find them all?)\n- The items are already sorted reverse-lamportCompare before this method is called. Sorting an anti-sorted list is the slowest way to sort anything. Rather than sorting, then reverse()'ing, this code should just invert the arguments in `lamportCompare` (or negate the return value).\n- The goal is to insert a new item into an already sorted list. You can do that much faster with a for loop.\n- This code wraps childId into an immutablejs Map, just so the argument matches `lamportCompare` - which then unwraps it again. Stop - I'm dying!\n\nBut in practice this code is going to be replaced by WASM calls through to [automerge-rs](https://github.com/automerge/automerge-rs). Maybe it already has been replaced with automerge-rs by the time you're reading this! So it doesn't matter. Try not to think about it. Definitely don't submit any PRs to fix all the low hanging fruit. *twitch.*\n\n\n## Acknowledgements\n\nThis post is part of the [Braid project](https://braid.org/) and funded by the [Invisible College](https://invisible.college/). If this is the sort of work you want to contribute towards, get in touch. We're hiring.\n\nThankyou to everyone who gave feedback before this post went live.\n\nAnd special thanks to Martin Kleppmann and Kevin Jahns for their work on Automerge and Yjs. Diamond stands on the shoulders of giants.\n\n[Comments on Hacker News](https://news.ycombinator.com/item?id=28017204)\n\n<footer>\n\n[2021 Seph Gentle](https://josephg.com/)\n\n[https://github.com/josephg/](https://github.com/josephg/)\n\n</footer>","numAgents":1,"txns":[{"parents":[],"numChildren":0,"agent":0,"time":"1970-01-01T00:00:00Z","patches":[[0,0,"Automerge is too slow and clunky. Martin (its principle architect and programmer) recorded himself typing an academic paper. Running his editing history through automerge (his own code) takes 490 seconds, which is a bit less than 10 minutes. Once processed, the editing trace sits on 1.1 GB of RAM. The newly merged performance branch (designed to fix a lot of these problems) is even slower - taking 750 seconds (12.5 minutes) to process the same editing trace.\nI managed to get that 10 minute time down to 70ms (0.07 seconds). Thats the best result I've ever gotten from optimization work, and I'm delighted by it. Let me tell you what I did!\nWhat does automerge do?\nBefore we can go into detail about how I made automerge fast, we have to spend a moment talking about how automerge itself works.\nAn automerge document is actually a tree of inserted characters. Each character in the document has the following properties:\nA unique ID, made up of a tuple of (client ID, sequence number)\nThe ID (or a pointer to) its parent item, which is the item directly before that character when it was inserted.\nThe character itself ('A')\nThere's a couple more fields (eg to mark when characters have been deleted), but essentially thats it. When a character is inserted in the document, automerge figures out the ID of the character immediately before the new character, and inserts the new character as one of its predecessor's *children*. If you just type a linear sequence of characters (as I'm doing right now), you'll end up with a big long chain of characters going down like a linked list.\nSo why is automerge so slow?\nWhen optimizing, I imagine myself manually doing all the work the computer is doing, one step at a time. Then I imagine asking: \"When I get bored, how would I speed this job up?\".\nAutomerge is slow for 3 main reasons:\nIts written in javascript and uses complex data structures. Javascript is reasonably fast for math, but slow and inefficient when using complex data structures.\nAutomerge uses a complex and inefficient data structure\nAutomerge makes extremely heavy use of immutablejs\nEach of these issues accounts for about an order of magnitude slowdown in performance. You can see all 3 issues showing up in this method from the automerge source tree, which is called on each keystroke. Automerge uses this method to figure out where each new character should be placed in the resulting document:\nfunction insertionsAfter(opSet, objectId, parentId, childId) {\n  let childKey = null\n  if (childId) childKey = Map({opId: childId})\n\n  return opSet\n    .getIn(['byObject', objectId, '_following', parentId], List())\n    .filter(op => op.get('insert') && (!childKey || lamportCompare(op, childKey) < 0))\n    .sort(lamportCompare)\n    .reverse() // descending order\n    .map(op => op.get('opId'))\n}\nWhats wrong with this method?\nThis method allocates all over the place. I can spot 5 allocations, not counting any extra nonsense immutablejs is doing. The call to List() has no effect as far as I can tell from reading immutablejs's documentation.\nThe document is always kept in a sorted order anyway, so the calls to sort() and reverse() are unnecessary. The algorithm only needs to figure out where the new child should be inserted. Re-sorting all children is entirely avoidable. Sort functions are often fast when the input is sorted already, but in this case because the sorting function is inverted, the computer always has to sort the entire list.\nYou can't tell from looking at this method, but insertionsAfter \nDespite CRDTs being the \"new hotness\" in the collaborative editing game for years, I've been resisting them. As I said in my [recent blog post about CRDTs](https://josephg.com/blog/crdts-are-the-future/), they've been generally unworkable for real world collaborative editing because:\nThey take up too much space on disk and in memory. (Automerge takes 1.1GB in RAM to store a 100kb document)\nThey consume way too much CPU to process edits\nUntil these issues are addressed, I can't recommend CRDTs for use in general computing.\n"],[0,0,"\n\n\n\n"],[0,0,"A few years ago I was really bothered by an academic paper. Some graduate students in "],[65,21,""],[65,0,"resera"],[70,1,""],[69,1,""],[68,1,""],[68,0,"earchers in France put together a comarison"],[104,0,"p"],[104,1,""],[105,0,"p"],[112,0," showing lots of ways o"],[134,1,""],[134,0,"CRDT and OT algorithms could be implemented to allow for concurrent editing, and they benchmarks"],[229,1,""],[229,0,"ed them."],[236,0," all"],[241,0," Their paper made "],[242,17,""],[242,0,"Lots of people I knew"],[242,4,""],[242,0,"A bunchof"],[250,1,""],[249,1,""],[266,0," all sent me linke"],[283,1,""],[283,0,"s to the paper asking what I thought"],[241,0," I'd stopped working on Google Wave a few years ab"],[290,1,""],[289,1,""],[289,0,"before and I was knee deep reimplementing ShareJS (a javascript library for collabo"],[371,1,""],[370,1,""],[370,0,"borative eidint"],[384,1,""],[383,1,""],[382,1,""],[381,1,""],[380,1,""],[380,0,"diting) using one o t"],[400,1,""],[399,1,""],[399,0,"f"],[241,1,""],[241,0,"\n\n"],[241,0," Some alori"],[251,1,""],[250,1,""],[249,1,""],[249,0,"gort"],[252,1,""],[252,0,"ithms worked reasonably well. And others"],[282,1,""],[281,1,""],[280,1,""],[280,0,". A"],[292,0," took upwards of 30mx"],[312,1,""],[312,0,"s "],[310,0,"0"],[315,0,"to handle a simple copy+paste operation."],[318,7,""],[318,0,"process "],[335,5,""],[281,4,""],[281,0," But"],[281,4,""],[281,0," And"],[309,5,""],[309,0,"3 seconds"],[354,0," from one of their real world editing sesion"],[397,1,""],[396,1,""],[395,1,""],[395,0,"sions"],[401,0,"\n\nWhich algorithm was that? I"],[429,1,""],[429,0,"Mine. Well, I didn't invent it - but it was the algorithm I was using for ShareD"],[508,1,""],[508,0,"JS"],[133,57,""],[129,4,""],[129,0,"algorithms"],[129,10,""],[129,0,"way yo"],[134,1,""],[133,1,""],[132,1,""],[132,0,"s you could implement"],[172,0," (with CRDT and OT algorithms)"],[394,0," Yikes!"],[394,1,""],[394,0,"\n\n"],[403,1,""],[403,0," "],[403,1,""],[402,1,""],[402,0," "],[429,0,"Well, it was "],[442,1,""],[442,0,"m"],[448,5,""],[448,0,"I mean,"],[525,0," "],[525,1,""],[525,0,". The algorithm we used for Google Wave"],[275,3,""],[275,0,"But"],[323,8,""],[322,1,""],[322,0," simple"],[345,0,"s"],[351,7,""],[358,10,""],[357,1,""],[376,1,""],[375,1,""],[375,0," "],[382,1,""],[382,0,"\n\n"],[545,0,". The algorithm I knew for a fact didn't take 3 seconds to process large paste events. What was going on?\n\nI lo"],[652,4,""],[652,0,"Luckily "],[652,8,""],[652,0,"I took a closer look ad"],[674,1,""],[674,0,"nd it seemed like it was amateur hour in thier im"],[715,8,""],[715,0,"their implementation. "],[652,85,""],[652,0,"I took a closer look and it seemed like it was amateur hour in their implementation."],[637,0,"on earth "],[637,9,""],[736,0," When a large past even"],[754,1,""],[755,0," e"],[760,0,"t happened, instead of inserting one block of text, their algorithm was "],[818,10,""],[818,0,"code "],[827,0,"taking each character"],[839,0,"inserted "],[857,0," one by one and inserted"],[880,1,""],[879,1,""],[879,0,"ing them"],[839,48,""],[839,0,"new character one by one and inserte"],[874,1,""],[874,0,"ing them inti"],[886,1,""],[886,0,"o their obviou"],[894,6,""],[894,0,"ca"],[895,1,""],[895,0,"razy lsow "],[900,5,""],[900,0,"slow data structure. Gah - "],[926,1,""],[925,1,""],[925,0,"~ this isn't a problem"],[920,0," I mean, yeah- "],[934,1,""],[933,1,""],[933,0," - of course it'll be slow if you do that! But"],[980,1,""],[980,0,"g"],[1006,0," with the algorithm. Thisis"],[1032,1,""],[1031,1,""],[1031,0," is a "],[1016,9,""],[1016,0,"approach"],[1036,0,"problem withi "],[1049,1,""],[1048,1,""],[1048,0," *your code*."],[742,1,""],[742,0,"a user pasted a block fo "],[766,1,""],[765,1,""],[764,1,""],[764,0,"fo c"],[767,1,""],[766,1,""],[765,1,""],[764,1,""],[764,0,"of code"],[771,27,""],[758,0,"big "],[762,5,""],[762,0,"chunk"],[798,17,""],[798,0,"that stron"],[807,1,""],[806,1,""],[806,0,"ing in one operatoin"],[825,1,""],[824,1,""],[823,1,""],[823,0,"ion"],[771,4,""],[771,0,"text"],[797,0," all of that content"],[817,12,""],[834,1,""],[901,4,""],[901,0,"each one"],[920,6,""],[775,0," (say, 1000 characters)"],[821,22,""],[821,0,"those 1000 characters in"],[875,55,""],[875,0,"splitting each character"],[899,4,""],[904,0," its own edit"],[917,26,""],[917,0,"ing operation. They were processing 1000 operations rather than 1 and"],[1058,39,""],[1058,0,"isn't science. You just wrote"],[1087,18,""],[1089,4,""],[1089,0,"bad"],[1099,0," I can't le"],[1100,10,""],[1100,0,"That doesn't tell us anything about what you're trying to test. It just tells us something about *you*."],[811,15,""],[811,0,"creating 1 operation with"],[852,23,""],[852,0,", their"],[864,4,""],[873,1,""],[872,1,""],[871,1,""],[870,1,""],[870,0," the insert into"],[886,24,""],[886,0," 10000"],[891,1,""],[891,0," operations - each with its"],[910,30,""],[910,0,"which needed to p"],[926,1,""],[926,0,"be processed separately"],[950,56,""],[1010,3,""],[1009,1,""],[1010,6,""],[1010,0,"we can't learn anything from that"],[1043,15,""],[1043,0,"!"],[1034,0,"about the algorithm "],[1064,0," "],[1064,1,""],[1006,58,""],[1006,0,"This isn't a problem with thei"],[1035,1,""],[1034,1,""],[1034,0,"e algorithm. This is just a problem with"],[1074,15,""],[1074,0," your"],[1075,0,"*"],[1080,5,""],[1086,0," mr researcher"],[1086,14,""],[1081,0,"dodgy "],[1093,104,""],[1093,0," I wouldn't mind so much if people I "],[1121,0,"I didn't have people I respected"],[1153,9,""],[1153,0," reading the paper and asking me about it."],[1093,1,""],[1093,0,"\n\n"],[1153,1,""],[1152,1,""],[1153,7,""],[1153,0,"flipping throuhg"],[1168,1,""],[1167,1,""],[1166,1,""],[1166,0,"ugh"],[1203,0,"\n\n"],[1204,1,""],[1203,1,""],[1202,1,""],[1202,0,". Argh!\n\nWhen we think about CRDTs and other concurrenting"],[1259,1,""],[1258,1,""],[1257,1,""],[1257,0," editing "],[1247,19,""],[1247,0,"collaborative editing sytst"],[1273,1,""],[1272,1,""],[1271,1,""],[1271,0,"se"],[1272,1,""],[1272,0,"tems we have  a"],[1286,1,""],[1285,1,""],[1285,0,"a problem with words. We describe each system as an \"algorithm\" - but really there's two things going on"],[1374,0,"very separate "],[1388,6,""],[1388,0,"parts"],[1393,9,""],[1393,0,":\n\n1. The semantics of the system, which we can describe "],[1426,24,""],[1426,0,". When concurrent edits happen in the same place, how d"],[1480,1,""],[1480,0,"can we tell? What "],[1476,22,""],[1476,0,"what happens?"],[1474,0," in the document"],[1497,8,""],[1497,0,"ho"],[1497,2,""],[1497,0,"happens? How does it know? How does it resolve it"],[1544,2,""],[1544,0,"the situation?"],[1403,0,"*"],[1413,0,"*"],[1413,1,""],[1413,0,"*"],[1413,1,""],[1413,0," "],[1413,1,""],[1413,0,"*"],[1471,6,""],[1471,0,"locatoin "],[1479,1,""],[1478,1,""],[1477,1,""],[1476,1,""],[1476,0,"ion "],[1510,18,""],[1545,0,"\n\n2."],[1548,1,""],[1547,1,""],[1546,1,""],[1546,0,"2. The *implementatoin "],[1568,1,""],[1567,1,""],[1566,1,""],[1565,1,""],[1565,0,"ion* of the system. What langue"],[1595,1,""],[1595,0,"a"],[1595,1,""],[1595,0,"age? What data structures? "],[1621,1,""],[1598,0," are we using"],[1634,0," How well optimized is it, for "],[1661,4,""],[1661,0,"and for what scenarios?\n\nIf the semantics are correct"],[1707,7,""],[1707,0,"incorrect, users' edits won't converge. I'll end up looing "],[1765,1,""],[1764,1,""],[1763,1,""],[1762,1,""],[1762,0,"king at a different fr"],[1783,1,""],[1782,1,""],[1782,0,"ver"],[1685,100,""],[1684,1,""],[1684,0,"\n\n"],[1209,0," No! Stop it!"],[1300,18,""],[1300,0,"language problem"],[1433,0,"concurrent editing "],[1603,4,""],[1603,0,"that"],[1607,6,""],[1606,1,""],[1605,1,""],[1604,1,""],[1603,1,""],[1602,1,""],[1601,1,""],[1600,1,""],[1599,1,""],[1702,0,"My text OT algorithm from a few years ago"],[1702,0,"I've implemented "],[1719,3,""],[1719,0,"plain-"],[1743,20,""],[1743,0,"in a bunch of different languages "],[1776,1,""],[1776,0," - I use it as a way to guage"],[1800,5,""],[1800,0,"get a sense of a language w"],[1826,1,""],[1826,0,"I want to learn"],[1724,1,""],[1724,0," "],[1732,10,""],[1719,0,"a simple "],[1741,0," algorithm"],[1786,1,""],[1785,1,""],[1785,0,"."],[1849,0,". "],[1785,66,""],[1785,0,", because I got curious what it would look l"],[1814,15,""],[1814,0,"the same code would look like in C, and Javascript, and Typescript, and"],[1870,15,""],[1870,0,"swif"],[1870,4,""],[1870,0,"Swift and Go and ru"],[1870,10,""],[1879,0,"st"],[1877,1,""],[1877,0,"R"],[1881,0,". Same algorithm"],[1883,14,""],[1883,0,"The same "],[1883,9,""],[1883,0,"Its the same algorithm in each place. The transform"],[1700,0,"\n\nWhen we say a system is "],[1716,10,""],[1715,1,""],[1715,0,"n \"O"],[1718,1,""],[1717,1,""],[1716,1,""],[1716,0," \"algorithm\" is slow, what are we even talking about?"],[1771,4,""],[1771,0,"I"],[1771,0,"A few years ago "],[1801,1,""],[1801,0,"th"],[1801,2,""],[1801,0,"a"],[1869,7,""],[1869,0,"after"],[1874,6,""],[1874,0,"g "],[1875,1,""],[1874,1,""],[1874,0," getting"],[1896,3,""],[1896,0,"the"],[1898,1,""],[1898,0,"at"],[1900,5,""],[1921,3,""],[1921,0," translated into"],[1974,51,""],[1974,0,"The semantics are the same. The performance was absolutely not. In javs"],[2044,1,""],[2044,0,"ascript I could run my transform function abuot"],[2090,1,""],[2089,1,""],[2088,1,""],[2088,0,"out 1000"],[2095,1,""],[2095,0," 000 times per second. Not bad! But the same code"],[2140,4,""],[2140,0,"function in C ran at a rate of 20M/second."],[2154,0,"could "],[2160,16,""],[2160,0,"do"],[2160,3,""],[2160,0,"run "],[2167,0," times"],[2173,1,""],[2173,0," per "],[2185,0," 200x faster. Wow."],[1769,0," Mr "],[1770,3,""],[1769,1,""],[1702,0,"So "],[1705,1,""],[1705,0,"w"],[1705,1,""],[1705,0,"W"],[1704,1,""],[1702,2,""],[1769,0," (I\""],[1772,1,""],[1772,0,"'m looking at *you* mr "],[1794,1,""],[1793,1,""],[1792,1,""],[1792,0,"Mr French Sicn"],[1805,1,""],[1804,1,""],[1803,1,""],[1803,0,"cientist)."],[1802,9,""],[1802,0,"CS Researcher!"],[1819,0,"\nWhen "],[1820,5,""],[1820,0,"Sometimes when I pick up a new language I want to program something I already understand "],[1908,1,""],[1908,0,", in order to get a sense of things. I translated "],[1820,138,""],[1820,0,"Sometimes when I pick up a new language I want to program something I already understand, in order to get a sense of things. I translated"],[1957,31,""],[1957,0," "],[1958,1,""],[1958,0,"my"],[1945,0,"So I "],[1949,1,""],[1948,1,""],[1949,0," ended up"],[1968,1,""],[1967,1,""],[1967,0,"ing"],[1995,9,""],[1995,0,"code into"],[2004,3,""],[2005,101,""],[2006,5,""],[2006,0,","],[2019,4,""],[2022,4,""],[2022,0,","],[2028,0," and Swift"],[2040,26,""],[2040,0,"Same *semantics*"],[2056,1,""],[2056,0,". Same algri"],[2067,1,""],[2066,1,""],[2045,21,""],[2045,0,"algorithm - but"],[2061,1,""],[2061,0,"t"],[2080,11,""],[2084,0," even close"],[2155,3,""],[2154,1,""],[2154,0,"k"],[2154,1,""],[2154,0," 000"],[2244,0," Thats"],[2267,1,""],[2267,0,"!"],[2268,238,""],[2268,0,"\n\nS"],[2270,1,""],[2270,0,"---\n\nso "],[2277,1,""],[2276,1,""],[2275,1,""],[2274,1,""],[2274,0,"\nSo "],[2277,1,""],[2276,1,""],[2275,1,""],[2275,0,"## Automerge\n\nSo as you may n"],[2303,1,""],[2303,0,"know"],[2295,0,"["],[2308,0,"](), I've been playing with "],[2323,13,""],[2323,0,"getting interested in CRDT "],[2349,1,""],[2349,0,"s lately. Most c"],[2364,1,""],[2364,0,"CRDTs are super slow, and I always chalked that up to "],[2399,19,""],[2399,0,"assumed that aw"],[2413,1,""],[2412,1,""],[2412,0,"was some inherent problemw tih t"],[2443,1,""],[2442,1,""],[2441,1,""],[2440,1,""],[2439,1,""],[2438,1,""],[2437,1,""],[2437,0," with \"the algorithm\". ("],[2460,1,""],[2459,1,""],[2458,1,""],[2458,0," (oops). Anyway, surpri"],[2475,6,""],[2475,0,"in a surprising turn of events, I was making the same mistakes as those researchers. I was assuming "],[2566,9,""],[2566,0,"reading papers talkin g"],[2588,1,""],[2587,1,""],[2587,0,"g about he"],[2596,1,""],[2595,1,""],[2595,0,"the *semantics* and assm"],[2618,1,""],[2618,0,"uming that meant those algorithms needed to be implemented a certain way. A slow way. Because the algorithm"],[2712,0,"\""],[2726,0," is slow\". But I was so wrong.\n\n"],[2757,1,""],[2756,1,""],[2213,5,""],[2212,1,""],[2213,3,""],[2213,0,"ran"],[2190,0,"by using a few implem"],[2210,1,""],[2209,1,""],[2209,0,"ementation traic"],[2224,1,""],[2223,1,""],[2222,1,""],[2222,0,"icks, "],[2236,12,""],[2238,0," code"],[2238,5,""],[2236,0," function in"],[2253,1,""],[2252,1,""],[2252,0,"ru"],[2253,1,""],[2252,1,""],[2252,0,"uns i"],[2256,1,""],[2255,1,""],[2251,4,""],[2251,0,"does"],[2251,4,""],[2251,0,"runs"],[2259,6,""],[2259,0," interations"],[2260,11,""],[2260,0,"iterations"],[2306,0,"!"],[2306,1,""],[2412,5,""],[2412,0,"crazy"],[2449,4,""],[2449,0," there was"],[2502,7,""],[2503,0," Oops!"],[2509,40,""],[2511,0,"'ve been"],[2519,4,""],[2631,66,""],[2631,0,"we knew how"],[2639,3,""],[2639,0,"what those "],[2639,11,""],[2639,0,"how those *implementations* should work"],[2680,0,"That is, they should work *slowly* "],[2714,1,""],[2714,0,". But "],[2720,64,""],[2720,0,"it turns out I was super wrong. T"],[2752,1,""],[2751,1,""],[2751,0,"\n\nHow wrong? "],[2763,1,""],[2763,0,"\n"],[2763,1,""],[2763,0," Automerge"],[2764,0,"To run [this editing trace()"],[2791,1,""],[2790,1,""],[2790,0,"](), "],[2804,0," (a popular CRDT) takes 270 seconds. I've "],[2842,4,""],[2842,0," can run the same editing trace"],[2843,0,"have a new e"],[2854,1,""],[2854,0,"implementation that "],[2904,0," in "],[2841,67,""],[2841,0,"I have a new implementation that can run the same editing trace in 65ms"],[2911,1,""],[2910,1,""],[2909,1,""],[2908,1,""],[2908,0,"0.065 seconds."],[2878,3,""],[2878,0,"process"],[2926,0," Well"],[2915,16,""],[2915,0,"32 "],[2917,1,""],[2916,1,""],[2915,1,""],[2915,0,"23 seconds. Thats about 10 000 "],[2945,1,""],[2945,0,"x "],[2941,1,""],[2941,0," "],[2939,8,""],[2939,0,"ten thousand times faster. T"],[2966,1,""],[2965,1,""],[2965,0," Its the largest speed up I've ever gotten from optimization work - and its *delightful*!"],[3053,1,""],[3052,0,"!"],[3037,17,""],[3037,0,"I'm utterly delighted by it."],[2504,0,"Haha w"],[2509,1,""],[2509,0,"awkward"],[2516,5,""],[2516,0," -"],[2504,6,""],[2504,0,"Hah a"],[2625,0," of different algorithms"],[2671,9,""],[2671,0,"anything about how the"],[2725,35,""],[2690,35,""],[2690,0,"to make the *implementations* efficient."],[2670,15,""],[2751,0," Most "],[2752,5,""],[2752,0,"Lots of CS researchers don't"],[2752,8,""],[2752,0,"Actually "],[2776,5,""],[2776,0,"aren't super geniuses who've spent decades thinking"],[2804,0," also*"],[2805,0,"*"],[2834,0," about optimization"],[2841,0,"c"],[2841,1,""],[2841,0,"how you can "],[2864,1,""],[2863,1,""],[2862,1,""],[2861,1,""],[2860,1,""],[2860,0,"e code."],[2751,116,""],[2663,0,"that meant "],[2831,0,", written by [a popular researcher]()"],[2981,5,""],[2981,0,"a"],[2981,2,""],[3006,0," - 10000x (Y"],[3017,1,""],[3016,1,""],[3015,1,""],[3117,0,"\nLets talk about why automerge is slow, and all thes e"],[3170,1,""],[3169,1,""],[3168,1,""],[3168,0," steps tat "],[3178,1,""],[3177,1,""],[3176,1,""],[3176,0,"hat make it fast.\n\nWell actually, lets start with\n\n## What a"],[3235,1,""],[3235,0,"on earth is an automerge?"],[3247,3,""],[3257,0,"\n\n"],[3234,9,""],[3247,0," anyway"],[3257,0,"Automerge is an algorithm"],[3273,0,"implementation of the RGA "],[3299,9,""],[3299,0,"CRDT. S"],[3305,1,""],[3305,0,"Oops that doesn't help. Automerge"],[3270,68,""],[3270,0,"a library to help you do conc"],[3295,4,""],[3295,0,"collaborative editing. Its based on RGA"],[3322,0,"wrt"],[3324,1,""],[3324,0,"itten by Martin Kleppmann, who's a little bit famous from his Book"],[3389,1,""],[3388,1,""],[3387,1,""],[3386,1,""],[3386,0,"book and excellent talks. Its "],[3424,0," an algo"],[3428,4,""],[3427,1,""],[3426,1,""],[3426,0," "],[3426,2,""],[3426,0,"n algorithm called "],[3448,0,", which c"],[3456,1,""],[3456,0,"you can read about in a paper if you're into that sort of thing.\n\nWhen processing"],[3527,10,""],[3527,0,"doing "],[3522,11,""],[3522,0,"C"],[3522,1,""],[3522,0,"Collaborative text editing works by thinking about a string as a list"],[3548,0," in automerge"],[3522,39,""],[3522,0,"Like"],[3525,1,""],[3524,1,""],[3523,1,""],[3522,1,""],[3522,0,"Automerge (and other CRDTs "],[3548,1,""],[3548,0,") think of a st"],[3562,1,""],[3561,1,""],[3560,1,""],[3560,0," shared document as a list of characters. "],[3602,43,""],[3602,0,"When users"],[3602,10,""],[3602,0,"Each inserted item in the document "],[3606,9,""],[3607,4,""],[3607,0,"character"],[3633,0,"is inserted into a "],[3633,19,""],[3633,0,"gets a unique ID ("],[3650,1,""],[3650,0,"based on "],[3650,9,""],[3649,1,""],[3649,0," - which isn't as bad as you think,"],[3657,27,""],[3657,0," we ca"],[3660,3,""],[3657,3,""],[3657,0," isn't as bad as you think,"],[3657,27,""],[3650,7,""],[3649,1,""],[3649,0," based on "],[3649,10,""],[3649,0,", and each insert specifies that it in"],[3682,5,""],[3682,0,"w"],[3667,16,""],[3667,0,"names which"],[3655,0,"whneever"],[3655,8,""],[3655,0,"whenever you "],[3667,1,""],[3666,1,""],[3665,1,""],[3664,1,""],[3664,0,"insert something, you name"],[3690,23,""],[3690,0," what you're inserting after. Eg if I type \"abc\", automerge creates 3 itme"],[3763,1,""],[3763,0,"e"],[3763,1,""],[3762,1,""],[3762,0,"ems:\n\n- Inser "],[3775,1,""],[3775,0,"t 'a' id (seph, 0)`"],[3784,0,"`"],[3795,0," after (ROOT)"],[3807,1,""],[3807,0,"`"],[3802,1,""],[3802,0,"`"],[3768,0,"- Insert 'a' id `(seph, 0)` after `ROOT`\n"],[3819,1,""],[3819,0,"b"],[3833,1,""],[3833,0,"1"],[3844,4,""],[3844,0,"(seph, 0)"],[3809,0,"- Insert 'b' id `(seph, 1)` after `(seph, 0)`\n"],[3865,1,""],[3865,0,"c"],[3879,1,""],[3879,0,"2"],[3897,1,""],[3897,0,"1"],[3900,0,"\n\nHow w"],[3906,1,""],[3906,0,"should you "],[3902,15,""],[3902,0,"How should you"],[2867,0,"https://martin.kleppmann.com/"],[3945,0," represent that? A tree of course!\n\n> Diagram here"],[3961,0," Well, its a "],[3961,13,""],[3930,0,"\n"],[3930,0,"\nLet s"],[3935,1,""],[3934,1,""],[3934,0,"s say  "],[3940,1,""],[3940,0,"I und"],[3944,1,""],[3943,1,""],[3942,1,""],[3942,0,"insert a '"],[3951,1,""],[3950,1,""],[3950,0,"n 'x' between \""],[3964,1,""],[3964,0,"a and b'"],[3970,0,"'"],[3964,0,"'"],[3966,0,"'"],[3966,1,""],[3964,1,""],[3964,0,"*"],[3966,0,"*"],[3974,1,""],[3974,0,"*"],[3973,1,""],[3972,1,""],[3972,0,"*b"],[3975,0,", so I get \"ab"],[3988,1,""],[3988,0,"Xbc\". I get these items:"],[3994,18,""],[3994,0,"Wh"],[3995,1,""],[3994,1,""],[3994,0,"Then we have:\n\n\n- Insert 'a' id `(seph, 0)` after `ROOT`\n- Insert 'b' id `(seph, 1)` after `(seph, 0)`\n- Insert 'c' id `(seph, 2)` after `(seph, 1)`"],[4008,1,""],[4009,0,"- Insert 'a' id `(seph, 0)` after `ROOT`\n"],[4060,1,""],[4060,0,"x"],[4074,1,""],[4074,0,"3"],[4089,0,")"],[4085,0,"("],[4086,4,""],[4086,0,"seph, 0"],[4188,0,"\n"],[4188,0,"\nThis isn't goo"],[4189,14,""],[4189,0,"Note the 'x' and 'b' both "],[4189,26,""],[4189,0,"Note the 'x' and 'b' both"],[4216,65,""],[3930,0,"\n"],[3930,0,"\nHow should you represent that? A tree of course!\n\n> Diagram here\n"],[3995,1,""],[4280,0," insert at the same location. S"],[4310,1,""],[4310,0,"This will happen when c"],[4332,1,""],[4332,0,"usert"],[4336,1,""],[4336,0,"s type in the same location, and we normally compare the item IDs to figure out which in"],[4423,1,""],[4422,1,""],[4416,6,""],[4416,0,"wh"],[4365,53,""],[4364,1,""],[4363,1,""],[4338,4,""],[4338,0,"concurrently type"],[4376,0,"."],[4281,27,""],[4281,0,"share the samer"],[4295,1,""],[4295,0," parent"],[4313,0," sometimes"],[4380,1,""],[4380,0,", and we can resolve that by comparing their item IDs. But not in this case! In this case I "],[4471,1,""],[4470,1,""],[4470,0,"my new item should "],[4470,19,""],[4470,0,"no matter what the IDs are we should always end up with \"a"],[4019,1,""],[4019,0,"X"],[4126,1,""],[4126,0,"X"],[4005,2,""],[4005,0," Mike"],[4017,0,"s"],[4050,1,""],[4050,0,"we"],[4064,0," "],[4064,1,""],[4139,7,""],[4139,0,"mike, 0"],[4443,4,""],[4443,0," we don't want to do that"],[4496,0,"*"],[4511,0,"*"],[4496,1,""],[4510,1,""],[4554,0,"Xbc\". RGA solves this by adding more information"],[4586,16,""],[4586,0,"a sequ"],[4588,4,""],[4587,1,""],[4587,0,"n extra item to "],[4586,17,""],[4586,0,"a tiny bit more data to each item. "],[4260,361,""],[4260,0,"Note the 'x' and 'b' both share the same parent. This will sometimes happen when users concurrently type in the same location, and we can resolve that by comparing their item IDs. But we don't want to do that in this case! In this case no matter what the IDs are we should always end up with \"aXbc\". RGA solves this by adding a tiny bit more data to each item."],[4587,0,"n extra integer"],[4602,19,""],[4615,1,""],[4615,0,","],[4615,1,""],[4615,0," call "],[4620,1,""],[4620,0,"ed a *sequence number*:"],[4644,0,"\n- Insert 'a' id `(seph, 0)` after `ROOT`\n- Insert 'X' id `(mike, 0)` after `(seph, 0)`\n- Insert 'b' id `(seph, 1)` after `(seph, 0)`\n- Insert 'c' id `(seph, 2)` after `(seph, 1)`\n"],[4685,0,", seq: 0*"],[4692,0,"*"],[4741,0,", seq: *0*"],[4797,0,", seq: *0*"],[4853,0,", seq: *0*"],[4805,1,""],[4805,0,"1"],[4861,1,""],[4861,0,"2"],[4749,1,""],[4749,0,"3"],[4642,1,""],[4642,0,". I"],[4644,1,""],[4643,1,""],[4642,1,""],[4642,0,":"],[4865,0,"Automerge's *semantics* are:\n\n- Everything goes after its"],[4913,9,""],[4913,0,"right after itse "],[4929,1,""],[4928,1,""],[4928,0," parent"],[4897,38,""],[4897,0,"Imagine the tree"],[4897,16,""],[4897,0,"Build the tree\n- If "],[4912,5,""],[4912,0,"- If"],[4911,0," from each item to its parents, all the way up."],[4963,0," two items have"],[4961,17,""],[4961,0,"Whenever you h"],[4970,5,""],[4970,0,"an item has children, put all the "],[4959,45,""],[4959,0,"- Whenever an item has children, put all the"],[4864,0,"\n"],[4864,0,"\nYjs"],[4865,3,""],[4865,0,"This isn't the only approach. Yjs solves this by "],[4865,49,""],[4864,1,""],[4863,1,""],[4911,0,", connecting"],[4923,5,""],[4947,18,""],[4970,0," multiple"],[4990,11,""],[4990,0,"sort them first by sequence number then by ID.\n\n"],[5037,0,"- The list "],[5047,1,""],[5047,0,"'s value is "],[5047,12,""],[5047,0," is whatever you get from flattening the tree with a depth-first so"],[5113,1,""],[5113,0,"earch."],[5111,8,""],[5111,0," traversal."],[5123,0,"\n"],[4874,0," (RGA)"],[5130,0,"So how should you implement"],[3931,48,""],[3931,0,"We can draw t"],[3943,1,""],[3943,0,"that like a "],[3948,7,""],[3948,0,"as a tree!"],[5127,0,"*"],[5137,0,"* automerge? The automerge library does it in the obvious tree based way. Each time an insert happens, we look up"],[5211,39,""],[5210,1,""],[5210,0," Ac"],[5212,1,""],[5212,0,"t least I think so - "],[5109,124,""],[5109,0,"So how should you *implement* automerge? The automerge library does it in the obvious tree based way. At least I think so - I h"],[5235,1,""],[5235,0,"honestly have"],[5233,15,""],[5233,0,"this is automerges"],[5250,1,""],[5250,0,"'s internal state after typing \"abc\""],[5233,0,"["],[5268,0,"](https://gist.github.com/josephg/0522c4aec5021cc1dddb60e778828dbe)"],[5354,0,". Yikes!"],[5826,0,"\n"],[6009,0,"\n"],[6035,0,"\n"],[6496,0,"\n"],[6956,0,"\n"],[6986,0,"\n"],[7167,0,"\n"],[7206,0,"\n"],[7368,0,"\n"],[7425,0,"\n"],[7477,0,"\n"],[5363,0,"\n\n\n\n\n"],[5364,0,"We "],[5366,1,""],[5365,1,""],[5364,1,""],[5364,0,"For benchmarking, I'm using [Marin"],[5397,1,""],[5396,1,""],[5396,0,"tin's editing trace](https://github.com/automerge/automerge-perf/)"],[5401,0," atuomera"],[5402,8,""],[5402,0,"automerge-perf"],[5477,0,". Martin rec"],[5479,10,""],[5479,0,"This is an editing history where m"],[5512,1,""],[5512,0,"Martin just"],[5518,5,""],[5518,0," recorded each keystroke while writing an academic paper. "],[5575,1,""],[5575,0," How does it do?\n\n"],[5356,6,""],[5356,0,"Yeah, I have no idea whats going on here."],[5356,6,""],[5241,0," ss"],[5243,1,""],[5242,1,""],[5242,0,"*some o"],[5248,1,""],[5247,1,""],[5247,0,"*"],[5247,1,""],[5247,0," of*"],[5250,1,""],[5242,1,""],[5613,15,""],[5612,1,""],[5612,0," How does it do?"],[5622,2,""],[5622,0,"automerge"],[5613,0,"So "],[5616,1,""],[5616,0,"h"],[5639,0,"\nTest"],[5640,0,"| "],[5646,0,"    | Time taken |\n| ------- | ---------- |"],[5665,0,"| ------- | ---------- |\n"],[5692,7,""],[5692,0,"automerge"],[5704,10,""],[5704,0,"26"],[5705,1,""],[5705,0,"70s"],[5232,0," after typing\""],[5245,1,""],[5245,0," \"abc\""],[5362,19,""],[5612,0," There's no concurrent edits in this trace (its just a single user), but its "],[5688,1,""],[5687,1,""],[5686,1,""],[5685,1,""],[5685,0,"concurrent edits "],[5685,17,""],[5685,0,"thats probably fine for now."],[5714,25,""],[5714,0,"As I said before, automerge takes a little under 5 minutes to process this editing trace:"],[5802,1,""],[5802,0,". I'm also going to in c"],[5825,1,""],[5824,1,""],[5824,0,"clude a simple baseo"],[5843,1,""],[5843,0,"line comparison, where we just splice() "],[5874,0,"use javascripts'"],[5889,1,""],[5888,1,""],[5888,0,"'s "],[5874,26,""],[5874,0,"create a javascript s"],[5959,0,"@ 1.0.0-preview2 "],[5704,8,""],[5705,0," Users typing "],[5712,7,""],[5712,0,"concurrently typing in the same location is super rare anyway."],[5774,1,""],[5774,0,"\n\n"],[5957,0,"tring and split"],[5971,1,""],[5963,0,"in the obvious way "],[5990,0,"ce into it:"],[6053,0,"| automerge @ 1.0.0-preview2 | 270s |\n"],[6084,3,""],[6084,0,"291"],[6122,3,""],[6093,26,""],[6093,0,"baseline"],[6093,0,"JS "],[6107,0,"0.61"],[6010,0,"                   "],[6056,0," "],[6056,1,""],[6056,0,"-------------------"],[6143,0,"               "],[6165,0,"     "],[6127,0,"      "],[6180,0,"### Why is atuomer"],[6191,7,""],[6191,0,"automerge slow?"],[6179,0,"\n"],[6208,0,"\nA"],[6209,1,""],[6209,0,"Automerge is slow for 3 reasons:\n\n1. Automerge uses "],[6256,5,""],[6256,0,"makes heavy use of immutable.js. Immutablejs is a library which gives you closure-like "],[6333,1,""],[6333,0,"j"],[6343,0,"semantis "],[6351,1,""],[6350,1,""],[6350,0,"cs in javascript"],[6352,3,""],[6352,0," for"],[6367,0," objects"],[6343,0,"copy-on-write "],[6389,0,". The "],[6391,4,""],[6391,0,"This is a cool set of functionality, but the optimizer *hates* this"],[6446,12,""],[6446,0,"gets"],[6436,0,"v8 "],[6436,1,""],[6436,0,"V"],[6453,0," really confused by immutablejs and it dramatics "],[6501,1,""],[6500,1,""],[6500,0,"ally decreases "],[6504,0," "],[6492,13,""],[6492,0,"increases memory usage and"],[6529,0,"performance\n2. Automerge'"],[6540,0,"."],[6555,0,"d "],[6556,1,""],[6555,1,""],[6555,0,"s data structures"],[6571,1,""],[6571,0,"s aren't very good."],[6449,35,""],[6449,0,"has no idea how to optimize immutablejs"],[6477,0,"code that makes heavy use of "],[6517,0,"."],[6518,4,""],[6518,0," As a result, "],[6531,1,""],[6448,0," & GC"],[6602,36,""],[6602,0," needs to do a lot of data "],[6628,1,""],[6623,5,""],[6620,3,""],[6616,4,""],[6614,2,""],[6611,3,""],[6608,3,""],[6602,6,""],[6602,0,"'s data structures aren't very good."],[6602,36,""],[6602,0," uses the wrong data structure for RGA (!!)"],[6632,0,"s"],[6633,8,""],[6638,0,"\n3. Atuomerg"],[6642,8,""],[6642,0,"Automerge is s"],[6655,1,""],[6655,0,"written "],[6639,24,""],[6639,0,"3. Automerge is written"],[6231,2,""],[6231,0,"a handful of "],[6663,10,""],[6663,0,"treats each inserted character as a separate item. Remember that paper I talked about earlier? Automerge makes the same mistake!"],[6790,1,""],[6790,0,".\n\n"],[6792,1,""],[6792,0,"4. Javascript"],[6502,19,""],[6502,0," uses"],[6465,18,""],[6465,0,"struggles to"],[6736,0," "],[6736,1,""],[6736,0,", where copy+paste operations are slow"],[6808,1,""],[6808,0,"!"],[6823,0," just isn"],[6831,1,""],[6831,0,"nn't "],[6835,1,""],[6834,1,""],[6833,1,""],[6832,1,""],[6832,0,"'t very faste "],[6845,1,""],[6844,1,""],[6844,0," anyway"],[6824,27,""],[6823,1,""],[6813,0,"Complex data structures are extra slow because of "],[6873,0,"\n\nYou can see most of these"],[6887,13,""],[6887,0,"some of these issues looking at "],[6887,32,""],[6887,0,"a lot of this stuff o"],[6907,1,""],[6907,0,"going on in this function from automerge:\n\n```javascript\n\n"],[6964,1,""],[6964,0,"function insertionsAfter(opSet, objectId, parentId, childId) {\n  let childKey = null\n  if (childId) childKey = Map({opId: childId})\n\n  return opSet\n    .getIn(['byObject', objectId, '_following', parentId], List())\n    .filter(op => op.get('insert') && (!childKey || lamportCompare(op, childKey) < 0))\n    .sort(lamportCompare)\n    .reverse() // descending order\n    .map(op => op.get('opId'))\n}\n```"],[6924,13,""],[6923,1,""],[6933,0," functoin"],[6941,1,""],[6940,1,""],[6939,1,""],[6939,0,"ion"],[7358,0,"\n\nThis is called on each insert, to figure out how to sort"],[7411,5,""],[7409,2,""],[7409,0,"the children onf"],[7424,1,""],[7423,1,""],[7423,0,"f an item should be sorted."],[6599,4,""],[6594,5,""],[6594,0,"picks the wrong "],[6604,6,""],[6629,0," we'll talk about this soon!"],[6842,60,""],[6842,0,"Javascript"],[6842,10,""],[6842,0,"Complex data structures are extra slow in ajvas"],[6884,5,""],[6884,0,"javascript."],[6894,1,""],[6896,68,""],[6896,0,"Look at this function from automerge:"],[7440,0," There are so many things slow about this:\n\n- There are 5 objects"],[7496,1,""],[7496,0,"6"],[7497,8,""],[7497,0," allocations in this function. Can you"],[7528,0,"("],[7536,0," spot them all?)"],[7485,11,""],[7485,0,"I "],[7486,1,""],[7485,1,""],[7485,0," I can spot "],[7497,1,""],[7497,0,"6"],[7497,1,""],[7497,0,"7"],[7527,0," "],[7527,1,""],[7527,0,". 5 if you don't include the two closures"],[7570,1,""],[7570,0,"("],[7579,4,""],[7579,0,"find"],[7528,41,""],[7528,0," (Though 2 should be hoisted)."],[7530,0,"t"],[7530,1,""],[7536,0," the 2 closures"],[7551,2,""],[7572,1,""],[7594,1,""],[7594,0,")"],[7572,0,"("],[7596,0,"\n- The items are already sorted by lamportCompare"],[7613,8,""],[7637,0," before this method is called"],[7622,0," "],[7622,1,""],[7622,0," the inverse of"],[7681,0,". Sorting a list"],[7596,0,"\n- The List()`"],[7603,0,"`"],[7611,0," argument has no effect"],[7621,0,"to `getO"],[7628,1,""],[7628,0,"In`"],[7597,47,""],[7596,1,""],[6909,8,""],[6909,0,"code in"],[6916,5,""],[6914,2,""],[6914,0,"r"],[6914,1,""],[6914,0,"from"],[6944,0,"\nfunction lamportCompare(op1, op2) {\n  return opIdCompare(op1.get('opId'), op2.get('opId'))\n}\n"],[7702,0," already"],[7717,19,""],[7717,0," -"],[7733,0,")"],[7733,1,""],[7733,0,"()"],[7718,0,"reverse-"],[7725,1,""],[7741,1,""],[7740,1,""],[6207,0,"\n\nwheneve"],[6209,7,""],[6209,0,"Whenever"],[6209,8,""],[6209,0,"The p"],[6209,5,""],[6209,0,"My philosophy with performance tuning"],[6209,37,""],[6209,0,"There's an old saying with performance tuning: "],[6255,1,""],[6255,0,"\n\n> You can't make a program faster. You can only make it do less work."],[6209,119,""],[6895,0,"\n\n"],[6896,0,"There"],[6896,6,""],[6895,1,""],[6209,0,"There's an old saying with performance tuning:\n\n> You can't make a program faster. You can only make it do less work.\n\n"],[6209,119,""],[6895,0,"\nThere's an old saying with performance tuning:\n\n> You can't make a program faster. You can only make it do less work.\n\n"],[7014,1,""],[7014,0,"\nSo we wan"],[7018,6,""],[7018,0,"how do we make the computer *do *"],[7050,1,""],[7049,1,""],[7046,3,""],[7046,0,"do l"],[7049,1,""],[7048,1,""],[7047,1,""],[7046,1,""],[7046,0,"c"],[7046,1,""],[7046,0,"do all the work of "],[7049,16,""],[7049,0,"less work here?\n"],[7066,0,"T"],[7066,1,""],[7066,0,"Exhibit A: Take a look "],[7089,5,""],[7116,1,""],[7116,0,":"],[7729,0,"*"],[7744,0,"*"],[7718,0," I don't know how hot it is, but"],[7751,1,""],[7751,0,"t"],[8007,0," is "],[8003,8,""],[8002,1,""],[8002,0,"n anti-sorted list is slow"],[8024,4,""],[8024,0,"the slowest sort. You could easily just"],[8042,21,""],[8042,0,"The code could easily just swap the j"],[8078,1,""],[8035,0," way to"],[8047,0," anything"],[8058,36,""],[8058,0,"Rather than sorting, then reverse()'ing, this could j"],[8110,1,""],[8109,1,""],[8104,5,""],[8104,0,"code should just invert the arguments of `lamportCompare` (or negat e"],[8172,1,""],[8171,1,""],[8171,0,"e the return value)."],[8141,3,""],[8141,0," in"],[8161,0,", or make "],[8162,9,""],[8161,1,""],[8191,0,"\n- The goal is to insert the new item into the list"],[8194,0,"If "],[8197,1,""],[8197,0,"t"],[8244,1,""],[8244,0,"t, you can do that with a for loop."],[8263,0,"much faster "],[8237,3,""],[8237,0,"an already sorted"],[8296,0,"single "],[8194,4,""],[8194,0,"T"],[8216,4,""],[8216,0,"a "],[8254,1,""],[8254,0,"."],[8256,1,""],[8256,0,"Y"],[8291,7,""],[8300,0,"\n- This code wrapped"],[8319,1,""],[8318,1,""],[8317,1,""],[8317,0,"s childId with "],[8327,5,""],[8327,0,"into a "],[8333,1,""],[8333,0,"n immutablejs Map, just so the argument matches lamportCompare`"],[8381,0,"`"],[8397,0," - which just "],[8406,5,""],[8406,0,"unwraps it again. "],[8423,1,""],[8423,0," This work is all avoidable."],[8440,0," computat"],[8440,9,""],[8453,0,"\n\n\n"],[8405,0," then"],[8429,27,""],[8429,0,"Don't do that!"],[8429,0,"Nooo! "],[8435,14,""],[8435,0,"Stopp"],[8439,1,""],[8439,0,"!!!"],[8441,1,""],[8440,1,""],[8440,0,"\n\n### "],[8445,1,""],[8445,0,"# Alg"],[8447,3,""],[8447,0,"Data structures\n\n"],[8441,0,"\n"],[8465,0,"But the much bigger reason"],[8465,26,""],[8465,0,"The biggest reason atu"],[8486,1,""],[8485,1,""],[8485,0,"utomerge is slow is that"],[2504,3,""],[2504,0,"But this is"],[2581,1,""],[2581,0,"!"],[2782,0," Super wrong."],[2796,6,""],[2796,0,"Running"],[2927,3,""],[2927,0,"291"],[3031,0," over"],[3066,1,""],[3066,0,"2"],[3067,1,""],[3067,0,"5"],[3067,1,""],[3067,0,"6"],[3067,1,""],[3066,1,""],[3066,0,"26"],[3067,1,""],[3067,0,"7"],[6259,0," whole slew"],[6270,8,""],[6924,0,"\n\nReally, it was just never written wtih "],[6964,1,""],[6963,1,""],[6962,1,""],[6961,1,""],[6961,0,"ith performance in mind."],[8556,44,""],[8556,0,"But all this is window dressing. The real read"],[8601,1,""],[8601,0,"so"],[8556,47,""],[8556,0,"The first"],[8556,0,"But the real"],[8568,3,""],[8574,0," thing to fix here is the a"],[8560,41,""],[8560,0,"this is all a big distraction. The big "],[8598,1,""],[8598,0,"gest thing to fi i"],[8615,1,""],[8614,1,""],[8614,0,"x is the algorithm. Th"],[8635,1,""],[8634,1,""],[8633,1,""],[8632,1,""],[8603,0,"and first "],[8633,0,"core "],[8647,0," & data stru"],[8658,1,""],[8658,0,"cu"],[8659,1,""],[8658,1,""],[8658,0,"ucture. "],[8638,12,""],[8654,0,"In automerge"],[8654,12,""],[8654,0,"Automerge seems to store a bunch of nested lists, but there's a better way to do this."],[6688,0,"\n1. Automerge makes heavy use of immutable.js. Immutablejs is a library which gives you clojure-like copy-on-write semantics for javascript objects. This is a cool set of functionality, but the V8 optimizer & GC struggles to optimize code that uses immutablejs. As a result, it increases memory usage and decreases performance."],[6284,328,""],[6284,0,"1"],[6362,1,""],[6362,0,"2"],[7156,0,"\n\n\n\n"],[7157,0,"\n"],[7157,0,"\n"],[7157,1,""],[7157,0,"The most important"],[7157,18,""],[7157,0,"i"],[7157,1,""],[7157,0,"With this sort of thing the first step always has"],[7181,25,""],[7181,0,"we always have to start with macro optimizations. As in "],[7231,6,""],[7231,0,"And in this case, the biggest problem is Automerge"],[7272,9,""],[7272,0,"automerge's complex tree based data structure.\n\nI wish I could take credit for this insight. Kevin Jahns - who wrote a "],[7390,1,""],[7390,0," ("],[7391,1,""],[7390,1,""],[7390,0,"nohter ("],[7389,9,""],[7389,0,"another (much better) CRDT"],[7320,95,""],[7320,0,"There's a better "],[7320,17,""],[7320,0,"The first change"],[7318,0," Complex data structures are "],[7319,28,""],[7318,1,""],[7336,0," we'll make here is replacing Automer"],[7366,7,""],[7366,0,"automerge's tree with a list. So instead of:\n\n```\n\n\n```"],[7416,0,"state = {\n  \n  "],[7426,2,""],[7427,2,""],[7427,0,"}"],[7428,1,""],[7426,0,"  {i"],[7429,1,""],[7429,0,"\n    "],[7432,2,""],[7430,2,""],[7429,1,""],[7429,0," item: 'a', children:"],[7441,0,"id, seq, "],[7459,0," [\n    \n    "],[7462,4,""],[7463,4,""],[7463,0,"  ]}"],[7426,0,"  { item: 'a', id, seq, children: [\n"],[7464,0,"  "],[7475,1,""],[7475,0,"b"],[7462,0,"    { item: 'b', id, seq, children: [\n"],[7504,0,"  "],[7515,1,""],[7515,0,"c"],[7540,0,"      ]"],[7500,47,""],[7500,0,"      { item: 'c', id, seq, children: [ ]"],[7539,1,""],[7540,0,"}\n      "],[7542,6,""],[7542,0,"    ])"],[7547,1,""],[7547,0,"}"],[7409,0," somethingl ike"],[7423,1,""],[7422,1,""],[7421,1,""],[7420,1,""],[7419,1,""],[7419,0," like"],[7253,19,""],[7264,0," biggest problem is its"],[7324,0,"So "],[7327,1,""],[7327,0,"t"],[7563,0,"\n      { item: 'c', id, seq, children: []}"],[7563,0,"\n    { item: 'b', id, seq, children: ["],[7484,44,""],[7484,0,"    "],[7437,0,"javascript"],[7507,1,""],[7507,0,"X"],[7533,0,","],[7632,0,"\n\nWe'll put all the items in a single flat list:"],[7682,0,"```javascript\nstate = {\n  { item: 'a', id, seq, children: [\n    { item: 'X', id, seq, children: []},\n    { item: 'b', id, seq, children: [\n      { item: 'c', id, seq, children: []}\n    ]}\n  ]}\n}\n```\n"],[7704,1,""],[7704,0,"["],[7875,1,""],[7875,0,"]"],[7730,11,""],[7730,0,"parent"],[7730,6,""],[7730,0,"children: ["],[7849,11,""],[7849,0,"p"],[7809,11,""],[7809,0,"p"],[7768,11,""],[7768,0,"p"],[7730,11,""],[7730,0,"p"],[7820,0,"a"],[7790,0,"a"],[7759,0,"a"],[7731,0,"a"],[7824,0,"r"],[7793,0,"r"],[7761,0,"r"],[7732,0,"r"],[7828,0,"e"],[7796,0,"e"],[7763,0,"e"],[7733,0,"e"],[7832,0,"n"],[7799,0,"n"],[7765,0,"n"],[7734,0,"n"],[7836,0,"t"],[7802,0,"t"],[7767,0,"t"],[7735,0,"t"],[7840,0,":"],[7805,0,":"],[7769,0,":"],[7736,0,":"],[7844,0," "],[7808,0," "],[7771,0," "],[7737,0," "],[7847,1,""],[7810,1,""],[7772,1,""],[7737,1,""],[7843,1,""],[7807,1,""],[7770,1,""],[7736,1,""],[7840,0," "],[7805,0," "],[7769,0," "],[7736,0," "],[7844,0,"}"],[7808,0,"}"],[7771,0,"}"],[7737,0,"}"],[7773,3,""],[7809,6,""],[7809,0,"    "],[7774,4,""],[7774,0,"  "],[7739,4,""],[7739,0,"  "],[7805,4,""],[7805,0,"  "],[7840,12,""],[7475,0,": {}"],[7478,1,""],[7477,1,""],[7477,0,"[]"],[7478,0,"'seph', 0"],[7493,0,": 0"],[7529,0,": [..]"],[7576,0,": [..]"],[7622,0,": [..]"],[7872,1,""],[7871,1,""],[7772,0,","],[7806,0,","],[7840,0,","],[7874,0,","],[7874,1,""],[7324,25,""],[7324,0,"Ther's a"],[7331,1,""],[7330,1,""],[7329,1,""],[7328,1,""],[7328,0,"e's a better way "],[6332,28,""],[7127,0," There's lots of performance wins to be had, but"],[7175,3,""],[7175,0," w"],[7200,17,""],[7200,0,"its always best to"],[7249,0,", since the mmicr"],[7257,9,""],[7257,0,"there's no point optimizing code you might be about to throw out anyway"],[7330,5,""],[7330,0,"I"],[7419,0,"Luckily, "],[7428,1,""],[7428,0,"t"],[7449,0,"to implement CRDTs which we can steal from Yjs - "],[7492,6,""],[7492,0,"mt "],[7494,1,""],[7493,1,""],[7493,0,"y favorite CRDT implementation - Yjs. Yjs "],[7467,0,". I wish I could claim I invented this, b"],[7469,39,""],[7468,1,""],[7467,1,""],[7467,0,", which we can see in my favorite CRDT "],[7506,42,""],[7520,0,":"],[7521,2,""],[7531,0,"make a "],[7537,1,""],[7536,1,""],[7535,1,""],[7535,0,"s a clever, obvious trick that"],[7565,83,""],[7565,0," I don't think anyone else noticed. Instead of implementing the CRDT as a tree like this:"],[7890,5,""],[7890,0,"Yjs"],[7897,0,"s"],[7925,5,""],[7986,0,": null"],[8026,0,": null"],[8031,1,""],[8030,1,""],[8029,1,""],[8028,1,""],[7973,0,": ['seph', 0]"],[8041,0,"['seph', 0]"],[8086,0,": ['seph', 0]"],[8133,0,": ..."],[8137,1,""],[8136,1,""],[8135,1,""],[8134,1,""],[8134,0," [..]"],[8148,0,"\nYjs implements a different"],[8152,0," actually does a few things differently. It"],[8207,11,""],[8207,0,"lg"],[8208,1,""],[8207,1,""],[8207,0,"a different CRDT (so d"],[8228,1,""],[8228,0,"it has different semantics)"],[8254,0," than RGA"],[8244,0,", b"],[8246,1,""],[8246,0,"slight"],[8244,8,""],[8234,0," slightly"],[8273,0,". But"],[8275,3,""],[8275,0,"And it uses a linked list, "],[8301,1,""],[8300,1,""],[8300,0," instead of an array, but we're jumping ahead."],[8149,0,"(Actually "],[8162,9,""],[8346,1,""],[8346,0,"!)\n\n"],[7527,0,"Yhs"],[7529,1,""],[7528,1,""],[7528,0,"hs does"],[7527,8,""],[7527,0,"Yjs doesn't need a whole blog post about how to make it faster because its alreadt "],[7609,1,""],[7608,1,""],[7608,0,"y fast. It got there by using"],[7637,9,""],[7995,0,"just "],[8302,0," also"],[8335,50,""],[8411,0,"The question is, how do you insert a new item into a list like this? With automerge the anse"],[8502,1,""],[8502,0,"wer is:\n\n- Find t"],[8511,1,""],[8511,0,"1."],[8520,0,"he parent item\n2. Add"],[8538,3,""],[8538,0,"Find"],[8538,4,""],[8538,0,"Add the new item to the parents' children in the approp"],[8587,6,""],[8587,0,"right spot\n\nWt"],[8600,1,""],[8600,0,"ith the list approach"],[8253,0,"\n\nSo, put the"],[8255,11,""],[8254,1,""],[8253,1,""],[8621,0," its:\n\n1. Find the parent item\n2. Scan "],[8655,5,""],[8655,0,"Skip over items"],[8655,0,"Iterate through the list, "],[8681,1,""],[8681,0,"s"],[8685,0,"ping"],[8700,0," whih "],[8705,1,""],[8704,1,""],[8704,0,"ch should om"],[8715,1,""],[8714,1,""],[8714,0,"come before t"],[8726,1,""],[8726,0,"the new item\n3. Insert"],[8538,3,""],[8538,0,"Insert"],[8557,3,""],[8557,0," into"],[8576,8,""],[8576,0,"list of children"],[8761,0," it there\n\nBasically we're doing an insertion sort."],[8788,5,""],[8788,0,"implementing"],[8801,2,""],[8801,0,"a fancy"],[8824,0,"\n\n\n\n"],[6841,55,""],[6840,1,""],[8731,0," going to replace Automerge's tree"],[8777,1,""],[8776,1,""],[8775,1,""],[8775,0,"ation with"],[8554,0,"\n3.W"],[8557,1,""],[8557,0," Walk up the tree to figure out the in"],[8593,2,""],[8593,0,"positional insert location"],[8555,64,""],[8554,1,""],[8554,0,"\n3. Walk up the tree to figure out the positional insert location"],[8589,30,""],[8589,0,"where we're actually inserting"],[8589,30,""],[8589,0,"the index where we're actually inserting"],[8555,74,""],[8554,1,""],[8695,0," ("],[8696,1,""],[8695,1,""],[8810,0,"\nThis code sounds complex, but its"],[8841,3,""],[8841,0,"it ends up being about 20 lines of code, ri"],[8883,1,""],[8882,1,""],[8882,0,"written using "],[8890,6,""],[8890,0,"in long form"],[8882,0,"["],[8903,0,"]"],[8903,1,""],[8903,0," here](https://github.com/josephg/reference-crdts/blob/fed747255df9d457e11f36575de555b39f07e909/crdts.ts#L401-L459). This code"],[9020,9,""],[8811,209,""],[8811,0,"This code sounds complex, but it ends up being about 20 lines of code, [written in long form here](https://github.com/josephg/reference-crdts/blob/fed747255df9d457e11f36575de555b39f07e909/crdts.ts#L401-L459)."],[8731,9,""],[8726,5,""],[8726,0,"I'm prompo"],[8735,1,""],[8734,1,""],[8733,1,""],[8733,0,"posii"],[8737,1,""],[8737,0,"ng"],[8746,1,""],[8746,0,"ing"],[8750,1,""],[8750,0,"a"],[8821,23,""],[8817,4,""],[8812,5,""],[8812,0,"You can write the whole algorithm"],[8836,9,""],[8836,0,"implementation"],[8850,15,""],[8850,0," in "],[8836,14,""],[8836,0,"insertion"],[8844,1,""],[8843,1,""],[8842,1,""],[8842,0," function"],[8877,1,""],[8877,0,"."],[8880,25,""],[8880,0,"Or 50 lines "],[8891,1,""],[8891,0," if you want to be v"],[8904,7,""],[8904,0,"com"],[8892,15,""],[8891,1,""],[8891,0," if I feel like it. You're not the boss of me."],[8810,0," The semantics are the same, the implementation is different."],[8810,61,""],[9050,0,"This implem"],[9055,6,""],[9055,0,"is semantically the same"],[9058,0,"*"],[9071,0,"*"],[9048,0,"\n\nThe beauti"],[9059,1,""],[9058,1,""],[9057,1,""],[9057,0,"utiful thing"],[9050,19,""],[9050,0,"There's a few beautiful things about this approach:\n\n1. You can implement C"],[9124,1,""],[9124,0,"Yjs, Automerge and Sync9 an"],[9138,4,""],[9138,0,","],[9148,0,"d other semantics in the same codebase. That github project ha"],[9188,22,""],[9188,0,"My [reference-crdts](https://github.com/josephg/reference-crdts) project implements all 3 of those algorithms using the same "],[9297,16,""],[9297,0,", just "],[9299,5,""],[9299,0,"mostly just swapping out the insert function."],[9334,0," (integrate)"],[9356,0,"\n2. Its faster\n3. "],[9371,3,""],[9370,1,""],[9360,10,""],[9360,0,"This is semant"],[9368,6,""],[9357,12,""],[9357,0,"2. This is "],[9357,43,""],[9357,0,"2. This is This is *semantically* the same"],[9360,8,""],[9383,8,""],[9383,0,"identical to the real automerge. (I checked with a fuzzer)"],[9426,0," it"],[9444,0,".T"],[9445,1,""],[9445,0," "],[9360,4,""],[9360,0,"Even though this implementation is di"],[9396,1,""],[9395,1,""],[9395,0,"very differe,"],[9407,1,""],[9407,0,"nt, this"],[9497,0,"So is"],[9500,2,""],[9500,0,"are the "],[9497,11,""],[9496,1,""],[9416,2,""],[9416,0,"approach"],[9449,22,""],[9482,0,"\n\n\n\n---"],[9484,0,"\n\n\n"],[9482,0,"\n| Test                       | Time taken |\n| -------------------------- | ---------- |\n| automerge @ 1.0.0-preview2 | 291s       |\n| JS baseline                | 0.61s      |\n\n"],[9481,0,"\nHow much better?"],[9588,0,"| automerge @ 1.0.0-preview2 | 291s       |\n"],[9634,9,""],[9634,0,"reference-crdts"],[9650,17,""],[9650,0,"           "],[9663,3,""],[9663,0,"31"],[9664,1,""],[9663,1,""],[9663,0,"31"],[9666,0," "],[9498,0," It tak"],[9499,6,""],[9499,0,"About 10"],[9506,1,""],[9506,0,"0x better."],[9497,0," is this approach"],[9685,10,""],[9685,0,"(automerge / yjs)"],[9686,10,""],[9686,0,"AM "],[9686,3,""],[9686,0,"automerge "],[9491,7,""],[9491,0,"faster "],[9526,6,""],[9526,0,"faster"],[9533,0," Its also much more em"],[9554,1,""],[9553,1,""],[9553,0,"memory-efficient and smaller."],[9569,13,""],[9569,0,"."],[9615,44,""],[9572,0,"| -------------------------- | ---------- |\n"],[9659,44,""],[9616,0,"| automerge @ 1.0.0-preview2 | 291s       |\n"],[9703,0,"\n| automerge @ 1.0.0-preview2 | 291s       |"],[9616,44,""],[9659,0,"\n| -------------------------- | ---------- |"],[9572,44,""],[9689,0," "],[9645,0," "],[9601,0," "],[9692,0," "],[9647,0," "],[9602,0," "],[9695,0," "],[9649,0," "],[9603,0," "],[9698,0," "],[9651,0," "],[9604,0," "],[9701,0," "],[9653,0," "],[9605,0," "],[9704,0," "],[9655,0," "],[9606,0," "],[9707,0," "],[9657,0," "],[9607,0," "],[9804,0,"       "],[9772,1,""],[9763,0,"  "],[9712,0,"  "],[9712,1,""],[9723,1,""],[9773,1,""],[7361,0,"\n\n\n### Algorithmic improvements"],[7379,0," / data structure"],[7368,28,""],[7368,0,"Improving the data structure"],[7396,13,""],[9391,0,"\n3. "],[9394,1,""],[9393,1,""],[9392,1,""],[9392,0,"2. When there are no concurrent edits in tha tlo"],[9439,1,""],[9438,1,""],[9437,1,""],[9436,1,""],[9436,0,"t location, you don't have to iterate "],[9395,79,""],[9395,0,"You almost always just insert atht"],[9428,1,""],[9427,1,""],[9427,0," the "],[9425,7,""],[9425,0,"right afte t"],[9436,1,""],[9435,1,""],[9435,0,"r the parent item."],[9395,0,"Concurrent inserts int he same"],[9414,11,""],[9414,0,"in the same location are super rare in practice, and "],[9461,5,""],[9461,0,". So"],[9466,1,""],[9466,0,"y"],[9524,0," Although this algorithm has a (linear time) loop, its almost"],[9575,10,""],[9575,0,"the loop gets ex"],[9584,7,""],[9584,0,"is almost never l"],[9600,1,""],[9600,0,"does anything."],[9600,13,""],[9600,0,"runs"],[9605,0," This makes it fast!"],[9606,4,""],[9606,0,"I"],[9606,1,""],[9606,0,"So its"],[9612,9,""],[9612,0," really"],[9624,0," in practice"],[8647,0,"Starting right after the parent item, "],[8685,1,""],[8685,0,"i"],[8709,1,""],[8709,0,"."],[8711,8,""],[8711,0,"Skip"],[8709,55,""],[8709,0," until we find the location the new item should be inserted"],[9799,0,"\n"],[9676,1,""],[9676,0,"3"],[9800,0,"4. Its neat! Use a list to implement a list? Genius!"],[9811,0," and obvious"],[9811,12,""],[9843,0," CR"],[9813,33,""],[9813,0,"Implement a list CRDT with a list"],[9855,0,"!"],[9945,1,""],[9945,0,", though I'm not measure "],[9969,1,""],[9968,1,""],[9968,0,"ing that here."],[6901,0," Or memory usage - th"],[6921,1,""],[6921,0,"hat simple editing trace con"],[6946,3,""],[6946,0,"makes "],[6920,32,""],[6920,0,"running this simple tra"],[6940,3,""],[6940,0,"editing trace in automerge consumes 1.6"],[6978,1,""],[6978,0,"7GB of ram "],[6988,1,""],[6988,0,"!!"],[6989,1,""],[6953,0," to produce a 100lb"],[6971,1,""],[6970,1,""],[6970,0,"h"],[6970,1,""],[6970,0,"kb document"],[6981,13,""],[7296,1,""],[7296,0,"."],[7298,5,""],[7298,0,"After all,"],[7364,16,""],[7364,0,"delete"],[7004,0," Holy cow!"],[7308,12,""],[7308,0,"T"],[7371,0,"\n"],[7135,236,""],[7135,0,"So how do we make the computer do less work here? There's lots of performance wins to be had, but with this sort of thing its always best to start with macro optimizations. There's no point optimizing code you might be about to delete."],[7371,0,"\n"],[7459,0," And I "],[7460,6,""],[7459,1,""],[10338,0,"Well, it"],[10344,2,""],[10344,0,"the performance improvement"],[10344,0,"some of "],[10379,0,"s might also come from the fact I'm not using automerge"],[10425,9,""],[10425,0,"immutablejs "],[10338,99,""],[10338,0,"Well, some of the performance improvements might also come from the fact I'm not using immutablejs"],[10338,7,""],[10338,0,"S"],[10430,0," here"],[10409,0,"also "],[10435,5,""],[10435,0,". But"],[10439,1,""],[10438,1,""],[10437,1,""],[10436,1,""],[10438,0,"\n\n"],[10438,0,"\n#### "],[10443,1,""],[10442,1,""],[10442,0," Micro optimizations for the win"],[10462,12,""],[10462,0,"\n\nNow we've covered the macro optimizations and picked our sem"],[10521,3,""],[10521,0,"data structure, there's another big prob"],[10473,88,""],[10473,0," go"],[10475,1,""],[10474,1,""],[10473,1,""],[10472,1,""],[10471,1,""],[10471,0,"re using the right algorithm in our implementation, we have a new hotspot in performance: Findingth"],[10569,1,""],[10568,1,""],[10568,0," the location to insert.\n\nThis "],[10594,5,""],[10594,0,"My reference-C"],[10607,1,""],[10607,0,"crdts implementation "],[10594,34,""],[10594,0,"My reference-crdts implementation"],[6993,1,""],[6992,1,""],[6991,1,""],[6991,0,"880"],[6994,2,""],[6994,0,"MB"],[6971,1,""],[6970,1,""],[6970,0,"KB"],[7014,0," Thats nearly as much ram as "],[7014,29,""],[7014,0," The document isn't even very big!"],[7014,0," Thats neraly "],[7021,7,""],[7021,0,"nearly as much as slack."],[7015,30,""],[7015,0,"~"],[7015,1,""],[7015,0,"Thats nearly as much as slack."],[7015,0,"``"],[7016,1,""],[7015,1,""],[7015,0,"~~"],[7047,0,"~~"],[7048,1,""],[7047,1,""],[7047,0,"--"],[7047,2,""],[7047,0,"~~"],[10662,0,"\n"],[10662,0,"\nSo imagine the user types an 'a' in the middle of the document (at position 50000"],[10743,1,""],[10743,0,"). "],[10663,83,""],[10663,0,"So imagine the user types an 'a' in the middle of the document (at position 5000)."],[10746,1,""],[10745,1,""],[10745,0," "],[10779,0," needs to find "],[10663,131,""],[10663,0,"So imagine the user types an 'a' in the middle of the document (at position 5000). My reference-crdts implementation needs to find"],[10662,0,"\n"],[10662,0,"\n```javascript\nstate = [\n  { item: 'a', id: ['seph', 0], seq, parent: null },\n  { item: 'X', id, seq, parent: ['seph', 0] },\n  { item: 'b', id, seq, parent: ['seph', 0] },\n  { item: 'c', id, seq, parent: [..] }\n]\n```"],[10662,0,"\nSo we have a document like this:\n"],[10663,0,"Including "],[10663,10,""],[10694,0,", now"],[10694,5,""],[10694,0,". ("],[10696,1,""],[10696,0,"Oh, it also has del"],[10708,7,""],[10708,0,"marks which items are deleted"],[10684,10,""],[10684,0,", which is a list of items"],[10712,2,""],[10712,0,"And"],[10715,4,""],[10715,0," we're"],[10731,1,""],[10731,0,"ing"],[10758,1,""],[10758,0,", like this:"],[10758,12,""],[10758,0,":"],[10837,47,""],[10785,0,"  { item: 'X', id, seq, parent: ['seph', 0] },\n"],[10884,0,"\n  { item: 'X', id, seq, parent: ['seph', 0] },"],[10785,47,""],[10947,0,"i"],[10900,0,"i"],[10853,0,"i"],[10800,0,"i"],[10951,0,"s"],[10903,0,"s"],[10855,0,"s"],[10801,0,"s"],[10955,0,"D"],[10906,0,"D"],[10857,0,"D"],[10802,0,"D"],[10959,0,"e"],[10909,0,"e"],[10859,0,"e"],[10803,0,"e"],[10963,0,"l"],[10912,0,"l"],[10861,0,"l"],[10804,0,"l"],[10967,0,"e"],[10915,0,"e"],[10863,0,"e"],[10805,0,"e"],[10971,0,"t"],[10918,0,"t"],[10865,0,"t"],[10806,0,"t"],[10975,0,"e"],[10921,0,"e"],[10867,0,"e"],[10807,0,"e"],[10979,0,"D"],[10924,0,"D"],[10869,0,"D"],[10808,0,"D"],[10982,1,""],[10926,1,""],[10870,1,""],[10808,1,""],[10979,0,"d"],[10924,0,"d"],[10869,0,"d"],[10808,0,"d"],[10983,0,":"],[10927,0,":"],[10871,0,":"],[10809,0,":"],[10987,0," "],[10930,0," "],[10873,0," "],[10810,0," "],[10991,0,"f"],[10933,0,"f"],[10875,0,"f"],[10811,0,"f"],[10995,0,"a"],[10936,0,"a"],[10877,0,"a"],[10812,0,"a"],[10999,0,"l"],[10939,0,"l"],[10879,0,"l"],[10813,0,"l"],[11003,0,"s"],[10942,0,"s"],[10881,0,"s"],[10814,0,"s"],[11007,0,"e"],[10945,0,"e"],[10883,0,"e"],[10815,0,"e"],[11011,0,","],[10948,0,","],[10885,0,","],[10816,0,","],[11015,0," "],[10951,0," "],[10887,0," "],[10817,0," "],[11114,0,"in ra rea"],[11122,1,""],[11121,1,""],[11120,1,""],[11119,1,""],[11118,1,""],[11117,1,""],[11117,0,"a real document, this "],[11114,25,""],[11114,0,"at like, "],[11123,3,""],[11186,0," which item in th e"],[10947,5,""],[10947,0,"true"],[10952,0," "],[10711,4,""],[10711,0," Oh, and unlike above"],[10712,20,""],[10712,0,"I didn't mention this above but"],[10743,6,""],[10743,0," we"],[10751,0," need"],[10752,4,""],[10751,1,""],[10758,1,""],[10757,1,""],[10756,1,""],[11209,18,""],[11209,0,"the "],[11209,4,""],[11209,0,"where to insert"],[11204,20,""],[11204,0,"correlate that position with a list item, so we can figure out:\n\n- Where t"],[11277,1,""],[11271,6,""],[11271,0,"What our new"],[11276,7,""],[11276,0,"the new item's parent should be\n- and then where the new item will be inserted"],[11342,0," actually"],[11355,8,""],[11355,0,"spliced in"],[11367,0,"My im"],[10660,1,""],[10660,0,", "],[10661,1,""],[10660,1,""],[10660,0,"."],[10601,0," few"],[10610,7,""],[10609,4,""],[10621,0," hotspots"],[10662,1,""],[10662,0,", and inserting"],[10668,0,"actually "],[10686,0,"."],[11398,0,"lementat"],[11396,10,""],[11396,0,"implementation does a linear scan through the document to find this location. Its a for() loop. we "],[11494,1,""],[11493,1,""],[11492,1,""],[11492,0,"We count all the not-deleted items until "],[11473,0," That sounds fancy - but "],[11498,4,""],[11498,0,"its"],[11557,0,"we've counted past 10"],[11577,1,""],[11576,1,""],[11576,0,"5000 items which aren't deleted and return the index "],[11628,1,""],[11623,0,"resulting "],[11638,0," (eg"],[11641,1,""],[11640,1,""],[11639,1,""],[11638,1,""],[11638,0,". E"],[11640,1,""],[11640,0,"(Eg 555"],[11646,1,""],[11646,0,"000"],[11648,1,""],[11647,1,""],[11646,1,""],[11645,1,""],[11644,1,""],[11638,6,""],[11638,0," - which will be bi"],[11638,19,""],[11638,0,". If 1000 items have been deleted"],[11648,5,""],[11648,0,"characters"],[11676,0," before position 5000, the index position might be 6000."],[11494,3,""],[11493,1,""],[11505,0,"`"],[11500,0,"`"],[11730,0," But unfor"],[11731,9,""],[11731,0,"Unfortunately for us, this is "],[11393,368,""],[11393,0,"My implementation does a linear scan through the document to find this location. That sounds fancy - its a `for()` loop. We count all the not-deleted items until we've counted past 5000 items which aren't deleted and return the resulting index. If 1000 characters have been deleted before position 5000, the index position might be 6000. Unfortunately for us, this is"],[11474,21,""],[11474,0,"I"],[11474,0,"Which means, I use"],[11492,3,""],[11480,5,""],[11480,0,"is to say"],[11706,8,""],[11705,1,""],[11700,0,"destination "],[11732,30,""],[11097,0,"\nLets imagine the document has 1000"],[11131,1,""],[11131,0," 000 items in it, and the"],[11156,15,""],[11226,0," 0"],[11379,0,", and"],[11387,10,""],[11387,0,"W"],[11393,0,"in the list "],[11379,0," (o"],[11381,1,""],[11380,1,""],[11380,0,"(its the id of the preceeding item!)"],[11414,1,""],[11381,4,""],[11381,0,"we need "],[11510,0," th"],[11512,1,""],[11511,1,""],[11510,1,""],[11510,0,"this with "],[11505,15,""],[11505,0,"implements this with "],[11560,22,""],[11665,0,"0"],[11663,0," "],[11781,0,"0 "],[11731,0,"0 "],[11823,0," 0"],[11828,0," This is l"],[11837,1,""],[11837,0,"pretty slow"],[11829,19,""],[11829,0,"Javascript's optimizer will do what ic "],[11867,1,""],[11866,1,""],[11866,0,"t can, but this is always going to be slow.\n\nThen "],[11911,5,""],[11911,0,"Then th"],[11917,1,""],[11916,1,""],[11916,0,"after we've found the new location, we need to splice it in:\n\n```javascript\ndoc.content.splice(destIdx, 0, newItem)\n```\n\n"],[12011,7,""],[12011,0,"60000"],[12011,5,""],[12011,0,"destIdx"],[12031,0," // inser"],[12031,9,""],[12037,0,"If the array currently has 1000 "],[12068,1,""],[12067,1,""],[12067,0," 000 items, javs"],[12082,1,""],[12082,0,"ascript (conceptually) needs"],[12090,20,""],[12043,0," list use"],[12051,1,""],[12050,1,""],[12049,1,""],[12049,0,"is implme"],[12057,1,""],[12056,1,""],[12049,7,""],[12048,1,""],[12043,5,""],[12043,0," "],[12043,1,""],[12090,0,"needs to move every item from position 60 000 forward by one space. (Well, if javascript uses an array for lists. "],[12203,1,""],[12202,1,""],[12197,5,""],[12193,4,""],[12193,0,"internally for lists. Who knows what it actually does - v8 is complex!)"],[12247,1,""],[12246,1,""],[12246,0," -"],[12157,0," This is also slow."],[12178,7,""],[12178,0,"This is assuming"],[12194,1,""],[12206,0,"actually "],[12244,0,"its "],[10631,1,""],[10631,0,"\n- "],[10633,1,""],[10632,1,""],[10632,0,"\n- "],[10666,1,""],[10665,1,""],[10665,0,"\n- "],[10665,0," and"],[10672,5,""],[10672,0,"A"],[10690,0," into the array"],[10705,1,""],[10788,18,""],[10788,0,"some of those"],[10808,3,""],[10808,0,"have been"],[10825,0,", "],[10826,1,""],[10825,1,""],[10808,5,""],[10808,0,"might also have "],[11120,0,",\n  ..."],[11323,4,""],[11323,0,"tihs"],[11326,1,""],[11325,1,""],[11324,1,""],[11324,0,"his"],[11353,1,""],[11353,0,"."],[11355,9,""],[11355,0,"We need to"],[11363,2,""],[11363,0,"thi"],[11365,1,""],[11365,0,"e index to"],[11367,0,"this "],[11372,6,""],[11431,9,""],[11431,0,"copy the "],[11269,0," We need to figure out"],[11281,10,""],[11281,0,"first create a new item - and for that we need to know what its parent"],[11331,20,""],[11331,0,"figure out what its p"],[11331,21,""],[11331,0,"copy its parent ID from the item "],[11331,33,""],[11331,0,"figure out what its parent should be."],[11368,117,""],[11368,0," And then when we insert, we need to find that parent in th elis"],[11431,1,""],[11430,1,""],[11429,1,""],[11428,1,""],[11427,1,""],[11427,0,"e list and splice i"],[11445,1,""],[11444,1,""],[11444,0," the new item in."],[11461,147,""],[11461,0,"\n"],[11490,1,""],[11490,0,"does"],[11481,13,""],[11481,0,"does"],[11490,5,""],[11490,0," using"],[11510,21,""],[11510,0,", "],[11511,1,""],[11510,1,""],[11560,4,""],[11626,6,""],[11626,0,"haven't been"],[11780,1,""],[11780,0,"\n\n"],[11862,0," O(n) slow."],[11863,0,"*"],[11868,0,"*"],[12144,7,""],[12144,0,"Well,"],[12219,35,""],[12219,0,"V"],[12225,0,"really "],[12243,0,"So each time"],[12243,12,""],[12243,0,"Each time we insert, we need to take as"],[12281,1,""],[12281,0,"bout as amny "],[12289,5,""],[12289,0,"many steps "],[12275,25,""],[12275,0,"loop"],[12275,4,""],[12275,0,"take about as many steps as there are i"],[12313,1,""],[12313,0,"characters in the document. Well, characters which have *ever been* in the document (s"],[12398,1,""],[12398,0,"because "],[12396,10,""],[12396,0,". So the lon"],[12398,10,""],[12398,0,"This isn't just slow. Its slow and getting slower."],[10512,19,""],[10512,0,"Fixing linear time"],[10512,18,""],[10512,0,"Removing scanning"],[12447,0,"\n\nYjs "],[12449,4,""],[12448,0,"Thei"],[12451,1,""],[12450,1,""],[12450,0,"ere's a few solutions to this, but lets start with the obvious"],[12505,7,""],[12505,0,"simplest: Replacing the array with a linked list.\n\nThis has a few benefits:\n\n- "],[12582,2,""],[12582,0,"-"],[12505,78,""],[12505,0,"simplest: Replacing the array with a linked list.\n\nThis has a few benefits:\n\n-"],[12514,0," To find an "],[12525,1,""],[12524,1,""],[12523,1,""],[12515,8,""],[12515,0,"Wehn item"],[12515,9,""],[12515,0,"When items are inserted"],[12515,0,"Usually when a human is typing, they don't actually move around the document that much. M"],[12603,1,""],[12602,0," We can cache the last inserted"],[12632,1,""],[12631,1,""],[12631,0," l"],[12625,8,""],[12625,0,"location the user inserted, anad "],[12657,1,""],[12656,1,""],[12655,1,""],[12655,0,"d when they insert again we"],[12681,1,""],[12680,1,""],[12679,1,""],[12679,0,", if they insert close to the old insert"],[12713,6,""],[12713,0,"curor"],[12717,1,""],[12716,1,""],[12716,0,"sor poit"],[12723,1,""],[12722,1,""],[12722,0,"sition we can just track "],[12592,4,""],[12592,0,"very"],[12624,9,""],[12624,0," index and posi"],[12625,14,""],[12625,0,"(index, position) pair where"],[12663,8,""],[12663,0,"typed something"],[12446,0,"\n\n#### Fixy fix fix"],[10593,0,"ca"],[10594,1,""],[10593,1,""],[10593,0,"need to "],[10556,10,""],[10556,0," core data structure"],[10611,36,""],[10611,0,"fix two performance hotspots:"],[10642,1,""],[10642,0,"1."],[10680,1,""],[10680,0,"2."],[11379,93,""],[11281,98,""],[11281,0,"Where on earth is that? "],[11304,1,""],[11304,0," We'll need to scan through the document to fin"],[11344,7,""],[11344,0," (skipping deleted items) to figure out where the new item goes, and what its "],[11413,9,""],[11413,0,"l"],[11413,1,""],[11413,0,"see whats nearby to name its parent.\n\nThats going to "],[11451,15,""],[11451,0,"If they insert at position 50 000, we'll probably have to scan about 60 000 "],[11514,0,"past "],[11532,0,"items to find the insert position! Yikes!\n\nAnd then when we actually insert, we do this:"],[11620,481,""],[11680,0,"\n"],[11680,0,"\nDouble yikes!"],[11694,2,""],[11694,0," "],[11747,0," will"],[11757,1,""],[11772,0,"single "],[11783,0," once space forward."],[11803,63,""],[11803,0," "],[11803,0," Oof"],[11804,3,""],[11804,0,"Its "],[11804,4,""],[11804,0,"This part happens from C++, but stil, "],[11841,1,""],[11840,1,""],[11840,0,"l oof."],[11921,0,", and who knows if thats actually true"],[11960,22,""],[11937,23,""],[11937,0,"whats really going on down there."],[11973,0,"So "],[11976,1,""],[11976,0,"e"],[12005,7,""],[12004,1,""],[11997,2,""],[11997,0,"the computer does"],[12014,5,""],[12076,5,""],[12076,0,"Sorry, as many st"],[12083,10,""],[12082,1,""],[12184,0," Its O(n%"],[12192,1,""],[12192,0,"^2)."],[12185,4,""],[12185,0,"Inserting n characters will take "],[12245,0,"\n"],[12245,0,"\n"],[12246,40,""],[12246,0,"L"],[12245,0,"\n"],[12245,0,"\nWe can fix both of these problems "],[12246,34,""],[12245,1,""],[12244,1,""],[12244,0,"\n\n"],[12246,32,""],[12334,0,"We can solve the scanning problem by "],[12371,7,""],[12375,1,""],[12375,0,"ing"],[12405,0,"*"],[12388,0,"*"],[12427,6,""],[12427,0," edited"],[12444,1,""],[12444,0,"."],[12446,5,""],[12446,0,"W"],[12469,0," we can hope they"],[12486,8,""],[12526,83,""],[12526,0," and just scan a bit forward or backwards from there to fi"],[12583,1,""],[12582,1,""],[12581,1,""],[12580,1,""],[12579,1,""],[12578,1,""],[12578,0,". "],[12579,1,""],[12579,0," This sounds kind of dodgy, but it works great in practice."],[12591,0," a little bit"],[12604,8,""],[12643,0,"\n\nThen we need to insert efficiently. We can do that by"],[12681,17,""],[12681,0,"Well, we can do that by pl"],[12706,1,""],[12705,1,""],[12705,0,"replacing the array with a linked list"],[12732,0,"doubly-"],[12732,7,""],[12743,0,". Its"],[12747,1,""],[12746,1,""],[12745,1,""],[12745,0,"(Its going to have to be a doubly-linked list to "],[12791,3,""],[12791,0,"for the scanning to work).\n\nYjs does these two optimizations "],[12851,1,""],[12851,0," and one bonus optimization: Instead of storing"],[12880,18,""],[12880,0,"U"],[12880,1,""],[12880,0,"Humans also type in runs of characters. Instead of "],[12819,112,""],[12819,0,"Yjs does these two optimizations and one bonus optimization: Humans also type in runs of characters. Instead of typing a "],[12939,1,""],[12937,2,""],[12937,0," a "],[12860,0,"more "],[12892,4,""],[12891,1,""],[12819,121,""],[12819,0,"Yjs does these two optimizations and one more bonus optimization: Humans type in runs of characters. Instead of typing a"],[12938,1,""],[12920,18,""],[12920,0,"If I type \"hello\", instead of storing:\n\n```javascript\nstate = [\n  { item: 'a', isDeleted: false, id: ['seph', 0], seq, parent: null },\n  { item: 'X', isDeleted: false, id, seq, parent: ['seph', 0] },\n  { item: 'b', isDeleted: true,  id, seq, parent: ['seph', 0] },\n  { item: 'c', isDeleted: false, id, seq, parent: [..] },\n  ...\n]\n```\n"],[12995,1,""],[12995,0,"h"],[13066,1,""],[13066,0,"e"],[13131,1,""],[13131,0,"l"],[13196,1,""],[13196,0,"l"],[13185,0,"  { item: 'l', isDeleted: false, id, seq, parent: [..] },\n"],[13254,1,""],[13254,0,"o"],[13301,5,""],[13300,1,""],[13146,4,""],[13146,0,"false"],[13153,1,""],[12984,0,"  { item: 'h', isDeleted: false, id: ['seph', 0], seq, parent: null },\n"],[13118,4,""],[13118,0,"['seph', 1"],[13132,246,""],[13055,0,"  { item: 'h', isDeleted: false, id: ['seph', 0], seq, parent: ['seph', 1 },\n  { item: 'h', isDeleted: false, id: ['seph', 0], seq, parent: ['seph', 1 },\n  { item: 'h', isDeleted: false, id: ['seph', 0], seq, parent: ['seph', 1 },\n"],[13143,1,""],[13143,0,"e"],[13066,1,""],[13066,0,"e"],[13143,1,""],[13143,0,"l"],[13220,1,""],[13220,0,"l"],[13297,1,""],[13297,0,"o"],[13101,1,""],[13101,0,"1"],[13179,0,"2"],[13179,1,""],[13178,1,""],[13178,0,"2"],[13255,1,""],[13255,0,"3"],[13332,1,""],[13332,0,"4"],[13127,1,""],[13127,0,"0]"],[13206,0,"]"],[13283,1,""],[13283,0,"2]"],[13361,1,""],[13361,0,"3]"],[13372,0,"\n\nYjs just stores:"],[13391,0,"\n```javascript\nstate = [\n  { item: 'h', isDeleted: false, id: ['seph', 0], seq, parent: null },\n  { item: 'e', isDeleted: false, id: ['seph', 1], seq, parent: ['seph', 0] },\n  { item: 'l', isDeleted: false, id: ['seph', 2], seq, parent: ['seph', 1] },\n  { item: 'l', isDeleted: false, id: ['seph', 3], seq, parent: ['seph', 2] },\n  { item: 'o', isDeleted: false, id: ['seph', 4], seq, parent: ['seph', 3] },\n]\n```"],[13428,0,"ello"],[13491,312,""],[13497,0,"\n"],[13497,0,"\nAaah much better! This reuc"],[13524,1,""],[13523,1,""],[13523,0,"duces the number of i"],[13543,1,""],[13543,0,"items in the list"],[13515,0," For our benchmark,"],[13535,1,""],[13535,0,"t"],[13579,0," from 180 000 down to about 40 000."],[13615,29,""],[13614,0," And it "],[13498,124,""],[13498,0,"Aaah much better! For our benchmark, this reduces the number of items in the list from 180 000 down to about 40 000. And it"],[6073,0," RAM used"],[6078,4,""],[6078,0,"usage"],[6127,0," --------- "],[6084,54,""],[6084,0,"| -------------------------- | ---------- | ---------"],[6083,0," |"],[6139,0," |"],[6185,0," 880MB     |"],[6241,0,"           |"],[10249,0," RAM usage |"],[10312,0," --------- |"],[10375,0," 880 MB    |"],[10438,0,"           |"],[10501,0,"          |"],[10511,1,""],[10511,0," |"],[13628,4,""],[13628,0,"this "],[13648,0," optimization"],[13623,0," We can't collapse the whole list like this - this io"],[13675,1,""],[13674,1,""],[13674,0,"only works when all the itme"],[13701,1,""],[13700,1,""],[13699,1,""],[13699,0,"i"],[13699,1,""],[13699,0,"tems come one after"],[13704,14,""],[13704,0,"line up  li"],[13714,1,""],[13713,1,""],[13712,1,""],[13712,0,"like this. But"],[13727,1,""],[13727,0,"f"],[13727,20,""],[13776,3,""],[13776,0,"our"],[13819,7,""],[13819,0,"\n\n| Test                              | Time taken | RAM usage |\n| --------------------------        | ---------- | --------- |\n| automerge @ 1.0.0-preview2        |  291s      | 880 MB    |\n| reference-crdts (automerge / yjs) |   31s      |           |\n| JS baseline                       | 0.61s      |           |\n"],[13819,0,"\n\nAnd it performs *great*:"],[14036,0,"| reference-crdts (automerge / yjs) |   31s      |           |\n"],[14101,33,""],[14101,0,"Yjs                              "],[14141,1,""],[14140,1,""],[14139,1,""],[14139,0," 0."],[14141,1,""],[14140,1,""],[14139,1,""],[14138,1,""],[14137,1,""],[14137,0,"0.97s"],[14150,6,""],[14150,0,"3 MB"],[14151,0,".7"],[14152,1,""],[14152,0,"6"],[13844,1,""],[13844,0," - its 30x faster:"],[10441,1,""],[10440,1,""],[10440,0,"23"],[10441,1,""],[10441,0,"7"],[10441,1,""],[10441,0,"8 MB"],[10445,3,""],[14105,5,""],[14105,0,"27"],[14106,1,""],[14106,0,"8 MB"],[13861,1,""],[13861,0," and uses just over 1/10th as much RAM:"],[13821,5,""],[13821,0,"I"],[13604,0,"\n\nBut in a link"],[13606,13,""],[13605,1,""],[13604,1,""],[12931,4,""],[12931,0,"has"],[13622,0," Finally paste events will be fast!"],[13657,1,""],[13657,0,"\n\n"],[13631,0,"those pesky "],[13744,6,""],[13744,0," feilds"],[13750,1,""],[13749,1,""],[13748,1,""],[13747,1,""],[13747,0,"i"],[13747,1,""],[13746,1,""],[13746,0,"ields"],[13759,10,""],[13759,0,". And we'll need so e"],[13779,1,""],[13778,1,""],[13778,0,"me special logic to split items back out if the user later inserts something in the middle of a span li"],[13872,9,""],[13872,0,"oen "],[13875,1,""],[13874,1,""],[13873,1,""],[13873,0,"ne of these spans"],[13896,4,""],[13896,0,"when all is said "],[13912,1,""],[13911,1,""],[13910,1,""],[13909,1,""],[13909,0,"aid and done, this"],[13928,12,""],[13928,0,"trick"],[13928,5,""],[13928,0,"change"],[14011,23,""],[14011,0,"These changes perform great, and "],[14043,1,""],[14042,1,""],[14041,1,""],[14040,1,""],[14039,1,""],[14038,1,""],[14038,0,". The result is"],[14053,2,""],[14068,0," we're using"],[14080,5,""],[14081,9,""],[14081,0,"about"],[14086,20,""],[14086,0," 10% o"],[14091,1,""],[14091,0,"as much RAM:"],[14473,1,""],[14472,1,""],[14472,0,"0.1"],[14471,1,""],[14475,0,"MB"],[14477,2,""],[10451,62,""],[10451,0,"| JS baseline                       | 0.61s      | 0.1 MB    |"],[6198,55,""],[6198,0,"| JS baseline                       | 0.61s      | 0.1 MB    |"],[6233,1,""],[6232,1,""],[6231,1,""],[6230,1,""],[6229,1,""],[6228,1,""],[6227,1,""],[5813,6,""],[5812,1,""],[5885,0," And wow is that - yep, 880MB. "],[5915,1,""],[5914,1,""],[5914,0," of RAM.\n\n"],[7085,44,""],[6981,138,""],[5922,0," Holy cow! ~~Thats nearly as much as slack.~~"],[5923,10,""],[5959,1,""],[6093,0,". Javascript"],[6095,10,""],[6095,0,"V8 is pretty fast!"],[6113,1,""],[6094,19,""],[14368,0,"\n"],[14368,0,"\n### Moving away from JAvascf"],[14390,7,""],[14390,0,"Javascript, and moving away from linked lists\n\nThe next big perfo"],[14437,18,""],[14437,0,"There isn't"],[14437,11,""],[14437,0,"Just "],[14441,1,""],[14440,1,""],[14439,1,""],[14438,1,""],[14438,0,"avascript won't go much faster than this. To improve performance more, we need to start decreasing the number of"],[14437,0,"I'm sad to say it but "],[14501,0," Yjs is very well optimized "],[14528,1,""],[14528,0,","],[14528,1,""],[14528,0," already."],[14536,1,""],[14536,0,", and "],[14541,1,""],[14540,1,""],[14539,1,""],[14538,1,""],[14537,1,""],[14536,1,""],[14536,0,"."],[14538,3,""],[14538,0,"If we want to continue to "],[14584,4,""],[14583,1,""],[14593,33,""],[14592,1,""],[14592,0," the computer to do fewer reads in memory"],[14609,24,""],[14593,16,""],[14593,0,"to pack memory"],[14596,11,""],[14596,0,"make better use of memory.\n\nIn javascript, an object like this:\n\n"],[14660,1,""],[14659,1,""],[14624,15,""],[14624,0,"Imagine "],[14651,0," in javascript"],[14667,0,"\n```\n{ item: 'hello', isDeleted: false, id: ['seph', 0], seq, parent: null }\n```"],[14671,0,"javascript"],[14671,10,""],[14671,0,"json"],[14671,4,""],[14671,0,"javascript"],[14757,0,"\n\nThis object actually looks liek"],[14789,1,""],[14788,1,""],[14788,0,"ke this:\n\n> Diagram..."],[14809,1,""],[14808,1,""],[14807,1,""],[14807,0,"\n\nNote how each "],[14809,14,""],[14809,0,"Note how each"],[14730,1,""],[14730,0,"100"],[14732,1,""],[14748,4,""],[14748,0,"[se"],[14750,1,""],[14749,1,""],[14749,0,"'mike', 2]"],[14830,0," "],[14817,14,""],[14817,0,"Each part of the object"],[14834,6,""],[14834,0,"data structure is separated from the rest"],[14852,23,""],[14852,0,"connected to the rest via pointers. Unforun"],[14894,1,""],[14893,1,""],[14893,0,"tunately, "],[14888,15,""],[14888,0,"In modern computers, following pointere"],[14926,1,""],[14926,0,"s is actually verys "],[14945,1,""],[14944,1,""],[14944,0," slow. If 1 clock cycle was 1 second, following a pointer ("],[14373,62,""],[14373,0,"Better "],[14379,1,""],[14373,6,""],[14373,0,"Moving away from Javascript, and moving away from linked lists"],[14930,9,""],[14930,0," realy"],[14935,1,""],[14935,0,"ly"],[14937,5,""],[14946,0," the computer t"],[14947,14,""],[14944,3,""],[14944,0,"If the computer did"],[14978,3,""],[14978,0,"every"],[15015,0,"doing "],[14994,27,""],[14994,0,"reading data from main memory would take"],[14984,2,""],[15032,0," a few minutes."],[15039,8,""],[15035,4,""],[15035,0,"couple of minutes"],[15035,0,"["],[15053,0,"](https://gist.github.com/hellerbarde/2843375). "],[14817,284,""],[14817,0,"Each part of the data structure is connected to the rest via pointers. In modern computers, following pointers is really slow. If the computer did 1 clock cycle every second, reading data from main memory would take a [couple of minutes](https://gist.github.com/hellerbarde/2843375)."],[14816,0,"\n"],[14816,0,"\nThis is awful for the computer."],[14817,5,""],[14817,0,"The computer hates this."],[14841,26,""],[14843,0,"See, "],[14848,1,""],[14848,0,"e"],[14861,4,""],[14861,0,"that "],[14894,12,""],[14908,0,"In order to follow a pointer, "],[14938,19,""],[14938,0,"your o"],[14943,1,""],[14943,0,"copute"],[14943,6,""],[14943,0,"computer needs to "],[14961,84,""],[14952,0,"usually "],[14969,0," re"],[14971,1,""],[14970,1,""],[14969,1,""],[14968,1,""],[14975,1,""],[14974,1,""],[14973,1,""],[14973,5,""],[14973,0," data"],[14995,0,". If every "],[15000,6,""],[15000,0,"normal memory accesses took 0.5 seconds,"],[15000,27,""],[15000,0,"L1 cache reads took"],[15032,0," reading from am"],[15047,1,""],[15046,1,""],[15046,0,"main memory"],[15070,0,"bout "],[15077,9,""],[15077,0,"2"],[15075,1,""],[15132,0,"\n\n"],[15133,1,""],[15132,1,""],[14841,0,"\n\nTo get there, the computer has to allocate memory with"],[14893,4,""],[14892,1,""],[14892,0,", which si sl"],[14900,5,""],[14900,0,"is slow. The garbage collected"],[14929,1,""],[14928,1,""],[14928,0,"or needs to understand "],[14940,11,""],[14940,0,"track that memory, "],[14958,1,""],[14957,1,""],[14957,0," and do some book "],[14974,1,""],[14974,0,"keeping (also slow)."],[14995,0,"\nAnd once the me"],[15009,2,""],[15009,0,"data is there,"],[15023,5,""],[15023,0," well,"],[15133,8,""],[15142,0," go and fetch that"],[15160,10,""],[15160,0," data"],[15090,28,""],[15090,0,"The data at the eo"],[15107,1,""],[15106,1,""],[15106,0,"other end of a pointer could be anywhere. In order to read"],[15160,4,""],[15160,0,"fetch that data"],[15175,47,""],[15175,0,", your computer needs to read from"],[15210,5,""],[15222,0," In "],[15223,3,""],[15223,0,"If "],[15225,1,""],[15224,1,""],[15224,0,"n computer time if"],[15241,1,""],[15240,1,""],[15239,1,""],[15239,0,", if"],[15243,3,""],[15258,5,""],[15258,0," take"],[14817,3,""],[14817,0,"C"],[14817,1,""],[14817,0,"Your"],[14817,0,"*"],[14843,0,"*"],[14845,0,"\n"],[14845,0,"\nAll the data is separated by pointers."],[14889,9,""],[14889,0,"put data into these boxes"],[14902,0," all"],[14955,1,""],[14955,0,". This"],[14961,6,""],[14970,0," Then"],[14976,1,""],[14976,0,"t"],[15007,0,"keep "],[15017,0," of"],[15032,25,""],[15032,0," "],[15075,64,""],[15075,0,"we need to read it"],[15151,0,"*"],[15143,0,"*"],[15155,30,""],[15155,0,"Y"],[15168,0," willusually"],[15179,1,""],[15178,1,""],[15177,1,""],[15176,1,""],[15175,1,""],[15174,1,""],[15173,1,""],[15173,0," "],[15155,19,""],[15155,0,"To read it, your computer usually"],[15197,0," go fetch it"],[15209,5,""],[15226,0,", which is a"],[15237,1,""],[15237,0,"also slow"],[15401,0,"\n\nWe can't do better in java"],[15411,18,""],[15411,0," fix this in javascript. If we make our data structures more complex, we run into the same limitations Automerge has with immutablejs - which is, the "],[15557,4,""],[15557,0,"if we make our data structures o"],[15588,1,""],[15588,0,"comple,"],[15594,1,""],[15594,0,"x, "],[15403,194,""],[15403,0,"We can't fix this in javascript. If we make our data structures more complex, we run into the same limitations Automerge has with immutablejs - which is, if we make our data structures complex,"],[15402,0,"\n"],[15402,0,"\n"],[15033,1,""],[15032,1,""],[15032,0,", which is "],[15052,1,""],[15055,5,""],[15055,0,"O"],[15081,0,"'re going to"],[15055,25,""],[15055,0,"Later we"],[15062,1,""],[15089,2,""],[15089,0,"that data"],[15100,60,""],[15099,1,""],[15099,0,","],[15099,1,""],[15098,1,""],[15098,0,", and it could be *anywhere*. "],[15374,0," Its like if your shopping list"],[15390,1,""],[15390,0," wrote a"],[15412,0,", but instead of writing \"mil"],[15440,1,""],[15439,1,""],[15438,1,""],[15438,0,"i"],[15438,1,""],[15438,0,"Mili"],[15441,1,""],[15441,0,"k\" you had a little scavenger hunt"],[15437,0,"each item, "],[15486,0," describing where in your house the note with \"milk\" on it is hidden."],[15533,1,""],[15533,0,"M"],[15555,0," Reading the whole list would take ages."],[15596,1,""],[15595,1,""],[15596,0,"\n"],[15596,0,"\nIdeally "],[15597,8,""],[15597,0,"To run faster, we need to move all the fields together. And we n"],[15600,4,""],[15600,0,"go "],[15634,7,""],[15634,0," data to"],[15641,1,""],[15640,1,""],[15639,1,""],[15658,0,"eed to move away from linked lists - as clever as they are, the user *does* sometimes hop around the document and we don't want to ever scan "],[15789,0,"*"],[15794,0,"* do those"],[15809,1,""],[15809,0,"s."],[15857,24,""],[15857,0,"fancy data structures in javascript, the language fights us ("],[15907,11,""],[15907,0,"forces us to "],[15907,13,""],[15894,13,""],[15894,0,"we end up fra"],[15904,3,""],[15904,0,"with even more fragmented memory."],[15937,25,""],[15937,0," In "],[15940,1,""],[15939,1,""],[15939,0,"s"],[15939,1,""],[15939,0,"ts sort of the"],[16001,52,""],[16001,0,". Clever data structures"],[15908,5,""],[15913,0," objects and more"],[15930,11,""],[15937,0," fragmentation"],[15896,0," confuse the optimizer, and"],[15948,30,""],[15948,0," o"],[15949,1,""],[15949,0,"all over the place in memory"],[15982,8,""],[16002,20,""],[16014,0," has"],[16019,23,""],[16019,0,"\n\nB"],[16021,1,""],[16021,0,"But its ok, there's one more "],[16032,18,""],[16032,0," we have webassembly."],[16035,0," don't need to write web app"],[16056,7,""],[16056,0,"javascript antmo"],[16071,1,""],[16070,1,""],[16069,1,""],[16069,0,"y more. "],[16076,1,""],[16075,1,""],[16075,0,", even on the web. We"],[16114,0,"\n\n[e"],[16117,1,""],[16116,1,""],[16116,0,"[Here](https://github.com/josephg/text-crdt-rust/) I've been quite"],[16181,1,""],[16180,1,""],[16180,0,"etly buliding a"],[16185,10,""],[16185,0,"build"],[16189,1,""],[16189,0,"ding yet another implementation"],[16206,14,""],[16206,0,"CRDT impelment"],[16211,9,""],[16211,0,"implementation in Rust. This implementation has all"],[16259,3,""],[16258,1,""],[16255,3,""],[16254,1,""],[16254,0,":\n\n- Does yjs's "],[16257,13,""],[16256,1,""],[16255,1,""],[16254,1,""],[16254,0," is essn"],[16261,1,""],[16261,0,"entially the same as yjs but:\n\n- It doesn't "],[16292,13,""],[16292,0,"- It doesn't"],[16297,7,""],[16297,0,"uses a B-Tree instead of "],[16305,2,""],[16305,0,"-t"],[16322,0,"a linked list to stro"],[16342,1,""],[16341,1,""],[16341,0,"ore the items. This a"],[16356,6,""],[16356,0,"The b-tree "],[16356,11,""],[16356,0,"At ec"],[16360,1,""],[16360,0,"ach node of the b-tree we store the number of "],[16355,0," This solves both of our linear scanning problems rom"],[16407,1,""],[16406,1,""],[16405,1,""],[16405,0,"from earlier."],[16356,62,""],[16355,1,""],[16396,10,""],[16396,0,"length of all of that item's children."],[16293,1,""],[16292,1,""],[16291,1,""],[16290,1,""],[16289,1,""],[16289,0," "],[16290,1,""],[16290,0,"i"],[16430,0,"\n\nThis solves both of our linear scanning problems from earlier. When we want to find where in the list to insert, "],[16516,29,""],[16516,0,"which item in the list"],[16516,6,""],[16516,0,"w"],[16516,1,""],[16520,0," 1000"],[16524,1,""],[16523,1,""],[16522,1,""],[16521,1,""],[16521,0,"50 0000"],[16527,1,""],[16539,0,", we can just traverse down the tree. The "],[16577,4,""],[16577,0,"Trees are really tiy"],[16596,1,""],[16596,0,"dy - storing all these itme"],[16622,1,""],[16621,1,""],[16621,0,"ems"],[16587,37,""],[16587,0,"very tidy - storing all these items we just need 5 "],[16432,206,""],[16432,0,"This solves both of our linear scanning problems from earlier. When we want to find item 50 000 in the list, we can just traverse down the tree. Trees are very tidy - storing all these items we just need 5"],[16430,0,"\n\n> Diagram here"],[16434,0,"B-tree "],[16441,1,""],[16441,0,"d"],[16630,30,""],[16630,0,"this sho"],[16637,1,""],[16636,1,""],[16635,1,""],[16635,0,"whole document  j"],[16651,1,""],[16650,1,""],[16650,0,"just needs 5 l"],[16663,1,""],[16663,0,"layers in the tree.\n\nWea "],[16687,1,""],[16686,1,""],[16685,1,""],[16684,1,""],[16684,0,"Each leaf node (where we store the actual data) packs a whole group of 32 items into the same chunk of memory."],[14367,0,"\nI honeslty "],[14370,9,""],[14370,0,"honestly"],[14369,0,"'m"],[14371,9,""],[14371,0," chocked"],[14372,7,""],[14372,0,"shocked how little ram yjs uses for this.\n"],[14403,10,""],[14403,0,". Its "],[14405,4,""],[14405,0,"I'm sure there's all sorts of wizardry in V8 that I don't understand which makes this possible. Its impresi"],[14511,1,""],[14511,0,"sive all "],[14519,1,""],[14519,0,"-round."],[14403,0," with this appo"],[14417,1,""],[14417,0,"roach"],[14524,0,"extremely "],[14544,11,""],[14544,0,"."],[14403,19,""],[14454,26,""],[14450,4,""],[14450,0,"which "],[14509,62,""],[14509,0,"Rust and B-tr"],[14521,1,""],[14520,1,""],[14520,0,"Treee"],[14524,1,""],[14524,0,"s"],[14509,9,""],[14509,0,"Everything is faster in rust, with "],[14533,1,""],[14533,0,"R"],[16341,0,". This time"],[16412,0," (including yjs's spans). "],[16438,2,""],[16438,0,"B"],[16503,1,""],[16503,0,"\n\n"],[16504,1,""],[16503,1,""],[16503,0," "],[16668,1,""],[16668,0,":\n\n- "],[16672,1,""],[16709,3,""],[16709,0,"our"],[16805,12,""],[16805,0,"only needs 4"],[16817,7,""],[16817,0," "],[16817,1,""],[16816,1,""],[16816,0,"5 levels"],[16827,4,""],[16827,0," our"],[16776,0," we can "],[16783,1,""],[16790,1,""],[16789,1,""],[16788,1,""],[16788,0,"e"],[16810,4,""],[16810,0,"in just"],[16817,6,""],[16753,0," "],[16753,1,""],[16694,0,"the "],[16702,0," at position"],[16721,12,""],[16843,0,"\n- Updating in the tree is easy "],[16870,5,""],[16870,0,"fast too. Usually we can just in"],[16879,23,""],[16879,0," If there's room in the current item, we just insert the new content there. If not, we \""],[16966,1,""],[16965,1,""],[16965,0," split the current item and insert in the parent. The worst case"],[17015,14,""],[17015,0,"In the worst case, we splill"],[17042,1,""],[17041,1,""],[16878,163,""],[16878,0," - it takes O(depth) - or about 5 steps no matter what."],[16918,0,"in this case "],[16945,0," happens"],[16954,0," Much better than needing to shift every ti"],[16996,1,""],[16995,1,""],[16995,0,"item in our javascript ara"],[17020,1,""],[17020,0,"ray!\n\n"],[17025,1,""],[17024,1,""],[17073,0," "],[17073,1,""],[17026,4,""],[17026,0,"In j"],[17029,1,""],[17028,1,""],[17027,1,""],[17027,0,"n Javascript we can't pack a single item into the"],[17073,3,""],[17073,0,"contiguous memory. In rust we can pack each"],[17126,0," into a single memory chunk"],[17153,56,""],[17127,0,"with 32 items all together "],[17180,40,""],[17180,0,"."],[17049,0,"even "],[17111,0,"! In fact, we can"],[17148,0," in r"],[17152,1,""],[17152,0,"our tree with"],[17165,5,""],[17174,0,". A"],[17176,1,""],[17177,1,""],[17176,1,""],[17176,0,"A"],[17111,55,""],[17111,0," pack groups of "],[17135,42,""],[17135,0," t"],[17136,1,""],[17136,0,"all together in chunks. This will result in a bit of memcop"],[17194,1,""],[17193,1,""],[17193,0,"py"],[17180,15,""],[17180,0,"some memcpy-ing when we insert, but memcpy is way faster than "],[17216,26,""],[17216,0,"thats faster than you think."],[15322,0," - you guesed i"],[15329,8,""],[15329,0,"guessed it -"],[15356,16,""],[15356,0,"We can scale up computer time by 1 billion to make it more intuitive. On this time sta"],[15441,1,""],[15440,1,""],[15440,0,"cale, each"],[15450,4,""],[15464,1,""],[15469,0,"s"],[15482,0," (about a heart beat)"],[15503,1,""],[15503,0,"."],[15505,0,"And "],[15552,9,""],[15551,1,""],[15551,0,"2 minutes"],[15560,46,""],[15363,0,"["],[15425,0,"]"],[15425,1,""],[15425,0,"](https://gist.github.com/hellerbarde/2843375)"],[15473,2,""],[15473,0,"At"],[15552,3,""],[15552,0,"Each"],[15552,4,""],[15552,0,"And eah"],[15558,1,""],[15558,0,"ch"],[15567,1,""],[15566,1,""],[15565,1,""],[15610,0," Arranging memory like javascript does here is like"],[15661,9,""],[15724,0," in your list"],[15737,8,""],[15737,0,","],[15745,1,""],[15745,0,"ve"],[15742,0,"r list is full of scavenger hunt clues."],[15782,28,""],[15782,0,"Ecah "],[15786,1,""],[15785,1,""],[15784,1,""],[15783,1,""],[15783,0,"ach clue names"],[15797,11,""],[15797,0," somewhere "],[15808,7,""],[15822,3,""],[15822,0,"with a tiny"],[15838,5,""],[15838,0," saying"],[15858,10,""],[15898,1,""],[15898,0,", and thats what Javascript does."],[15898,1,""],[15898,0,"."],[15899,6,""],[15899,0," T"],[15752,4,""],[15752,0,"actually a"],[15762,3,""],[15777,6,""],[15777,0," full of clues"],[15832,0," - and if you go there you'll find"],[15866,5,""],[15892,0," or \"Cheee"],[15901,1,""],[15901,0,"se\""],[15911,1,""],[15911,0,"\n\n"],[16007,4,""],[16007,0,"squish"],[16192,0,"sl"],[16193,1,""],[16192,1,""],[16192,0,"long slow "],[16208,0," (Remember, its a scavenger hunt each time we move to the n"],[16220,0,"we do"],[16225,3,""],[16269,0,"ext item with linked lists)"],[16295,0,"!"],[15952,28,""],[16575,4,""],[16575,0,"So I've been "],[16575,13,""],[16574,0,"So I've been quietly building "],[16605,0,"yet another CRDT imeplem"],[16622,7,""],[16622,0,"implementation, this time"],[16605,42,""],[16605,0,"a CRDT implementation in rust"],[16679,78,""],[16731,24,""],[16788,3,""],[16788,0,"all of its"],[16814,0,"inern"],[16818,1,""],[16817,1,""],[16816,1,""],[16816,0,"ternal "],[17055,0,"across and down "],[17071,4,""],[17070,1,""],[17164,1,""],[17164,0,", so we only need 5 reads to find the item."],[17265,9,""],[17265,0,"the same "],[17276,0,"or so "],[17288,35,""],[17287,1,""],[17300,58,""],[17300,0," than nee"],[17306,3,""],[17306,0,"when n"],[17311,1,""],[17311,0,"we need "],[17318,1,""],[17318,0,"e"],[17306,13,""],[17306,0,"that javascript array.\n\nIt might al"],[17340,1,""],[17339,1,""],[17339,0,"be faster te"],[17350,1,""],[17349,1,""],[17349,0,"yet to *also* cache the location"],[17373,0,"last "],[17386,0,". I haven't trued th"],[17398,8,""],[17398,0,"tried that yet. But its really fast anyway.\n\n"],[17663,0,"\n"],[17444,1,""],[17662,0,"\n"],[17443,1,""],[17661,0,"\n"],[17442,1,""],[17660,1,""],[17442,0,"\n"],[17363,0,"use yjs's trick and "],[17433,28,""],[17435,219,""],[17435,0,"We"],[17435,2,""],[17435,0,"In Javascript we can't even pack a single item into contiguous memory. In rust we can pack groups of 32 items all together in chunks. This will result in some memcpy-ing when we insert, but thats faster than you think.\n"],[17435,219,""],[17435,0,"We can also pack all the items tightly in memory. Each leaf in the b-tree is stored in a single block fo"],[17538,1,""],[17537,1,""],[17537,0,"of memory. That block "],[17548,11,""],[17548,0,"At that block we store 32 entries - each storing in turn a span of characters. Th"],[17628,1,""],[17627,1,""],[17626,1,""],[17626,0," This "],[17627,5,""],[17627,0,"So inserting *does* need a few memcpy"],[17652,12,""],[17652,0,"some memcopy"],[17663,1,""],[17662,1,""],[17661,1,""],[17661,0,"py-ing, but thats"],[17673,5,""],[17673,0,"I'm"],[17675,1,""],[17674,1,""],[17673,1,""],[17673,0,"thats seriously faster than you think it is. Much faster"],[17704,0," ui"],[17706,1,""],[17705,1,""],[17705,0,"intuitie"],[17712,1,""],[17712,0,"vely"],[17730,11,""],[17729,1,""],[17672,0," its fine -"],[17690,0,"still "],[17717,29,""],[17717,0," doing"],[17673,50,""],[17673,0,"memcpy"],[17672,1,""],[17672,0," a little bit of "],[17695,0," is fine. Its faster than you think"],[17709,0,"seriously "],[17740,0,".\n\nAnyway, how m"],[17755,1,""],[17755,0,"fast?"],[17759,1,""],[17759,0," does it go?\n\nCalled from javascript through webap"],[17808,1,""],[17808,0,"ssembly, the benchmark"],[17817,13,""],[17817,0,"we're down to 0.2 seconds. Called directly from rust, t"],[17871,1,""],[17871,0,"we can proe"],[17881,1,""],[17881,0,"cess this editing trace in "],[17833,1,""],[17832,1,""],[17831,1,""],[17830,1,""],[17830,0," 200 milli"],[17840,1,""],[17913,0,"65 n"],[17916,1,""],[17916,0,"milliseconds. And "],[17929,5,""],[17741,0,"\n\nThere's one last thing I've done. I don't know if its a good idea, but I suspect its "],[17816,12,""],[17816,0,"di i"],[17819,1,""],[17818,1,""],[17818,0,"d it "],[17822,1,""],[17822,0," anyway.\n\n"],[17831,1,""],[17830,1,""],[17830,0," I moved the text content itself into a "],[17869,1,""],[17869,0,"nother structures."],[17886,1,""],[17885,1,""],[17885,0,". S"],[17887,1,""],[17887,0,"When you're actually doing collaborative editing "],[17935,1,""],[17935,0,", you have all the car"],[17956,1,""],[17955,1,""],[17955,0,"haracters in your odnw"],[17973,4,""],[17973,0,"document in "],[17940,0," probably want to"],[18002,0,"an actual array, or an actual string or something. So I made it so the CRDT data structure onol"],[18096,1,""],[18095,1,""],[18095,0,"ly"],[17829,0," because it seemed clever at the time"],[17854,12,""],[17893,7,""],[17893,0,"a separate data"],[17920,0,"See, "],[17925,1,""],[17925,0,"w"],[17992,8,""],[18072,9,""],[18072,0,"in VS Code's data structures or h"],[18104,1,""],[18104,0,"whatever. It doesn't make sense to store the content twice"],[18189,14,""],[18188,1,""],[18193,0," stores "],[18194,0,"needs to "],[18209,1,""],[18208,1,""],[18208,0," the spans and such. Just enough that it can merge changes.s"],[18267,1,""],[17868,4,""],[17867,1,""],[17883,0,"out "],[18028,0,"to be stored "],[18059,21,""],[18059,0,","],[18077,27,""],[18077,0,"editor r "],[18085,1,""],[18084,1,""],[18084,0,"or something"],[18173,78,""],[18164,9,""],[18164,0,"my CRDT stores"],[18366,0,"\n"],[18179,1,""],[18365,0,"\nThere's one last thing I've done. I don't know if its a good idea, but I did it anyway because it seemed clever. I moved the content itself out into a separate data structure. See, when you're actually doing collaborative editing, you probably want all the characters in your document to be stored in an actual array, or in VS Code's editor or something. It doesn't make sense to store the content twice. So I made it so my CRDT stores"],[17743,436,""],[17929,0,"\n"],[17742,1,""],[17928,0,"\nWe can also pack all the items tightly in memory. Each leaf in the b-tree is stored in a single block of memory. At that block we store 32 entries - each storing in turn a span of characters. So inserting *does* need some memcpy-ing, but a little bit of memcpy is fine. Its seriously faster than you think."],[17435,307,""],[17621,307,""],[17435,0,"We can also pack all the items tightly in memory. Each leaf in the b-tree is stored in a single block of memory. At that block we store 32 entries - each storing in turn a span of characters. So inserting *does* need some memcpy-ing, but a little bit of memcpy is fine. Its seriously faster than you think.\n"],[17928,1,""],[17742,0,"\n"],[17929,0,"\n\n\n"],[17931,0,"\n| Test                              | Time taken | RAM usage |\n| --------------------------        | ---------- | --------- |\n| automerge @ 1.0.0-preview2        |  291s      | 880 MB    |\n| reference-crdts (automerge / yjs) |   31s      |  28 MB    |\n| Yjs                               | 0.97s      | 3.6 MB    |\n| JS baseline                       | 0.61s      | 0.1 MB    |"],[17930,1,""],[18308,0,"\n| Rust via web"],[18316,7,""],[18316,0,"called from JS"],[18316,14,""],[18316,0,"(through WASM)               | 0.65s\n| JS baseline                       | 0.61s      | 0.1 MB    |"],[18246,63,""],[18289,0,"      | 2.3 MB    |"],[18246,0,"| Rust (through WASM)               | 0.65s      | 2.3 MB    |\n"],[18317,12,""],[18317,0,"native"],[18324,0,"      "],[18254,7,""],[18254,0,"Via JS +"],[18254,3,""],[18254,0,"Called from"],[18269,1,""],[18269,0,"via"],[18279,11,""],[18287,1,""],[18286,1,""],[18286,0,"20"],[18287,1,""],[18287,0,"0"],[18349,0,"0"],[18354,1,""],[18434,0,"\n| Rust (native)                     | 0.065s     | 2.3 MB    |"],[18309,63,""],[18371,0,"\n| Rust (Called from JS via WASM)    | 0.20s      | 2.3 MB    |"],[18246,63,""],[18069,0,"("],[18071,1,""],[18085,0,")"],[18086,1,""],[18191,20,""],[18191,0,"(&"],[18192,1,""],[18192,0,"$"],[18192,1,""],[18192,0,"#"],[18192,1,""],[18192,0,"@13.5.5)           "],[18189,3,""],[18189,0,"("],[18198,0,"  "],[18070,1,""],[18070,0,"v"],[18190,1,""],[18190,0,"v"],[18790,81,""],[18790,0,"\n\nThese times assume your "],[18804,12,""],[18792,12,""],[18792,0,"S"],[18792,1,""],[18792,0,"So the data strucut"],[18810,1,""],[18809,1,""],[18809,0,"ture looks like this:\n\n```\n{\n  \n  "],[18838,2,""],[18839,2,""],[18839,0,"}\n```"],[18838,0,"  text: <R"],[18847,1,""],[18846,1,""],[18846,0,"Rope implementation"],[18846,19,""],[18846,0,"\"abc\","],[18837,0,"\n  tree: <Range tree storing spans and offsets and such"],[18847,45,""],[18847,0,"B-tree storing the content>,\n  index: I"],[18885,1,""],[18884,1,""],[18884,0," <Index "],[18876,16,""],[18876,0,"  index: <Index"],[17328,0,"\n\nI'm also storing a "],[17348,1,""],[17348,0,"n index bac"],[17355,4,""],[17355,0," "],[17355,1,""],[17355,0,", so we can easily find \""],[17379,1,""],[17374,5,""],[17374,0,"look up items byt"],[17390,1,""],[17390,0," their ID ("],[17400,1,""],[17400,0,"*("],[17401,1,""],[17400,1,""],[17400,0,"(*("],[17402,1,""],[17402,0,"[Seph"],[17406,1,""],[17405,1,""],[17404,1,""],[17403,1,""],[17403,0,"'seph', 100]("],[17415,1,""],[17415,0,"*)"],[17374,7,""],[17374,0,"find"],[17374,4,""],[17367,7,""],[17367,0,"quickly find"],[17414,0," -> "],[17417,1,""],[17416,1,""],[17415,1,""],[17414,1,""],[17415,0,"."],[17429,0," even"],[17441,7,""],[17441,0," if I"],[17469,4,""],[17469,0," of"],[17477,1,""],[17477,0,"ing"],[17527,0,"Rust lets us"],[17539,11,""],[17602,61,""],[17602,0,"stores"],[17619,0,", with even"],[17629,1,""],[17629,0,"rything contiguous."],[17649,44,""],[17648,1,""],[17649,2,""],[17649,0,"I"],[17649,3,""],[17649,0,"I"],[17658,0," like this"],[17737,0," also"],[17741,1,""],[17740,1,""],[17740,0,"ways"],[17744,10,""],[17756,0," I"],[17758,4,""],[17764,0," it will be"],[17778,7,""],[17778,0,"Speaking of fast,"],[18859,0,"actually "],[18939,6,""],[18930,9,""],[18930,0,"  index: <in"],[18941,1,""],[18940,1,""],[18940,0,"Index of ID => "],[18954,1,""],[18953,1,""],[18952,1,""],[18952,0,"-> "],[18954,1,""],[18953,1,""],[18952,1,""],[18952,0,"=> b-tree node>,"],[18978,3,""],[18978,0,"oh hai!"],[18859,0,"*"],[18868,0,"*"],[18996,0,"\nBut gues "],[19005,1,""],[19005,0,"s"],[18997,9,""],[18997,0,"For the text I'm "],[19009,5,""],[19009,0," content I'm using [Ropey](https://docs.rs/ropey/1.2.0/ropey/). But guess what? I"],[19089,1,""],[19089,0,"My code is faster than ropey. And "],[19119,4,""],[19118,1,""],[19118,0," If I turn it off"],[19118,17,""],[19119,0,"\n| Test                              | Time taken | RAM usage |\n| --------------------------        | ---------- | --------- |\n| automerge (v1.0.0-preview2)       |  291s      | 880 MB    |\n| reference-crdts (automerge / yjs) |   31s      |  28 MB    |\n| Yjs (v13.5.5)                     | 0.97s      | 3.6 MB    |\n| JS baseline                       | 0.61s      | 0.1 MB    |\n| Rust (Called from JS via WASM)    | 0.20s      | 2.3 MB    |\n| Rust (native)                     | 0.065s     | 2.3 MB    |\n"],[19118,0," And that content is stored "],[19139,7,""],[19139,0,"going to be stored in someone else's"],[19151,24,""],[19151,0,"someone else's problem anyway. What happens if I turn that off?"],[19182,0,"Its cheating, but "],[19200,1,""],[19200,0,"w"],[19675,0,"| Rust (native)                     | 0.065s     | 2.3 MB    |\n"],[19753,0,", not sto"],[19761,1,""],[19760,1,""],[19759,1,""],[19758,1,""],[19757,1,""],[19757,0," string"],[19764,19,""],[19764,0,"        "],[19758,8,""],[19758,0,"content "],[19780,1,""],[19779,1,""],[19779,0,"23"],[19791,1,""],[19791,0,"1"],[19182,0,"Look, I know I'm"],[19198,3,""],[19197,1,""],[19196,1,""],[19195,1,""],[19195,0,"its"],[19231,0,"just ... "],[19774,1,""],[19786,0,")"],[19779,7,""],[19779,0,"doc content"],[19792,4,""],[19685,6,""],[19685,0,"???   "],[18405,6,""],[18405,0,"???    "],[18411,1,""],[18657,6,""],[18657,0,"W"],[18830,0," And that stru"],[18831,13,""],[18831,0,"It doesn't make sense to duplicate the document content."],[18878,0,"'s"],[18888,1,""],[18888,0," in my library."],[19141,0,"Its pretty fast... but "],[19164,4,""],[19179,4,""],[19179,0,"B-tree"],[19342,1,""],[19342,0," to see how fast this puppy can really go?"],[19953,0,"\nBoom.\n\n"],[19959,0," 14000 "],[19965,1,""],[19965,0,"x faster."],[19973,0,"; as promised"],[225,0,"all of "],[236,4,""],[419,0,"this is awkward but .. "],[587,0,"which, by the way, "],[677,18,""],[677,0,"Oi!"],[679,1,""],[679,0," - whats going on?"],[696,1,""],[696,0," here?"],[773,14,""],[773,0,"code"],[944,0,". And"],[949,2,""],[955,5,""],[955,0,"of those inserts"],[1007,16,""],[1007,0,"O"],[1007,0,"Duh - "],[1013,1,""],[1013,0,"o"],[1183,0,"so many "],[1197,10,""],[1207,0,"me a link to"],[1219,7,""],[1254,6,""],[1257,0," Bad!"],[1271,0," Y "],[1273,1,""],[1272,1,""],[1272,0,"My code isn't slow, "],[1271,21,""],[1408,0,". Jupiter os an "],[1423,1,""],[1422,1,""],[1421,1,""],[1420,1,""],[1419,1,""],[1418,1,""],[1418,0,"is an Algorithm. RGA is an Algorithm."],[1456,3,""],[1456,0,"B"],[1435,0,"The "],[1442,6,""],[1443,1,""],[1443,0,"a"],[1653,13,""],[1652,1,""],[1795,1,""],[1804,1,""],[1896,128,""],[1896,0,"Years ago "],[1907,9,""],[1918,1,""],[1917,1,""],[1916,1,""],[1916,0,"ed"],[1928,6,""],[1922,6,""],[1921,1,""],[183,0,"s"],[2126,38,""],[2149,4,""],[2149,0,"does"],[2294,0," I think they're the future of collaborative editing."],[2378,0," for years"],[2211,1,""],[2222,0," is slow!"],[2495,0,"I think "],[2536,1,""],[2537,3,""],[2537,0,"as "],[2666,16,""],[2666,0,"anything about efficient "],[2708,10,""],[2708,0," of those systems"],[2727,6,""],[2727,0,"Wow, I was"],[2737,16,""],[2737,0," was"],[2737,0," turns out I"],[2733,4,""],[2731,2,""],[2727,4,""],[2727,0,"But it"],[2717,8,""],[2717,0," systems"],[2727,6,""],[2727,0,"Wow, I was"],[2737,16,""],[2763,11,""],[2763,0,"Well"],[2801,0,"["],[2811,0,"](https://github.com/automerge/automerge/)"],[2798,0,"https://github.com/automerge/automerge-perf/"],[2998,0," to run"],[3082,1,""],[3081,1,""],[3081,0,"54"],[3082,1,""],[3081,1,""],[3081,0,"65"],[3099,32,""],[3098,1,""],[3099,0,"nearly "],[3106,6,""],[3106,0,"5000x faster"],[3264,0,"I'll take you through "],[3285,33,""],[3285,0," I "],[3287,1,""],[3286,1,""],[3285,1,""],[3285,0," I "],[3287,1,""],[3285,2,""],[3285,0," all the steps that make it fast."],[3300,18,""],[3300,0,"to make it super fast."],[3324,4,""],[3324,0,"But"],[3353,0,":"],[2254,0,"https://josephg.com/blog/crdts-are-the-future/"],[3570,0,"["],[3586,0,"](https://martin.kleppmann.com/2020/07/06/crdt-hard-parts-hydra.html)"],[4147,27,""],[4147,0,"Sounds like a tree, dawg!"],[4147,24,""],[4147,0,"Its a tree"],[4438,0,"\n> Diagram here\n"],[5151,8,""],[5151,0,"When"],[5196,6,""],[5224,0,"their "],[5239,0," resulting"],[5254,0," (or d"],[5259,1,""],[5259,0,"text document) can be made by"],[5288,26,""],[5288,0," "],[5425,11,""],[5429,0,", which is to store a "],[5450,1,""],[5449,1,""],[5449,0,"all the data as a tree"],[5529,1,""],[5528,1,""],[5527,1,""],[5526,1,""],[5525,1,""],[5524,1,""],[5523,1,""],[5522,1,""],[5652,0," (Wh"],[5655,1,""],[5654,1,""],[5653,1,""],[5652,1,""],[5653,0," (What are all those Uint8Arrays doing all of t"],[5699,1,""],[5698,1,""],[5697,1,""],[5697,0,"ver the place?)"],[5655,0,"And "],[5659,1,""],[5659,0,"w"],[5716,0,"."],[5718,0,"\nThrough this po"],[5719,15,""],[5719,0,"We're going to go through a lot of different algri"],[5768,1,""],[5767,1,""],[5767,0,"orh"],[5769,1,""],[5769,0,"ithms here"],[5773,1,""],[5773,0,"ic app"],[5775,4,""],[5773,2,""],[5773,0,"s"],[5779,0,"."],[5780,1,""],[5780,0," To"],[5783,3,""],[5795,1,""],[5794,1,""],[5793,1,""],[5793,0," all of them"],[5781,24,""],[5781,0,"So t"],[5784,1,""],[5784,0,"for a simple benchmark"],[5784,3,""],[5784,0,"as"],[5810,0," going to"],[5819,6,""],[5819,0," use"],[5937,6,""],[5944,0," himself"],[5961,0," where"],[5962,21,""],[6001,1,""],[6000,1,""],[6000,0," aren't any"],[6011,3,""],[6046,1,""],[6051,0," ja"],[6053,1,""],[6052,1,""],[6052,0,"has edits from"],[6081,1,""],[6081,0,"."],[6083,1,""],[6083,0,"B"],[6106,1,""],[6106,0," -"],[6109,1,""],[6109,0,"u"],[6114,0," almost never "],[6127,1,""],[6128,13,""],[6128,0,"put their cursors a t"],[6148,1,""],[6147,1,""],[6147,0,"t exactly the same place and start "],[6188,43,""],[6188,0," at the same time."],[6127,0," actually"],[6197,18,""],[6197,0,"."],[6185,6,""],[6190,1,""],[6189,1,""],[6188,1,""],[6188,0,"e"],[6190,0," And I'm just counting the time from applying this trace *locally*. Not ideal, but eh. You want the good stuff, ou"],[6273,31,""],[6273,0,"good enough"],[6273,11,""],[6273,0,"eh."],[6273,3,""],[6273,0,"its "],[6276,1,""],[6275,1,""],[6274,1,""],[6274,0,"it"],[6275,1,""],[6274,1,""],[6274,0,"t'll do."],[3033,0,"nearly 5 minutes to run. "],[3058,20,""],[3131,1,""],[3130,1,""],[3129,1,""],[3132,0,"millin"],[3137,1,""],[3144,0,". 0.6"],[3148,1,""],[3148,0,"065 seconds"],[3392,3,""],[3392,0,"Wait, no."],[3401,10,""],[3401,0," First"],[3436,0," an"],[3437,2,""],[3436,1,""],[3434,0,"on earth "],[3798,0,"\n\nI"],[3800,1,""],[3800,0,"I don't recomend"],[3815,1,""],[3814,1,""],[3813,1,""],[3813,0,"mend using it. If you want a production grade CRDT implementation today, "],[3800,0,"("],[3818,0," actually"],[3801,0,"Just an aside: "],[3851,0," t"],[3852,1,""],[3851,1,""],[3851,0," yet - its not ready"],[3931,0,"https://github.com/yjs/yjs"],[3930,0," Yjs is the "],[3938,4,""],[3938,0,"currently the best in the business"],[3972,27,""],[3972,0,". Kevin "],[3979,1,""],[3979,0," Y"],[3980,1,""],[3980,0,"Jahns is a class act"],[3986,14,""],[3974,12,""],[3974,0,"Youl'"],[3978,1,""],[3977,1,""],[3977,0,"'ll see why soon!)"],[3849,2,""],[3849,0,"automerge"],[3938,0,"["],[3942,0,"]( https://github.com/yjs/yjs)"],[3944,1,""],[3974,10,""],[3859,4,""],[3858,1,""],[3858,0," at the moment."],[3873,3,""],[3873,0," I"],[3887,0," for prime time"],[3892,10,""],[3891,1,""],[3890,1,""],[3889,1,""],[3888,1,""],[3888,0,"yet"],[3988,24,""],[3988,0,"as "],[3990,1,""],[3989,1,""],[3989,0,"n easy recommendation. It "],[4014,1,""],[4013,1,""],[4012,1,""],[4011,1,""],[4010,1,""],[4023,3,""],[4023,0,"some of the reasons"],[3801,7,""],[3801,0,"Oh and a quick"],[4058,0,"Si "],[4060,1,""],[4059,1,""],[4059,0,"o "],[4058,3,""],[4073,0,"Yjs and other "],[4087,5,""],[4086,1,""],[4086,0,"s"],[4086,1,""],[4446,11,""],[4446,0,"We can draw this as a tree!"],[4954,0,"argh, "],[4968,0," actually"],[5006,1,""],[5006,0," because"],[5014,14,""],[5014,0," "],[4780,1,""],[4780,0,"X"],[4818,0," Hang on, which one goes first?"],[4828,0,"how do we figure out "],[4854,4,""],[4854,0," character shoul"],[4865,5,""],[4864,1,""],[4981,10,""],[4981,0," sorting them based on "],[5003,1,""],[5030,0,"then we'd end up with \"abXc\"."],[5059,118,""],[5060,3,""],[5060,0,"Automerge"],[5148,0,". The sequence number is bi"],[5173,2,""],[5173,0,"1 bigger than the biggest sequence number you've ever seen"],[5150,0,"When you make a change, "],[5174,1,""],[5174,0,"t"],[5159,15,""],[5159,0,"insert anything, you set "],[5204,2,""],[5204,0,"to"],[5207,0,"be "],[5268,1,""],[5268,0,". Yjs has a different approach, but its "],[5268,40,""],[5268,0,":"],[5270,0,"\n"],[5270,0,"\n(Yjs has a different approach to the e"],[5308,1,""],[5308,0,"sequence numner th"],[5317,9,""],[5317,0,"m"],[5317,1,""],[5317,0,"number thing, but the difference is "],[5335,18,""],[5335,0,"lets not get into that now)"],[5282,0,"slightly "],[5344,26,""],[5344,0,"whatever"],[5344,8,""],[5344,0,"its fine,"],[5352,1,""],[5344,8,""],[5344,0,"you"],[5271,77,""],[5270,1,""],[5269,1,""],[5082,0,"with a bit of a hack. It "],[5107,3,""],[5112,1,""],[5111,1,""],[5110,1,""],[5110,0,"s"],[5174,0,"ever"],[5211,0," new item's"],[5524,0,"\n\n(Wo "],[5529,1,""],[5526,4,""],[5525,1,""],[5525,0,"\n\n"],[5526,0,"> Wow I saw a sequence number, and it was *this big*!"],[5578,1,""],[5577,0,"!"],[5526,53,""],[5525,1,""],[5524,1,""],[5524,0,"\n\n> Wow I saw a sequence number, and it was *this big!*. Y"],[5581,1,""],[5581,0,"\""],[5581,1,""],[5581,0,"Yeah? Mine is *even bige"],[5604,1,""],[5604,0,"ger!*"],[5528,0,"\""],[5581,0,"\""],[5583,0,"\""],[5612,0,"\". Ahem."],[6180,0,"Uh, uhm, "],[6225,1,""],[6286,1,""],[6285,1,""],[6285,0," I think"],[6286,7,""],[6286,0,"Yes, the automerge library implements"],[6312,11,""],[6286,26,""],[6286,0,"Whta"],[6289,1,""],[6288,1,""],[6288,0,"atever. The automerge library implements"],[6318,10,""],[6318,0,"works by building a tree of items."],[6285,1,""],[6285,0,"\n\n"],[6286,1,""],[6285,1,""],[6285,0," "],[6286,8,""],[6285,3,""],[6285,0,"\n\n"],[6286,1,""],[6285,1,""],[6285,0," Any"],[6288,1,""],[6287,1,""],[6286,1,""],[6286,0,"Waht"],[6289,1,""],[6288,1,""],[6287,1,""],[6287,0,"hatever. "],[6035,0,"("],[6286,0,")"],[6356,61,""],[6356,0,"So how e"],[6363,1,""],[6363,0,"we"],[6364,1,""],[6363,1,""],[6363,0,"fas"],[6356,10,""],[6356,0,"How fast is it?"],[6372,4,""],[6372,0,"A"],[6408,3,""],[6408,0,"run"],[6408,3,""],[6408,0,"test it using"],[6432,0,"own "],[6436,15,""],[6423,0,"an editin "],[6432,1,""],[6432,0,"g trace "],[6446,20,""],[6446,0," himself made"],[6526,8,""],[6526,0," trace of"],[6542,8,""],[6550,1,""],[6549,1,""],[6549,0,"in"],[6550,1,""],[6549,1,""],[6543,6,""],[6543,0,"typing up"],[6552,15,""],[6552,0," "],[6356,16,""],[6356,0,"How fast is it? "],[6356,16,""],[6356,0,"For "],[6360,1,""],[6360,0,"a"],[6361,1,""],[6363,1,""],[6362,1,""],[6397,0," automerge"],[6407,3,""],[6656,22,""],[6736,0," anyawy"],[6742,1,""],[6741,1,""],[6740,1,""],[6740,0,"way"],[6745,4,""],[6748,5,""],[6748,0," only"],[6832,0," Kevin Jahns (the Yjs author) has a much better"],[6873,6,""],[6873,0,"more extensive benchmarking suite"],[6878,0,"["],[6907,0," here](https://github.com/dmonad/crdt-benchmarks). All the benchmarks here are done using Nodes"],[7001,1,""],[7001,0,"js 16.1 on my hc"],[7016,1,""],[7015,1,""],[7015,0,"chonky chonk ryzen 5800x workstation."],[7022,5,""],[7021,1,""],[6991,18,""],[7027,1,""],[7027,0,", with using Nodejs 16.1 "],[7034,6,""],[7046,0,"and rustc 1.52 when thats appropriate. Spoilers!"],[6525,2,""],[6525,0,"from"],[6613,40,""],[6613,0,","],[6615,1,""],[6615,0,"b"],[6711,0," also"],[6774,1,""],[6774,0,", which"],[6781,4,""],[6781,0," isn't"],[6793,1,""],[6821,4,""],[6927,0," if you're into that sort of thing"],[6967,3,""],[6967,0,"my"],[6967,2,""],[6967,0,"the"],[7090,0,"("],[7100,0,")"],[7075,1,""],[7075,0," becomes"],[7110,0,"Anyway, "],[7118,1,""],[7118,0,"a"],[7127,0," above"],[7233,0," "],[7244,35,""],[7108,0,"\n\nThe editing trace "],[7110,18,""],[7110,0,"M"],[7110,1,""],[7110,0,"The editing trace has 2800"],[7135,1,""],[7135,0," 000 edits, and the final document size is about 100kb."],[7188,0," "],[7188,1,""],[7187,0," "],[7188,2,""],[7188,0,"000 characters"],[7205,9,""],[7204,1,""],[7203,1,""],[7203,0," A"],[7203,1,""],[7203,0,"\n\n"],[7278,8,""],[7290,18,""],[7290,0,"by the time its donw"],[7309,1,""],[7309,0,"e, automerge uses"],[7341,0," Wow."],[7345,1,""],[7345,0,"!"],[7345,1,""],[7345,0,"!"],[7342,4,""],[7342,0,"Whoa! Thats 10kb f"],[7359,1,""],[7359,0,"of ram *per key press*."],[7384,54,""],[7384,0,"We can compare"],[7384,14,""],[7384,0,"W"],[7384,1,""],[7384,0,"If we just process that in javascript directly"],[7430,24,""],[7430,0,", using a"],[7457,39,""],[7457,0,", well "],[7463,1,""],[7463,0,", its much slower:"],[7467,1,""],[7467,0," might allow concurrent edits but its"],[7504,12,""],[7504,0," slow"],[7671,0," "],[7674,1,""],[7764,0," "],[7764,1,""],[7763,1,""],[7763,0," though?"],[8360,8,""],[8360,0,"that"],[8372,0," too"],[8438,0," The automerge team is working on a rust \"backend\""],[8487,1,""],[8479,1,""],[8486,0," for the algorithm, but it hasn't been merged yet."],[8474,0,"replacement "],[8490,16,""],[8490,0," implementation of the"],[8554,0," And in the meantime they haven't bothered making the javascript code fast because"],[8554,82,""],[8528,0,"at the time of writing "],[8579,118,""],[8578,0,"\n"],[8578,1,""],[8579,0,"There's an old saying with performance tuning:\n\n> You can't make a program faster. You can only make it do less work.\n"],[8386,3,""],[8386,0," automerge"],[8400,5,""],[8379,9,""],[8379,0,"A"],[8437,10,""],[8436,1,""],[8436,0,"ir "],[8546,17,""],[8546,0," landed yet."],[8661,2,""],[8661,0,"the computer"],[8560,0,"So how do"],[8560,9,""],[8689,4,""],[8689,0,"H"],[8778,0," from goin ght"],[8791,1,""],[8790,1,""],[8789,1,""],[8788,1,""],[8788,0,"g through the code and improving things"],[8832,0," I agree with the atuomer"],[8850,7,""],[8850,0,"automerge team:"],[8866,1,""],[8866,0,"W"],[8864,1,""],[8864,0,"."],[9005,19,""],[9005,0,"A"],[9074,0," Lets "],[9079,1,""],[9078,1,""],[9077,1,""],[9076,1,""],[9075,1,""],[9074,1,""],[9074,0," We can "],[9075,7,""],[9075,0,"LEts"],[9078,1,""],[9077,1,""],[9076,1,""],[9076,0,"ets \"Im"],[9082,1,""],[9081,1,""],[9081,0,"improve\" it."],[9080,9,""],[9080,0,"fix"],[9172,1,""],[9172,0,"."],[9174,5,""],[9174,0,"You can"],[9172,1,""],[9172,0,", which Ke"],[9180,2,""],[9174,6,""],[9174,0,"pioneered by"],[9186,55,""],[9227,5,""],[9227,0,"talking about"],[9261,1,""],[9260,1,""],[9260,0,","],[9260,1,""],[9281,0,"pretty "],[9334,0,"data structure \""],[9355,0,"\""],[9388,0,"in the field has "],[9461,0," automerge does"],[9476,5,""],[9753,0,"flat "],[10027,84,""],[10026,1,""],[10025,1,""],[10025,0,", bu"],[10028,1,""],[10027,1,""],[10026,1,""],[10026,0," "],[10035,1,""],[10034,1,""],[10034,0,"ll get there"],[10046,14,""],[9983,9,""],[10041,0,"With this structure, the way we insert items changes."],[10093,1,""],[10093,0," slightly. "],[10104,68,""],[10103,1,""],[10094,9,""],[10093,1,""],[10093,0,"."],[10110,3,""],[10110,0,"wi"],[10111,1,""],[10111,0,"e insert by"],[10122,10,""],[10122,0," answer is"],[10119,3,""],[10112,7,""],[10111,1,""],[10111,0,"i"],[10110,2,""],[10110,0,"the"],[10093,1,""],[10093,0," slightly. ?"],[10104,0,"The question is, how do you insert a new item into a list like this"],[10104,18,""],[10104,0,"H"],[10144,10,""],[10062,42,""],[10041,21,""],[10041,0,"That looks simple, but "],[10064,1,""],[10064,0,"h"],[10121,14,""],[10121,0,"its easy:"],[10213,18,""],[10213,0,", keeping the sor"],[10226,4,""],[10226,0,"m sorted."],[10213,1,""],[10213,0,". ("],[10216,8,""],[10216,0,"Keep"],[10213,20,""],[10188,0,"right location in the "],[10235,0,"."],[10235,1,""],[10245,0," tyj"],[10248,1,""],[10247,1,""],[10246,1,""],[10246,0,"yjs"],[10387,0,"where "],[10428,0,"And uh, "],[10436,1,""],[10436,0,"i"],[10428,9,""],[10428,0,"I"],[10434,9,""],[10434,0," it!"],[10440,33,""],[10440,0,"This is"],[10447,39,""],[10447,0," just a"],[10440,0,"Essentially, "],[10453,4,""],[10453,0,"this approach"],[10500,0,"It sounds sort of complicated, but "],[10535,1,""],[10535,0,"y"],[10603,0,"Here's a"],[10610,1,""],[10610,0,"the algorithm in "],[10627,3,""],[10635,45,""],[10635,0,", with lots o"],[10642,6,""],[10642,0,"comments"],[10869,0," CRDT"],[10837,0," lots of R"],[10846,1,""],[10846,0,"CRDTs like this."],[10894,0,"s all work, and y"],[10904,7,""],[10904,0,"\n2. Doing it this way lets you implement the semantics of multiple"],[10975,0,"s"],[10976,10,""],[11107,2,""],[11107,0,"s. "],[11110,2,""],[11110,0,"M"],[11116,0," you"],[11125,0," need to"],[11141,1,""],[11140,1,""],[11139,1,""],[11138,1,""],[11174,0,"s"],[11177,1,""],[11177,0,"3"],[11423,1,""],[11423,0,"4"],[11547,1,""],[11547,0,"5"],[11179,0," The algorithm iss"],[11196,1,""],[11196,0," super fast"],[11194,13,""],[11194,0,"only slows down when there are"],[11225,1,""],[11225,0,"c"],[11264,0,". u"],[11266,1,""],[11266,0,"But thats"],[11275,4,""],[11298,4,""],[11298,0," -"],[11360,85,""],[11360,0,"I"],[11387,1,""],[11387,0,"."],[11404,4,""],[11404,0,"the"],[11408,0,"*"],[11423,0,"*"],[11423,1,""],[11408,1,""],[11426,4,""],[11425,1,""],[11450,0," is"],[11478,0," to actual automerge, and yjs and sync9"],[11519,1,""],[11546,1,""],[11545,1,""],[11545,0,".)"],[11519,0,"("],[11520,21,""],[11520,0,"F"],[11526,0," verfi"],[11531,1,""],[11530,1,""],[11530,0,"ified (TM)"],[11520,0,"["],[11536,0,"](https://github.com/josephg/reference-crdts/blob/main/reference_test.ts)"],[11609,6,""],[11617,0," kind"],[11618,4,""],[11618,0,"also really"],[11630,4,""],[11630,0,"elegant"],[11639,0,"We "],[11642,1,""],[11642,0,"i"],[11675,1,""],[11675,0,"."],[11684,1,""],[11676,8,""],[11676,0," Genius!"],[11676,8,""],[11676,0," Genius!"],[11720,5,""],[11720,0,"ITs a"],[11724,1,""],[11723,1,""],[11722,1,""],[11721,1,""],[11721,0,"ts about"],[11777,37,""],[11777,0,":"],[12096,0,"Mind you, "],[12106,1,""],[12106,0,"s"],[12143,10,""],[12142,1,""],[12193,0," This "],[12194,5,""],[12194,0,"These "],[12194,6,""],[12194,0,"These are completely different codebases being tested."],[10235,0,"\n3. Uh"],[10239,2,""],[10239,0,"S"],[10239,1,""],[10239,0,"Traverse the tree"],[10248,8,""],[10248,0,"backwa"],[10248,6,""],[10248,0,"up the tree to figure out where "],[10274,6,""],[10274,0,"the insert position of th e"],[10300,1,""],[10300,0,"e"],[10300,1,""],[10299,1,""],[10299,0,"e new item, and update"],[10250,0," through"],[10329,0," our copy of the document. (Automerge also sto"],[10236,139,""],[10236,0,"3. Traverse up through the tree to figure out the insert position of the new item, and update our copy of the document. (Automerge also sto"],[10239,0,"("],[10239,1,""],[10318,4,""],[10318,0," so you can"],[10329,53,""],[10329,0," add "],[10333,1,""],[10329,4,""],[10329,0," update our copy of the document. (Automerge also sto"],[10337,12,""],[10349,21,""],[10349,0," in your editor / "],[10366,1,""],[10365,1,""],[10364,1,""],[10364,0,"."],[10341,0,"actual "],[10383,1,""],[10383,0,"Y"],[10666,0," (And it"],[10668,6,""],[10668,0,"and it si"],[10676,1,""],[10675,1,""],[10675,0,"is a bit hairy translating the semantics)"],[10716,1,""],[10716,0,"."],[10718,1,""],[10718,0,"B"],[10761,0," for automerge or yjs "],[10782,1,""],[10822,9,""],[10822,0,"insert function"],[10978,38,""],[10978,0,"This approach is pretty beautiful"],[11011,12,""],[10995,7,""],[10995,0,"pretty "],[10995,7,""],[11004,0," for lot sof reasons"],[11016,1,""],[11015,1,""],[11014,1,""],[11013,1,""],[11012,1,""],[11012,0,"s of "],[11820,0,"\n5. Its faster *and* simpler. Holy grail."],[11850,0,"Thats wal"],[11858,1,""],[11857,1,""],[11856,1,""],[11856,0,"always the "],[11867,1,""],[11867,0,"h"],[11850,28,""],[11850,0,"Holy grail, right there."],[11848,26,""],[11848,0,"."],[11849,28,""],[11931,10,""],[11931,0,"Its "],[11897,34,""],[11897,0,"This approach is about"],[11919,3,""],[11930,0,", and"],[11935,10,""],[12302,0,"se"],[12434,0,", so its"],[12436,6,""],[12435,1,""],[12434,1,""],[12434,0,". The performance difference is nevr j"],[12471,1,""],[12470,1,""],[12469,1,""],[12469,0,"er just one thing"],[12462,0,"s aren't"],[12470,9,""],[12434,1,""],[12434,0,", so"],[12439,1,""],[12439,0,"t"],[12479,0,"this "],[12484,4,""],[12281,0,"> Note: "],[12289,11,""],[12289,0,"S"],[12289,90,""],[12398,0," Some of these performance improvements come from the fact I'm also not using immutablejs. "],[12399,58,""],[12430,1,""],[12430,0," here"],[12434,1,""],[12433,1,""],[12432,1,""],[12431,1,""],[12430,1,""],[12429,1,""],[12429,0," here - which will also make a big performane "],[12474,1,""],[12473,1,""],[12473,0,"ce difference."],[12443,4,""],[12443,0,"is"],[12454,1,""],[12454,0,"ing"],[12464,11,""],[12464,0,"performance"],[12446,0,"probably "],[12473,11,""],[12473,0,"impact on performance"],[12494,12,""],[12494,0,"."],[12520,0,"\n"],[12520,0,"\nThis is better, but its still not *fast*."],[12673,0,"\n"],[12563,1,""],[12672,0,"\nThis is better, but its still not *fast*."],[12521,42,""],[12566,0," / abstraction"],[12525,0,"that "],[12546,6,""],[12546,0,"correct "],[12564,12,""],[12575,22,""],[12575,0,","],[12575,1,""],[12575,0," its time to "],[12588,12,""],[12587,1,""],[12591,0," our"],[12594,1,""],[12593,1,""],[12592,1,""],[12591,1,""],[12521,10,""],[12521,0,"W"],[12567,0,", "],[12568,1,""],[12567,1,""],[12566,1,""],[12566,0,", but the implementation iss"],[12593,1,""],[12593,0," still not *fast*. "],[12612,1,""],[12612,0,"I"],[12631,0," big"],[12656,1,""],[12656,0,"."],[12657,43,""],[12656,1,""],[12656,0,":"],[12692,0,","],[12648,8,""],[12648,0,"bottlenecks in this algorithm"],[12757,4,""],[12757,0,"W"],[12861,5,""],[13177,6,""],[13177,0,"I"],[13282,6,""],[13427,1,""],[13427,0,". We also need to figureout "],[13454,1,""],[13453,1,""],[13452,1,""],[13451,1,""],[13450,1,""],[13450,0," "],[13450,1,""],[13450,0,"e out the parent of thi"],[13472,1,""],[13472,0,"e new item."],[13483,41,""],[13445,0,"take a look at nearby operations to "],[13523,0,"th"],[13524,1,""],[13523,1,""],[13523,0," the user"],[13532,5,""],[13539,0,"s"],[13640,1,""],[13640,0,"."],[13687,7,""],[13687,0,"t"],[13684,4,""],[13684,0,"the cod d"],[13692,1,""],[13691,1,""],[13691,0,"e does this"],[13866,0," *after* the new item"],[13906,0," in the array"],[13965,6,""],[13964,1,""],[13963,1,""],[13963,0,"\n\n> T"],[13967,1,""],[13966,1,""],[13965,1,""],[13964,1,""],[13963,1,""],[13963,0," (I'm "],[13965,0,"Well, "],[13983,11,""],[13983,0," v8"],[13985,1,""],[13984,1,""],[13984,0,"V8"],[13986,9,""],[14012,13,""],[14012,0,"here"],[14016,1,""],[14016,0,"."],[14018,5,""],[14018,0,"W"],[13953,9,""],[13953,0,"its still probably slow when we're moving thousands of items"],[14016,6,""],[14016,0,"Well, "],[14016,4,""],[14016,0,"Aside:"],[14022,1,""],[14035,0," here that"],[14073,5,""],[14075,0,"u"],[14075,1,""],[14075,0,"gut"],[14077,1,""],[14076,1,""],[14075,1,""],[14075,0,"But "],[14079,1,""],[14079,0,"w"],[14116,5,""],[14116,0,"in th"],[14120,1,""],[14119,1,""],[14119,0,"th"],[14118,3,""],[14116,2,""],[14116,0,"there"],[13995,9,""],[13995,0,"a"],[13995,1,""],[13995,0,"so many"],[14002,3,""],[13938,9,""],[13938,0," in native code"],[14148,0," in"],[14126,25,""],[14126,0,"Every time we insert into a document with n items"],[14201,53,""],[14201,0,"n steps of work"],[14168,0,"*"],[14170,0,"*"],[14203,0,"*"],[14205,0,"*"],[14212,8,""],[14221,21,""],[14221,0,"ee"],[14222,1,""],[14222,0,"very time we insert into a document where there have"],[14287,0,"*n* items "],[14312,0," - d"],[14315,1,""],[14314,1,""],[14313,1,""],[14312,1,""],[14312,0,". D"],[14314,1,""],[14313,1,""],[14312,1,""],[14312,0,", because deleted items are never really removed"],[14366,0," algorithm"],[14422,1,""],[14422,0," "],[14124,0,"\n\nInsert "],[14132,1,""],[14132,0,"ing an item will tak"],[14144,8,""],[14144,0,"into a document"],[14159,38,""],[14174,35,""],[14174,0," "],[14174,1,""],[14174,0,", the computer does about *n* steps"],[14174,25,""],[14174,0," will take"],[14196,5,""],[14196,0,"Nope, its worse than that."],[14222,15,""],[14223,1,""],[14223,0,"I"],[14229,0,"ing"],[14276,1,""],[14266,1,""],[14266,0,"*"],[14276,0,"*"],[14287,16,""],[14221,0," beau"],[14225,1,""],[14224,1,""],[14224,0,"cause deleted items aren't really removed"],[14331,48,""],[14331,0," will take n steps"],[14342,0,"*"],[14344,0,"*"],[14414,0,"In Big-O notation, "],[14433,1,""],[14433,0,"i"],[14466,0,"*"],[14473,0,"*"],[14443,0,"*"],[14445,0,"*"],[14477,0,"\n"],[14498,0,"\n"],[14498,0,"\nCan we fix this? Yes we can!"],[14529,0,"We need t"],[14537,1,""],[14529,8,""],[14962,0,", without sliding "],[14972,8,""],[14972,0,"copying all the existing items around"],[15009,7,""],[15009,0,"."],[15011,1,""],[15011,0,"W"],[15067,0," - because linked lists allow inser"],[15091,11,""],[15091,0,"c"],[15091,1,""],[15091,0,"allow inserts in the middle in O(1) time"],[15134,0,"Well, "],[15140,1,""],[15140,0,"i"],[15132,79,""],[15137,0," adds"],[15142,4,""],[15180,18,""],[15180,0,"thing"],[15800,18,""],[15800,0,"Aaah "],[15805,1,""],[15805,0,"f"],[15895,0,". Coll"],[15897,4,""],[15897,0,"We can only collapse runs of items "],[15932,18,""],[15931,1,""],[15951,8,""],[15937,14,""],[15937,0,"the iD"],[15942,1,""],[15941,1,""],[15941,0,"IDs and parents are sequential"],[15976,0," the code"],[15985,6,""],[15990,0,"s"],[15996,0," tricky"],[16003,8,""],[16034,0,"again "],[16066,10,""],[16082,4,""],[16082,0," a"],[16084,9,""],[16095,26,""],[16094,1,""],[16094,0,"t "],[16096,2,""],[16130,5,""],[16130,0,"entries"],[16096,0,"for this editing trace, "],[16096,24,""],[16096,0,"in Martin's editing trace, "],[15885,10,""],[15885,0," into a single item"],[15853,0,"Note "],[15858,1,""],[15858,0,"w"],[15860,0," unfortunately"],[15946,13,""],[15946,0,"inserts"],[15978,4,""],[15978,0," line up"],[15979,7,""],[15979,0,"are"],[15979,3,""],[15979,0,"line up"],[15997,0,"ly"],[16001,5,""],[16001,0,"T"],[16009,0," also"],[16026,6,""],[16025,1,""],[16001,33,""],[16001,0,"We'll also sometimes need to"],[16068,6,""],[16093,0," one of our"],[16104,2,""],[16115,26,""],[16115,0," in Martin's editing trace"],[16115,26,""],[16115,0,", with this benchmark data"],[16233,29,""],[16233,0,"How fast is it now? Yjs"],[16256,10,""],[16270,0," than the reference-crdts implementation, and it only "],[16324,16,""],[16324,0,"uses"],[16743,0," and confused"],[16748,8,""],[16748,0,"b"],[16748,1,""],[16748,0,"b"],[16748,1,""],[16748,0,"confused"],[16747,9,""],[16743,4,""],[16785,4,""],[16785,0," some"],[16790,9,""],[16811,0," is"],[16819,1,""],[16818,1,""],[16818,0,"ing"],[16869,42,""],[16869,0,"Leaving "],[16876,1,""],[16869,7,""],[16869,0,"Everything is faster in Rust, with B-Trees"],[16869,42,""],[16869,0,"Its"],[16869,3,""],[16869,0,"Everything is faster in Rust, with B-Trees"],[16869,42,""],[16869,0,"Javascript"],[16869,10,""],[16869,0,"Faster than Javascript"],[16893,22,""],[16970,1,""],[16970,0,", and"],[16976,1,""],[16976,0,"i"],[16936,36,""],[16893,0,"Yjs is very well optimized already, and I doub"],[16935,4,""],[16935,0,"suspect "],[16943,1,""],[16943,0,"j"],[16954,5,""],[16954,0,"can't"],[16942,0," we can't make"],[16967,9,""],[16967,0," run"],[16984,9,""],[16984,0,"in this test"],[16998,5,""],[16998,0,"I"],[16997,1,""],[16997,0,"\n\n"],[16998,1,""],[16997,1,""],[16997,0," "],[17081,1,""],[17081,0," w"],[17082,1,""],[17082,0,"- which we can only do"],[17053,51,""],[17053,0,"more control over the memory layout - which we can only do in a lower"],[17117,5,""],[17117,0,"sst"],[17119,1,""],[17118,1,""],[17118,0,"ystems "],[17104,5,""],[17120,0,"language like Rust."],[17320,0," in memory"],[17344,0,"By the way, "],[17357,1,""],[17357,0,"y"],[17385,0,"Its "],[17388,1,""],[17387,1,""],[17386,1,""],[17385,1,""],[17385,0,"Its terrible because "],[17406,1,""],[17406,0,"a"],[17422,0,"fragmented - "],[17434,1,""],[17433,1,""],[17432,1,""],[17432,0,". Its all "],[17468,30,""],[17468,0," arrange data like this"],[17528,0," for each item"],[17529,0,"one by one "],[17605,5,""],[17611,0,"all of those "],[17624,14,""],[17624,0,"objects"],[17602,0,"extra data "],[17674,12,""],[17674,0,"ll "],[17699,1,""],[17699,0,"."],[17700,6,""],[17700,0," I"],[17723,0," in memory"],[17699,1,""],[17699,0,", and"],[17705,1,""],[17705,0,"i"],[17699,38,""],[17801,5,""],[17806,0," as well"],[17816,2,""],[17816,0,"If we"],[17821,4,""],[17858,26,""],[17904,1,""],[17904,0,","],[17906,19,""],[17905,1,""],[17930,0," about"],[17949,1,""],[17949,0," -"],[17950,1,""],[17949,1,""],[17949,0,"- "],[17969,1,""],[17971,0,"At t"],[17974,1,""],[17973,1,""],[17972,1,""],[17972,0,"nd at this speed, "],[17990,4,""],[18016,17,""],[18016,0," takes the computer"],[17971,0,"In comps"],[17978,1,""],[17978,0,"arons"],[17982,1,""],[17981,1,""],[17980,1,""],[17980,0,"ison, "],[17986,4,""],[17999,1,""],[18094,5,""],[18103,6,""],[18102,1,""],[18107,1,""],[18106,1,""],[18105,1,""],[18105,0,"iting"],[18168,0," shopping "],[18177,1,""],[18056,1,""],[18056,0,"\n\n"],[18127,1,""],[18127,0,"."],[18129,1,""],[18129,0,"B"],[18223,14,""],[18229,5,""],[18229,0," item in the scavenger hunt names"],[18262,6,""],[18289,33,""],[18288,1,""],[18287,1,""],[18286,1,""],[18286,0,", with a hiddne"],[18300,1,""],[18299,1,""],[18299,0,"en"],[18301,5,""],[18333,0,"or whatever "],[18351,41,""],[18351,0," "],[18351,1,""],[18351,0,"\n\nReading the whole list would take ages."],[18352,1,""],[18351,1,""],[18350,1,""],[18350,0," "],[18350,1,""],[18350,0,". Needless to say, "],[18369,1,""],[18369,0,"r"],[18391,0," takes the computer"],[18410,11,""],[18416,0," ("],[18417,1,""],[18416,1,""],[18415,1,""],[18415,0," (in computer time)."],[18675,0,"linked li"],[18665,19,""],[18665,0,"F"],[18665,1,""],[18665,0,"With linked lists "],[18688,2,""],[18688,0," that"],[18743,18,""],[18727,16,""],[18727,0,"between items, and we do that a lot"],[18740,22,""],[18777,12,""],[18777,0,"F"],[18812,0," need a lot of objects, "],[18836,27,""],[18835,1,""],[18835,0," so"],[18838,4,""],[18838,0," we"],[18834,1,""],[18834,0,". So there's"],[18836,10,""],[18826,0," weird"],[18840,1,""],[18840,0,", which willen"],[18853,1,""],[18852,1,""],[18852,0," end up"],[18859,32,""],[18840,0," (like fixed size ara"],[18860,1,""],[18860,0,"rays)"],[18865,1,""],[18865,0,". These"],[18867,5,""],[18867,0,"In javascript"],[18880,11,""],[18880,0," "],[18867,14,""],[18867,0,"And that makes fragmentation worse, even as we're making the "],[18903,25,""],[18902,1,""],[18901,1,""],[18901,0,". Its a "],[18902,45,""],[18902,0," "],[18901,0,", which makes"],[18909,5,""],[18909,0,"can make things slow, "],[18930,1,""],[18929,1,""],[18929,0,"er, not faster"],[18999,0,"even "],[19004,49,""],[19014,0," we don't have to use javascript any more"],[18986,1,""],[18985,1,""],[18985,0," "],[18496,10,""],[18496,0,"I want to"],[18534,1,""],[18533,1,""],[18533,0,"."],[18535,1,""],[18535,0,"A"],[18639,6,""],[18655,79,""],[18655,0," (With linked lists we do that scavenger hunt each time we move between items!)"],[18675,25,""],[18675,0,"you incur a memory read"],[18708,3,""],[18708,0," you"],[18858,3,""],[18858,0,"All those extra objects"],[18881,5,""],[18909,0,"so the result is often"],[18931,21,""],[18952,0,"This is "],[18960,3,""],[18959,1,""],[19000,8,""],[19067,11,""],[19067,0,"WebAssembly"],[19081,2,""],[19081,0,"To see how fast we can *really* go,"],[19268,0,"the "],[19275,0," implemen"],[19276,8,""],[19275,1,""],[19272,0,"previous "],[19272,9,""],[19268,4,""],[19241,30,""],[19241,0,"works the same as yjs"],[19262,1,""],[19262,0,","],[19264,1,""],[19264,0,"b"],[19309,0," internally"],[19740,9,""],[19740,0,"any item."],[19784,4,""],[19784,0,". Updates"],[19793,1,""],[19798,1,""],[19810,0,"so again"],[19818,8,""],[19832,0," and we're done"],[19889,0,"\n"],[19889,0,"\nWhen we"],[19890,7,""],[19890,0,"It doesn't compe"],[19905,1,""],[19904,1,""],[19904,0,"e into play here, but when merging remote edits we also need to find items by their ID ("],[19992,71,""],[20009,0," My rust implementation has an index to make this fast, too."],[20071,39,""],[20071,0,"I'm not using"],[20125,0," - which might make it "],[20128,20,""],[20128,0,"at least not yet"],[20148,0,"just "],[20166,10,""],[20166,0," it."],[20146,0,"Mayb eit w"],[20155,1,""],[20154,1,""],[20153,1,""],[20152,1,""],[20151,1,""],[20150,1,""],[20150,0,"e it would help? "],[20168,5,""],[20192,45,""],[20192,0," avoids "],[20199,1,""],[20192,7,""],[20192,0," lets us pack all the items tightly in memory"],[20192,45,""],[20192,0," gives us total control over the memory lat"],[20234,1,""],[20234,0,"yout, so we can pack everything in tightly"],[20309,0,"a run of "],[20328,28,""],[20328,0," "],[20328,1,""],[20328,0,", all packed"],[20334,6,""],[20334,0,"adjacent in RAM"],[20436,3,""],[20436,0,"Memcpy"],[20442,7,""],[20442,0," is always"],[20483,1,""],[20483,0," - its a few hearb"],[20500,1,""],[20500,0,"t beats. Not a scavenger hunt."],[20486,4,""],[20486,0,"its "],[20513,0,"the "],[20517,2,""],[20531,0," of a main memory lookup"],[20642,6,""],[20642,0,"we can now proces "],[20659,1,""],[20659,0,"s the whole trace in"],[20679,7,""],[20598,12,""],[20598,0,"Driven from "],[20621,7,""],[20621,0,"to"],[20598,25,""],[20598,0,"If we compile this code to"],[20636,0," and drive it from javascript"],[20723,0,"And if we compile it to native code and "],[20763,6,""],[20763,0,"call it"],[20828,0,"*"],[20844,0,"*"],[20845,1,""],[20845,0,":"],[20845,1,""],[20845,0,"."],[21353,0,"I've done "],[21363,8,""],[21377,10,""],[21352,0,"\n"],[21352,0,"\n---"],[21461,0," and I couldn't help myself"],[21490,0,"In this implementation, "],[21541,4,""],[21525,0," text"],[21577,0," The reason is that"],[21597,1,""],[21597,0,"w"],[21842,0," too"],[21772,1,""],[21772,0," don't think it"],[21787,8,""],[21792,0,"s"],[21859,3,""],[21859,0,"m"],[21859,1,""],[21856,3,""],[21856,0,"My"],[21917,28,""],[21917,0,"[i"],[21918,1,""],[21917,1,""],[21917,0,"Btree"],[21917,0,"<"],[21923,0," of {"],[21927,1,""],[21927,0,"[item, item item"],[21938,0,","],[21944,0,", ...]"],[21932,0," span"],[21943,0," span"],[21950,6,""],[21954,1,""],[21954,0,">,"],[16869,0,"Making it "],[16879,1,""],[16879,0,"f"],[21362,0,"\n"],[21362,0,"\nThi"],[21365,1,""],[21364,1,""],[21363,1,""],[21363,0,"This code is faster than using a raw javascript string."],[21388,0,"editing"],[21395,5,""],[21397,0," normal"],[21404,4,""],[21363,0,"Even from webassembly "],[21384,1,""],[21384,0,", "],[21368,4,""],[21368,0,"through"],[21389,1,""],[21389,0,"t"],[21401,0," 3x"],[21426,0," nai"],[21429,1,""],[21429,0,"tive"],[21433,7,""],[21458,0,"\nBut"],[21462,1,""],[21462,0," "],[21552,7,""],[21552,0," sounded"],[21622,5,""],[21622,0,"split out"],[21635,0," document's"],[21660,7,""],[22136,0,"I'm "],[22136,4,""],[21968,0," "],[21968,1,""],[21968,0," Its a \"struct of arrays\" rather than \"array of structs\" approach."],[21968,1,""],[21968,0,"\n\n"],[22037,0,"So "],[22040,1,""],[22040,0,"m"],[22036,1,""],[22035,1,""],[22035,0," "],[22036,4,""],[22036,0,"M"],[22034,1,""],[22034,0,", with"],[22041,1,""],[22041,0,"m"],[22074,1,""],[22074,0,"ing"],[22415,0,"So "],[22418,1,""],[22418,0,"l"],[23120,14,""],[23120,0,". Thats how you implement a CRDT."],[22595,0," Semantics | LAng"],[22611,1,""],[22610,1,""],[22609,1,""],[22609,0,"anguage | Data structure"],[22696,0," ---------"],[22769,0," AM"],[22771,1,""],[22770,1,""],[22770,0,"RGA"],[22836,0,"RGA"],[22838,1,""],[22837,1,""],[22836,1,""],[22836,0," RGA / YATA"],[22910,0," YATA"],[22978,0," (none)"],[23048,0," YATA"],[23116,0," YATA"],[23184,0," YATA"],[22706,0," "],[22634,73,""],[22634,0,"| --------------------------        | ---------- | --------- | ---------"],[22847,0," |"],[22773,0,"        |"],[22606,0," "],[22707,0,"--"],[22708,1,""],[22708,0," | --------"],[22795,0," Javascript"],[22796,10,""],[22796,0,"JS"],[22874,0," JS"],[22945,0,"       | JS"],[22596,23,""],[22595,1,""],[22674,21,""],[22674,0,"---------- | --------"],[22685,10,""],[22684,1,""],[22684,0,"-----|"],[22610,0," |"],[22756,15,""],[22756,0,"T"],[22756,1,""],[22756,0,"Naive-tree     |"],[22761,1,""],[22761,0," "],[22836,15,""],[22836,0,"Array          |"],[22916,15,""],[22916,0,"Linked list    |"],[22996,6,""],[22996,0,"(none)         |"],[23076,4,""],[23013,63,""],[23013,0,"| Rust (Called from JS via WASM)    | 0.20s      | ???       |"],[23002,0,"*"],[22996,0,"*"],[23004,2,""],[23075,0," B-Tree"],[23146,4,""],[23146,0,"B-Tree"],[23216,4,""],[23216,0,"B-Tree"],[23082,0,"         |"],[23162,0," "],[23093,70,""],[23093,0,"| Rust (native)                     | 0.065s     | 2.3 MB    | B-Tree         |"],[23242,0,"         |"],[22946,0,"*"],[22935,0,"*"],[22948,2,""],[23306,0,"\n\n\n"],[28386,64,""],[28386,0,"You can't tell from looking at this method, but insertionsAfter"],[24905,4073,""],[24694,211,""],[23308,0,"\n\n"],[7740,1,""],[9091,1,""],[12498,1,""],[14480,1,""],[14479,1,""],[16861,1,""],[16858,0,"\nBut we"],[16859,6,""],[16859,0,"We"],[16860,1,""],[16859,1,""],[16859,0,"But we can go faster"],[16859,5,""],[16859,0,"W"],[16859,16,""],[17144,0,"\n"],[16897,1,""],[17143,0,"\n## Making it faster than Javascript"],[16861,36,""],[17107,0,"\n"],[16860,1,""],[17106,0,"\n"],[16859,1,""],[16858,0,"\n"],[16858,0,"\nBut can we still go "],[16859,5,""],[16859,0,"C"],[16875,0,"faster?"],[16859,0,"But "],[16863,1,""],[16863,0,"c"],[16859,5,""],[16859,0,"C"],[16859,24,""],[16859,0,"Can we still go faster?"],[16859,270,""],[16859,0,"Can we still go faster? Yjs is very well optimized already, and I suspect we can't make javascript run much faster in this test. If we want to continue to improve performance, we need more control over the memory layout - which we can do in a systems language like Rust."],[17078,51,""],[17078,0,"."],[17085,11,""],[17085,0,"F"],[17043,0,"to go lower level. W"],[17062,1,""],[17061,1,""],[17061,0," We need"],[17069,4,""],[16988,113,""],[16859,129,""],[16859,0,"Can we still go faster? Yjs is very well optimized already, and I suspect we can't make javascript run much faster in this test."],[17016,0,"\nIf we want to continue to improve performance, we need to go lower level. We need control over the memory layout."],[16987,0," But maybe.. just maybe we can be"],[17020,1,""],[17104,6,""],[17104,0,"a "],[17117,0," language, and we need"],[17139,9,""],[17128,0,"so we"],[17133,11,""],[17133,0," can"],[17145,5,""],[17369,12,""],[17370,1,""],[17370,0,"Y"],[17398,3,""],[17398,0,"This is"],[17833,0,"How slow? "],[17681,1,""],[17680,1,""],[17680,0," "],[17831,1,""],[17831,0,"\n\n"],[17841,0," are main memory reads"],[17973,0," would"],[17984,1,""],[18002,8,""],[18002,0,". The omp"],[18010,1,""],[18009,1,""],[18008,1,""],[18008,0,"computer "],[18002,15,""],[18002,0," - about"],[18012,0," human"],[18060,4,""],[18060,0,"every"],[18087,0," wl"],[18089,1,""],[18089,0,"ill"],[18112,0,"almost "],[18128,1,""],[18128,0,"!"],[18131,0,"This is what we do do to"],[18154,1,""],[18154,0,"he "],[18150,7,""],[18150,0,"do"],[18151,1,""],[18150,1,""],[18150,0,"to the computer when it runs javascript. In "],[18194,9,""],[18193,1,""],[18193,0," Arranging"],[18193,1,""],[18190,3,""],[18178,12,""],[18173,5,""],[18170,3,""],[18165,5,""],[18156,9,""],[18152,4,""],[18150,2,""],[18150,0,"do"],[18150,2,""],[18150,0,"do the "],[18156,1,""],[18154,2,""],[18154,0,"o"],[18152,3,""],[18149,3,""],[18146,3,""],[18143,3,""],[18138,5,""],[18135,3,""],[18131,4,""],[18200,1,""],[18200,0,"."],[18129,0," Imagine instead of "],[18130,19,""],[18129,1,""],[18471,13,""],[16471,1,""],[16471,0,":"],[16459,1,""],[16459,0,":"],[22711,1,""],[21019,1,""],[16459,1,""],[12074,1,""],[7609,1,""],[22707,0,":"],[21016,0,":"],[16457,0,":"],[12073,0,":"],[7609,0,":"],[22723,1,""],[21031,1,""],[16471,1,""],[12086,1,""],[7621,1,""],[22719,0,":"],[21028,0,":"],[16469,0,":"],[12085,0,":"],[7621,0,":"],[16727,0,"Honestly "],[16747,0," and a little suspicious of"],[22992,1,""],[21249,1,""],[16653,1,""],[22990,0,"2"],[21248,0,"2"],[16653,0,"2"],[22992,1,""],[21249,1,""],[16653,1,""],[22990,0,"3"],[21248,0,"3"],[16653,0,"3"],[17084,0,"\n\n"],[17085,0,"I "],[17086,1,""],[17085,1,""],[17085,0,"When I told Kevin that h"],[17108,1,""],[17108,0,"I thought I could "],[17085,41,""],[17085,0,"When I told Kevin that I thought I could"],[17056,0,"..."],[17128,0," we "],[17121,11,""],[17121,0,"a good rust impleemntation"],[17133,14,""],[17133,0,"implementation would go faster"],[17121,0,"I could make a"],[17134,1,""],[17160,0," that went "],[17171,10,""],[17177,0," than yjs, he didn't believe me. EH"],[17211,1,""],[17210,1,""],[17210,0,"He said yjs was already so optimized, he"],[17134,11,""],[17134,0,"CRDT"],[17134,0,"a "],[17160,5,""],[17160,0," goes"],[17244,1,""],[17243,1,""],[17243,0,"he doubted i"],[17254,1,""],[17253,1,""],[17243,10,""],[17243,0,"there wasn't much "],[17243,18,""],[17243,0,"going even faster was going to be basically impossible."],[17264,0,"n't"],[17280,20,""],[17280,0,"possibe"],[17286,1,""],[17286,0,"l"],[17286,1,""],[17286,0,"le"],[17160,5,""],[17160,0,"s"],[17228,0,"well "],[17261,0," probably"],[17277,12,""],[17287,0,"\n\nBut I knew about"],[17300,5,""],[17300,0,"something he dd"],[17314,1,""],[17314,0,"idn't: The way the computer organizes memory and memory lookups"],[17321,0,"U"],[17321,1,""],[17321,0,"We can use rust to "],[17321,18,""],[17321,0,"If we can control"],[17338,8,""],[17342,0," way the"],[17321,74,""],[17289,32,""],[17289,0,"But I knew something he didn't:"],[17287,0," \"Maybe a little faster... but not a lot faster!\""],[17310,0," in "],[17313,1,""],[17312,1,""],[17312,0,"f you just port it to rust"],[17338,2,""],[17338,0,"."],[17338,1,""],[17334,1,""],[17334,0,"R"],[17340,1,""],[17340,0,"B"],[17162,0,"way "],[17165,1,""],[17165,0," "],[17348,4,""],[17348,0,"it won't go "],[17374,0,"."],[17374,1,""],[17397,2,""],[17397,0,"Kevin"],[17409,0," know"],[17415,0," I knew about memory fragmentation c"],[17450,1,""],[17450,0,"and cache coherent structures."],[17347,12,""],[17347,0," not"],[17213,1,""],[17213,0,"Y"],[17258,0," a little bit"],[17253,18,""],[17253,0," a lot"],[17367,0," V"],[17368,1,""],[17367,1,""],[17366,0," V8 is really fast these days!"],[17405,4,""],[17405,0,"know"],[17405,4,""],[17405,0,"knew"],[17490,1,""],[17490,0,"cy"],[17492,11,""],[17509,31,""],[17509,0,"keep making yjs"],[17520,4,""],[17520,0," our algorithms "],[17493,54,""],[17493,0," Rust isn't just *faster*. It "],[17522,1,""],[17522,0,"s also"],[17551,21,""],[17551,0,"and that gives us the tools we need to control allocations and the"],[17614,3,""],[17613,1,""],[16893,0," Apparently some parts of yjs have been rewritten about 11 tives"],[16956,1,""],[16955,1,""],[16954,1,""],[16954,0,"mes in order to make it go that fast"],[16977,13,""],[16977,0," work so well. "],[16991,1,""],[16991,0," ITs super"],[16992,9,""],[16992,0,"Its super impressive!"],[16923,9,""],[16923,0,"were"],[16923,4,""],[16923,0,"have been"],[16950,1,""],[16950,0,"2"],[16991,22,""],[16990,1,""],[16990,0,"!"],[16993,0,"But "],[16997,1,""],[16997,0,"c"],[16993,5,""],[16993,0,"C"],[17017,40,""],[16993,0,"But "],[16997,1,""],[16997,0,"c"],[17019,0," anyway"],[17028,0,"Honestly "],[17039,21,""],[17039,0,"doubt I can mae"],[17053,1,""],[17053,0,"ke"],[17071,14,""],[17070,1,""],[17080,0," any faster than Kevin did"],[17039,5,""],[17038,1,""],[17038,0,"'m nervous about running"],[17054,8,""],[17048,6,""],[17040,8,""],[17038,2,""],[17038,0," doubt"],[17056,0,"pure "],[17165,0,"Pure "],[17165,5,""],[17484,0,"!"],[17718,0,"\n\n(I k"],[17723,1,""],[17723,0,"sway"],[17726,1,""],[17725,1,""],[17724,1,""],[17724,0,"ay *n"],[17728,1,""],[17728,0,"knew"],[17731,1,""],[17731,0,"w* because Kevin h"],[17748,1,""],[17748,0,"is copying me right back, and ork"],[17780,1,""],[17779,1,""],[17778,1,""],[17778,0,"working on "],[17723,11,""],[17723,0,"use the past tense here "],[17802,0,"[Yrs](https://github.com/yjs/y-crdt) - a rust port"],[17841,2,""],[17841,0,"his own "],[17858,0," of Yjs that "],[17870,1,""],[17869,1,""],[17868,1,""],[17868,0,"at "],[17870,1,""],[17869,1,""],[17868,1,""],[17867,1,""],[17866,1,""],[17865,1,""],[17865,0,"!)"],[17720,0,"> "],[17722,1,""],[17867,1,""],[18072,0,"Bad news: "],[18456,7,""],[18456,0,"will often"],[18471,1,""],[18746,16,""],[18746,0,"A"],[18811,7,""],[18811,0," close to"],[18831,0,"\n\n> Interactive vis showing 100 seconds vs 0.5 seconds"],[18886,0,"\n"],[18886,0,"\nIts the difference between reading a piece of paper, and reading a piece of paper witha sca"],[18977,1,""],[18976,1,""],[18975,1,""],[18974,1,""],[18973,1,""],[18973,0," location in your house. Then you have to go there, search around and *then* you find a pi"],[19044,19,""],[19044,0,"there"],[19048,1,""],[19047,1,""],[19046,1,""],[19045,1,""],[19044,1,""],[19043,1,""],[19043,0,"there you find another"],[18923,0," note on a"],[18964,0,"scavenger hunt"],[18978,14,""],[18983,0," a"],[19009,7,""],[19009,0," Y"],[19065,0,"*"],[19073,0,"* piece of paper with the actual note on it."],[18886,231,""],[18885,1,""],[18956,5,""],[18956,0,", only"],[18974,0,"\"Cheese, Milk, Bread\", "],[18997,20,""],[18996,1,""],[19015,25,""],[19015,0," has"],[19018,1,""],[19017,1,""],[19016,1,""],[19016,0,"lists a series of"],[19048,0,"s"],[19061,28,""],[19084,1,""],[19084,0," - and only when you search around there will you find"],[19138,5,""],[19153,6,""],[19153,0,"which actually says you need"],[19188,30,""],[19236,5,""],[19237,3,""],[19251,0," ages"],[19312,0," so our data is all together in memory"],[19315,12,""],[19315,0," its"],[19344,3,""],[19343,1,""],[19345,0," also"],[19343,0,"\n\n\n"],[19343,0," This is why linked"],[19344,18,""],[19344,0,"There's a reason why alno"],[19368,1,""],[19367,1,""],[19367,0,"most nobody uses linked lists"],[18596,8,""],[18596,0,"everything t"],[18607,1,""],[18607,0,"your computer does"],[18625,8,""],[19029,5,""],[19029,0,"is"],[19066,4,""],[19066,0,"thin "],[19070,1,""],[19070,0,"g you need to buy"],[19061,22,""],[19061,0,"The name"],[19061,36,""],[19061,0,"Each item on your shopping list names somewhere in your house"],[19122,6,""],[19122,0,"."],[19124,1,""],[19124,0,"Y"],[19124,1,""],[19124,0,"O"],[19215,1,""],[19219,1,""],[19215,1,""],[19215,0,"m"],[19267,15,""],[19267,0,"you"],[19269,1,""],[19268,1,""],[19267,1,""],[19266,1,""],[19271,0," for your computer)"],[19272,0,"("],[19273,17,""],[19273,0,"relatively speaking"],[19293,0," ages"],[19297,1,""],[19296,1,""],[19295,1,""],[19294,1,""],[19293,1,""],[19353,7,""],[19353,0,"thecompu"],[19360,1,""],[19359,1,""],[19358,1,""],[19357,1,""],[19356,1,""],[19356,0," computer can fetch it all in one go"],[19392,19,""],[19446,0," and this is u"],[19459,1,""],[19459,0,"it - memory fragmentation su"],[19486,1,""],[19485,1,""],[19485,0,"ruins performance in the real world."],[19415,19,""],[19427,0," are almost never used in the real world"],[19523,18,""],[19526,2,""],[19568,24,""],[19568,0," because"],[19674,78,""],[19658,0,"those "],[19525,1,""],[19524,1,""],[19524,0," "],[19714,0,"The problem with "],[19731,1,""],[19731,0,"f"],[19767,0,"is that you end up "],[19790,0,"ing"],[19871,1,""],[19896,19,""],[19896,0,"as a result your programs often end up running"],[19949,12,""],[19949,0," anyway"],[19908,0,"of all that work "],[20018,0,", and why it han"],[20033,1,""],[20033,0,"sn't gotten faster in"],[20037,17,""],[20037,0," really gotten any faster"],[20502,0," And at l"],[20510,1,""],[20510,0,"each leaf, ew "],[20523,1,""],[20522,1,""],[20521,1,""],[20521,0,"we store 32 spans of inserts (!)"],[20549,0,", a"],[20551,1,""],[20550,1,""],[20549,1,""],[20530,0,"a chunk of "],[20560,0,", all congi"],[20570,1,""],[20569,1,""],[20569,0,"tiguous in memory"],[20587,1,""],[20586,1,""],[20587,1,""],[20543,9,""],[20550,1,""],[20550,0," spans"],[20872,0,"about "],[20972,0," after"],[21208,0," "],[21208,1,""],[21208,0," also"],[21212,1,""],[21211,1,""],[21210,1,""],[21209,1,""],[21208,1,""],[20502,81,""],[21357,32,""],[21357,0,"I'm storing an inline array"],[21384,4,""],[21398,0," in each leaf node"],[21379,0,"packed "],[21423,21,""],[21445,1,""],[21449,6,""],[21449,0," result in"],[21586,0,"Its "],[21590,1,""],[21590,0,"n"],[21584,0," per word"],[21595,4,""],[21594,1,""],[21593,1,""],[21593,0,", as opposed to "],[21609,4,""],[21567,26,""],[21567,0,"a few bytes per heartbeat"],[21611,0," epic "],[21616,1,""],[21946,0," Thats 4400"],[21956,1,""],[21955,1,""],[21954,1,""],[21954,0,"500x faster than the"],[21971,3,""],[21971,0,"where we started with automerge."],[22002,1,""],[22002,0,", or about 4.3 million p"],[22025,1,""],[22025,0,"operations every second."],[22003,1,""],[22002,1,""],[22002,0,". It can process"],[22018,2,""],[22019,6,""],[22023,0,"*"],[22031,0,"*"],[22376,0,"*"],[22388,0,"*"],[22389,2,""],[22660,511,""],[25386,0,"\nBut I've done one last thing. I don't know if its a good idea, but I did it anyway because it sounded clever and I couldn't help myself. In this implementation, I split out the document's text content into a separate data structure. The reason is that when you're actually doing collaborative editing, you probably want all the characters in your document to be stored in an actual array, or in VS Code's editor or something. I don't think it makes sense to duplicate the document's content in my library too.\n\n"],[22659,0,"\nThis implementation uses a"],[22686,6,""],[22705,0," approach"],[22754,0," for the string content."],[22778,9,""],[22778,0," The complete"],[22783,8,""],[22783,0,"whole"],[22783,5,""],[22782,1,""],[22808,8,""],[22808,0," looks"],[22852,9,""],[22852,0,"{}"],[22853,0,"id, parent, ..."],[22855,0," len"],[22858,1,""],[22857,1,""],[22856,1,""],[22855,1,""],[22855,0,", length"],[22871,5,""],[22874,9,""],[22874,0,"{id, length, parent}"],[22967,0,"\n"],[22967,0,"\nAll the tet"],[22978,1,""],[22978,0,"xt content itslef"],[22994,1,""],[22993,1,""],[22992,1,""],[22992,0,"elf is pulled out into a rope library "],[23029,1,""],[23029,0,". (Smart"],[23032,5,""],[23032,0,"Ropes are smart strings)"],[23055,0,". Get it?"],[23041,6,""],[23041,0," fancy"],[23065,2,""],[23065,0,". "],[23087,0," here"],[23147,1,""],[23146,1,""],[23146,0,", work"],[23151,1,""],[23150,1,""],[23149,1,""],[23149,0,"hich works great"],[23165,15,""],[23197,0," so fast that"],[23210,12,""],[23216,0," "],[23216,1,""],[23216,0," is actually dominating"],[23211,28,""],[23211,0,"most of the algorithm's time is spent in ropey"],[23249,0,"updating things "],[23274,97,""],[23275,1,""],[23275,0,"W"],[23307,4,""],[23307,0,"ropey"],[23275,0,"Its not "],[23275,8,""],[24101,0," 11 million operations / e"],[24126,1,""],[24126,0,"second."],[24138,1,""],[24138,0,", my friends, is"],[24182,0,"\n# Conco"],[24189,1,""],[24189,0,"liution"],[24195,1,""],[24194,1,""],[24193,1,""],[24192,1,""],[24191,1,""],[24190,1,""],[24190,0,"usion\n\nI'm really g"],[24201,8,""],[24201,0,"kind of grateful for that paper now. I'"],[24239,1,""],[24238,1,""],[24237,1,""],[24237,0," I mean, you don't lik"],[24237,22,""],[24227,0,"silly academic "],[24252,0," I used to think that academics were really clever, but it turns out there'"],[24326,1,""],[24325,1,""],[24324,1,""],[24324,0,"y're just like the rest of us."],[24334,0,"as myopic and obsessive as "],[24361,8,""],[24360,1,""],[24360,0," the"],[24376,0," (I'm no"],[24383,1,""],[24382,1,""],[24381,1,""],[24380,1,""],[24379,1,""],[24378,1,""],[24378,0,"Well not me - "],[24321,71,""],[24321,0,"that"],[24308,17,""],[24308,0,"apparenyl"],[24316,1,""],[24315,1,""],[24315,0,"tly being good at writing papers is a "],[24197,156,""],[24197,0,"I'm kind of grateful for that silly academic paper now. I used to think that academics were really clever, but apparently being good at writing papers is a"],[24100,0," than automerge"],[24317,50,""],[24317,0," (and maybe I'm not that"],[24333,0,"just "],[24342,4,""],[24342,0,"smart enough)"],[24354,0,"!"],[24356,0,"."],[24354,1,""],[24355,1,""],[24355,0,"!"],[24331,23,""],[24331,0,"ll just enver be"],[24339,8,""],[24339,0,"never be that smart"],[24360,0," Now I know that "],[24212,165,""],[24212,0,"I'm kind of grateful for that silly academic paper now. I used to think that academics were really clever (and maybe I'll just never be that smart)! Now I know that"],[24361,15,""],[24361,0,"But I'm starting to realise that t"],[24394,1,""],[24394,0,"they're just a "],[24408,1,""],[24408,0,"s "],[24407,3,""],[24407,0,"like the rest of us - obsessed "],[24427,1,""],[24426,1,""],[24426,0,". They're smart in one domain, and kinf "],[24465,1,""],[24464,1,""],[24464,0,"d of"],[24468,10,""],[24468,0," terrible"],[24299,18,""],[24299,0,"must be the smartest people around"],[24381,29,""],[24388,0," reaj"],[24392,1,""],[24392,0,"lly"],[24430,5,""],[24430,0,"great at"],[24438,3,""],[24442,7,""],[24442,0," obsession"],[24420,0," mugs"],[24443,0," theri"],[24448,1,""],[24447,1,""],[24447,0,"ir"],[24454,9,""],[24454,0,"special interest area"],[24497,0," everywhere else.\n\nInventing a CRDT al"],[24534,1,""],[24533,1,""],[24526,0,"the semantics for concurrent editing is really hard "],[24566,11,""],[24565,1,""],[24564,1,""],[24563,1,""],[24563,0,"sounds"],[24563,6,""],[24544,0,"per"],[24546,1,""],[24546,0,"er-to-peer "],[24576,0,"sounds terrifying"],[24516,85,""],[24516,0,"Inventing the semantics for peer-to-peer concurrent editing sounds terrifying a CRDT"],[24424,1,""],[24423,1,""],[24422,1,""],[24421,1,""],[24420,1,""],[24444,4,""],[24535,56,""],[24535,0,"a CRDT"],[24507,0,"I wasn't smart enough "],[24528,0," to figure out the semantics for "],[24561,29,""],[24507,0,"I really wa"],[24517,1,""],[24517,0,"anted list cRD"],[24530,1,""],[24529,1,""],[24528,1,""],[24528,0,"CRDTs "],[24507,9,""],[24507,0,"We really needed a "],[24526,7,""],[24535,1,""],[24535,0," "],[24284,5,""],[24293,5,""],[24293,0," were"],[24298,3,""],[24528,0,"on Wave"],[24528,7,""],[24527,1,""],[24499,0,"Google wave, all those years ago "],[24531,1,""],[24531,0,", really wa"],[24541,1,""],[24540,1,""],[24540,0,"needed"],[24546,16,""],[24548,0," high performance"],[24575,0,". I wasn't "],[24586,61,""],[24586,0,"smart enough to invent one"],[24577,0,"I li"],[24580,1,""],[24579,1,""],[24579,0,"think pretty highly of myself, but "],[24649,0," back then. "],[24660,1,""],[24660,0," So "],[24660,0," And because the academics didn't make CRDTs fast, I assumed nobd"],[24724,1,""],[24724,0,"ody could. "],[24734,5,""],[24734,0," I might"],[24735,0,"But, "],[24739,1,""],[24738,1,""],[24738,0," "],[24746,0," not me "],[24753,1,""],[24752,1,""],[24751,1,""],[24751,0,"be clever enough to in"],[24577,37,""],[24577,0,"And "],[24616,10,""],[24580,0," back then"],[24628,0,"I assumed that"],[24642,3,""],[24651,3,""],[24650,1,""],[24661,0,"couldn't "],[24670,7,""],[24674,0," their"],[24686,0," run"],[24697,10,""],[24710,1,""],[24710,0,"\n\n"],[24710,0," That was wrong - I "],[24729,1,""],[24728,1,""],[24728,0,"my forte isn't "],[24499,244,""],[24499,0,"Google wave, all those years ago, really needed a high performance list CRDT. And back then I wasn't smart enough to invent one. I assumed that because academics couldn't make their CRDTs run fast, nobody could. That was wrong - my forte isn't"],[24392,0," mugs"],[24477,8,""],[24477,0,"middling"],[24582,5,""],[24582,0,"B"],[24594,22,""],[24594,0,"didn't manage to"],[24623,0,"When papers like LOGOOT and WOOT came out and their algorithms ran really slowly, "],[24665,3,""],[24665,0,"I was exce"],[24674,1,""],[24674,0,"ited - but"],[24719,1,""],[24719,0,"."],[24744,0,"the "],[24757,0," involved"],[24553,17,""],[24553,0," good quality"],[24577,0," Our federation model was bonkers, and it would b"],[24625,1,""],[24625,0,"have been so simple with  a"],[24651,1,""],[24650,1,""],[24650,0,"a CRDT. But"],[24663,1,""],[24663,0,"b"],[24663,1,""],[24662,1,""],[24662,0,"ba"],[24658,45,""],[24658,0,"So "],[24661,1,""],[24661,0,"w"],[24705,3,""],[24705,0,"got"],[24758,0," And "],[24762,1,""],[24777,0," mea"],[24778,3,""],[24778,0,"meant the a"],[24773,16,""],[24773,0,"the aca"],[24773,7,""],[24773,0,"that was as fast as those algorithms could ever go, "],[24824,1,""],[24832,4,""],[24832,0," if"],[24845,0,"th"],[24846,1,""],[24845,1,""],[24836,0,"the "],[24849,9,""],[24899,1,""],[24899,0,"\n\n"],[24582,0,"wave "],[24582,0,"["],[24604,0,"]https://web.archive.org/web/20130330144116/http://www.waveprotocol.org/federation"],[24605,81,""],[24605,0,"(https://web.archive.org/web/20130330144116/http://www.waveprotocol.org/federation)"],[24604,84,""],[24582,1,""],[24616,0," "],[24616,1,""],[24616,0," and really buggy."],[24634,6,""],[24634,0," I"],[24621,6,""],[24621,0,"it never worked properly"],[24645,6,""],[24774,7,""],[24774,0," so "],[24777,8,""],[24777,0," slow they were unworkable"],[24647,21,""],[24647,0,"The whole thing would have been so much"],[24693,0,"r"],[24701,0," good"],[24713,4,""],[24713,0,"W"],[24578,135,""],[24578,0,"So "],[24581,1,""],[24581,0,"w"],[24578,19,""],[24578,0,"I got excited when"],[24621,16,""],[24597,0,"papers describing "],[24639,0,". But that excitemtn "],[24659,1,""],[24658,1,""],[24657,1,""],[24656,1,""],[24655,1,""],[24655,0,"ment "],[24650,10,""],[24650,0,"excitement turned to dust when I realised how slow and inefficient their algoirth"],[24723,8,""],[24723,0,"algi"],[24726,1,""],[24726,0,"orithms were"],[24738,21,""],[24738,0,". They"],[24777,1,""],[24777,0," - and"],[24783,74,""],[24821,9,""],[24820,1,""],[24819,1,""],[24818,1,""],[24818,0,"m "],[24819,1,""],[24855,0,"."],[24856,17,""],[24856,0," My gift to the world"],[24857,0,"Par t"],[24861,1,""],[24860,1,""],[24860,0,"t of "],[24865,1,""],[24865,0,"m"],[24857,9,""],[24857,0,"M"],[24877,0," isn't"],[24878,5,""],[24878,0,"might not be CRDT"],[24891,0,"inventing new classes of "],[24920,0,". But I do know how to make code run fast. And I was letting down the academics in turn b "],[25009,1,""],[25009,0,"y not showing up and doing my part.\n\n"],[24857,20,""],[24857,0,"I might have no idea how to "],[24885,14,""],[24893,1,""],[24892,1,""],[24891,1,""],[24891,15,""],[24896,0,"s"],[24933,0," really"],[24947,4,""],[24966,21,""],[24966,0,"everyone"],[24966,8,""],[24965,1,""],[24953,0,"quietly "],[24968,0," everyone"],[25018,1,""],[25018,0," in "],[25021,1,""],[25020,1,""],[25019,1,""],[25018,1,""],[25018,0," to m"],[25022,1,""],[25021,1,""],[25020,1,""],[25019,1,""],[25018,1,""],[25018,0," here."],[24222,1,""],[24221,1,""],[24220,1,""],[24219,1,""],[24218,1,""],[24217,1,""],[24216,1,""],[24216,0,"a little bit"],[24582,0," so"],[24584,1,""],[24583,1,""],[24583,0,"So"],[24605,0,"the "],[24615,11,""],[24615,0," for"],[24771,0," just"],[24793,0," I figured"],[24861,4,""],[24861,0,"But I"],[24886,19,""],[24886,0,"not be any good at"],[24911,0,"ing"],[24920,1,""],[24920,0,","],[24922,1,""],[24922,0,"b"],[24956,7,""],[24928,3,""],[24959,0," But I didn't even try to help out"],[24990,0,"those al"],[24997,1,""],[24997,0,"cademics "],[25009,0," and improve "],[25014,8,""],[25014,0,"fix up their algorithms."],[24978,0,"*"],[24982,0,"*"],[24982,1,""],[24978,1,""],[24966,0,"*"],[24982,0,"*"],[25029,10,""],[25029,0,"implementations"],[24520,22,""],[24509,0,"A decade ago "],[24533,7,""],[24566,3,""],[24566,0," So"],[24575,0," really"],[24610,0," the"],[24630,0," CRDTs"],[24773,4,""],[24773,0,"totally"],[24791,0," outside of the lab"],[24882,0," So I "],[24887,1,""],[24886,1,""],[24885,1,""],[24884,1,""],[24884,0,"o I ign'red them"],[24883,17,""],[24883,0,"And I ignored them."],[24970,0," do"],[24999,0," really"],[25061,20,""],[25061,0,"make good"],[25087,0," They were t"],[25098,1,""],[25098,0,"doing their part in this bi"],[25123,2,""],[25123,0,"dance, and I wasn't doing mine"],[25000,6,""],[25000,0,"stupidly"],[25000,8,""],[25000,0,"really"],[25016,0," here, in my own field,"],[25038,1,""],[25087,0," their"],[25093,5,""],[25109,0," work well"],[25186,0,"."],[25187,78,""],[25189,0,"I "],[25190,1,""],[25189,1,""],[25189,0,"I"],[25189,1,""],[25189,0,"I think the idea that everyone has some hiddne"],[25234,1,""],[25233,1,""],[25233,0,"en te"],[25237,1,""],[25237,0,"alent is tosh"],[25246,0,"a bit of "],[25246,9,""],[25250,0,". But I do think we all "],[25189,85,""],[25189,0,"I think the idea that everyone has some hidden talent is tosh. But I do think we all"],[24970,0," am prety"],[24978,1,""],[24978,0,"ty good at"],[24988,15,""],[24992,1,""],[24992,0,"ing"],[25004,7,""],[25011,3,""],[25011,0,"And"],[25036,0,","],[25036,1,""],[25036,0,","],[25082,10,""],[25082,0,"improve their"],[25111,10,""],[25265,0," have different proclivities and interests. We all have different songs to sing"],[25309,35,""],[25309,0,"Each of us a"],[25320,1,""],[25320,0,"has a song to sing over the city. A"],[25354,1,""],[25353,1,""],[25179,0," They figured out the semnatics"],[25201,9,""],[25201,0,"semantics, nut t"],[25216,1,""],[25215,1,""],[25214,1,""],[25213,1,""],[25212,1,""],[25212,0,"bnut t"],[25217,1,""],[25216,1,""],[25215,1,""],[25214,1,""],[25213,1,""],[25213,0,"ut the "],[25219,1,""],[25219,0,"y "],[24904,317,""],[24904,0,"But I was wrong. I might not be any good at inventing CRDTs, but I am pretty good at making code run fast. And here, in my own field, I *didn't even try* to help those academics improve their implementations. They were doing their part in this dance, and I wasn't doing mine. They figured out the semantics, but they"],[24615,0,"["],[24622,0,"](https://hal.inria.fr/inria-00432368/document)"],[24674,0,"["],[24679,0,"](https://hal.inria.fr/inria-00445975/document)"],[24741,0," 12 years ago"],[24996,0,"so "],[25177,46,""],[25213,0," strage"],[25219,1,""],[25218,1,""],[25217,1,""],[25216,1,""],[25216,0,"range"],[24507,0," (Is that a masis"],[24523,1,""],[24522,1,""],[24522,0,"sive"],[22655,3,""],[22655,0,"###"],[22657,1,""],[22657,0," Struct of arrays vs Array of structs"],[22695,0,"\n"],[22695,0,"\nI'm doing a slight of hand here - t"],[22730,1,""],[22729,1,""],[22728,1,""],[22727,1,""],[22727,0,". This implme"],[22739,1,""],[22738,1,""],[22738,0,"ementation isn't"],[22749,5,""],[22749,0,"has another small change - and I'm not sure ifI like"],[22793,8,""],[22793,0,"if I like it.\n\nIn javascript we have this:\n\n```\n{ item: 'hello', isDeleted: false, id: ['seph', 0], seq, parent: null },"],[22841,0,"doc = "],[22840,0,"javascript"],[22854,0,"."],[22854,1,""],[22857,0,"\n"],[22851,6,""],[22851,0,"doc ="],[22857,0,"["],[22857,1,""],[22856,1,""],[22856,0,"{"],[22856,1,""],[22856,0," {\n  content: [\n    "],[22872,0,"    { item: 'hello', isDeleted: false, id: ['seph', 0], seq, parent: null },\n"],[22962,5,""],[22962,0,"world"],[22981,5,""],[22981,0,"true"],[22993,4,""],[22993,0,"mike"],[23017,4,""],[23017,0,"['seph', 0]"],[23031,0,"\n    ...\n    "],[23040,4,""],[23040,0,"  ]\n  "],[23044,2,""],[23044,0,"}\n```\n\nIn rust I'm doing this:"],[22851,20,""],[22851,0,"doc = { content: ["],[22947,4,""],[22947,0,"  "],[22870,4,""],[22870,0,"  "],[23034,5,""],[23034,0,"] }"],[23035,1,""],[23060,0,"the equivalent of "],[23084,0,"\n"],[23084,0,"\n\n```javascript\ndoc = { content: [\n  { item: 'hello', isDeleted: false, id: ['seph', 0], seq, parent: null },\n  { item: 'world', isDeleted: true, id: ['mike', 0], seq, parent: ['seph', 0] },\n    ...\n]}\n```"],[23084,1,""],[23122,13,""],[23122,0,"length: 5"],[23133,18,""],[23175,13,""],[23175,0,"length: -5"],[23187,17,""],[23117,0,"\n  // No string content!"],[23106,1,""],[23106,0,"\n  "],[23258,4,""],[23258,0,"      "],[23197,2,""],[23197,0,"    "],[23144,2,""],[23144,0,"    "],[23120,2,""],[23120,0,"    "],[23264,6,""],[23264,0,"    "],[23271,1,""],[23271,0,"\n    "],[23272,4,""],[23272,0,"  "],[23275,0,"\n  "],[23276,2,""],[23275,0,",\n  \n  "],[23277,2,""],[23280,0,"textContent: 'hello' // Actually in a rope"],[23318,4,""],[23318,0,"Rope, not a string."],[23318,1,""],[23318,0,"r"],[23059,18,""],[23059,0," something l"],[23070,1,""],[23070,0,"more like"],[23108,0,"\n  clients: ['seph', 'mmi"],[23132,1,""],[23131,1,""],[23131,0,"ike'],\n  "],[23138,2,""],[23282,6,""],[23282,0,"0"],[23200,6,""],[23200,0,"0"],[23251,6,""],[23251,0,"1"],[23220,4,""],[23220,0,"[-1, -"],[23225,1,""],[23224,1,""],[23223,1,""],[23223,0,", 0]"],[23225,1,""],[23224,1,""],[23223,1,""],[23223,0,", -1"],[23231,0," // root "],[23232,8,""],[23231,1,""],[23141,7,""],[23141,0,"items"],[23148,0,"RangeTree "],[23322,0,"Rope "],[23334,37,""],[23326,0,"y Rope {"],[23342,0," }"],[23327,1,""],[23148,9,""],[23148,0,"BTree"],[23148,5,""],[23148,0,"RangeTree"],[23158,0,"{"],[23305,0,"}"],[23229,8,""],[23229,0,"NULL"],[23232,1,""],[23231,1,""],[23230,1,""],[23229,1,""],[23229,0,"null"],[23229,4,""],[23229,0,"ROOT"],[23341,0,"\n"],[23304,1,""],[23340,0,"\n  ]},"],[23298,6,""],[23334,0,"\n    ..."],[23290,8,""],[23326,0,"\n    { length: -5, id: [1, 0], seq, parent: [0, 0] },"],[23237,53,""],[23273,0,"\n    { length: 5, id: [0, 0], seq, parent: ROOT },"],[23187,50,""],[23223,0,"\n    // No string content!"],[23187,2,""],[23187,0,"    "],[23161,26,""],[23199,0,"\n  items: RangeTree {["],[23139,22,""],[23177,0,"\n"],[23138,5,""],[23138,0,"  "],[23174,0,","],[23137,0,"\n  "],[23138,2,""],[23137,1,""],[23175,0,"\n  clients: ['seph', 'mike'],"],[23109,29,""],[23146,0,"\n  "],[23147,2,""],[23342,1,""],[23349,0,"\n"],[23350,308,""],[23349,1,""],[23349,0,"\n"],[23349,0,"\nThere's a few tweaks here, but "],[23350,31,""],[23349,1,""],[23349,0,"\nNotice the tet"],[23363,1,""],[23363,0,"xt"],[23350,0,"There's a bunch of small tweaks here, but "],[23393,0,"t"],[23393,1,""],[23392,1,""],[23392,0,"n"],[23407,0," content? Its "],[23420,1,""],[23419,1,""],[23418,1,""],[23418,0," pulled it out into its own structure. The been"],[23464,1,""],[23463,1,""],[23463,0,"nefit "],[23457,12,""],[23457,0,"This is a tradeoff:\n\n- "],[23478,2,""],[23478,0,"-"],[23457,10,""],[23457,0,"Welom"],[23461,1,""],[23460,1,""],[23460,0,"come to "],[23438,7,""],[23438,0,"a separate data"],[23484,0," "],[23476,0,"the land of "],[23496,0,"s"],[23497,1,""],[23488,0,"Engineering "],[23500,1,""],[23500,0,"T"],[23480,1,""],[23480,0,"L"],[23650,43,""],[23650,0,"[Ropey](https://docs.rs/ropey/1.2.0/ropey/)"],[23463,0,"( "],[23464,1,""],[23464,0," "],[23464,1,""],[23463,1,""],[23463,0," ([Ropey](https://docs.rs/ropey/1.2.0/ropey/)"],[23465,0,"U"],[23465,1,""],[23465,0,"using a list"],[23476,1,""],[23475,1,""],[23474,1,""],[23473,1,""],[23472,1,""],[23472,0," rust library calle d"],[23492,1,""],[23491,1,""],[23491,0,"d "],[23536,0,")"],[23536,0,", which i "],[23545,1,""],[23545,0,"s *"],[23547,1,""],[23546,1,""],[23545,1,""],[23544,1,""],[23544,0,"implements *another* b-tree!"],[23623,0," Havin "],[23629,1,""],[23629,0,"g the texxt conte"],[23638,1,""],[23645,0,"nt self contained like this means the "],[23679,4,""],[23679,0,"ropey can do text-specific optimizations"],[23673,0,"allows "],[23680,6,""],[23685,0," to"],[23688,4,""],[23719,0,", like packing all the chara"],[23719,28,""],[23719,0,". So we use less ram.\n- "],[23741,2,""],[23741,0,"-"],[23721,19,""],[23721,0,"The biggest advantage is we use a lot less ram this way."],[23597,0," Uncomfortable"],[23793,0," But inserting into both"],[23798,19,""],[23798,0,"ei"],[23799,1,""],[23798,1,""],[23798,0,"with ech"],[23805,1,""],[23804,1,""],[23804,0,"ach insert we'"],[23817,1,""],[23817,0," need to update 2 data structures. Rop"],[23854,1,""],[23853,1,""],[23852,1,""],[23851,1,""],[23850,1,""],[23850,0," instead of 1, which makes everything more than"],[23871,0,"in this case "],[23910,0," "],[23910,1,""],[23910,0," twice as slow as it could be"],[23861,0," just"],[23875,13,""],[23892,19,""],[23897,0,"er"],[23899,15,""],[23899,0,"\n- "],[23900,2,""],[23900,0,"-"],[23399,3,""],[23399,0,"what I did with the"],[23431,1,""],[23431,0," here."],[23485,1,""],[23484,1,""],[23484,0,", "],[23557,1,""],[23557,0,". Ropey implements"],[23575,17,""],[23594,1,""],[23593,1,""],[23591,0," t"],[23592,1,""],[23591,1,""],[23592,0," "],[23592,1,""],[23592,0," to efficiently manage text inserts"],[23627,1,""],[23627,0,". This isn't a net win."],[23651,10,""],[23651,0,"We have unfortunately arrived at"],[23386,5,""],[23386,0,". But"],[23399,0,"in particular "],[23388,44,""],[23350,38,""],[23350,0,"One big "],[23357,1,""],[23070,10,""],[23070,0,"closer to "],[23350,26,""],[23350,0,"One "],[23353,1,""],[23352,1,""],[23351,1,""],[23350,1,""],[23350,0,"Note"],[23364,2,""],[23364,0,"the text"],[22766,0,", important"],[23361,5,""],[23361,0,"To "],[23363,1,""],[23362,1,""],[23361,1,""],[23379,0,"content "],[23712,10,""],[23792,6,""],[23918,0,"."],[23921,0," And the b"],[23926,5,""],[23926,0,"it doubles the compiled"],[23941,0,"size of the "],[23961,0," binary - with wasm "],[23968,7,""],[23968,0,", which matters on the web. The"],[24005,0,"bundle goes from 60kb to 120kb."],[24012,4,""],[24012,0,"increases"],[24040,1,""],[24040,0," when we depend on Ropey."],[23968,26,""],[24039,0,"\n- But it makes it way a"],[24062,1,""],[24062,0,"faster to read off "],[24042,5,""],[24042,0,"I"],[24044,0," also"],[24040,42,""],[24040,0,"- It also makes it way faster to read off"],[22818,234,""],[28308,0,"\nIn javascript we have this:\n\n```javascript\ndoc = { content: [\n  { item: 'hello', isDeleted: false, id: ['seph', 0], seq, parent: null },\n  { item: 'world', isDeleted: true, id: ['mike', 0], seq, parent: ['seph', 0] },\n    ...\n]}\n```\n"],[22847,9,""],[22847,0,"like "],[22851,1,""],[23122,12,""],[23122,0,"Notice te"],[23130,1,""],[23130,0,"he document's"],[23156,0," is "],[23159,1,""],[23158,1,""],[23157,1,""],[23157,0,"has been pulled"],[23207,0,". I'm"],[23212,1,""],[23212,0," "],[23212,1,""],[23463,47,""],[23463,0,"C"],[23463,1,""],[23463,0,"R"],[23468,0," can"],[23508,26,""],[23508,0,"W"],[23514,0," much"],[23515,4,""],[23514,1,""],[23539,10,""],[23539,0," when "],[23544,1,""],[23551,0,"ing"],[23601,5,""],[23603,1,""],[23603,0,". This"],[23609,6,""],[23637,6,""],[23637,0,"Depending on ropey"],[23676,3,""],[23676,0,"our"],[23741,25,""],[23741,0," - which is"],[23741,11,""],[23744,0,"Ropey "],[23750,8,""],[23781,0," the document's"],[23742,54,""],[23741,1,""],[24535,0,"| *JS baseline*                     | 0.61s      | 0.1 MB    | *(none)*       |\n"],[24618,2,""],[24618,0,"Ropey (rust)"],[24640,10,""],[24655,2,""],[24655,0,"029"],[24660,1,""],[24694,80,""],[24615,0,"| Rust (Called from JS via WASM)    | 0.20s      | ???       | B-Tree         |\n"],[24774,80,""],[24695,0,"| Rust (native)                     | 0.065s     | 2.3 MB    | B-Tree         |\n"],[24828,1,""],[24828,0,"2"],[22675,2,""],[22675,0,"or"],[22694,0,"?"],[23742,0,"."],[23742,1,""],[23744,217,""],[23747,6,""],[23747,0,"CRDT implementation "],[23766,1,""],[23777,0," at this point"],[23902,3,""],[23902,0," and"],[23742,0,"\n- Sometimes we "],[23743,15,""],[23742,1,""],[23742,0,"\n\nI'm still not sure "],[23744,19,""],[23744,0,"I'm still not sure if I like this change."],[23763,22,""],[23763,0,"whether I like this approach."],[23635,0," It also"],[23643,62,""],[23643,0," increases the size of the"],[23670,4,""],[23682,10,""],[23700,0,"."],[23644,9,""],[23644,0,"doubles"],[23537,5,""],[23537,0,"W"],[23695,0,"\n- We sometimes don't need the text content at all - like when"],[23698,59,""],[23698,0,"Most applications"],[23698,17,""],[23698,0,"There's a bunch of use cases where don"],[23735,1,""],[23734,1,""],[23733,1,""],[23733,0,"we don't "],[23696,46,""],[23696,0,"- There's a bunch of use cases where we don't"],[23157,0," doesn't live in the items"],[23178,5,""],[23178,0,"list of items anymore. Now its"],[23208,25,""],[23208,0," in "],[23211,1,""],[23263,0," for this"],[23359,0,"which ca"],[23366,1,""],[23365,1,""],[23364,1,""],[23363,1,""],[23362,1,""],[23361,1,""],[23360,1,""],[23359,1,""],[23358,1,""],[23358,0," "],[23288,34,""],[23288,0,"https://crates.io/crates/ropey"],[23358,12,""],[23339,0,"et "],[23341,1,""],[23340,1,""],[23339,1,""],[23339,0,"yet "],[23339,4,""],[23357,0," efficiently"],[23376,0," the document's"],[23396,8,""],[23396,0," content"],[23583,0," (Ropey only uses 200kb for the "],[23607,8,""],[23607,0,"to store the whole document - its way more efficient than"],[23645,19,""],[23645,0,"tighter than my code!)"],[23641,0,"apparently "],[23583,95,""],[23543,13,""],[23543,0,"packing"],[23543,0,"byte "],[23600,0,"like this "],[23764,10,""],[23764,0,"some"],[23793,0," care about the document's contents."],[23828,0," anyway"],[23753,83,""],[23805,0,"But "],[23809,1,""],[23809,0,"m"],[23967,0,"?"],[23968,12,""],[23968,0," How"],[23978,0,"can "],[24659,1,""],[24659,0,"R"],[24659,1,""],[24659,0,"r"],[24072,4,""],[24072,0,"CRDT"],[24925,0,"\n("],[24926,1,""],[24926,0,"(Why is it slower"],[24931,12,""],[24931,0,"d"],[24931,1,""],[24931,0,"is it slower"],[24937,6,""],[24937,0,"faster to "],[24931,16,""],[24931,0,"don't "],[24927,10,""],[24927,0,"Weird - 29ms + 23ms ! "],[24948,1,""],[24948,0,"= 65ms. I wonder if its "],[24971,1,""],[24971,0," "],[24956,16,""],[24956,0,"We're "],[24926,1,""],[24926,0,"Oh look"],[24933,5,""],[24926,37,""],[24926,0,"Oh look - 29ms + 23ms != 65ms. We're"],[24906,17,""],[24906,0," make the computer do less work"],[24938,0,"\n\nAnd just to "],[24940,12,""],[24939,1,""],[24938,1,""],[24976,0," probably fill"],[24971,19,""],[24971,0,"I "],[24971,2,""],[24971,0,"I'm probably thrashing the cPU c"],[25002,1,""],[25001,1,""],[25000,1,""],[24999,1,""],[24998,1,""],[24998,0,"CPU's cache inserting one character at a time"],[25010,0,"by processing "],[25024,10,""],[25027,10,""],[25027,0," edit"],[24970,72,""],[24970,0," It look"],[24971,7,""],[24971,0,"I can "],[24973,4,""],[24973,0,"smell more"],[24979,4,""],[24979,0,"faster performance "],[24979,19,""],[24979,0,"opppo"],[24983,1,""],[24982,1,""],[24982,0,"ortunities for even more performance."],[24979,27,""],[24979,0,"a batch_update() methods "],[25003,1,""],[25002,1,""],[25002,0," with faster"],[24971,9,""],[24971,0,"It looks like a"],[25009,4,""],[25009,0,"would have even"],[24971,16,""],[24971,0,"I smell a *"],[24996,0,"*"],[25004,0," in my future"],[25017,35,""],[25017,0," with *another* 20"],[25018,17,""],[25018,0,"which can process this trace in 52ms"],[25055,0,"\n"],[25046,0,", rope and all,"],[25272,5,""],[25292,1,""],[25292,0," -"],[25295,8,""],[25317,0,"ty"],[25319,14,""],[25358,19,""],[25380,1,""],[25380,0,"W"],[25385,6,""],[25385,0,"really needed"],[25425,3,""],[25431,6,""],[25431,0,"super"],[25465,0,"CRDTs started to emerge."],[25489,3,""],[25601,0," werea "],[25607,1,""],[25606,1,""],[25606,0," a big deal - and they're"],[25631,15,""],[25644,0," no1"],[25647,1,""],[25647,0,"w!"],[25649,1,""],[25617,31,""],[25602,4,""],[25602,0,"seemd"],[25606,1,""],[25606,0,"ed like"],[25741,0,"ly"],[25773,18,""],[25754,19,""],[25754,0,"pretty uni"],[25763,1,""],[25763,0,"usable for real world editing"],[25793,1,""],[25792,1,""],[25792,0,","],[25792,1,""],[25792,0,". "],[25795,1,""],[25794,1,""],[25794,0,"A"],[25799,0," made a "],[25800,7,""],[25799,1,""],[25799,0," made a big mistake - I"],[25823,7,""],[25823,0,"assumed"],[25887,5,""],[25887,0,"S"],[25924,48,""],[24970,0," The reason"],[24947,0," at those last three rows"],[24988,1,""],[24987,1,""],[24987,0,"is less than"],[24978,1,""],[24977,1,""],[24983,1,""],[24982,1,""],[24999,1,""],[24998,1,""],[24983,12,""],[24983,0,"<"],[24973,1,""],[24972,1,""],[24972,0,"!"],[24987,0," We're probably seeing t"],[24988,23,""],[24988,0,"There's "],[24988,8,""],[24988,0,"I'm probably thrashing the CPU cache."],[25024,0," w"],[25025,1,""],[25025,0,"by bouncing between thoses "],[25045,7,""],[25045,0,"these two B-trees"],[25064,11,""],[25158,0,"just "],[25158,4,""],[25157,1,""],[25045,5,""],[25045,0,"the"],[25059,1,""],[25059,0," i"],[25060,1,""],[25059,1,""],[25059,0,"s"],[25059,1,""],[25059,0," "],[25059,1,""],[25059,0,"s"],[26015,0,"It turns out "],[26029,0,"'m"],[26031,3,""],[26015,0,"I'm "],[26018,1,""],[26017,1,""],[26016,1,""],[26016,0," don't know who"],[26030,1,""],[26029,1,""],[26028,1,""],[26028,0,"'"],[26016,0,"'"],[26017,12,""],[26017,0,"m terib"],[26023,1,""],[26022,1,""],[26022,0,"rible at academic papers, but "],[26053,1,""],[26052,1,""],[26052,0,"i"],[26151,1,""],[26159,0,"*"],[26155,0,"use my skills and "],[26183,1,""],[26183,0," researchers"],[26239,0," of inventing CRDT semantics. But"],[26272,5,""],[26293,41,""],[26293,0," Oops!"],[26294,0,"And I "],[26299,1,""],[26298,1,""],[26298,0,"if I did, we could have f"],[26322,1,""],[26322,0,"had fast, workable CD"],[26342,1,""],[26342,0,"RDTs a decade ago. "],[26311,0,"might"],[26316,5,""],[26341,0,"te"],[26342,1,""],[26341,1,""],[26346,0," for text editing"],[26385,0,"For the record, "],[26513,14,""],[26467,11,""],[26470,4,""],[26470,0," do all"],[26506,0," We "],[26506,4,""],[26506,0," Different dharmas. "],[26525,1,""],[26541,1,""],[26541,0,"our own gift for the world"],[26567,27,""],[26567,0,", if we can find it"],[26587,0,"\n\nInstead of being frustrated at that paper, I shoud"],[26638,1,""],[26638,0,"ld n"],[26641,1,""],[26641,0,"have"],[26632,13,""],[26631,1,""],[26630,1,""],[26589,32,""],[26589,0,"T"],[26599,0," was a call to adventure "],[26623,1,""],[26623,0,". That was the world saying \"Your skills are rare\""],[26625,10,""],[26625,0,"T"],[26641,0," was sayinh"],[26651,1,""],[26651,0,"g"],[26670,4,""],[26670,0,"valuable. W"],[26680,1,""],[26679,1,""],[26678,1,""],[26678,0," an"],[26670,11,""],[26670,0,"needed here."],[26579,7,""],[26579,0,"figure out th"],[26591,1,""],[26590,1,""],[26590,0,"what that is"],[26605,4,""],[26605,0,"In this spirit,"],[26605,15,""],[26605,0,"That"],[26620,0,"really "],[26648,0,"It was "],[26655,3,""],[26654,1,""],[26654,0," the"],[26684,0,"He "],[26686,1,""],[26686,0,"y seph, "],[26688,1,""],[26688,0,"S"],[26694,27,""],[26694,0,"We "],[26696,1,""],[26695,1,""],[26694,1,""],[26694,0,"we need your help over here. You're holding a piece of the puzzle"],[26749,3,""],[26749,0,"this"],[26762,0," In my ou"],[26770,1,""],[26769,1,""],[26769,0,"youthn"],[26774,1,""],[26774,0,"ful "],[26726,3,""],[26726,0,"r skils"],[26732,1,""],[26732,0,"ls are"],[26738,8,""],[26761,0,", and we can't get it owrking"],[26783,7,""],[26783,0,"wi"],[26784,1,""],[26784,0,"orking without you"],[26820,0,"arrogance I "],[26605,227,""],[26605,0,"That paper was really a call to adventure. It was the world saying was saying \"Hey Seph, we need your help over here. Your skills are a piece of this puzzle, and we can't get it working without you.\" In my youthful arrogance I"],[26017,1,""],[26016,1,""],[26016,0," might be"],[26260,0,"P2P collaborative editing"],[26285,14,""],[26312,5,""],[26312,0,"I"],[26662,10,""],[26662,0,"The"],[26671,0," came knocking at my door"],[26703,11,""],[26705,4,""],[26778,5,""],[26779,1,""],[26778,1,""],[26778,0,". W"],[26788,4,""],[26788,0," "],[26789,3,""],[26789,0,"this"],[26842,0," turned away. "],[26855,1,""],[26854,1,""],[26854,0,". I di"],[26859,1,""],[26858,1,""],[26857,1,""],[26856,1,""],[26855,1,""],[26855,0," I didn't enter the dragon's cave, and didn't "],[26894,7,""],[26894,0,"it took me another decades"],[26919,1,""],[26919,0," to find the treat"],[26936,1,""],[26936,0,"sure inside.\n\nBut we've found it now. P2P"],[26974,3,""],[26974,0,"Realtime collaborative editing"],[26974,0,"Decentralized "],[26988,1,""],[26988,0,"r"],[27018,0,"? We're coming for you.\n\n\n"],[27044,45,""],[27044,0,"# Appending X"],[27056,1,""],[27056,0,"A: "],[27058,1,""],[27058,0," Lying with benchmarks\n\nI've odne a"],[27087,6,""],[27087,0,"done a few lgi"],[27100,1,""],[27099,1,""],[27098,1,""],[27098,0,"gliths "],[27098,7,""],[27098,0,"slights of hands"],[27082,11,""],[27082,0,"There are a"],[27113,1,""],[27113,0," above that I want to admit, justi"],[27142,5,""],[27142,0,"efe"],[27142,3,""],[27141,1,""],[27140,1,""],[27140,0," and defend"],[27135,6,""],[27135,0,"f"],[27135,1,""],[27135,0,"confe"],[27139,1,""],[27138,1,""],[27137,1,""],[27136,1,""],[27135,1,""],[27135,0,"'fess up to "],[27157,0,".\n\n1. I'"],[27164,1,""],[27163,1,""],[27163,0,"I've written this post b"],[27163,24,""],[27163,0,"I've played fast and loose with two CRDT algoir"],[27204,6,""],[27204,0,"semantics"],[27190,0,"directly comparing implementations which use "],[27235,4,""],[27234,1,""],[27239,0,"different "],[27263,0,": Y"],[27265,1,""],[27265,0,"RGA (automerge) and YARTA"],[27289,1,""],[27288,1,""],[27287,1,""],[27287,0,"TA (yjs + my rust code). This i"],[27317,1,""],[27316,1,""],[27315,1,""],[27314,1,""],[27313,1,""],[27312,1,""],[27312,0,"My claim "],[27312,9,""],[27312,0,"I'm making a "],[27324,1,""],[27324,0,"n assumption"],[27189,0," with numbers,"],[27319,4,""],[27319,0,"implementation"],[27347,3,""],[27347,0,"the "],[27361,0," that both algorithms are "],[27372,15,""],[27367,5,""],[27367,0,"the implementation speed is identical - because in my reference CRDT implementation "],[27450,1,""],[27450,0,", it is. A"],[27459,1,""],[27421,0,"["],[27436,0,"]"],[27436,1,""],[27451,0,"](https://github.com/josephg/reference-crdts)"],[27505,0,"With a "],[27511,1,""],[27510,1,""],[27510,0,"this editing trace, "],[27164,84,""],[27164,0,"'ve written th"],[27163,44,""],[27163,0,"I'm comp"],[27170,1,""],[27169,1,""],[27168,1,""],[27167,1,""],[27167,0,"directly comparing the performance of implementations im"],[27222,1,""],[27221,1,""],[27221,0,"of"],[27223,1,""],[27163,0,"Through this post "],[27297,0," interchangably"],[27308,0,"e"],[27314,0," This only makes sense if"],[27339,69,""],[27339,0," the algorithms are intern"],[27364,1,""],[27364,0,"changable"],[27369,0,"e"],[27315,59,""],[27315,0,"This rests on the assumption that both algorithms run just as fast as each other"],[27398,13,""],[27397,1,""],[27396,1,""],[27395,1,""],[27395,0,"."],[27314,0," YATA "],[27315,5,""],[27315,0,"When there are no concurrent edits, all CRDT"],[27355,0,"list "],[27364,0,"s "],[27315,51,""],[27314,1,""],[27329,3,""],[27329,0,"a"],[27329,1,""],[27329,0,"the"],[27354,10,""],[27354,0,"semantics "],[27349,5,""],[27349,0,"the "],[27362,0," are interchangable"],[27377,0,"e"],[27382,32,""],[27382,0,", and the performance"],[27388,15,""],[27388,0,"if you swap semantics, the perfomra"],[27422,1,""],[27421,1,""],[27420,1,""],[27420,0,"rmance won't change."],[27439,1,""],[27441,0,"I've demonstrated this interchangability in my "],[27464,18,""],[27464,0,"property "],[27441,0,"This is actually a bold l"],[27465,1,""],[27465,0,"claim - which "],[27497,14,""],[27578,34,""],[27578,0,". And "],[27580,4,""],[27580,0,"You "],[27580,4,""],[27580,0,"I believe you could use the same approach to modify yjs to impement"],[27639,8,""],[27639,0,"implement RGA semantics - you'd just have to change"],[27581,0,"'m convinced"],[27593,8,""],[27694,0," yjs's *integrate* method, and store *ma"],[27733,1,""],[27732,1,""],[27732,0,"se"],[27721,4,""],[27730,0,"q* isntead of"],[27733,10,""],[27733,0,"instead of *originRight* in *Item* and store *maxSeq*"],[27777,0," and update"],[27797,0," in the document. This "],[27815,5,""],[27815,0,"The"],[27580,15,""],[27580,0,"Y"],[27652,0," if you wanted"],[27667,1,""],[27666,1,""],[27666,0,"."],[27668,1,""],[27668,0,"Y"],[27666,0," to"],[27762,0," each"],[27774,0,","],[27775,4,""],[27817,0," and h"],[27822,1,""],[27822,0,"change the binary encoding format"],[27857,3,""],[27857,0,"I talked to Kevin about this and he doesn't see t"],[27905,1,""],[27905,0,"any point."],[27889,1,""],[27889,0,", while cool, "],[27927,0," in "],[27930,1,""],[27929,1,""],[27928,1,""],[27927,1,""],[27918,4,""],[27918,0,"the "],[27927,0," of making"],[27931,6,""],[27931,0,"addin"],[27931,5,""],[27931,0,"making yjs compatible"],[27927,25,""],[27918,4,""],[27918,0,"any "],[27387,0,"t aht"],[27391,1,""],[27390,1,""],[27389,1,""],[27388,1,""],[27387,1,""],[27387,0," that"],[27444,0," (at least for single user editing traces)"],[27506,0," kin"],[27509,1,""],[27508,1,""],[27507,1,""],[27506,1,""],[27506,5,""],[27506,0," noven"],[27511,1,""],[27510,1,""],[27509,1,""],[27509,0,"vel"],[27518,0,"."],[27520,8,""],[27537,0," that this is true"],[27637,0,", which has identical performance for yjs and automerge"],[27671,0,"when using "],[27682,3,""],[27681,1,""],[27686,3,""],[27686,0,"or"],[27698,0," a"],[27699,1,""],[27699,0,"semantics"],[27710,0,"And I think "],[27722,1,""],[27722,0,"y"],[27716,7,""],[27715,1,""],[27715,0,"'m confident y"],[27159,0,"\n\n"],[27160,0,"### Yjs ==="],[27164,7,""],[27164,0,"Are these CRDTs actull"],[27185,1,""],[27184,1,""],[27184,0,"ally the same?"],[27202,1,""],[27201,1,""],[27200,1,""],[27351,1,""],[27350,1,""],[27350,0,".\n\n"],[27404,16,""],[27404,0," bascai"],[27410,1,""],[27409,1,""],[27409,0,"i"],[27409,1,""],[27408,1,""],[27408,0,"ically the same"],[27547,0," big bold"],[27548,8,""],[27547,1,""],[27559,0,","],[27559,2,""],[27559,0,"!"],[27537,16,""],[27537,0,"a new"],[27542,6,""],[27542,0," idea tha"],[27550,1,""],[27549,1,""],[27548,1,""],[27547,1,""],[27547,0," and I think I "],[27548,14,""],[27548,0,"that I think I "],[27539,24,""],[27539,0,"novel idea that nobody "],[27555,0,"I think "],[27570,0,"has discovered before"],[27591,1,""],[27591,0,"."],[27592,1,""],[27592,0,"\n\n"],[27611,5,""],[27616,8,""],[27616,0,"proper"],[27621,1,""],[27620,1,""],[27619,1,""],[27618,1,""],[27617,1,""],[27616,1,""],[27616,0," property"],[27751,0," either"],[27775,0,"'s"],[27904,4,""],[27903,1,""],[27911,0,":\n\n-"],[27916,1,""],[27916,0,"C"],[27923,1,""],[27923,0,"Y"],[27947,0," (or make an alternative with at"],[27977,2,""],[27977,0,"auto"],[27972,9,""],[27971,1,""],[27971,0,") which used slightly different logic for concurrent edits"],[28029,3,""],[28029,0,"\n- S"],[28083,3,""],[28083,0,"\n- S"],[28092,11,""],[28116,0,", and keep it up to doa"],[28138,1,""],[28137,1,""],[28137,0,"ate"],[28144,1,""],[28144,0,"\n- "],[28147,1,""],[28147,0,"C"],[28154,0,"yjs's "],[28160,3,""],[28159,1,""],[28183,1,""],[28183,0,"\n\n"],[28255,0," "],[28255,1,""],[28255,0," in adding this hinge into his library"],[28294,0,"\n\nFor my rust code, I probably will at some point add a "],[28344,6,""],[28344,0,"make my CRDT implementation ha"],[28373,1,""],[28372,1,""],[28372,0,"accecpt a"],[28380,1,""],[28379,1,""],[28378,1,""],[28377,1,""],[28376,1,""],[28376,0,"e"],[28376,1,""],[28376,0,"pt a type parameter which switches between yjs and automerge semantics."],[27164,9,""],[27164,0,"Hang on - A"],[27174,1,""],[27174,0,"are these"],[28457,0,"\n\n### "],[28459,4,""],[28459,0,"###"],[27043,0,"\n"],[27043,0,"\n# Appending"],[27054,1,""],[27053,1,""],[27053,0,"x\n\n# Wh"],[27059,1,""],[27058,1,""],[27057,1,""],[27057,0,"#"],[27061,0,"#"],[27063,13,""],[27063,0,"Appending A: "],[27063,23,""],[27063,0,"More information on my"],[27058,0," What if I want to use"],[27059,21,""],[27059,0,"Thats coo"],[27059,9,""],[27059,0,"What now? I want to use a CRDT for my application. What should I do?\n\nUse yjs. Yjs has excellent performance"],[27129,0,"If you're building an application today you should "],[27180,1,""],[27180,0,"u"],[27218,0,", low memory usage, great support (+ paid support if ou want"],[27271,7,""],[27271,0,"you need"],[27236,1,""],[27236,0," and"],[27254,0,". Kevin "],[27256,6,""],[27256,0,"You can also get"],[27272,3,""],[27286,11,""],[27286,0,"if you need it"],[27269,3,""],[27269,0,"become a sponsor of yjs t"],[27293,29,""],[27293,0,"if you want - which g"],[27313,1,""],[27313,0,"(if Kevin has time) will"],[27256,81,""],[27256,0,"You "],[27259,1,""],[27258,1,""],[27257,1,""],[27256,1,""],[27256,0,"If you have money"],[27263,10,""],[27263,0,"want help imeplm"],[27278,1,""],[27277,1,""],[27276,1,""],[27275,1,""],[27275,0,"plementing yjs in your application, Kevin "],[27149,1,""],[27149,0," a"],[27150,1,""],[27150,0,"co"],[27151,1,""],[27150,1,""],[27150,0,"document based collaborative"],[27196,0,", and you want ti t"],[27214,1,""],[27213,1,""],[27212,1,""],[27211,1,""],[27211,0,"to do it on top of CRDTs"],[27384,0,"might be able to "],[27377,24,""],[27377,0," get in conte"],[27389,1,""],[27389,0,"act with Kevin Jahns"],[27378,20,""],[27378,0,"yjs"],[27380,1,""],[27379,1,""],[27378,1,""],[27377,1,""],[27377,0," "],[27389,0," accepts some paid work in exchange for "],[27425,4,""],[27424,1,""],[27413,11,""],[27413,0,"so ke"],[27417,1,""],[27416,1,""],[27416,0,"he can work on yjs ful "],[27438,1,""],[27438,0,"l time."],[27413,0,"to fund working"],[27428,14,""],[27435,0," (and adjacent p"],[27450,1,""],[27450,0,"work)"],[27466,0,"\n\nMy rust code is really fast, but it m"],[27504,1,""],[27504,0,"probably"],[27504,0,"will "],[27517,0," never turn into a reliable"],[27536,8,""],[27536,0,"useful r"],[27543,1,""],[27543,0,"general purpose CRDT library. I simply don't have"],[27573,0,"There's 100 other things that "],[27573,30,""],[27573,0,"To be compatible "],[27579,11,""],[27579,0,"able to compete with yjs there are "],[27604,10,""],[27604,0,"on functionality there are 100 other things "],[27648,19,""],[27648,0," it "],[27651,1,""],[27650,1,""],[27649,1,""],[27648,1,""],[27648,0,"it needs to do well. "],[27603,0,"'s"],[27605,3,""],[27667,1,""],[27666,1,""],[27666,0,", including binary encoding and "],[27694,4,""],[27693,1,""],[27693,0,", network protocols, support for non-list structures, presence (curos"],[27761,1,""],[27760,1,""],[27760,0,"sor positions) and so on."],[27571,0," like yjs"],[27613,1,""],[27612,1,""],[27612,0,","],[27613,14,""],[27779,0,"\n\nIf you want database like semantics for realtime editing, you na"],[27844,1,""],[27843,1,""],[27843,0,"can"],[27839,7,""],[27839,0,"nobody has m"],[27850,1,""],[27850,0,"done this well yet."],[27839,0,"as far as I know "],[27882,4,""],[27882,0,"on top of CRDTs yet. You can use Shared"],[27920,1,""],[27920,0,"DB"],[27915,0,"my "],[27915,3,""],[27922,0," (which I wrote yesr"],[27941,1,""],[27940,1,""],[27940,0,"ars ago, and has been continually improved by an army oc "],[27996,1,""],[27995,1,""],[27995,0,"f contributors since then). "],[27982,28,""],[27982,0," "],[27996,0,"I'm excited for Redwoor"],[28018,1,""],[28018,0,"d."],[27915,0,"["],[27923,0,"](https://github.com/share/sharedb/)."],[27961,7,""],[27962,0," "],[27962,1,""],[27969,0,"shard"],[27973,1,""],[27973,0,"edb "],[28032,1,""],[28033,1,""],[28033,0," Looking forward, "],[28067,0,"["],[28075,0,"](https://github.com/redwood/redwood)"],[28033,1,""],[28033,0,"\n\nIf you want P2P support "],[28035,24,""],[28113,1,""],[28113,0," - which promises "],[28122,9,""],[28122,0,"is impl"],[28122,7,""],[28122,0,"has planned full CRDT support."],[28122,0,"uses "],[28122,5,""],[28122,0,"supports p2p editing and "],[28131,3,""],[28131,0,"P2P"],[29597,0," "],[29594,4,""],[29594,0,"###"],[27408,7,""],[27408,0,"support"],[27390,25,""],[27390,0,"sometimes accepts money in exchann"],[27423,1,""],[27423,0,"ge for help integrate"],[27443,1,""],[27443,0,"ing yjs into various applications. He usess t"],[27487,1,""],[27486,1,""],[27486,0," "],[27486,1,""],[27485,1,""],[27485,0," this to"],[27498,11,""],[27498,0," working on"],[27701,5,""],[27701,0," lot "],[27705,1,""],[27705,0,"s of "],[29679,0," This is the wrong benchmark"],[29698,9,""],[29698,0,"measure of performance\n\nYes, I agree.\n\nThe "],[29737,4,""],[29737,0,"The"],[29728,0," know and I"],[29748,3,""],[29748,0,"Accepting incoming changes from the usero"],[29788,1,""],[29788,0," only needs to happen fast enough "],[29821,1,""],[29815,0,"*"],[29822,0,"*. Fingers simply don't type very fast - so once a cR"],[29874,1,""],[29873,1,""],[29873,0,"CRDT gets "],[29878,5,""],[29878,0,"can handle any user edit in "],[29893,0,"local "],[29912,0,"under 1ms, going faster probably doesn't matte."],[29958,1,""],[29958,0,"r.\n\nThe important metrics are:"],[29966,0,"more "],[29993,0,"\n\n- How long the document takes to load from disk\n- "],[30043,2,""],[30043,0,"-"],[30027,0," save and"],[30053,0," Howm"],[30057,1,""],[30057,0," much spae"],[30066,1,""],[30066,0,"ce the do"],[30069,6,""],[30069,0,"it takes to send and rev"],[30092,1,""],[30092,0,"ceive the document"],[30058,52,""],[30058,0,"many bytes a document takes over the wo"],[30096,1,""],[30096,0,"ire"],[30095,4,""],[30095,0,"network"],[30086,0,"to en"],[30090,1,""],[30089,1,""],[30089,0,"send "],[30089,5,""],[30089,0,"store or send "],[30119,0,"\n\nWe"],[30122,1,""],[30121,1,""],[30121,0,"I'm also "],[30121,9,""],[30121,0,"All of these "],[30121,13,""],[30121,0,"The editing trace I'm using here also only has a single user making edits - "],[30196,1,""],[30195,1,""],[30194,1,""],[30194,0,". There might "],[30202,6,""],[30202,0,"could be pathological cases lurking in the shadows"],[30224,0,"performance "],[30264,0," when concurrent edits happen here."],[29965,0," actually"],[29974,5,""],[30290,13,""],[30274,0,"users make "],[30301,0,"."],[27054,0," A:"],[27057,14,""],[28251,1,""],[28251,0," Appending B: Your benchmarks are wrong"],[28290,34,""],[28285,0,"weird / "],[28298,0," / misleading"],[28265,4,""],[28265,0,"These"],[28464,9,""],[28586,0,"I"],[28586,1,""],[28586,0,"Doing this"],[28596,4,""],[28596,0," "],[28596,1,""],[28640,0,"for YATA and RGA "],[28701,0," between CRDT"],[28754,42,""],[28690,3,""],[28693,0," can"],[28725,0," without change"],[28739,1,""],[28739,0,"ing your implementation, or your implementation performance"],[28798,30,""],[28845,10,""],[28845,0,"n"],[28845,1,""],[28845,0,"looked at"],[28865,3,""],[28865,0," feel confident in this claim because I"],[28923,9,""],[29049,7,""],[29038,0,"(and an i"],[29046,1,""],[29045,1,""],[29044,1,""],[29044,0," almost-identical codepath) "],[29112,0," There might be some performance chang"],[29145,5,""],[29145,0,"differences with conflict-heavy editing traces - but thats extremely rare in ra"],[29223,1,""],[29222,1,""],[29222,0,"practice."],[29232,4,""],[29231,1,""],[29231,0,"\n\n"],[29236,0," also"],[29261,25,""],[29316,0,", without changing yjs's pef"],[29343,1,""],[29343,0,"rformance"],[29340,0," resulting"],[29341,9,""],[29340,1,""],[29354,13,""],[29354,0,"I know how you'd do it, too"],[29687,0," he a"],[29691,1,""],[29690,1,""],[29689,1,""],[29688,1,""],[29687,1,""],[29686,1,""],[29685,1,""],[29684,1,""],[29683,1,""],[29683,0,"."],[29684,1,""],[29685,1,""],[29685,0,"W"],[29732,4,""],[29732,0,"RGA support"],[29743,11,""],[29743,0," into"],[29761,0," I sort of "],[29764,8,""],[29763,1,""],[29763,0," "],[29763,1,""],[29762,1,""],[29761,1,""],[29761,0," Its a lot of "],[29762,13,""],[29762,0,"Changing the binary format in particular is a lot of work - and there"],[29819,12,""],[29819,0,", and "],[29761,64,""],[29761,0," Its not a feature anyob"],[29784,1,""],[29783,1,""],[29783,0,"body actually asks for."],[30006,25,""],[30006,0,"\nYes, I know and I agree. This post only measure "],[30054,1,""],[30054,0,"s the time toa"],[30067,1,""],[30066,1,""],[30066,0,"aken to replac"],[30079,1,""],[30079,0,"y an "],[30081,3,""],[30081,0,"a local editing trace. There's lot o"],[30116,1,""],[30115,1,""],[30115,0,"s"],[30065,0,"and memory "],[30065,11,""],[30102,0,", and the resulting RAM usage"],[30145,0," of mo"],[30150,1,""],[30132,20,""],[30132,0," But arguably, "],[30147,1,""],[30147,0,"a"],[30145,1,""],[30364,0,"("],[30364,1,""],[30364,0,"*"],[30383,0,"*"],[30360,24,""],[30360,0,"B"],[30360,1,""],[30360,0,"The *actually important*"],[30702,0,"\n\nI did it this way becasue both "],[30722,13,""],[30722,0,"because my reference-crdts"],[30730,18,""],[30729,1,""],[30729,0,":\n\n- Yjs and automerge both impleemtn"],[30734,0,"The "],[30738,1,""],[30738,0,"y"],[30756,14,""],[30756,0,"libraries implement very fast"],[30781,4,""],[30781,0,"compact binary representations"],[30766,0,"both "],[30816,0,". Th"],[30818,2,""],[30818,0,"An existence proof is enough for me h"],[30854,1,""],[30853,1,""],[30853,0," - I think you could port those binary packing formats to any inm"],[30917,1,""],[30916,1,""],[30916,0,"mplementation"],[30731,0,"\n- My re"],[30738,1,""],[30737,1,""],[30736,1,""],[30735,1,""],[30734,1,""],[30734,0,"I don't "],[30732,10,""],[30731,1,""],[30730,1,""],[30729,1,""],[30729,0," I don't have a binary"],[30732,5,""],[30732,0,"haven't implemented"],[30765,0," format in my reference-crdts or rust"],[30795,0,"implementation "],[30812,0," my"],[30820,0," code.\n"],[30826,0," I think it would be roughly "],[30835,0,"the performance "],[30827,11,""],[30827,0,"If I didn"],[30835,1,""],[30835,0,", I'd copy yjs & automerge's binary formats (they're extremely compact)"],[30841,0,"probably "],[30915,0," - so size would be identical. And I think"],[30990,0,"in "],[30990,3,""],[30990,0,"proportional w"],[31003,1,""],[31003,0,"to the time taken to process this editing trace - "],[31052,1,""],[31051,1,""],[31050,1,""],[31032,18,""],[31032,0,"editing traces."],[31047,200,""],[31047,0,"\n\n"],[31047,0," But I've been wrong before"],[30831,0," wrote that code"],[30847,4,""],[30851,1,""],[30850,1,""],[30849,1,""],[30849,0,"it would"],[30851,6,""],[30849,2,""],[30849,0,"I'd"],[30847,0," did"],[30842,5,""],[30837,5,""],[30831,6,""],[30887,0," because"],[30895,9,""],[30895,0," they're so"],[30906,10,""],[30914,1,""],[30914,0,"."],[30916,3,""],[30916,0,"S"],[30918,0," I expect"],[30928,0,"the resulting "],[30965,0," between all of these implementations"],[31009,0," suspect (claim)"],[31017,14,""],[31030,0,"for loading and saving "],[31053,3,""],[31061,28,""],[31061,0," pretty similar to the"],[31121,0," Probab"],[31121,7,""],[31121,0," Probably a bit faster e"],[31144,1,""],[31144,0,"because you only have to pro"],[31152,20,""],[31152,0,"the "],[31152,4,""],[31152,0,"in this format the document is alread st"],[31191,1,""],[31190,1,""],[31189,1,""],[31189,0,"y stored in order."],[31122,86,""],[31148,0,".\n\nI "],[31152,1,""],[31151,1,""],[31151,0,"There's a few small differences"],[30316,0,"about "],[30364,0," "],[30364,1,""],[30364,0," "],[30364,1,""],[30364,0,"\n\nIt is really fun though."],[31188,26,""],[31188,0," is one difference which might matter - yjs's binary format does run-length encoding of the "],[31231,49,""],[31231,0," packa"],[31236,1,""],[31236,0,"s th"],[31239,1,""],[31238,1,""],[31238,0,"information about deleted eleemnts "],[31264,9,""],[31264,0,"elements"],[31232,40,""],[31232,0,"and automerge treat dele"],[31252,4,""],[31252,0,"informatoin ab"],[31252,14,""],[31252,0,"information about deleted items l"],[31284,1,""],[31284,0,"slightly differentlt."],[31304,1,""],[31303,1,""],[31303,0,"y. "],[31305,1,""],[31305,0," (Ys"],[31308,1,""],[31308,0,"hs"],[31309,1,""],[31308,1,""],[31308,0,"js packs"],[31311,5,""],[31311,0,"RLE-e"],[31315,1,""],[31314,1,""],[31313,1,""],[31312,1,""],[31311,1,""],[31311,0,"run-el"],[31316,1,""],[31315,1,""],[31315,0,"length-encodes them and packa"],[31343,1,""],[31343,0,"s that information into the version structure. "],[31389,1,""],[31388,1,""],[31388,0,". Automerge put a"],[31404,1,""],[31403,1,""],[31403,0,"s that into the operation log)"],[31405,5,""],[31405,0,"deletes "],[31435,0,"."],[31437,0," This probably has some real-world "],[31461,11,""],[31461,0,"implications in terms pf "],[31485,1,""],[31484,1,""],[31483,1,""],[31483,0,"of implementation, but whatever"],[31505,9,""],[31505,0," I'"],[31507,1,""],[30437,4,""],[30437,0,"muuc"],[30440,1,""],[30439,1,""],[30439,0,"ch time"],[30560,0,"\n- How much time the document takes to save and load from disk"],[30431,62,""],[30465,16,""],[30465,0,"on disk or"],[30544,10,""],[31489,7,""],[31489,0,", because for automerge you need to store *when* each delete happened. Not just i"],[31569,1,""],[31569,0,"*if* the item has been deleted."],[31599,0," ("],[31600,1,""],[31599,1,""],[31600,0,"\n\nThere'"],[31602,6,""],[31601,1,""],[31600,1,""],[30544,0,"\n- T"],[30547,1,""],[30547,0,"The time taken "],[30547,15,""],[30547,0,"The time taken to update a docuemn"],[30580,1,""],[30579,1,""],[30578,1,""],[30578,0,"ment at rest (assuming a document is infrequently editing"],[30634,1,""],[30633,1,""],[30632,1,""],[30632,0,"ed and living "],[30590,56,""],[30590,0," ("],[30590,2,""],[30590,0," (more below)"],[31660,0,"\n"],[31660,0,"\nThe question nobody in the community seems to be thinking about is updaintg"],[31735,1,""],[31734,1,""],[31733,1,""],[31732,1,""],[31732,0,"ting a document at rest. If I have a CRDT "],[31769,0,"list "],[31779,0,"stored in P"],[31789,1,""],[31789,0,"postgres, and its very infrequently wr"],[31807,17,""],[31807,0,"wr"],[31808,1,""],[31807,1,""],[31806,1,""],[31809,0,"itten to infrequently, a"],[31832,1,""],[31832,0,"yjs and automerge seem to assume the ri"],[31850,21,""],[31850,0,"are written to "],[31862,3,""],[31862,0,"assuming you wan t"],[31879,1,""],[31878,1,""],[31878,0," t"],[31879,1,""],[31878,1,""],[31878,0,"t to:\n\n1. Load the docuemn"],[31903,1,""],[31902,1,""],[31901,1,""],[31901,0,"ment into RAM\n2. Make your change\n3. Save thew "],[31947,1,""],[31946,1,""],[31946,0," "],[31935,12,""],[31935,0,"3. Save the"],[31897,0,"whole "],[31952,0," whole document back to disk again\n\nThis"],[31988,4,""],[31988,0,"We do this for "],[31988,15,""],[31988,0,"This is actually really inefficient"],[31660,0,"\n---\n"],[28265,5,""],[28265,0,"Your"],[28325,3,""],[28325,0,"couple of"],[32006,15,""],[32006,0,"extremely"],[32027,0,", n"],[32029,1,""],[32029,0,"and it matter "],[32042,1,""],[32042,0,"s for some "],[32047,6,""],[32047,0," reall appli"],[32052,1,""],[32058,0,"cations ("],[32066,1,""],[32065,1,""],[32065,0," if we "],[32066,6,""],[32065,1,""],[32036,0,"will "],[32047,1,""],[32069,0," if we want CRDTs to be anything"],[32093,8,""],[32093,0,"u"],[32093,1,""],[32093,0,"u"],[32093,1,""],[32093,0,"mo"],[32094,1,""],[32093,1,""],[32093,0,"useful outside the context of text editing."],[32073,0,"(like me) you"],[32086,2,""],[32035,5,""],[32042,0,"s"],[32082,0,"'re hoping we add collaborative editing to more applicatoins tha"],[32130,16,""],[32130,0,"a"],[32130,1,""],[32065,0,". Espe"],[32066,5,""],[32065,1,""],[32065,0,". Especially if w"],[32067,10,""],[32048,19,""],[32048,0,"all the "],[32048,8,""],[32048,0,"the 99% of applications a"],[32072,1,""],[32072,0,"out there which aren't collaborative text editi"],[32118,1,""],[32117,1,""],[32117,0,"o"],[32117,1,""],[32117,0,"tors."],[32087,0," might want concurrent"],[32099,0,"to support "],[32120,0," editing, but"],[32168,131,""],[32168,0,"\n\nAs far as I know, nobody is thinking about this problem at the moment.\n\nI'm "],[32242,4,""],[32242,0,"I'm"],[32241,0,"\n\n---"],[32241,1,""],[32245,0,"\n"],[32250,0," also not looking into pruning. CRDTs like this grow u"],[32303,1,""],[32303,0,"over time (since we keep toms"],[32331,1,""],[32331,0,"bstones from all deleted items). This i"],[32364,6,""],[32364,0,"There are some "],[32364,15,""],[32364,0,"T"],[32364,1,""],[32364,0,"We don't actually need"],[32364,22,""],[32364,0,"You don't "],[32364,10,""],[32364,0,"There are some algorithms fr"],[32391,1,""],[32391,0,"or fixing this "],[32405,1,""],[32405,0,", and trimming down the document size from time to time. But a"],[32364,103,""],[32364,0,"This can be fixed, but fixing this is orthogonal to o"],[32416,1,""],[32412,4,""],[32412,0,"."],[32387,6,""],[32386,1,""],[32386,0," its "],[32387,4,""],[32387,0,"these fixes"],[32381,0," (eg Yjs's GC algorithm or "],[32407,1,""],[32406,1,""],[32405,1,""],[32404,1,""],[32404,0,", or Antimatter)"],[32420,1,""],[32420,0,"."],[32422,1,""],[32422,0,"B"],[32409,0,"To"],[32410,1,""],[32409,1,""],[32438,4,""],[32438,0,"are"],[32441,3,""],[32452,0," to what I'm doing above"],[32432,5,""],[32432,0,"a"],[32432,1,""],[32432,0,"things should work with any of the approaches I've listed"],[32489,34,""],[32489,0," "],[32498,0,"\n### Appendig"],[32510,1,""],[32510,0,"x C: Holy cow, automerge is really slow!"],[32551,57,""],[32551,0,"\nI know!! Take a loook "],[32573,1,""],[32572,1,""],[32571,1,""],[32571,0,"k at "],[32561,15,""],[32561,0,"Iyd "],[32564,1,""],[32563,1,""],[32562,1,""],[32562,0,"ts really just"],[32565,11,""],[32565,0,"not even trying to be fast. Look at this code:\n"],[32564,0," e"],[32565,1,""],[32565,0,"really"],[33943,746,""],[32532,0,"'"],[32532,1,""],[32534,0,"'s javascript c"],[32548,1,""],[32547,1,""],[33955,0,"\nT"],[33956,1,""],[33956,0,"But this code is all going tobe re"],[33989,1,""],[33988,1,""],[33987,1,""],[33986,1,""],[33985,1,""],[33985,0," be replaced by [automerge-rs](https://github.com/automerge/automerge-rs), whene"],[34064,1,""],[34063,1,""],[34063,0,"ver"],[34065,1,""],[34064,1,""],[34063,1,""],[34062,1,""],[34062,0,"enever that finally lands. (Maybe this week"],[34090,15,""],[34089,1,""],[34089,0,"Its been \"real son"],[34106,1,""],[34106,0,"on now\" for months. Maybe its landed"],[33997,0," i"],[33998,1,""],[33997,1,""],[33959,0," in practice"],[34012,0," calls "],[34013,6,""],[34013,0,"WASM calls through to"],[34176,0," by the time you're reading this! How fast is au"],[34214,10,""],[34214,0,"does automerge-rs compare? Good ue"],[34247,1,""],[34246,1,""],[34246,0,"question - I'd lo"],[34257,6,""],[34257,0,"maybe "],[34257,6,""],[34257,0,"I'd love to know too. Run"],[34279,3,""],[34278,1,""],[34277,1,""],[34277,0,"!"],[0,0,"\n\n\n"],[1,0,"! "],[2,1,""],[1,1,""],[1,0,"# Autom"],[3,5,""],[3,0,"Making CRDTs go BRRR "],[23,1,""],[22,1,""],[21,1,""],[20,1,""],[19,1,""],[3,7,""],[12,0,"BRRR: Improving performance byt "],[43,1,""],[42,1,""],[42,0," 4000x"],[3211,5,""],[3211,0,"Its"],[3416,0,"I took "],[3416,7,""],[3422,1,""],[3422,0,"ing"],[7952,1,""],[7952,0,"I"],[7952,0,"["],[7965,0,"](https://immutable-js.github.io/)"],[7962,1,""],[8476,0,"just "],[9062,21,""],[9062,0,"when you can"],[9081,0," it"],[9070,0,"'"],[9070,1,""],[9062,12,""],[9062,0,"before"],[9074,1,""],[9074,0,"ing"],[9062,7,""],[9062,0,"and then "],[9078,1,""],[9077,1,""],[9076,1,""],[9076,0,"ing"],[9062,17,""],[9062,0,"before rewriting"],[9062,16,""],[9062,0,"when yuo're a"],[9067,8,""],[9067,0,"you're about to throw it away in a rewrite"],[9109,3,""],[9279,0," as fa"],[9284,1,""],[9283,1,""],[9282,1,""],[9281,1,""],[9280,1,""],[9279,1,""],[9301,0," is another (competing) CRDT algorithm n "],[9341,1,""],[9340,1,""],[9340,0,"on github"],[9330,10,""],[9330,0,"implementation "],[9354,0," made by J"],[9363,1,""],[9363,0,"H"],[9363,1,""],[9363,0,"Kevin Jahns. Ke"],[9377,1,""],[9376,1,""],[9376,0,"A"],[9376,1,""],[9376,0,"And its really fast, well dou"],[9404,1,""],[9404,0,"cumented and well made. Yjs"],[9517,6,""],[9517,0,"really"],[9517,6,""],[9517,0,"really"],[9517,6,""],[9517,0,"pretty"],[9427,1,""],[9427,0,"\n\n"],[10218,58,""],[10217,1,""],[10414,136,""],[10413,1,""],[10424,3,""],[10415,9,""],[10415,0,"But with this"],[10445,1,""],[10445,0," l"],[10446,1,""],[10445,1,""],[10445,0,"s more complicated"],[10620,0," (?)"],[10637,0," there, splicing into the array"],[10668,1,""],[10740,8,""],[10751,0," - how do you figure out where the new item should go?"],[10805,51,""],[10805,0," But it "],[10812,1,""],[10812,0,"s only complicated like *math*. The logic for ordering ends up being 2l"],[10882,1,""],[10882,0," "],[10881,2,""],[10881,0,"just a few if statements."],[10842,64,""],[10842,0," - the "],[10845,4,""],[10845,0,"once you f"],[10854,1,""],[10843,0,"is complicate."],[10856,1,""],[10856,0,"d."],[10858,11,""],[10859,8,""],[10859,0,"Its hard to understand, but when you do, you "],[11042,0," if you're interested"],[11408,2,""],[11408,0,"I made a"],[11414,2,""],[11414,0," a"],[11486,0," whivh"],[11491,1,""],[11490,1,""],[11490,0,"ch"],[11529,0," side-by-sided"],[11542,1,""],[11544,66,""],[11544,0,"For "],[11547,1,""],[11546,1,""],[11545,1,""],[11544,1,""],[11544,0,"You can (mostly) swap imle"],[11569,1,""],[11568,1,""],[11568,0,"plementations y"],[11582,1,""],[11582,0,"by just changing your inte"],[11607,1,""],[11606,1,""],[11605,1,""],[11604,1,""],[11604,0,"insertion function."],[11604,9,""],[11590,14,""],[11590,0,"sapp"],[11593,1,""],[11592,1,""],[11591,1,""],[11591,0,"wapping out your insertion"],[11644,5,""],[11644,0," does"],[11654,1,""],[11810,17,""],[11810,0,"I"],[11821,0,", its really fast"],[11810,0,"So "],[11813,1,""],[11813,0,"i"],[11824,1,""],[11824,0," "],[11824,1,""],[11989,0," (TM)"],[12097,46,""],[11194,10,""],[11194,0,"better "],[11220,0," "],[11177,0,"This approach is better for lots of reasons :\n"],[11177,46,""],[11220,1,""],[11200,1,""],[11194,6,""],[11194,0,"beautiful "],[12097,0," We implement a list CRDT with a list. Genius!"],[12097,46,""],[11194,10,""],[11194,0,"better "],[11220,0," "],[11177,0,"This approach is better for lots of reasons :\n"],[11177,46,""],[11221,0," We implement a list CRDT with a list. Genius!"],[11221,46,""],[11220,1,""],[11176,0,"\n We implement a list CRDT with a list. Genius!"],[11178,1,""],[11177,1,""],[11177,0,"W"],[11177,0,"In short"],[11177,8,""],[11222,0,"\n"],[10831,4,""],[10814,5,""],[10826,0,"like"],[10895,70,""],[10895,0,"you can do the whoel "],[10915,1,""],[10914,1,""],[10913,1,""],[10913,0,"le thing in about "],[11003,21,""],[11117,45,""],[10728,0," We implement a list CRDT with a list. Genius!"],[10731,0,"'re"],[10744,0,"ing"],[11169,1,""],[11168,1,""],[12085,1,""],[12085,0," - w"],[12088,1,""],[12087,1,""],[12086,1,""],[12085,1,""],[12085,0,". Moving the fronteir"],[12085,1,""],[12085,0,", which is the "],[12100,20,""],[12100,0,"kind of idea that makes you"],[12085,42,""],[12085,0," "],[12085,1,""],[12085,0,". These idae"],[12096,1,""],[12095,1,""],[12087,8,""],[12087,0,"Ideas which do this are golden."],[12111,0,"truly "],[12110,0," rare and"],[12119,6,""],[12119,0," truly"],[12134,0,"\n\n"],[12135,0,"I'"],[12136,1,""],[12136,0," "],[12135,2,""],[12135,0,"I"],[11396,220,""],[11395,1,""],[11395,0,", if you want to."],[11932,0," made"],[11932,5,""],[11408,4,""],[11403,5,""],[11399,4,""],[11396,3,""],[11395,1,""],[11395,0,", if you want to."],[11932,0," made"],[11000,0,"\n\n\n"],[11002,1,""],[11001,1,""],[11000,1,""],[10781,0,"\n"],[10781,0,"\nIn an eff"],[10782,9,""],[10782,0,"I implemented both Yjs and Automerge myself using this approach in a toy CRDT "],[10855,5,""],[10855,0,"codebase, so I could understand"],[10865,21,""],[10865,0," "],[10865,1,""],[10865,0,"to prove I could"],[10845,36,""],[10845,0,". The code"],[10851,0,"["],[10856,0," is here](https://github.com/josephg/reference-crdts)"],[10860,0,"all "],[10913,0," if you want to "],[10870,42,""],[10870,0,"https://github.com/josephg/reference-crdts/blob/main/crdts.ts"],[10948,0,"figure this out in m"],[10948,20,""],[10948,0,"understan "],[10957,1,""],[10957,0,"d this in more detail."],[11199,1,""],[11199,0,"\n\n\n"],[10979,1,""],[10782,0,"\n"],[10980,219,""],[10783,0,"It sounds complicated - how do you figure out where the new item should go? But its complicated like *math* is complicated. Its hard to understand, but when you do, you can do the whole thing in about 20 lines of code.\n"],[11199,1,""],[11002,0,"\n"],[10781,1,""],[11199,2,""],[11199,0," "],[11366,0," Both "],[11371,1,""],[11370,1,""],[11369,1,""],[11368,1,""],[11367,1,""],[11366,1,""],[11366,0," C"],[11367,1,""],[11367,0,"Automer"],[11367,7,""],[11367,0,"Implemented like this, all the e"],[11398,1,""],[11390,8,""],[11390,0,"the difference "],[11390,15,""],[11390,0,"the CRDT semantics "],[11390,0,"auot"],[11393,1,""],[11392,1,""],[11392,0,"tomerge and yjs's "],[11410,4,""],[11425,0,"are identical"],[11410,28,""],[11410,0,"performance"],[11389,0," the performance differences "],[11394,24,""],[11393,1,""],[11366,59,""],[12130,6,""],[12130,0," Implemented like this, the automerge and yjs's performance"],[12130,59,""],[12130,0,"I made"],[12130,6,""],[12129,1,""],[12129,0,"\n"],[12690,5,""],[12724,1,""],[12724,0," too."],[12130,0,"B"],[12130,1,""],[12130,0,"In this codebase I have an implementation of ys"],[12176,1,""],[12175,1,""],[12175,0,"both RGA (au"],[12186,1,""],[12185,1,""],[12184,1,""],[12175,0,"the sma"],[12181,1,""],[12180,1,""],[12180,0,"emantics of "],[12201,0,"(automerge) and yjs ("],[12221,1,""],[12220,1,""],[12219,1,""],[12218,1,""],[12217,1,""],[12217,0,"YATA (js"],[12224,1,""],[12223,1,""],[12223,0,"yjs). But "],[12229,4,""],[12229,0,"They have identical performance."],[12229,0,"But "],[12233,19,""],[12233,0,"the"],[12248,0," is identical anyway"],[12261,7,""],[12249,0,"in this test "],[12277,0,"How fast? "],[12277,10,""],[12990,19,""],[12990,0,"There are two"],[13040,9,""],[13040,0,"code"],[13122,0,"\n\nIts t"],[13128,1,""],[13127,1,""],[13126,1,""],[13125,1,""],[13124,1,""],[13123,1,""],[13122,1,""],[13044,0," we need to fix"],[13139,0,"L"],[13139,1,""],[13139,0,"Lets say "],[13148,1,""],[13148,0,"w"],[13194,33,""],[13194,0,"S"],[13193,45,""],[13489,0,"\n Some of those items might have been deleted:"],[13490,1,""],[13490,0,"\nNote that "],[13501,1,""],[13501,0,"s"],[13544,1,""],[13544,0,", so I've added an `isDeleted` flag to mark them s"],[13593,1,""],[13593,0,"as such."],[13579,22,""],[13579,0,"."],[13579,0," to mark which ones"],[13599,0," We can't just remove them from the array because other peers might insert a"],[13655,20,""],[13655,0,"inserts might depend on them. (Oops)"],[13690,0,"!"],[13686,0,"Dang"],[13690,4,""],[13692,0,". "],[13693,1,""],[13692,1,""],[13686,4,""],[13686,0,"Drat"],[13691,0," But lets not worry about that for now."],[13695,6,""],[13695,0," I'm "],[13721,7,""],[13721,0,"in this post"],[13491,11,""],[13491,0,"S"],[13873,0," in my array"],[13753,1,""],[13753,0,"5"],[13771,0,". M"],[13773,1,""],[13772,1,""],[13771,1,""],[13771,0,", representing 100 00 "],[13792,1,""],[13792,0,"0 items which haven't been deleted."],[13827,5,""],[13759,0," array"],[13800,5,""],[13800,0,"characters"],[13839,1,""],[13839,0,"If t"],[13898,0,"document "],[13898,0,"*"],[13916,0,"*"],[13925,1,""],[13925,0,","],[13927,1,""],[13927,0,"w"],[13932,9,""],[13945,1,""],[13944,1,""],[13944,0,"our document"],[13948,8,""],[13947,1,""],[13955,0,"To find out, "],[13968,1,""],[13968,0,"w"],[13972,1,""],[13971,1,""],[13970,1,""],[14043,24,""],[14043,0," the right array location"],[14069,91,""],[14071,0,"So "],[14074,1,""],[14074,0,"i"],[14147,5,""],[14146,1,""],[14160,0,"or something "],[14262,0,", which is double yikes"],[14347,14,""],[14375,1,""],[14375,0,"5"],[14983,20,""],[14983,0,"I"],[15691,23,""],[15690,5,""],[15694,0," extra optimizatoin"],[15713,11,""],[15712,1,""],[15711,1,""],[15710,1,""],[15710,0,"ion here"],[15685,5,""],[15685,0," does"],[15720,0,"Because "],[15728,1,""],[15728,0,"h"],[15761,1,""],[15761,0,","],[15763,1,""],[15763,0,"i"],[15763,4,""],[15763,0,"when we"],[15783,0," in a document"],[16409,0,"\n\nSemantically this is the s"],[16436,1,""],[16435,1,""],[16434,1,""],[16433,1,""],[16432,1,""],[16432,0,"equivalent to the expanded version above - but the p"],[16483,1,""],[16483,0,"id, seq and parents of the internal elements is implicif"],[16538,1,""],[16538,0,"c"],[16538,1,""],[16538,0,"t."],[16539,0," when "],[16544,1,""],[16543,1,""],[16542,1,""],[16541,1,""],[16540,1,""],[16539,1,""],[16540,9,""],[16540,0," So"],[16557,0," we"],[16609,0," or something like that"],[16709,1,""],[16709,0,"\n\n"],[16710,1,""],[16709,1,""],[16709,0," "],[16710,5,""],[16710,0,"Yjs"],[16733,0,"s"],[16809,3,""],[16809,0,"these"],[16820,0," - since the id and sequence numbesr won'"],[16849,12,""],[16849,0,"numbers "],[16856,1,""],[16856,0," won'tli"],[16863,1,""],[16862,1,""],[16862,0," line up"],[16871,1,""],[16871,0,"\n\n"],[16873,14,""],[16873,0,"In our"],[17652,10,""],[17652,0,"I "],[17653,1,""],[17652,1,""],[17652,0,"Kevin says"],[17701,5,""],[17700,1,""],[17721,0," find the fas"],[17722,12,""],[17722,0,"make this code run so fast"],[17748,22,""],[17748,0,"."],[17721,0," figure out "],[17722,11,""],[17721,1,""],[18480,33,""],[18479,1,""],[18485,0," knows this now too, and he's"],[18514,3,""],[18526,10,""],[18523,3,""],[18523,0,"my approach in turn."],[18543,1,""],[18543,0," He's now"],[18552,4,""],[18600,28,""],[18600,0," which "],[18601,6,""],[18601,0,"to see if he can beat me in perfora"],[18635,1,""],[18634,1,""],[18634,0,"rmance."],[18515,37,""],[18514,1,""],[18806,0," with all the parts separate "],[18834,1,""],[18834,0," "],[18834,1,""],[18834,0,"d by pointers"],[26293,0,"So "],[26631,0," much"],[26783,15,""],[26783,0,"That was a mistake"],[26847,12,""],[26846,1,""],[27342,0," we can give"],[27354,4,""],[27354,0," to"],[27403,0," Some people are great parents. I"],[27404,0,"("],[27404,1,""],[27436,0," lok"],[27439,1,""],[27438,1,""],[27438,0,"ike performance."],[27442,0,"ob"],[27443,1,""],[27442,1,""],[27442,0,"thinking about "],[27457,11,""],[27457,0,"software performance tuning"],[27441,16,""],[27441,0," "],[27442,21,""],[27448,0," software"],[27442,7,""],[27442,0,"making "],[27457,0," o"],[27458,1,""],[27458,0,"o"],[27458,1,""],[27458,0,"go really fast"],[27435,0,"Me? "],[27440,5,""],[27440,0," can"],[27450,1,""],[27449,1,""],[27448,1,""],[27448,0,"e"],[27435,4,""],[27435,0,"Thats great, but "],[27659,4,""],[27659,0,"making "],[27665,1,""],[27664,1,""],[27663,1,""],[27662,1,""],[27662,0,"e this"],[27675,1,""],[27674,1,""],[27673,1,""],[27673,0," fast"],[27693,24,""],[27693,0,"Instead of entering"],[27704,8,""],[27704,0,"doing that work"],[27721,0," "],[27721,1,""],[27720,1,""],[27719,1,""],[27719,0,", I was sbu"],[27729,1,""],[27728,1,""],[27728,0,"b"],[27728,1,""],[27727,1,""],[27727,0,"busy and"],[27840,0," and bring it back"],[27884,0," Practical "],[27896,1,""],[27895,1,""],[27895,0,"d"],[27940,1,""],[27940,0,"\n\n"],[27941,1,""],[27940,1,""],[27940,0," "],[27452,10,""],[27452,0,"check out hos"],[27464,1,""],[27464,0,"w fast I can mek"],[27479,1,""],[27478,1,""],[27478,0,"ake"],[27493,13,""],[27493,0,"!"],[27482,8,""],[27482,0,"CRDTs"],[27404,0,"("],[27492,0,")"],[27509,7,""],[27609,40,""],[28413,0," Yjs already runs fast and eventua"],[28440,7,""],[28440,0,"soon it will "],[28448,5,""],[28448,0,"should become even faster."],[28492,0,"*"],[28499,0,"*"],[28793,0," Kevin has got this."],[28993,1,""],[28993,0,", which does this stuff on top p"],[29024,1,""],[29024,0,"of OT."],[29312,0,"Yes, I know. "],[29325,5,""],[29325,0,"I've made a few gl"],[29342,1,""],[29341,1,""],[29341,17,""],[29356,11,""],[29356,0," which"],[33169,0," Ther "],[33174,1,""],[33174,0,"e are e"],[33180,1,""],[33180,0,"better aprpoa"],[33192,1,""],[33191,1,""],[33190,1,""],[33189,1,""],[33189,0,"proaches to doing this sort of thing on top of a database, but"],[33251,2,""],[33251,0," "],[33252,1,""],[33252,0,"a"],[33311,0,"all at "],[32999,36,""],[32999,0,"This is s"],[33007,1,""],[33007,0,"the workflow that "],[33025,17,""],[33025,0,"y"],[33025,1,""],[33011,0,"cure"],[33014,1,""],[33014,0,"rentl"],[33018,1,""],[33017,1,""],[33017,0,"t "],[33018,1,""],[33018,0,"ly recommended "],[33042,4,""],[33042,0,"for"],[33045,1,""],[33046,0,"the "],[33086,6,""],[33090,11,""],[33091,10,""],[33091,0,"collaborative"],[33124,14,""],[33051,1,""],[33051,0,"5"],[33167,48,""],[33166,1,""],[33166,0," -"],[33168,1,""],[33235,15,""],[33235,0,". Help!"],[33241,1,""],[33241,0," please!"],[33237,0,"We could use yur"],[33252,1,""],[33251,1,""],[33251,0,"our "],[33255,1,""],[33255,0,"h"],[33259,7,""],[25654,0," This is fast enough to saturate 100mb"],[25691,1,""],[25690,1,""],[25690,0," "],[25687,4,""],[25687,0,"me"],[25688,1,""],[25687,1,""],[25687,0,"100 megabit ethernet."],[25678,0,"be "],[25675,35,""],[25675,0,"that my h"],[25683,1,""],[25682,1,""],[25681,1,""],[25680,1,""],[25668,12,""],[25667,1,""],[25667,0,"er than the fiber ethernet comin "],[25699,1,""],[25699,0,"g into my apartment"],[25719,1,""],[25719,0,"\n\n"],[25783,0,"And "],[25787,1,""],[25787,0,"o"],[25789,0,"!"],[25789,0," look"],[25794,6,""],[25835,0,"It l"],[25838,1,""],[25837,1,""],[25836,1,""],[25835,1,""],[26003,0,"*"],[26008,0,"*"],[33468,5,""],[33468,0,"addressed"],[33517,0," Or ignored (eg g"],[33533,1,""],[33533,0,"Git)"],[33536,0," grows forever and nobody cares"],[33568,0,".\n\n"],[33571,4,""],[33571,0,"But thats orthogonal "],[33591,1,""],[33591,0," to everything"],[33605,52,""],[33521,0,"you could just ignore it like git does"],[33559,47,""],[33560,0," Nobody seems to mind too much."],[33560,31,""],[33536,0,"mostly "],[33566,0," - nobody seems to care that their git repos grow without bound, forever"],[33811,0,"Gosh, "],[33817,1,""],[33817,0,"l"],[0,1,""],[27,0,"list "],[17,30,""],[17,0,"Making collaborative editing "],[51,0," faster"],[1856,9,""],[1855,1,""],[1854,1,""],[1853,1,""],[1853,0,"OT"],[1853,2,""],[1853,0,"operational transform"],[1852,0," sompe"],[1857,1,""],[1856,1,""],[1856,0,"e particular"],[1891,0,"algorithm "],[2299,0," But were the academics using the slow version or th "],[2351,1,""],[2351,0,"e fast e"],[2358,1,""],[2358,0,"version"],[2299,1,""],[2299,0,"\n\n"],[2366,0,"? Were they "],[2368,10,""],[2368,0,"did "],[2368,4,""],[2368,0,"id"],[2369,1,""],[2368,1,""],[2368,0,"Did they have fast versions of some algorithms and slow versions of ther"],[2439,1,""],[2438,1,""],[2437,1,""],[2436,1,""],[2436,0,"others, which might mess up their results? Its impiss"],[2488,1,""],[2487,1,""],[2486,1,""],[2486,0,"ossible"],[2479,3,""],[2479,0,"Reading the "],[2479,12,""],[2479,0,"Its"],[2493,0," to tell1"],[2501,1,""],[2501,0,"!"],[2479,3,""],[2479,0,"From the paper, its"],[2917,1,""],[2917,0,"."],[23861,0,"T"],[23861,1,""],[23861,0,"See, i"],[23867,1,""],[23867,0,"i"],[23867,1,""],[23877,0," actually"],[24156,0," // negative = deleted."],[24178,1,""],[24178,0," content"],[24110,6,""],[24110,0,"l"],[24060,6,""],[24060,0,"l"],[24106,0,"e"],[24061,0,"e"],[24108,0,"n"],[24062,0,"n"],[24163,0,"len "],[24322,0,"For"],[24324,1,""],[24323,1,""],[24322,1,""],[24402,0," for this"],[24469,0,"just "],[24502,1,""],[24502,0,"\n\n"],[24516,4,""],[24516,0," "],[24516,1,""],[24515,1,""],[24515,0,"universally a"],[24663,25,""],[24663,0,"So using ropey"],[24666,6,""],[24666,0,"with "],[24676,0,", we use less RAM."],[24712,10,""],[24714,0," now"],[24788,0,"more "],[24792,1,""],[24791,1,""],[24790,1,""],[24789,1,""],[24788,1,""],[24788,0,"2+x"],[24790,1,""],[24789,1,""],[24788,1,""],[24788,0,"more than twice as "],[24813,0,","],[24813,1,""],[24812,1,""],[24811,1,""],[24811,0,", and it makes the wasm bundle"],[24841,50,""],[24841,0," twice as big ("],[24856,1,""],[24862,1,""],[24861,1,""],[24861,0,"->"],[24869,0,")"],[24873,0,"So "],[25936,0," This is kind of uselesss"],[25960,1,""],[25960,0,", but its now"],[26060,14,""],[26056,4,""],[26056,0,"my internet connection"],[26078,25,""],[26036,7,""],[26036,0,"I can process edits"],[26049,6,""],[26041,8,""],[26037,4,""],[26036,1,""],[26036,0,"This is"],[26036,7,""],[26036,0,"Its"],[26036,39,""],[26036,0,"This could saturate "],[26036,20,""],[26036,0,"I could saturate my internet connection and have CPU to spare."],[26076,0,"with this "],[26260,36,""],[26260,0," by interleaving b"],[26277,1,""],[26277,0,"the b-treeu "],[26288,1,""],[26287,1,""],[26287,0," updates"],[26330,57,""],[26330,0,"whic"],[26333,1,""],[26332,1,""],[26331,1,""],[26330,1,""],[26330,0," which should work"],[26351,0," just"],[26331,0,"in my future "],[26349,20,""],[26349,0,"brings "],[26355,1,""],[26354,1,""],[26353,1,""],[26352,1,""],[26351,1,""],[26350,1,""],[26349,1,""],[26349,0," brings that 54"],[26363,1,""],[26362,1,""],[26362,0,"65ms down to"],[27443,0," to invent"],[27453,35,""],[28101,13,""],[28206,0,"(super fast CRDTs) "],[28252,9,""],[28251,1,""],[28251,0," have "],[28264,0," "],[28264,1,""],[28264,0," S"],[28265,1,""],[28264,1,""],[28341,0," next"],[28493,4,""],[28496,34,""],[29223,5,""],[29233,21,""],[29233,0," instead of document semantics"],[29393,25,""],[29392,1,""],[29392,0," uss"],[29395,1,""],[29395,0,"es"],[31062,12,""],[31062,0,"And "],[31065,1,""],[31064,1,""],[31063,1,""],[31062,1,""],[31061,1,""],[31060,1,""],[31060,0,", and h"],[31066,1,""],[31139,9,""],[31139,0,"something"],[31131,0,"It would add complexity, but"],[31131,28,""],[33990,1,""],[33989,1,""],[34100,7,""],[34100,0,"L"],[0,0,"\n\n"],[0,0,"> R"],[2,1,""],[2,0,"DRAFT: Needs diagrams before publishing."],[23,0,", maybe some tidy up"],[62,0," Don't share the link too widelyp"],[94,1,""],[94,0," please! This isn't ready for N"],[124,1,""],[124,0,"HN."],[34114,0,"\n\n### on"],[34121,1,""],[34120,1,""],[34120,0,"All of thee "],[34131,1,""],[34130,1,""],[34130,0,"se benchmarks show the e"],[34153,1,""],[34153,0,"result from multip"],[34170,1,""],[34169,1,""],[34169,0,"iple changes\n\n"],[34119,0," This doesn't "],[34120,13,""],[34119,1,""],[34120,61,""],[34120,0,"You have too many variables changing"],[34115,0,"\n"],[34159,0,"Yeah, well spotted. Each of these tests changes multiple ve"],[34217,1,""],[34217,0,"ariables. Maybe my d"],[34236,1,""],[34236,0,"reference implementation is faster than automerge simply "],[34159,134,""],[34159,0,"Yeah, well spotted. Each of these tests changes multiple variables. Maybe my reference implementation is faster than automerge simply"],[33271,0," whole data "],[33282,1,""],[33282,0,"base full of"],[33294,5,""],[33299,0,"s"],[33300,7,""],[33314,0,"I want to be able to update a single itme"],[33354,1,""],[33353,1,""],[33353,0,"em quickly."],[33364,84,""],[33364,0," With yjs and automerge today you need to:"],[33510,0,"\nThis is going to be awuf"],[33534,1,""],[33533,1,""],[33533,0,"fully slow, "],[33544,1,""],[33543,1,""],[33364,0,"\n\n"],[33366,1,""],[33259,0," Most applications aren "],[33282,1,""],[33282,0,"'t collaborative text edti"],[33307,1,""],[33306,1,""],[33306,0,"itors."],[33416,1,""],[33312,0," "],[33312,1,""],[33312,0," Most aapps"],[33318,5,""],[33318,0,"apps have lots of small objects which are each "],[33360,5,""],[33360,0,"rarely written to."],[33313,65,""],[33312,1,""],[33311,0,", where there's one document l"],[33340,1,""],[33340,0,"you can load once, keep open and then e"],[33378,1,""],[33378,0,"save"],[33311,71,""],[33311,0,". Intea"],[33317,1,""],[33316,1,""],[33315,1,""],[33315,0,"stead they have ad"],[33332,1,""],[33331,1,""],[33331,0,"databases full"],[33321,0,"most apps "],[33331,5,""],[33350,0," of tiny objects, each of which is almost never"],[33385,12,""],[33385,0,"very rarely written to"],[33408,1,""],[33408,0,"\n\n"],[33410,104,""],[33409,1,""],[33408,1,""],[33408,0,"j"],[33408,1,""],[33408,0,"\n"],[33409,1,""],[33408,1,""],[33408,0," "],[33587,0,"."],[33588,140,""],[33616,0," than this"],[33681,8,""],[33661,14,""],[33661,0,"working on "],[33671,1,""],[33735,5,""],[33735,0," at"],[33746,0," here"],[31861,0," much"],[33172,0," other"],[33178,9,""],[33178,0," perof"],[33183,1,""],[33182,1,""],[33182,0,"formance measure"],[33252,0," how"],[33255,1,""],[33254,1,""],[33253,1,""],[33252,1,""],[33335,22,""],[33335,0,"Usually we"],[33343,2,""],[33343,0,"applications have"],[33391,1,""],[33391,0,". Each "],[33398,6,""],[33400,0," those objects"],[33414,6,""],[33441,1,""],[33441,0,"\n\nIf you want to update a single object in da "],[33486,1,""],[33485,1,""],[33485,0," "],[33485,1,""],[33484,1,""],[33484,0,"a data "],[33490,1,""],[33490,0,"base "],[33495,4,""],[33494,1,""],[33499,3,""],[33499,0,"or"],[33517,0,","],[33517,1,""],[34348,48,""],[34348,0,"Wh"],[34348,2,""],[34348,0,"Holy cow, automerge's javascript is really slow!"],[427,0," ("],[428,1,""],[427,1,""],[427,0," (wow"],[431,1,""],[430,1,""],[429,1,""],[429,0,"wow, "],[433,1,""],[432,1,""],[431,1,""],[430,1,""],[429,1,""],[429,0,"Wow, yess!)"],[248,1,""],[248,0,"\n\n"],[928,53,""],[928,0," - something was fishy here"],[929,0,"at the paper to see what was going on "],[969,0,"because "],[1003,0,"It turns out "],[1016,1,""],[1016,0,"w"],[1003,14,""],[1003,0,"In their paper w"],[1366,11,""],[1366,0," implementation"],[1362,4,""],[1362,0,"this particular"],[1362,4,""],[1362,0,"their"],[1395,0," Written in a "],[1404,5,""],[1404,0,"up as Science Paper"],[1410,0,"ub"],[1411,1,""],[1410,1,""],[1410,0,"PUbli"],[1414,1,""],[1413,1,""],[1412,1,""],[1411,1,""],[1411,0,"ublished "],[1433,0," it makes people think this"],[798,10,""],[798,0,"hang on -"],[807,1,""],[798,0,"- "],[881,6,""],[881,0,"W"],[937,24,""],[936,1,""],[1366,65,""],[1366,0,"\n"],[903,463,""],[903,0,"I took a closer look at the paper - because something was fishy here. In their paper when a user pasted a big chunk of text (say, 1000 characters), instead of creating 1 operation with 1000 characters, their code split the insert into 1000 operations. And each of those inserts needed to be processed separately. Duh - of course it'll be slow if you do that! This isn't a problem with the algorithm. This is just a problem with *their particular implementation*."],[1478,0," Written up as Published Science Paper it makes people think this\n"],[1479,0,"?Be"],[1481,1,""],[1480,1,""],[1479,1,""],[1479,0,"Because, "],[1488,1,""],[1488,0,"w"],[1552,0," is a Fact rather than a "],[1563,14,""],[1563,0,"Of The Universe rather than a "],[1592,1,""],[1592,0,"n implemetnation de"],[1594,17,""],[1594,0,"implementation detail of some "],[1367,257,""],[1367,0,"I wouldn't mind so much if I didn't have so many people flipping me a link to the paper and asking me about it. Because, written up as Published Science Paper it makes people think this is a Fact Of The Universe rather than an implementation detail of some"],[1623,1,""],[1623,0,"\n"],[1616,7,""],[1616,0,"in some "],[1616,8,""],[1616,0,"of some code write"],[1633,1,""],[1633,0,"ten by a "],[1641,1,""],[1641,0,"n overworked researcher."],[1666,0,"\n"],[1423,11,""],[1423,0,"sending"],[1423,10,""],[1427,0,"ing"],[1430,3,""],[1444,0," (pointedly)"],[1467,5,""],[1467,0,"what I think about"],[1490,10,""],[1490,0,"W"],[1669,0,"So, "],[1674,1,""],[1673,1,""],[1673,0,"n"],[1676,0," "],[1677,14,""],[1677,0,"the sci"],[1677,7,""],[1677,0,"The science isn't real! I'm"],[1703,1,""],[1702,1,""],[1701,1,""],[1700,1,""],[1695,5,""],[1695,0,"right! Please believe me!"],[1669,5,""],[1669,0,"N"],[1671,0,"oo"],[1693,5,""],[1693,0,"real"],[2349,13,""],[2362,0,"\n\nAnd differen"],[2375,1,""],[2375,0,"ent"],[2377,1,""],[2376,1,""],[2375,1,""],[2364,11,""],[2363,1,""],[2362,1,""],[2738,0," of this code"],[2938,1,""],[2950,49,""],[3018,0,"["],[3050,0,"]((https://josephg.com/blog/crdts-are-the-future/)). And maybe other kinds of f"],[3128,1,""],[3128,0,"sof"],[3113,18,""],[3113,0,"all our software - but I'm not ready to talk about that yet"],[3185,0,"today "],[3185,6,""],[3185,0,"you read about in academic papers "],[3799,0," "],[3799,1,""],[3799,0," Martin Kleppmann"],[4142,0," currently"],[4201,0,"ward"],[4245,4,""],[4245,0,"we need to "],[4255,1,""],[3799,17,""],[5034,0,"you "],[5045,9,""],[5045,0,"into th ed"],[5054,1,""],[5053,1,""],[5053,0,"e"],[5053,1,""],[5052,1,""],[5052,0,"e document"],[5896,0,", and the user *clearly* inserted before"],[5898,38,""],[5898,0,"even though the user inserted before the 'b'*"],[5939,0,"*"],[5940,1,""],[5941,1,""],[5890,1,""],[5890,0,"*"],[5895,1,""],[5895,0,"*"],[5943,1,""],[5943,0,"\n\n"],[6506,0,"\n"],[6506,0,"\nFor reference, Yjs "],[6507,15,""],[6507,0,"(Aside: "],[6519,0,"solves this with a *different* hack; but the difference isn't really importnat"],[6596,1,""],[6595,1,""],[6594,1,""],[6594,0,"ant)"],[6597,0,"."],[6581,6,""],[6581,0,"actually"],[6581,8,""],[6580,1,""],[6590,0," here"],[6518,0," is identical, except that it"],[6559,0," problem"],[6591,1,""],[6591,0,"."],[6592,6,""],[6592,0," T"],[6587,4,""],[6587,0,"tweak"],[6515,0,"If you're curious, "],[6550,1,""],[6550,0,","],[6515,19,""],[6587,5,""],[6587,0,"hack"],[6587,4,""],[6587,0,"trick"],[5974,13,""],[5974,0,"neat hack"],[6583,5,""],[6583,0,"hack"],[7457,0," wh"],[7459,1,""],[7459,0,"hile writing a p"],[7457,18,""],[7712,0,", so I'm no t"],[7724,1,""],[7723,1,""],[7723,0,"t too worried"],[7769,5,""],[7769,0," taken to "],[7778,1,""],[7786,1,""],[7785,1,""],[7784,1,""],[8504,0," not"],[8508,6,""],[8508,0," "],[8508,1,""],[8438,0," editing trace"],[8455,0," a javascript string"],[8475,11,""],[8484,33,""],[8486,0,"we can't merge concud"],[8506,1,""],[8506,0,"rrent edits but"],[8521,43,""],[8521,0," its "],[8525,1,""],[8521,4,""],[8521,0,"it might not concurrent edits but its slow:"],[8517,4,""],[8511,6,""],[8506,5,""],[8506,0,"d"],[8500,7,""],[8494,6,""],[8488,6,""],[8486,2,""],[8484,0,", using a javascript string, well"],[8475,0," javascript"],[8468,7,""],[8457,11,""],[8455,2,""],[8446,6,""],[8438,8,""],[8508,0," "],[8508,1,""],[8508,0," allow"],[8504,4,""],[7784,0,"ing"],[7784,3,""],[8504,0," not"],[8504,4,""],[8504,0," not"],[8508,6,""],[8508,0," "],[8508,1,""],[8438,0," editing trace"],[8455,0," a javascript string"],[8475,11,""],[8484,33,""],[8486,0,"we can't merge concud"],[8506,1,""],[8506,0,"rrent edits but"],[8521,43,""],[8521,0," its "],[8517,9,""],[8517,0,". But its a lt"],[8530,1,""],[8530,0,"ot faster:"],[8853,25,""],[8853,0,"A tree is "],[8862,1,""],[8855,9,""],[8855,0,"T"],[8853,3,""],[8853,0,"The d"],[8871,1,""],[8871,0," "],[8871,1,""],[8857,0,"tree based "],[8882,0," isn't very fast"],[9409,0," "],[9409,1,""],[9420,19,""],[9420,0," does that"],[8882,16,""],[8882,0," automerge uses gets big and slow"],[8906,14,""],[8903,3,""],[8903,0,"huge"],[9900,16,""],[9900,0,"the"],[9918,0," has the right approach"],[10016,0,". Fix the core algorihtm and"],[10031,13,""],[10031,0,"an"],[10032,1,""],[10032,0,"lgorithm and data "],[10049,1,""],[10049,0,"structures"],[10049,0," "],[10060,0,". Then "],[10062,5,""],[10062,0,"b"],[10062,1,""],[10061,1,""],[10060,1,""],[10060,0," before moving to optimizing individual methods"],[10137,4,""],[10137,0,"a function"],[10153,6,""],[10153,0,"it won't survive"],[10161,8,""],[10155,6,""],[10153,2,""],[10153,0,"you're"],[10195,0," anyway"],[10205,0,"But by far, "],[10292,7,""],[10292,0,"replaci"],[10298,1,""],[10298,0,"e it with something faster."],[12009,4,""],[12009,0,"in the same way"],[12076,4,""],[12076,0,"once"],[12085,2,""],[12085,0,"understand it"],[12108,2,""],[12108,0,"implement"],[12319,0,"'re curious and"],[12339,22,""],[12351,0,"s"],[12351,1,""],[12225,0,", both in the same"],[12225,18,""],[13286,4,""],[13286,0,"my reference-crdts"],[13342,16,""],[13341,1,""],[13427,0,"Its not exactly like-for-like - I'mn"],[13462,1,""],[13462,0," not impleenting "],[13459,20,""],[13459,0,"my o"],[13462,1,""],[13462,0,"implementi"],[13471,1,""],[13471,0,"ation also doe"],[13477,8,""],[13477,0,"doesn't use immutablejs. But"],[13505,4,""],[13505,0," my code, using t"],[13521,1,""],[13520,1,""],[13520,0," this"],[13534,0,","],[13536,3,""],[13536,0,"ends up "],[13560,1,""],[13560,0,". Its also"],[13570,9,""],[13911,215,""],[13459,0,"for example, "],[13573,0," than automerge"],[14107,0,"base"],[14760,0," going to"],[14782,17,""],[14782,0,"(*"],[14783,1,""],[14782,1,""],[14782,0,"("],[14782,1,""],[14782,0,"*jere"],[14786,1,""],[14785,1,""],[14784,1,""],[14783,1,""],[14783,0,"here*"],[14753,37,""],[14753,0,"thats a problem for another day.)"],[15209,1,""],[15208,1,""],[15208,0,"75"],[15826,0,"Wait, no - "],[15837,6,""],[15878,22,""],[15878,0," stick around"],[16011,0,"The a"],[16015,1,""],[16015,0,"system starts off fast, but it gets slower with every keystroke"],[16078,27,""],[16011,4,""],[16011,0,"This "],[16126,0,"\n\n"],[16127,1,""],[16127,0,"> Insert diagram"],[16136,0,"n^2 "],[16147,0,"?"],[16129,7,""],[16129,0,"Can has, "],[16737,0,". This is faster"],[16753,2,""],[16788,0," "],[16788,1,""],[16781,0,"you to "],[16794,15,""],[16197,0," And by we, I mean yjs has fixed these problems. So l"],[16249,1,""],[16249,0,"what did it do?"],[16246,17,""],[16246,0,"How did it mak"],[16257,3,""],[16257,0,"do that"],[16355,0,"Yjs "],[16359,7,""],[16364,0,"s"],[16437,0,"ever"],[16437,4,""],[16454,9,""],[16454,0,"the document"],[16477,0," try to"],[16478,6,""],[16477,1,""],[16485,0,"something later"],[16500,5,""],[16505,13,""],[16504,1,""],[16503,1,""],[16502,1,""],[16502,0,"they probably"],[16506,0,"'ll"],[16558,0,". So the system"],[16573,4,""],[16583,0,"s"],[16574,0,"usually "],[16593,6,""],[16619,5,""],[16619,0,"the cached location"],[16639,1,""],[16639,0,"\n\n"],[16640,1,""],[16639,1,""],[16639,0," "],[16670,0," (and it probably owu"],[16690,1,""],[16689,1,""],[16689,0,"wo"],[16690,1,""],[16689,1,""],[16689,0,"wo"],[16690,1,""],[16689,1,""],[16688,1,""],[16688,0,"wouldn't work as well for non-text-editing applications)"],[16745,1,""],[16744,1,""],[16744,0,". B"],[16747,1,""],[17740,0," \""],[17741,1,""],[17740,1,""],[17739,1,""],[17738,1,""],[17738,0,"\"run\" is"],[17742,1,""],[17738,1,""],[17720,42,""],[17720,0,"This is  j"],[17729,1,""],[17728,1,""],[17728,0,"just a compressed version of what we wrote"],[17770,17,""],[17776,0,"."],[17778,7,""],[17778,0,"T"],[17805,0,"all "],[17842,0," "],[17842,1,""],[17842,0,". ("],[17844,1,""],[17843,1,""],[17843,0," (We assume each parent is the"],[17855,18,""],[17855,0,"the ids got up"],[17868,1,""],[17867,1,""],[17866,1,""],[17865,1,""],[17865,0," up by 1 each time, and each item has thepre"],[17908,1,""],[17907,1,""],[17906,1,""],[17906,0," previous item as a"],[17898,27,""],[17898,0,"'s parent is the previous item)"],[18109,15,""],[18109,0,"needs"],[18201,1,""],[18200,1,""],[18200,0,","],[18201,49,""],[18201,0," "],[18157,0,"later "],[18208,0,"so the logic is a bit complex."],[18240,0,"But "],[18244,1,""],[18244,0,"i"],[18260,0,"ing"],[18247,4,""],[18247,0,"this "],[18269,0," set"],[18324,4,""],[18324,0,"array"],[18356,1,""],[18355,1,""],[18354,1,""],[18353,1,""],[18352,1,""],[18351,1,""],[18998,0,", but"],[19003,3,""],[19003,0," i"],[19958,4,""],[19958,0,"reclaim"],[19965,6,""],[19965,0," the"],[19958,11,""],[19958,0,"claim the "],[19967,1,""],[19979,0," crown back"],[21597,12,""],[21597,0,"so rarely"],[21647,0,"*"],[21686,0,"*"],[21789,0,". n"],[21791,1,""],[21790,1,""],[21790,0," And this code will be used"],[21805,12,""],[21805,0,"should be fast for intera"],[21824,6,""],[21824,0,"stuf "],[21828,1,""],[21824,4,""],[21824,0,"non-text e"],[21833,1,""],[21832,1,""],[21832,0,"-editing tasks."],[21847,5,""],[21847,0,"I"],[21848,2,""],[21869,0," have to"],[21880,0," one of"],[21899,5,""],[21899,0,"document "],[22150,4,""],[22150,0,"your"],[22208,0,", just from "],[22208,12,""],[22297,0," in the last few years"],[22324,16,""],[22365,0,", even we"],[22373,1,""],[22373,0,"hen making webpages"],[22356,10,""],[22356,0,"."],[22358,1,""],[22358,0,"E"],[22383,1,""],[22383,0,","],[22385,1,""],[22385,0,"w"],[22404,1,""],[22404,0,"!"],[23036,0," that means wec"],[23050,1,""],[23050,0," can find any ti"],[23065,1,""],[23064,1,""],[23064,0,"item in"],[23071,19,""],[23071,0," about"],[23085,0," from main memory"],[23102,17,""],[23115,3,""],[23158,0,"."],[23160,16,""],[23160,0,"Again,"],[23214,0,"shuffling everything in a "],[23240,5,""],[23554,1,""],[23553,1,""],[23552,1,""],[23551,1,""],[23551,0," it uet"],[23557,1,""],[23556,1,""],[23555,1,""],[23555,0,"yet."],[23651,0,"Each leaf noe"],[23663,1,""],[23663,0,"de in my b-tree "],[23679,4,""],[23685,1,""],[23684,1,""],[23683,1,""],[23683,0,"es"],[23685,26,""],[23696,18,""],[23696,0,", all "],[23696,6,""],[23686,0,"a block of "],[23707,0,", all packed together in memory"],[23898,9,""],[23898,0,"clock cycle"],[23909,1,""],[23909,0,". Not"],[23914,14,""],[27669,13,""],[27886,3,""],[27886,0,"but we're"],[27869,5,""],[27869,0,"our"],[27881,1,""],[27881,0,"ies"],[27889,6,""],[27869,4,""],[27869,0,"what we"],[27876,11,""],[27876,0," obsess over"],[27927,0," I can code p"],[27939,1,""],[27939,0,"well enough "],[27950,1,""],[27950,0,", but do't"],[27959,1,""],[27958,1,""],[27958,0,"n't"],[27956,5,""],[27956,0,"I still get zuccini and cucubmer "],[27988,1,""],[27987,1,""],[27986,1,""],[27985,1,""],[27984,1,""],[27984,0,"mber mixed up"],[27971,1,""],[27971,0,"h"],[27971,1,""],[27971,0,"c"],[27857,0,"."],[27859,1,""],[27859,0,"We're all"],[27882,0,"ever"],[27865,4,""],[28006,0,"."],[28333,9,""],[28329,4,""],[28329,0,"the algorithms were too "],[28364,22,""],[28364,0," for practical "],[28365,14,""],[28353,0,"slow and "],[28374,0,"to be practical"],[28390,74,""],[28380,9,""],[28380,0,"useful"],[28486,8,""],[28486,0,"dim"],[28488,1,""],[28488,0,"smissed "],[28545,0," writing (and"],[28557,1,""],[28556,1,""],[28555,1,""],[28554,1,""],[28553,1,""],[28546,0,"reading and "],[28543,2,""],[28543,0,"when it comes to"],[28559,20,""],[28737,6,""],[28737,0,"make"],[28767,0," work"],[29148,11,""],[29148,0,"I do well enough with my ne"],[29148,27,""],[29148,0,"But me? I don't mik"],[29166,1,""],[29166,0,"nd kids"],[29148,8,""],[29149,0,"'m ok at"],[29157,11,""],[29148,0,"M"],[29148,1,""],[29148,0,"Me? "],[29155,3,""],[29155,0," fine"],[29160,8,""],[29160,0," with kids"],[29175,0," -"],[29176,1,""],[29175,1,""],[29206,6,""],[29206,0,"p"],[29206,1,""],[29206,0,"software "],[29512,19,""],[29523,3,""],[29527,0," super fast CRDTs for the world"],[29488,8,""],[29488,0,"o"],[29488,1,""],[29488,0,"go looking for the"],[29522,0,". In th"],[29524,5,""],[29523,1,""],[29523,0," In this case,"],[29531,6,""],[29526,5,""],[29523,3,""],[29523,0," In th"],[29526,3,""],[29523,3,""],[29522,1,""],[29502,4,""],[29502,0," the"],[29522,0,"."],[29516,0,"of fast CRDTs "],[29529,54,""],[29499,0,"inside "],[28308,4,""],[28308,0,"ah"],[28309,1,""],[28309,0,"sh"],[28379,6,""],[28379,0,"practically useful"],[28492,3,""],[15839,0,"'"],[1143,0,"indivdiual "],[1143,11,""],[1143,0,"individual "],[1183,8,""],[1183,0," operations"],[1230,3,""],[1230,0,"Do'h"],[1565,0,"that these speed"],[1576,5,""],[1576,0,"benchmark s"],[1576,11,""],[1576,0,"published sp"],[1586,2,""],[1586,0,"algorithm speeds are "],[1607,7,""],[1606,1,""],[1718,0,"\""],[1767,0,"\""],[1747,0," everybody"],[1778,0,"-"],[1778,1,""],[1778,0," - but I didn't have a "],[1786,15,""],[1786,0," was nobody, "],[1798,1,""],[1797,1,""],[1797,0,"; "],[1798,1,""],[1797,1,""],[1797,0,". I didn't have a scientific "],[1815,11,""],[1815,0,"published paper justifying my claims. Just working code."],[1853,0,"("],[1872,0,"..)"],[1852,23,""],[1585,10,""],[1591,1,""],[1591,0," cmp"],[1594,1,""],[1593,1,""],[1593,0,"omparisons"],[1667,0,","],[1667,1,""],[1706,0,"university "],[1716,1,""],[1706,10,""],[3379,5,""],[3379,0,"a decade"],[3389,0,"'ve"],[3392,7,""],[3392,0," been"],[3404,1,""],[3403,1,""],[3403,0,"ing"],[3449,15,""],[3449,0,"CRDTs. That they were doomed to always be slow and unwor"],[3504,1,""],[3504,0,"rkable"],[3515,0," - and"],[3537,0," to admit"],[3048,18,""],[3048,0,"Making CRDTs"],[3048,12,""],[3048,0,"Mak"],[3050,1,""],[3049,1,""],[3048,1,""],[3048,0,"Imple"],[3046,7,""],[3045,1,""],[3044,1,""],[1438,7,""],[1438,0,"sending me links to"],[1531,0,"a "],[1556,0,","],[1557,9,""],[1673,3,""],[1673,0," in"],[1859,0," I had some "],[1866,5,""],[1866,0,"working code but - "],[1884,1,""],[1883,1,""],[1882,1,""],[1882,0," nobo"],[1883,4,""],[1883,0,"I"],[1883,1,""],[1883,0,"it felt like nobody cared about htat."],[1915,5,""],[1915,0,"that."],[1903,0,"really "],[1896,6,""],[1896,0,"none of the smart science people"],[1914,7,""],[1914,0,"computer sicnec"],[1928,1,""],[1927,1,""],[1926,1,""],[1925,1,""],[1924,1,""],[1924,0,"cience"],[1937,7,""],[1791,14,""],[1941,0," I was nobody. "],[1955,1,""],[1955,0,"\n\nAnd I "],[1960,3,""],[1960,0,", at some point around then, I dismissed CRDTs altogether. If the researchers involved "],[2038,9,""],[2038,0,"who invented them couldn't make them fast, who was I?"],[2093,0,"But "],[2097,1,""],[2097,0,"w"],[1962,20,""],[1962,0,"somewhere around that time"],[1988,6,""],[2092,0,"\n"],[2092,0,"\n---"],[2098,5,""],[2098,0,"W"],[1956,135,""],[1955,1,""],[2477,3,""],[2477,0,"show that"],[2502,22,""],[2502,0," "],[2502,1,""],[2534,12,""],[2534,0,"actually showing"],[2550,6,""],[2551,36,""],[2543,8,""],[2543,0,"proving? It seems like tests - you can prove the absence of bugs, but th"],[2614,1,""],[2613,1,""],[2592,7,""],[2592,0,"existence "],[2601,1,""],[2615,0,"not their absence. P"],[2634,1,""],[2634,0,"Benchmarks feel like that too - you can prove the "],[2680,4,""],[2680,0,"fast code is possible, but "],[2680,9,""],[2680,0,"speed ups"],[2689,3,""],[2689,0," are"],[2708,0,"you can't prove something is slow."],[2737,0,"inherently "],[3064,5,""],[3064,0,"W"],[2551,202,""],[3088,0,"\n\n It seems like tests - you can prove the existence of bugs, but not their absence. Benchmarks feel like that too - you can prove speed ups are possible, but you can't prove something is inherently slow."],[3090,14,""],[3090,0,"Maybe benchmarks"],[3090,16,""],[3090,0,"There's a rule with"],[3100,9,""],[3100,0,"saying about"],[3117,1,""],[3117,0,"ing:"],[3122,2,""],[3122,0,"\""],[3123,1,""],[3123,0,"Y"],[3160,7,""],[3159,1,""],[3158,1,""],[3158,0,". You can't "],[3123,0,"Tests can "],[3133,8,""],[3162,4,""],[3162,0,"They ca"],[3168,1,""],[3167,1,""],[3173,0,"prove"],[3192,0,"\""],[3220,4,""],[3281,29,""],[3281,0,"an algorithm will always be slow."],[3294,12,""],[3294,0,"has to "],[2477,4,""],[2477,0,"say"],[2486,15,""],[2486,0,"an"],[2477,3,""],[2476,1,""],[2475,1,""],[2474,1,""],[2474,0,"our implementation run s"],[2497,1,""],[2496,1,""],[2496,0,"s"],[2497,21,""],[2502,0,"ly"],[2537,10,""],[2538,0,"'ve"],[2556,0,"old "],[2650,3,""],[2650,0,"is"],[2683,11,""],[2682,1,""],[2705,0,"runs "],[2834,0,"\n"],[2834,0,"\nIf you ma"],[2835,9,""],[2835,0,"But if you made a chart of that \"Ot-text is fast, and ot-text is slow\""],[2835,31,""],[2835,0,"It would be silly making a chart showing how"],[2881,3,""],[2885,0,"-t"],[2886,1,""],[2886,0,"ot"],[2880,1,""],[2890,0," both"],[2900,16,""],[2900,0," and"],[2909,1,""],[2909,0,". The difference is in the implementation. And thats true here too - "],[2835,143,""],[2835,0,"It would be silly making a chart showing how text-ot is both fast and slow. The difference is in the implementation. And thats true here too -"],[1382,48,""],[1382,0,"The annoying part was when"],[1415,8,""],[1415,0," sent around"],[1427,3,""],[1463,6,""],[1463,0,"asked"],[1536,18,""],[1570,3,""],[1570,0,"seem like"],[1582,1,""],[1582,0,"f"],[1587,1,""],[1587,0,"o"],[1590,1,""],[1590,0,"t"],[1594,1,""],[1594,0,"u"],[1640,2,""],[1640,0,"of"],[1614,0," what they were"],[1628,1,""],[1627,1,""],[1626,1,""],[1625,1,""],[1625,0,"really wor"],[1634,1,""],[1633,1,""],[1633,0,"ere -"],[1672,0,"java "],[1681,0,","],[2176,5,""],[2176,0,"aspects"],[2467,66,""],[2467,0,"W"],[2467,1,""],[2467,0,"When our implementation runs slowly, what are we actually proving?"],[2504,29,""],[2504,0,"we "],[2506,1,""],[2505,1,""],[2504,1,""],[2504,0,"I don't know if t"],[2520,1,""],[2520,0,"wher"],[2523,1,""],[2522,1,""],[2521,1,""],[2521,0,"e're proving anything about the semantics."],[2553,0,"res"],[2555,1,""],[2554,1,""],[2553,1,""],[2562,0," involved"],[2504,68,""],[2504,0,"what does that mean?"],[2504,19,""],[2504,0,"is that meaningful"],[2504,18,""],[2504,0,"does that teach us anything"],[2504,27,""],[2504,0,"what should "],[2502,14,""],[2467,0,"What s"],[2472,1,""],[2472,0,"can we learn from "],[2490,23,""],[2490,0,"a slow"],[2496,12,""],[2496,0," implementation"],[2512,0," Maybe its like tests - a passing test suite doesn't prove the absence of bugs. It just proves you aren't l"],[2618,1,""],[2592,26,""],[2591,1,""],[2557,5,""],[2557,0,"cant"],[2560,1,""],[2589,0," And a slow implementation p"],[2616,1,""],[2616,0,"sa"],[2617,1,""],[2617,0,"uggests the semantics"],[2629,9,""],[2629,0,"system is slow - ut "],[2648,1,""],[2647,1,""],[2646,1,""],[2646,0,"but it only proves"],[2616,48,""],[2615,1,""],[2557,0,"suggests, but "],[2629,0," suggests, but can't prove the system will always be slow."],[2575,1,""],[2574,1,""],[2574,0," never"],[2652,1,""],[2652,0," "],[2652,1,""],[2651,1,""],[2651,0," never"],[2995,143,""],[2994,1,""],[3071,0,"Maybe its worse - maybe "],[3095,4,""],[3099,0," had"],[3103,5,""],[3178,0,"have "],[3187,0,"ed"],[3248,221,""],[1952,0,"\n"],[1952,0,"\na"],[1953,1,""],[1953,0,"Some time around then I "],[1953,24,""],[1952,1,""],[1951,1,""],[3555,0," an"],[3557,1,""],[3556,1,""],[3555,1,""],[3735,8,""],[3959,0,"And "],[3963,1,""],[3963,0,"w"],[4644,9,""],[4656,8,""],[4656,0,"?"],[5559,0,"  "],[5607,0,"    "],[5919,0,"  "],[5873,0,"  "],[5827,0,"  "],[5925,0,"  "],[6250,21,""],[6250,0,"we can't sort them bae"],[6271,1,""],[6271,0,"sed on their ID."],[6286,1,""],[6286,0,", because the X *has to* go before the b"],[6249,77,""],[6249,0," then the document might end up as"],[6802,1,""],[6801,1,""],[6801,0,"Its the algorithmic version of "],[6918,6,""],[6744,0,"  "],[6688,0,"  "],[6632,0,"  "],[6750,0,"  "],[7006,1,""],[6996,1,""],[6952,0," to RGA"],[6956,3,""],[6956,0,"a"],[6956,1,""],[6956,0,"a"],[6956,1,""],[6956,0,"RGA"],[6939,0," is im"],[6944,1,""],[6943,1,""],[6942,1,""],[6941,1,""],[6940,1,""],[6940,0,"implements a librar"],[6953,6,""],[6952,1,""],[6952,0," CRDT called YATA which"],[7038,0," slightly"],[6939,0," - which we'll see more of later -"],[7003,0,". YATA is"],[7012,9,""],[7568,0,"thats what automerge does"],[7593,2,""],[7593,0,"so"],[7588,5,""],[7578,10,""],[7573,5,""],[7568,5,""],[7801,1,""],[363,1,""],[362,1,""],[362,0,", using various "],[387,1,""],[405,2,""],[405,0,"."],[407,1,""],[407,0,"A"],[979,4,""],[978,1,""],[969,4,""],[974,0," was going on"],[986,1,""],[986,0,"n"],[1420,4,""],[1420,0,"that several"],[1444,7,""],[1444,0," me"],[1594,0,"ed"],[1624,0,". And not"],[1633,12,""],[1737,0,", rushing"],[1739,7,""],[1739,0,"who'"],[1742,1,""],[1742,0," has a bunch of im"],[1755,5,""],[1755,0,"more implementations to code up"],[1814,4,""],[1814,0,"right"],[1851,1,""],[1850,1,""],[1850,0,"."],[1852,1,""],[1852,0,"B"],[2006,0,"Who was I? "],[2031,0,"\n"],[2031,0,"\n"],[1799,0," peer reviewed"],[2046,1,""],[2045,1,""],[2673,0," quite"],[2763,0,"that this "],[2773,3,""],[2772,1,""],[2802,0,"But "],[2810,0," trie"],[2810,5,""],[2882,0,"The "],[2882,4,""],[2882,0,"I o"],[2884,1,""],[2884,0,"took the same semantis"],[2905,1,""],[2905,0,"cs, and the s"],[2917,2,""],[2917,0,"s"],[2931,0,"."],[2933,3,""],[2933,0,"B"],[3008,4,""],[3008,0,"ran"],[3221,1,""],[3221,0," was"],[3316,0," woiu"],[3320,1,""],[3319,1,""],[3318,1,""],[3318,0,"ould have totally"],[3335,11,""],[3359,1,""],[3359,0,"."],[3361,17,""],[3361,0,"I"],[3383,0," from just reading tha p"],[3406,1,""],[3405,1,""],[3404,1,""],[3404,0,"e paper"],[3414,3,""],[3414,0,"# Making CRDTs fast"],[3615,0," the future of"],[3633,4,""],[3764,5,""],[3764,0," I assumed"],[3774,19,""],[3767,0,"dismissed them, "],[3766,0," stop "],[3771,1,""],[3771,0,"ped reading papers and"],[3783,0,"academic "],[3859,10,""],[3858,1,""],[3858,0,". A GUID a"],[3867,1,""],[3867,0,"for every character? Madness!"],[3896,1,""],[3897,55,""],[3896,1,""],[4096,15,""],[4096,0," how to make those"],[4114,10,""],[4101,0,"the best way to "],[4117,14,""],[4118,15,""],[4118,0,"implement"],[4129,3,""],[6435,4,""],[6435,0,"if i"],[6438,1,""],[6438,0,"we do that"],[6481,1,""],[6482,0,"X"],[6531,0," That would be super wrong."],[6543,14,""],[6543,0,"really"],[6543,0,"be "],[6552,0," confusing"],[8248,21,""],[8248,0,"a record of"],[8250,0,"character by character "],[8273,6,""],[8273,0,"recording"],[8486,0," about that"],[8616,0,"'s"],[11050,5,""],[11050,0,"And we can "],[11190,2,""],[11190,0,"in"],[11429,0,", as we'll see soon"],[12916,8,""],[12916,0,"insert function in"],[12982,0,"'s "],[12984,1,""],[12984,0," cR"],[12986,1,""],[12985,1,""],[12985,0,"CRDT (YATA)"],[10388,0," I've been told its about 5x faster, but I haven't "],[10429,10,""],[10429,0,"I couldn't get the version in git working."],[10392,1,""],[10391,1,""],[10391,0,"m"],[10392,5,""],[1604,1,""],[1604,0,"F"],[1609,2,""],[1609,0,"bo"],[1610,1,""],[1609,1,""],[1609,0,"about"],[1609,18,""],[1609,0,"About The Universe"],[1661,3,""],[1682,0,"s"],[1715,1,""],[1715,0," probably"],[1724,11,""],[1724,0," overstretched"],[1749,1,""],[1749,0,". One of a "],[1760,11,""],[1765,5,""],[1765,0," of"],[1785,2,""],[1785,0,"they needed to"],[1760,0,"whole "],[2827,0," With time there's always"],[2828,5,""],[2828,0,"If you wait long enouu"],[2849,1,""],[2849,0,"gh "],[2851,1,""],[2851,0,", "],[2853,5,""],[2867,0," more bugs. And always bigger smart-arses with faster im"],[2909,14,""],[2909,0,"w"],[2909,1,""],[2909,0,"to "],[2890,22,""],[2890,0,"new ways to do "],[2890,15,""],[2890,0,"faster implementations."],[2915,4,""],[2991,15,""],[2991,0,"I"],[2991,1,""],[2991,0,"Each implementation has the same"],[3339,22,""],[3339,0,"M"],[3344,0,", without noticing,"],[3433,50,""],[3487,0,"\n"],[3486,0," Benchmarking is an art, not a sciecne"],[3523,1,""],[3522,1,""],[3521,1,""],[3487,34,""],[3486,1,""],[3630,1,""],[3676,1,""],[3890,1,""],[3890,0,". I"],[3902,6,""],[3902,0,"CRDTs had"],[3911,3,""],[3963,0,"Only "],[3968,1,""],[3968,0,"m"],[3975,0," comes from those tunnels"],[3993,7,""],[3993,0,"lands"],[4113,0," h"],[4114,1,""],[4114,0,"which described"],[4129,14,""],[4172,1,""],[4171,1,""],[4170,1,""],[4169,1,""],[4169,0,". And I"],[4184,1,""],[4183,1,""],[4182,1,""],[4182,0,"ed"],[4159,10,""],[4159,0,"systems"],[3963,4,""],[3963,0,"Naught but "],[3973,1,""],[3999,5,""],[3999,0,"strange lands"],[10541,42,""],[10535,6,""],[10535,0,". I ran an early benchmark and it was barely f"],[10569,12,""],[10569,0,"glig"],[10572,1,""],[10571,1,""],[10570,1,""],[10569,1,""],[10569,0,"slightly faster"],[10569,0,"only "],[10535,1,""],[10535,0,", but"],[10570,23,""],[10570,0,"performance was almost h"],[10593,1,""],[10593,0,"the same. I'm going to "],[10586,30,""],[10586,0,"remarkably close to the javascript version - so "],[10606,0,"that of "],[10636,6,""],[10636,0,"."],[10541,96,""],[10541,0,"performance in this test was almost the same as the JS version."],[10456,0," to run through wasm"],[10555,5,""],[10555,0,". I ran the "],[10555,0,", but I see similar "],[10575,12,""],[10574,1,""],[10567,8,""],[10561,0,"at the moment "],[10576,0,"'m "],[10578,1,""],[10582,0,"ing"],[10561,88,""],[10561,0,"I'm not seeing much improvement using it yet. I suspect thin"],[10620,1,""],[10619,1,""],[10619,0,"ey have some kinks to work out before its redad"],[10665,1,""],[10664,1,""],[10663,1,""],[10663,0,"ady for release."],[10616,5,""],[10616,0," it"],[10619,5,""],[10619,0," has"],[10561,44,""],[10561,0,"I couldn't"],[10563,8,""],[10562,1,""],[10561,1,""],[10561,0,"it ran slower than that in my tests"],[10568,0,"a fair bit "],[10677,1,""],[10677,0,"; and I'll hold off on adding benchmarks at"],[10719,1,""],[10718,1,""],[10718,0,"until then."],[10561,29,""],[10561,0,"d"],[10561,1,""],[10561,0,"it didn't run that fast"],[10584,5,""],[10608,2,""],[10608,0,"they"],[10613,4,""],[10613,0,"have "],[10669,1,""],[10669,0,","],[10689,3,""],[10695,0," them to my little table"],[10719,11,""],[10689,31,""],[10689,0,"adding b"],[10696,1,""],[10696,0,"them to my table "],[10707,5,""],[10707,0,"results table"],[10539,0," supposed to be"],[10554,6,""],[10564,0," or so"],[10663,14,""],[10670,62,""],[10671,0,"\n\n---"],[9733,0," Automerge stores st"],[9752,1,""],[9751,1,""],[9751,0,"too many objects "],[9767,1,""],[9744,0,"creates and "],[9779,0,"'"],[9743,0,"'"],[9744,36,""],[9744,0,"s data structure is slow"],[9768,1,""],[9768,0,"."],[9746,0,"core "],[9769,60,""],[9768,1,""],[9768,0,"n't "],[9771,1,""],[9770,1,""],[9769,1,""],[9768,1,""],[9768,0," too l"],[9773,1,""],[9773,0,"slow."],[9768,4,""],[9751,0,"tree based "],[9780,0,"hug"],[9780,3,""],[9777,3,""],[9777,0,"gets big and "],[9794,0," as the document grows"],[10701,5,""],[10741,6,""],[10740,1,""],[10740,0," tuning"],[10767,9,""],[10767,0,"the computer run"],[10809,4,""],[10809,0," it"],[10812,9,""],[10783,1,""],[10782,1,""],[10781,1,""],[10780,1,""],[10955,0," small"],[11017,25,""],[11017,0,"I"],[13618,0," The yjs version is slightly different"],[13638,18,""],[13638,0,"almost identical."],[13638,16,""],[13638,0,"in the same file, if you want to ah"],[13672,1,""],[13671,1,""],[13671,0,"have a look. They're almost identica"],[13699,8,""],[13699,0,"impossil"],[13706,1,""],[13706,0,"ble to tell apart"],[13699,24,""],[13699,0,"identical"],[13683,0," Despite being very diffi"],[13707,1,""],[13707,0,"erent papers, the implementations"],[13740,8,""],[13740,0," are"],[13725,15,""],[13725,0,"semantics are"],[13737,1,""],[13736,1,""],[13735,1,""],[13734,1,""],[13635,0,"of this function "],[13742,9,""],[13742,0,"lig"],[13744,1,""],[13743,1,""],[13743,0,"ogic is"],[13750,4,""],[13747,0," for inserting"],[14335,0,"the "],[14374,0," codebases"],[14375,9,""],[14375,0,"code"],[14651,8,""],[14651,0,"Their "],[14695,0," (And it will be until "],[14712,6,""],[14712,0,"eh"],[14713,1,""],[14712,1,""],[14712,0,"whenever users don't"],[14695,37,""],[14697,0,"Mode"],[14700,1,""],[14699,1,""],[14698,1,""],[14698,0,"y code is "],[14704,4,""],[14704,0,"base os ob"],[14713,1,""],[14712,1,""],[14711,1,""],[14710,1,""],[14709,1,""],[14709,0,"is obviousy"],[14719,1,""],[14719,0,"ly "],[14722,31,""],[14722,0,"very different from automerge."],[14753,1,""],[14753,0,"F"],[14765,26,""],[14765,0," I'm not using"],[14779,4,""],[14712,25,""],[14711,1,""],[14710,1,""],[14709,1,""],[14709,0,"has lots of differences "],[14737,0," the real"],[14756,0," library"],[14769,9,""],[14769,0," instance,"],[14769,10,""],[14769,0," example,"],[14756,8,""],[14741,5,""],[14737,4,""],[14732,1,""],[14720,12,""],[14717,3,""],[14712,5,""],[14709,3,""],[14709,0,"is obviously very different "],[14779,0," use"],[14773,6,""],[14769,4,""],[14765,4,""],[14765,0," my implementation doesn't"],[14753,1,""],[14753,0,"f"],[14741,11,""],[14736,5,""],[14726,10,""],[14722,4,""],[14722,0,"Its not exactly like-for-like -"],[14721,1,""],[14719,2,""],[14719,0,"y"],[14711,9,""],[14709,2,""],[14709,0,"os ob"],[14711,3,""],[14708,3,""],[14704,4,""],[14704,0," is "],[14707,1,""],[14704,3,""],[14699,5,""],[14698,1,""],[14698,0,"ode"],[14697,92,""],[15120,0,"\nBut a lot of that difference really is immutablejs.\n"],[15121,0,"("],[15121,1,""],[15121,0,"(But bear in mind there's only so much we can conclude from this. "],[15186,1,""],[15185,1,""],[15185,0," about the data"],[15121,79,""],[15121,0,"I wish I could take full c "],[15136,11,""],[15136,0,"give Kevin's approach"],[15135,22,""],[15135,0," attribute all of that to this sweet data structure. "],[15187,1,""],[15238,0," gumming up th eworke"],[15258,1,""],[15252,6,""],[15252,0,"e works"],[15205,0," performance"],[15271,0," "],[15271,1,""],[15205,12,""],[15259,0," for automerge"],[14770,0,", and 30x more"],[14784,15,""],[15156,0," diffee"],[15162,1,""],[15162,0,"rence"],[15175,0," super"],[15182,5,""],[15182,0,"simple"],[15176,12,""],[15176,0,"sweet and simple"],[15260,24,""],[15259,1,""],[15259,0," making"],[15267,0,"everything "],[15287,0," does slower"],[15298,1,""],[15297,1,""],[15287,10,""],[15267,11,""],[15276,0," slow"],[15267,0,"all of "],[15283,0,"'s code"],[15295,0,"dow"],[15297,1,""],[15296,1,""],[15295,1,""],[15295,0," down"],[15299,1,""],[15298,1,""],[15297,1,""],[15296,1,""],[15295,1,""],[15145,0,"*"],[15149,0,"*"],[15249,0," just"],[15240,10,""],[15257,35,""],[15257,0,"slow"],[15257,0,"being "],[15240,4,""],[15240,0,"is probably attributat"],[15261,1,""],[15260,1,""],[15260,0,"able to"],[15279,11,""],[15279,0," alone"],[15240,27,""],[15240,0,"can probably"],[15244,8,""],[15240,4,""],[15240,0,"is just"],[15247,18,""],[15247,0," automerge's lack of "],[15260,8,""],[15260,0," im"],[15262,1,""],[15261,1,""],[15261,0,"implementations"],[15275,1,""],[15260,1,""],[15274,0," (and immutablejs)"],[15224,4,""],[15224,0,"the"],[15238,0," here"],[15247,5,""],[15247,0,"probably just quirks of "],[15297,0,"."],[15300,0,"Oh, "],[15260,10,""],[15260,0," due to "],[15267,1,""],[15247,9,""],[15247,0,"probabl "],[15254,1,""],[15254,0,"y "],[15260,0," little microoptimizations"],[15286,34,""],[15288,22,""],[15288,0,"My code ex"],[15297,1,""],[15296,1,""],[15295,1,""],[15294,1,""],[15293,1,""],[15292,1,""],[15291,1,""],[15291,0,"implementation executes less code, and "],[15288,42,""],[15287,1,""],[15256,30,""],[15256,0,"from immutablejs"],[15256,4,""],[15256,0,"just"],[15272,0," gumming things up"],[15316,0,"Now that "],[15325,1,""],[15325,0,"w"],[15337,3,""],[15337,0,"a fast"],[15343,8,""],[15339,0,"clean and "],[15316,10,""],[15316,0,"W"],[15355,0," "],[15355,1,""],[15366,0," now"],[20491,0," If there was a programming "],[20507,12,""],[20507,0,"programmer version of speedrunning"],[20529,0,"the "],[20545,0," community, Kevin would be there with bells on."],[20557,34,""],[20557,0,"they would adore KEv"],[20576,1,""],[20575,1,""],[20575,0,"evin"],[20405,4,""],[20405,0,"he rewrote"],[20428,20,""],[20408,0,"wrote and "],[20474,4,""],[20474,0," run"],[20488,14,""],[20488,0,"If there was a"],[22875,0,"would "],[22885,1,""],[22885,0," you"],[22875,0,"like that "],[22904,22,""],[22987,16,""],[22987,0,"as much as possible with each rae"],[23019,1,""],[23018,1,""],[23018,0,"ead to main ma"],[23031,1,""],[23031,0,"emory"],[23273,0," I wannt"],[23280,1,""],[23279,1,""],[23279,0,"t"],[23291,6,""],[23291,0,"to"],[23329,0," "],[23342,0," it"],[23356,7,""],[23355,1,""],[23359,6,""],[23358,1,""],[23768,22,""],[23744,24,""],[23744,0,"been able to improve its performance"],[23736,0,"s"],[23737,33,""],[23737,0," "],[23749,0," ahs"],[23752,1,""],[23751,1,""],[23750,1,""],[23750,0,"hasn't improved"],[23851,0," We "],[23854,1,""],[23853,1,""],[23852,1,""],[23851,1,""],[23766,1,""],[23766,0,"\n\n"],[23851,1,""],[23851,0," these days. We can d"],[23871,1,""],[23871,0,"coe t"],[23875,1,""],[23874,1,""],[23873,1,""],[23873,0,"de this is "],[23883,1,""],[23882,1,""],[23882,0,"n anything."],[23892,0,"*"],[23884,0,"*"],[23881,2,""],[23881,0,"up in"],[24065,0," also"],[24069,1,""],[24068,1,""],[24068,0,"most"],[24060,13,""],[24060,0,"is almos ti"],[24070,1,""],[24069,1,""],[24068,1,""],[24068,0,"t identical to"],[24082,11,""],[24258,1,""],[24258,0,", w"],[24260,1,""],[24260,0,"so we can qui"],[24270,3,""],[24270,0,"find anything "],[24258,26,""],[24258,0,"."],[24172,4,""],[24172,0,"E"],[24204,3,""],[24210,0,"s"],[24629,0," We update a leaf, then its parent, and its parent, all the way up to th eroo"],[24705,1,""],[24704,1,""],[24703,1,""],[24702,1,""],[24701,1,""],[24701,0,"e root"],[24707,22,""],[24708,0," A"],[24709,1,""],[24709,0,"So"],[24712,1,""],[24712,0,"a"],[24653,0,"the"],[24655,1,""],[24654,1,""],[24653,1,""],[24653,0,"the character oun"],[24669,1,""],[24668,1,""],[24667,1,""],[24667,0,"counts at "],[24742,0," after"],[24763,3,""],[24762,1,""],[24837,37,""],[24837,0,"W"],[24837,1,""],[24837,0,"It doesn't come into play here, but w"],[24837,0,"We never merge edits from remote peers in this test,"],[24889,35,""],[24889,0," but I made that fast too anyway."],[24923,1,""],[24923,0,"W"],[24989,0,"eg "],[25049,20,""],[25049,0,"search by ID."],[25039,1,""],[25038,1,""],[25037,1,""],[25037,0,"little "],[25060,0,"the b-tree "],[25154,20,""],[25154,0,"It might help -"],[25171,0," just"],[25602,0," I picked 32 by trying a few numbers"],[25631,0,"different numbers and benchmarking "],[25665,1,""],[25665,0,"."],[25666,7,""],[25666,0," Higher"],[25667,6,""],[25667,0,"T"],[25667,1,""],[25667,0,"32 seems"],[25674,1,""],[25674,0,"ed pretty good."],[25618,35,""],[25630,0," the system with a few different sizes"],[25679,0," to work"],[25694,5,""],[25694,0," well"],[25635,0,"whole "],[26747,33,""],[27673,0,"But "],[27677,1,""],[27677,0,"w"],[27694,4,""],[27902,5,""],[27902,0,"M"],[28002,6,""],[28002,0,"the document"],[28024,0," Ropey on its own takes 29ms to process this string"],[28069,6,""],[28069,0,"docu"],[28069,4,""],[28069,0,"editing trace."],[29220,0," -"],[29222,4,""],[29222,0," "],[29222,1,""],[29222,0," "],[29244,0," are *weird*"],[29325,11,""],[29332,0," in the two b-trees"],[29406,0,"should "],[29418,1,""],[29802,1,""],[29802,0," - to the "],[29802,10,""],[29802,0,"."],[30289,0," turned my back on academia i"],[30317,1,""],[30317,0,"and"],[31178,0," figure out how to"],[31206,5,""],[31237,15,""],[31237,0,"turning toward th"],[31251,3,""],[31244,7,""],[31237,7,""],[31237,0,"doing that work"],[31237,15,""],[31237,0,"answering that call"],[31340,2,""],[31340,0,"start"],[31353,7,""],[31353,0," to a"],[31357,1,""],[31357,0,"make"],[31361,25,""],[31367,0," fast"],[31373,0," And return with the treat"],[31398,1,""],[31398,0,"sure of these algirh"],[31417,1,""],[31416,1,""],[31416,0,"o"],[31416,1,""],[31415,1,""],[31415,0,"orithms. (Well, it took a decade and *k"],[31453,1,""],[31453,0,"Kevin*)"],[31459,0,"."],[31447,0,", some hard work"],[31476,0," Thanks dude!"],[31477,12,""],[31468,0,"some great ideas from"],[31489,1,""],[31489,0," "],[31495,1,""],[31495,0," and Martin"],[31496,0,"Jahns "],[31512,0," Kleppmann"],[31523,1,""],[31423,1,""],[31423,0,"\n\n"],[31425,1,""],[31523,1,""],[31523,0," I couln"],[31530,1,""],[31530,0,"dn't have done it "],[31524,24,""],[31524,0,"Automerge's run-"],[31536,4,""],[31536,0,"document encoding system is fantastic - and "],[31576,4,""],[31575,1,""],[31574,1,""],[31573,1,""],[31573,0,"."],[31524,12,""],[31524,0,"The "],[31552,0," Martin made for Automerge"],[31591,0,", and was the inpsi"],[31609,1,""],[31608,1,""],[31607,1,""],[31607,0,"spiration for Yjs's "],[31621,0,"the euqu"],[31628,1,""],[31627,1,""],[31626,1,""],[31626,0,"quivalent in "],[31644,1,""],[31643,1,""],[31642,1,""],[31643,0," And "],[31644,4,""],[31644,0,"Using incrementing sequence numbers"],[31489,0," a bunch of clever people."],[31515,34,""],[31551,0," Kell"],[31555,1,""],[31554,1,""],[31553,1,""],[31553,0,"leppmann"],[31646,0,"The system of "],[31660,5,""],[31660,0,"using"],[31695,0," instead of UUIDs"],[31696,11,""],[31696,0,"to save storing "],[31704,0,"generating an d"],[31717,1,""],[31718,0," "],[31678,0," (agent id,"],[31698,8,""],[31698,0,") tuples"],[31709,0," avoid"],[31715,5,""],[31744,0," is genius. And"],[31501,0,"other "],[31604,0," it"],[31765,3,""],[31765,0,"I have no idea who came up with that. And Kevin's list approach I describe here is the sort of obvious j"],[31868,1,""],[31860,0,"fantastic, "],[31879,0,"idea that 100 smart p"],[31893,7,""],[31893,0,"p"],[31893,1,""],[31893,0,"smart pp"],[31900,1,""],[31900,0,"eople have surely walked tirhg "],[31925,6,""],[31925,0,"right past without noticing it."],[31501,5,""],[31500,1,""],[31507,7,""],[31507,0," folks"],[31624,4,""],[31624,0," its"],[31592,5,""],[31592,0,"."],[31594,1,""],[31594,0,"I"],[31594,50,""],[31561,4,""],[31561,0,"in"],[31562,1,""],[31561,1,""],[31551,10,""],[31551,0,"invented for"],[31564,4,""],[31753,0,"representi"],[31762,1,""],[31762,0,"ation "],[31768,9,""],[31768,0,"approach "],[31768,9,""],[31845,0,"must "],[31900,0," I don't know"],[31901,12,""],[31901,0,"I don't know that I wouldn't "],[31929,1,""],[31928,1,""],[31927,1,""],[31926,1,""],[31926,0," have thouhg"],[31909,29,""],[31909,0,"think I woul"],[31903,18,""],[31903,0,"think I wouldn't"],[31918,1,""],[31917,1,""],[31916,1,""],[31916,0," have walked right past that "],[31902,43,""],[31902,0," wouldn't have thought of that either."],[31519,8,""],[31519,0,"binary"],[31575,9,""],[31575,0,"brilliant"],[31647,0,"in order "],[31665,23,""],[31670,0," everywhere"],[31691,1,""],[31691,0,", and"],[31738,0," of course,"],[31750,7,""],[31750,0,"The"],[31752,1,""],[31751,1,""],[31750,1,""],[31750,0,"the"],[31773,0," + insertion approack"],[31793,1,""],[31793,0,"h"],[31750,0,"Kevin's "],[31758,3,""],[31757,1,""],[31886,7,""],[31920,3,""],[31922,39,""],[31922,0,"I wouldn"],[31929,1,""],[31929,0," n"],[31930,1,""],[31930,0,"have "],[31929,6,""],[31929,0,"n't have thought of that either."],[31924,8,""],[31924,0,"don't think I would "],[31943,1,""],[31817,12,""],[31827,1,""],[31827,0,". Its the"],[31829,25,""],[31829,0,"I bet"],[31879,0," that iea"],[31887,1,""],[31886,1,""],[31886,0,"dea over the last decade"],[31918,0," any of them"],[31939,0," it"],[31982,11,""],[31982,0,"it either"],[37968,9,""],[37968,0,"Why is"],[37998,15,""],[37998,0,"so slow?"],[38008,9,""],[38019,0,"just "],[38027,5,""],[37968,0,"I don't get it - "],[37985,1,""],[37985,0,"w"],[39399,1,""],[39398,1,""],[39397,1,""],[39396,1,""],[39395,1,""],[39394,1,""],[39394,0,"Im "],[39396,1,""],[39395,1,""],[39395,0,"'m dying."],[39404,5,""],[39403,1,""],[39403,0,"!"],[39394,0,"Stop - "],[39442,4,""],[39545,66,""],[39555,1,""],[39555,0," already has been replaced with w"],[39587,1,""],[39587,0,"automerge-rs"],[39599,8,""],[39599,0," "],[39632,0," So itd "],[39639,1,""],[39638,1,""],[39638,0," doesn' "],[39645,1,""],[39645,0,"t matter"],[39653,70,""],[39653,0,".\n"],[39654,0," Try not to think about it. *Twitch*"],[39683,1,""],[39683,0,"t"],[39689,0,"."],[39681,0," Definitely don't submit any PRs to fi"],[39682,37,""],[39681,1,""],[39681,0," Definitely don't submit any PRs to fix all the low hanging fruit."],[37885,0," Moving from automerge to au"],[37912,1,""],[37911,1,""],[37911,0,"reference-crdts"],[37911,0,"my "],[37929,66,""],[37929,0," changes:\n\n- Core"],[37942,4,""],[37942,0,"The core data structure (list -> "],[37974,1,""],[37973,1,""],[37972,1,""],[37971,1,""],[37967,4,""],[37967,0,"tree to list)\n- Removed immutablejs\n- Removed automerge's frontend / backend protocol\n- Use d"],[38059,1,""],[38058,1,""],[38058,0,"d a different javascript style\n\nWhich "],[38090,6,""],[38090,0,"Which"],[37930,0,"resulted in changes to"],[37952,7,""],[38110,0," of these changes made the"],[38105,31,""],[38105,0,"W"],[38105,1,""],[38105,0,"How can "],[38105,8,""],[38105,0,"The change from reference-crdts to yjs is"],[38145,1,""],[38144,1,""],[38143,1,""],[38143,0,", and yjs to my rust code "],[38115,0,"s"],[38150,0,"from "],[38175,0,"are similarly big. "],[38193,1,""],[38193,0," Its possible I'm mi"],[38194,0,"So "],[38197,1,""],[38197,0,"i"],[38216,0,"sattributing the performance"],[38216,0,"s"],[38216,1,""],[38233,0,"speedups"],[38241,11,""],[38241,0," here; wheras "],[38246,9,""],[38246,0,".\n\nI suppose to answer that"],[38103,0,"\n\nTh"],[38106,1,""],[38105,1,""],[38105,0,"My code"],[38105,7,""],[38105,0,"We got 10x performance from this change. How "],[38146,4,""],[38146,0,"But which ch"],[38156,2,""],[38156,0,"part of this"],[38150,18,""],[38150,0,"to what should we attribute the speedup?"],[38067,0,". And all the Uint8Arrays that appeared"],[38098,8,""],[38098,0,"pop up throughout automerge's "],[38127,1,""],[38126,1,""],[38125,1,""],[38125,0," for whatever reason."],[38229,40,""],[38229,0,"I don't *really* know how to attribute that speedup amongst all the changes."],[38395,54,""],[38391,4,""],[38391,0,"monolo"],[38396,1,""],[38396,0,"ithic."],[38404,24,""],[38404,0,"And yes, this is a reasonabile"],[38433,1,""],[38432,1,""],[38431,1,""],[38431,0,"le criticism of this appar"],[38456,1,""],[38455,1,""],[38455,0,"roach. I covered too much territory here."],[38495,0," to be thorough"],[38502,0,"as "],[38513,0," as I'd like. We"],[38527,2,""],[38527,0,"I did benchmakr "],[38542,1,""],[38541,1,""],[38540,1,""],[38540,0,"rk 4 different CRDT implementations - 2 of which I wrote myself from scratch"],[38575,0," here"],[38258,10,""],[38258,0,"distribute "],[38305,0," that happened"],[38417,0," Maybe rust is just that much faster than javascript, and all my discussion"],[38469,0," for this sort of thing"],[38515,0," of pointers is just made up?"],[38543,1,""],[38543,0,"."],[38546,5,""],[38546,0,"Y"],[38549,1,""],[38549,0,"."],[38551,1,""],[38551,0,"T"],[38760,0," And this post is "],[38546,232,""],[38546,0,"Yes. This is a reasonable criticism of this approach. I covered too much territory here to be as thorough as I'd like. I did benchmark 4 different CRDT implementations here - 2 of which I wrote myself from scratch. And this post is nearly 7000 words already."],[38149,8,""],[38149,0,"A"],[38149,1,""],[38149,0,"Tje"],[38151,1,""],[38150,1,""],[38150,0,"he"],[38152,8,""],[38169,0," is totally different ("],[38191,1,""],[38190,1,""],[38190,0,". (FP javascript -> imperitive)"],[38215,1,""],[38215,0,"a"],[38270,5,""],[38269,1,""],[38269,0,"'m only guessing"],[38285,14,""],[38293,10,""],[38293,0,"assign t"],[38300,1,""],[38299,1,""],[38351,0," And for what its worth - I ssu"],[38381,1,""],[38380,1,""],[38380,0,"uspect just removing immutablejs and tidying up automerge"],[38416,0," doing some obvious"],[38435,21,""],[38435,0," "],[38435,1,""],[38435,0," tidying up automerge"],[38427,8,""],[38422,5,""],[38416,6,""],[38427,10,""],[38424,3,""],[38416,8,""],[38412,4,""],[38400,12,""],[38391,9,""],[38386,5,""],[38380,6,""],[38380,0,"su"],[38378,4,""],[38376,2,""],[38374,2,""],[38368,6,""],[38364,4,""],[38359,5,""],[38355,4,""],[38351,4,""],[38455,0,"my "],[38462,0," code"],[38470,5,""],[38504,22,""],[38504,0,"because rust is fast"],[38512,12,""],[38512,0,"of"],[38512,2,""],[38512,0,"the rust omp"],[38523,1,""],[38522,1,""],[38521,1,""],[38521,0,"compiler"],[38512,0,"of"],[38514,3,""],[38528,0," specifics"],[38529,9,""],[38529,0,"stuff"],[38573,12,""],[38573,0,"fake news"],[38573,9,""],[38573,0,"invented"],[38834,7,""],[38833,1,""],[38834,0," So I suppose"],[38835,12,""],[38835,0,"If this bothers you, please do those benchmarks. I'd love to "],[38866,6,""],[38866,0,"more detailed "],[38584,320,""],[38584,0,"Yes. This is a reasonable criticism of this approach. I covered too much territory here to be as thorough as I'd like. I did benchmark 4 different CRDT implementations here - 2 of which I wrote myself from scratch. And this post is nearly 7000 words. If this bothers you, please do more detailed benchmarks. I'd love to"],[38059,8,""],[38059,0,"malarky"],[38059,7,""],[38059,0,"protocol"],[38068,0," And"],[38072,4,""],[38077,3,""],[38077,0,"those"],[38147,0," are gone too, obviously"],[38610,0,"And, "],[38615,1,""],[38615,0,"y"],[38669,161,""],[38669,0,"I "],[38670,1,""],[38670,0,"f this bothers, "],[38685,1,""],[38684,1,""],[38684,0," you'"],[38688,1,""],[38688,0,", I'd *love* to "],[38701,3,""],[38701,0,"for someone to pull apart each of these changes and "],[38741,12,""],[38741,0,"performance differences and show me"],[38768,8,""],[38768,0," publish a more detailed guide. I'd read the heck out of that."],[38830,104,""],[38765,0,"between implementations I show here "],[38866,0,"\n\n\n### You haven't published"],[38873,21,""],[38873,0,"Where is the code to re-run your benchmarks?"],[38873,0,"I don't believe you. "],[38873,21,""],[38917,0," I want to verify &"],[38935,1,""],[38935,0,"t"],[38935,1,""],[38934,1,""],[38928,6,""],[38928,0,"play\n\nThe benchmark code for yjs and automerge I'm running is [here](https://gist.github.com/josephg/13efc1444660c07870fcbd0b3e917638). For my rust implementation I'm benchmarking [this code](https://github.com/josephg/text-crdt-rust/tree/ba20b6386c0472958f33024ce0b806e75470e1ca). Run it with `car"],[38991,4,""],[38991,0,"in this github gist"],[39078,1,""],[39078,0,"\n\n"],[39242,0,"go criterion yjs` or `cargo criterion ropey` for the ropey baseline. Turn on oa"],[39320,1,""],[39319,1,""],[39319,0,"and off the inline rope updates in "],[39351,3,""],[39351,0,"near the o"],[39360,1,""],[39350,10,""],[39350,0," my commenting out lines near the top of src/universal/doc.rs."],[38956,0," javascript"],[38957,10,""],[38957,0,"my JS string baseline,"],[38998,12,""],[39089,0," Its a mess."],[39100,1,""],[39100,0,"; but messy is better than missing."],[39111,0," links"],[39112,5,""],[39112,0,"code"],[39139,0," code"],[39326,0," "],[39326,1,""],[39354,3,""],[39354,0,"to isolate"],[39486,0,"\n\nI haven't uploaded my wasm wrapper anywhere."],[39510,0,"rust "],[39514,0," crdt"],[39486,0," You can add `--features memusage` to print out memory allocator statistics. (T"],[39564,1,""],[39563,1,""],[39562,1,""],[39561,1,""],[39561,0,". (This is how I'm generating "],[39580,11,""],[39580,0,"figurout "],[39588,1,""],[39587,1,""],[39586,1,""],[39585,1,""],[39585,0,"ing out how much r"],[39602,1,""],[39602,0,"RAM I'm using)."],[39563,1,""],[39614,1,""],[39561,1,""],[39561,0," - which is"],[39572,8,""],[39145,0," "],[39145,1,""],[38918,14,""],[38917,1,""],[38872,0," IS thi"],[38878,1,""],[38877,1,""],[38876,1,""],[38875,1,""],[38874,1,""],[38874,0,"s this reproducable?"],[38881,12,""],[38881,0,"reproducable"],[38912,27,""],[38912,0," that e"],[38918,1,""],[38918,0,"generated these benchmark results?"],[38895,57,""],[38895,0,"Show me the code"],[38907,0,"benchmarking "],[38924,0," please"],[38924,7,""],[38924,0,"!"],[33461,7,""],[33461,0,"sleights"],[31273,0,"I got frustrated with academia a"],[31304,1,""],[31304,0,"on the whole and "],[31353,1,""],[31353,0,"."],[31355,5,""],[31355,0,"I"],[31294,0," c"],[31295,1,""],[31295,0,"disappointing app"],[31311,1,""],[31310,1,""],[31309,1,""],[31309,0,"app"],[31311,1,""],[31310,1,""],[31309,1,""],[31308,1,""],[31308,0," papers and"],[31341,0,","],[31424,2,""],[31424,0,"at how we can"],[31458,0," to"],[31455,6,""],[31454,47,""],[31454,0," And bring us to this point."],[31455,27,""],[31454,1,""],[31454,0," "],[31454,1,""],[31453,1,""],[31453,0," and no time at all to arrive at these performance numbers."],[31688,0," avoiding UUIDs by"],[31753,36,""],[31753,0," "],[31764,4,""],[31763,1,""],[31763,0,"."],[31801,0,", but its brilliant"],[31807,13,""],[31807,0,"I love it"],[31897,13,""],[31897,0," makes everything si"],[31916,1,""],[31916,0,"o much simpler"],[32049,11,""],[32049,0,"doubt"],[32103,2,""],[32103,0,"fast CRDTs"],[32102,6,""],[32102,0," the formula for fast "],[32129,0,", "],[32130,1,""],[32129,1,""],[32123,1,""],[32123,0,", lightwa"],[32131,1,""],[32131,0,"eight "],[32141,1,""],[32141,0," implementations"],[32094,0,", after a decade of waiting,"],[32190,1,""],[32190,0,"\n\n"],[32191,1,""],[32190,1,""],[32190,0," "],[39104,740,""],[39045,59,""],[39044,1,""],[33694,0,"\n\nIf you want to play with any of the benchmarks yourself, the "],[33753,4,""],[33753,0,"here's "],[33751,9,""],[33751,0,":\n\n\nThe benchmark code for my JS string baseline, yjs and automerge is [in this github gist](https://gist.github.com/josephg/13efc1444660c07870fcbd0b3e917638). Its a mess; but messy code is better than missing code.\n\nFor my rust implementation I'm benchmarking [this code](https://github.com/josephg/text-crdt-rust/tree/ba20b6386c0472958f33024ce0b806e75470e1ca). Run it with `cargo criterion yjs` or `cargo criterion ropey` to isolate the ropey baseline. Turn on and off the inline rope updates my commenting out lines near the top of src/universal/doc.rs. You can add `--features memusage` to print out memory allocator statistics - which is how I'm figuring out how much RAM I'm using.\n\nI haven't uploaded my rust crdt wasm wrapper anywhere."],[33753,1,""],[33752,1,""],[33751,1,""],[33751,0,", most of t"],[33751,11,""],[33751,0,":\n"],[33742,0," I ran"],[33757,0,", everything is a bit of a hodge b"],[33790,1,""],[33790,0,"podge"],[33695,0,"\n\n"],[33696,0,"### You haven't published the code which generated your results"],[33860,1,""],[33860,0,". But its almost all online."],[34129,0," results"],[34318,0,"if you want "],[34593,0," You'll need `automerge-paper.json.gz` from [this repositor"],[34643,9,""],[34643,0,"repository"],[34593,1,""],[34593,0,"\n\n"],[34654,0,"](https://github.com/josephg/crdt-benchmarks) for most of these tests."],[34602,0,"also "],[34705,3,""],[34705,0,"in order to run"],[34101,0,"\n\nThe reference "],[34116,1,""],[34116,0,"-crdts benchmark is in th"],[34133,8,""],[34133,0,"code is [in thi"],[34147,1,""],[34147,0,"e repository here](https://github.com/josephg/reference-crdts/blob/main/bench.ts). You ca"],[34230,6,""],[34230,0,"If you want to measuer m"],[34253,1,""],[34252,1,""],[34251,1,""],[34250,1,""],[34250,0,"re memory usage you can use the same approach as I did i"],[34305,1,""],[34103,202,""],[34103,0,"The reference-crdts benchmark code is [in the repository here](https://github.com/josephg/reference-crdts/blob/main/bench.ts). If you want to measure memory usage you can use the same approach as I did"],[33913,3,""],[33913,0,"the "],[33954,0," tests"],[34152,3,""],[34152,0,"its"],[34166,5,""],[34166,0," here"],[34311,0,"'"],[34276,0,"'"],[34277,35,""],[34277,0,"ll need to add"],[34291,1,""],[34291,0," queries"],[34272,27,""],[34272,0,", follow the approach from the gist and "],[34307,5,""],[34307,0,". You can run tihs code "],[34321,10,""],[34321,0,"this code with `node --loader ts-node/esm --expose-gc bench.ts`"],[34307,0," of printing out"],[33940,4,""],[33940,0,","],[33951,0," and reference-crdts"],[33980,0," all jammed into"],[33998,3,""],[33985,11,""],[33985,0,"in"],[34166,2,""],[34166,0,"needs"],[34131,295,""],[34165,4,""],[34165,0," come from"],[34435,2,""],[34435,0,"by"],[34449,25,""],[34449,0,"editing the global c"],[34461,8,""],[34461,0,"constant at the top of"],[34581,0,"while benchmarking "],[34602,12,""],[34602,0,"thats how"],[34642,9,""],[34642,0,"its using. (Note you can't measure memory using "],[34684,6,""],[34684,0,"su"],[34685,1,""],[34684,1,""],[34684,0,"usage during tests because test mode changes the memory"],[34702,37,""],[34702,0,")"],[34668,0," accurately"],[34701,7,""],[34701,0,"in the unit testing environment"],[34732,5,""],[34882,0," The reference-crdts implementation depends on ["],[34902,15,""],[34902,0," benchmarks"],[34912,1,""],[34925,0,"crdts.ts]("],[34934,1,""],[34933,0," from this repository"],[34955,0,"(https://github.com/josephg/reference-crdts/tree/fed747255df9d457e11f36575de555b39f07e909)"],[34954,0,", at this version"],[34199,0,", at this version"],[33699,60,""],[33699,0," How do I reproduce your results?"],[33709,22,""],[33709,0,"re-run your benchmark results"],[33699,0," I don't believe you"],[33699,20,""],[33709,3,""],[33727,0,"s myself"],[33735,8,""],[33713,4,""],[33713,0,"these"],[38416,53,""],[38416,0,"we need to take a lot more seriously is how we"],[38470,1,""],[38469,1,""],[38468,1,""],[38468,0,"e"],[38648,1,""],[38648,0," - so the model of \"load an objet"],[38680,1,""],[38680,0,"ct, keep it in ram for "],[38699,4,""],[38699,0,"while its open and then save it"],[38723,0,"eventually "],[38741,0,"\" doesn't work."],[38751,4,""],[38751,0,"apply"],[39104,0,"\n\n"],[39105,1,""],[39104,1,""],[39104,0,"\n\n> Edit: Kevin says there are "],[39125,10,""],[39125,0,"you can do this "],[39133,8,""],[39133,0,"adapt Yjs's providers to implement this in a reasonable way. Id"],[39195,1,""],[39195,0,"'d"],[39194,3,""],[39194,0,"I"],[39194,1,""],[39194,0,"Kevin is usually right; but I'd sure love to see that in action."],[39194,64,""],[39193,1,""],[39193,0," I'd love to see that in action."],[39194,31,""],[39193,1,""],[39193,0," I'd ove"],[39200,1,""],[39199,1,""],[39198,1,""],[39198,0,"love to see that in action."],[40111,4,""],[40111,0,"I can "],[40129,1,""],[40128,1,""],[40127,1,""],[40146,0," 10x"],[40171,0,"of "],[40185,14,""],[40178,7,""],[40178,0,"differences"],[40288,0,"How much f"],[40297,1,""],[40297,0,"of the speed difference beween"],[40321,6,""],[40321,0,"between my"],[40331,8,""],[40341,0," and yjs is simply due to"],[40366,67,""],[40360,6,""],[40360,0,"thnks"],[40364,1,""],[40363,1,""],[40362,1,""],[40362,0,"anks to the rust compiler?"],[40388,48,""],[40349,0," has nothing to do with memory layout, and everything to do wtih"],[40412,1,""],[40411,1,""],[40410,1,""],[40410,0,"ith"],[40413,20,""],[40432,0," I don't know."],[40432,1,""],[40432,0,"\n\n"],[40449,3,""],[40449,0,"So"],[40446,1,""],[40446,0,"!"],[40643,7,""],[40643,0,"tease apart"],[40708,0," I love benhc"],[40720,1,""],[40719,1,""],[40719,0,"chmarking stories. That "],[40742,1,""],[40742,0,"s normal, right?"],[948,39,""],[959,6,""],[959,0,"implementation "],[1333,5,""],[1333,0,"yout"],[1336,1,""],[1336,0,"r"],[1531,9,""],[1530,1,""],[2203,3,""],[2202,1,""],[2201,1,""],[2200,1,""],[2199,1,""],[2198,1,""],[2198,0," RGA is an"],[2209,1,""],[2209,0,"A"],[2401,20,""],[2401,0,"What are the rules?"],[2419,1,""],[2419,0," which describe the system's behaviour?"],[2585,0,"When "],[2585,5,""],[2585,0,"If my "],[2591,24,""],[2591,0,"implementation runs"],[2615,0,"ly,"],[2618,15,""],[2618,0," what can we infer from that"],[2631,0,"really s"],[2638,1,""],[2624,29,""],[2624,0,"does that actul"],[2638,1,""],[2638,0,"ally tll"],[2645,1,""],[2644,1,""],[2644,0,"ell us"],[2673,1,""],[2672,1,""],[2672,0,"."],[2674,1,""],[2674,0,"A"],[2719,6,""],[2728,0,"re are no more"],[2742,11,""],[2738,4,""],[2737,1,""],[2725,0,"that "],[2897,0,", maybe,"],[2905,7,""],[2905,0," writes"],[3305,5,""],[3305,0,"testing"],[3487,13,""],[3837,6,""],[3837,0,"a "],[3845,0," or so "],[3851,1,""],[3850,1,""],[3849,1,""],[3848,1,""],[3847,1,""],[3846,1,""],[3846,0,"ago"],[3851,0," decided to"],[3869,1,""],[3868,1,""],[3867,1,""],[4071,0,"I think "],[5241,0,"i nThe "],[5247,1,""],[5246,1,""],[5245,1,""],[5244,1,""],[5243,1,""],[5242,1,""],[5241,1,""],[5241,0,"in The Literature "],[5244,15,""],[5244,0,"the academic literature "],[5267,1,""],[5256,11,""],[5247,9,""],[5244,3,""],[5244,0,"The Literature "],[5244,15,""],[5244,0,"the academic literature "],[5267,1,""],[5256,11,""],[5247,9,""],[5244,3,""],[5243,1,""],[5242,1,""],[5241,1,""],[5282,0,"n academic"],[7310,8,""],[7508,1,""],[7471,0," But"],[7476,1,""],[7476,0,"t"],[7496,0," really"],[29306,1,""],[29306,0,"&lt;"],[29248,240,""],[29248,0,"\nAnd oh look - those last three rows are *weird*! 29 and 23 don't add up to 65. I'm probably thrashing the CPU cache by interleaving updates in the two b-trees. Looks like a *batch_update()* method would bring that 65ms down to *52ms*.\n"],[33600,46,""],[33600,0,"Benchmarks"],[33600,0,"All "],[33604,1,""],[33604,0,"b"],[33614,0," are lies"],[33628,0," yes"],[33634,80,""],[33634,0,"very clever."],[33632,14,""],[33625,7,""],[33625,0,"Yes yes, very clever."],[33791,27,""],[33791,0," I'm not sorry  "],[33806,1,""],[33806,0,"- writing "],[33805,11,""],[33805,0,"."],[33799,0," even"],[33647,43,""],[33647,0,"\n### How do I run these benchmarks myself?\n"],[33799,5,""],[33805,1,""],[33805,0," - writing "],[33815,1,""],[33807,8,""],[33806,1,""],[33806,0," "],[33806,1,""],[33805,1,""],[33799,6,""],[33795,4,""],[33791,4,""],[33791,0," But its almost all online."],[33638,8,""],[33634,4,""],[33634,0,"I know. I've made a few sleights of hand which I want to 'fess up to and defend."],[33628,4,""],[33618,5,""],[33614,4,""],[33604,1,""],[33604,0,"B"],[33603,1,""],[33600,13,""],[33600,0,"Your benchmarks are weird / wrong / misleading"],[33600,46,""],[33600,0,"Benchmarks"],[33600,0,"All "],[33604,1,""],[33604,0,"b"],[33614,0," are lies"],[33628,0," yes"],[33634,80,""],[33634,0,"very clever."],[33791,27,""],[33791,0," I'm not sorry  "],[33806,1,""],[33806,0,"- writing "],[33805,11,""],[33805,0,"."],[33799,0," even"],[33647,43,""],[33600,23,""],[33600,0,"Your benchmarks are weird / wrong / misleading"],[33600,46,""],[33600,0,"We need to talk about ben"],[33600,25,""],[33600,0,"These benchmarks "],[33600,17,""],[33600,0,"B"],[33600,1,""],[33600,0,"These benchmarks "],[33616,1,""],[33605,11,""],[33600,5,""],[33600,0,"We need to talk about ben"],[33621,4,""],[33600,21,""],[33600,0,"Tge"],[33602,1,""],[33601,1,""],[33601,0,"hese bencmkar"],[33613,1,""],[33612,1,""],[33611,1,""],[33610,1,""],[33610,0,"h"],[33600,11,""],[33600,0,"Are the be"],[33609,1,""],[33609,0,"enchmarks"],[33603,15,""],[33603,0," these benchmarking"],[33621,1,""],[33620,1,""],[33619,1,""],[33619,0,"s for real?"],[33584,0,"\n"],[33636,18,""],[33636,0,"; though its"],[33645,3,""],[33645,0,"there's a few slippery sleights of hands "],[33685,1,""],[33684,1,""],[33684,0," doing"],[33689,1,""],[33688,1,""],[33687,1,""],[33686,1,""],[33685,1,""],[33685,0,"going on here."],[33636,8,""],[33636,0,"B"],[33636,1,""],[33636,0," "],[33636,1,""],[33636,0,". But"],[33641,8,""],[33641,0," there are a"],[33652,1,""],[33651,1,""],[33800,20,""],[33800,0," I'm not even sorry."],[33799,21,""],[33799,0," mess."],[34107,9,""],[34107,0,"josehpg/te"],[34107,10,""],[34107,0,"josephg/text-crdt-rust"],[34238,6,""],[34238,0,"Benchmakr"],[34246,1,""],[34245,1,""],[34245,0,"rk by running"],[34258,5,""],[34307,0,","],[34352,17,""],[34352,0,"T"],[34367,0," structure"],[34385,0," can be enabled or disabled"],[34416,11,""],[34480,0," also"],[34571,8,""],[34571,0,"."],[34573,45,""],[34652,0,". I've been running the benchmarks with that flag, c"],[34703,1,""],[34703,0,"then CT"],[34709,1,""],[34709,0,"c"],[34709,1,""],[34708,1,""],[34708,0,"ctl_"],[34711,1,""],[34710,1,""],[34710,0,"rl+C as"],[34716,1,""],[34715,1,""],[34714,1,""],[34713,1,""],[34712,1,""],[34711,1,""],[34708,3,""],[34708,0,"killing the benchmarks as soon as "],[34729,13,""],[34729,0," run as soon as numbers start coming out."],[34769,1,""],[34822,15,""],[34822,0,"josephg/crdt-benchmarks"],[34984,15,""],[34984,0,"my reference"],[34984,12,""],[34984,0,"josephg/reference-crdts"],[40800,0,"'"],[39603,0,"'"],[35983,0,"'"],[26041,0,"'"],[20874,0,"'"],[16160,0,"'"],[14164,0,"'"],[9304,0,"'"],[3265,0,"'"],[3985,1,""],[3985,0,"o"],[188,0,"\n\n"],[189,0,"<seph-foo />"],[199,1,""],[198,1,""],[199,0,"</seph-foo>"],[199,11,""],[198,0," /"],[198,2,""],[199,0,"</seph-foo>"],[199,0,"oh hai"],[216,0," -->"],[189,0,"<!-- "],[206,0,"dsfdsdf"],[206,7,""],[221,4,""],[189,5,""],[217,0,"\n"],[217,1,""],[195,3,""],[195,0,"time-btn"],[217,3,""],[217,0,"time-btn"],[203,0," timeM"],[208,1,""],[208,0,"Ms=1000"],[209,1,""],[208,1,""],[208,0,"-ms"],[208,3,""],[208,0,"ms"],[209,1,""],[208,1,""],[208,0,"Ms"],[208,0,"-"],[209,1,""],[209,0,"m"],[209,1,""],[209,0,"M"],[208,1,""],[209,1,""],[208,1,""],[204,4,""],[204,0,"ms"],[205,1,""],[205,0,"illisect"],[212,1,""],[212,0,"onds"],[244,0," -->"],[189,0,"<!-- "],[249,4,""],[189,5,""],[26592,0,"**"],[26624,0,"**"],[26626,4,""],[26668,0,"*"],[26655,0,"*"],[26669,0,"*"],[26656,0,"*"],[26672,4,""],[20202,0,"*"],[20199,0,"*"],[20203,0,"*"],[20200,0,"*"],[20206,4,""],[15128,0,"*"],[15095,0,"*"],[15129,0,"*"],[15096,0,"*"],[9662,0,"*"],[9636,0,"*"],[9663,0,"*"],[9637,0,"*"],[9394,0,"\n"],[9394,0,"\nI'm comparing it here to a baseline where all the edits are just applied directly to a javascript string."],[9499,0,", which should be the theori"],[9526,1,""],[9526,0,"etical "],[9499,34,""],[9460,7,""],[9460,0,"spliced "],[9467,1,""],[9477,0,"into "],[9482,3,""],[9395,3,""],[9395,0,"We can "],[9395,7,""],[9395,0,"As a baseline"],[9395,13,""],[9395,0,"To get a sense of how fast"],[9417,4,""],[9417,0,"inefficient that is, we can"],[9453,1,""],[9452,1,""],[9451,1,""],[9451,0,"e"],[9455,0," "],[9456,6,""],[9541,0," Splicing into a string directly can't "],[9542,38,""],[9542,0,"T"],[9542,1,""],[9541,1,""],[9540,1,""],[9540,0,". ("],[9542,1,""],[9541,1,""],[9453,3,""],[9453,0,"the "],[9453,4,""],[9453,0,"this "],[9471,0," benchmark"],[9552,1,""],[9552,0,"; which shoulw"],[9565,1,""],[9564,1,""],[9564,0,"ws"],[9565,1,""],[9564,1,""],[9563,1,""],[9563,0,"ws about how fast h"],[9581,1,""],[9581,0,"javascript"],[9559,32,""],[9559,0," gives us a se "],[9573,1,""],[9573,0,"se "],[9575,1,""],[9574,1,""],[9573,1,""],[9573,0,"nse of how fast javascript could go, if it wasn't loaded down with all our code."],[9653,128,""],[9653,0,"\n"],[9653,0," (Sp"],[9656,1,""],[9655,1,""],[9654,1,""],[9654,0,"And "],[9657,1,""],[9657,0,", javascript"],[9659,0,"raw "],[9673,0," is very fast."],[9659,14,""],[9659,0,"javascript runnign"],[9676,1,""],[9675,1,""],[9675,0,"ng on v8"],[9681,1,""],[9681,0,"V"],[20389,0," @ 13.5.5"],[20400,9,""],[20389,9,""],[20389,0," (v13.5.5)"],[20269,1,""],[20268,1,""],[20268,0,"(v"],[20284,0,")"],[20285,1,""],[20411,1,""],[26991,0,"\n\n"],[26992,0,"\n(I have no idea how to measure memory usage in "],[27024,16,""],[27024,0,"wasm memory usage. It should be the same as the native version)"],[27086,0,"."],[26992,96,""],[26991,1,""],[26990,1,""],[26990,0,". (!)"],[20127,1,""],[20127,0,". Its *300x faster than automerge*!"],[20161,1,""],[20160,0,"!"],[20162,0,"."],[27029,1,""],[27028,1,""],[27027,1,""],[27026,1,""],[27025,1,""],[27025,0,"!"],[27025,0," directly, and its doing way more "],[27050,9,""],[27050,0,"a whole lot of extra work to support c"],[27087,1,""],[27087,0,"collaborative editing too"],[26496,1,""],[26496,0,":"],[26496,1,""],[26496,0," "],[28659,1,""],[26496,1,""],[20229,1,""],[15149,1,""],[9756,1,""],[28655,0,":"],[26493,0,":"],[20227,0,":"],[15148,0,":"],[9756,0,":"],[29329,0,"*"],[29300,0,"*"],[29330,0,"*"],[29301,0,"*"],[29334,4,""],[29870,0,"\n\n"],[29871,0,"That academic paper made claims "],[29896,0,"benchmarking "],[29896,13,""],[29903,0,"about how "],[29891,22,""],[29891,0,"claimed to know how fast t"],[29916,1,""],[29916,0,"various CRDTs run, but its performance measuer"],[29961,1,""],[29960,1,""],[29960,0,"res were off by "],[29891,15,""],[29891,0,"m"],[29891,1,""],[29875,0," silly"],[29897,0,"I real"],[29902,1,""],[29902,0,"d all tohse "],[29913,1,""],[29912,1,""],[29911,1,""],[29910,1,""],[29909,1,""],[29909,0,"hose years ago made claims about"],[29929,0,"some bol"],[29929,8,""],[29968,1,""],[29968,0,". But"],[29973,4,""],[29989,22,""],[29989,0," numbers o"],[29998,1,""],[29998,0,"were "],[29969,0," And because its *published science* we "],[30006,3,""],[30005,1,""],[30005,0,", everyone believed the researchers."],[30004,1,""],[29986,1,""],[30073,0,"off by thou"],[30080,4,""],[30080,0,"3 orders of magnitude."],[30072,0,"n't just wrong. They were wrong by a factor"],[30115,30,""],[30107,8,""],[30107,0,"thousa"],[30112,1,""],[30111,1,""],[30111,0,"sands of times."],[30107,19,""],[30107,0,"several orders of magnitude."],[29970,43,""],[29970,0,"And we all"],[30005,0,", because "],[29974,6,""],[29974,0,"everyone"],[29924,17,""],[29924,0,"tried "],[29924,6,""],[29924,0,"told us all"],[30011,0,"it was published sciec"],[30032,1,""],[30032,0,"nce"],[30041,3,""],[30041,0,"the"],[30132,0," Who knows what the paper would have concluded if they "],[30133,54,""],[30132,1,""],[30132,0," It turns out, the paper wasn't written by gods."],[30132,1,""],[30132,0,"\n\n"],[29924,0,"claimed to "],[29935,4,""],[29935,0,"tell"],[29938,1,""],[29938,0,"l"],[30001,11,""],[30001,0,"paper"],[30108,29,""],[30108,0," sa"],[30110,1,""],[30109,1,""],[30109,0,"thousands of times."],[30129,0,"\nBut thats ok."],[30143,50,""],[30143,0," Actually "],[30156,0," sort of"],[30157,7,""],[30157,0,"weirdly"],[30314,14,""],[30314,0,"this whole thing made me learn something that "],[30339,21,""],[30339,0,"realise something that should have been obvious a"],[30387,1,""],[30387,0,"dea"],[30389,1,""],[30389,0,"cades ago. "],[30399,1,""],[30399,0," Scientists aren't gods. They're"],[30422,0,", sent from the heavens to bring Truth to mortals"],[30473,0,"No, "],[30477,1,""],[30477,0,"t"],[30511,0,"Great"],[30516,11,""],[29924,27,""],[29924,0,"proported to tell us all how "],[29924,9,""],[29924,0,"tried"],[30126,0," They were wrong like a billionare "],[30160,1,""],[30159,1,""],[30158,1,""],[30158,0,"ire guessing ab"],[30172,1,""],[30172,0," banana"],[30137,5,""],[30137,0,"as accurate as"],[30151,5,""],[30183,0," costs $1000."],[30137,0,"about "],[30207,0," you know?"],[30218,1,""],[30218,0,"T"],[30227,0," Thats human, and"],[30244,9,""],[30265,34,""],[30239,26,""],[30251,47,""],[30251,0,"feel sort of inadequate with academics - "],[30292,5,""],[30291,1,""],[30303,5,""],[30322,1,""],[30371,22,""],[30378,13,""],[30378,0,":"],[30425,1,""],[30424,1,""],[30424,0,"s with the gift of"],[30442,8,""],[30448,11,""],[30631,533,""],[42881,0,"\n\n\n\n\n\n\n\n---\n\n\n\nA decade ago Google Wave really needed a good quality list CRDT. So I got super excited when the papers for CRDTs started to emerge. [LOGOOT](https://hal.inria.fr/inria-00432368/document) and [WOOT](https://hal.inria.fr/inria-00445975/document) seemed like a big deal! But that excitement turned to ash when I realised the algorithms were too slow and inefficient to be practically useful. And I made a big mistake - I assumed if the academics couldn't make them fast, nobody could. I turned my back on academia and dismissed them.\n"],[30631,0,"\n"],[30631,0,"\nAnd its important to know that, because the best collaborations "],[30672,0,"sometimes "],[30706,0,"don't come from two chefs working together. They come"],[30706,53,""],[30706,0,"come from "],[30706,10,""],[30706,0,"lok"],[30708,1,""],[30708,0,"ok like Gilbert & Sullivan. M"],[30736,1,""],[30736,0,"O"],[30736,1,""],[30736,0,"The same love, and the same dream"],[30735,0," Or Jobs and Wozniak."],[30790,0," but different skill sets. Different perspectives headed toward the same goal."],[43134,532,""],[43133,1,""],[43132,1,""],[43131,1,""],[43130,1,""],[43129,1,""],[43128,1,""],[43127,1,""],[43126,1,""],[43125,1,""],[43124,1,""],[43123,1,""],[43122,1,""],[43121,1,""],[30635,4,""],[30635,0," thats"],[30659,5,""],[30703,0,"aren't between two "],[30718,4,""],[30718,0,"peers. Instead they "],[30826,0," tto"],[30829,1,""],[30828,1,""],[30828,0,"otally"],[30857,9,""],[30857,0,"Two "],[30857,4,""],[30857,0,"Many minds"],[30862,5,""],[30862,0,"different"],[30871,13,""],[30871,0," minds"],[30877,14,""],[30877,0," s"],[30872,7,""],[30872,0,"strengths fighting for"],[30909,0,"\n\nA decade ago Google Wave really needed a good quality list CRDT. So I got super excited when the papers for CRDTs started to emerge. [LOGOOT](https://hal.inria.fr/inria-00432368/document) and [WOOT](https://hal.inria.fr/inria-00445975/document) seemed like a big deal! But that excitement turned to ash when I realised the algorithms were too slow and inefficient to be practically useful. And I made a big mistake - I assumed if the academics couldn't make them fast, nobody could. I turned my back on academia and dismissed them.\n"],[31442,1,""],[30976,3,""],[31197,20,""],[31197,0,"died when I"],[31288,4,""],[31377,49,""],[31389,0," big"],[31455,0," - ( *"],[31460,1,""],[31459,1,""],[31459,0,"I *H"],[31462,1,""],[31462,0,"hate* reading them) "],[31481,1,""],[31459,0,"to my eternal shame "],[31501,1,""],[31501,0,"."],[31503,3,""],[31503,0,"But"],[31458,1,""],[31458,0,"I haven't written any and "],[31484,42,""],[31484,0,"I'll do almost anything to avoid reading them"],[31576,5,""],[31576,0,"H"],[31455,74,""],[31502,0,"And "],[31506,1,""],[31506,0,"h"],[31763,1,""],[31762,1,""],[31762,0,"s."],[31763,1,""],[31763,0,"!"],[30202,0," It"],[30204,1,""],[30203,1,""],[30202,1,""],[30126,0," It turns out we cah"],[30145,1,""],[30145,0,"n make fast CRDTs."],[30152,5,""],[30157,0," which a"],[30158,7,""],[30157,1,""],[30152,0,"small and fast "],[30172,0,", if we're willing to be a bit clever about it"],[30220,4,""],[30220,0,"And that ma"],[30230,1,""],[30230,0,"eaks"],[30233,1,""],[30232,1,""],[30232,0,"ns that aca"],[30220,23,""],[30220,0,"That"],[30151,15,""],[30157,0," as f"],[30158,4,""],[30158,0,"work almost as fast as a string"],[30181,2,""],[30181,0,"editing a "],[30197,1,""],[30197,0,"."],[30199,46,""],[30199,0,"So that paper "],[30213,10,""],[30213,0,"was "],[30126,73,""],[30039,0," It turns out we can make CRDTs work almost as fast as editing a string. "],[30040,0,"But "],[30044,1,""],[30044,0,"i"],[30075,39,""],[30075,0,"fast. We can make them crazy fast - lik"],[30111,3,""],[30111,0,"about"],[30108,8,""],[30108,0,". We can make them about as fast as native string operations"],[30170,4,""],[30170,0,"So"],[30196,0," in that paper"],[30231,38,""],[30231,0,"They were"],[30240,17,""],[30250,8,""],[30250,0,"wrong"],[30317,0," what"],[30567,0," people"],[30683,5,""],[30683,0," pretty well"],[30695,7,""],[30743,0," "],[30743,1,""],[30743,0," And thats ok."],[30756,1,""],[30756,0,", no matter what "],[30756,17,""],[30756,0,"."],[30759,36,""],[30759,0,"And"],[30949,0," brought together brought together to achieve something none of us could achieve on our own"],[31005,4,""],[31005,0,"no one"],[31043,53,""],[31422,0," And in that moment"],[31532,24,""],[31532,0,"But, even though "],[31550,0,"'m"],[31552,9,""],[31562,16,""],[31562,0,"at"],[31580,1,""],[31580,0,","],[31582,4,""],[31887,334,""],[31886,1,""],[32922,3,""],[32922,0,"And now"],[33020,4,""],[31650,46,""],[31650,0,"I left the researchers to it."],[31535,1,""],[31651,0,"didn't try "],[31648,0," with a task I really wanted,"],[31690,0," to help."],[31699,28,""],[31686,0," even"],[31649,29,""],[31625,0," yet"],[31862,0," Collaborative editing needed a collaboration."],[31907,0," between all of us"],[31927,5,""],[31926,1,""],[31863,0,"Oops! It turned out "],[31883,1,""],[31883,0,"c"],[31912,0,"to e "],[31916,1,""],[31915,1,""],[31915,0,"be "],[31953,458,""],[30021,1,""],[30021,0,"P"],[30031,1,""],[30031,0,"S"],[30056,0," the a"],[30061,1,""],[30061,0,"paer"],[30064,1,""],[30063,1,""],[30063,0,"per was wrong."],[30078,1,""],[30078,0,"W"],[30119,0,"*"],[30130,0,"*"],[30150,41,""],[30150,0,"run so fast you'd think you were using native strings"],[30205,4,""],[30205,0,"T"],[30355,0," I'm sort of "],[30357,11,""],[30357,0," sort of appreciate that paper now."],[30392,6,""],[30392,0," Its"],[30393,3,""],[30393,0,"Their mistake is"],[30414,5,""],[30414,0,"Its"],[30418,0,"*"],[30424,0,"*"],[30828,0,"despite what I've been told, "],[30841,14,""],[30836,5,""],[30836,0,"some"],[30836,4,""],[30836,0,"what some people think"],[30853,0,"seem to "],[30841,0,"*"],[30853,0,"*"],[30881,286,""],[31367,0,"\nAnd sometimes the best collaborations aren't between peers. Instead they look like Gilbert & Sullivan. Or Jobs and Wozniak. The same love, and the same dream but totally different skill sets brought together brought together to achieve something no one of us could achieve on our own.\n\n"],[31653,1,""],[31368,0,"But the truth is"],[31384,3,""],[31403,0," work needs a"],[31430,1,""],[31430,0,". And those collaborations can work best when they"],[31503,14,""],[31503,0,"L"],[31507,5,""],[31507,0," al"],[31509,1,""],[31509,0,"t"],[31529,0," - one guy did the music, the other the lyrics"],[31596,0," - on "],[31601,1,""],[31601,0,"e guy was the storyteller, the other the engineer"],[31652,0,"They shared"],[31663,3,""],[31663,0," "],[31664,19,""],[31664,0,"a"],[31665,5,""],[31676,0,"needed "],[31683,8,""],[31703,0," to be"],[31726,17,""],[31737,49,""],[31737,0," it. Together they made something no no"],[31775,1,""],[31774,1,""],[31774,0,"one of them could make along"],[31801,1,""],[31801,0,"e."],[31805,5,""],[31805,0,"E"],[31891,7,""],[31891,0,"But"],[31891,3,""],[31891,0,"And yet"],[32221,0," Who could have guessed!"],[32656,0,"faster and "],[32773,4,""],[32773,0,"us"],[32773,2,""],[32773,0,"them"],[32873,0," finally "],[32881,1,""],[30081,0,"*"],[30085,0,"*"],[29941,12,""],[29941,0,"that lots of"],[29953,8,""],[29959,0," are pretty slow"],[29975,4,""],[30279,9,""],[30284,0," like"],[30289,3,""],[30279,12,""],[30278,1,""],[30278,0," a"],[30322,0," kind of wrong"],[30650,0,"*"],[30657,0,"*. They're"],[30859,7,""],[30859,0," people"],[31524,0,"["],[31543,0,"](https://en.wikipedia.org/wiki/Gilbert_and_Sullivan)"],[31669,12,""],[31730,0," that dream"],[31772,34,""],[31772,0,"b"],[31772,1,""],[31772,0," be achieved"],[32225,5,""],[32224,1,""],[9472,9,""],[9471,1,""],[9478,0,"instea "],[9484,1,""],[9484,0,"d of stro"],[9492,1,""],[9491,1,""],[9491,0,"oring information "],[9497,12,""],[9497,0,"all the exta"],[9508,1,""],[9508,0,"ra information to make collaborative editing work, we just"],[9566,22,""],[9573,1,""],[9572,1,""],[9572,0,"e all the content"],[9623,0,"."],[9624,1,""],[9417,11,""],[9417,0,"much overhead there"],[9436,5,""],[9481,80,""],[9480,1,""],[9546,0," This obviu"],[9556,1,""],[9556,0,"ously won'"],[9565,1,""],[9564,1,""],[9564,0,"uldn't"],[9552,18,""],[9552,0,"throws away all the infroma"],[9578,1,""],[9577,1,""],[9576,1,""],[9575,1,""],[9575,0,"ormation we need for a"],[9596,1,""],[9596,0,"collaborait"],[9606,1,""],[9605,1,""],[9604,1,""],[9604,0,"ative editing, but it"],[9625,6,""],[9572,0,"extra "],[9598,3,""],[9598,0,"to make"],[9627,0," work"],[9681,5,""],[9681,0,"can"],[9687,44,""],[9689,6,""],[9689,0,"J"],[9726,1,""],[9726,0,":"],[9466,0,"["],[9475,0,"](https://gist.github.com/josephg/13efc1444660c07870fcbd0b3e917638#file-js_baseline-js-L37-L41)"],[9475,0," benchmark"],[9475,10,""],[9569,1,""],[9477,92,""],[9475,2,""],[9466,1,""],[9571,6,""],[9683,0,"It turns out "],[9696,1,""],[9696,0,"j"],[9723,5,""],[9724,0,"*"],[9729,0,"*"],[15247,26,""],[15247,0,"automerge (v1.0.0-preview2)"],[9849,26,""],[9849,0,"automerge (v1.0.0-preview2)"],[15276,1,""],[9877,1,""],[10870,86,""],[10870,0,"I"],[10870,59,""],[10869,1,""],[10868,1,""],[10868,0,", and the code"],[10868,1,""],[10868,0,"."],[10751,0,"["],[10751,1,""],[10763,0,"["],[10800,0,"](https://github.com/automerge/automerge-rs/)"],[10916,12,""],[10916,0,"On this test the code"],[10933,4,""],[10933,0,"rust code performs l"],[10952,1,""],[10952,0,"almost "],[10665,294,""],[10665,0,"Automerge was just never written with performance in mind. Their team is working on a replacement [rust implementation of the algorithm](https://github.com/automerge/automerge-rs/) to run through wasm, but at the time of writing it hasn't landed yet. On this test the rust code performs almost"],[9877,0,"*"],[10944,15,""],[10944,0,"is br"],[10948,1,""],[10948,0,"arely faster than the javascript."],[10946,0," only"],[10975,0,"equivalent "],[10975,11,""],[10916,70,""],[10916,0," I got the master branch working, but they obviously have some kinks to work out - its barely faster than"],[10999,0,"on this test "],[11034,0," the javascript equiva"],[11055,1,""],[11054,1,""],[11035,19,""],[11035,0,"automerge's javascript code."],[11064,0,"]"],[11064,1,""],[11064,0,"\n\n"],[11065,0,"---"],[11614,6,""],[11613,1,""],[11616,5,""],[11616,0,"B"],[30001,35,""],[30001,0,"said CRDTs and OT algorithms"],[30033,7,""],[30001,4,""],[30001,0,"says"],[30110,13,""],[30218,27,""],[30218,0,"we can compete with the performance of "],[30341,0,"\""],[30385,0,"\""],[30341,1,""],[30341,0,"*"],[30385,1,""],[30385,0,"*"],[30385,1,""],[30385,0,"\""],[30341,1,""],[30341,0,"\""],[30356,8,""],[30356,0,"guesses"],[30356,7,""],[30356,0,"guessing"],[30508,8,""],[30519,4,""],[30519,0,"around"],[30718,7,""],[30718,0,"And in that regard, they're"],[30932,27,""],[30927,5,""],[30927,0,"being sometimes laughed at"],[30954,0," "],[30954,1,""],[30953,1,""],[30953,0,","],[30943,0,"rudely "],[30943,7,""],[31348,14,""],[31347,1,""],[31527,3,""],[31527,0,"sometimes"],[31660,0,"(t"],[31661,1,""],[31661,0,"they're famous for"],[31661,18,""],[31661,0,"they made a bunch of famous musicals). "],[31700,3,""],[31700,0,"O"],[31700,0,"But they w"],[31709,1,""],[31700,9,""],[31708,3,""],[31708,0,"wrote"],[31665,8,""],[31665,0," wrote a "],[31921,12,""],[31921,0,"body"],[31932,4,""],[31932,0,"do"],[32354,23,""],[32354,0,"Ironic!"],[32354,7,""],[32354,0,"Who could have guessed!"],[32354,0,"How ironic! "],[32388,1,""],[32388,0,"?!"],[244,0," -->"],[188,0,"<!-- "],[249,4,""],[188,62,""],[378,4,""],[377,1,""],[803,1,""],[22542,3,""],[22572,10,""],[22572,0," to human scale"],[22635,0,"we can imagine "],[22530,5,""],[22530,0,"The numbers s"],[22542,1,""],[22542,0,"are t"],[22546,1,""],[22530,16,""],[22529,1,""],[22531,38,""],[22531,0,"At a"],[22594,1,""],[22593,1,""],[22593,0," "],[22594,15,""],[22613,5,""],[22613,0,"might"],[22641,0,"."],[22612,17,""],[22612,0," takes"],[22631,0," And"],[22635,49,""],[22635,0," every"],[22640,1,""],[22639,1,""],[22638,1,""],[22637,1,""],[22636,1,""],[22636,0,"a "],[22660,23,""],[22660,0,"takes"],[22671,0,"r"],[22671,1,""],[22685,0," T"],[22686,1,""],[22686,0,"It "],[22688,1,""],[22688,0,"s the difference between a single heart beat, and the time taken to brush your teeth."],[27782,9,""],[29652,0," They should add"],[29653,15,""],[29653,0,"The bottom two rows should add up to our rust performance - but"],[29720,3,""],[29720,0,"+"],[29725,15,""],[29725,0,"iss "],[29728,1,""],[29727,1,""],[29727,0," less than"],[29652,0," The rust impleem"],[29668,1,""],[29667,1,""],[29667,0,"menet"],[29671,1,""],[29670,1,""],[29670,0,"tation "],[29653,24,""],[29652,1,""],[29591,0," a lot"],[29674,4,""],[29674,0,"entries"],[29659,22,""],[29659,0,"The rust performance (65ms) is the "],[29687,7,""],[29687,0,"should be the sum of the time spent in ropey (29ms) + the time spent in "],[29756,3,""],[29756,0,"updat "],[29761,1,""],[29761,0,"ing my b-tree (23ms). But its not"],[29794,69,""],[29794,0,"."],[29796,0,"The difference is probably caused by"],[29832,13,""],[29832,0," "],[29856,43,""],[29856,0," or something"],[29920,4,""],[29920,0,"my per"],[29925,1,""],[29924,1,""],[29923,1,""],[29922,1,""],[29927,0," performance all the way"],[29871,0,"It "],[29874,1,""],[29874,0,"l"],[29871,0,"If I'm writ"],[29881,1,""],[29880,1,""],[29879,1,""],[29878,1,""],[29878,0,"right "],[29884,13,""],[29883,1,""],[29435,0," Remember, these perfora"],[29458,1,""],[29458,0,"mance t"],[29464,1,""],[29464,0,"numbers describe how much time it take s"],[29503,1,""],[29502,1,""],[29502,0,"s to process 27"],[29516,1,""],[29516,0,"60 000 operations. S"],[29535,1,""],[29534,1,""],[29515,0,"a "],[29516,1,""],[29515,1,""],[29533,0," from a single user"],[29553,0," "],[29533,19,""],[29515,0,"an editing trace of "],[29436,120,""],[29435,0," We're processing 260 000 operations in 23ms, or "],[29483,1,""],[29481,2,""],[29481,0,"which is"],[29512,1,""],[29512,0,"per"],[29543,0," home"],[29574,4,""],[29574,0,"edits"],[29583,5,""],[29580,3,""],[29580,0,"I'd still ahve"],[29593,1,""],[29592,1,""],[29591,1,""],[29590,1,""],[29590,0,"have"],[29731,0,"full "],[29753,0," "],[29753,1,""],[29753,0,"benchmark "],[29866,11,""],[29866,0,"But those numbers don't addu "],[29894,1,""],[29893,1,""],[29893,0," up!"],[29897,1,""],[29958,13,""],[29972,0,","],[29934,14,""],[29944,0," thrashing, because all the up"],[29972,2,""],[29972,0,"b-tree updates are interleaved"],[29954,48,""],[22960,12,""],[22960,0," a"],[22977,1,""],[22958,2,""],[22958,0,"first requires"],[22939,4,""],[22939,0,"figuring out your"],[23004,37,""],[23004,0,"You just have a list of places"],[23034,11,""],[23034,0," "],[23048,0," - \"Under the couch\", \"On top of the r"],[23085,1,""],[23085,0,"fridge\", and so on."],[23104,1,""],[23105,96,""],[23105,0,"And you have to "],[23105,16,""],[23105,0,"On top of your fridge is a little note saying you need toothpaste."],[23144,6,""],[23144,0,"mentioning"],[23158,0," actually"],[23209,0," through your"],[23202,20,""],[23202,0,"its going to take you a long time to"],[23238,46,""],[23238,0," "],[23238,1,""],[23238,0," go "],[23239,3,""],[23239,0,"figure out what to uy"],[23259,1,""],[23258,1,""],[23258,0,"buy."],[22939,38,""],[22939,0,"your shopping list "],[22958,8,""],[22958,0,"describes"],[22958,9,""],[22958,0,"invol"],[22958,5,""],[22958,0,"is"],[22534,1,""],[22533,1,""],[22684,3,""],[22684,0,"This is"],[22723,11,""],[22723,0," beat of your heart"],[22756,0," it takes"],[22765,6,""],[22724,0,"heart"],[22733,14,""],[22962,2,""],[22962,0,"actually"],[22962,0,"is "],[22965,8,""],[22964,1,""],[22964,0," actually"],[22990,48,""],[22990,0,":"],[23046,14,""],[23046,0,"Under the couch "],[23062,8,""],[23093,9,""],[23128,59,""],[23128,0,"going to tho"],[23139,1,""],[23139,0,"e "],[23128,13,""],[23128,0,"doing the grocery shopping will be a chore."],[23170,1,""],[23128,5,""],[23128,0,"this makes doing "],[23144,1,""],[23166,8,""],[22871,7,""],[22871,0,"would be like"],[22953,9,""],[23163,7,""],[23163,0,"a laot of "],[23172,1,""],[23171,1,""],[23170,1,""],[23169,1,""],[23168,1,""],[23167,1,""],[23166,1,""],[23166,0,"ot of work"],[23177,0," We "],[23180,1,""],[23179,1,""],[23178,1,""],[23177,1,""],[23177,0," "],[23177,1,""],[23177,0," We can fix this"],[22908,1,""],[22908,0,". But"],[22914,5,""],[23177,15,""],[23176,1,""],[23308,0," (So when I pick up my grocery list, it has all the information I need)."],[23381,22,""],[23381,0,"L"],[23397,3,""],[23427,0," for this reason"],[23432,11,""],[23432,0,"exactly this reason"],[23451,15,""],[23637,1,""],[23637,0," "],[23634,16,""],[23634,0,"h"],[23634,1,""],[23634,0,"things other than text editing"],[23664,6,""],[23679,2,""],[23679,0,"the progrm"],[23688,1,""],[23688,0,"am"],[23313,18,""],[23313,0,"a single read of my "],[23345,0," tells me"],[23354,8,""],[23381,0," to know"],[23609,4,""],[23609,0,"And "],[23607,0,", which in yjs has linear performance"],[23626,0,"a "],[23646,0," cost"],[23653,0,"This doesn't happe "],[23671,1,""],[23671,0,"n num"],[23675,1,""],[23674,1,""],[23673,1,""],[23673,0,"much in a text docu"],[23678,14,""],[23678,0,"when text editing, but "],[23701,4,""],[23728,35,""],[23728,0," in other cases too"],[23784,2,""],[23784,0,"need"],[23346,5,""],[23346,0,"would con"],[23352,3,""],[23352,0,"tell us"],[23359,25,""],[23357,2,""],[23357,0,"me"],[23358,1,""],[23357,1,""],[23357,0,"us everything we"],[38705,5,""],[39950,9,""],[39966,0," "],[39966,1,""],[39950,0,"database using "],[31793,20,""],[31792,1,""],[31792,0,"'re be"],[31797,1,""],[31796,1,""],[31795,1,""],[31794,1,""],[31793,1,""],[31792,1,""],[31792,0," involve people with different skillsets"],[31831,1,""],[31830,1,""],[31829,1,""],[32452,8,""],[32452,0,"maybe we would"],[5329,258,""],[5328,0,"\n\nMartin explains i"],[5330,17,""],[5330,0,"Martin explains Automerge"],[5346,1,""],[5346,0,"a"],[5355,0," far better than I will in this talk:\n\n<iframe width=\"560\" height=\"315\" src=\"https://www.youtube-nocookie.com/embed/x7drE24geUw?start=1237\" title=\"YouTube video player\" frameborder=\"0\" allow=\"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture\" allowfullscreen></iframe>"],[5374,0,"v"],[5374,1,""],[5374,0,"ev"],[5375,1,""],[5374,1,""],[5391,0," from 2020"],[5891,1,""],[5891,0,"\n\nImagine I"],[5902,7,""],[5913,1,""],[5913,0,"."],[5913,1,""],[5913,0," into an empty document."],[5939,0,"A"],[5939,1,""],[5938,1,""],[5938,0,"A"],[6135,15,""],[6135,0,"<img src=\"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB2ZXJzaW9uPSIxLjEiIHdpZHRoPSIxOTFweCIgaGVpZ2h0PSIxNjFweCIgdmlld0JveD0iLTAuNSAtMC41IDE5MSAxNjEiPjxkZWZzLz48Zz48cGF0aCBkPSJNIDUwIDYwIEwgMjAgNjAgTCAyMCA0Ni4zNyIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjMjQyNDI0IiBzdHJva2UtbWl0ZXJsaW1pdD0iMTAiIHBvaW50ZXItZXZlbnRzPSJzdHJva2UiLz48cGF0aCBkPSJNIDIwIDQxLjEyIEwgMjMuNSA0OC4xMiBMIDIwIDQ2LjM3IEwgMTYuNSA0OC4xMiBaIiBmaWxsPSIjMjQyNDI0IiBzdHJva2U9IiMyNDI0MjQiIHN0cm9rZS1taXRlcmxpbWl0PSIxMCIgcG9pbnRlci1ldmVudHM9ImFsbCIvPjxyZWN0IHg9IjUwIiB5PSI0MCIgd2lkdGg9IjQwIiBoZWlnaHQ9IjQwIiBmaWxsPSIjZmZmZmZmIiBzdHJva2U9IiMwMDAwMDAiIHBvaW50ZXItZXZlbnRzPSJhbGwiLz48ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgtMC41IC0wLjUpIj48c3dpdGNoPjxmb3JlaWduT2JqZWN0IHN0eWxlPSJvdmVyZmxvdzogdmlzaWJsZTsgdGV4dC1hbGlnbjogbGVmdDsiIHBvaW50ZXItZXZlbnRzPSJub25lIiB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiByZXF1aXJlZEZlYXR1cmVzPSJodHRwOi8vd3d3LnczLm9yZy9UUi9TVkcxMS9mZWF0dXJlI0V4dGVuc2liaWxpdHkiPjxkaXYgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGh0bWwiIHN0eWxlPSJkaXNwbGF5OiBmbGV4OyBhbGlnbi1pdGVtczogdW5zYWZlIGNlbnRlcjsganVzdGlmeS1jb250ZW50OiB1bnNhZmUgY2VudGVyOyB3aWR0aDogMzhweDsgaGVpZ2h0OiAxcHg7IHBhZGRpbmctdG9wOiA2MHB4OyBtYXJnaW4tbGVmdDogNTFweDsiPjxkaXYgc3R5bGU9ImJveC1zaXppbmc6IGJvcmRlci1ib3g7IGZvbnQtc2l6ZTogMDsgdGV4dC1hbGlnbjogY2VudGVyOyAiPjxkaXYgc3R5bGU9ImRpc3BsYXk6IGlubGluZS1ibG9jazsgZm9udC1zaXplOiAxMnB4OyBmb250LWZhbWlseTogSGVsdmV0aWNhOyBjb2xvcjogIzAwMDAwMDsgbGluZS1oZWlnaHQ6IDEuMjsgcG9pbnRlci1ldmVudHM6IGFsbDsgd2hpdGUtc3BhY2U6IG5vcm1hbDsgd29yZC13cmFwOiBub3JtYWw7ICI+YTwvZGl2PjwvZGl2PjwvZGl2PjwvZm9yZWlnbk9iamVjdD48dGV4dCB4PSI3MCIgeT0iNjQiIGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJIZWx2ZXRpY2EiIGZvbnQtc2l6ZT0iMTJweCIgdGV4dC1hbmNob3I9Im1pZGRsZSI+YTwvdGV4dD48L3N3aXRjaD48L2c+PHBhdGggZD0iTSAxMDAgMTAwIEwgNzAgMTAwIEwgNzAgODYuMzciIGZpbGw9Im5vbmUiIHN0cm9rZT0iIzI0MjQyNCIgc3Ryb2tlLW1pdGVybGltaXQ9IjEwIiBwb2ludGVyLWV2ZW50cz0ic3Ryb2tlIi8+PHBhdGggZD0iTSA3MCA4MS4xMiBMIDczLjUgODguMTIgTCA3MCA4Ni4zNyBMIDY2LjUgODguMTIgWiIgZmlsbD0iIzI0MjQyNCIgc3Ryb2tlPSIjMjQyNDI0IiBzdHJva2UtbWl0ZXJsaW1pdD0iMTAiIHBvaW50ZXItZXZlbnRzPSJhbGwiLz48cmVjdCB4PSIxMDAiIHk9IjgwIiB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIGZpbGw9IiNmZmZmZmYiIHN0cm9rZT0ibm9uZSIgcG9pbnRlci1ldmVudHM9ImFsbCIvPjxnIHRyYW5zZm9ybT0idHJhbnNsYXRlKC0wLjUgLTAuNSkiPjxzd2l0Y2g+PGZvcmVpZ25PYmplY3Qgc3R5bGU9Im92ZXJmbG93OiB2aXNpYmxlOyB0ZXh0LWFsaWduOiBsZWZ0OyIgcG9pbnRlci1ldmVudHM9Im5vbmUiIHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIHJlcXVpcmVkRmVhdHVyZXM9Imh0dHA6Ly93d3cudzMub3JnL1RSL1NWRzExL2ZlYXR1cmUjRXh0ZW5zaWJpbGl0eSI+PGRpdiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94aHRtbCIgc3R5bGU9ImRpc3BsYXk6IGZsZXg7IGFsaWduLWl0ZW1zOiB1bnNhZmUgY2VudGVyOyBqdXN0aWZ5LWNvbnRlbnQ6IHVuc2FmZSBjZW50ZXI7IHdpZHRoOiAzOHB4OyBoZWlnaHQ6IDFweDsgcGFkZGluZy10b3A6IDEwMHB4OyBtYXJnaW4tbGVmdDogMTAxcHg7Ij48ZGl2IHN0eWxlPSJib3gtc2l6aW5nOiBib3JkZXItYm94OyBmb250LXNpemU6IDA7IHRleHQtYWxpZ246IGNlbnRlcjsgIj48ZGl2IHN0eWxlPSJkaXNwbGF5OiBpbmxpbmUtYmxvY2s7IGZvbnQtc2l6ZTogMTJweDsgZm9udC1mYW1pbHk6IEhlbHZldGljYTsgY29sb3I6ICMwMDAwMDA7IGxpbmUtaGVpZ2h0OiAxLjI7IHBvaW50ZXItZXZlbnRzOiBhbGw7IHdoaXRlLXNwYWNlOiBub3JtYWw7IHdvcmQtd3JhcDogbm9ybWFsOyAiPmI8L2Rpdj48L2Rpdj48L2Rpdj48L2ZvcmVpZ25PYmplY3Q+PHRleHQgeD0iMTIwIiB5PSIxMDQiIGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJIZWx2ZXRpY2EiIGZvbnQtc2l6ZT0iMTJweCIgdGV4dC1hbmNob3I9Im1pZGRsZSI+YjwvdGV4dD48L3N3aXRjaD48L2c+PHBhdGggZD0iTSAxNTAgMTQwIEwgMTIwIDE0MCBMIDEyMCAxMjYuMzciIGZpbGw9Im5vbmUiIHN0cm9rZT0iIzI0MjQyNCIgc3Ryb2tlLW1pdGVybGltaXQ9IjEwIiBwb2ludGVyLWV2ZW50cz0ic3Ryb2tlIi8+PHBhdGggZD0iTSAxMjAgMTIxLjEyIEwgMTIzLjUgMTI4LjEyIEwgMTIwIDEyNi4zNyBMIDExNi41IDEyOC4xMiBaIiBmaWxsPSIjMjQyNDI0IiBzdHJva2U9IiMyNDI0MjQiIHN0cm9rZS1taXRlcmxpbWl0PSIxMCIgcG9pbnRlci1ldmVudHM9ImFsbCIvPjxyZWN0IHg9IjE1MCIgeT0iMTIwIiB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIGZpbGw9IiNmZmZmZmYiIHN0cm9rZT0ibm9uZSIgcG9pbnRlci1ldmVudHM9ImFsbCIvPjxnIHRyYW5zZm9ybT0idHJhbnNsYXRlKC0wLjUgLTAuNSkiPjxzd2l0Y2g+PGZvcmVpZ25PYmplY3Qgc3R5bGU9Im92ZXJmbG93OiB2aXNpYmxlOyB0ZXh0LWFsaWduOiBsZWZ0OyIgcG9pbnRlci1ldmVudHM9Im5vbmUiIHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIHJlcXVpcmVkRmVhdHVyZXM9Imh0dHA6Ly93d3cudzMub3JnL1RSL1NWRzExL2ZlYXR1cmUjRXh0ZW5zaWJpbGl0eSI+PGRpdiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94aHRtbCIgc3R5bGU9ImRpc3BsYXk6IGZsZXg7IGFsaWduLWl0ZW1zOiB1bnNhZmUgY2VudGVyOyBqdXN0aWZ5LWNvbnRlbnQ6IHVuc2FmZSBjZW50ZXI7IHdpZHRoOiAzOHB4OyBoZWlnaHQ6IDFweDsgcGFkZGluZy10b3A6IDE0MHB4OyBtYXJnaW4tbGVmdDogMTUxcHg7Ij48ZGl2IHN0eWxlPSJib3gtc2l6aW5nOiBib3JkZXItYm94OyBmb250LXNpemU6IDA7IHRleHQtYWxpZ246IGNlbnRlcjsgIj48ZGl2IHN0eWxlPSJkaXNwbGF5OiBpbmxpbmUtYmxvY2s7IGZvbnQtc2l6ZTogMTJweDsgZm9udC1mYW1pbHk6IEhlbHZldGljYTsgY29sb3I6ICMwMDAwMDA7IGxpbmUtaGVpZ2h0OiAxLjI7IHBvaW50ZXItZXZlbnRzOiBhbGw7IHdoaXRlLXNwYWNlOiBub3JtYWw7IHdvcmQtd3JhcDogbm9ybWFsOyAiPmM8L2Rpdj48L2Rpdj48L2Rpdj48L2ZvcmVpZ25PYmplY3Q+PHRleHQgeD0iMTcwIiB5PSIxNDQiIGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJIZWx2ZXRpY2EiIGZvbnQtc2l6ZT0iMTJweCIgdGV4dC1hbmNob3I9Im1pZGRsZSI+YzwvdGV4dD48L3N3aXRjaD48L2c+PHJlY3QgeD0iMCIgeT0iMCIgd2lkdGg9IjQwIiBoZWlnaHQ9IjQwIiBmaWxsPSIjZmZmZmZmIiBzdHJva2U9IiMwMDAwMDAiIHBvaW50ZXItZXZlbnRzPSJhbGwiLz48ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgtMC41IC0wLjUpIj48c3dpdGNoPjxmb3JlaWduT2JqZWN0IHN0eWxlPSJvdmVyZmxvdzogdmlzaWJsZTsgdGV4dC1hbGlnbjogbGVmdDsiIHBvaW50ZXItZXZlbnRzPSJub25lIiB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiByZXF1aXJlZEZlYXR1cmVzPSJodHRwOi8vd3d3LnczLm9yZy9UUi9TVkcxMS9mZWF0dXJlI0V4dGVuc2liaWxpdHkiPjxkaXYgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGh0bWwiIHN0eWxlPSJkaXNwbGF5OiBmbGV4OyBhbGlnbi1pdGVtczogdW5zYWZlIGNlbnRlcjsganVzdGlmeS1jb250ZW50OiB1bnNhZmUgY2VudGVyOyB3aWR0aDogMzhweDsgaGVpZ2h0OiAxcHg7IHBhZGRpbmctdG9wOiAyMHB4OyBtYXJnaW4tbGVmdDogMXB4OyI+PGRpdiBzdHlsZT0iYm94LXNpemluZzogYm9yZGVyLWJveDsgZm9udC1zaXplOiAwOyB0ZXh0LWFsaWduOiBjZW50ZXI7ICI+PGRpdiBzdHlsZT0iZGlzcGxheTogaW5saW5lLWJsb2NrOyBmb250LXNpemU6IDEycHg7IGZvbnQtZmFtaWx5OiBIZWx2ZXRpY2E7IGNvbG9yOiAjMDAwMDAwOyBsaW5lLWhlaWdodDogMS4yOyBwb2ludGVyLWV2ZW50czogYWxsOyBmb250LXN0eWxlOiBpdGFsaWM7IHdoaXRlLXNwYWNlOiBub3JtYWw7IHdvcmQtd3JhcDogbm9ybWFsOyAiPihyb290KTwvZGl2PjwvZGl2PjwvZGl2PjwvZm9yZWlnbk9iamVjdD48dGV4dCB4PSIyMCIgeT0iMjQiIGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJIZWx2ZXRpY2EiIGZvbnQtc2l6ZT0iMTJweCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1zdHlsZT0iaXRhbGljIj4ocm9vdCk8L3RleHQ+PC9zd2l0Y2g+PC9nPjwvZz48c3dpdGNoPjxnIHJlcXVpcmVkRmVhdHVyZXM9Imh0dHA6Ly93d3cudzMub3JnL1RSL1NWRzExL2ZlYXR1cmUjRXh0ZW5zaWJpbGl0eSIvPjxhIHRyYW5zZm9ybT0idHJhbnNsYXRlKDAsLTUpIiB4bGluazpocmVmPSJodHRwczovL3d3dy5kaWFncmFtcy5uZXQvZG9jL2ZhcS9zdmctZXhwb3J0LXRleHQtcHJvYmxlbXMiIHRhcmdldD0iX2JsYW5rIj48dGV4dCB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LXNpemU9IjEwcHgiIHg9IjUwJSIgeT0iMTAwJSI+Vmlld2VyIGRvZXMgbm90IHN1cHBvcnQgZnVsbCBTVkcgMS4xPC90ZXh0PjwvYT48L3N3aXRjaD48L3N2Zz4=\" />\n"],[6135,6616,""],[6135,0,"<svg xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" version=\"1.1\" width=\"192px\" viewBox=\"-0.5 -0.5 192 162\" style=\"max-width:100%;max-height:162px;\"><defs/><g><path d=\"M 51 61 L 21 61 L 21 47.37\" fill=\"none\" stroke=\"#242424\" stroke-miterlimit=\"10\" pointer-events=\"stroke\"/><path d=\"M 21 42.12 L 24.5 49.12 L 21 47.37 L 17.5 49.12 Z\" fill=\"#242424\" stroke=\"#242424\" stroke-miterlimit=\"10\" pointer-events=\"all\"/><rect x=\"51\" y=\"41\" width=\"40\" height=\"40\" fill=\"#ffffff\" stroke=\"#808080\" stroke-width=\"2\" pointer-events=\"all\"/><g transform=\"translate(-0.5 -0.5)\"><switch><foreignObject style=\"overflow: visible; text-align: left;\" pointer-events=\"none\" width=\"100%\" height=\"100%\" requiredFeatures=\"http://www.w3.org/TR/SVG11/feature#Extensibility\"><div xmlns=\"http://www.w3.org/1999/xhtml\" style=\"display: flex; align-items: unsafe center; justify-content: unsafe center; width: 38px; height: 1px; padding-top: 61px; margin-left: 52px;\"><div style=\"box-sizing: border-box; font-size: 0; text-align: center; \"><div style=\"display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; \">a</div></div></div></foreignObject><text x=\"71\" y=\"65\" fill=\"#000000\" font-family=\"Helvetica\" font-size=\"12px\" text-anchor=\"middle\">a</text></switch></g><path d=\"M 101 101 L 71 101 L 71 87.37\" fill=\"none\" stroke=\"#242424\" stroke-miterlimit=\"10\" pointer-events=\"stroke\"/><path d=\"M 71 82.12 L 74.5 89.12 L 71 87.37 L 67.5 89.12 Z\" fill=\"#242424\" stroke=\"#242424\" stroke-miterlimit=\"10\" pointer-events=\"all\"/><rect x=\"101\" y=\"81\" width=\"40\" height=\"40\" fill=\"#ffffff\" stroke=\"#808080\" stroke-width=\"2\" pointer-events=\"all\"/><g transform=\"translate(-0.5 -0.5)\"><switch><foreignObject style=\"overflow: visible; text-align: left;\" pointer-events=\"none\" width=\"100%\" height=\"100%\" requiredFeatures=\"http://www.w3.org/TR/SVG11/feature#Extensibility\"><div xmlns=\"http://www.w3.org/1999/xhtml\" style=\"display: flex; align-items: unsafe center; justify-content: unsafe center; width: 38px; height: 1px; padding-top: 101px; margin-left: 102px;\"><div style=\"box-sizing: border-box; font-size: 0; text-align: center; \"><div style=\"display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; \">b</div></div></div></foreignObject><text x=\"121\" y=\"105\" fill=\"#000000\" font-family=\"Helvetica\" font-size=\"12px\" text-anchor=\"middle\">b</text></switch></g><path d=\"M 151 141 L 121 141 L 121 127.37\" fill=\"none\" stroke=\"#242424\" stroke-miterlimit=\"10\" pointer-events=\"stroke\"/><path d=\"M 121 122.12 L 124.5 129.12 L 121 127.37 L 117.5 129.12 Z\" fill=\"#242424\" stroke=\"#242424\" stroke-miterlimit=\"10\" pointer-events=\"all\"/><rect x=\"151\" y=\"121\" width=\"40\" height=\"40\" fill=\"#ffffff\" stroke=\"#808080\" stroke-width=\"2\" pointer-events=\"all\"/><g transform=\"translate(-0.5 -0.5)\"><switch><foreignObject style=\"overflow: visible; text-align: left;\" pointer-events=\"none\" width=\"100%\" height=\"100%\" requiredFeatures=\"http://www.w3.org/TR/SVG11/feature#Extensibility\"><div xmlns=\"http://www.w3.org/1999/xhtml\" style=\"display: flex; align-items: unsafe center; justify-content: unsafe center; width: 38px; height: 1px; padding-top: 141px; margin-left: 152px;\"><div style=\"box-sizing: border-box; font-size: 0; text-align: center; \"><div style=\"display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; \">c</div></div></div></foreignObject><text x=\"171\" y=\"145\" fill=\"#000000\" font-family=\"Helvetica\" font-size=\"12px\" text-anchor=\"middle\">c</text></switch></g><rect x=\"1\" y=\"1\" width=\"40\" height=\"40\" fill=\"#ffffff\" stroke=\"#808080\" stroke-width=\"2\" pointer-events=\"all\"/><g transform=\"translate(-0.5 -0.5)\"><switch><foreignObject style=\"overflow: visible; text-align: left;\" pointer-events=\"none\" width=\"100%\" height=\"100%\" requiredFeatures=\"http://www.w3.org/TR/SVG11/feature#Extensibility\"><div xmlns=\"http://www.w3.org/1999/xhtml\" style=\"display: flex; align-items: unsafe center; justify-content: unsafe center; width: 38px; height: 1px; padding-top: 21px; margin-left: 2px;\"><div style=\"box-sizing: border-box; font-size: 0; text-align: center; \"><div style=\"display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; font-style: italic; white-space: normal; word-wrap: normal; \">(root)</div></div></div></foreignObject><text x=\"21\" y=\"25\" fill=\"#000000\" font-family=\"Helvetica\" font-size=\"12px\" text-anchor=\"middle\" font-style=\"italic\">(root)</text></switch></g></g><switch><g requiredFeatures=\"http://www.w3.org/TR/SVG11/feature#Extensibility\"/><a transform=\"translate(0,-5)\" xlink:href=\"https://www.diagrams.net/doc/faq/svg-export-text-problems\" target=\"_blank\"><text text-anchor=\"middle\" font-size=\"10px\" x=\"50%\" y=\"100%\">Viewer does not support full SVG 1.1</text></a></switch></svg>"],[6134,5033,""],[6134,0,"\n\n"],[6135,0,"> automerge1.drawio.svg"],[6433,12,""],[6433,0,"automerge2.draio"],[6448,1,""],[6447,1,""],[6447,0,"wio.svg"],[6505,58,""],[6581,1,""],[6581,0,". Hang on, how do we figure out which character goes first? "],[6641,6,""],[6641,0,"W"],[6583,0,"But "],[6587,1,""],[6587,0,"h"],[6543,12,""],[6542,1,""],[6635,3,""],[6635,0,"could just picked"],[6651,1,""],[6650,1,""],[6547,0," concurrently"],[6581,0," in the document"],[6675,49,""],[6675,0,"sort by their "],[6689,4,""],[6689,0,"u"],[6689,1,""],[6689,0,"agent"],[6698,0," or something"],[6515,10,""],[6587,0,", o"],[6589,1,""],[6588,1,""],[6587,1,""],[6592,9,""],[6661,2,""],[6661,0,"using"],[6734,5,""],[6734,0,"could"],[6770,17,""],[6770,0,"m"],[6770,1,""],[6770,0,"Mike inserted *X*"],[6963,8,""],[6963,0,"sometin"],[6969,1,""],[6968,1,""],[6968,0,"hing"],[6846,0," (RGA)"],[7431,0," "],[7431,1,""],[7431,0," The rule is that the bigge"],[7449,9,""],[7449,0,"whenever"],[7449,8,""],[7449,0,"children are sorted first based on theisr"],[7489,1,""],[7488,1,""],[7487,1,""],[7487,0,"r"],[7487,1,""],[7487,0,"ir sequence numbers (bug"],[7510,1,""],[7509,1,""],[7509,0,"igger sequence number first). Then they're "],[7539,13,""],[7539,0,"On"],[7540,1,""],[7539,1,""],[7539,0,"If the sequence numbers match, they get"],[7539,3,""],[7539,0,"Only if "],[7583,0," sorted based on their "],[7539,6,""],[7539,0,"I"],[7569,0," they must be concurrent changes. In that case"],[7632,0,"arbitrarily "],[7659,0,"agent IDs."],[7431,1,""],[7431,0,"\n\n"],[7571,4,""],[7571,0,"the changes"],[7601,8,""],[7616,8,""],[7616,0,"we"],[7618,7,""],[7618,0," sort them"],[7619,0,"can "],[7670,0," (We do this because we"],[7692,1,""],[7691,1,""],[7691,0,"all peers"],[7691,9,""],[7691,0,"its important all peers ne"],[7716,1,""],[7715,1,""],[7715,0,"end up with the same document)"],[7744,0,"."],[7677,0," it this way"],[7689,5,""],[7690,21,""],[7690,0,"so"],[7723,0," resulting"],[9521,1,""],[9521,0,"6"],[9819,2,""],[9819,0,"I'm"],[9822,4,""],[9829,1,""],[9829,0,"ing"],[9821,11,""],[9821,0,"ll compare"],[9879,8,""],[9879,0," edits"],[9937,4,""],[9964,5,""],[9964,0," do"],[9989,5,""],[11635,0,"from microoptimizations - "],[11645,0,"-"],[11635,27,""],[11699,1,""],[11699,0,"."],[11701,1,""],[11701,0,"B"],[11686,0," lots of"],[12342,0," If I werwe"],[12352,1,""],[12351,1,""],[12351,0,"e going to build col"],[12368,3,""],[12368,0,"c"],[12368,1,""],[12368,0,"software which supporte"],[12390,1,""],[12390,0,"s collaborative editing today, I'd build it on yjs."],[12437,1,""],[12437,0,"Y"],[12425,12,""],[12425,0,"use "],[10325,0,"\nWe"],[10327,1,""],[10326,1,""],[10326,0,"This is a chart of automerge's "],[10326,31,""],[10326,0,"Automerge"],[10326,9,""],[10326,0,"This is a chart of automerge\n\n<svg class=\"plot\" fill=\"currentColor\" text-anchor=\"middle\" width=\"700\" height=\"400\" viewBox=\"0 0 700 400\"><g transform=\"translate(40,0)\" fill=\"none\" text-anchor=\"end\"><g class=\"tick\" opacity=\"1\" transform=\"translate(0,370.5)\"><line stroke=\"currentColor\" x2=\"-6\"></line><line stroke=\"currentColor\" x2=\"600\" stroke-opacity=\"0.1\"></line><text fill=\"currentColor\" x=\"-9\" dy=\"0.32em\">0.0</text></g><g class=\"tick\" opacity=\"1\" transform=\"translate(0,322.49637377865497)\"><line stroke=\"currentColor\" x2=\"-6\"></line><line stroke=\"currentColor\" x2=\"600\" stroke-opacity=\"0.1\"></line><text fill=\"currentColor\" x=\"-9\" dy=\"0.32em\">0.5</text></g><g class=\"tick\" opacity=\"1\" transform=\"translate(0,274.4927475573099)\"><line stroke=\"currentColor\" x2=\"-6\"></line><line stroke=\"currentColor\" x2=\"600\" stroke-opacity=\"0.1\"></line><text fill=\"currentColor\" x=\"-9\" dy=\"0.32em\">1.0</text></g><g class=\"tick\" opacity=\"1\" transform=\"translate(0,226.48912133596485)\"><line stroke=\"currentColor\" x2=\"-6\"></line><line stroke=\"currentColor\" x2=\"600\" stroke-opacity=\"0.1\"></line><text fill=\"currentColor\" x=\"-9\" dy=\"0.32em\">1.5</text></g><g class=\"tick\" opacity=\"1\" transform=\"translate(0,178.48549511461982)\"><line stroke=\"currentColor\" x2=\"-6\"></line><line stroke=\"currentColor\" x2=\"600\" stroke-opacity=\"0.1\"></line><text fill=\"currentColor\" x=\"-9\" dy=\"0.32em\">2.0</text></g><g class=\"tick\" opacity=\"1\" transform=\"translate(0,130.48186889327476)\"><line stroke=\"currentColor\" x2=\"-6\"></line><line stroke=\"currentColor\" x2=\"600\" stroke-opacity=\"0.1\"></line><text fill=\"currentColor\" x=\"-9\" dy=\"0.32em\">2.5</text></g><g class=\"tick\" opacity=\"1\" transform=\"translate(0,82.47824267192972)\"><line stroke=\"currentColor\" x2=\"-6\"></line><line stroke=\"currentColor\" x2=\"600\" stroke-opacity=\"0.1\"></line><text fill=\"currentColor\" x=\"-9\" dy=\"0.32em\">3.0</text></g><g class=\"tick\" opacity=\"1\" transform=\"translate(0,34.47461645058467)\"><line stroke=\"currentColor\" x2=\"-6\"></line><line stroke=\"currentColor\" x2=\"600\" stroke-opacity=\"0.1\"></line><text fill=\"currentColor\" x=\"-9\" dy=\"0.32em\">3.5</text></g><text fill=\"currentColor\" transform=\"translate(-40,20)\" dy=\"-1em\" text-anchor=\"start\"> time per txn (ms)</text></g><g transform=\"translate(0,370)\" fill=\"none\" text-anchor=\"middle\"><g class=\"tick\" opacity=\"1\" transform=\"translate(40.5,0)\"><line stroke=\"currentColor\" y2=\"6\"></line><line stroke=\"currentColor\" y2=\"-350\" stroke-opacity=\"0.1\"></line><text fill=\"currentColor\" y=\"9\" dy=\"0.71em\">0</text></g><g class=\"tick\" opacity=\"1\" transform=\"translate(155.98322028809213,0)\"><line stroke=\"currentColor\" y2=\"6\"></line><line stroke=\"currentColor\" y2=\"-350\" stroke-opacity=\"0.1\"></line><text fill=\"currentColor\" y=\"9\" dy=\"0.71em\">50,000</text></g><g class=\"tick\" opacity=\"1\" transform=\"translate(271.46644057618425,0)\"><line stroke=\"currentColor\" y2=\"6\"></line><line stroke=\"currentColor\" y2=\"-350\" stroke-opacity=\"0.1\"></line><text fill=\"currentColor\" y=\"9\" dy=\"0.71em\">100,000</text></g><g class=\"tick\" opacity=\"1\" transform=\"translate(386.94966086427644,0)\"><line stroke=\"currentColor\" y2=\"6\"></line><line stroke=\"currentColor\" y2=\"-350\" stroke-opacity=\"0.1\"></line><text fill=\"currentColor\" y=\"9\" dy=\"0.71em\">150,000</text></g><g class=\"tick\" opacity=\"1\" transform=\"translate(502.43288115236857,0)\"><line stroke=\"currentColor\" y2=\"6\"></line><line stroke=\"currentColor\" y2=\"-350\" stroke-opacity=\"0.1\"></line><text fill=\"currentColor\" y=\"9\" dy=\"0.71em\">200,000</text></g><g class=\"tick\" opacity=\"1\" transform=\"translate(617.9161014404607,0)\"><line stroke=\"currentColor\" y2=\"6\"></line><line stroke=\"currentColor\" y2=\"-350\" stroke-opacity=\"0.1\"></line><text fill=\"currentColor\" y=\"9\" dy=\"0.71em\">250,000</text></g><text fill=\"currentColor\" transform=\"translate(700,30)\" dy=\"-0.32em\" text-anchor=\"end\">txns </text></g><g fill=\"none\" stroke=\"purple\" stroke-width=\"1.5\" stroke-miterlimit=\"1\" transform=\"translate(0.5,0.5)\"><path d=\"M42.30966440576184,334.968453217152L44.61932881152369,347.3297060008833L46.92899321728553,352.3034286308774L49.238657623047374,353.85148461209457L51.54832202880921,353.99288937369545L53.85798643457106,353.119184685576L56.1676508403329,353.5882125643014L58.47731524609475,353.94662789479634L60.78697965185658,354.0068946236547L63.096644057618434,354.1490683078529L65.40630846338027,353.5765641960213L67.71597286914212,353.6863778677001L70.02563727490396,353.28293398339684L72.3353016806658,352.9293209351293L74.64496608642764,352.9794113749642L76.9546304921895,350.64519971937096L79.26429489795132,347.5166021671373L81.57395930371317,346.34497410983045L83.88362370947502,346.06483080366127L86.19328811523685,329.7538633679724L88.5029525209987,341.20606687397316L90.81261692676054,344.17714897508205L93.12228133252239,344.02096322473784L95.43194573828421,339.15071317905466L97.74161014404606,337.4161803915942L100.05127454980791,345.529651911968L102.36093895556976,334.43219213151616L104.6706033613316,332.6128071740481L106.98026776709344,329.1433388486094L109.28993217285529,330.72351626400473L111.59959657861712,327.0967618490162L113.90926098437896,329.89010082727265L116.21892539014081,339.2226639901794L118.52858979590265,331.50890378474145L120.8382542016645,325.2647309122023L123.14791860742633,324.43846311967076L125.45758301318818,323.29314824950376L127.76724741895003,324.4245276667778L130.07691182471186,297.0018474059277L132.3865762304737,327.2634034611283L134.69624063623556,318.67958991494424L137.0059050419974,320.79089999648323L139.31556944775923,317.08631403777366L141.62523385352108,317.1262170522847L143.93489825928293,315.5594217036104L146.24456266504478,313.9409277935827L148.55422707080663,315.99555768979025L150.86389147656845,313.1872971679967L153.1735558823303,311.8466137798146L155.48322028809213,311.6192958724972L157.79288469385398,312.18679733346215L160.10254909961583,275.0526459267001L162.41221350537768,307.67335132936387L164.7218779111395,312.81199444924806L167.03154231690135,312.0217097908432L169.3412067226632,319.40058767560174L171.65087112842502,303.2904382256132L173.96053553418687,306.0601856298547L176.27019993994872,323.22592646787865L178.57986434571058,338.4754829397754L180.8895287514724,324.0422604860777L183.19919315723425,311.7291642678771L185.5088575629961,317.5852446235697L187.81852196875795,325.754799163999L190.1281863745198,273.2218301538354L192.43785078028165,307.0379464344723L194.74751518604347,308.3675182314111L197.0571795918053,305.8125952144778L199.36684399756714,315.50578542817016L201.676508403329,310.0300645885391L203.98617280909085,304.62440782643097L206.29583721485267,302.907305923881L208.60550162061452,300.7181531616053L210.91516602637637,309.3549651114627L213.22483043213822,334.854562309457L215.53449483790007,256.6764747401852L217.8441592436619,306.02416966122115L220.1538236494237,310.3887761981957L222.46348805518556,303.43580943104564L224.77315246094741,297.79652458815247L227.08281686670927,300.0300648629319L229.39248127247112,331.8233899414033L231.70214567823297,308.30299991729026L234.01181008399482,294.57287976030636L236.32147448975667,306.4273207234548L238.63113889551846,250.2423452782171L240.9408033012803,299.7219722136838L243.25046770704216,310.1519343708049L245.560132112804,298.3395931638715L247.86979651856586,296.9839028824633L250.17946092432769,294.8186880886822L252.48912533008954,315.4002676011884L254.7987897358514,328.7540567058032L257.10845414161327,296.1958934037708L259.41811854737506,285.1752623706938L261.7277829531369,223.7808467136446L264.0374473588987,293.1937300104379L266.3471117646606,289.9869132376882L268.65677617042246,291.6462404722998L270.96644057618425,289.42647291779764L273.27610498194616,288.73305852091545L275.58576938770796,285.40769612092686L277.8954337934698,211.52907397574947L280.20509819923166,296.8787805094819L282.5147626049935,282.295329170959L284.82442701075536,280.7163715275385L287.1340914165172,272.5731189417396L289.443755822279,275.0129783224233L291.75342022804085,276.9126581770053L294.0630846338027,189.08334506829772L296.37274903956455,269.75095167386496L298.6824134453264,267.29315698612555L300.9920778510882,265.8590805276817L303.30174225685005,264.501607487239L305.6114066626119,269.3548107729358L307.92107106837375,268.8816247241124L310.23073547413566,202.03719512981164L312.54039987989745,283.08538581221364L314.8500642856593,286.0625855919234L317.15972869142115,285.31391182056876L319.469393097183,283.6213318017489L321.7790575029448,191.616563149324L324.0887219087067,279.98515686757565L326.3983863144685,289.1524945249947L328.70805072023035,263.5754665180542L331.0177151259922,266.8788627463574L333.32737953175405,255.23313406131842L335.6370439375159,153.86730210866077L337.9467083432777,301.99399449969684L340.2563727490396,290.8151097199587L342.5660371548014,271.37666532881445L344.8757015605633,243.9075814030077L347.1853659663251,247.42484492269904L349.49503037208694,143.05820126289254L351.80469477784874,241.84426073806134L354.1143591836106,239.0242903080998L356.4240235893725,292.0706584851939L358.7336879951343,320.2314768731976L361.04335240089614,320.6956649302387L363.353016806658,320.0829015220471L365.66268121241984,321.2679022376054L367.9723456181817,322.1500064081641L370.2820100239436,279.7812966036057L372.59167442970534,150.62350929459564L374.90133883546713,257.0801537460953L377.21100324122904,255.46705246774198L379.5206676469909,248.08051474050524L381.83033205275274,318.5028032163361L384.1399964585146,276.7833899801005L386.44966086427644,152.70123680729728L388.75932527003823,256.6348536760652L391.06898967580014,245.0570589547315L393.378654081562,270.61816627165695L395.6883184873238,291.8337743186176L397.99798289308563,280.8975785923264L400.3076472988474,253.8488537800058L402.61731170460934,147.2092245933975L404.92697611037113,267.5180237332205L407.23664051613304,269.12887056904947L409.54630492189483,263.69664792804076L411.8559693276567,261.98689326829947L414.16563373341853,139.71486284935736L416.4752981391804,261.370087858105L418.78496254494223,255.87257318100725L421.0946269507041,251.42154830828582L423.40429135646593,131.12237322332066L425.7139557622277,249.9432022329065L428.02362016798963,256.1754197061827L430.3332845737514,254.50504213301897L432.64294897951333,146.26343237985773L434.9526133852751,315.7184830632591L437.2622777910369,302.10868524317397L439.57194219679883,255.69386672151452L441.8816066025606,256.41916570277965L444.19127100832253,248.13793562231044L446.5009354140843,114.02454935610312L448.8105998198462,287.79113971980667L451.120264225608,312.85080038886963L453.42992863136993,247.3359109086496L455.7395930371317,243.34848556827768L458.04925744289346,257.7248076918354L460.35892184865537,119.47206998493448L462.6685862544172,265.91938940330715L464.97825066017907,242.72561048392126L467.2879150659409,282.8106164159161L469.5975794717028,107.43905265210508L471.90724387746457,262.2833716323476L474.2169082832265,252.86015026091383L476.5265726889883,269.4731244463173L478.8362370947501,233.83269544419872L481.14590150051197,100.98776160576477L483.45556590627376,244.24007151106983L485.76523031203567,301.8079308123864L488.07489471779746,92.276266478406L490.38455912355937,244.46197624194338L492.6942235293212,310.48604681001416L495.003887935083,312.8078811147665L497.31355234084486,313.28568309617674L499.6232167466067,314.5272652056339L501.93288115236857,314.03204683685385L504.2425455581304,314.7672865055629L506.55220996389227,314.0681960634063L508.86187436965406,314.9782533216905L511.17153877541597,278.2343911738366L513.4812031811778,103.58778921321984L515.7908675869396,256.7088159354081L518.1005319927015,252.40193097464996L520.4101963984633,310.27312490170635L522.7198608042252,313.89856161738174L525.029525209987,117.09933023463333L527.3391896157488,250.46510226563396L529.6488540215107,252.63180133148424L531.9585184272726,281.29381511586587L534.2681828330344,97.4889116048936L536.5778472387963,254.0046295795242L538.887511644558,268.9243289417631L541.1971760503199,236.43463906860703L543.5068404560817,243.32870538611743L545.8165048618436,84.21007881810141L548.1261692676054,248.48442243559901L550.4358336733673,235.82050822847495L552.7454980791291,250.43728877275638L555.055162484891,81.18646414056792L557.3648268906528,257.0717637683346L559.6744912964147,253.72565890605804L561.9841557021764,249.73066156932813L564.2938201079384,254.28819573630133L566.6034845137001,78.48691944732096L568.9131489194621,224.2537264993702L571.2228133252238,239.2663311199341L573.5324777309856,232.68035053927576L575.8421421367475,69.11175796229507L578.1518065425093,250.54871478950017L580.4614709482713,267.08943890964383L582.771135354033,249.6621817083864L585.0807997597949,47.52002115006532L587.3904641655568,217.37818785303227L589.7001285713186,203.3479695705606L592.0097929770805,60.56641231392514L594.3194573828423,232.57566269516408L596.629121788604,228.98581452406694L598.938786194366,214.00566179434387L601.2484506001277,100.80896576366655L603.5581150058896,203.38959245872059L605.8677794116514,260.22470453529644L608.1774438174134,282.70516752262176L610.4871082231753,20L612.796772628937,219.03020807171086L615.106437034699,238.11778445410738L617.4161014404607,58.48072724002276L619.7257658462227,291.5684325466767L622.0354302519844,306.4843494155757L624.3450946577461,297.73916524730816L626.6547590635081,260.0212592150145L628.9644234692698,209.87775537831772L631.2740878750318,29.030959931952616L633.5837522807935,287.9655590713959L635.8934166865554,262.31117053219054L638.2030810923173,271.11027026144575L640,274.7612139915496\"></path></g><g stroke=\"currentColor\" transform=\"translate(0,0.5)\"><line x1=\"40\" x2=\"640\" y1=\"370\" y2=\"370\"></line></g></svg>"],[10356,13540,""],[10354,0,"'s performance "],[10342,27,""],[10342,0,"showing how long each in"],[10350,16,""],[10350,0,"the time taken d"],[10365,1,""],[10365,0,"for each chunk of 10"],[10384,1,""],[10384,0,"000 operations while running the test. "],[10359,9,""],[10359,0,"spent processing"],[10406,13,""],[10406,0,"during"],[10423,0," "],[10423,1,""],[10423,0,"There's a lot going on here. "],[10423,29,""],[10423,0,"I think those spikes h"],[10444,1,""],[10444,0,"are the garbage "],[10448,4,""],[10448,0,"V8's "],[10461,0,"collector trying to free up memory. The spikes get both slower and more frequent as the "],[10326,223,""],[10326,0,"This is a chart showing the time spent processing each chunk of 1000 operations during the test. I think those spikes are V8's garbage collector trying to free up memory. The spikes get both slower and more frequent as the"],[10550,0,"> am_perf1.svg"],[10511,5,""],[10543,0," document grows."],[10359,5,""],[10359,0,"taken to"],[10409,6,""],[10409,0,"throughout"],[10429,0," T"],[10430,1,""],[10430,0,"(The times show average"],[10435,5,""],[10435,0,"y"],[10435,1,""],[10435,0,"Y axis shows"],[10453,0,"*"],[10461,0,"* time "],[10429,39,""],[10377,1,""],[10376,1,""],[10375,1,""],[10375,19,""],[10375,0," each"],[10390,1,""],[10410,0,", "],[10411,1,""],[10410,1,""],[10410,0,", bucketed into groups of 1000 operations"],[10412,8,""],[10412,0,"averaged"],[10421,4,""],[10421,0,"in"],[10547,40,""],[10547,0,"as the test "],[10524,35,""],[13430,0,":"],[13383,0,":"],[13336,0,":"],[13433,0," "],[13385,0," "],[13337,0," "],[13436,0,"["],[13387,0,"["],[13338,0,"["],[13439,0,"."],[13389,0,"."],[13339,0,"."],[13442,0,"."],[13391,0,"."],[13340,0,"."],[13445,0,"]"],[13393,0,"]"],[13341,0,"]"],[13301,0,": 0"],[13450,1,""],[13397,1,""],[13344,1,""],[13149,1,""],[13103,1,""],[13056,1,""],[13444,1,""],[13392,1,""],[13340,1,""],[13146,1,""],[13101,1,""],[13055,1,""],[13438,1,""],[13387,1,""],[13336,1,""],[13143,1,""],[13099,1,""],[13054,1,""],[13432,1,""],[13382,1,""],[13332,1,""],[13140,1,""],[13097,1,""],[13053,1,""],[13426,1,""],[13377,1,""],[13328,1,""],[13137,1,""],[13095,1,""],[13052,1,""],[13420,1,""],[13372,1,""],[13324,1,""],[13134,1,""],[13093,1,""],[13051,1,""],[15078,0," a bit"],[15080,4,""],[15078,2,""],[13415,0,": [..]"],[13368,0,": [..]"],[13321,0,": [..]"],[13132,0,": [..]"],[13092,0,": [..]"],[13051,0,": [..]"],[13445,6,""],[13392,6,""],[13339,6,""],[13144,6,""],[13098,6,""],[13051,6,""],[15078,0," a bit"],[15079,6,""],[15133,0," in the document"],[15246,4,""],[15246,0,"I"],[15539,0," We're moving the Pareto fronteir "],[15572,1,""],[15571,1,""],[15570,1,""],[15569,1,""],[15569,0,"ier."],[15538,1,""],[15538,0,", which moves"],[15551,13,""],[15563,0,"efficieny "],[15568,1,""],[15568,0,"i"],[15571,0,"c"],[15556,0,"["],[15583,0,"](https://en.wikipedia.org/wiki/Pareto_efficiency)"],[10524,0," That big spike? A group of 1000 edits took 3"],[10568,1,""],[10568,0,"over 3.5"],[10524,52,""],[10540,0,"\n\n That big spike? A group of 1000 edits took over 3.5"],[10542,1,""],[10593,0," seconds to process.\n"],[10613,0," Oof."],[18703,23,""],[18703,0,"We can "],[18703,7,""],[18703,0,"If we s"],[18709,1,""],[18709,0,"zoom in on the diagram above"],[18703,2,""],[18703,0,"You can see this if"],[18754,0,". Th"],[18757,1,""],[18756,1,""],[18755,1,""],[18755,0," The amount of ti"],[18756,16,""],[18755,1,""],[18755,0,"\n\n> ref_perf3.svg"],[18755,0," There's a lot going on here because the insert cursor moves all over the place, and shuffi"],[18845,1,""],[18845,0,"ling elements in an array "],[18834,37,""],[18834,0," during this trace, but you "],[18858,4,""],[18858,0,"the"],[18741,0,"referencer"],[18750,1,""],[18750,0,"-crdts part of the "],[18889,0,"'re s a"],[18895,1,""],[18894,1,""],[18893,1,""],[18892,1,""],[18891,1,""],[18890,1,""],[18889,1,""],[18889,0,"e'"],[18890,1,""],[18889,1,""],[18889,0,"'e s"],[18892,1,""],[18891,1,""],[18890,1,""],[18889,1,""],[18889,0,"re's a strong trend *up and to the right*."],[18903,0,"linear "],[18734,30,""],[18734,0,"on"],[18792,23,""],[18792,0,"inserts are"],[18822,18,""],[18858,0,"during this "],[18857,13,""],[18857,0," "],[18880,0," I assume the section at thee"],[18908,1,""],[18908,0," end was martin "],[18917,7,""],[18917,0,"Martin coming back trhoguh the d"],[18936,13,""],[18935,1,""],[18916,0," when"],[18880,60,""],[18792,0,"the "],[18792,4,""],[18792,0,"martin"],[18792,6,""],[18792,0,"Martin's "],[18808,0," are"],[18792,43,""],[18792,0,"inserts happened all over the place"],[18840,0," obviously"],[18873,22,""],[18873,0,"upwards."],[18873,7,""],[18873,0,"up and to the right"],[18911,0,"\n"],[20517,20,""],[20517,0," the same information"],[21082,0,"the resulting "],[21096,4,""],[22019,0,"\n\n> yjs_perf3"],[22031,1,""],[22031,0,"4.svg"],[22019,0,"\n\nMy reference-crdts implmeention"],[22040,12,""],[22040,0,"implementation gets "],[22021,39,""],[22021,0,"Yjs is a"],[22028,1,""],[22028,0,"basically a line at the "],[22021,31,""],[22021,0,"You can't really tell anything about yjs if we put it on the same scale as "],[22021,75,""],[22021,0,"I can't really put yjs on the same scale as the other algoir"],[22080,1,""],[22079,1,""],[22079,0,"rithms because its so fast."],[22105,1,""],[22105,0,":"],[22124,0,"\n"],[22124,0,"\nBut if we isolate yjs, you can see it (m"],[22164,1,""],[22163,1,""],[22163,0,"(mostly) having linear "],[22179,7,""],[22179,0,"constnat per"],[22179,12,""],[22179,0,"constant performance for any"],[22204,3,""],[22179,8,""],[22179,0,"flat"],[22172,28,""],[22172,0,"performing just as well at the start of the test and at the end."],[22235,1,""],[22235,0,":\n\n> <svg class=\"plot\" fill=\"currentColor\" text-anchor=\"middle\" width=\"700\" height=\"400\" viewBox=\"0 0 700 400\" style=\"background: white none repeat scroll 0% 0%;\"><g transform=\"translate(40,0)\" fill=\"none\" text-anchor=\"end\"><g class=\"tick\" opacity=\"1\" transform=\"translate(0,370.5)\"><line stroke=\"currentColor\" x2=\"-6\"></line><line stroke=\"currentColor\" x2=\"600\" stroke-opacity=\"0.1\"></line><text fill=\"currentColor\" x=\"-9\" dy=\"0.32em\">0.000</text></g><g class=\"tick\" opacity=\"1\" transform=\"translate(0,330.51486076085445)\"><line stroke=\"currentColor\" x2=\"-6\"></line><line stroke=\"currentColor\" x2=\"600\" stroke-opacity=\"0.1\"></line><text fill=\"currentColor\" x=\"-9\" dy=\"0.32em\">0.002</text></g><g class=\"tick\" opacity=\"1\" transform=\"translate(0,290.5297215217089)\"><line stroke=\"currentColor\" x2=\"-6\"></line><line stroke=\"currentColor\" x2=\"600\" stroke-opacity=\"0.1\"></line><text fill=\"currentColor\" x=\"-9\" dy=\"0.32em\">0.004</text></g><g class=\"tick\" opacity=\"1\" transform=\"translate(0,250.5445822825633)\"><line stroke=\"currentColor\" x2=\"-6\"></line><line stroke=\"currentColor\" x2=\"600\" stroke-opacity=\"0.1\"></line><text fill=\"currentColor\" x=\"-9\" dy=\"0.32em\">0.006</text></g><g class=\"tick\" opacity=\"1\" transform=\"translate(0,210.5594430434178)\"><line stroke=\"currentColor\" x2=\"-6\"></line><line stroke=\"currentColor\" x2=\"600\" stroke-opacity=\"0.1\"></line><text fill=\"currentColor\" x=\"-9\" dy=\"0.32em\">0.008</text></g><g class=\"tick\" opacity=\"1\" transform=\"translate(0,170.57430380427223)\"><line stroke=\"currentColor\" x2=\"-6\"></line><line stroke=\"currentColor\" x2=\"600\" stroke-opacity=\"0.1\"></line><text fill=\"currentColor\" x=\"-9\" dy=\"0.32em\">0.010</text></g><g class=\"tick\" opacity=\"1\" transform=\"translate(0,130.58916456512665)\"><line stroke=\"currentColor\" x2=\"-6\"></line><line stroke=\"currentColor\" x2=\"600\" stroke-opacity=\"0.1\"></line><text fill=\"currentColor\" x=\"-9\" dy=\"0.32em\">0.012</text></g><g class=\"tick\" opacity=\"1\" transform=\"translate(0,90.60402532598107)\"><line stroke=\"currentColor\" x2=\"-6\"></line><line stroke=\"currentColor\" x2=\"600\" stroke-opacity=\"0.1\"></line><text fill=\"currentColor\" x=\"-9\" dy=\"0.32em\">0.014</text></g><g class=\"tick\" opacity=\"1\" transform=\"translate(0,50.61888608683553)\"><line stroke=\"currentColor\" x2=\"-6\"></line><line stroke=\"currentColor\" x2=\"600\" stroke-opacity=\"0.1\"></line><text fill=\"currentColor\" x=\"-9\" dy=\"0.32em\">0.016</text></g><text fill=\"currentColor\" transform=\"translate(-40,20)\" dy=\"-1em\" text-anchor=\"start\"> avg time per txn (ms)</text></g><g transform=\"translate(0,370)\" fill=\"none\" text-anchor=\"middle\"><g class=\"tick\" opacity=\"1\" transform=\"translate(40.5,0)\"><line stroke=\"currentColor\" y2=\"6\"></line><line stroke=\"currentColor\" y2=\"-350\" stroke-opacity=\"0.1\"></line><text fill=\"currentColor\" y=\"9\" dy=\"0.71em\">0</text></g><g class=\"tick\" opacity=\"1\" transform=\"translate(155.98322028809213,0)\"><line stroke=\"currentColor\" y2=\"6\"></line><line stroke=\"currentColor\" y2=\"-350\" stroke-opacity=\"0.1\"></line><text fill=\"currentColor\" y=\"9\" dy=\"0.71em\">50,000</text></g><g class=\"tick\" opacity=\"1\" transform=\"translate(271.46644057618425,0)\"><line stroke=\"currentColor\" y2=\"6\"></line><line stroke=\"currentColor\" y2=\"-350\" stroke-opacity=\"0.1\"></line><text fill=\"currentColor\" y=\"9\" dy=\"0.71em\">100,000</text></g><g class=\"tick\" opacity=\"1\" transform=\"translate(386.94966086427644,0)\"><line stroke=\"currentColor\" y2=\"6\"></line><line stroke=\"currentColor\" y2=\"-350\" stroke-opacity=\"0.1\"></line><text fill=\"currentColor\" y=\"9\" dy=\"0.71em\">150,000</text></g><g class=\"tick\" opacity=\"1\" transform=\"translate(502.43288115236857,0)\"><line stroke=\"currentColor\" y2=\"6\"></line><line stroke=\"currentColor\" y2=\"-350\" stroke-opacity=\"0.1\"></line><text fill=\"currentColor\" y=\"9\" dy=\"0.71em\">200,000</text></g><g class=\"tick\" opacity=\"1\" transform=\"translate(617.9161014404607,0)\"><line stroke=\"currentColor\" y2=\"6\"></line><line stroke=\"currentColor\" y2=\"-350\" stroke-opacity=\"0.1\"></line><text fill=\"currentColor\" y=\"9\" dy=\"0.71em\">250,000</text></g><text fill=\"currentColor\" transform=\"translate(700,30)\" dy=\"-0.32em\" text-anchor=\"end\">txns </text></g><g fill=\"none\" stroke=\"blue\" stroke-width=\"1.5\" stroke-miterlimit=\"1\" transform=\"translate(0.5,0.5)\"><path d=\"M42.30966440576184,331.3045814071602L44.61932881152369,331.3281726513708L46.92899321728553,317.2031623359376L49.238657623047374,320.30996767031394L51.54832202880921,324.5561494998344L53.85798643457106,318.80054861881143L56.1676508403329,322.17045619910107L58.47731524609475,317.9318914709247L60.78697965185658,322.536120335409L63.096644057618434,320.6676347178808L65.40630846338027,318.42368870722214L67.71597286914212,325.6765331047233L70.02563727490396,320.6674348185915L72.3353016806658,324.34220899853125L74.64496608642764,320.00146236735725L76.9546304921895,321.81180946626955L79.26429489795132,318.92290314557437L81.57395930371317,323.10450901416675L83.88362370947502,320.64124458570836L86.19328811523685,320.2583868017046L88.5029525209987,323.0325358113214L90.81261692676054,317.763134167238L93.12228133252239,326.08038306978705L95.43194573828421,324.9763932920026L97.74161014404606,325.2328780819742L100.05127454980791,303.1731166207364L102.36093895556976,313.42500655935237L104.6706033613316,322.56730864634795L106.98026776709344,319.5774598876221L109.28993217285529,322.68466509505504L111.59959657861712,318.30173405351576L113.90926098437896,320.89694951522637L116.21892539014081,309.4595202730632L118.52858979590265,320.2042069444228L120.8382542016645,318.2851401781658L123.14791860742633,316.12078462065284L125.45758301318818,298.8351689520023L127.76724741895003,291.3212414850521L130.07691182471186,297.56706021924L132.3865762304737,287.8023693119221L134.69624063623556,323.15089183095284L137.0059050419974,320.82577590953804L139.31556944775923,321.2006366792788L141.62523385352108,324.31483918109416L143.93489825928293,320.1688201525851L146.24456266504478,325.1025264664701L148.55422707080663,320.0064804055508L150.86389147656845,325.4477981195858L153.1735558823303,319.86935142956924L155.48322028809213,323.3210286184828L157.79288469385398,321.120466413925L160.10254909961583,319.88972380366755L162.41221350537768,323.44298327218917L164.7218779111395,318.79135205985676L167.03154231690135,321.3613568994709L169.3412067226632,290.84303926237556L171.65087112842502,324.6245240686047L173.96053553418687,315.76869546334996L176.27019993994872,270.62895196043087L178.57986434571058,204.0013745776499L180.8895287514724,262.0046372681377L183.19919315723425,317.71955038736985L185.5088575629961,276.9875287148924L187.81852196875795,288.72382690772554L190.1281863745198,297.9105325553182L192.43785078028165,320.5408818109297L194.74751518604347,324.52656053216555L197.0571795918053,321.20223602254885L199.36684399756714,289.9629463706867L201.676508403329,305.4076661731511L203.98617280909085,325.24769252594626L206.29583721485267,321.27600861690973L208.60550162061452,326.00778998550203L210.91516602637637,301.6272712117183L213.22483043213822,238.40504823043395L215.53449483790007,318.3081316500306L217.8441592436619,308.71399736343693L220.1538236494237,300.18526715281536L222.46348805518556,317.24952504362983L224.77315246094741,324.93220981426674L227.08281686670927,320.8783564235497L229.39248127247112,299.5511028194817L231.70214567823297,320.8437692288689L234.01181008399482,321.686636016929L236.32147448975667,314.55818535727093L238.63113889551846,310.9775361111746L240.9408033012803,316.84569518766L243.25046770704216,309.83596035145825L245.560132112804,320.4817038755921L247.86979651856586,323.59332734887266L250.17946092432769,319.6206438689118L252.48912533008954,307.6216033084685L254.7987897358514,287.8947550325755L257.10845414161327,305.25092442547464L259.41811854737506,319.6879988321421L261.7277829531369,316.2449384644532L264.0374473588987,310.47672225507415L266.3471117646606,319.4948905328851L268.65677617042246,326.31307656730263L270.96644057618425,323.49054559905113L273.27610498194616,326.7847012543128L275.58576938770796,324.0901427723198L277.8954337934698,302.22207013174227L280.20509819923166,243.24856808823785L282.5147626049935,319.4276955486686L284.82442701075536,322.8252128404381L287.1340914165172,321.6952527636756L289.443755822279,325.2934754959085L291.75342022804085,317.5032308312992L294.0630846338027,325.47760702115966L296.37274903956455,321.3213917882935L298.6824134453264,321.39014619550466L300.9920778510882,326.1225673311962L303.30174225685005,320.41552842243766L305.6114066626119,322.7730322739611L307.92107106837375,315.57716662170344L310.23073547413566,324.18250838387917L312.54039987989745,323.83101899892216L314.8500642856593,327.1049822937151L317.15972869142115,323.63111330457184L319.469393097183,322.67107015591233L321.7790575029448,327.1557433071173L324.0887219087067,323.0679226776373L326.3983863144685,318.1496105454543L328.70805072023035,279.397792945101L331.0177151259922,324.4581859633952L333.32737953175405,322.0938846423003L335.6370439375159,321.9853250284475L337.9467083432777,324.1815087384768L340.2563727490396,326.59757079285436L342.5660371548014,336.09354164371956L344.8757015605633,336.34304880153394L347.1853659663251,338.5556065274863L349.49503037208694,335.47819026148954L351.80469477784874,337.3090698624702L354.1143591836106,332.5620940625089L356.4240235893725,308.5890437735233L358.7336879951343,306.7671609811643L361.04335240089614,299.8325782231667L363.353016806658,305.57436423114183L365.66268121241984,294.0060236703604L367.9723456181817,289.4551551058633L370.2820100239436,308.44829612885104L372.59167442970534,325.80506536857416L374.90133883546713,330.6798136065485L377.21100324122904,327.5802056148002L379.5206676469909,332.6212720723246L381.83033205275274,207.6065946787434L384.1399964585146,284.108602092771L386.44966086427644,325.4592139032503L388.75932527003823,316.9858431344646L391.06898967580014,332.191431773667L393.378654081562,316.76372567974687L395.6883184873238,262.98145415682063L397.99798289308563,262.72876812364757L400.3076472988474,319.2657557491691L402.61731170460934,324.8604364362326L404.92697611037113,320.5371032377032L407.23664051613304,324.3348317912298L409.54630492189483,322.29161118117236L411.8559693276567,322.34859000089403L414.16563373341853,321.89257942949104L416.4752981391804,325.9654057503255L418.78496254494223,321.66526399742827L421.0946269507041,322.2050433193038L423.40429135646593,325.1463301802433L425.7139557622277,322.11967507660495L428.02362016798963,326.14152030117594L430.3332845737514,319.83094566690846L432.64294897951333,235.32461306809228L434.9526133852751,75.91829753787508L437.2622777910369,166.21079974512585L439.57194219679883,324.22787152064717L441.8816066025606,319.73820014243006L444.19127100832253,326.10955220426155L446.5009354140843,322.6142912354799L448.8105998198462,176.58686333872367L451.120264225608,83.42800656378876L453.42992863136993,311.36719129027165L455.7395930371317,312.4791580477033L458.04925744289346,298.11045820980615L460.35892184865537,312.8952034334508L462.6685862544172,310.59487830093826L464.97825066017907,325.9474125054728L467.2879150659409,299.280983170092L469.5975794717028,324.93938712227896L471.90724387746457,316.1473747265925L474.2169082832265,316.7793198352163L476.5265726889883,322.8709958104003L478.8362370947501,322.93777103590054L481.14590150051197,325.76707943910765L483.45556590627376,321.23782286263213L485.76523031203567,308.2479705268284L488.07489471779746,320.70002272246745L490.38455912355937,317.4416736922379L492.6942235293212,278.8441986756996L495.003887935083,157.1250764558391L497.31355234084486,84.79489853924105L499.6232167466067,71.64552552793683L501.93288115236857,65.63359998491238L504.2425455581304,76.58820854134962L506.55220996389227,76.58103123333747L508.86187436965406,86.7671455173775L511.17153877541597,220.09323392010714L513.4812031811778,323.38780376950496L515.7908675869396,319.9820894897051L518.1005319927015,320.7833916743615L520.4101963984633,48.230647902170475L522.7198608042252,20L525.029525209987,234.41697034533672L527.3391896157488,318.8339362688006L529.6488540215107,326.0302016451587L531.9585184272726,306.1575675028279L534.2681828330344,322.95836334390395L536.5778472387963,325.42042830214876L538.887511644558,306.96326806767235L541.1971760503199,320.13823146503574L543.5068404560817,274.2893515642087L545.8165048618436,269.0293464528473L548.1261692676054,280.27104844694315L550.4358336733673,277.58808553880993L552.7454980791291,322.2740376950358L555.055162484891,316.5819931694009L557.3648268906528,279.9989695015021L559.6744912964147,249.68333656105924L561.9841557021764,309.12944297683856L564.2938201079384,276.3615414094514L566.6034845137001,298.3803579252909L568.9131489194621,311.3117918536824L571.2228133252238,304.58599161439633L573.5324777309856,292.6017456122655L575.8421421367475,276.9658967667332L578.1518065425093,282.3808443087335L580.4614709482713,303.58716279015715L582.771135354033,305.0545974050616L585.0807997597949,320.97050217568227L587.3904641655568,310.4371569424752L589.7001285713186,324.76027370969933L592.0097929770805,316.59958661567515L594.3194573828423,321.7128262498121L596.629121788604,282.7173392360888L598.938786194366,308.06443877392303L601.2484506001277,188.83277207355542L603.5581150058896,308.9111241299632L605.8677794116514,286.98589280499056L608.1774438174134,281.5791622111582L610.4871082231753,323.5951267403882L612.796772628937,291.2160806059849L615.106437034699,233.74921853720272L617.4161014404607,214.3130421494712L619.7257658462227,55.90869424962041L622.0354302519844,62.69273295716713L624.3450946577461,52.62697390908525L626.6547590635081,183.19672675685553L628.9644234692698,313.11612134347683L631.2740878750318,318.630012032703L633.5837522807935,107.19075490582142L635.8934166865554,200.7048397186645L638.2030810923173,216.57058317375066L640,273.51763834722107\"></path></g><g text-anchor=\"start\" transform=\"translate(0.5,0.5)\"><text dx=\"3\" dy=\"0.32em\" x=\"640\" y=\"273.51763834722107\">yjs</text></g><g stroke=\"currentColor\" transform=\"translate(0,0.5)\"><line x1=\"40\" x2=\"640\" y1=\"370\" y2=\"370\"></line></g></svg>"],[22240,13966,""],[22240,0,"yjs_pef"],[22246,1,""],[22246,0,"rf5.svg"],[22181,1,""],[22180,1,""],[22179,1,""],[22179,0,"s"],[22219,3,""],[22219,0,"or"],[22172,61,""],[22172,0,"takes constant time"],[22163,28,""],[22163,0,"has mostly flat performance. Its almost always fast:"],[22233,0,"\n"],[22233,0,"\n(Though I have no idea what"],[22234,1,""],[22260,0," those spikes are "],[22277,1,""],[22277,0,". Kevin thinks it might be from "],[22278,31,""],[22278,0," "],[22234,7,""],[22272,0," "],[22272,1,""],[22272,0,"Remen"],[22276,1,""],[22276,0,"mber, the "],[22234,52,""],[22234,0,"I have no idea what those spikes are. Remember, the"],[22167,0,"*"],[22174,0,"*"],[22216,0,", and it des"],[22227,1,""],[22226,1,""],[22226,0,"oesn't get slower over time"],[22194,29,""],[22194,0,"I"],[22215,0," "],[22215,1,""],[22225,0," in this test"],[22225,13,""],[22194,0,"Unlike the other algorithms, "],[22223,1,""],[22223,0,"i"],[22310,15,""],[22310,0,". But remember, the scale here is "],[22310,34,""],[22310,0," hou"],[22313,1,""],[22312,1,""],[22311,1,""],[22311,0,"though. They're pretty small in absolute terms, but its stilla "],[22373,1,""],[22372,1,""],[22372,0," a bit weird."],[22373,12,""],[22373,0,"pretty curious!"],[22380,7,""],[22380,0,"weird"],[22373,7,""],[22367,6,""],[22367,0,"still "],[22381,5,""],[22381,0,"C"],[21837,182,""],[21836,1,""],[21838,0,"Kevin says he wrote and rewrote parts of yjs 12 times in order to make this code run so fast. If there was a programmer version of the speedrunning community, they would adore Kevin. "],[22028,7,""],[22028,0," even"],[22029,4,""],[22028,1,""],[22118,5,""],[22118,0,"I"],[22243,0,", as the document grows"],[22391,0," Maybe that"],[22401,1,""],[22400,1,""],[22400,0,"ey happen when the user moves their cursor a long way"],[22443,10,""],[22443,0,"around the document? Or when the user deletes chunks of "],[22495,4,""],[22495,0,"? I have on idea"],[22504,7,""],[22504,0,"no idea."],[22514,0,"The real question is: "],[22543,6,""],[22545,0," even"],[22546,0,"*"],[22558,0,"*"],[22559,7,""],[22619,3,""],[22619,0,"mu"],[22619,2,""],[22619,0,"any"],[22641,3,""],[22641,0,"managed here"],[23514,0,"; 5"],[23458,0,"item = "],[23458,0,"var "],[23471,4,""],[23471,0,"content"],[23528,1,""],[23528,0,":"],[23611,48,""],[23611,0,"mem-frag.drawio.svg"],[23572,0,"is "],[23583,16,""],[23583,0," a mess like this"],[24393,54,""],[24906,40,""],[24906,0,"des"],[24906,3,""],[24906,0,"would tell us everything we need to know"],[25752,0," much"],[25758,0," The v8"],[25764,1,""],[25763,1,""],[25763,0,"V8 optimizer does "],[25617,0,","],[25777,5,""],[25777,0,"helps a lot here - small string inlining "],[25782,6,""],[25777,35,""],[25777,0,"does a"],[25777,6,""],[25777,0,"has a lot of tricks"],[25782,0,"n awful l"],[25790,1,""],[25789,1,""],[25803,0," "],[25803,1,""],[25803,0,". But its not magic."],[25803,0," "],[25803,1,""],[25804,0," (Small stringi "],[25819,1,""],[25818,1,""],[25818,0," inling wou"],[25819,10,""],[25819,0,"inlining would help here)."],[25850,3,""],[25850,0,"V8 isn't"],[25858,4,""],[25853,5,""],[25853,0,"will "],[25857,1,""],[25853,4,""],[25853,0,"isn't"],[25496,0,"small, "],[25496,7,""],[25805,41,""],[25804,1,""],[25803,1,""],[25803,0,", "],[25805,1,""],[25805,0,"b"],[25824,0," It doesn't actually un"],[25825,22,""],[25824,1,""],[25823,1,""],[25823,0," and its tricks only get us so far."],[26350,19,""],[26350,0,"btree.drawio.svg"],[26566,19,""],[26566,0,"Martin's editing trace"],[26618,3,""],[26618,0," which"],[26624,5,""],[26743,0,"update "],[28889,0,"\n"],[28889,0,"\nTh"],[28891,1,""],[28891,0,"ecnhi"],[28895,1,""],[28894,1,""],[28893,1,""],[28893,0,"hnically this is O(log n)"],[28912,0,"n * "],[28922,0,". Teach "],[28924,6,""],[28924,0,"Each insert should "],[28936,0,"*"],[28943,0,"*"],[28936,9,""],[28936,0,"takes "],[28924,18,""],[28924,0,"Inserts slowly "],[28932,7,""],[28932,0,"get gradually slower as our document grows. But in reality, its fast"],[28980,20,""],[28980,0,"ec"],[28981,1,""],[28980,1,""],[28980,0,"because the whole thing fits in CPU cache, it "],[29025,1,""],[29024,1,""],[29023,1,""],[29023,0,"you c"],[29027,1,""],[29027,0,"honestly can't tell in th eb"],[29054,1,""],[29053,1,""],[29052,1,""],[29052,0,"e bne"],[29056,1,""],[29055,1,""],[29055,0,"enhcm"],[29059,1,""],[29058,1,""],[29057,1,""],[29057,0,"chmark data."],[29027,9,""],[29037,22,""],[29027,10,""],[29027,0,"wouldn't know"],[29041,0,"\n\n> rust_perf6.svg"],[28907,25,""],[28890,126,""],[28890,0,"Performance is also smooth as butter. Because "],[28928,8,""],[28928,0,"From rust"],[28928,9,""],[28928,0,"Rust doesn't need a grab"],[28951,1,""],[28950,1,""],[28949,1,""],[28949,0,"arbage collector to track allocations, so "],[28974,0," memory"],[28905,5,""],[28890,103,""],[28890,0,"Performance is smooth as butter. Rust doesn't need a garbage collector to track memory allocations, so"],[28888,0,"\n\nI have no idea how to track "],[28890,28,""],[28889,1,""],[28888,1,""],[28990,2,""],[28990,0,"so there's no big GC spikes. Usin"],[29019,4,""],[29019,0,"Because da"],[29028,1,""],[29027,1,""],[29027,0,"each b-tree node is"],[29019,27,""],[29019,0,"The entire "],[29019,11,""],[29019,0,"I'm not sure what those spikes are. They aren't "],[29055,12,""],[29054,1,""],[29053,1,""],[29049,0," in the time char"],[29057,9,""],[29057,0,"e"],[29057,1,""],[29057,0,"performance"],[29018,54,""],[29037,0,"\n I'm not sure what those spikes in the performance are"],[29039,1,""],[29038,1,""],[29038,0,"I"],[29069,2,""],[29069,0,"are in"],[29075,20,""],[29075,0," "],[29075,1,""],[29074,1,""],[29073,1,""],[29038,35,""],[29038,0,"I'm not sure what those spikes are"],[29037,0,"\n"],[29037,0,"\nNote I'm only g"],[29052,1,""],[29052,0,"showing the WASM version of this code, called from javascript. T"],[29115,1,""],[29115,0,"Performance is 3x better"],[29115,24,""],[29115,0,"I simply haven't written the code"],[29144,4,""],[29144,0,"ntaiv"],[29148,1,""],[29147,1,""],[29146,1,""],[29145,1,""],[29145,0,"ative code"],[29144,7,""],[29132,16,""],[29132,0,"implemented"],[29132,11,""],[29132,0,"instrumented my rust code"],[29148,0,"native "],[29164,0,"."],[29201,0,"\n"],[29166,1,""],[29200,0,"\nNote I'm only showing the WASM version of this code, called from javascript. I simply haven't instrumented my native rust code."],[29038,128,""],[29072,0,"\n"],[29037,1,""],[29071,1,""],[29037,0,"\n"],[29072,128,""],[29038,0,"Note I'm only showing the WASM version of this code, called from javascript. I simply haven't instrumented my native rust code.\n"],[29200,1,""],[29166,0,"\n"],[29089,0," here"],[29038,5,""],[29064,25,""],[29064,0,"performance here"],[29107,7,""],[29185,0,"."],[29175,0,"sml"],[29177,1,""],[29177,0,"all "],[29192,0," They're stable between runs.\n"],[29197,24,""],[29197,0," v"],[29198,1,""],[29198,0,"overlap perfecte"],[29213,1,""],[29213,0,"ly between subsequent runs."],[29107,0," simply"],[29107,7,""],[29107,0," simply"],[29158,23,""],[29158,0,"I wonder what those"],[29194,1,""],[29194,0,"?"],[29158,36,""],[29158,0,"What are those small spikes"],[29209,19,""],[29200,9,""],[29200,0,"perfectly"],[29200,9,""],[29192,8,""],[29192,0,"line up perfectly between "],[29217,1,""],[29218,0,"benchmark "],[29158,27,""],[29158,0,"I wonder what those spikes are"],[29018,0," Actually this entire data set only needs 414"],[29062,1,""],[29061,1,""],[29061,0,"100 allocations"],[29049,0,"(all 260000"],[29057,0," "],[29061,0,") operations "],[29090,0,"em"],[29091,1,""],[29090,1,""],[29090,0,"memory "],[29108,0," in total durin"],[29118,5,""],[29117,1,""],[29117,0,"."],[29063,11,""],[29028,0,"pro"],[29028,3,""],[29019,9,""],[29019,0,"Processing "],[29070,5,""],[29070,0,"calls malloc"],[29087,29,""],[29087,0," times."],[29069,0," ends "],[29070,5,""],[29069,1,""],[29447,6,""],[29447,0,"I"],[32256,0,"\n\nWe can put all the"],[32269,7,""],[32269,0,"a lot of this stuff on one graph, but i"],[32258,50,""],[32258,0,"If I "],[32262,1,""],[32260,2,""],[32258,2,""],[32258,0,"We can put a lot of this stuff on one graph, but i"],[32258,2,""],[32258,0,"I"],[32258,1,""],[32258,0,"We"],[32301,7,""],[32301,0," if it a"],[32308,1,""],[32308,0,"has a log scale, though its pretty min"],[32345,1,""],[32344,1,""],[32323,21,""],[32323,0,"."],[32305,2,""],[32305,0,"I give it"],[32314,4,""],[32327,0," Its re"],[32333,1,""],[32332,1,""],[32332,0,"pretty meaningless, but ou "],[32358,1,""],[32357,1,""],[32356,1,""],[32258,98,""],[32258,0,"We can put a lot of this stuff on one graph if I give it a log scale. Its pretty meaningless, but"],[32356,0,"\n> all_perf.svg"],[32355,0," you can see some features"],[32350,31,""],[32338,0,". And pretty"],[32362,0,"!"],[32338,1,""],[32338,0,", but"],[32343,4,""],[32340,23,""],[32340,0,"nobo"],[32340,4,""],[32340,0,"bugl"],[32343,1,""],[32342,1,""],[32342,0,"t log scales are seriously meaning"],[32359,17,""],[32359,0,"meaningless to humans."],[31680,11,""],[31680,0,". Thats "],[31772,0,"CRDT "],[31782,0," and"],[32338,0,"really "],[32338,7,""],[32344,0," "],[32338,7,""],[32338,0,"remarkable how neatly they stack up like this"],[32359,5,""],[32359,0," it"],[32313,7,""],[32313,0,"use"],[32364,0,"s"],[32368,10,""],[32354,1,""],[32353,1,""],[32353,0," it looks"],[32362,13,""],[32405,0," If"],[32407,1,""],[32406,1,""],[32405,1,""],[32422,0,"\n\n"],[32423,0,"If I use a normal linear scale, yjs and my "],[32463,3,""],[32463,0,"the rust implementation are just "],[32423,73,""],[32422,1,""],[32421,1,""],[32263,158,""],[32262,1,""],[31884,0,"\n"],[31884,0,"\n"],[31884,1,""],[31883,1,""],[32263,0,"\n"],[32263,0,"\n\nWe can put a lot of this stuff on one graph if I use a log scale. Its remarkable how neat it looks, but log scales are meaningless to humans.\n\n> all_perf.svg"],[32263,1,""],[32302,5,""],[32302,0,"chart"],[32274,23,""],[32274,0," everything on"],[31937,5,""],[36730,7,""],[36730,0,"/Sh"],[36732,1,""],[36731,1,""],[36730,1,""],[36730,0,"ShareDB"],[36753,0,"it "],[36765,12,""],[36760,5,""],[36768,0," by leaps"],[36759,18,""],[36759,0," been maintained by a di"],[36782,1,""],[36782,0,"edicated team"],[36795,12,""],[36795,0,"."],[36764,0," ac"],[36756,11,""],[36755,1,""],[36755,0,"s still well used and well"],[36792,21,""],[36792,0," by the people"],[36753,3,""],[36752,1,""],[36752,0," well used, "],[36763,1,""],[36762,1,""],[36762,0," and battle tested"],[36780,50,""],[36780,0,"."],[36753,0,"its "],[36766,0,", well maintained "],[36783,1,""],[38593,0,"out"],[38609,1,""],[38609,0,"ve been"],[39385,0," Yjs's semantics also take slightly morememory"],[39421,10,""],[39421,0,"more memory in practice."],[39385,60,""],[41168,0,"binary "],[41292,0,"mirror the benchmarks I showed above"],[41328,61,""],[41328,0,","],[41328,1,""],[41333,0," I'd like to know"],[41329,21,""],[41352,0,", and it would be fun to find out"],[41401,0,"semantic "],[41420,19,""],[41420,0," worth mentioning."],[41438,2,""],[41439,1,""],[41439,0,"Y"],[41517,1,""],[41598,1,""],[41598,0,", wheras"],[41604,0,"e"],[41654,1,""],[41727,4,""],[41736,0," stores"],[41743,18,""],[43888,0," Although"],[43889,8,""],[43888,1,""],[43888,0,"\n\n"],[43889,1,""],[43888,1,""],[43888,0," I have "],[43889,7,""],[43888,1,""],[43888,0," "],[43888,1,""],[43888,0,"\n\n"],[43889,1,""],[43888,1,""],[43888,0," We'll "],[43888,7,""],[127,0,"\n\n> automerge1.drawio.svg"],[130,1,""],[129,1,""],[129,0,"<img src="],[159,0,">"],[129,31,""],[128,1,""],[127,1,""],[6135,0,"<img src=automerge1.drawio.svg>"],[6166,23,""],[6438,0,"\n<img src=automerge1.drawio.svg>"],[6457,1,""],[6457,0,"2"],[6471,24,""],[10541,0,"\n<img src=automerge1.drawio.svg>"],[10551,17,""],[10551,0,"am_perf1"],[10565,15,""],[18918,0,"\n<img src=automerge1.drawio.svg>"],[18928,17,""],[18928,0,"ref_perf3"],[18943,16,""],[22132,0,"\n<img src=automerge1.drawio.svg>"],[22142,17,""],[22142,0,"yjs_perf4"],[22157,15,""],[22156,1,""],[22309,15,""],[22309,0,"<img src=yjs_perf4.svg>"],[22326,1,""],[22326,0,"5"],[23660,0,"\n<img src=yjs_perf4.svg>"],[23670,17,""],[23689,0,">"],[26403,0,"\n<img src=yjs_perf4.svg>"],[26413,17,""],[26429,0,">"],[29159,0,"\n<img src=yjs_perf4.svg>"],[29169,17,""],[29183,0,">"],[32464,0,"\n<img src=yjs_perf4.svg>"],[32474,17,""],[32486,0,">"],[5329,0,"\n\n"],[5330,1,""],[5329,1,""],[5329,0,"\n\n"],[5331,1,""],[5331,0,"\n"],[5330,1,""],[5329,1,""],[7282,0,"*"],[7222,0,"*"],[7164,0,"*"],[7111,0,"*"],[6401,0,"*"],[6351,0,"*"],[6303,0,"*"],[6260,0,"*"],[6068,0,"*"],[6018,0,"*"],[5975,0,"*"],[7293,0,"*"],[7232,0,"*"],[7173,0,"*"],[7119,0,"*"],[6408,0,"*"],[6357,0,"*"],[6308,0,"*"],[6264,0,"*"],[6071,0,"*"],[6020,0,"*"],[5976,0,"*"],[7303,1,""],[7241,1,""],[7181,1,""],[7126,1,""],[6414,1,""],[6362,1,""],[6312,1,""],[6267,1,""],[6073,1,""],[6021,1,""],[5976,1,""],[7296,0,"*"],[7235,0,"*"],[7176,0,"*"],[7122,0,"*"],[6411,0,"*"],[6360,0,"*"],[6311,0,"*"],[6267,0,"*"],[6074,0,"*"],[6023,0,"*"],[5979,0,"*"],[10665,0,"\n<img src=am_perf1.svg>"],[10683,0,"_smooth"],[10665,0,"\nThe chart is a bit easier to read when we smooth everything "],[10708,18,""],[10708,0,"average everythign out "],[10716,15,""],[10716,0,"everything out a bit - but "],[10736,7,""],[10736,0,". Clearly performance is slowly "],[10761,7,""],[10761,0,"gradually getting wo"],[10761,20,""],[10761,0,"getting gradu"],[10773,1,""],[10773,0,"ually worse over time.\n"],[10738,9,""],[10738,0,"P"],[10749,11,""],[10749,0," gets"],[10132,0,"\n\n\n| Test                              | Time taken | RAM usage |\n|:--------------------------        | ----------:| ---------:|\n| automerge (v1.0.0-preview2)       |  291s      | 880 MB    |\n| **reference-crdts (automerge / yjs)** |   31s      |  28 MB    |\n| JS baseline                       | 0.61s      | 0.1 MB    |"],[10263,0,"**"],[10292,0,"**"],[10328,66,""],[10327,1,""],[10391,229,""],[10390,1,""],[10590,0,"\n\n"],[10591,1,""],[10590,1,""],[10133,1,""],[9809,0,"\n\nThe "],[9811,4,""],[9811,0,"Processing "],[9811,11,""],[9810,1,""],[9809,1,""],[9711,0," Thats about "],[9718,6,""],[9718,0,"just shy of 900 edits per seoc"],[9747,1,""],[9746,1,""],[9746,0,"cond, which is honestly fine"],[9761,13,""],[9761,0,"probably fine. But"],[9779,4,""],[9812,4,""],[9812,0,"is using"],[10774,1,""],[10773,1,""],[10773,4,""],[10825,0," and zoom in"],[10913,0,"\n\n(Note the y "],[10915,12,""],[10914,1,""],[10913,1,""],[10835,2,""],[10835,0,"the Y axis"],[10873,0," (roughly linearly)"],[12823,0,"["],[12827,0,"](https://github.com/yjs/yjs)"],[12904,10,""],[12885,0,"opensource "],[12937,5,""],[12937,0,"I"],[12940,7,""],[15466,0,"\n3. Its much faster, because"],[15470,24,""],[15470,0,"Th"],[15470,2,""],[15470,0,"We can use a much simpler data structure, which makes the algorithm much faster."],[15483,67,""],[15483,0,"flat array to store all the"],[15503,7,""],[15503,0,"everything, rather than a "],[15528,1,""],[15528,0," weird tree."],[15529,5,""],[15529,0,"sp"],[15530,1,""],[15529,1,""],[15528,1,""],[15534,0," This makes "],[15528,0,"n unbalanced"],[15558,0,"everything smaller and faster for the compilt"],[15602,1,""],[15601,1,""],[15600,1,""],[15600,0,"uter to process."],[15844,236,""],[15617,0,"4. Even though the implementation is different, this approach is *semantically* identical to the actual automerge, and yjs and sync9 code. ([Fuzzer verified (TM)](https://github.com/josephg/reference-crdts/blob/main/reference_test.ts))\n"],[16080,171,""],[15853,0,"5. Its faster *and* simpler, which moves the [Pareto efficiency frontier](https://en.wikipedia.org/wiki/Pareto_efficiency). Ideas which do this are rare and truly golden.\n"],[16251,1,""],[16024,0,"\n"],[16252,0,"\n"],[16024,1,""],[16023,0,"\n\n"],[15616,0,"\n2. Doing it this way lets you implement the semantics of multiple CRDTs in the same codebase, if you want to."],[15357,110,""],[15506,0,"\n1. You can implement lots of CRDTs like this. Yjs, Automerge, Sync9 and others all work"],[15269,89,""],[15269,0,"1"],[15418,0,"\n2. The code s"],[15431,1,""],[15431,0,"is i"],[15434,1,""],[15434,0,"simple"],[15434,0,"really "],[15434,7,""],[15434,0,"m"],[15434,1,""],[15434,0,"really "],[15447,0,"."],[15886,10,""],[15886,0,"Being faster"],[15886,169,""],[15883,3,""],[15882,1,""],[15448,0," Being faster *and* simpler, which moves the [Pareto efficiency frontier](https://en.wikipedia.org/wiki/Pareto_efficiency). Ideas which do this are rare and truly golden."],[15476,6,""],[15475,1,""],[15612,1,""],[15612,0,"3"],[15700,110,""],[15699,0,". You can implement ment"],[15722,1,""],[15721,1,""],[15720,1,""],[15720,0,"m"],[15720,1,""],[15720,0,"any lo"],[15725,1,""],[15725,0,"ist CRDT "],[15733,1,""],[15733,0,"s in the same codebase."],[15757,236,""],[15221,0," And even though the code is very different, the Even though the implementation is different, this approach is *semantically* identical to the actual automerge, and yjs and sync9 code. ([Fuzzer verified (TM)](https://github.com/josephg/reference-crdts/blob/main/reference_test.ts))\n"],[15269,44,""],[15266,4,""],[15265,1,""],[15355,0,"bases"],[15459,1,""],[15994,1,""],[15995,3,""],[15995,0,"It does"],[16002,13,""],[15995,7,""],[15995,0,"Ther"],[15998,1,""],[15997,1,""],[15997,0,"ore"],[15999,1,""],[15998,1,""],[15997,1,""],[15997,0,"eoretically this algorithm"],[16122,5,""],[16122,0,"really"],[16024,5,""],[16028,0,"s"],[16203,13,""],[16203,0,"I"],[16218,0," in practice"],[16024,0,"can "],[16032,1,""],[14763,0," in a "],[14767,2,""],[14767,0,"my *reference-crdts*"],[14770,22,""],[14769,1,""],[14771,16,""],[14771,0,"reference-crdts"],[14850,0," codebase."],[14860,40,""],[14769,0," proot "],[14775,1,""],[14774,1,""],[14774,0,"f of concept"],[14770,16,""],[14770,0,"experimental"],[14864,8,""],[14864,0,"library"],[14864,7,""],[14864,0,"codebase"],[14784,0,"*"],[14800,0,"*"],[16363,14,""],[16363,0,"I"],[16363,1,""],[16363,0,"YU"],[16364,1,""],[16363,1,""],[16363,0,"U"],[16383,0," my implementation of automerge's algorithm is"],[16429,8,""],[16451,0," the real"],[16470,1,""],[16470,0,". And its"],[16479,4,""],[16989,9,""],[16989,0,"automerge up"],[17002,0,"\n\nIts a lot faster than "],[17004,22,""],[17003,1,""],[17003,0,"\nIts a lot faster than automerge:\n\nref_vs_am_perf.svg"],[17038,0,"<img src="],[17065,0,">"],[17037,0,"\n![]"],[17041,10,""],[17041,0,"("],[17060,1,""],[17060,0,")"],[17040,0,"Automerge is much slower than reference-crdts"],[33045,9,""],[33045,0,"!"],[29740,9,""],[29740,0,"!"],[26984,9,""],[26984,0,"!"],[24241,9,""],[24241,0,"!"],[22889,9,""],[22889,0,"!"],[22713,9,""],[22713,0,"!"],[19499,9,""],[19499,0,"!"],[10911,9,""],[10911,0,"!"],[10659,9,""],[10659,0,"!"],[6453,9,""],[6453,0,"!"],[6141,9,""],[6141,0,"!"],[32966,0,"["],[29669,0,"["],[26921,0,"["],[24186,0,"["],[22842,0,"["],[22674,0,"["],[19468,0,"["],[10888,0,"["],[10644,0,"["],[6446,0,"["],[6142,0,"["],[32977,0,"]"],[29679,0,"]"],[26930,0,"]"],[24194,0,"]"],[22849,0,"]"],[22680,0,"]"],[19473,0,"]"],[10892,0,"]"],[10647,0,"]"],[6448,0,"]"],[6143,0,"]"],[32988,0,"("],[29689,0,"("],[26939,0,"("],[24202,0,"("],[22856,0,"("],[22686,0,"("],[19478,0,"("],[10896,0,"("],[10650,0,"("],[6450,0,"("],[6144,0,"("],[33011,1,""],[29713,1,""],[26964,1,""],[24229,1,""],[22876,1,""],[22705,1,""],[19496,1,""],[10919,1,""],[10665,1,""],[6473,1,""],[6166,1,""],[33001,0,")"],[29704,0,")"],[26956,0,")"],[24222,0,")"],[22870,0,")"],[22700,0,")"],[19492,0,")"],[10916,0,")"],[10663,0,")"],[6472,0,")"],[6166,0,")"],[10651,0,"automm"],[10656,1,""],[10655,1,""],[10655,0,"moe"],[10657,1,""],[10656,1,""],[10656,0,"erge performance chart"],[10925,0,"automerge performance chart smoothed u"],[10962,1,""],[10962,0,"out"],[6143,0,"treee"],[6147,1,""],[6147,0," with \"abc\" inserts"],[6473,0,"tree with \"aXbc\""],[19587,0,"reference crdts implmentation zoomed in"],[19531,9,""],[19530,1,""],[19539,7,""],[19566,0," Perofr"],[19572,1,""],[19571,1,""],[19570,1,""],[19570,0,"formance gets better near tha "],[19599,1,""],[19598,1,""],[19598,0,"e end when Martin star"],[19616,4,""],[19616,0,"went back to the start of his paper and started editing it."],[19664,8,""],[19664,0,"making edits"],[19676,3,""],[19676,0,"."],[19663,7,""],[19668,1,""],[19668,0,"ing"],[19780,25,""],[19780,0,"Kevin "],[19785,1,""],[19806,0," in Yjs"],[19780,0,"And by \"we\", I mean "],[19856,0,"eK"],[19857,1,""],[19856,1,""],[19856,0,"Kevin solved this problem by thinking about how p"],[19904,1,""],[19904,0,"humans actually edit documents. "],[19949,7,""],[19949,0,"we"],[19951,3,""],[19958,0,"'"],[19951,0,"'"],[19952,7,""],[19952,0,"re typing"],[19961,1,""],[19963,4,""],[19963,0,"we"],[19944,4,""],[19944,0,"while"],[19994,3,""],[19994,0,"a "],[19995,1,""],[19924,0," text"],[20161,5,""],[20160,1,""],[20160,0," later"],[20168,0,"the new "],[20134,0,"The next edit will probably be pretty close to the previous edit"],[20198,98,""],[20198,0,", so Kevin just scans from "],[20220,5,""],[20220,0,"forwards or backwards from the last position"],[20266,80,""],[20265,1,""],[20265,0,"\n\n"],[20266,1,""],[20265,1,""],[20265,0," "],[20296,0," to me"],[20297,5,""],[20296,1,""],[20296,0," to me, b"],[20304,1,""],[20303,1,""],[20302,1,""],[20302,0," - wouldn't Yjs ha"],[20305,15,""],[20304,1,""],[20303,1,""],[20302,1,""],[20303,7,""],[20303,0,"- I mean, thats a big assumption!"],[20336,67,""],[20340,0," apparen"],[20341,7,""],[20340,1,""],[20335,0," to make"],[20376,0,"\n\n(And I'm simplif"],[20378,16,""],[20378,0,"(And I'm simplifying a bit here - Yjs actualy"],[20422,1,""],[20422,0,"ly stores i"],[20432,1,""],[20432,0,"a whole set of cach"],[20378,73,""],[20378,0,"And w"],[20378,5,""],[20378,0,"What i"],[20378,6,""],[20377,1,""],[20376,1,""],[20376,0,"\n\n(And what if two users are editing different parts of a document? Yjs cac"],[20448,3,""],[20448,0,"stores a whole set of cache locations, so there's usually a cached marker location nearby.)"],[20498,0,"almost always "],[20512,7,""],[20511,1,""],[20526,1,""],[20526,0,"cur"],[20521,8,""],[20521,0,"cursor"],[20379,5,""],[20379,0,"W"],[20444,0,"actually "],[20439,0," "],[20439,1,""],[20439,0," I"],[20440,1,""],[20439,1,""],[20439,0," I'm simplifying here -"],[20513,5,""],[20513,0," "],[20513,1,""],[20513,0,". "],[20515,1,""],[20515,0,"T"],[20568,0," no matter where users make changes in the document"],[20706,2,""],[20706,0,"Yjs does that"],[20719,12,""],[21868,6,""],[21868,0,"The algorithm can"],[21953,0," - but that happens any time"],[21960,21,""],[21960,0,"c"],[21960,1,""],[21960,0,"that happens whenever a user types a series of characters without moving their cursor"],[21997,6,""],[21997,0,"run"],[22048,5,""],[22140,5,""],[22140,0,"runs"],[22328,0,"This blows me away but - "],[22352,1,""],[22351,1,""],[22347,4,""],[22347,0,"- "],[22372,4,""],[22372,0,"my "],[22411,0,"thanks to the spans approach "],[23494,0,". Ch"],[23497,1,""],[23496,1,""],[23495,1,""],[23494,1,""],[23517,0,"But "],[23558,6,""],[23558,0,"near the end"],[23604,0,"*"],[23596,0,"*"],[24053,3,""],[24053,0,"Yjs"],[24713,1,""],[24713,0,"\n  "],[24797,1,""],[24797,0,"\n  "],[24798,2,""],[24733,1,""],[24733,0,"\n  "],[24753,1,""],[24753,0,"\n  "],[24773,1,""],[24773,0,"\n  "],[24783,1,""],[24783,0,"\n  "],[24651,9,""],[24651,0,"one of our document items"],[24676,10,""],[27020,0," in the decade since it was released"],[24874,0,"javascript objects fragmented in memory"],[23328,0,"yjs performance a"],[23344,1,""],[23344,0,"vs other oa"],[23354,1,""],[23353,1,""],[23353,0,"alogi"],[23357,1,""],[23356,1,""],[23355,1,""],[23355,0,"gorithms"],[23534,0,"yjs performance isolated"],[27746,0,"b-tree diagram"],[27659,0," This isn't a btreemap"],[27673,8,""],[27672,1,""],[27672,0," "],[27672,1,""],[27671,1,""],[27671,0,"you"],[27673,1,""],[27672,1,""],[27671,1,""],[27671,0,"a "],[27672,1,""],[27672,0,"n ordinera"],[27681,1,""],[27680,1,""],[27679,1,""],[27678,1,""],[27677,1,""],[27677,0,"inary b-tree. Instead of storing offsets,"],[27719,1,""],[27719,0,"e"],[27801,0," This i"],[27807,1,""],[27807,0,"lets u"],[27812,1,""],[27812,0,"the "],[27812,4,""],[27812,0,"us resize children"],[27822,0,"a node's "],[27839,0," with *log n*"],[27849,1,""],[27849,0,"("],[27851,0,")"],[27822,1,""],[27822,0,"the"],[27822,3,""],[27822,0,"any ti"],[27827,1,""],[27826,1,""],[27826,0,"item"],[27830,7,""],[27853,0," mo"],[27855,1,""],[27854,1,""],[27853,1,""],[27845,0,"just "],[27858,0," edits. (We just walk up the "],[27865,22,""],[28222,0," In practice, most of these reads will already be in your CPU's cache."],[28780,0," That codepath doesn't get benchmarked here though - you'll have to tam"],[28850,1,""],[28850,0,"ke my word for it."],[28832,1,""],[28831,1,""],[28830,1,""],[28830,0,". Its fast but for now "],[28904,3,""],[28904,0,"Yjs"],[28935,0," edit"],[28984,1,""],[28983,1,""],[28983,0,"."],[29418,0,"Why 32? "],[29426,14,""],[29426,0,"I ran my"],[29446,1,""],[29445,1,""],[29444,1,""],[29444,18,""],[29444,0," "],[29471,1,""],[29471,0," and"],[29615,0," like in the other tests"],[29670,0,"editing "],[29686,0," just"],[29709,0," This is faster than editing a string in javascript."],[29761,1,""],[29761,0,"\n\n"],[29846,0,"all 260k edits in "],[29885,0," just"],[30564,140,""],[30528,36,""],[30528,0,"Even through webassembly, this code"],[30527,36,""],[29715,46,""],[29715,0,"is 3x faster than editing a native javascript string directly, and its doing a whole lot of extra work to support collaborative editing too!"],[29776,1,""],[29776,0,"!"],[29778,1,""],[29778,0,"A"],[30621,1,""],[30735,0," mysterious"],[30746,4,""],[30758,0,"And because memory is packed in, "],[30780,0,"so "],[30789,3,""],[30791,1,""],[30791,0,"p"],[31039,1,""],[31010,0," have no idea"],[31023,7,""],[31045,0,"."],[31093,0," Maybe the allocator?"],[30782,0," tightly"],[30757,0," We don't care where inserts happen - this system si fas"],[30807,6,""],[30807,0,"is uniformly fast no matter"],[30825,9,""],[30825,0,"across the whole document."],[30758,94,""],[30655,0,"We don't care where inserts happen - this system is uniformly fast across the whole document. "],[30655,0,"The b-tree gives us *log "],[30679,1,""],[30679,0,"(n) p"],[30683,1,""],[30682,1,""],[30682,0," "],[30682,1,""],[30682,0,"* performance for every edit, no matter"],[30655,68,""],[30655,0,"A b-tree doesn't"],[30671,6,""],[30683,7,""],[30683,0,"edits"],[30697,1,""],[30696,1,""],[30695,1,""],[30695,0,". "],[30697,1,""],[30697,0,"T"],[30977,0,"rust per"],[30982,3,""],[30982,0,"implementation in was "],[31003,1,""],[31003,0,"m vs yjs"],[31148,0," But I expect the r"],[31149,18,""],[31149,0,"I expect the rust implementation to look the same "],[31162,37,""],[31162,0,"only change will be the "],[31148,38,""],[31148,0," I don't "],[31149,8,""],[31149,0,"The rust version of this code"],[31149,0,"I don't know why "],[31166,1,""],[31166,0,"t"],[31195,0," is 3x faster. Is it the javascript / WASM i"],[31238,1,""],[31238,0,"bounary"],[31238,7,""],[31238,0,"boundary? Or are the re"],[31260,1,""],[31259,1,""],[31258,1,""],[31258,0,"re optimizations"],[31251,9,""],[31251,0,"does"],[31248,7,""],[31248,0,"Does LLVM make"],[31258,4,""],[31258,0,"have more tricks when"],[31280,13,""],[31280,0,"optimizing native x65"],[31300,1,""],[31299,1,""],[31298,1,""],[31298,0,"x75"],[31300,1,""],[31299,1,""],[31299,0,"65"],[31300,1,""],[31299,1,""],[31299,0,"86 code? Or"],[31147,0,", though I assume its just the same but 3x "],[31147,43,""],[31213,0,"the performance costc "],[31234,1,""],[31233,1,""],[31233,0," coming from "],[31246,3,""],[31261,1,""],[31261,0,"-"],[31261,1,""],[31260,1,""],[31260,0,"-to-"],[31264,1,""],[31341,0," is the s"],[31349,1,""],[31349,0,"wasm virtual machine"],[31345,24,""],[31345,0,"it all the bounds checks wasm needs"],[31370,10,""],[31370,0,"the WASM VM needs? A"],[31389,1,""],[31389,0,"In an"],[31389,5,""],[31389,0,"No matter - its lightning"],[31413,1,""],[31412,1,""],[31412,0,"ng fast."],[31405,0,"truly "],[31405,6,""],[31419,0," anyway"],[31429,0,"And "],[31429,4,""],[31431,34,""],[31431,0,"wonder what those spikes are"],[32290,0,"\n\n"],[32291,1,""],[32290,1,""],[32290,0,"\n\nI figure this is better for mo"],[32321,1,""],[32320,1,""],[32320,0,"lots of use cases, "],[32338,1,""],[32337,1,""],[32337,0," anyway - for e"],[32337,15,""],[32337,0,". For example, if the "],[32355,4,""],[32355,0,"you're editing text in VS Code, the VS Vode "],[32394,5,""],[32394,0,"Code editing i"],[32407,1,""],[32407,0,"environment will need "],[32424,5,""],[32424,0,"have a copy of the document anyway, so there's no i"],[32474,1,""],[32474,0,"need to duplicate everything in the b-tree."],[32506,3,""],[32506,0,"my"],[31812,9,""],[31812,0,"BTree"],[31812,0,"Spanning"],[31819,1,""],[31818,1,""],[31817,1,""],[31816,1,""],[31812,4,""],[32286,226,""],[32478,0,"\n- Lots of use cases will store the co"],[32515,1,""],[32514,1,""],[32514,0,"document content somewhere "],[32541,177,""],[32479,0,"- But when inserting we need to update 2 data structures instead of 1. This makes everything more than twice as slow, and it makes the wasm bundle twice as big (60kb -> 120kb).\n"],[32718,0,"\n- But when inserting we need to update 2 data structures instead of 1. This makes everything more than twice as slow, and it makes the wasm bundle twice as big (60kb -> 120kb)."],[32479,177,""],[32541,0,"else anyway. Eg, if you're using VS c"],[32577,1,""],[32577,0,"Code"],[32564,3,""],[32564,0," hook this up to"],[32580,6,""],[32588,0,", the text content doesn't need to be stored in the CRDT at all."],[32607,0,"probably "],[32642,2,""],[32642,0,"by"],[32664,5,""],[32664,0,"W"],[32834,0,"\n- Lots of use cases will store the document content somewhere else anyway. Eg, if you hook this up to VS Code, the text content probably doesn't need to be stored by the CRDT at all."],[32479,183,""],[32834,0," In that case, its"],[32835,17,""],[32835,0,"Implemented like this, it'd be really east to "],[32880,1,""],[32879,1,""],[32878,1,""],[32877,1,""],[32876,1,""],[32876,0,"y to just turn that code off."],[32891,13,""],[32891,0,"the "],[32886,9,""],[32886,0,"stop storing the content at all"],[32762,0," vs code has"],[32771,3,""],[32771,0,"will have a cop o"],[32787,1,""],[32786,1,""],[32786,0,"y of the document at all times anyway. So"],[32827,34,""],[32827,0," there's no need to "],[32847,12,""],[32852,1,""],[32851,1,""],[32851,0,"e the document in the "],[32873,8,""],[32869,4,""],[32869,0,"my "],[32876,0," structures as well"],[32895,7,""],[32896,84,""],[32896,0," Implemented like this, it'd be really easy to just stop storing the content at all."],[33035,0,"But whatever. "],[33049,1,""],[33049,0,"M"],[33035,14,""],[33147,0," contents"],[34827,2,""],[34827,0,"in a pre"],[34832,3,""],[34832,0,"single, pretty"],[34846,4,""],[34954,0,"all data in one chart"],[34990,0,"\n\nI"],[34992,1,""],[34991,1,""],[34990,1,""],[34990,0,"\n\nRemember "],[35000,1,""],[35000,0,", log scales trick your brain. The data actually looks like this:\n\ntype: 'log', domain: [0.0005, 4], tickFormat: ',',"],[35067,50,""],[35067,0,"![all data in one chart](all_perf.svg)"],[35100,0,"_linear"],[35090,0,", with a linear sscale"],[35106,1,""],[35064,1,""],[35064,0,". Automerge makes everything look fast."],[35066,37,""],[35065,1,""],[35064,1,""],[35064,0,":"],[35064,1,""],[35064,0,". In comparison"],[35065,14,""],[35064,1,""],[35064,0,":"],[34804,0,"\n"],[34804,0,"\n#["],[34806,1,""],[34805,1,""],[34805,0,"@"],[34805,1,""],[34805,0,"#["],[34806,1,""],[34805,1,""],[34805,0,"![](totals.svg)"],[41222,0,"\n"],[41222,0,"\n"],[41222,1,""],[41221,1,""],[41221,0,"\n\nYou can play with the charts"],[41250,1,""],[41250,0,"ing "],[41223,31,""],[41223,0,"The charts were made using Obj"],[41252,1,""],[41252,0,"servableHQ's "],[41264,1,""],[41263,1,""],[41262,1,""],[41244,5,""],[41244,0,"on"],[41247,0,"["],[41260,0,"](https://observablehq.com/@josephg/crdt-algorithm-performance-benchmarks)."],[42054,0,"n"],[42062,1,""],[42062,0," "],[42366,28,""],[42366,0,"You would just need to:"],[42805,0," And "],[42809,1,""],[42808,1,""],[42807,1,""],[42806,1,""],[42805,1,""],[42805,0," "],[42805,1,""],[42805,0," And "],[42806,4,""],[42805,1,""],[42805,0," And RGA has slightly worse ordering semantics in some"],[42818,41,""],[42818,0,"an interleaving problem when prefixing"],[42841,15,""],[42841,0," th"],[42843,1,""],[42842,1,""],[42842,0,"in "],[42844,1,""],[42843,1,""],[42842,1,""],[42842,0,"when pre"],[42821,0,"["],[42842,0,"](https://www.cl.cam.ac.uk/~arb33/papers/KleppmannEtAl-InterleavingAnomalies-PaPoC2019.pdf)"],[42942,0,"fixing"],[42819,1,""],[42818,1,""],[42817,1,""],[42832,7,""],[42832,0,"anomolies"],[42832,9,""],[42832,0,"no"],[42833,1,""],[42832,1,""],[42832,0,"anomalies"],[42947,0,"p"],[42947,1,""],[42938,9,""],[42938,0,"prepending text "],[42953,1,""],[42953,0," "],[42953,1,""],[42953,0,"."],[42817,0," weird"],[42838,9,""],[42838,0,"problems"],[42813,0," can have"],[42822,4,""],[42842,9,""],[42950,4,""],[42950,0,"items"],[42977,56,""],[42977,0," make my code"],[43015,6,""],[43015,0,"for "],[43026,1,""],[43025,1,""],[43025,0,"ing"],[43054,0,"'as"],[43056,1,""],[43055,1,""],[43055,0,"s"],[43073,0,"Your performance "],[43078,12,""],[43078,0,"benchmarks"],[43088,40,""],[43088,0," measure the wron "],[43105,1,""],[43105,0,"g thing"],[43068,0,"\n"],[43210,5,""],[43210,0,". And I' m"],[43219,1,""],[43218,1,""],[43218,0,"m measuring"],[43254,6,""],[43254,0," A"],[43379,3,""],[43378,1,""],[43377,1,""],[43376,1,""],[43376,0,". "],[43378,1,""],[43378,0,"O"],[43483,0," (And automerge is basically"],[43499,12,""],[43499,0,"usually performacn"],[43516,1,""],[43515,1,""],[43514,1,""],[43514,0,"s that well)"],[43525,0,"."],[43525,0," already"],[43536,26,""],[43593,0,"does "],[43613,1,""],[43658,0,"does "],[43680,1,""],[43700,3,""],[43700,0,"How much time it takes"],[43722,11,""],[43743,0," stored"],[44841,6,""],[44863,0," as a community"],[46057,0," Any pruning system should work with all of the algorithms I've shown here."],[46139,17,""],[46139,0,"Each ste"],[46144,3,""],[46144,0,"improvement changes too many"],[46182,9,""],[46962,0," LLVM?"],[46968,19,""],[46983,0," (Although"],[46983,10,""],[47373,12,""],[47369,4,""],[47369,0,"Because its "],[49099,1,""],[49098,1,""],[31166,32,""],[31166,0,"this code runs"],[31184,6,""],[31184,0,"slower through WASM"],[31208,36,""],[31208,0,"it the"],[31211,0,"because "],[31219,3,""],[31218,1,""],[31229,4,""],[31229,0," calls to the "],[31247,9,""],[31247,0," VM are  slo"],[31258,1,""],[31257,1,""],[31256,1,""],[31255,1,""],[31255,0,"slow"],[31271,21,""],[31271,0,"simply"],[31287,1,""],[31286,1,""],[31285,1,""],[31285,0,"e"],[31302,0," better,"],[31309,1,""],[31309,0,", since it can use"],[31309,18,""],[31286,0," & vectorize"],[31414,0," also"],[31455,17,""],[31455,0,"stea"],[31458,1,""],[31457,1,""],[31457,0,"ay put"],[31471,0," subsequent"],[31460,3,""],[31455,5,""],[31454,1,""],[31454,0,"'re "],[31455,3,""],[31455,0,"d"],[31455,1,""],[31454,1,""],[31454,0," don't move between"],[31473,29,""],[31478,0,"s"],[31478,1,""],[31455,10,""],[31455,0,"have exactly the same shape"],[31490,0," benchmark"],[31513,0,"its "],[31520,0," memory"],[31964,1,""],[31963,1,""],[31962,1,""],[31961,1,""],[31960,1,""],[31960,0,"ative"],[31971,8,""],[31979,0," was deleted"],[31971,1,""],[31970,1,""],[31970,0," m"],[31971,1,""],[31970,1,""],[31970,0,"means the "],[31868,0," "],[35071,0,"i"],[35071,1,""],[35071,0,"With a linear scale "],[35091,1,""],[35091,0,"t"],[35100,8,""],[35099,1,""],[34843,0,"\n\nI'"],[34846,1,""],[34845,1,""],[34845,0,"I've been resisting listing op"],[34874,1,""],[34873,1,""],[34872,1,""],[34872,0," the "],[34845,32,""],[34845,0,"But remember, t"],[34859,1,""],[34859,0,"automerge au"],[34870,1,""],[34869,1,""],[34869,0,"and ref-crdts "],[34859,0,"the "],[34887,0,"impleemntations w"],[34887,17,""],[34887,0,"implementations aren't consistentl"],[34920,1,""],[34920,0,". These numbers change a lot "],[34845,0,"I've been generally rse"],[34867,1,""],[34866,1,""],[34866,0,"eiss"],[34869,1,""],[34868,1,""],[34867,1,""],[34867,0,"sisting showing perfomrance n"],[34883,13,""],[34883,0,"performance numbers like this because "],[34921,17,""],[34920,1,""],[34961,17,""],[34961,0,"get slower over time"],[34983,27,""],[34983,0,"They'd be "],[34988,5,""],[34988,0,"re much faster than this with small dco"],[35026,1,""],[35025,1,""],[35025,0,"ocuments, and slower with large n"],[35057,1,""],[35057,0,"documents."],[34845,75,""],[34845,0,"But these totals for"],[34889,37,""],[34889,0," are entirel "],[34893,9,""],[34893,0," extreml"],[34900,1,""],[34900,0,"ely benchmark dependant"],[34926,3,""],[34926,0,"he algorithms are"],[34943,8,""],[34950,15,""],[34950,0," with"],[34994,0,"r"],[34961,0,"er"],[12023,10,""],[12050,0," before its ready."],[12069,3,""],[12069,0,"O"],[12082,3,""],[12082,0,"the code is "],[12091,3,""],[12091,0,"performs nearly the"],[12100,10,""],[12100,0,"almost the same as"],[12118,19,""],[12146,1,""],[12146,0,":\n\n#"],[12149,1,""],[12149,0,"@"],[12149,1,""],[12149,0,"![](am_vs_amrs.svg)"],[12069,78,""],[12069,0,"W"],[12069,1,""],[12069,0,"Swict"],[12073,1,""],[12072,1,""],[12072,0,"tching to this "],[12082,5,""],[12082,0,"the rust back"],[12086,9,""],[12086,0,"automerge-rs backend doesn't make any "],[12120,4,""],[12120,0,"this test any faster."],[12141,21,""],[12141,0," (Though it does use 3x less R"],[12170,1,""],[12170,0,"memory)"],[12141,36,""],[19853,6,""],[19853,0,"does Yjs"],[19861,3,""],[19861,0," "],[19861,6,""],[19861,0," solve the"],[19849,23,""],[19849,0,"How did he manage that?\n\nSo remember, there are two problems"],[19876,33,""],[19876,0," t"],[19877,1,""],[19877,0,"remember, there are two problems to fix:\n\n- How do we find"],[19921,14,""],[19921,0,"If a user inserted at position 100 in the document, how do we find "],[19921,67,""],[19921,0,"How do we find a specific insert position "],[19962,1,""],[19962,0,"?\n- How do we insert content at that location in a fast way?"],[19975,0," efficiently"],[20019,14,""],[19919,1,""],[19919,0,"1."],[19966,1,""],[19966,0,"2"],[19966,1,""],[19965,1,""],[19965,0,"2. "],[20037,4,""],[20037,0,"the first "],[20046,1,""],[20160,11,""],[20160,0,"bounce around"],[20196,0,"Rather than scanning the document each time an edit hape"],[20251,1,""],[20251,0,"pens, "],[20260,31,""],[20267,1,""],[20266,1,""],[20265,1,""],[20265,0,"es"],[20316,0," mae an"],[20322,1,""],[20321,1,""],[20320,1,""],[20319,1,""],[20319,0,"de an"],[20330,1,""],[20329,1,""],[20329,13,""],[20452,0," editing"],[20550,0,"What if edits happn"],[20568,1,""],[20568,0,"en randomly?!"],[20580,1,""],[20580,0," "],[20580,1,""],[20579,1,""],[20579,0,"?! "],[20581,0," But people don't actually edit documents randomly, so "],[20636,5,""],[20727,23,""],[20777,1,""],[20777,0,", so"],[20782,1,""],[20782,0,"t"],[20829,6,""],[20829,0,"near each user"],[20860,5,""],[20860,0,"they're"],[20871,1,""],[20871,0,"ing"],[20725,0," at the same time"],[20784,0,"d"],[20920,0,"Once yjs finds the target insert location, it needs to"],[20974,15,""],[20925,1,""],[20925,0,"Y"],[21033,7,""],[21039,4,""],[21039,0,"solves "],[21045,1,""],[21153,0,"*"],[21158,0,"*"],[21153,6,""],[21153,0,"constnat"],[21160,1,""],[21159,1,""],[21158,1,""],[21158,0,"tan"],[21160,1,""],[21159,1,""],[21158,1,""],[21158,0,"ant"],[21173,0,"has an extra bonus"],[21191,14,""],[21849,4,""],[21849,0,"So"],[21897,0," too"],[21911,29,""],[21932,0,", just stored more compactly"],[22077,0," internal"],[22124,4,""],[22124,0,"U"],[22165,5,""],[22165,0," o"],[22166,1,""],[22166,0,"document"],[22193,0," using t"],[22200,1,""],[22199,1,""],[22198,1,""],[22197,1,""],[22196,1,""],[22195,1,""],[22194,1,""],[22193,1,""],[22216,0," using this trick"],[22327,0,"conveniently "],[22423,0," And that happens a lot."],[22809,0," in this test"],[22822,1,""],[22822,0,"."],[22824,3,""],[22824,0,"And"],[22828,6,""],[22828,0,"because"],[22828,30,""],[36732,26,""],[36732,0,"what some of my fie"],[36750,1,""],[36749,1,""],[36749,0,"riends"],[36732,23,""],[36732,0,"what some friends would"],[36742,0,"of my "],[36732,29,""],[36732,0,"the reactions of some of my friends"],[36735,0," ridicule"],[36744,13,""],[36744,0," from"],[38902,0," list"],[38912,15,""],[38912,0," implementation"],[39527,0,"\n\nAutomerge is also in the process of dramatically improving performance based on "],[39529,0,"The "],[39533,1,""],[39533,0,"a"],[39542,0," team is also fantastic. They've been receptive to a lo"],[39567,30,""],[39567,0,"I've chatted with them about a lot of these issues and they're "],[39630,9,""],[39683,9,""],[39683,0,"using these tricks. I"],[39703,1,""],[39703,0,"By the time your ea"],[39703,19,""],[39703,0,"In a "],[39703,5,""],[39702,1,""],[39702,0," Performance might have impro"],[39726,5,""],[39726,0,"dramatically"],[39703,0,"Automerge "],[39713,1,""],[39713,0,"p"],[39748,0," improved by the time"],[39758,11,""],[39758,0,"between whe"],[39768,1,""],[39767,1,""],[39766,1,""],[39766,0,"time time I"],[39766,11,""],[39766,0,"the time I wrote this and"],[39758,33,""],[39758,0,"by the time you're reading this too."],[39572,33,""],[39572,0,"had some great conversations with them about "],[39629,0,". They care about '"],[39635,0,"'"],[39636,12,""],[39636,0,"re making performance then "],[39662,1,""],[39661,1,""],[39661,0," #1 issue of 2021 "],[39679,2,""],[39691,18,""],[39691,0,"planning on using a lot of these tricks to "],[39734,53,""],[39734,0,"make the"],[39739,3,""],[39739,0,"automerge fast."],[39753,1,""],[39755,55,""],[39755,0,"It might already be much faster "],[39819,3,""],[39818,1,""],[39856,0,"there's a lot of work that"],[39856,26,""],[39856,0,"I'll probably"],[39869,16,""],[39932,0," and automerge"],[40138,0,", editor bindings"],[40167,19,""],[40166,1,""],[39880,0," it"],[39950,0," Good CRDT libraries need a "],[39951,27,""],[39951,0,"There's "],[39958,1,""],[39957,1,""],[39956,1,""],[39956,0," is a lot more that goes into a good CRDT library than speed."],[40017,84,""],[40017,0," CRDT libraries also need to support"],[40053,10,""],[40090,12,""],[40098,0," data"],[40655,0,"all benchmarks are lies"],[40678,55,""],[40678,0,", and I'm not immune"],[40646,0,"Well, "],[40652,1,""],[40652,0,"y"],[40660,0," "],[40660,1,""],[40661,44,""],[40646,15,""],[40646,0,"Well, yes. But"],[40613,31,""],[40613,0," Lies, damned lies and benchmarks"],[40648,14,""],[40647,1,""],[40646,1,""],[40646,0,"\n\nIs this for real? Yes, but .."],[40676,1,""],[40675,1,""],[40674,1,""],[40674,0,"..."],[40678,0,"\nFirst, "],[40686,2,""],[40686,0,"i"],[40669,0,". And hopefully this is all reproducable."],[40710,1,""],[40711,1,""],[40711,0,"B"],[40670,47,""],[40670,0," But I'm not telling the full picture here."],[40675,0,"pefo"],[40678,1,""],[40677,1,""],[40677,0,"rofmr"],[40681,1,""],[40680,1,""],[40679,1,""],[40678,1,""],[40678,0,"formance is complicated and "],[40816,0,"you can but "],[42356,11,""],[42356,0,"A"],[42351,0,"\n"],[42357,3,""],[42357,0,"Is it fair"],[42357,10,""],[42357,0,"Are CRDT and "],[42361,9,""],[42361,0,"Yjs "],[42361,0,"Automerge and "],[42379,31,""],[42379,0,"doing the same thing? IS it"],[42405,1,""],[42404,1,""],[42403,1,""],[42402,1,""],[42401,1,""],[42400,1,""],[44077,20,""],[44472,0,", a"],[44474,1,""],[44474,0,"barring some unlucky GC pauses"],[45624,3,""],[45624,0,"an"],[45606,4,""],[45606,0,"stores"],[45644,63,""],[45644,0,"The result is that"],[45662,8,""],[45749,0," This uses extra RAM, that none o "],[45782,1,""],[45782,0,"f the other"],[45769,24,""],[45769,0," for a sweet feature, which none of the other implementations"],[45644,0,"As a "],[45649,4,""],[45655,0,","],[45656,8,""],[45725,0," in question"],[45775,61,""],[45775,0,"."],[45761,0,"justifyable "],[45772,1,""],[45771,1,""],[45770,1,""],[45770,0,"ly "],[45767,1,""],[45767,0,"i"],[45794,0,"\nThere's a performance mesa"],[45820,1,""],[45819,1,""],[45819,0,"ausre"],[45817,7,""],[45817,0,"measure nobody is taking seriously enough at the moment. And ti"],[45879,1,""],[45878,1,""],[45878,0,"that is, "],[45886,1,""],[45885,1,""],[45885,0,", "],[45795,92,""],[45795,0,"There's a performance measure nobody is taking seriously enough at the moment. And that is,"],[45886,80,""],[45886,0," "],[45919,0," (in a database)"],[45990,0,"And "],[45994,1,""],[45994,0,"u"],[46015,0,"are actually interat"],[46034,1,""],[46034,0,"cting with "],[46045,4,""],[46044,1,""],[46219,13,""],[46219,0,"isn't very"],[46225,4,""],[46225,0,"often useful"],[46124,0,"."],[46126,6,""],[46126,0,"T"],[46221,13,""],[46221,0,"how we should interact wti"],[46246,1,""],[46245,1,""],[46245,0,"ith this sort of data."],[46125,142,""],[47052,11,""],[47052,0,"step in this sto"],[47065,3,""],[47065,0,"journey"],[47213,0,"implementation "],[47228,12,""],[47234,1,""],[47234,0,"d"],[47235,3,""],[47560,11,""],[47560,0,"all of thes"],[47567,4,""],[47567,0,"t"],[47564,4,""],[47564,0,"this"],[47574,10,""],[47574,0,"I'm "],[47577,1,""],[47582,1,""],[47582,0,"sing"],[47590,11,""],[47590,0," "],[47607,0," should be distributed"],[47641,19,""],[47641,0," those changes"],[47884,0,"'s optimizer"],[47912,0," (Though if "],[47920,4,""],[47920,0," the fact automerge-rs is still pretty so"],[47960,1,""],[47960,0,"low"],[47945,18,""],[47945,0,"n't any faster than automerge gives me some confidence)"],[47999,0,"."],[47999,0," that its not just rust"],[47914,8,""],[47914,0,"T"],[47914,102,""],[47898,0,"\nThe fact automerge-rs isn't any faster than automerge gives me some confidence that its not just rust."],[47907,0," that"],[47931,4,""],[48002,0," But honestly"],[48015,1,""],[48015,0," "],[48031,1,""],[48030,1,""],[48029,1,""],[48028,1,""],[48028,0,"."],[40823,0,". "],[40824,1,""],[40823,1,""],[40823,0,": (Though"],[40878,1,""],[40878,0,")"],[40861,12,""],[40866,0,"."],[40832,4,""],[40823,1,""],[40823,0,"."],[40826,6,""],[40826,0,"But"],[40825,1,""],[40859,1,""],[1327,4,""],[1327,0,"their"],[1362,28,""],[1362,0,"S"],[1369,0," smart"],[1369,6,""],[1369,0," smart"],[1369,6,""],[1362,1,""],[1362,0,"s"],[1362,0,"The annoying part was that "],[1365,9,""],[1365,0," infuriating"],[2903,0," someone out "],[2874,6,""],[2866,8,""],[2866,0,"somebody will find"],[2920,0,"there will write a"],[2938,7,""],[2960,1,""],[4708,3,""],[4708,0,"Thats"],[21087,25,""],[21087,0,"using "],[21106,0," instead of an array"],[21128,24,""],[21128,0,"L"],[21147,7,""],[21153,0,"s"],[21128,0,"Ao lo"],[21132,1,""],[21131,1,""],[21130,1,""],[21129,1,""],[21128,1,""],[21128,0,"so lon"],[21128,6,""],[21128,0,"So long as we have an insert position, "],[21167,1,""],[21167,0,"l"],[21186,8,""],[21186,0,"us to insert "],[21186,6,""],[21192,0,"s"],[21094,0," bidirectional"],[21200,0,"th"],[21201,1,""],[21200,1,""],[21231,36,""],[21231,0,"does one more thing to makep"],[21258,1,""],[21254,4,""],[21254,0,"improve perofrman"],[21262,9,""],[21262,0,"performance"],[21273,1,""],[21273,0,"."],[21275,9,""],[21275,0,"H"],[21281,0," usually"],[21316,1,""],[21316,0,"."],[21318,1,""],[21318,0,"W"],[21317,0," So"],[21320,2,""],[21320,0," w"],[21916,4,""],[21916,0,"F"],[22026,161,""],[22025,1,""],[22229,13,""],[22336,133,""],[22338,5,""],[22338,0,"I"],[22346,12,""],[22345,1,""],[22356,4,""],[22356,0,"using space"],[22366,1,""],[22365,1,""],[22365,0,"ns"],[22367,7,""],[22398,16,""],[22397,1,""],[22390,0,"array "],[22403,6,""],[23072,0," oni "],[23076,1,""],[23075,1,""],[23074,1,""],[23073,1,""],[23073,0,"in this test"],[23153,1,""],[23153,0,"."],[23155,3,""],[23154,1,""],[23155,1,""],[23155,0,"I"],[23124,9,""],[23355,0," Look -"],[23370,0," even"],[23356,7,""],[23881,16,""],[23881,0,"Kevin"],[23881,5,""],[23881,0,"Or when the user"],[23931,0,"Bu"],[23932,1,""],[23931,1,""],[23931,0,"This is neat, but "],[23949,1,""],[23949,0,"t"],[26311,19,""],[26311,0,"more information"],[26343,2,""],[26343,0,"of"],[26360,0,"We want"],[26367,2,""],[26401,5,""],[26401,0,"to"],[26702,42,""],[26702,0,"thats "],[26702,6,""],[26702,0,"Thats probably no "],[26719,1,""],[26719,0,"t a big ea"],[26728,1,""],[26727,1,""],[26727,0,"deal in text editing"],[26789,0," use"],[26851,4,""],[26851,0,"slow"],[26855,9,""],[26986,6,""],[26986,0,"exotic "],[27304,20,""],[27304,0,"is very clever"],[27318,6,""],[27323,0," its not "],[27332,10,""],[27342,3,""],[27342,0,"microoptimization"],[27342,17,""],[27342,0,"small"],[27342,5,""],[27342,0,"clever"],[27412,0," at all"],[27413,6,""],[27412,1,""],[27401,0,"'"],[27383,0,"'"],[27384,18,""],[27384,0,"re not limited to"],[27401,1,""],[27412,0," here"],[27412,5,""],[27449,0,"'"],[27449,1,""],[27770,3,""],[27770,0,"the"],[27780,1,""],[27780,0,"\n\nUsually when people talk about b-trees they meana  "],[27832,1,""],[27831,1,""],[27830,1,""],[27830,0," a BTreeMap "],[27841,1,""],[27841,0,". But my implementation"],[27864,4,""],[27864,0," insn"],[27868,1,""],[27867,1,""],[27866,1,""],[27866,0,"sn't"],[27870,6,""],[27842,0," Thats not what I'm doing here."],[27873,48,""],[27893,7,""],[27893,0,"keys"],[27980,0," (recursively)"],[28009,34,""],[28009,0,"do insertions and delete"],[28032,1,""],[28032,0,"ions in"],[28049,6,""],[28049,0,"time, while updating the position of every character in the wole docu"],[28109,9,""],[28109,0,"whole document. It "],[28127,1,""],[28126,1,""],[28125,1,""],[28124,1,""],[27833,0,"["],[27842,0,"](https://doc.rust-lang.org/std/collections/struct.BTreeMap.html)"],[28009,21,""],[28009,0,"number of characters in that"],[28053,14,""],[28009,0,"totall "],[28015,1,""],[28014,1,""],[28014,0," "],[28118,71,""],[28118,0,"."],[28073,0," find any imt"],[28085,1,""],[28084,1,""],[28084,0,"tem by characte"],[28074,25,""],[28074,0,"look up any item by b"],[28094,1,""],[28094,0,"character position,"],[28113,3,""],[28123,1,""],[28122,1,""],[28121,1,""],[28120,1,""],[28120,0," or"],[28120,0,","],[28120,1,""],[28124,3,""],[28123,1,""],[28132,1,""],[28131,1,""],[28130,1,""],[28129,1,""],[28129,0,"e"],[28035,0," (recursively)"],[28075,4,""],[28075,0,"So we can"],[28084,8,""],[28101,0," in the document"],[28140,0," or"],[28161,0,"all "],[28160,0," anywhere in th edocument"],[28175,1,""],[28176,0," "],[28186,4,""],[28241,0,"\n"],[28241,0,"\n> Does this have a name? I've been calling it a \"range tree\", but that name see"],[28318,3,""],[28318,0,"is ["],[28321,1,""],[28321,0,"[taken by another al"],[28339,2,""],[28339,0,"data structure](https://en.wikipedia.org/wiki/Range_tree)"],[28308,0,"I think "],[28315,1,""],[28314,1,""],[28313,1,""],[28312,1,""],[28311,1,""],[28310,1,""],[28309,1,""],[28308,1,""],[28308,4,""],[28308,0,"I think that"],[35329,0,"\n"],[35329,0,"\nThe total "],[35330,10,""],[35330,0,"I"],[35330,1,""],[35330,0,"In this benchmark the average"],[35330,29,""],[35330,0,"The number of operations per second looks like this"],[35330,3,""],[35330,0,"In this benchn"],[35343,1,""],[35343,0,"mark the"],[35362,10,""],[35362,0,"edits each algorithm can process"],[35421,0,":"],[35444,0," reem"],[35448,1,""],[35447,1,""],[35447,0,"member,"],[35455,17,""],[35445,10,""],[35445,0,"particularly for "],[35485,0,", these perorman"],[35493,8,""],[35493,0,"performance numbers"],[35563,3,""],[35563,0,"run"],[35631,0," "],[35631,1,""],[35631,0," And in the case of automerge, it may be able to do about 900 edits per second"],[35680,2,""],[35680,0,"process"],[35714,0," *on average*, but the slowest edit during this benchmark took "],[35772,5,""],[35772,0,"stalle "],[35778,1,""],[35778,0,"d the jav"],[35780,7,""],[35780,0,"javascript for 1.8 *"],[35799,1,""],[35799,0,"seconds."],[35780,10,""],[35780,0,"V8"],[35772,0,"entirely "],[35772,9,""],[35772,0,"completely "],[35546,1,""],[35546,0," because"],[35554,4,""],[35554,0," the"],[35570,45,""],[35570,0,"slow down as the document grows"],[35601,22,""],[35632,0," although"],[35644,15,""],[35644,0," can"],[35697,4,""],[35736,0," run"],[35740,11,""],[35768,0," In a res"],[35776,1,""],[35776,0,"al usage "],[35778,7,""],[35778,0," appli"],[35774,10,""],[35774,0,"web application this woudl"],[35799,1,""],[35798,1,""],[35798,0,"ld make the whole webpage hang "],[35828,1,""],[35828,0,"."],[35816,8,""],[35816,0,"app"],[35818,1,""],[35817,1,""],[35816,1,""],[35816,0,"web app "],[10839,4,""],[10838,1,""],[10838,0," Its "],[10839,4,""],[10839,0,"This chart averaes"],[10856,1,""],[10855,1,""],[10855,0,"ges over "],[10767,97,""],[10767,0,"That big spike? A group of 1000 edits took over 3.5 seconds to process. This chart averages over"],[10783,80,""],[10783,0,"It happened because a single edit took *1.2"],[10825,1,""],[10825,0,"8 seconds* to process. (Presumably"],[10849,10,""],[10848,1,""],[10847,1,""],[10817,4,""],[10817,0,"was processing for"],[10849,12,""],[10849,0,". Of"],[10852,1,""],[10852,0,"f"],[10852,1,""],[10852,0,"of. In a real application that would feel like the whole website freezing up for a couple of seconds hli"],[10955,1,""],[10954,1,""],[10953,1,""],[10953,0,"while you're trying "],[10966,7,""],[10966,0,"in the middle of typing."],[10783,21,""],[10783,0,"A"],[10863,33,""],[10863,0,"means the whole applicatoin"],[10889,1,""],[10888,1,""],[10887,1,""],[10887,0,"ion would"],[10904,1,""],[10903,1,""],[10902,1,""],[10902,0,"e"],[10903,3,""],[10862,6,""],[10862,0," would translate to"],[10863,6,""],[10872,0,"s"],[10898,6,""],[10904,1,""],[10904,0,"ing up"],[10863,11,""],[10863,0,"would translate to "],[10879,3,""],[10863,22,""],[10863,0,"would result in the"],[10863,15,""],[10863,0,"means"],[10890,0," would"],[10904,1,""],[10903,1,""],[10902,1,""],[10901,1,""],[10901,0,"e"],[10901,1,""],[10901,0,"ze"],[10930,0," sometimes"],[10954,17,""],[10879,11,""],[10879,0,"app"],[10883,0,"("],[10883,1,""],[10883,0,"(or browser tab) "],[10939,10,""],[10952,0," in the middle of"],[10939,0," sometimes"],[11075,0,"We can see the "],[11090,1,""],[11090,0,"p"],[11090,0,"average "],[10858,11,""],[35486,19,""],[35486,0,"T"],[35489,0," average"],[35540,0," in this test"],[35489,24,""],[35489,0," speed of processing edits"],[35496,3,""],[35496,0,"each algorithm "],[35520,1,""],[35519,1,""],[35518,1,""],[35518,0,"es"],[35526,51,""],[35565,0," remember -"],[35566,0,"these numbers are misleading. "],[35596,29,""],[35596,0,"In a"],[35596,0,"Remember, "],[35606,1,""],[35606,0,"i"],[35606,3,""],[35629,84,""],[35630,0,"gradually "],[35673,46,""],[35673,0,"Automerge can "],[35735,0," but"],[35673,0,"And even though "],[35689,1,""],[35689,0,"a"],[35826,61,""],[35486,0,"A"],[35486,1,""],[35486,0,"We can make a chart showing "],[35514,1,""],[35514,0,"t"],[35554,16,""],[35641,0," aren't steady. They"],[35661,10,""],[35661,0,"'re fast at first "],[35678,1,""],[35678,0,", then "],[35684,1,""],[35797,3,""],[35796,1,""],[35854,0," a full"],[35808,0," single"],[35808,7,""],[35801,7,""],[35800,1,""],[35800,0,"re was an"],[35806,3,""],[35802,4,""],[35800,2,""],[35800,0," slowest"],[35518,0,"average "],[35803,0," (wh"],[35806,1,""],[35805,1,""],[35804,1,""],[35804,0,"(which f"],[35811,1,""],[35811,0,"is fast enough that users's "],[35838,1,""],[35837,1,""],[35836,1,""],[35835,1,""],[35835,0,"s won't notice)"],[35929,0," "],[35929,1,""],[35851,0," memory usage pac"],[35867,1,""],[35866,1,""],[35866,0,"eaked at 2.6GB and"],[9939,0," The peak memory usage is "],[9940,25,""],[9940,0,"At peak, automerge u"],[9959,1,""],[9949,10,""],[9949,0,"the benchmark used 2.6 GB of RAM."],[9962,5,""],[9962,0," needed"],[9534,0,"v"],[9534,1,""],[9534,0,"v"],[9550,0,"v"],[9550,1,""],[9548,1,""],[9549,0,"v"],[9549,1,""],[35897,0,"in this test "],[35936,0," "],[36021,0," I "],[36023,1,""],[36022,1,""],[36022,0,"My test be"],[36031,1,""],[36030,1,""],[36025,5,""],[36025,0,"workstation has CPU and RAM for days, but your users w"],[36078,1,""],[36078,0,"w"],[36078,1,""],[36078,0,"don't."],[36021,63,""],[35897,47,""],[36316,0,"\n"],[37233,0," write "],[37234,6,""],[37234,0,"optimize"],[37320,26,""],[37320,0,"wa"],[37321,1,""],[37321,0,"hat "],[37311,25,""],[37318,2,""],[37318,0,"normal"],[37325,0," (Howls o"],[37327,7,""],[37327,0,"l"],[37327,1,""],[37327,0,"Laughter of my friends notwithstanding)"],[37365,0,"."],[37318,6,""],[37318,0,"ok"],[37323,38,""],[37323,0,"Despite what my feien"],[37343,1,""],[37342,1,""],[37341,1,""],[37340,1,""],[37340,0,"riends would have you think"],[37367,1,""],[37367,0,"!"],[37366,1,""],[37365,1,""],[37364,1,""],[37363,1,""],[37362,1,""],[37361,1,""],[37360,1,""],[37359,1,""],[37358,1,""],[37357,1,""],[37356,1,""],[37355,1,""],[37354,1,""],[37353,1,""],[37352,1,""],[37351,1,""],[37350,1,""],[37349,1,""],[37348,1,""],[37347,1,""],[37347,0,"think"],[37890,0," between wp"],[37900,1,""],[37899,1,""],[37899,0,"people with "],[37911,76,""],[37910,1,""],[38907,0,". Fr"],[38910,1,""],[38910,0,"or all O"],[38917,1,""],[38917,0,"of Kevin's "],[38909,19,""],[38909,0,"Kevin is "],[38909,9,""],[38909,0,"For all of Kevin's "],[38909,19,""],[38909,0,"Yjs is excellent in part because"],[38909,32,""],[38909,0,"Kevin adapt"],[38915,5,""],[38914,1,""],[38913,1,""],[38912,1,""],[38911,1,""],[38910,1,""],[38909,1,""],[38908,1,""],[38907,1,""],[38908,0," k"],[38909,1,""],[38909,0,"Kevin"],[38909,5,""],[38909,0,"Yjs's "],[38914,1,""],[38913,1,""],[38912,1,""],[38912,0," owes its serialization"],[38913,22,""],[38913,0,"adapted"],[38912,8,""],[38909,0,"Kevin copied it "],[38909,19,""],[38908,1,""],[31851,0," Remember, the WASM version s"],[31879,1,""],[31879,0,"(shown here) is "],[31895,33,""],[31905,12,""],[31895,0,"still "],[31911,0,"than how"],[31916,3,""],[31916,0,"the speed this code runs nativelay"],[31949,1,""],[31948,1,""],[31948,0,"y"],[31950,0," I wonder why?"],[31965,13,""],[31965,0,"Are th"],[31970,1,""],[31969,1,""],[31968,1,""],[32000,4,""],[32119,13,""],[32119,0,"I"],[32119,1,""],[32119,0,"No matter - i"],[32283,0," requesting morem"],[32299,1,""],[32299,0," memory form "],[32311,1,""],[32310,1,""],[32309,1,""],[32308,1,""],[32308,0,"rom "],[32259,5,""],[32259,0,"t"],[32280,0,"is "],[32253,58,""],[32253,0,"I suse"],[32258,1,""],[32258,0,"pect its the"],[32263,7,""],[32263,0,"the memory allocator"],[32273,10,""],[32266,7,""],[32263,3,""],[32263,0,"its the"],[32266,4,""],[32262,4,""],[32258,4,""],[32258,0,"e"],[32254,5,""],[32253,1,""],[32253,0,"Maybe the memory allocator is requesting more memory from "],[32282,1,""],[32280,2,""],[32259,1,""],[32259,0,"its t"],[32311,1,""],[32308,3,""],[32308,0,"orm "],[32311,1,""],[32306,5,""],[32299,7,""],[32299,0,"m"],[32294,6,""],[32283,11,""],[32000,0," are"],[32000,4,""],[32253,5,""],[32253,0,"Its probably"],[32265,4,""],[32286,1,""],[32286,0,"."],[31951,10,""],[31951,0,"W"],[31753,0," performance through"],[31778,17,""],[31778,0," in the"],[31784,1,""],[31784,0,"is chart"],[31869,0,"And "],[31873,1,""],[31873,0,"r"],[31883,79,""],[31883,0,"this is the slow version. The code runs 3x faster "],[31923,0,"another "],[31951,0,"But "],[31955,1,""],[31955,0,"w"],[32114,11,""],[32114,0,"I"],[32115,2,""],[32114,0,"Mayb "],[32118,1,""],[32118,0,"e it doesn't matter too much - "],[32149,1,""],[32149,0,"i"],[32271,0,"I assume its"],[32283,12,""],[32271,10,""],[32271,0,"I"],[32274,0," probably"],[31909,3,""],[31909,0,"When I run this benchmark natively it"],[31946,5,""],[31969,9,""],[31952,7,""],[31951,1,""],[31961,0," again"],[31962,5,""],[31961,1,""],[31961,0," than this"],[32171,3,""],[32171,0,"the code is"],[31652,5,""],[31652,0,"needs"],[31657,7,""],[31662,0," calls to malloc"],[31678,6,""],[31652,5,""],[31652,0,"makes"],[32638,0,"Note: "],[33483,0,"For "],[33487,1,""],[33487,0,"l"],[33504,5,""],[33504,0," we'll end up"],[33522,1,""],[33522,0,"ing"],[33483,3,""],[33483,0,"In"],[33483,2,""],[33483,0,"For"],[33570,2,""],[33570,0,"For example"],[33599,0," CRDT"],[33620,7,""],[33620,0,"the editor"],[33636,4,""],[33636,0,"keep"],[33755,0,", at all"],[33765,83,""],[33765,0,"This implementation approach makes it easy to just turn that part of the code off."],[33902,0,"But regardless, "],[33918,1,""],[33918,0,"m"],[19104,0,"'"],[19945,0,"w"],[19945,1,""],[19945,0,"e"],[2658,0,"'"],[3489,0,"'"],[4739,0,"'"],[5084,0,"'"],[5249,0,"'"],[5247,4,""],[5247,0,"Automerge is"],[7427,3,""],[7427,0,"This is"],[8152,3,""],[8152,0,"i'"],[8153,1,""],[8153,0,"t's"],[9874,0,"'"],[12313,0,"'"],[12727,0,"'"],[12998,0,"'"],[12998,1,""],[12998,0,"'"],[12998,1,""],[12727,1,""],[12727,0,"'"],[12727,1,""],[12313,1,""],[12313,0,"'"],[12727,0,"'"],[13294,0,"'"],[13505,0,"'"],[14303,0,"'"],[14448,0,"'"],[14868,0,"'"],[14924,0,"'"],[16554,0,"'"],[16840,0,"'"],[17369,0,"'"],[22821,0,"'"],[23382,0,"'"],[23664,0,"'"],[24030,0,"'"],[24827,0,"'"],[24834,0," a"],[25463,0,"'"],[27567,0,"'"],[29578,0,"'"],[30079,0,"'"],[30530,0,"'"],[32350,0,"'"],[32957,0,"'"],[35076,0,"'"],[36252,0,"'"],[36252,1,""],[36252,0,"'"],[36275,2,""],[36275,0,"this"],[36270,4,""],[36270,0,"tiy"],[36272,1,""],[36272,0,"dy"],[37073,0,"'"],[41132,0,"'"],[41775,0,"'"],[44440,0,"'"],[48705,0,"'"],[49145,0,"'"],[12999,0,"  "],[13000,1,""],[12999,1,""],[28446,0,"\n"],[28446,0,"\nIn "],[28447,3,""],[28447,0,"This example shows a docuen"],[28473,1,""],[28472,1,""],[28472,0,"ment with 1000 charat"],[28492,1,""],[28492,0,"cters"],[28477,0,"which currently has "],[28497,5,""],[28512,0,"."],[28512,1,""],[28512,0,":"],[28466,0,"the tree storing "],[28841,4,""],[28841,0,"5"],[28892,0," In th e"],[28899,1,""],[28898,1,""],[28898,0,"e examlpe abo"],[28900,11,""],[28900,0,"example above, we "],[28841,1,""],[28841,0,"2"],[28915,3,""],[28915,0,"the item with position 200 must be in the "],[28938,3,""],[28938,0,"345"],[28940,1,""],[28939,1,""],[28939,0,"50"],[28957,0,"middle node in the in"],[28964,14,""],[28964,0,"leaf node here."],[29079,0," in this benchmark"],[30036,0," Unlike in the diagram,"],[30060,1,""],[30060,0,"e"],[30287,10,""],[30287,0,"CPUs can copy several"],[30332,0,"Its "],[30336,1,""],[30336,0,"n"],[30395,0," entries"],[30411,2,""],[30411,0,"this"],[30447,0,"bucket "],[30697,0," Thats 5x faster than yjs, and"],[30727,8,""],[30727,0," m"],[30728,1,""],[30728,0,"remarkably"],[30788,10,""],[30788,0,", "],[30789,1,""],[30788,1,""],[30788,0,"."],[30722,1,""],[30722,0,"."],[30724,4,""],[30724,0,"And "],[30754,0,"our baseline test "],[30806,1,""],[30806,0,", despite"],[30815,9,""],[30822,36,""],[30822,0,"all the work to support"],[30867,4,""],[30870,5,""],[30870,0,"I"],[30870,1,""],[30870,0,"And i"],[30870,5,""],[30870,0,"I"],[30884,2,""],[30884,0,"this benchmark"],[30918,0,"["],[30945,0,"](https://github.com/josephg/text-crdt-rust/blob/ba20b6386c0472958f33024ce0b806e75470e1ca/benches/yjs.rs)"],[36122,12,""],[36122,0,"calculate"],[36131,8,""],[36344,5,""],[36344,0,"E"],[37087,0," As Ive"],[37093,1,""],[37092,1,""],[37092,0,"'ve shown,"],[37103,1,""],[37103,0,"w"],[10831,14,""],[10831,0,"In the big spike"],[10831,16,""],[10831,0,"In the slowest spike near the end,"],[10865,1,""],[10866,1,""],[10866,0,"a"],[10880,18,""],[10880,0,"took"],[10898,0," to process"],[10937,0,","],[12412,0," (Although it does smooth out pre"],[12444,1,""],[12443,1,""],[12443,0,"erformance)"],[12431,0,"halve memory usage and "],[12477,0,"."],[12477,1,""],[12476,0,"."],[12391,9,""],[12391,0,"average perofma"],[12405,1,""],[12404,1,""],[12403,1,""],[12402,1,""],[12402,0,"formance in this test"],[45279,5,""],[47003,1,""],[47003,0,"one other"],[47033,0,"I think "],[47206,5,""],[47206,0,"U"],[47599,4,""],[47599,0,"for"],[47817,0,"There's another per"],[47835,1,""],[47834,1,""],[47833,1,""],[47833,0,"aprp"],[47836,1,""],[47835,1,""],[47835,0,"proach to making CRDTs fast, which is pruning. Essentially, "],[47881,52,""],[47881,0," "],[47869,0," I haven't mentioned here at all and that"],[47914,0,"*"],[47922,0,"*"],[47925,0,"By e"],[47928,1,""],[47928,0,"default, list "],[47953,4,""],[47953,0,"e"],[47953,1,""],[47953,0,"these"],[47959,0,"only ever "],[47993,0," m"],[47994,1,""],[47994,0,"have to"],[48018,4,""],[48018,0,"for"],[48041,0," There are a few apr"],[48060,1,""],[48060,0,"proaches which pull"],[48041,0," Storing and"],[48042,11,""],[48042,0,"A lot of the performance and memory cost of CRDTs coem"],[48095,1,""],[48094,1,""],[48094,0,"mes from storing"],[48103,0,"loading, "],[48119,0," and searching that growing data set."],[48194,0," this data out entirely."],[48218,22,""],[48219,1,""],[48219,0,"Fo"],[48220,1,""],[48219,1,""],[48167,5,""],[48167,0,"some"],[48216,0,", and "],[48216,6,""],[48218,0,"For example, "],[48231,3,""],[48264,1,""],[48254,0,"["],[48265,0,"](https://braid.org/antimatter)"],[48189,0,"solve this problem by finding ways to "],[48227,9,""],[48227,0,"discard this"],[48244,5,""],[48244,0," "],[48227,7,""],[48227,0,"hs"],[48228,1,""],[48227,1,""],[48227,0,"shed"],[48232,0,"some of "],[48339,0," That said,"],[48350,40,""],[48354,0," just has its "],[48355,13,""],[48355,0,"repositories have tehi"],[48376,1,""],[48375,1,""],[48374,1,""],[48374,0,"heir data "],[48368,16,""],[48368,0,"only grow over time"],[48373,0,"ever "],[48392,5,""],[48392,0," and"],[48396,2,""],[48422,45,""],[48422,0,". So maaby"],[48431,1,""],[48430,1,""],[48429,1,""],[48429,0,"ybe"],[48424,8,""],[48424,0,"Maybe it doesn't matter so long as the underlying system is fast enough?"],[48418,0,"about "],[48410,18,""],[48410,0,"mind too much"],[48503,6,""],[48503,0,"pruning is"],[48557,4,""],[48557,0," A"],[48575,0,"also "],[48574,0," should also"],[48586,17,""],[48586,0," be abl"],[48590,3,""],[48590,0,"applicable to"],[48603,9,""],[48603,0," any"],[48642,0," Maybe thats how "],[48648,11,""],[48648,0," ruthlessly pruning & archiving old dta"],[48686,1,""],[48685,1,""],[48685,0,"ata is how "],[48692,4,""],[48692,0,"the patch"],[48700,1,""],[48699,1,""],[48699,0,"t"],[48699,1,""],[48698,1,""],[48698,0,"th to getting another 5x "],[48712,11,""],[48712,0,"evebn "],[48717,1,""],[48716,1,""],[48715,1,""],[48715,0,"b "],[48716,1,""],[48715,1,""],[48715,0,"m "],[48716,1,""],[48715,1,""],[48715,0,"n better performance, yet "],[48735,6,""],[48735,0,"."],[48558,1,""],[48558,0,"Any good"],[48593,17,""],[48593,0," work with"],[48603,4,""],[48603,0," all"],[48631,0,"talk a"],[48636,1,""],[48635,1,""],[48635,0,"ed about"],[48643,5,""],[48649,94,""],[48713,1,""],[48712,1,""],[48712,0,"s"],[48712,1,""],[48712,0,"ah"],[48735,14,""],[48735,0,"step in this optimization ho"],[48762,1,""],[48761,1,""],[48761,0,"jui"],[48763,1,""],[48762,1,""],[48762,0,"ourney involves"],[48785,0," to "],[48788,1,""],[48809,0,"For example, "],[48822,1,""],[48822,0,"m"],[48807,0," and I'm not isolating them"],[48830,4,""],[48830,0,"those changes"],[49265,1,""],[49264,1,""],[49263,1,""],[49263,0,"I can only"],[49281,1,""],[49280,1,""],[49279,1,""],[49361,1,""],[49355,6,""],[49355,0,"jump"],[49485,0,"yjs and "],[49485,8,""],[49698,9,""],[49700,0,"hoest"],[49704,1,""],[49703,1,""],[49702,1,""],[49702,0,"nestly "],[49765,5,""],[49765,0,"my "],[49785,0," problem"],[49852,5,""],[49852,0,"the"],[49948,5,""],[49948,0,"bread"],[49952,1,""],[49952,0,"kdown"],[50059,0,"still "],[50164,0,"["],[50164,1,""],[50164,0,"["],[50164,1,""],[50173,0," [from automerge:"],[50189,1,""],[50189,0,"](https://github.com/automerge/automerge/blob/d2e7ca2e141de0a72f540ddd738907bcde234183/backend/op_set.js#L649-L659)"],[15151,0," If yo're "],[15152,9,""],[15152,0,"It looks "],[15152,9,""],[15152,0,"Autom"],[15152,5,""],[15152,0,"Comp"],[15152,4,""],[15152,0,"Compacted, automerge looks like this:"],[15152,12,""],[15152,0,"A"],[15178,0,"\n\n"],[15179,0,"\n```javascript\n\n\n```"],[15194,1,""],[15194,0,"const integrateAutomergeSmol = <T>(doc: Doc<T>, newItem: Item<T>) => {\n  const {id} = newItem\n  doc.version[id[0]] = id[1]\n\n  let parent = findItem(doc, newItem.originLeft)\n\n  let i\n\n  // Scan to find the insert location\n  for (i = parent + 1; i < doc.content.length; i++) {\n    let o = doc.content[i]\n    let oparent = findItem(doc, o.originLeft)\n\n    // Should we insert here?\n    if (oparent < parent\n      || (oparent === parent\n        && (newItem.seq === o.seq)\n        && id[0] < o.id[0])\n    ) break\n  }\n\n  // We've found the position. Insert at position *i*.\n  doc.content.splice(i, 0, newItem)\n  doc.maxSeq = Math.max(doc.maxSeq, newItem.seq)\n}"],[15183,10,""],[15183,0,"typescript"],[15221,1,""],[15220,1,""],[15219,1,""],[15218,1,""],[15320,0,"i, "],[15366,9,""],[15842,1,""],[15562,0," (Thisi s "],[15571,1,""],[15570,1,""],[15569,1,""],[15568,1,""],[15564,4,""],[15564,0,"Black magic incoming)"],[15584,0,"!"],[15584,1,""],[15316,5,""],[15316,0,"let"],[15319,1,""],[15316,3,""],[15316,0,"const"],[15365,0,"  let i"],[15372,38,""],[15365,0,"  // Scan to find the insert location\n"],[15364,0,"\n  "],[15365,2,""],[15618,63,""],[15618,0,"      || (oparent === parent && (newItem.seq === o.seq)"],[15618,83,""],[15618,0,"      || (oparent === parent && (newItem.seq === o.seq) && id[0] < o.id[0])"],[15618,75,""],[15618,0,"      || (oparent === parent && (newItem.seq === o.seq)\n        && id[0] < o.id[0])"],[15618,55,""],[15618,0,"      || (oparent === parent\n        && (newItem.seq === o.seq)"],[15618,63,""],[15618,0,"      || (oparent === parent && (newItem.seq === o.seq)"],[15618,83,""],[15618,0,"      || (oparent === parent && (newItem.seq === o.seq) && id[0] < o.id[0])"],[15618,75,""],[15618,0,"      || (oparent === parent && (newItem.seq === o.seq)\n        && id[0] < o.id[0])"],[15618,55,""],[15618,0,"      || (oparent === parent\n        && (newItem.seq === o.seq)"],[15571,0,"Warning: "],[15591,9,""],[15580,0,"Deep sourcery"],[15593,11,""],[15593,0,"Black magic"],[15584,9,""],[15580,4,""],[15591,0,"."],[15591,1,""],[15152,10,""],[15152,0,"Written this way, automerge "],[15382,0," /** "],[15386,1,""],[15385,1,""],[15384,1,""],[15384,0,"/ SLOW"],[15382,8,""],[15160,8,""],[15160,0,"in thi"],[15160,6,""],[15160,0,"in thi s"],[15167,1,""],[15166,1,""],[15166,0,"s style"],[15184,11,""],[15184,0," turns into"],[14892,2,""],[14892,0,"This"],[15154,49,""],[15154,0,"Specifically, these 20 lines of code:"],[15551,0,"\n        if (newItem.seq > o.seq) break\n"],[15552,8,""],[15552,0,"      "],[15552,6,""],[15552,0,"    "],[15586,1,""],[15586,0,"\n    let oparent = findItem(doc, o.originLeft)"],[15506,46,""],[15540,0," // Optimizatin"],[15554,1,""],[15553,1,""],[15553,0,"on"],[15554,1,""],[15553,1,""],[15553,0,"ion for non-concurrent editing case"],[15556,32,""],[15556,0," only"],[15556,5,""],[15544,0,"This is just an "],[15560,1,""],[15560,0,"o"],[15572,0,".\n    "],[15574,4,""],[15544,29,""],[15544,0,"Optimization."],[15544,0,"Unnecessary "],[15556,1,""],[15556,0,"o"],[15296,29,""],[15296,0,"x"],[15298,0,"z"],[15298,1,""],[15296,1,""],[15296,0,"\n  doc.version[id[0]] = id[1]"],[15296,30,""],[15865,0,"\n  \n  doc.version[id[0]] = id[1]"],[15866,2,""],[15866,0,"\n// "],[15869,1,""],[15868,1,""],[15867,1,""],[15867,0,"  // And s"],[15876,1,""],[15876,0,"assorted bookkeeping."],[15876,0,"do "],[15879,8,""],[15879,0,"various"],[15173,3,""],[15179,8,""],[15152,0,", like this"],[15163,28,""],[15163,0,":"],[15956,0,"\n\n<video controls>\n  <source src=https://invisiblecollege.s3-us-west-1.amazonaws.com/braid-meeting-10.mp4'"],[15989,0,"'"],[16062,0,"#t-"],[16064,1,""],[16064,0,"=270"],[16069,0,"\n  </div"],[16076,1,""],[16075,1,""],[16074,1,""],[16074,0,"video>"],[16070,2,""],[16069,0,">"],[16069,0," type=video/mp4"],[15973,0," height=400"],[16076,3,""],[16076,0,"300"],[15209,1,""],[15208,1,""],[15207,1,""],[15218,1,""],[15217,1,""],[15216,1,""],[15233,1,""],[15232,1,""],[15231,1,""],[15478,13,""],[15478,0,"O"],[15152,12,""],[15152,0,". Automerge looks like this, "],[15180,1,""],[15179,1,""],[15179,0,", though there's probably"],[15187,17,""],[15187,0," the people who understand this code probably fit in a small room, so don't or"],[15264,1,""],[15263,1,""],[15263,0,"worry"],[15253,1,""],[15252,1,""],[15252,0,". "],[15254,4,""],[15254,0,"D"],[15265,0," if this looks like"],[15274,10,""],[15274,0,"makes nose "],[15284,1,""],[15283,1,""],[15282,1,""],[15282,0," sense."],[16105,78,""],[16061,70,""],[16060,1,""],[15154,25,""],[15154,0,"H"],[15154,1,""],[15154,0,"This is what it actually looks lik e"],[15189,1,""],[15188,1,""],[15188,0,"e in practice, but"],[15206,23,""],[15206,0," don't worry if it makes no sense. The"],[15244,21,""],[15244,0," set of people who do understand this code"],[15287,9,""],[15307,36,""],[15241,0,"I think "],[15249,1,""],[15249,0,"t"],[15304,0,"s"],[15304,1,""],[16845,0,". If you'"],[16853,1,""],[16853,0,"wan"],[16855,1,""],[16854,1,""],[16853,1,""],[16853,0," want to learn more, I gave a "],[16876,0,"["],[16884,0,"talk](https://invisiblecollege.s3-us-west-1.amazonaws.com/braid-meeting-10.mp4#t=300)"],[16888,0," a few weeks ago about this approach"],[17005,0,"."],[17005,1,""],[16883,0,"n informal"],[17015,0,", going into alot m"],[17033,1,""],[17032,1,""],[17031,1,""],[17030,1,""],[17029,1,""],[17029,0," lot more detail about how and *why "],[17064,1,""],[17064,0,"* CRDTs work li"],[17078,1,""],[17077,1,""],[17077,0,"this way."],[15678,10,""],[15678,0,"p"],[15451,10,""],[15451,0,"p"],[15670,0,"a"],[15452,0,"a"],[15672,0,"r"],[15453,0,"r"],[15674,0,"e"],[15454,0,"e"],[15676,0,"n"],[15455,0,"n"],[15678,0,"t"],[15456,0,"t"],[15378,4,""],[15378,0,"{}"],[15379,0,"P"],[15379,1,""],[15379,0,"parent"],[15379,0,"Id, "],[15389,0,", content"],[15379,1,""],[15379,0,"i"],[15382,0," seq,"],[15448,0,"Idx"],[15548,0,"Idx"],[15788,0,"Idx"],[15820,0,"Idx"],[15683,0,"Idx"],[15782,0,"IDx"],[15783,1,""],[15783,0,"d"],[15815,0,"Idx"],[15239,0," to you"],[15248,9,""],[15248,0,"T"],[15269,3,""],[15290,0," probably"],[15251,7,""],[15248,14,""],[15248,0,"We could probably fit everyone who"],[15293,0,"s"],[15304,13,""],[16346,27,""],[16346,0," with a few more comments"],[16690,0," "],[16690,1,""],[16664,3,""],[16664,0,"my"],[16884,1,""],[16884,0,"\n\n"],[16911,0," about all of this, and where those black magic "],[16941,18,""],[16941,0,"that black magic logic came from"],[16978,4,""],[16977,0,"gave "],[16983,1,""],[17116,0," at a braidjs meeting. In my talk I went"],[17156,8,""],[17156,0," "],[16912,62,""],[16911,1,""],[16911,0,","],[17060,0,"["],[17067,1,""],[17066,1,""],[17074,0,"](https://braid.org/)"],[17067,7,""],[17066,1,""],[17087,0," meeting"],[16921,16,""],[16921,0,"a talk"],[16927,16,""],[17069,0," a few weeks ago"],[17168,0," But"],[15384,26,""],[15383,1,""],[15382,1,""],[15368,5,""],[15326,10,""],[15326,0,"javascript"],[16313,6,""],[16313,0,", with "],[16339,1,""],[16475,8,""],[16475,0,"code"],[16475,4,""],[16475,0,"function"],[15343,18,""],[15343,0,"automergeInsert"],[16143,7,""],[17125,4,""],[16849,0,"'re interested in"],[16866,8,""],[16872,0,"ing"],[17055,82,""],[17057,0,"Bu"],[17058,1,""],[17057,1,""],[17057,0,"The important point is, "],[17081,1,""],[17081,0,"t"],[17108,5,""],[17108,0," a few"],[17114,3,""],[17079,1,""],[15307,0,"to"],[15308,1,""],[15307,1,""],[15278,0," on the planet"],[15329,0," meeting"],[15324,6,""],[15322,9,""],[15322,0,"my k"],[15325,1,""],[15325,0,"lounge"],[15331,1,""],[15331,0," "],[15325,6,""],[15325,0,"k"],[15324,2,""],[15322,2,""],[15322,0,"a meeting"],[16023,78,""],[15995,0," ..."],[15998,1,""],[15865,0,"newItem."],[15397,22,""],[15396,1,""],[15974,1,""],[15486,7,""],[15485,1,""],[15485,0,"\n  let i"],[15629,1,""],[15881,1,""],[15446,1,""],[15446,0,"\n  "],[15447,2,""],[15881,0,"\n  "],[15882,2,""],[15881,1,""],[15972,0,"\n  "],[15973,2,""],[15727,0," part"],[17032,18,""],[17450,0,"probably lots of "],[17473,4,""],[17473,0," all"],[17466,1,""],[17463,3,""],[17458,5,""],[17450,8,""],[17457,4,""],[17731,4,""],[17731,0,"Ths "],[17734,1,""],[17733,1,""],[17733,0,"is algorithm is"],[17775,141,""],[17518,0," In my reference-crdts codebase I have an implementation of both RGA (automerge) and YATA (yjs). Their performance in this test is identical.\n"],[17659,1,""],[17614,0," They share most of their code (ex"],[17647,1,""],[17647,0,"verything except this one function) and "],[17688,1,""],[17687,1,""],[17687,0,"t"],[17687,6,""],[17687,0,"their "],[17987,1,""],[17943,43,""],[15674,0," "],[15674,1,""],[15446,0," // SLOW"],[15453,1,""],[15452,1,""],[15451,1,""],[15450,1,""],[15450,0,"(slow)"],[15987,0," // (slow)"],[18986,0,"\n\nIe, the two lines I marked *"],[19015,1,""],[19015,0,"`*"],[19016,1,""],[19016,0,"(slow`"],[19021,1,""],[19021,0,")` in the code listing above."],[19835,6,""],[19835,0,"what index th"],[19847,1,""],[19846,1,""],[19846,0,"does that correspond to"],[19869,7,""],[20000,4,""],[20000,0,"I"],[20063,0,"linearly "],[21175,0," - which "],[21183,1,""],[21150,0,"linear "],[21190,0," is what we expect for "],[21209,4,""],[21209,0,"when "],[21182,32,""],[21269,11,""],[21269,0,"to"],[21278,1,""],[21277,1,""],[21276,1,""],[21343,12,""],[21343,0,"F"],[21343,1,""],[21343,0,"Changing data structures"],[21343,24,""],[21343,0,"Faster "],[21343,7,""],[21343,0,"F"],[21343,1,""],[21343,0,"Fix"],[21343,3,""],[21343,0,"Changing the data structure"],[15323,0," "],[15323,1,""],[15245,1,""],[15244,1,""],[15243,1,""],[15242,1,""],[15241,1,""],[15240,1,""],[15239,1,""],[15152,1,""],[15152,0,":"],[15154,176,""],[15153,1,""],[15153,0,"\n\n(But don't be alarmed if this makes"],[15185,5,""],[15185,0,"looks d"],[15191,1,""],[15191,0,"confusing - everyone who ca"],[15216,2,""],[15216,0,"understands this code "],[15203,35,""],[15203,0,"the peole"],[15211,1,""],[15210,1,""],[15210,0,"ple who understnad th"],[15218,13,""],[15218,0,"understand this code fit around a sm"],[15239,15,""],[15239,0,"today fit in a small meeting room.)"],[15245,0,"probably "],[16762,13,""],[16762,0,"goind e"],[16768,1,""],[16767,1,""],[16766,1,""],[16766,0,"g deeper on this"],[15203,0,"we could probably fit everyone"],[15233,10,""],[15248,0,"s"],[15265,13,""],[15234,0,"on the planet "],[15273,6,""],[15273,0," today"],[15282,0,"to"],[15421,4,""],[15421,0,"1"],[15959,4,""],[15959,0,"2"],[18915,0,"(&*"],[18917,1,""],[18916,1,""],[18915,1,""],[18915,0," (*1)"],[18919,1,""],[18918,1,""],[18917,1,""],[18916,1,""],[18915,1,""],[18959,17,""],[18959,0,"These are thw "],[18972,1,""],[18971,1,""],[18971,0,"e"],[18959,14,""],[18959,0,"These are the linkes"],[18959,64,""],[18959,0,"(These linesa re"],[18974,1,""],[18973,1,""],[18972,1,""],[18971,1,""],[18971,0," are marked (1) and (2) in the code listing above)."],[18983,0,"*"],[18987,0,"*"],[18996,0,"*"],[18993,0,"*"],[19028,0,"To understand why these lines are en"],[19063,1,""],[19062,1,""],[19046,16,""],[19046,0,"this is needed, "],[19062,1,""],[19062,0,"l"],[19051,0,"code "],[19058,7,""],[19058,0," necessary"],[19422,0,"Note, "],[19428,1,""],[19428,0,"s"],[19471,1,""],[19471,0,"."],[19473,3,""],[19422,4,""],[19422,0,"And"],[19425,1,""],[19522,0,"(Unfortunately "],[19537,1,""],[19537,0,"w"],[19403,1,""],[19402,1,""],[19402,0,"'seph', 1"],[20041,0,"So "],[20044,1,""],[20044,0,"i"],[21382,0,"\n\n"],[21383,0,"Why does the graph have this shape? Here's the "],[21396,5,""],[21396,0,"chart"],[21430,0,"graph of the e"],[21443,1,""],[21443,0,"ins"],[21443,3,""],[21443,0,"edit position for every change"],[21467,6,""],[21466,1,""],[21465,1,""],[21465,0,"y keyt"],[21470,1,""],[21470,0,"stroke."],[21476,1,""],[21476,0,", with the same averaging "],[21492,10,""],[21492,0,"bucketing and smoothing applied:"],[21525,0,"\n![reference crdts implementation zoomed in](ref_perf3.svg)"],[21570,9,""],[21570,0,"inspos"],[21528,40,""],[21528,0,"Editin"],[21533,1,""],[21532,1,""],[21532,0," position throughout document "],[21561,1,""],[21417,0," in particular"],[21392,3,""],[21392,0,"this"],[21434,0,"If we "],[21440,11,""],[21445,7,""],[21445,0," where"],[21452,0,"each "],[21461,29,""],[21461,0," happened throguhout"],[21471,10,""],[21471,0,"throughout the editing trace"],[21500,0," and use"],[21508,5,""],[21542,7,""],[21541,1,""],[21541,0,", the reusl"],[21551,1,""],[21550,1,""],[21549,1,""],[21549,0,"sult is remarkably familiar"],[21433,0," Thats "],[21433,7,""],[20241,23,""],[20241,0,", which "],[20248,1,""],[20242,6,""],[20241,1,""],[20241,0,", which is double yikes"],[20573,23,""],[20575,0," is actually super fast at this, so maybe its not"],[20624,8,""],[20624,0," using an"],[20650,0,"?"],[20651,49,""],[20651,0," Who knows!"],[20650,0," to implement an arra"],[20664,7,""],[20664,0,"Arras"],[20668,1,""],[20668,0,"ys"],[20588,0,"suspiciously "],[20601,6,""],[20613,0," part"],[20629,3,""],[20629,0,"v8 isn't"],[20637,4,""],[20698,0,"But the general rule is, "],[20723,1,""],[20723,0,"i"],[20702,0,"in fe"],[20706,1,""],[20705,1,""],[20705,0,"general"],[20712,19,""],[20773,0,"about "],[20976,32,""],[20975,1,""],[20974,1,""],[20974,0,"."],[20976,1,""],[20976,0,"I"],[21112,0,"The time taken to perform each insert looks "],[21155,1,""],[21155,0," like this. "],[21166,1,""],[21165,1,""],[21165,0,":"],[21166,221,""],[20959,15,""],[20959,0,"is reasonably fast, but"],[20981,2,""],[20981,0,"t"],[20983,1,""],[20983,0,"i"],[20983,1,""],[20983,0,"i"],[21172,1,""],[21119,53,""],[21119,0,"There's a lot going on here because inserts happened all over the document"],[21155,38,""],[21155,0,"Martin's editign ps"],[21173,1,""],[21172,1,""],[21171,1,""],[21170,1,""],[21169,1,""],[21169,0,"ng position bounced around the docuen"],[21205,1,""],[21204,1,""],[21204,0,"ment. But there's a l"],[21224,1,""],[21224,0,"strong linear trend up and to thr "],[21257,1,""],[21256,1,""],[21256,0,"e right, which is what we would expect for a"],[21299,1,""],[21298,1,""],[21297,1,""],[21296,1,""],[21295,1,""],[21295,0,"when each insert takes ("],[21318,1,""],[21318,0,"O(n) time ."],[21328,1,""],[21327,1,""],[21327,0,"."],[21318,0,"*"],[21323,0,"*"],[21300,5,""],[21306,0,"s"],[21312,1,""],[21324,1,""],[21324,0,":"],[21396,0,"performance get better near the end? And why"],[21440,15,""],[21472,0," simply"],[21486,0,"*"],[21492,0,"*"],[21543,3,""],[21543,0,"with"],[21547,4,""],[21433,33,""],[21432,1,""],[21387,0,"And why this shape in particular? And "],[21425,1,""],[21425,0,"w"],[21600,11,""],[21600,0,"eerily "],[38425,16,""],[38425,0,"are junk food for your inu"],[38450,1,""],[38450,0,"tuition"],[38404,9,""],[38404,0,"But"],[38453,0,"Remember, "],[38463,1,""],[38463,0,"w"],[38453,11,""],[38453,0,"W"],[38482,0,"still "],[21586,20,""],[21586,0,"we end up with the same cur"],[21601,12,""],[21601,0,"a very"],[21616,0," curve"],[39064,0," How we implement our alog"],[39089,1,""],[39088,1,""],[39088,0,"gorithms mat"],[39082,18,""],[39082,0,"things matters, "],[39097,1,""],[39096,1,""],[39096,0,"."],[39082,15,""],[39082,0,"our algorithms matters."],[39064,41,""],[39064,0," How we implement our algorithms matters."],[39064,1,""],[39064,0,"\n\n"],[39066,42,""],[38850,0," if we get creative with implementation"],[38875,0,"our "],[38893,0," strategies"],[38906,0,"With the right approach, "],[38931,1,""],[38931,0,"w"],[38942,0," CRDTs"],[38948,9,""],[38957,0,"that "],[38460,0,"The same data on "],[38477,4,""],[38476,1,""],[38474,2,""],[38474,0,"with"],[38494,15,""],[38411,5,""],[38411,0,"L"],[38469,5,""],[38469,0," on"],[38647,0,"some "],[39681,32,""],[39680,1,""],[39670,0,", no matter how "],[39682,4,""],[39682,0,"the e"],[39686,1,""],[39686,0,"teasing from my friends,"],[39693,0," I get"],[9982,6,""],[9982,0,"was using"],[9972,9,""],[9968,4,""],[9968,0,"nodejs"],[9998,1,""],[9998,0,"!"],[9979,6,""],[9979,0,"sitting on "],[9968,21,""],[9968,0,"tho"],[9970,1,""],[9970,0,"is code was using"],[9968,9,""],[9968,0,"automerge"],[10071,0,"["],[10082,0," benchmark](https://gist.github.com/josephg/13efc1444660c07870fcbd0b3e917638#file-js_baseline-js)"],[10267,3,""],[10267,0,"all the"],[10371,3,""],[10371,0,"is caa"],[10376,1,""],[10376,0,"pable of going"],[10390,3,""],[21788,0,"\n"],[21788,0,"\nThis te"],[21789,7,""],[21789,0,"So editing performance is dominated"],[21792,0,"the time spent applying changes"],[21823,19,""],[21836,0," by the time spent scanning f"],[21864,1,""],[21863,1,""],[21863,0," our document array."],[21864,3,""],[21864,0,"the"],[21876,0,"'s item"],[21879,5,""],[21836,0," (1) -"],[21842,3,""],[21841,1,""],[21840,1,""],[21839,1,""],[21838,1,""],[21837,1,""],[21836,1,""],[21836,0," by"],[21849,5,""],[21849,0,"it takes to"],[21868,1,""],[21867,1,""],[21866,1,""],[21865,1,""],[21865,0," through"],[21700,14,""],[21700,0,"the result is"],[21710,3,""],[21710,0," is"],[18801,17,""],[18801,0,"Death by 1000 scans"],[21790,6,""],[21790,0,"It looks like the"],[21907,0," Edits at the end of the document are much slower than edits at the start "],[21907,74,""],[1008,4,""],[1008,0,"like"],[1286,0," Operational Transformation"],[1299,1,""],[1299,0,"o"],[1299,1,""],[1299,0,"t"],[1287,1,""],[1287,0,"p"],[1287,1,""],[1287,0,"o"],[1774,0," that"],[2267,1,""],[2266,1,""],[2266,0," are"],[2305,0," black-box"],[2331,29,""],[2331,0,"concurrent end"],[2344,1,""],[2343,1,""],[2343,0,"dits"],[2354,10,""],[2354,0,"twp cli"],[2360,1,""],[2359,1,""],[2358,1,""],[2357,1,""],[2356,1,""],[2356,0,"o clients"],[2370,1,""],[2370,0," the same region of text at the e"],[2402,1,""],[2402,0,"same time,"],[2412,45,""],[2427,57,""],[2427,0,"Are they merged? Do they conflict"],[2444,0,"How? "],[2442,7,""],[2442,0,", or do the"],[2442,11,""],[2442,0,"? "],[2460,0,"? "],[2461,1,""],[2461,0," What are the rules?"],[2442,0,", na"],[2445,1,""],[2444,1,""],[2444,0,"and if so in what order"],[2469,18,""],[2495,0," white-box"],[2522,0," of the system"],[2542,0," programming"],[2609,29,""],[2609,0,"does it perform in different editing"],[2637,8,""],[2627,10,""],[2624,3,""],[2616,8,""],[2613,3,""],[2609,4,""],[2609,0,"optimized is it, and for what"],[2621,3,""],[2621,0," the code"],[2630,24,""],[2744,0,"*"],[2753,0,"*"],[2770,0,"*"],[2776,0,"*"],[2802,0,"Likewise "],[2811,1,""],[2811,0,"a"],[2811,4,""],[2833,0,"*"],[2842,0,"*"],[2859,0,"*"],[2865,0,"*"],[2872,11,""],[2872,0,"all"],[2872,3,""],[2872,0,"every implementation"],[2897,7,""],[2893,0," o"],[2894,1,""],[2893,1,""],[2893,0,"of the system "],[2921,48,""],[2921,0,"No mate"],[2927,1,""],[2927,0,"ter "],[2921,10,""],[2920,7,""],[2801,0," But no m"],[2802,8,""],[2802,0,"No matter how many tests you write, there are a"],[2838,11,""],[2838,0,"given enough time someone usually finds anohter"],[2878,7,""],[2878,0,"more bugs. And"],[2888,4,""],[2882,6,""],[2878,4,""],[2878,0,"anohter"],[2877,8,""],[2871,6,""],[2863,8,""],[2855,8,""],[2850,5,""],[2843,7,""],[2838,5,""],[2838,0,"there are a"],[2847,2,""],[2843,4,""],[2837,6,""],[2830,7,""],[2826,4,""],[2820,6,""],[2815,5,""],[2811,4,""],[2804,7,""],[2802,2,""],[2802,0,"But no m"],[2808,2,""],[2805,3,""],[2801,4,""],[2920,0," bugs."],[2920,0," No matter "],[2930,1,""],[2927,3,""],[2927,0,"e"],[2923,5,""],[2921,2,""],[2921,0,"If you wait long enough, somebody will find more"],[3006,12,""],[3006,0,"can design a"],[4284,9,""],[4284,0,"b"],[3152,9,""],[3152,0,"b"],[2317,9,""],[2317,0,"b"],[4269,0,"e"],[3145,0,"e"],[2318,0,"e"],[4272,0,"h"],[3147,0,"h"],[2319,0,"h"],[4275,0,"a"],[3149,0,"a"],[2320,0,"a"],[4278,0,"v"],[3151,0,"v"],[2321,0,"v"],[4281,0,"i"],[3153,0,"i"],[2322,0,"i"],[4284,0,"o"],[3155,0,"o"],[2323,0,"o"],[4287,0,"u"],[3157,0,"u"],[2324,0,"u"],[4290,0,"r"],[3159,0,"r"],[2325,0,"r"],[4284,9,""],[4284,0,"semantics"],[3152,9,""],[3152,0,"semantics"],[2317,9,""],[2317,0,"semantics"],[4284,9,""],[4284,0,"b"],[3152,9,""],[3152,0,"b"],[2317,9,""],[2317,0,"b"],[4269,0,"e"],[3145,0,"e"],[2318,0,"e"],[4272,0,"h"],[3147,0,"h"],[2319,0,"h"],[4275,0,"a"],[3149,0,"a"],[2320,0,"a"],[4278,0,"v"],[3151,0,"v"],[2321,0,"v"],[4281,0,"i"],[3153,0,"i"],[2322,0,"i"],[4284,0,"o"],[3155,0,"o"],[2323,0,"o"],[4287,0,"u"],[3157,0,"u"],[2324,0,"u"],[4290,0,"r"],[3159,0,"r"],[2325,0,"r"],[2833,1,""],[2841,1,""],[2857,1,""],[2862,1,""],[4770,0,"Thats "],[4789,1,""],[4789,0,"."],[4791,7,""],[4791,0,"N"],[4790,1,""],[4789,1,""],[4789,0,", which is "],[4800,1,""],[4800,0,"n"],[7598,1,""],[7630,1,""],[8175,9,""],[8175,0,"hebavi"],[8175,6,""],[8175,0,"behaviour"],[8186,3,""],[8186,0,"is defined by this algorithm"],[8261,1,""],[8855,0,")"],[25190,11,""],[25190,0,"P"],[18561,11,""],[18561,0,"P"],[10744,11,""],[10744,0,"P"],[25171,0,"l"],[18552,0,"l"],[10745,0,"l"],[25174,0,"a"],[18554,0,"a"],[10746,0,"a"],[25177,0,"i"],[18556,0,"i"],[10747,0,"i"],[25180,0,"n"],[18558,0,"n"],[10748,0,"n"],[25183,0," "],[18560,0," "],[10749,0," "],[25186,0,"s"],[18562,0,"s"],[10750,0,"s"],[25189,0,"t"],[18564,0,"t"],[10751,0,"t"],[25192,0,"r"],[18566,0,"r"],[10752,0,"r"],[25195,0,"i"],[18568,0,"i"],[10753,0,"i"],[25198,0,"n"],[18570,0,"n"],[10754,0,"n"],[25201,0,"g"],[18572,0,"g"],[10755,0,"g"],[25204,0," "],[18574,0," "],[10756,0," "],[25207,0,"e"],[18576,0,"e"],[10757,0,"e"],[25210,0,"d"],[18578,0,"d"],[10758,0,"d"],[25213,0,"i"],[18580,0,"i"],[10759,0,"i"],[25216,0,"t"],[18582,0,"t"],[10760,0,"t"],[25219,0,"s"],[18584,0,"s"],[10761,0,"s"],[25222,0," "],[18586,0," "],[10762,0," "],[25225,0,"i"],[18588,0,"i"],[10763,0,"i"],[25228,0,"n"],[18590,0,"n"],[10764,0,"n"],[25231,0," "],[18592,0," "],[10765,0," "],[25234,0,"J"],[18594,0,"J"],[10766,0,"J"],[25237,0,"S"],[18596,0,"S"],[10767,0,"S"],[25240,1,""],[18598,1,""],[10768,1,""],[25238,1,""],[18597,1,""],[10768,1,""],[25236,1,""],[18596,1,""],[10768,1,""],[25234,1,""],[18595,1,""],[10768,1,""],[25232,1,""],[18594,1,""],[10768,1,""],[25230,1,""],[18593,1,""],[10768,1,""],[25228,1,""],[18592,1,""],[10768,1,""],[25226,1,""],[18591,1,""],[10768,1,""],[25224,1,""],[18590,1,""],[10768,1,""],[25222,1,""],[18589,1,""],[10768,1,""],[25220,1,""],[18588,1,""],[10768,1,""],[25218,1,""],[18587,1,""],[10768,1,""],[25216,1,""],[18586,1,""],[10768,1,""],[17821,3,""],[17821,0,"Y"],[16853,3,""],[16853,0,"Y"],[16579,3,""],[16579,0,"Y"],[17818,0,"j"],[16852,0,"j"],[16580,0,"j"],[17821,0,"s"],[16854,0,"s"],[16581,0,"s"],[18525,3,""],[18525,0,"Yjs"],[25093,3,""],[25093,0,"Yjs"],[25902,3,""],[25902,0,"Y"],[25763,3,""],[25763,0,"Y"],[25696,3,""],[25696,0,"Y"],[25625,3,""],[25625,0,"Y"],[25466,3,""],[25466,0,"Y"],[25315,3,""],[25315,0,"Y"],[25893,0,"j"],[25756,0,"j"],[25691,0,"j"],[25622,0,"j"],[25465,0,"j"],[25316,0,"j"],[25899,0,"s"],[25761,0,"s"],[25695,0,"s"],[25625,0,"s"],[25467,0,"s"],[25317,0,"s"],[28925,1,""],[28925,0,"Y"],[29951,1,""],[29951,0,"Y"],[32737,0,"Y"],[32737,1,""],[32736,1,""],[32736,0,"Y"],[34155,3,""],[34155,0,"Y"],[33481,3,""],[33481,0,"Y"],[34154,0,"j"],[33482,0,"j"],[34156,0,"s"],[33483,0,"s"],[36906,0,"Yjs"],[36909,3,""],[44141,3,""],[44141,0,"Y"],[43164,3,""],[43164,0,"Y"],[42664,3,""],[42664,0,"Y"],[42601,3,""],[42601,0,"Y"],[42507,3,""],[42507,0,"Y"],[42405,3,""],[42405,0,"Y"],[44132,0,"j"],[43157,0,"j"],[42659,0,"j"],[42598,0,"j"],[42506,0,"j"],[42406,0,"j"],[44138,0,"s"],[43162,0,"s"],[42663,0,"s"],[42601,0,"s"],[42508,0,"s"],[42407,0,"s"],[46529,3,""],[46529,0,"Y"],[46463,3,""],[46463,0,"Y"],[46276,3,""],[46276,0,"Y"],[45730,3,""],[45730,0,"Y"],[46524,0,"j"],[46460,0,"j"],[46275,0,"j"],[45731,0,"j"],[46528,0,"s"],[46463,0,"s"],[46277,0,"s"],[45732,0,"s"],[46813,1,""],[46813,0,"Y"],[48288,3,""],[48288,0,"Y"],[47220,3,""],[47220,0,"Y"],[48287,0,"j"],[47221,0,"j"],[48289,0,"s"],[47222,0,"s"],[49416,3,""],[49416,0,"Yjs"],[51403,3,""],[51403,0,"Yjs"],[51521,3,""],[51521,0,"Y"],[51417,3,""],[51417,0,"Y"],[51520,0,"j"],[51418,0,"j"],[51522,0,"s"],[51419,0,"s"],[27509,0,"\n\n> And yes, I know, V9"],[27531,1,""],[27531,0,"8 d"],[27533,1,""],[27533,0,"tries its harr"],[27546,1,""],[27546,0,"dest to prevent this. But its not magic."],[27580,0,"made of "],[27566,0," sor t"],[27571,1,""],[27570,1,""],[27570,0,"t o fthi"],[27577,1,""],[27576,1,""],[27575,1,""],[27574,1,""],[27573,1,""],[27573,0,"f thing when it can"],[27606,8,""],[40084,0,"h"],[44228,0,"plain "],[44240,0," editing"],[47358,9,""],[47358,0,"b"],[46602,9,""],[46602,0,"b"],[46413,9,""],[46413,0,"b"],[46026,9,""],[46026,0,"b"],[45940,9,""],[45940,0,"b"],[47327,0,"e"],[46579,0,"e"],[46398,0,"e"],[46019,0,"e"],[45941,0,"e"],[47332,0,"h"],[46583,0,"h"],[46401,0,"h"],[46021,0,"h"],[45942,0,"h"],[47337,0,"a"],[46587,0,"a"],[46404,0,"a"],[46023,0,"a"],[45943,0,"a"],[47342,0,"v"],[46591,0,"v"],[46407,0,"v"],[46025,0,"v"],[45944,0,"v"],[47347,0,"i"],[46595,0,"i"],[46410,0,"i"],[46027,0,"i"],[45945,0,"i"],[47352,0,"o"],[46599,0,"o"],[46413,0,"o"],[46029,0,"o"],[45946,0,"o"],[47357,0,"u"],[46603,0,"u"],[46416,0,"u"],[46031,0,"u"],[45947,0,"u"],[47362,0,"r"],[46607,0,"r"],[46419,0,"r"],[46033,0,"r"],[45948,0,"r"],[45940,0,"merging "],[45940,0,"concurrent "],[46246,5,""],[46246,0," it"],[46618,0,"'s"],[30073,6,""],[30073,0,"range tree"],[30073,0,"["],[30084,0,"](https://en.wikipedia.org/wiki/Range_tree)"],[30190,0," "],[30190,1,""],[30190,0," "],[30190,1,""],[30192,0,"A "],[30193,1,""],[30192,1,""],[30192,0,"My range"],[30192,8,""],[30192,0,"And "],[30192,4,""],[30192,0,"I'm "],[30194,2,""],[30193,1,""],[30192,1,""],[30190,0," Inter"],[30191,5,""],[30191,0,"The range tree internl"],[30212,1,""],[30212,0,"ally uses a "],[30191,33,""],[30190,1,""],[30192,0,"The range tree is really"],[30192,24,""],[30192,0,"Under the hood, my range tree s "],[30223,1,""],[30222,1,""],[30222,0,"is acutall"],[30231,1,""],[30230,1,""],[30229,1,""],[30228,1,""],[30227,1,""],[30227,0,"ually j"],[30225,9,""],[30225,0,"actually just a b-tree. But "],[30253,1,""],[30253,0,"u"],[30241,0,"slightly modified "],[30266,4,""],[30267,1,""],[30267,0,"But u"],[30816,163,""],[30815,1,""],[30815,0,"\n> Does this have a name? I've been calling it a \"range tree\", but I think that name is [taken by another data structure](https://en.wikipedia.org/wiki/Range_tree)\n"],[30818,160,""],[30818,0,"I'm sure I didn't"],[30818,17,""],[30818,0,"I k"],[30820,1,""],[30819,1,""],[30818,1,""],[30818,0,"That wikipedia ari"],[30835,1,""],[30835,0,"ticle "],[30818,0,"This is a range tree, right? "],[30870,0,"its pretty"],[30870,0,"on range trees "],[30885,10,""],[30885,0,"is a pretty poor mat"],[30904,1,""],[30903,1,""],[30902,1,""],[30902,0,"description of what I'm doing here."],[30847,4,""],[30847,0,"The"],[30851,0,"["],[30884,0,"](https://en.wikipedia.org/wiki/Range_tree)"],[30940,4,""],[30940,0,"bad"],[30940,3,""],[30940,0,"weak"],[31295,1,""],[31295,0,"4"],[31377,1,""],[31377,0,"4"],[31632,1,""],[31632,0,"4"],[24677,0,"62"],[24678,1,""],[24677,1,""],[24676,1,""],[24675,1,""],[24675,0,"62"],[24653,0," by 3x,"],[24661,1,""],[24660,1,""],[24659,1,""],[24659,0,". ("],[24662,4,""],[24680,0,"k down to "],[24690,5,""],[24689,1,""],[24688,1,""],[24687,1,""],[24686,1,""],[24686,0," from 180"],[24694,1,""],[24693,1,""],[24692,1,""],[24691,1,""],[24690,1,""],[24689,1,""],[24688,1,""],[24687,1,""],[24686,1,""],[24685,1,""],[24684,1,""],[24683,1,""],[24682,1,""],[24681,1,""],[24666,3,""],[24665,1,""],[24665,0,"k down"],[24671,5,""],[24678,0,")."],[24667,0,"entries "],[33817,11,""],[33817,0,"Plain string edits in JS"],[33842,21,""],[33842,0,"        "],[25196,0,"*"],[18561,0,"*"],[10744,0,"*"],[25223,0,"*"],[18587,0,"*"],[10769,0,"*"],[25226,1,""],[18589,1,""],[10770,1,""],[25224,1,""],[18588,1,""],[10770,1,""],[37276,11,""],[37276,0,"Plain string edits in JS"],[37301,21,""],[37301,0,"        "],[34360,0,"![rust implementation in wasm vs Yjs](rust_perf6.svg)\n"],[34413,0,"\n"],[34462,1,""],[34462,0,"7"],[37541,1,""],[33993,1,""],[37539,1,""],[33992,1,""],[37537,1,""],[33991,1,""],[37536,0,"1"],[33991,0,"1"],[37538,0,"."],[33992,0,"."],[37540,0,"1"],[33993,0,"1"],[33368,2,""],[33368,0,"56"],[33392,0," over"],[33398,4,""],[33398,0,"1"],[33398,1,""],[33398,0,"5000"],[33466,1,""],[33466,0,"5"],[33466,1,""],[33466,0,"6"],[32935,0,"under "],[33929,1,""],[33928,1,""],[33928,0,"12"],[33929,1,""],[33929,0,"0"],[33929,1,""],[33929,0,"9"],[32930,14,""],[32930,0,"193"],[29972,42,""],[29972,0,"https://github.com/josephg/diamond-types"],[29970,0," a"],[29971,1,""],[29970,1,""],[29940,1,""],[29969,0," called D"],[29977,1,""],[29977,0,"[Diamond types"],[29978,1,""],[29978,0,"d"],[29978,1,""],[29978,0,"D"],[30036,19,""],[30036,0,"Diamond"],[30237,9,""],[32371,4,""],[32377,0," in an array"],[32389,9,""],[32382,1,""],[32382,0," fixed size"],[32411,16,""],[32411,0,"T"],[32411,1,""],[32411,0,"Inserting like t"],[32421,4,""],[32421,0,"with a structure like"],[32447,5,""],[32454,0,"s"],[32459,4,""],[32459,0,"a little bit of"],[32675,0,"And "],[32679,1,""],[32679,0,"w"],[32772,7,""],[32772,0,"reasonably "],[32634,10,""],[32665,0,"\n"],[32200,465,""],[32200,0,"Rust gives us total control over the memory layout, so we can pack everything in tightly. Unlike in the diagram, each leaf node in my b-tree stores a block of 32 entries, packed in a fixed size array in memory. Inserting with a structure like this results in a little bit of memcpy-ing, but a little bit of memcpy is fine. Memcpy is always faster than I think it will be - CPUs can copy several bytes per clock cycle. Its not the epic hunt of a main memory lookup."],[32665,0,"\n"],[32665,1,""],[32664,1,""],[32664,0,"\n\n"],[32779,0," I don't know "],[32779,14,""],[32666,0,"("],[32780,0,")"],[32666,1,""],[32779,1,""],[32779,0," I have no idea why thats "],[32780,25,""],[32779,1,""],[32778,1,""],[32778,0," on my computer."],[32785,8,""],[32785,0,"hardware"],[32774,4,""],[32774,0,"fast"],[31299,1,""],[31299,0,"3"],[31381,1,""],[31381,0,"3"],[31636,1,""],[31636,0,"3"],[33242,102,""],[33242,0,"https://github.com/josephg/diamond-types/blob/yjs-style/benches/yjs.rs"],[33165,0,"It gets even faster if we "],[33191,19,""],[33191,0,"skip wasm and "],[33165,21,""],[33165,0,"I"],[33180,0," and run this"],[33193,4,""],[33204,0," "],[33204,1,""],[33204,0,"th"],[33205,1,""],[33204,1,""],[33204,3,""],[33210,0,"ly"],[33212,9,""],[33214,26,""],[33213,1,""],[33212,1,""],[33204,0,"["],[33165,0,"It gets even faster "],[33185,1,""],[33185,0,"i"],[33196,0,"javascript and "],[33224,4,""],[33224,0,"the"],[33320,1,""],[33320,0,". Like t"],[33322,6,""],[33322,0,"Running natively"],[33247,0," through rust"],[33168,4,""],[33168,0,"goes"],[33215,0,"."],[33217,21,""],[33217,0,"The benchmark "],[33221,10,""],[33221,0,"same benchmark ported"],[33244,21,""],[33244,0,"to rust"],[33243,1,""],[33236,0,"["],[33324,21,""],[175,5,""],[175,0,"5000x"],[137,50,""],[131,0,"5000x faster "],[150,0,":"],[150,1,""],[149,1,""],[149,0,": A case study in optimization"],[131,13,""],[136,0," that go 5000 "],[149,1,""],[149,0,"x faster"],[131,0,"Making "],[143,8,""],[143,0," go"],[162,14,""],[162,0,"n"],[176,0," "],[176,1,""],[176,0," adventure"],[131,6,""],[131,0,"How I made a"],[148,4,""],[143,1,""],[142,1,""],[146,0,"s go"],[168,13,""],[131,4,""],[173,0," in optimization"],[9,54,""],[4639,0,"["],[4658,0,"](https://github.com/josephg/diamond-types)"],[4746,1,""],[4745,1,""],[4745,0,"54"],[4746,1,""],[4746,0,"6"],[4746,1,""],[4746,0,"4"],[4745,2,""],[4745,0,"65"],[4745,2,""],[4745,0,"54"],[4746,1,""],[4746,0,"6"],[4772,1,""],[4771,1,""],[4771,0,"45"],[4772,1,""],[4771,1,""],[4771,0,"56"],[4791,7,""],[4791,0," over"],[10703,1,""],[10702,1,""],[10701,1,""],[10700,1,""],[24670,1,""],[24669,1,""],[24669,0,"12"],[24643,1,""],[24643,0,"14"],[32672,0," I have no idea."],[32717,3,""],[32717,0,"bunch of"],[32756,0,"just "],[32768,18,""],[32756,12,""],[32756,0,"seemed "],[32762,1,""],[32756,7,""],[32756,0,"happened to be "],[32756,35,""],[32756,0,"ran the fastest."],[32673,16,""],[32756,0," I have no idea. "],[32772,1,""],[32771,1,""],[32771,0," why thats the best"],[32780,10,""],[32780,0," worked out to be the best."],[32743,4,""],[32750,1,""],[32749,1,""],[32748,1,""],[32740,8,""],[32740,0,"worked well"],[32851,0,"["],[32884,0,"](https://github.com/josephg/diamond-js)"],[33215,21,""],[33215,0,"I"],[33215,0,"Javascript and WASM is now a bottleneck. "],[33266,20,""],[33266,0," all that and run"],[33283,5,""],[33283,0," the"],[33320,70,""],[33320,0,"https://github.com/josephg/diamond-types/blob/42a8bc8fb4d44671147ccaf341eee18d77b2d532/benches/yjs.rs"],[33267,8,""],[33267,0,"javascd"],[33273,1,""],[33273,0,"ript"],[33289,5,""],[33301,9,""],[33301,0,"directly in rust"],[33426,0,", we"],[33443,3,""],[33443,0,"the"],[33443,3,""],[33443,0,"all"],[34463,4,""],[34463,0,"1394"],[34457,6,""],[34457,0,"results in "],[34599,0," -->"],[34546,0,"<!-- "],[34604,4,""],[34546,5,""],[34545,0,"\n"],[34545,0,"\nHm, lets zoom in a bit there and just "],[34546,8,""],[34546,0,"Oh, its so fast you can barely see it next to yjs ("],[34596,1,""],[34596,0,"*fleexxxx*. Lets"],[34636,6,""],[34635,1,""],[34634,1,""],[34633,1,""],[34633,0,"and bask in that flat line:"],[34549,0," what a pity."],[34563,1,""],[34563,0,"I"],[34570,0,"consistently "],[34622,0,"("],[34633,0,")"],[34719,7,""],[34687,1,""],[34687,0,":"],[34687,1,""],[34687,0,":"],[34736,0,"\n\nWell, nearly flat line. I have no idea what the jitteryness is "],[34800,1,""],[34797,3,""],[34777,4,""],[34777,0,"why its a bit"],[34790,4,""],[34801,1,""],[34800,1,""],[34799,1,""],[34798,1,""],[34798,0,"."],[34798,1,""],[34798,0," - though the s"],[34798,15,""],[34798,0,". Its probab"],[34800,10,""],[34800,0,"Maybe deletes are faster than inserts or something."],[34818,0,"slightly "],[34818,9,""],[34818,0,"marginally "],[34861,1,""],[34861,0,", so we're seeing the insert / delete ratio aga"],[34907,1,""],[34906,1,""],[34905,1,""],[34904,1,""],[34904,0,"."],[34904,0," pop out of the timing data"],[34849,12,""],[34848,1,""],[35140,1,""],[35140,0,"~4"],[35151,9,""],[35151,0,"again"],[34762,24,""],[34762,0,"I wonder if the"],[34777,4,""],[34785,0,"ness"],[34789,1,""],[34789,0," shows"],[34790,5,""],[34790,0,"is showing"],[34800,6,""],[34793,8,""],[34835,0," or something?"],[34849,71,""],[34744,0,"a "],[34737,114,""],[34736,1,""],[34736,0,"\n\nWell, a nearly flat line. I wonder if the jitteryness is deletes are marginally faster than inserts or something?"],[34773,78,""],[34773,0,"what that k"],[34783,1,""],[34783,0,"jitteryness is about?"],[34803,1,""],[34803,0,"..?"],[34808,0,"And remember ,this is"],[34820,1,""],[34821,0," "],[34829,0," "],[34830,9,""],[34866,14,""],[34880,10,""],[34880,0,"nodejs"],[34889,7,""],[34808,15,""],[34808,0,"T"],[34917,4,""],[34917,0," So"],[34943,0,"*"],[34948,0,"*"],[34959,4,""],[34959,0,"If"],[34994,0,"s"],[34996,4,""],[34996,0,"another"],[35083,7,""],[35092,0,"("],[35104,0,")"],[35121,0," that much"],[35156,0," memory"],[35197,16,""],[35197,0,"Eh, I "],[35196,60,""],[35198,131,""],[36323,0," "],[37654,1,""],[34108,1,""],[37652,1,""],[34107,1,""],[37651,0,"5"],[34107,0,"5"],[37653,0,"6"],[34108,0,"6"],[37825,1,""],[37824,1,""],[37823,1,""],[37823,0,"1.1"],[38175,374,""],[38174,0,"\n---\n"],[38715,43,""],[38715,0,":"],[38758,0,"But "],[38762,1,""],[38762,0,"l"],[38807,15,""],[38807,0,"O"],[38824,0," the data"],[44423,14,""],[44423,0,"diamond-types"],[44455,87,""],[44455,0,"https://github.com/josephg/diamond-types/tree/42a8bc8fb4d44671147ccaf341eee18d77b2d532"],[44566,0," RUSTFLAGS='-C target-cpu=native' "],[44620,70,""],[44694,0,"["],[44742,0,"](https://github.com/josephg/diamond-types/blob/42a8bc8fb4d44671147ccaf341eee18d77b2d532/src/list/doc.rs#L15)"],[44726,9,""],[44726,0,"list"],[44856,8,""],[44856,0,"look at memory statistics by running"],[44894,19,""],[44894,0,"cargo run --release --features memusage --example stats"],[44950,60,""],[44951,199,""],[45411,20,""],[45411,0,"M"],[45446,0,"\nMy rust crdt wasm wrapper anywhere."],[45446,36,""],[45446,0,"\n"],[45410,1,""],[45445,0,"\nThe charts were made on [ObservableHQ](https://observablehq.com/@josephg/crdt-algorithm-performance-benchmarks)."],[45297,113,""],[45332,0,"\n"],[45296,1,""],[45331,0,"\nYou'll also need `automerge-paper.json.gz` from [josephg/crdt-benchmarks](https://github.com/josephg/crdt-benchmarks) in order to run most of these tests. The reference-crdts benchmark depends on [crdts.ts from josephg/reference-crdts, at this version](https://github.com/josephg/reference-crdts/tree/fed747255df9d457e11f36575de555b39f07e909)"],[44953,343,""],[44988,0,"\n"],[44952,1,""],[44987,0,"\nFor my rust implementation results come from benchmarking [josephg/diamond-types, at this version](https://github.com/josephg/diamond-types/tree/42a8bc8fb4d44671147ccaf341eee18d77b2d532). Benchmark by running ` RUSTFLAGS='-C target-cpu=native' cargo criterion yjs`. The inline rope structure updates can be enabled or disabled by editing [the constant at the top of src/list/doc.rs](https://github.com/josephg/diamond-types/blob/42a8bc8fb4d44671147ccaf341eee18d77b2d532/src/list/doc.rs#L15). You can look at memory statistics by running `cargo run --release --features memusage --example stats`."],[44356,596,""],[44391,0,"\n"],[44355,1,""],[44390,1,""],[44355,0,"\n"],[44391,596,""],[44356,0,"For my rust implementation results come from benchmarking [josephg/diamond-types, at this version](https://github.com/josephg/diamond-types/tree/42a8bc8fb4d44671147ccaf341eee18d77b2d532). Benchmark by running ` RUSTFLAGS='-C target-cpu=native' cargo criterion yjs`. The inline rope structure updates can be enabled or disabled by editing [the constant at the top of src/list/doc.rs](https://github.com/josephg/diamond-types/blob/42a8bc8fb4d44671147ccaf341eee18d77b2d532/src/list/doc.rs#L15). You can look at memory statistics by running `cargo run --release --features memusage --example stats`.\n"],[44987,1,""],[44952,0,"\n"],[44988,0,"\n"],[44956,4,""],[44956,0,"diamond"],[44963,5,""],[44356,34,""],[44356,0,"My diamond benchmarking result"],[44386,23,""],[44386,0,"s were generated from"],[44356,51,""],[44356,0,"Diamond's benchmarks come from this repo"],[44386,10,""],[44926,33,""],[44926,0,"[This repository](https://github.com/josephg/diamond-js/tree/6e8a95670b651c0aaa7701a1a763778d3a486b0c) contains d"],[45038,1,""],[45038,0,"the diamond-js wrapp"],[45042,16,""],[45042,0,"wasm wrapper"],[44926,0,"Diamond is compiled"],[44937,8,""],[44937,0,"wrapped"],[44937,7,""],[44937,0,"compiled & "],[44947,1,""],[44946,1,""],[44946,0,"to wasm using "],[44961,4,""],[44961,0,"this"],[44966,10,""],[44966,0,"project"],[45059,0,", o"],[45061,1,""],[45061,0,"though I've bee"],[45061,15,""],[45061,0,"hardcoded to point to a local copy of diamond-types from git"],[45121,26,""],[45121,0,"."],[45466,0,"\n"],[45123,1,""],[45465,0,"\nDiamond is compiled to wasm using [this project](https://github.com/josephg/diamond-js/tree/6e8a95670b651c0aaa7701a1a763778d3a486b0c), hardcoded to point to a local copy of diamond-types from git."],[44926,197,""],[45268,0,"\n"],[44925,1,""],[45267,0,"\nDiamond's benchmarks come from [josephg/diamond-types, at this version](https://github.com/josephg/diamond-types/tree/42a8bc8fb4d44671147ccaf341eee18d77b2d532). Benchmark by running ` RUSTFLAGS='-C target-cpu=native' cargo criterion yjs`. The inline rope structure updates can be enabled or disabled by editing [the constant at the top of src/list/doc.rs](https://github.com/josephg/diamond-types/blob/42a8bc8fb4d44671147ccaf341eee18d77b2d532/src/list/doc.rs#L15). You can look at memory statistics by running `cargo run --release --features memusage --example stats`."],[44356,569,""],[44698,0,"\n"],[44355,1,""],[44697,1,""],[44355,0,"\n"],[44698,0,".\n"],[45467,1,""],[45311,7,""],[45311,0,"wrapper"],[45467,0," The bench"],[45471,6,""],[45471,0," wasm bundle is optimized with was"],[45502,3,""],[45502,0,"b"],[45502,1,""],[45502,0,"wasm-opt."],[45487,0,"also "],[45487,5,""],[45625,1,""],[43059,12,""],[43059,0,"Diamond"],[43089,0,"there's a lot of work before its "],[43118,4,""],[43118,0,"I have feature parity with "],[43145,76,""],[43153,1,""],[43153,0,"A"],[43224,0,"operation "],[43394,0," And they need to be optimized for"],[43404,0,"also "],[43433,0," loading and saving documents from "],[43394,74,""],[43394,0," And they also need to be optimized for loading and saving documents from "],[43394,74,""],[43394,0," Diamond is "],[43403,3,""],[43403,0,"does almost none of this "],[43395,0,"So far"],[43401,1,""],[43401,0," d"],[43434,1,""],[43434,0,"."],[43434,1,""],[43434,0," "],[43434,1,""],[43434,0," thankless work."],[43435,14,""],[43434,1,""],[43395,6,""],[43395,0,"At the time of writing,"],[47365,0,"\n\n"],[47366,0,"That said, there is one way in which Yjs has a definite edge over the other implemtn"],[47449,1,""],[47448,1,""],[47447,1,""],[47447,0,"mentations: Yjs doesn'st "],[47471,1,""],[47470,1,""],[47469,1,""],[47469,0,"t store "],[47442,15,""],[47432,10,""],[47432,0,"automerge"],[47447,14,""],[47447,0,"treats deletes"],[47447,14,""],[47447,0,"doesn't store which items in a document have been deleted. Only that they have"],[47521,0,"*"],[47526,0,"* b"],[47528,1,""],[47527,1,""],[47526,1,""],[47526,0," been* deleted. This is "],[47547,3,""],[47547,0,"has some weird implications:\n\n- "],[47577,2,""],[47577,0,"-"],[47259,12,""],[47259,0,"diamond"],[47359,0," I'm still"],[47364,5,""],[47364,0,"not sure if I want to. Kevin is probably right - I don't think this is something people ask for."],[47461,0,"\n---\n"],[47467,12,""],[47467,0,"T"],[47467,0,"Well, "],[47473,1,""],[47473,0,"t"],[47537,0,".Its n"],[47542,1,""],[47541,1,""],[47540,1,""],[47539,1,""],[47538,1,""],[47537,1,""],[47537,0,". And it has nothing to do with "],[47539,30,""],[47538,1,""],[47537,1,""],[47557,16,""],[47557,0,"*when* each item in a"],[47587,5,""],[47587,0," has"],[47678,0," Yjs needs to store much less information. Storing when "],[47721,13,""],[47721,0,"It takes about 500kb"],[47679,62,""],[47679,0,"Storing when each delete happened is weirdly large. Diamond's memory usage increases from 1.12mb to 2.34mb when I also to"],[47799,1,""],[47798,1,""],[47798,0,"store delet"],[47786,23,""],[47785,1,""],[47785,0,"."],[47731,0,"Thsi in"],[47737,1,""],[47736,1,""],[47735,1,""],[47734,1,""],[47734,0,"is"],[47735,1,""],[47734,1,""],[47733,1,""],[47733,0,"is increases"],[47745,1,""],[47745,0," d"],[47768,10,""],[47791,0,"\n"],[47731,4,""],[47731,0,"Adding this data"],[47803,0," I think I can optimize that further, but its not t"],[47853,1,""],[47853,0,"nothing."],[47845,3,""],[47845,0,"it aint"],[47852,4,""],[47862,0,"- Storing when each delete"],[47864,24,""],[47862,2,""],[47862,0,"-"],[47641,0," (Deletes are a "],[47643,14,""],[47643,0,"Yjs stores deletes as a state CRDT, not as a "],[47687,1,""],[47687,0,"n operation-based CRDT)."],[47818,9,""],[47818,0,"to"],[47808,4,""],[47808,0,"temporal deletes"],[47824,5,""],[47836,1,""],[47835,1,""],[47835,0," increases"],[47882,8,""],[47931,0," And it'll also have an impact on fil"],[47965,3,""],[47965,0,"storage"],[47965,0,"on-disk "],[47980,0," size."],[47988,0," Yjs can't do character-by-character repl"],[48025,4,""],[48025,0,"editing replays."],[47998,43,""],[47998,0," replay editing sessions"],[47999,0,"give you pretty time slider style "],[48033,7,""],[48048,1,""],[48048,0," replays. "],[48057,1,""],[48057,0," (Do people want that? I"],[48080,1,""],[48079,1,""],[48059,20,""],[48058,1,""],[48058,0,"(Maybe people don't want that, but its cool)"],[48101,0,"."],[48103,0,"\n- Yjs's "],[48111,1,""],[48110,1,""],[48109,1,""],[48109,0," needs to embed information about "],[48119,24,""],[48119,0,"RLE"],[48121,1,""],[48120,1,""],[48119,1,""],[48119,0,"run-length encode the deletes"],[48137,4,""],[48137,0,"information about which items have been "],[48183,1,""],[48182,1,""],[48182,0,"ed into the version field. In diamond, versions are small ("],[48240,1,""],[48239,1,""],[48234,5,""],[48234,0,"a few bytes. In yjs, versions are 4kb."],[48268,0,"~"],[48273,0," And thet"],[48281,1,""],[48281,0,"y grow over time."],[48297,0," "],[48297,1,""],[48297,0," as the document grows"],[48320,0," (B"],[48322,1,""],[48321,1,""],[48320,1,""],[48319,0,", and more items are "],[48319,21,""],[48321,0,"\n"],[48321,0,"\nThe master branch of diamond does"],[48351,4,""],[48351,0,"adds this information back"],[47883,0,"'m going to"],[47894,4,""],[47928,0,"'"],[47940,5,""],[47940,0,"T"],[47940,1,""],[47940,0,"I"],[47950,18,""],[47950,0," increase"],[47882,34,""],[47882,0,"There's room for more optimization"],[47942,3,""],[47956,0,"s the"],[47996,21,""],[47996,0,"do "],[47999,28,""],[47999,0,"per-keystroke editing"],[48028,0," or anything fancy like that"],[48058,45,""],[48057,1,""],[48190,3,""],[48189,1,""],[48188,1,""],[48187,1,""],[48187,0,"t"],[48187,1,""],[48187,0," tens of"],[48312,21,""],[48312,0,"tempo"],[48312,5,""],[48312,0,"del"],[48312,3,""],[48312,0,"temporal deletes, "],[48329,1,""],[48328,1,""],[48328,0,". I've been benchmarking out of a branch"],[48362,0,"special "],[48376,0," with this stuff disabled, to make the comparison "],[48411,0,"a fair"],[48417,3,""],[48429,0,"with yjs. But diamond"],[48443,0,"f"],[48443,1,""],[48443,0,"the released version of "],[48474,0," might end up a little bigger."],[48503,0," than you would expect"],[48509,16,""],[48509,0,"these benchmarks suggest"],[48534,0," I haven'd"],[48543,1,""],[48543,0,"t decided if it should be confi"],[48535,39,""],[48534,1,""],[48534,0," This is not diamond's final form."],[48535,33,""],[48534,1,""],[47801,6,""],[47801,0,"When I add"],[47839,0," "],[47839,1,""],[47839,0,", it"],[47841,13,""],[47853,0," increases"],[47882,1,""],[47882,0,"4"],[47895,0,"lots of "],[47911,5,""],[47911,0," further"],[47938,2,""],[47938,0,"this"],[47958,23,""],[47958,0,"O"],[47978,0," also increases"],[47958,0,"This will also impact "],[47980,1,""],[47980,0,"o"],[48000,16,""],[48000,0,". I won't be able to match"],[48001,25,""],[47555,1,""],[47554,1,""],[47553,1,""],[47552,1,""],[47551,1,""],[47551,0,"record"],[47644,0,"Aka, "],[47789,3,""],[47789,0,"has a "],[47808,0," impact on memory usage"],[47833,8,""],[47833,0,"A"],[47836,0,"ing"],[47867,1,""],[47867,0," b"],[47868,1,""],[47868,0,"pushes"],[47888,10,""],[47868,6,""],[47868,0,"increases"],[47912,1,""],[47912,0,"!"],[47913,115,""],[47831,0," and on-disk storage size"],[47941,0,"Without temporal deletes, "],[47977,2,""],[47977,0,"implement"],[48020,8,""],[48020,0,"other"],[48031,0," stuff"],[48048,0," (Maybe people "],[48056,7,""],[48056,0,"thats what people want?)"],[48079,0," Is it weird to have every keystroke recorded?"],[48105,0," errent "],[48112,1,""],[48111,1,""],[48110,1,""],[48109,1,""],[48109,0,"ant"],[48166,0," the"],[48149,11,""],[48155,4,""],[48213,0,"*"],[48221,0,"*"],[48343,0," This is still pretty s"],[48344,22,""],[48344,0,"Kevin assures me that deletes"],[48366,7,""],[48366,0,"this information is always small in practice, ubt "],[48415,1,""],[48414,1,""],[48413,1,""],[48412,1,""],[48412,0,"but I don't like"],[48416,12,""],[48416,0,"it still gives"],[48425,5,""],[48425,0,"makes me nervous."],[48417,1,""],[48416,1,""],[48415,1,""],[48415,0,"t"],[48415,1,""],[48415,0," this"],[48498,27,""],[48498,0,"This blos"],[48506,1,""],[48506,0,"g post is writte"],[48498,24,""],[48498,0,"All benchmarks in this blog post use "],[48535,4,""],[48535,0,"a"],[48552,0,"of diamond-types "],[48535,1,""],[48535,0,"the [yjs-style]"],[48550,8,""],[48549,1,""],[48556,0,"](https://github.com/josephg/diamond-types/tree/yjs-style)"],[48615,16,""],[48614,1,""],[48556,0," of diamond-types"],[48631,0,", where"],[48638,5,""],[48638,0," t"],[48639,1,""],[48638,1,""],[48650,0,"has been "],[48667,1,""],[48667,0,". This makes for"],[48683,8,""],[48690,0,"er"],[48712,1,""],[48712,0,", but"],[48717,4,""],[48721,0," final"],[48727,9,""],[48760,46,""],[48753,7,""],[48753,0,"be a little bigger than I've suggested above. YMMV."],[48798,6,""],[48798,0," Eh."],[48798,4,""],[47612,21,""],[47612,0,"whether each ti"],[47626,1,""],[47625,1,""],[47625,0,"item has been"],[47646,0," or not"],[47654,74,""],[47653,1,""],[47830,9,""],[47830,0,"doubles"],[38757,0,"\n"],[38757,0,"\nI"],[38758,1,""],[38758,0,"> Its cool"],[38760,8,""],[38760,0,"Huh - the jitterny"],[38777,1,""],[38776,1,""],[38776,0,"yness of yjs and rust-wasm kind of line up."],[38802,8,""],[38811,0," Periods when yjs is slow, rust-wasm gets faster. And vice versa. I wonder what thats "],[38896,1,""],[38895,1,""],[38895,0," is !?"],[38900,1,""],[38899,1,""],[38898,1,""],[38898,0,"!"],[38766,0," "],[38766,1,""],[38766,0,"look at the bottom two lines around 200 0"],[38806,1,""],[38805,1,""],[38805,0,",000. "],[38811,1,""],[38811,0,"T"],[38848,7,""],[38848,0,"mirror each other"],[38914,1,""],[38914,0,"."],[38915,15,""],[38914,1,""],[38929,0,"s"],[38930,8,""],[38930,0," going on there"],[38913,1,""],[38912,1,""],[38105,68,""],[39039,0,"\n\nThat, my friends, is how you make the computer do a lot less work."],[39039,1,""],[39040,0,"\n"],[39040,1,""],[39107,0,"\n"],[39985,0,"beautiful, flawed "],[40011,29,""],[40036,0," mooks"],[40041,1,""],[40041,0,"s"],[40733,13,""],[40733,0," I guess"],[40733,8,""],[40757,0," comes out of"],[40770,6,""],[40825,376,""],[41035,4,""],[41035,0,"And "],[41040,0," just thumbed my nose at them all and kept using O"],[41083,7,""],[41083,0,"work in"],[41089,1,""],[41088,1,""],[41087,1,""],[41087,0,"ing on Operational Tranform"],[41114,18,""],[41110,0,"s"],[41121,0," helped out"],[41132,4,""],[41210,0,"So"],[41211,1,""],[41210,1,""],[41918,0," U"],[41919,1,""],[41918,1,""],[41918,0," My contribution is using b-trees and pu"],[41957,1,""],[41956,1,""],[41955,1,""],[41943,0," RLE-"],[41948,1,""],[41947,1,""],[41947,0," "],[41944,4,""],[41944,0,"run-length encoded "],[41971,3,""],[41970,1,""],[41970,0," alongisde a "],[41971,12,""],[41971,0,"and rare-"],[41979,1,""],[41979,0,"ly-"],[41981,1,""],[41981,0," all"],[41975,10,""],[41974,1,""],[41974,0," clever indexing. And showing Kevin's list representation can be adapted to ang"],[42052,1,""],[42052,0," "],[42052,1,""],[42052,0,"y algorithm. I don't"],[42054,9,""],[42054,0,"CRDT algorithm"],[42070,7,""],[42070,0,"Nobody has noticed"],[42070,18,""],[42070,0,"I don't think anyone noticed that before."],[42012,0,"fast "],[42165,20,""],[42165,0,"figureou"],[42172,1,""],[42171,1,""],[42171,0,"d out how to make"],[42233,0," Gawsh."],[42234,7,""],[34763,43,""],[34770,2,""],[34770,0,"chart shows"],[34781,12,""],[34794,7,""],[34793,1,""],[34782,0,"javascript "],[34804,0,", called"],[34806,6,""],[34806,0,"calling into rust via"],[34832,20,""],[34781,0," the slow version. "],[34765,0,"And "],[34769,1,""],[34769,0,"t"],[34804,0,"This is"],[34809,2,""],[34809,0,"includes"],[34808,9,""],[34808,0," benchmark is run "],[34804,22,""],[34804,0,"For fairness this char"],[34804,22,""],[34804,0,"This chart is j"],[34818,1,""],[34818,0,"generea"],[34824,1,""],[34823,1,""],[34823,0,"ated via"],[34828,3,""],[34828,0,"from"],[34844,11,""],[34843,1,""],[34863,3,""],[34863,0,"through"],[34877,44,""],[34768,0," remember,"],[34800,0,"*"],[34805,0,"*"],[34888,41,""],[34952,4,""],[34952,0,"I wonder "],[34964,0," the gap is so big"],[35036,0,"know how to "],[35056,14,""],[35093,14,""],[35093,0," does WASM's"],[35126,19,""],[35126,0," slow it down that much?"],[35127,0,"reall"],[35131,1,""],[35130,1,""],[35129,1,""],[35128,1,""],[35127,1,""],[35019,0," really that"],[34965,17,""],[34965,0,"wasm is so much slower than native"],[34951,1,""],[34951,0,"\n\n"],[34953,17,""],[34953,0,"Why is WASM"],[34964,3,""],[34984,0," when I run it"],[35005,0,"ly"],[37816,1,""],[37815,1,""],[37814,1,""],[37814,0,"0.0"],[37816,1,""],[37816,0,"96"],[37822,1,""],[42468,0,"["],[42472,0,"](https://github.com/yjs/yjs)"],[42511,9,""],[42511,0,"o"],[42511,1,""],[42511,0,"solid"],[48464,3,""],[48464,0,"For now, the"],[48502,4,""],[48502,0,"has"],[48502,3,""],[48502,0,"includes"],[48529,0,"But "],[48533,1,""],[48533,0,"a"],[48570,3,""],[48570,0,"a"],[48666,34,""],[48666,0,"which works similarly to yhs"],[48693,1,""],[48692,1,""],[48692,0,"js"],[48678,12,""],[48678,0,"like"],[48686,0," intea"],[48691,1,""],[48690,1,""],[48689,1,""],[48689,0,"stead"],[48683,1,""],[48683,0,"Y"],[48780,18,""],[48780,0,"work differently"],[47955,1,""],[47955,0,", and makes the system about 20"],[47985,1,""],[47984,1,""],[47984,0,"10% slower."],[47985,1,""],[47984,1,""],[47984,0,"3"],[47984,1,""],[47984,0,"5"],[48710,10,""],[48710,0,"matches how"],[48725,0," works"],[48790,77,""],[48790,0,"these benchmarks might not be indicitive of diamond 1.0"],[48820,10,""],[48820,0,"indicative"],[48846,0," "],[48846,1,""],[48790,44,""],[48801,0," might be different"],[48811,9,""],[48811,0,"not m"],[48808,8,""],[48808,0,"not match"],[48808,9,""],[48808,0,"have a lisg"],[48818,1,""],[48817,1,""],[48816,1,""],[48815,1,""],[48815,0,"slightly different me"],[48835,1,""],[48834,1,""],[48834,0,"performance profile"],[48854,0," Eh."],[48854,4,""],[48854,0," Its "],[48854,5,""],[48854,0," (I"],[48856,1,""],[48855,1,""],[48855,0,"(E"],[48856,1,""],[48856,0,"There's plenty of puns here about diamond not being polished yet, but I'm not sharp enough for any of those"],[48947,16,""],[48947,0,"to make"],[48947,7,""],[48947,0,"for those right now)"],[48966,0,"."],[50313,413,""],[50312,1,""],[49964,7,""],[49964,0,"dim"],[49966,1,""],[49966,0,"amond yet"],[49975,5,""],[50113,9,""],[50113,0,"similar"],[50158,1,""],[50157,1,""],[50157,0,", an d"],[50162,1,""],[50161,1,""],[50160,1,""],[50159,1,""],[50159,0,"and "],[50163,14,""],[50198,5,""],[50198,0,"will probably appx"],[50215,1,""],[50215,0,"roximately"],[50264,0,"Maybe. "],[50270,0," Or maybe I'm wrong."],[50313,1,""],[50313,0,"."],[50315,5,""],[50315,0,"I"],[50158,0," modulo d"],[50166,1,""],[50166,0,"delete operations. "],[50184,1,""],[50159,6,""],[50159,0,"except for"],[50189,3,""],[50189,0,"And per"],[50195,1,""],[50194,1,""],[50193,1,""],[50192,1,""],[50189,5,""],[50189,0,"O"],[50189,1,""],[50189,0,"P"],[52645,5,""],[52645,0,"'m "],[52658,0,"ing"],[37525,30,""],[37525,0,"D"],[34007,30,""],[34007,0,"D"],[37497,0,"i"],[34008,0,"i"],[37499,0,"a"],[34009,0,"a"],[37501,0,"m"],[34010,0,"m"],[37503,0,"o"],[34011,0,"o"],[37505,0,"n"],[34012,0,"n"],[37507,0,"d"],[34013,0,"d"],[37509,0," "],[34014,0," "],[37511,0,"("],[34015,0,"("],[37513,0,"w"],[34016,0,"w"],[37515,0,"a"],[34017,0,"a"],[37517,0,"s"],[34018,0,"s"],[37519,0,"m"],[34019,0,"m"],[37520,1,""],[34019,1,""],[37518,1,""],[34018,1,""],[37517,0,"s"],[34018,0,"s"],[37519,0,"m"],[34019,0,"m"],[37521,0," "],[34020,0," "],[37523,0,"v"],[34021,0,"v"],[37525,0,"i"],[34022,0,"i"],[37527,0,"a"],[34023,0,"a"],[37529,0," "],[34024,0," "],[37531,0,"n"],[34025,0,"n"],[37533,0,"o"],[34026,0,"o"],[37535,0,"d"],[34027,0,"d"],[37537,0,"e"],[34028,0,"e"],[37539,0,"j"],[34029,0,"j"],[37541,0,"s"],[34030,0,"s"],[37543,0,")"],[34031,0,")"],[37545,0," "],[34032,0," "],[37547,0," "],[34033,0," "],[37549,0," "],[34034,0," "],[37551,0," "],[34035,0," "],[37553,0," "],[34036,0," "],[34032,5,""],[34034,0,"     "],[37605,13,""],[37605,0,"D"],[34070,13,""],[34070,0,"D"],[37594,0,"i"],[34071,0,"i"],[37596,0,"a"],[34072,0,"a"],[37598,0,"m"],[34073,0,"m"],[37600,0,"o"],[34074,0,"o"],[37602,0,"n"],[34075,0,"n"],[37604,0,"d"],[34076,0,"d"],[37606,0," "],[34077,0," "],[37608,0,"("],[34078,0,"("],[37610,0,"n"],[34079,0,"n"],[37612,0,"a"],[34080,0,"a"],[37614,0,"t"],[34081,0,"t"],[37616,0,"i"],[34082,0,"i"],[37618,0,"v"],[34083,0,"v"],[37620,0,"e"],[34084,0,"e"],[37622,0,")"],[34085,0,")"],[37625,3,""],[34090,3,""],[37767,4,""],[37767,0,"a"],[37767,1,""],[37767,0,"Diamond"],[37786,4,""],[37786,0," doc"],[37122,0," Lang"],[37126,1,""],[37125,1,""],[37124,1,""],[37123,1,""],[37123,0,"Language |"],[37213,0," -------- |"],[37304,0," JS       |"],[37395,0," JS       |"],[37486,0," JS       |"],[37577,0," JS       |"],[37668,0," JS       | JS       |"],[37679,11,""],[37759,0," JS       |"],[37850,0," JS       |"],[37944,0," JS       |"],[37913,1,""],[37912,1,""],[37911,1,""],[37669,2,""],[37669,0,"Rust/wasm"],[37677,1,""],[37676,1,""],[37675,1,""],[37674,1,""],[37674,0,"WASM"],[37678,6,""],[37761,2,""],[37761,0,"Rust"],[37765,1,""],[37673,1,""],[37673,0,"+"],[37678,0,"+JS"],[37673,5,""],[37676,0," "],[37767,1,""],[37851,2,""],[37851,0,"Rust"],[37855,2,""],[37942,2,""],[37942,0,"Rust"],[37946,2,""],[37673,1,""],[37673,0," iva"],[37676,1,""],[37675,1,""],[37674,1,""],[37674,0,"via "],[37130,1,""],[37129,1,""],[37128,1,""],[37127,1,""],[37127,0,"    "],[37106,14,""],[37106,0,"Data storage"],[37110,8,""],[37110,0,"          "],[37110,11,""],[37110,0," structure "],[33318,4,""],[33317,1,""],[34565,12,""],[34564,1,""],[34947,33,""],[34947,0,"4x slower than"],[34969,1,""],[34968,1,""],[34968,0," execution"],[35054,1,""],[35053,1,""],[35052,1,""],[35051,1,""],[35050,1,""],[35049,1,""],[35048,1,""],[35047,1,""],[35046,1,""],[35045,1,""],[35044,1,""],[35043,1,""],[35078,1,""],[35077,1,""],[35076,1,""],[35075,1,""],[35074,1,""],[35073,1,""],[35072,1,""],[35071,1,""],[35070,1,""],[35069,1,""],[35083,1,""],[35082,1,""],[35132,1,""],[35131,1,""],[35130,1,""],[35129,1,""],[35128,1,""],[35127,1,""],[35126,1,""],[35125,1,""],[35124,1,""],[35123,1,""],[37610,7,""],[37610,0,"+wasm"],[37610,5,""],[37610,0," via JS"],[37613,1,""],[37612,1,""],[37611,1,""],[37611,0,"+"],[38102,10,""],[38102,0,"keystrokes"],[38767,14,""],[38766,1,""],[38842,1,""],[38841,1,""],[38841,0,"gets"],[38850,0,"er"],[38873,0,"er"],[38905,1,""],[38904,1,""],[38903,1,""],[38902,1,""],[38901,1,""],[38901,0,"there"],[38854,9,""],[38854,0,"d"],[38795,9,""],[38795,0,"d"],[38847,0,"i"],[38796,0,"i"],[38849,0,"a"],[38797,0,"a"],[38851,0,"m"],[38798,0,"m"],[38853,0,"o"],[38799,0,"o"],[38855,0,"n"],[38800,0,"n"],[38857,0,"d"],[38801,0,"d"],[49011,4,""],[49011,0,"These"],[52128,20,""],[47921,19,""],[47921,0,"this data"],[47930,8,""],[47938,0," diamond's"],[48025,0,"Because it doesn't store "],[48050,8,""],[48025,43,""],[48029,0,"doen'"],[48033,1,""],[48032,1,""],[48032,0,"esn't "],[48037,1,""],[48036,1,""],[48035,1,""],[48034,1,""],[48033,1,""],[48032,1,""],[48032,0,"sn't store enough information to "],[48065,6,""],[48474,0,"basically "],[48508,1,""],[48508,0,". He might be right"],[48551,0," weirldy"],[48556,1,""],[48557,0,"l"],[52836,12,""],[52836,0,"diamond"],[52911,12,""],[52911,0,"diamond"],[53094,0," r"],[53095,1,""],[53095,0,"diamond's performance i"],[53117,1,""],[53116,1,""],[53117,4,""],[53117,0,"isn't just thanks to"],[53137,9,""],[31884,22,""],[31884,0,"Diamond"],[77,58,""],[77,0,"5000x faster CRDTs: An adventure in optimization"],[0,75,""],[50,0," -->"],[0,0,"<!-- "],[55,4,""],[0,5,""],[50,0,"\n\n<span class=m="],[65,1,""],[64,1,""],[64,0,"post-meta>July 31 2021</span>"],[21,1,""],[20,1,""],[20,0,"\n\n## "],[24,0,"$$"],[25,1,""],[24,1,""],[24,0,"##"],[26,1,""],[25,1,""],[24,1,""],[23,1,""],[22,1,""],[21,1,""],[20,1,""],[20,0,": "],[22,17,""],[22,0,"O"],[34,0," Adventures"],[34,11,""],[22,1,""],[22,0,"An adventure in o"],[38,1,""],[38,0,"O"],[25,1,""],[25,0,"A"],[55374,0,"\n\n---\n\nJoseph Gentle\n\n"],[55395,1,""],[55381,0,"["],[55395,0,"](https://josephg.com/)"],[55379,0,"\n<footer>"],[55428,0,"\n</fi"],[55432,1,""],[55432,0,"ooter>"],[55375,4,""],[55386,0,"Wri"],[55388,1,""],[55387,1,""],[55386,1,""],[55386,0,"By "],[55390,6,""],[55390,0,"Seph"],[55386,3,""],[55385,0,"\nSeph Gentle\n"],[55400,11,""],[55400,0,"https://josephg.com/"],[55399,0,"[https://josephg.com/](https://josephg.com/)\n\n"],[55454,11,""],[55454,0,"gt"],[55455,1,""],[55455,0,"ithub.com"],[55465,0,"josephg/"],[55475,20,""],[55475,0,"https://github.com/josephg/"],[55386,11,""],[55389,20,""],[55389,0,"Seph Gentle"],[55386,1,""],[55385,1,""],[55387,0,"2021 "],[37076,1,""],[37076,0,":"],[37833,1,""],[37742,1,""],[37651,1,""],[37560,1,""],[37467,1,""],[37376,1,""],[37285,1,""],[37194,1,""],[37103,1,""],[37012,1,""],[37823,1,""],[37733,1,""],[37643,1,""],[37553,1,""],[37461,1,""],[37371,1,""],[37281,1,""],[37191,1,""],[37101,1,""],[37011,1,""],[37813,1,""],[37724,1,""],[37635,1,""],[37546,1,""],[37455,1,""],[37366,1,""],[37277,1,""],[37188,1,""],[37099,1,""],[37010,1,""],[37803,1,""],[37715,1,""],[37627,1,""],[37539,1,""],[37449,1,""],[37361,1,""],[37273,1,""],[37185,1,""],[37097,1,""],[37009,1,""],[37793,1,""],[37706,1,""],[37619,1,""],[37532,1,""],[37443,1,""],[37356,1,""],[37269,1,""],[37182,1,""],[37095,1,""],[37008,1,""],[37783,1,""],[37697,1,""],[37611,1,""],[37525,1,""],[37437,1,""],[37351,1,""],[37265,1,""],[37179,1,""],[37093,1,""],[37007,1,""],[37773,1,""],[37688,1,""],[37603,1,""],[37518,1,""],[37431,1,""],[37346,1,""],[37261,1,""],[37176,1,""],[37091,1,""],[37006,1,""],[37763,1,""],[37679,1,""],[37595,1,""],[37511,1,""],[37425,1,""],[37341,1,""],[37257,1,""],[37173,1,""],[37089,1,""],[37005,1,""],[37753,1,""],[37670,1,""],[37587,1,""],[37504,1,""],[37419,1,""],[37336,1,""],[37253,1,""],[37170,1,""],[37087,1,""],[37004,1,""],[37743,1,""],[37661,1,""],[37579,1,""],[37497,1,""],[37413,1,""],[37331,1,""],[37249,1,""],[37167,1,""],[37085,1,""],[37003,1,""],[37733,1,""],[37652,1,""],[37571,1,""],[37490,1,""],[37407,1,""],[37326,1,""],[37245,1,""],[37164,1,""],[37083,1,""],[37002,1,""],[37483,1,""],[37482,1,""],[55262,0,"\n# Acknowledgements"],[55262,0,"\n"],[55283,0,"\n"],[55283,0,"\nTa"],[55285,1,""],[55285,0,"hanks fo"],[55292,1,""],[55291,1,""],[55291,0,"to everyone who gave "],[55284,28,""],[55284,0,"This work was made possible thanks to "],[55312,10,""],[55312,0,"as part of [braid](b"],[55331,1,""],[55331,0,"https:"],[55331,6,""],[55331,0,"https://braid.org/)"],[55323,0,"the "],[55328,1,""],[55328,0,"B"],[55333,0," project"],[55311,15,""],[55294,17,""],[55294,0,"is part of the"],[55344,0,", ufn"],[55348,1,""],[55347,1,""],[55346,1,""],[55345,1,""],[55344,1,""],[55344,0,", f"],[55346,1,""],[55345,1,""],[55344,1,""],[55344,0," and funded by the [Invisible College](https://invisible.college/).\n\nThankyou to everyone who gave feedback before ths"],[55461,1,""],[55460,1,""],[55460,0,"i"],[55460,1,""],[55460,0,"his post went live."],[55413,0,"Huge "],[55418,1,""],[55418,0,"t"],[55483,1,""],[55483,0,". And Parti"],[55489,5,""],[55489,0,"Martin and Kevin for "],[55506,4,""],[55505,1,""],[55489,0,"special thakns to "],[55497,10,""],[55497,0,"thanks to "],[55513,0," L"],[55514,1,""],[55514,0,"Kleppmann "],[55524,1,""],[55533,0," Jahns for their work on Automerge and Yjs. Diamond "],[55577,8,""],[55577,0,"This wouldn'"],[55582,7,""],[55582,0,"works "],[55587,1,""],[55586,1,""],[55289,4,""],[55289,0,"post"],[55411,0," We're hiring"],[55412,0,"If this is the sort of work you want to contribute towards, "],[55472,1,""],[55472,0,"w"],[55472,0," g"],[55473,1,""],[55472,1,""],[55472,0,"get in touch. "],[55486,1,""],[55486,0,"W"],[55498,0,"."],[55501,6,""],[55501,0,"T"],[55567,1,""],[55567,0,"\n\n"],[55661,9,""],[55661,0,"My CRDT is g"],[55672,1,""],[55672,0,"i"],[55672,1,""],[55672,0,"great because"],[55669,16,""],[55669,0,"is standing on the shoulders of ch"],[55702,1,""],[55701,1,""],[55701,0,"giants."],[55669,11,""],[55669,0,"stands"],[55703,0,"\n"],[55661,7,""],[55661,0,"Diamond"],[5490,25,""],[5490,0,"width=\"560\" height=\"315\" "],[5490,0,"min"],[5492,1,""],[5491,1,""],[5490,1,""],[5490,0,"max-"],[5506,0,"max-"],[5506,4,""],[5490,4,""],[5490,0,"min"],[5490,3,""],[5489,0," max-width: 10"],[5502,1,""],[5501,1,""],[5500,1,""],[5499,1,""],[5499,0,"=100\""],[5500,0,"\""],[5490,40,""],[5490,0,"class=\"typ"],[5499,1,""],[5498,1,""],[5497,1,""],[5497,0,"youtube\""],[5504,0,"-"],[5504,1,""],[3510,0,"#"],[5033,0,"#"],[11458,0,"#"],[38962,0,"#"],[42173,0,"##"],[43828,0,"##"],[45622,0,"#"],[45622,1,""],[43830,1,""],[42173,1,""],[53322,0,"#"],[55262,0,"#"],[250,0,"realtime "],[259,10,""],[259,0,"collaborative"],[280,0," (like google docs)"],[287,1,""],[287,0,"G"],[294,1,""],[294,0,"D"],[299,1,""],[299,0,". They implemented lots of algorithms ("],[338,15,""],[349,11,""],[349,0,")"],[349,0," stuff"],[356,0," and they"],[365,10,""],[378,0,"them "],[386,8,""],[386,0,"to see"],[391,1,""],[390,1,""],[389,1,""],[388,1,""],[387,1,""],[386,1,""],[386,0," to see how they perform"],[412,13,""],[412,0,"(Cool!!) "],[338,0,"["],[343,0,"](https://en.wikipedia.org/wiki/Conflict-free_replicated_data_type)"],[409,1,""],[345,64,""],[343,2,""],[338,1,""],[342,0,"s"],[337,1,""],[337,0," -"],[338,1,""],[337,1,""],[337,0,"- "],[351,0," algorithms and"],[372,1,""],[372,0,"."],[374,3,""],[374,0,"And"],[1712,10,""],[1712,0,"grad student"],[2078,0,"["],[2084,0,"](https://en.wikipedia.org/wiki/Conflict-free_replicated_data_type)"],[2078,0,"Conflict-Free"],[2078,13,""],[2151,0," (thats Conf-"],[2163,1,""],[2163,0,"lict-Free Replicated d"],[2184,1,""],[2184,0,"Data types"],[2057,0,"\nCRDTs are Conflict-Free Replicate D"],[2092,1,""],[2091,1,""],[2091,0,"d Data types. Basically, special algoit"],[2129,1,""],[2128,1,""],[2128,0,"rithms "],[2124,11,""],[2124,0,"constructions wihc"],[2141,1,""],[2140,1,""],[2140,0,"ch "],[2142,1,""],[2141,1,""],[2140,1,""],[2139,1,""],[2139,0,"i"],[2139,1,""],[2139,0,"hich let mutl"],[2151,1,""],[2150,1,""],[2150,0,"ltiple users "],[2148,15,""],[2148,0,"l"],[2148,1,""],[2148,0,"multiple computers / users all edit some data and "],[2194,4,""],[2194,0,"locally without "],[2202,8,""],[2202,0,"nee"],[2202,3,""],[2184,0,"the same data"],[2197,17,""],[2197,0," at the same time, and "],[2219,1,""],[2218,1,""],[2214,4,""],[2214,0,". Once the compuer"],[2231,1,""],[2230,1,""],[2230,0,"ters tell "],[2235,5,""],[2235,0,"share their changes with each other, they"],[2272,4,""],[2272,0,"everyone's copy "],[2215,73,""],[2215,0," "],[2215,1,""],[2214,1,""],[2214,0," without worrying about locking or \n"],[2058,191,""],[2058,0,"CRDTs are Conflict-Free Replicated Data types. Basically, special constructions which let multiple computers / users all edit the same data at the same time without worrying about locking or"],[2249,1,""],[2215,33,""],[2214,1,""],[2214,0,", without worrying about editing conflicts. They "],[2258,5,""],[2257,1,""],[2286,66,""],[2068,0,"["],[2104,0,"]((https://en.wikipedia.org/wiki/Conflict-free_replicated_data_type))"],[2172,1,""],[2105,1,""],[2347,1,""],[2352,45,""],[2352,0," "],[2325,0," They let you build peer-to-peer google docs, or "],[2331,3,""],[2331,0,"can let us"],[2341,4,""],[2377,0,"database replication without"],[2377,0,"make eventuallyc"],[2392,1,""],[2392,0,"-consistent "],[2412,0,"s"],[2413,20,""],[2413,0,"."],[2416,0,"But "],[2420,1,""],[2420,0,"w"],[2347,0," a"],[2384,0,"fast, "],[2184,0,"they're "],[2192,21,""],[2192,0,"fancy programming tricks"],[2235,12,""],[2241,4,""],[2286,0," s"],[2287,1,""],[2287,0,"locking or"],[2369,59,""],[2369,0,"realtime document editing. Or "],[2396,3,""],[2396,0,"So we can take google out of google docs, or "],[2431,0,"'s computers ou "],[2446,1,""],[2446,0,"t of google"],[2467,0,"add collaborative editing to Git."],[2496,1,""],[2496,0,"g"],[2210,6,""],[2210,0,"tools"],[2466,32,""],[2466,0,"do master-master replication without PAXOS"],[2494,14,""],[2483,0,"database "],[2503,0," was "],[2507,1,""],[2506,1,""],[2506,0,"y faster"],[2405,44,""],[2405,0,"do"],[2419,0," without google"],[2439,48,""],[2439,0,"add pair programming to git"],[2404,3,""],[2404,0," build"],[2437,0,"'s computers"],[2331,151,""],[2330,1,""],[2293,0,", without servers"],[2302,8,""],[2294,8,""],[2293,1,""],[2330,0," And "],[2334,1,""],[2334,0,", maybe, without servers."],[2351,0,"some "],[2362,1,""],[2362,0," in control over "],[2378,1,""],[2377,1,""],[2376,1,""],[2375,1,""],[2375,0,"f everything"],[2366,7,""],[2366,0,"charge"],[2336,5,""],[2336,0,"hopefully"],[2359,0," FAANG"],[2355,10,""],[2355,0,"somebody else's compue"],[2376,1,""],[2376,0,"ter (\"the cloud)"],[2391,1,""],[2391,0,"\")"],[2393,20,""],[2393,0," controlling"],[2394,0,"witnessing and "],[2394,14,""],[2394,0,"needing to"],[2405,11,""],[2405,0,"coordinate"],[2173,0,"Th"],[2174,1,""],[2173,1,""],[2058,0,"For the unitn"],[2070,1,""],[2069,1,""],[2069,0,"nitiated, "],[2079,10,""],[2079,0,"CRDTS "],[2086,0,"("],[2122,0,")"],[2190,20,""],[2190,0," are"],[2219,5,""],[2219,0,"to allow"],[2227,4,""],[2242,0," to"],[2219,2,""],[2219,0,"which let"],[2228,6,""],[2282,1,""],[2282,0,". And we can do it"],[2309,0,"worrying about "],[2331,0,", "],[2332,1,""],[2331,1,""],[2334,15,""],[2352,0,", or b"],[2357,1,""],[2357,0,"e"],[2357,1,""],[2356,1,""],[2355,1,""],[2354,1,""],[2353,1,""],[2352,1,""],[2352,0,". People don't even need to be online to "],[2352,41,""],[2352,0," or spotty internet connections"],[2356,0,"lag & "],[2360,1,""],[2360,0,"from"],[2394,23,""],[2394,0,"The best part of CRDT "],[2415,1,""],[2415,0,"s is you can do all that without needing"],[2494,8,""],[2497,0," monitor and"],[2324,11,""],[2445,1,""],[2445,0,"S"],[2454,1,""],[2454,0,"E"],[2461,1,""],[2461,0,"C"],[2445,25,""],[2445,0,"any central computer on "],[2466,2,""],[2466,0,"in"],[2469,1,""],[2480,1,""],[2496,10,""],[2496,0,"control"],[2244,3,""],[2284,3,""],[2284,0," they do it"],[2295,10,""],[2303,0," needing to"],[2322,1,""],[2321,1,""],[2320,1,""],[2347,0," locking or"],[2395,0," an"],[2397,1,""],[2396,1,""],[2396,0,"or anything like that"],[2444,0," that they"],[2454,8,""],[2290,6,""],[2290,0,"work "],[2302,23,""],[2281,112,""],[2281,0,"They let you work locally without the internet"],[2313,1,""],[2312,1,""],[2311,1,""],[2311,0," no lag (you don't even have to be online)"],[2353,13,""],[2354,0," And when you do sync up with other users / devices, everything is "],[2418,3,""],[2418,0,"just mai"],[2425,1,""],[2425,0,"gically"],[2418,0,"should "],[2418,7,""],[2432,0," syncs up and becomes eventually consistent."],[2532,0," even"],[2545,4,""],[2545,0," a"],[2568,1,""],[2577,1,""],[2555,0,"ized"],[2512,0," can"],[2620,0," (Like google) "],[2627,1,""],[2627,0,"G"],[2633,0," Docs"],[2622,0,"Ahem, "],[2628,4,""],[2620,22,""],[2318,0,"."],[2321,1,""],[2321,0,"Y"],[2397,1,""],[2397,0,"&"],[2372,4,""],[2372,0,"connect"],[2383,4,""],[2383,0,"to"],[2383,2,""],[2383,0,"with"],[2372,7,""],[2372,0,"sync"],[2621,0," Think, google docs without goog.e"],[2654,1,""],[2653,1,""],[2653,0,"le."],[2629,1,""],[2629,0,"G"],[2636,1,""],[2636,0,"D"],[2649,1,""],[2649,0,"G"],[2649,1,""],[2649,0,"g"],[2656,0," Or master-master replication without "],[2674,0,"database "],[2058,645,""],[2058,0,"For the uninitiated, CRDTS [(Conflict-Free Replicated Data types)](https://en.wikipedia.org/wiki/Conflict-free_replicated_data_type) are fancy programming tools which let multiple users edit the same data at the same time. They let you work locally with no lag. (You don't even have to be online). And when you do sync up with other users & devices, everything just magically syncs up and becomes eventually consistent. The best part of CRDTs is that they can do all that without even needing a centralized computer in the cloud to monitor and control everything. Think, Google Docs without google. Or master-master database replication without lag. Or seamless "],[2621,1,""],[2621,0,"\n\n"],[2623,98,""],[2623,0,"Think, Google Docs without google. Or master-master database replication without lag. Or seamless cross-device application data, with no startup"],[2760,0,"dodgy "],[2773,0,"'s servers "],[2745,5,""],[2745,0,"s"],[2752,0,"out"],[2756,8,""],[2756,0,"worrying that some"],[2793,0,"are going to go offline"],[2809,7,""],[2809,0,"dark in a couple years."],[2756,76,""],[2756,0,"relying on a flakey startup "],[2783,1,""],[2783,0,"'s sta"],[2788,1,""],[2787,1,""],[2787,0,"ervers to still be around in a decade."],[2817,0,"nother"],[2832,0,"\n"],[2832,0,"\nBut they're famously slow."],[2854,0,"really "],[2865,0,", so nobody really"],[2870,13,""],[2870,0,"basl"],[2873,1,""],[2873,0,"re"],[2874,1,""],[2873,1,""],[2872,1,""],[2872,0,"rely anyone use "],[2887,1,""],[2887,0,"s them"],[2894,0," Wel"],[2897,1,""],[2896,1,""],[2895,1,""],[2894,1,""],[2894,0," Well, "],[2895,6,""],[2895,0,"But they don't have to be!\n\nBut before we can even talk about that, "],[2923,40,""],[2923,0,"But before we can even talk about that,"],[2962,71,""],[2767,1,""],[2767,0,"some"],[2836,11,""],[2836,0,"For text editing they're"],[2836,0,"But "],[2840,1,""],[2840,0,"f"],[2623,6,""],[2623,0,"I want"],[2658,51,""],[2660,22,""],[2660,0," my"],[2664,12,""],[2664,0,"apps to seamlessly work "],[2683,5,""],[2683,0,"share data between all my devices"],[2725,0," me needing to"],[2746,1,""],[2745,1,""],[2744,1,""],[2658,5,""],[2658,0,"I want my"],[2757,0,"["],[2772,0,"](https://ourincrediblejourney.tumblr.com/)"],[2865,3,""],[2865,0,"For"],[2868,4,""],[2888,1,""],[2887,1,""],[2887,0,"ve been"],[2915,0," for a de"],[2923,1,""],[2922,1,""],[2921,1,""],[2920,1,""],[2920,0,"years"],[2881,0," (and other rel"],[2895,1,""],[2895,0,"al application data)"],[2881,34,""],[2915,0," "],[2915,1,""],[2915,0," and clunky"],[2966,26,""],[2966,0,"Well, until now. "],[2982,1,""],[2083,1,""],[2083,0,"s"],[2058,925,""],[2057,1,""],[3589,0,"\n\nFor the uninitiated, CRDTs [(Conflict-Free Replicated Data types)](https://en.wikipedia.org/wiki/Conflict-free_replicated_data_type) are fancy programming tools which let multiple users edit the same data at the same time. They let you work locally with no lag. (You don't even have to be online). And when you do sync up with other users & devices, everything just magically syncs up and becomes eventually consistent. The best part of CRDTs is that they can do all that without even needing a centralized computer in the cloud to monitor and control everything.\n\nI want Google Docs without google. I want my apps to seamlessly share data between all my devices, without me needing to rely on some [flakey startup](https://ourincrediblejourney.tumblr.com/)'s servers to still be around in another decade.\n\nFor text editing they've been famously really slow and clunky for years, so barely anyone uses them. Well, until now.\n\n"],[4584,1,""],[4584,0,"\n\n\n"],[4584,0,"\n"],[4518,1,""],[4583,0,"\n"],[4517,1,""],[4582,0,"\n"],[4516,1,""],[4581,0,"\nFor text editing they've been famously really slow and clunky for years, so barely anyone uses them. Well, until now."],[4398,118,""],[4463,0,"\n"],[4397,1,""],[4462,0,"\nI want Google Docs without google. I want my apps to seamlessly share data between all my devices, without me needing to rely on some [flakey startup](https://ourincrediblejourney.tumblr.com/)'s servers to still be around in another decade."],[4156,241,""],[4221,0,"\n"],[4155,1,""],[4220,0,"\nFor the uninitiated, CRDTs [(Conflict-Free Replicated Data types)](https://en.wikipedia.org/wiki/Conflict-free_replicated_data_type) are fancy programming tools which let multiple users edit the same data at the same time. They let you work locally with no lag. (You don't even have to be online). And when you do sync up with other users & devices, everything just magically syncs up and becomes eventually consistent. The best part of CRDTs is that they can do all that without even needing a centralized computer in the cloud to monitor and control everything."],[3591,564,""],[3656,1,""],[3656,0," "],[4464,118,""],[4468,1,""],[4467,1,""],[4466,1,""],[4465,1,""],[4464,1,""],[4647,1,""],[4647,0,"\n\nBut "],[4653,1,""],[4653,0,"m"],[4712,6,""],[4712,0,". "],[4714,1,""],[4714,0,"A"],[4648,0,"\n"],[4648,0,"\n"],[4648,1,""],[4647,1,""],[5195,0,"\n\n\n"],[2058,42,""],[2058,0,"Even talking about this we"],[2082,0,"stuff "],[2591,2,""],[2591,0,"somebody's"],[2602,14,""],[2602,0,"code"],[2992,4,""],[2992,0,"Years ago I"],[3375,3,""],[3375,0,"a"],[4215,241,""],[4215,0,"I want Google Docs without google. I want my apps to seamlessly share data between all my devices, without me needing to rely on some [flakey startup](https://ourincrediblejourney.tumblr.com/)'s servers to still be around in another decade."],[4215,424,""],[4215,0,"I want Google Docs without google. I want my apps to seamlessly share data between all my devices, without me needing to rely on some [flakey startup](https://ourincrediblejourney.tumblr.com/)'s servers to still be around in another decade. I think they're the [future of collaborative editing](https://josephg.com/blog/crdts-are-the-future/). And maybe the future of all software - but I'm not ready to talk about that yet."],[5189,1,""],[5188,1,""],[5187,1,""],[2591,8,""],[2591,0,"some academic"],[2649,4,""],[2649,0,"teach"],[5895,0,"\n"],[56432,0," "],[56432,1,""],[56432,0," "],[56432,1,""],[35738,0,"Aside: "],[35738,7,""],[35927,0," "],[35927,1,""],[35927,0," I'm so curious!"],[56585,0,"\n[Discuss on HN](https://news.ycombinator.com/item?id=28017204)"],[56594,0,"ion"],[56601,2,""],[56601,0,"Hacker News"],[56596,1,""],[56595,1,""],[56594,1,""],[56593,1,""],[56593,0,"s"],[56587,9,""],[56587,0,"O"],[56587,1,""],[56587,0,"Discuss o"],[56657,1,""],[56586,0,"\n"],[56658,9,""],[56587,0,"<footer>\n"],[56667,1,""],[56596,0,"\n"],[56668,41,""],[56597,0,"[2021 Seph Gentle](https://josephg.com/)\n"],[56709,1,""],[56638,0,"\n"],[56710,59,""],[56639,0,"[https://github.com/josephg/](https://github.com/josephg/)\n"],[56769,1,""],[56698,0,"\n"],[56770,0,"\n"],[56700,7,""],[56700,0,"W"],[56700,1,""],[56700,0,"See al"],[56769,0,"\n"],[56698,1,""],[56768,0,"\n[https://github.com/josephg/](https://github.com/josephg/)"],[56639,59,""],[56709,0,"\n"],[56638,1,""],[56708,0,"\n[2021 Seph Gentle](https://josephg.com/)"],[56597,41,""],[56667,0,"\n"],[56596,1,""],[56666,0,"\n<footer>"],[56587,9,""],[56657,0,"\n"],[56586,1,""],[56768,1,""],[56587,9,""],[56587,0,"S"],[56587,1,""],[56587,0,"And lots "],[56587,9,""],[56587,0,"Read feedback on"],[56587,6,""],[56587,0,"F"],[56587,1,""],[56587,0,"Read f"],[56587,6,""],[56587,0,"F"],[56595,0," is"],[56587,0,"Lots of "],[56587,23,""],[56587,0,"Comments on "],[16813,1,""],[16834,1,""],[27613,10,""],[27613,0,"s"],[20654,1,""],[20698,0,"t"],[20698,1,""],[20698,0,"n"],[20698,1,""],[0,0,"Automerge is too slow and clunky. Martin (its principle architect and programmer) recorded himself typing an academic paper. Running his editing history through automerge (his own code) takes 490 seconds, which is a bit less than 10 minutes. Once processed, the editing trace sits on 1.1 GB of RAM. The newly merged performance branch (designed to fix a lot of these problems) is even slower - taking 750 seconds (12.5 minutes) to process the same editing trace.\nI managed to get that 10 minute time down to 70ms (0.07 seconds). Thats the best result I've ever gotten from optimization work, and I'm delighted by it. Let me tell you what I did!\nWhat does automerge do?\nBefore we can go into detail about how I made automerge fast, we have to spend a moment talking about how automerge itself works.\nAn automerge document is actually a tree of inserted characters. Each character in the document has the following properties:\nA unique ID, made up of a tuple of (client ID, sequence number)\nThe ID (or a pointer to) its parent item, which is the item directly before that character when it was inserted.\nThe character itself ('A')\nThere's a couple more fields (eg to mark when characters have been deleted), but essentially thats it. When a character is inserted in the document, automerge figures out the ID of the character immediately before the new character, and inserts the new character as one of its predecessor's *children*. If you just type a linear sequence of characters (as I'm doing right now), you'll end up with a big long chain of characters going down like a linked list.\nSo why is automerge so slow?\nWhen optimizing, I imagine myself manually doing all the work the computer is doing, one step at a time. Then I imagine asking: \"When I get bored, how would I speed this job up?\".\nAutomerge is slow for 3 main reasons:\nIts written in javascript and uses complex data structures. Javascript is reasonably fast for math, but slow and inefficient when using complex data structures.\nAutomerge uses a complex and inefficient data structure\nAutomerge makes extremely heavy use of immutablejs\nEach of these issues accounts for about an order of magnitude slowdown in performance. You can see all 3 issues showing up in this method from the automerge source tree, which is called on each keystroke. Automerge uses this method to figure out where each new character should be placed in the resulting document:\nfunction insertionsAfter(opSet, objectId, parentId, childId) {\n  let childKey = null\n  if (childId) childKey = Map({opId: childId})\n\n  return opSet\n    .getIn(['byObject', objectId, '_following', parentId], List())\n    .filter(op => op.get('insert') && (!childKey || lamportCompare(op, childKey) < 0))\n    .sort(lamportCompare)\n    .reverse() // descending order\n    .map(op => op.get('opId'))\n}\nWhats wrong with this method?\nThis method allocates all over the place. I can spot 5 allocations, not counting any extra nonsense immutablejs is doing. The call to List() has no effect as far as I can tell from reading immutablejs's documentation.\nThe document is always kept in a sorted order anyway, so the calls to sort() and reverse() are unnecessary. The algorithm only needs to figure out where the new child should be inserted. Re-sorting all children is entirely avoidable. Sort functions are often fast when the input is sorted already, but in this case because the sorting function is inverted, the computer always has to sort the entire list.\nYou can't tell from looking at this method, but insertionsAfter \nDespite CRDTs being the \"new hotness\" in the collaborative editing game for years, I've been resisting them. As I said in my [recent blog post about CRDTs](https://josephg.com/blog/crdts-are-the-future/), they've been generally unworkable for real world collaborative editing because:\nThey take up too much space on disk and in memory. (Automerge takes 1.1GB in RAM to store a 100kb document)\nThey consume way too much CPU to process edits\nUntil these issues are addressed, I can't recommend CRDTs for use in general computing.\n"],[0,0,"\n\n\n\n"],[0,0,"A few years ago I was really bothered by an academic paper. Some graduate students in "],[65,21,""],[65,0,"resera"],[70,1,""],[69,1,""],[68,1,""],[68,0,"earchers in France put together a comarison"],[104,0,"p"],[104,1,""],[105,0,"p"],[112,0," showing lots of ways o"],[134,1,""],[134,0,"CRDT and OT algorithms could be implemented to allow for concurrent editing, and they benchmarks"],[229,1,""],[229,0,"ed them."],[236,0," all"],[241,0," Their paper made "],[242,17,""],[242,0,"Lots of people I knew"],[242,4,""],[242,0,"A bunchof"],[250,1,""],[249,1,""],[266,0," all sent me linke"],[283,1,""],[283,0,"s to the paper asking what I thought"],[241,0," I'd stopped working on Google Wave a few years ab"],[290,1,""],[289,1,""],[289,0,"before and I was knee deep reimplementing ShareJS (a javascript library for collabo"],[371,1,""],[370,1,""],[370,0,"borative eidint"],[384,1,""],[383,1,""],[382,1,""],[381,1,""],[380,1,""],[380,0,"diting) using one o t"],[400,1,""],[399,1,""],[399,0,"f"],[241,1,""],[241,0,"\n\n"],[241,0," Some alori"],[251,1,""],[250,1,""],[249,1,""],[249,0,"gort"],[252,1,""],[252,0,"ithms worked reasonably well. And others"],[282,1,""],[281,1,""],[280,1,""],[280,0,". A"],[292,0," took upwards of 30mx"],[312,1,""],[312,0,"s "],[310,0,"0"],[315,0,"to handle a simple copy+paste operation."],[318,7,""],[318,0,"process "],[335,5,""],[281,4,""],[281,0," But"],[281,4,""],[281,0," And"],[309,5,""],[309,0,"3 seconds"],[354,0," from one of their real world editing sesion"],[397,1,""],[396,1,""],[395,1,""],[395,0,"sions"],[401,0,"\n\nWhich algorithm was that? I"],[429,1,""],[429,0,"Mine. Well, I didn't invent it - but it was the algorithm I was using for ShareD"],[508,1,""],[508,0,"JS"],[133,57,""],[129,4,""],[129,0,"algorithms"],[129,10,""],[129,0,"way yo"],[134,1,""],[133,1,""],[132,1,""],[132,0,"s you could implement"],[172,0," (with CRDT and OT algorithms)"],[394,0," Yikes!"],[394,1,""],[394,0,"\n\n"],[403,1,""],[403,0," "],[403,1,""],[402,1,""],[402,0," "],[429,0,"Well, it was "],[442,1,""],[442,0,"m"],[448,5,""],[448,0,"I mean,"],[525,0," "],[525,1,""],[525,0,". The algorithm we used for Google Wave"],[275,3,""],[275,0,"But"],[323,8,""],[322,1,""],[322,0," simple"],[345,0,"s"],[351,7,""],[358,10,""],[357,1,""],[376,1,""],[375,1,""],[375,0," "],[382,1,""],[382,0,"\n\n"],[545,0,". The algorithm I knew for a fact didn't take 3 seconds to process large paste events. What was going on?\n\nI lo"],[652,4,""],[652,0,"Luckily "],[652,8,""],[652,0,"I took a closer look ad"],[674,1,""],[674,0,"nd it seemed like it was amateur hour in thier im"],[715,8,""],[715,0,"their implementation. "],[652,85,""],[652,0,"I took a closer look and it seemed like it was amateur hour in their implementation."],[637,0,"on earth "],[637,9,""],[736,0," When a large past even"],[754,1,""],[755,0," e"],[760,0,"t happened, instead of inserting one block of text, their algorithm was "],[818,10,""],[818,0,"code "],[827,0,"taking each character"],[839,0,"inserted "],[857,0," one by one and inserted"],[880,1,""],[879,1,""],[879,0,"ing them"],[839,48,""],[839,0,"new character one by one and inserte"],[874,1,""],[874,0,"ing them inti"],[886,1,""],[886,0,"o their obviou"],[894,6,""],[894,0,"ca"],[895,1,""],[895,0,"razy lsow "],[900,5,""],[900,0,"slow data structure. Gah - "],[926,1,""],[925,1,""],[925,0,"~ this isn't a problem"],[920,0," I mean, yeah- "],[934,1,""],[933,1,""],[933,0," - of course it'll be slow if you do that! But"],[980,1,""],[980,0,"g"],[1006,0," with the algorithm. Thisis"],[1032,1,""],[1031,1,""],[1031,0," is a "],[1016,9,""],[1016,0,"approach"],[1036,0,"problem withi "],[1049,1,""],[1048,1,""],[1048,0," *your code*."],[742,1,""],[742,0,"a user pasted a block fo "],[766,1,""],[765,1,""],[764,1,""],[764,0,"fo c"],[767,1,""],[766,1,""],[765,1,""],[764,1,""],[764,0,"of code"],[771,27,""],[758,0,"big "],[762,5,""],[762,0,"chunk"],[798,17,""],[798,0,"that stron"],[807,1,""],[806,1,""],[806,0,"ing in one operatoin"],[825,1,""],[824,1,""],[823,1,""],[823,0,"ion"],[771,4,""],[771,0,"text"],[797,0," all of that content"],[817,12,""],[834,1,""],[901,4,""],[901,0,"each one"],[920,6,""],[775,0," (say, 1000 characters)"],[821,22,""],[821,0,"those 1000 characters in"],[875,55,""],[875,0,"splitting each character"],[899,4,""],[904,0," its own edit"],[917,26,""],[917,0,"ing operation. They were processing 1000 operations rather than 1 and"],[1058,39,""],[1058,0,"isn't science. You just wrote"],[1087,18,""],[1089,4,""],[1089,0,"bad"],[1099,0," I can't le"],[1100,10,""],[1100,0,"That doesn't tell us anything about what you're trying to test. It just tells us something about *you*."],[811,15,""],[811,0,"creating 1 operation with"],[852,23,""],[852,0,", their"],[864,4,""],[873,1,""],[872,1,""],[871,1,""],[870,1,""],[870,0," the insert into"],[886,24,""],[886,0," 10000"],[891,1,""],[891,0," operations - each with its"],[910,30,""],[910,0,"which needed to p"],[926,1,""],[926,0,"be processed separately"],[950,56,""],[1010,3,""],[1009,1,""],[1010,6,""],[1010,0,"we can't learn anything from that"],[1043,15,""],[1043,0,"!"],[1034,0,"about the algorithm "],[1064,0," "],[1064,1,""],[1006,58,""],[1006,0,"This isn't a problem with thei"],[1035,1,""],[1034,1,""],[1034,0,"e algorithm. This is just a problem with"],[1074,15,""],[1074,0," your"],[1075,0,"*"],[1080,5,""],[1086,0," mr researcher"],[1086,14,""],[1081,0,"dodgy "],[1093,104,""],[1093,0," I wouldn't mind so much if people I "],[1121,0,"I didn't have people I respected"],[1153,9,""],[1153,0," reading the paper and asking me about it."],[1093,1,""],[1093,0,"\n\n"],[1153,1,""],[1152,1,""],[1153,7,""],[1153,0,"flipping throuhg"],[1168,1,""],[1167,1,""],[1166,1,""],[1166,0,"ugh"],[1203,0,"\n\n"],[1204,1,""],[1203,1,""],[1202,1,""],[1202,0,". Argh!\n\nWhen we think about CRDTs and other concurrenting"],[1259,1,""],[1258,1,""],[1257,1,""],[1257,0," editing "],[1247,19,""],[1247,0,"collaborative editing sytst"],[1273,1,""],[1272,1,""],[1271,1,""],[1271,0,"se"],[1272,1,""],[1272,0,"tems we have  a"],[1286,1,""],[1285,1,""],[1285,0,"a problem with words. We describe each system as an \"algorithm\" - but really there's two things going on"],[1374,0,"very separate "],[1388,6,""],[1388,0,"parts"],[1393,9,""],[1393,0,":\n\n1. The semantics of the system, which we can describe "],[1426,24,""],[1426,0,". When concurrent edits happen in the same place, how d"],[1480,1,""],[1480,0,"can we tell? What "],[1476,22,""],[1476,0,"what happens?"],[1474,0," in the document"],[1497,8,""],[1497,0,"ho"],[1497,2,""],[1497,0,"happens? How does it know? How does it resolve it"],[1544,2,""],[1544,0,"the situation?"],[1403,0,"*"],[1413,0,"*"],[1413,1,""],[1413,0,"*"],[1413,1,""],[1413,0," "],[1413,1,""],[1413,0,"*"],[1471,6,""],[1471,0,"locatoin "],[1479,1,""],[1478,1,""],[1477,1,""],[1476,1,""],[1476,0,"ion "],[1510,18,""],[1545,0,"\n\n2."],[1548,1,""],[1547,1,""],[1546,1,""],[1546,0,"2. The *implementatoin "],[1568,1,""],[1567,1,""],[1566,1,""],[1565,1,""],[1565,0,"ion* of the system. What langue"],[1595,1,""],[1595,0,"a"],[1595,1,""],[1595,0,"age? What data structures? "],[1621,1,""],[1598,0," are we using"],[1634,0," How well optimized is it, for "],[1661,4,""],[1661,0,"and for what scenarios?\n\nIf the semantics are correct"],[1707,7,""],[1707,0,"incorrect, users' edits won't converge. I'll end up looing "],[1765,1,""],[1764,1,""],[1763,1,""],[1762,1,""],[1762,0,"king at a different fr"],[1783,1,""],[1782,1,""],[1782,0,"ver"],[1685,100,""],[1684,1,""],[1684,0,"\n\n"],[1209,0," No! Stop it!"],[1300,18,""],[1300,0,"language problem"],[1433,0,"concurrent editing "],[1603,4,""],[1603,0,"that"],[1607,6,""],[1606,1,""],[1605,1,""],[1604,1,""],[1603,1,""],[1602,1,""],[1601,1,""],[1600,1,""],[1599,1,""],[1702,0,"My text OT algorithm from a few years ago"],[1702,0,"I've implemented "],[1719,3,""],[1719,0,"plain-"],[1743,20,""],[1743,0,"in a bunch of different languages "],[1776,1,""],[1776,0," - I use it as a way to guage"],[1800,5,""],[1800,0,"get a sense of a language w"],[1826,1,""],[1826,0,"I want to learn"],[1724,1,""],[1724,0," "],[1732,10,""],[1719,0,"a simple "],[1741,0," algorithm"],[1786,1,""],[1785,1,""],[1785,0,"."],[1849,0,". "],[1785,66,""],[1785,0,", because I got curious what it would look l"],[1814,15,""],[1814,0,"the same code would look like in C, and Javascript, and Typescript, and"],[1870,15,""],[1870,0,"swif"],[1870,4,""],[1870,0,"Swift and Go and ru"],[1870,10,""],[1879,0,"st"],[1877,1,""],[1877,0,"R"],[1881,0,". Same algorithm"],[1883,14,""],[1883,0,"The same "],[1883,9,""],[1883,0,"Its the same algorithm in each place. The transform"],[1700,0,"\n\nWhen we say a system is "],[1716,10,""],[1715,1,""],[1715,0,"n \"O"],[1718,1,""],[1717,1,""],[1716,1,""],[1716,0," \"algorithm\" is slow, what are we even talking about?"],[1771,4,""],[1771,0,"I"],[1771,0,"A few years ago "],[1801,1,""],[1801,0,"th"],[1801,2,""],[1801,0,"a"],[1869,7,""],[1869,0,"after"],[1874,6,""],[1874,0,"g "],[1875,1,""],[1874,1,""],[1874,0," getting"],[1896,3,""],[1896,0,"the"],[1898,1,""],[1898,0,"at"],[1900,5,""],[1921,3,""],[1921,0," translated into"],[1974,51,""],[1974,0,"The semantics are the same. The performance was absolutely not. In javs"],[2044,1,""],[2044,0,"ascript I could run my transform function abuot"],[2090,1,""],[2089,1,""],[2088,1,""],[2088,0,"out 1000"],[2095,1,""],[2095,0," 000 times per second. Not bad! But the same code"],[2140,4,""],[2140,0,"function in C ran at a rate of 20M/second."],[2154,0,"could "],[2160,16,""],[2160,0,"do"],[2160,3,""],[2160,0,"run "],[2167,0," times"],[2173,1,""],[2173,0," per "],[2185,0," 200x faster. Wow."],[1769,0," Mr "],[1770,3,""],[1769,1,""],[1702,0,"So "],[1705,1,""],[1705,0,"w"],[1705,1,""],[1705,0,"W"],[1704,1,""],[1702,2,""],[1769,0," (I\""],[1772,1,""],[1772,0,"'m looking at *you* mr "],[1794,1,""],[1793,1,""],[1792,1,""],[1792,0,"Mr French Sicn"],[1805,1,""],[1804,1,""],[1803,1,""],[1803,0,"cientist)."],[1802,9,""],[1802,0,"CS Researcher!"],[1819,0,"\nWhen "],[1820,5,""],[1820,0,"Sometimes when I pick up a new language I want to program something I already understand "],[1908,1,""],[1908,0,", in order to get a sense of things. I translated "],[1820,138,""],[1820,0,"Sometimes when I pick up a new language I want to program something I already understand, in order to get a sense of things. I translated"],[1957,31,""],[1957,0," "],[1958,1,""],[1958,0,"my"],[1945,0,"So I "],[1949,1,""],[1948,1,""],[1949,0," ended up"],[1968,1,""],[1967,1,""],[1967,0,"ing"],[1995,9,""],[1995,0,"code into"],[2004,3,""],[2005,101,""],[2006,5,""],[2006,0,","],[2019,4,""],[2022,4,""],[2022,0,","],[2028,0," and Swift"],[2040,26,""],[2040,0,"Same *semantics*"],[2056,1,""],[2056,0,". Same algri"],[2067,1,""],[2066,1,""],[2045,21,""],[2045,0,"algorithm - but"],[2061,1,""],[2061,0,"t"],[2080,11,""],[2084,0," even close"],[2155,3,""],[2154,1,""],[2154,0,"k"],[2154,1,""],[2154,0," 000"],[2244,0," Thats"],[2267,1,""],[2267,0,"!"],[2268,238,""],[2268,0,"\n\nS"],[2270,1,""],[2270,0,"---\n\nso "],[2277,1,""],[2276,1,""],[2275,1,""],[2274,1,""],[2274,0,"\nSo "],[2277,1,""],[2276,1,""],[2275,1,""],[2275,0,"## Automerge\n\nSo as you may n"],[2303,1,""],[2303,0,"know"],[2295,0,"["],[2308,0,"](), I've been playing with "],[2323,13,""],[2323,0,"getting interested in CRDT "],[2349,1,""],[2349,0,"s lately. Most c"],[2364,1,""],[2364,0,"CRDTs are super slow, and I always chalked that up to "],[2399,19,""],[2399,0,"assumed that aw"],[2413,1,""],[2412,1,""],[2412,0,"was some inherent problemw tih t"],[2443,1,""],[2442,1,""],[2441,1,""],[2440,1,""],[2439,1,""],[2438,1,""],[2437,1,""],[2437,0," with \"the algorithm\". ("],[2460,1,""],[2459,1,""],[2458,1,""],[2458,0," (oops). Anyway, surpri"],[2475,6,""],[2475,0,"in a surprising turn of events, I was making the same mistakes as those researchers. I was assuming "],[2566,9,""],[2566,0,"reading papers talkin g"],[2588,1,""],[2587,1,""],[2587,0,"g about he"],[2596,1,""],[2595,1,""],[2595,0,"the *semantics* and assm"],[2618,1,""],[2618,0,"uming that meant those algorithms needed to be implemented a certain way. A slow way. Because the algorithm"],[2712,0,"\""],[2726,0," is slow\". But I was so wrong.\n\n"],[2757,1,""],[2756,1,""],[2213,5,""],[2212,1,""],[2213,3,""],[2213,0,"ran"],[2190,0,"by using a few implem"],[2210,1,""],[2209,1,""],[2209,0,"ementation traic"],[2224,1,""],[2223,1,""],[2222,1,""],[2222,0,"icks, "],[2236,12,""],[2238,0," code"],[2238,5,""],[2236,0," function in"],[2253,1,""],[2252,1,""],[2252,0,"ru"],[2253,1,""],[2252,1,""],[2252,0,"uns i"],[2256,1,""],[2255,1,""],[2251,4,""],[2251,0,"does"],[2251,4,""],[2251,0,"runs"],[2259,6,""],[2259,0," interations"],[2260,11,""],[2260,0,"iterations"],[2306,0,"!"],[2306,1,""],[2412,5,""],[2412,0,"crazy"],[2449,4,""],[2449,0," there was"],[2502,7,""],[2503,0," Oops!"],[2509,40,""],[2511,0,"'ve been"],[2519,4,""],[2631,66,""],[2631,0,"we knew how"],[2639,3,""],[2639,0,"what those "],[2639,11,""],[2639,0,"how those *implementations* should work"],[2680,0,"That is, they should work *slowly* "],[2714,1,""],[2714,0,". But "],[2720,64,""],[2720,0,"it turns out I was super wrong. T"],[2752,1,""],[2751,1,""],[2751,0,"\n\nHow wrong? "],[2763,1,""],[2763,0,"\n"],[2763,1,""],[2763,0," Automerge"],[2764,0,"To run [this editing trace()"],[2791,1,""],[2790,1,""],[2790,0,"](), "],[2804,0," (a popular CRDT) takes 270 seconds. I've "],[2842,4,""],[2842,0," can run the same editing trace"],[2843,0,"have a new e"],[2854,1,""],[2854,0,"implementation that "],[2904,0," in "],[2841,67,""],[2841,0,"I have a new implementation that can run the same editing trace in 65ms"],[2911,1,""],[2910,1,""],[2909,1,""],[2908,1,""],[2908,0,"0.065 seconds."],[2878,3,""],[2878,0,"process"],[2926,0," Well"],[2915,16,""],[2915,0,"32 "],[2917,1,""],[2916,1,""],[2915,1,""],[2915,0,"23 seconds. Thats about 10 000 "],[2945,1,""],[2945,0,"x "],[2941,1,""],[2941,0," "],[2939,8,""],[2939,0,"ten thousand times faster. T"],[2966,1,""],[2965,1,""],[2965,0," Its the largest speed up I've ever gotten from optimization work - and its *delightful*!"],[3053,1,""],[3052,0,"!"],[3037,17,""],[3037,0,"I'm utterly delighted by it."],[2504,0,"Haha w"],[2509,1,""],[2509,0,"awkward"],[2516,5,""],[2516,0," -"],[2504,6,""],[2504,0,"Hah a"],[2625,0," of different algorithms"],[2671,9,""],[2671,0,"anything about how the"],[2725,35,""],[2690,35,""],[2690,0,"to make the *implementations* efficient."],[2670,15,""],[2751,0," Most "],[2752,5,""],[2752,0,"Lots of CS researchers don't"],[2752,8,""],[2752,0,"Actually "],[2776,5,""],[2776,0,"aren't super geniuses who've spent decades thinking"],[2804,0," also*"],[2805,0,"*"],[2834,0," about optimization"],[2841,0,"c"],[2841,1,""],[2841,0,"how you can "],[2864,1,""],[2863,1,""],[2862,1,""],[2861,1,""],[2860,1,""],[2860,0,"e code."],[2751,116,""],[2663,0,"that meant "],[2831,0,", written by [a popular researcher]()"],[2981,5,""],[2981,0,"a"],[2981,2,""],[3006,0," - 10000x (Y"],[3017,1,""],[3016,1,""],[3015,1,""],[3117,0,"\nLets talk about why automerge is slow, and all thes e"],[3170,1,""],[3169,1,""],[3168,1,""],[3168,0," steps tat "],[3178,1,""],[3177,1,""],[3176,1,""],[3176,0,"hat make it fast.\n\nWell actually, lets start with\n\n## What a"],[3235,1,""],[3235,0,"on earth is an automerge?"],[3247,3,""],[3257,0,"\n\n"],[3234,9,""],[3247,0," anyway"],[3257,0,"Automerge is an algorithm"],[3273,0,"implementation of the RGA "],[3299,9,""],[3299,0,"CRDT. S"],[3305,1,""],[3305,0,"Oops that doesn't help. Automerge"],[3270,68,""],[3270,0,"a library to help you do conc"],[3295,4,""],[3295,0,"collaborative editing. Its based on RGA"],[3322,0,"wrt"],[3324,1,""],[3324,0,"itten by Martin Kleppmann, who's a little bit famous from his Book"],[3389,1,""],[3388,1,""],[3387,1,""],[3386,1,""],[3386,0,"book and excellent talks. Its "],[3424,0," an algo"],[3428,4,""],[3427,1,""],[3426,1,""],[3426,0," "],[3426,2,""],[3426,0,"n algorithm called "],[3448,0,", which c"],[3456,1,""],[3456,0,"you can read about in a paper if you're into that sort of thing.\n\nWhen processing"],[3527,10,""],[3527,0,"doing "],[3522,11,""],[3522,0,"C"],[3522,1,""],[3522,0,"Collaborative text editing works by thinking about a string as a list"],[3548,0," in automerge"],[3522,39,""],[3522,0,"Like"],[3525,1,""],[3524,1,""],[3523,1,""],[3522,1,""],[3522,0,"Automerge (and other CRDTs "],[3548,1,""],[3548,0,") think of a st"],[3562,1,""],[3561,1,""],[3560,1,""],[3560,0," shared document as a list of characters. "],[3602,43,""],[3602,0,"When users"],[3602,10,""],[3602,0,"Each inserted item in the document "],[3606,9,""],[3607,4,""],[3607,0,"character"],[3633,0,"is inserted into a "],[3633,19,""],[3633,0,"gets a unique ID ("],[3650,1,""],[3650,0,"based on "],[3650,9,""],[3649,1,""],[3649,0," - which isn't as bad as you think,"],[3657,27,""],[3657,0," we ca"],[3660,3,""],[3657,3,""],[3657,0," isn't as bad as you think,"],[3657,27,""],[3650,7,""],[3649,1,""],[3649,0," based on "],[3649,10,""],[3649,0,", and each insert specifies that it in"],[3682,5,""],[3682,0,"w"],[3667,16,""],[3667,0,"names which"],[3655,0,"whneever"],[3655,8,""],[3655,0,"whenever you "],[3667,1,""],[3666,1,""],[3665,1,""],[3664,1,""],[3664,0,"insert something, you name"],[3690,23,""],[3690,0," what you're inserting after. Eg if I type \"abc\", automerge creates 3 itme"],[3763,1,""],[3763,0,"e"],[3763,1,""],[3762,1,""],[3762,0,"ems:\n\n- Inser "],[3775,1,""],[3775,0,"t 'a' id (seph, 0)`"],[3784,0,"`"],[3795,0," after (ROOT)"],[3807,1,""],[3807,0,"`"],[3802,1,""],[3802,0,"`"],[3768,0,"- Insert 'a' id `(seph, 0)` after `ROOT`\n"],[3819,1,""],[3819,0,"b"],[3833,1,""],[3833,0,"1"],[3844,4,""],[3844,0,"(seph, 0)"],[3809,0,"- Insert 'b' id `(seph, 1)` after `(seph, 0)`\n"],[3865,1,""],[3865,0,"c"],[3879,1,""],[3879,0,"2"],[3897,1,""],[3897,0,"1"],[3900,0,"\n\nHow w"],[3906,1,""],[3906,0,"should you "],[3902,15,""],[3902,0,"How should you"],[2867,0,"https://martin.kleppmann.com/"],[3945,0," represent that? A tree of course!\n\n> Diagram here"],[3961,0," Well, its a "],[3961,13,""],[3930,0,"\n"],[3930,0,"\nLet s"],[3935,1,""],[3934,1,""],[3934,0,"s say  "],[3940,1,""],[3940,0,"I und"],[3944,1,""],[3943,1,""],[3942,1,""],[3942,0,"insert a '"],[3951,1,""],[3950,1,""],[3950,0,"n 'x' between \""],[3964,1,""],[3964,0,"a and b'"],[3970,0,"'"],[3964,0,"'"],[3966,0,"'"],[3966,1,""],[3964,1,""],[3964,0,"*"],[3966,0,"*"],[3974,1,""],[3974,0,"*"],[3973,1,""],[3972,1,""],[3972,0,"*b"],[3975,0,", so I get \"ab"],[3988,1,""],[3988,0,"Xbc\". I get these items:"],[3994,18,""],[3994,0,"Wh"],[3995,1,""],[3994,1,""],[3994,0,"Then we have:\n\n\n- Insert 'a' id `(seph, 0)` after `ROOT`\n- Insert 'b' id `(seph, 1)` after `(seph, 0)`\n- Insert 'c' id `(seph, 2)` after `(seph, 1)`"],[4008,1,""],[4009,0,"- Insert 'a' id `(seph, 0)` after `ROOT`\n"],[4060,1,""],[4060,0,"x"],[4074,1,""],[4074,0,"3"],[4089,0,")"],[4085,0,"("],[4086,4,""],[4086,0,"seph, 0"],[4188,0,"\n"],[4188,0,"\nThis isn't goo"],[4189,14,""],[4189,0,"Note the 'x' and 'b' both "],[4189,26,""],[4189,0,"Note the 'x' and 'b' both"],[4216,65,""],[3930,0,"\n"],[3930,0,"\nHow should you represent that? A tree of course!\n\n> Diagram here\n"],[3995,1,""],[4280,0," insert at the same location. S"],[4310,1,""],[4310,0,"This will happen when c"],[4332,1,""],[4332,0,"usert"],[4336,1,""],[4336,0,"s type in the same location, and we normally compare the item IDs to figure out which in"],[4423,1,""],[4422,1,""],[4416,6,""],[4416,0,"wh"],[4365,53,""],[4364,1,""],[4363,1,""],[4338,4,""],[4338,0,"concurrently type"],[4376,0,"."],[4281,27,""],[4281,0,"share the samer"],[4295,1,""],[4295,0," parent"],[4313,0," sometimes"],[4380,1,""],[4380,0,", and we can resolve that by comparing their item IDs. But not in this case! In this case I "],[4471,1,""],[4470,1,""],[4470,0,"my new item should "],[4470,19,""],[4470,0,"no matter what the IDs are we should always end up with \"a"],[4019,1,""],[4019,0,"X"],[4126,1,""],[4126,0,"X"],[4005,2,""],[4005,0," Mike"],[4017,0,"s"],[4050,1,""],[4050,0,"we"],[4064,0," "],[4064,1,""],[4139,7,""],[4139,0,"mike, 0"],[4443,4,""],[4443,0," we don't want to do that"],[4496,0,"*"],[4511,0,"*"],[4496,1,""],[4510,1,""],[4554,0,"Xbc\". RGA solves this by adding more information"],[4586,16,""],[4586,0,"a sequ"],[4588,4,""],[4587,1,""],[4587,0,"n extra item to "],[4586,17,""],[4586,0,"a tiny bit more data to each item. "],[4260,361,""],[4260,0,"Note the 'x' and 'b' both share the same parent. This will sometimes happen when users concurrently type in the same location, and we can resolve that by comparing their item IDs. But we don't want to do that in this case! In this case no matter what the IDs are we should always end up with \"aXbc\". RGA solves this by adding a tiny bit more data to each item."],[4587,0,"n extra integer"],[4602,19,""],[4615,1,""],[4615,0,","],[4615,1,""],[4615,0," call "],[4620,1,""],[4620,0,"ed a *sequence number*:"],[4644,0,"\n- Insert 'a' id `(seph, 0)` after `ROOT`\n- Insert 'X' id `(mike, 0)` after `(seph, 0)`\n- Insert 'b' id `(seph, 1)` after `(seph, 0)`\n- Insert 'c' id `(seph, 2)` after `(seph, 1)`\n"],[4685,0,", seq: 0*"],[4692,0,"*"],[4741,0,", seq: *0*"],[4797,0,", seq: *0*"],[4853,0,", seq: *0*"],[4805,1,""],[4805,0,"1"],[4861,1,""],[4861,0,"2"],[4749,1,""],[4749,0,"3"],[4642,1,""],[4642,0,". I"],[4644,1,""],[4643,1,""],[4642,1,""],[4642,0,":"],[4865,0,"Automerge's *semantics* are:\n\n- Everything goes after its"],[4913,9,""],[4913,0,"right after itse "],[4929,1,""],[4928,1,""],[4928,0," parent"],[4897,38,""],[4897,0,"Imagine the tree"],[4897,16,""],[4897,0,"Build the tree\n- If "],[4912,5,""],[4912,0,"- If"],[4911,0," from each item to its parents, all the way up."],[4963,0," two items have"],[4961,17,""],[4961,0,"Whenever you h"],[4970,5,""],[4970,0,"an item has children, put all the "],[4959,45,""],[4959,0,"- Whenever an item has children, put all the"],[4864,0,"\n"],[4864,0,"\nYjs"],[4865,3,""],[4865,0,"This isn't the only approach. Yjs solves this by "],[4865,49,""],[4864,1,""],[4863,1,""],[4911,0,", connecting"],[4923,5,""],[4947,18,""],[4970,0," multiple"],[4990,11,""],[4990,0,"sort them first by sequence number then by ID.\n\n"],[5037,0,"- The list "],[5047,1,""],[5047,0,"'s value is "],[5047,12,""],[5047,0," is whatever you get from flattening the tree with a depth-first so"],[5113,1,""],[5113,0,"earch."],[5111,8,""],[5111,0," traversal."],[5123,0,"\n"],[4874,0," (RGA)"],[5130,0,"So how should you implement"],[3931,48,""],[3931,0,"We can draw t"],[3943,1,""],[3943,0,"that like a "],[3948,7,""],[3948,0,"as a tree!"],[5127,0,"*"],[5137,0,"* automerge? The automerge library does it in the obvious tree based way. Each time an insert happens, we look up"],[5211,39,""],[5210,1,""],[5210,0," Ac"],[5212,1,""],[5212,0,"t least I think so - "],[5109,124,""],[5109,0,"So how should you *implement* automerge? The automerge library does it in the obvious tree based way. At least I think so - I h"],[5235,1,""],[5235,0,"honestly have"],[5233,15,""],[5233,0,"this is automerges"],[5250,1,""],[5250,0,"'s internal state after typing \"abc\""],[5233,0,"["],[5268,0,"](https://gist.github.com/josephg/0522c4aec5021cc1dddb60e778828dbe)"],[5354,0,". Yikes!"],[5826,0,"\n"],[6009,0,"\n"],[6035,0,"\n"],[6496,0,"\n"],[6956,0,"\n"],[6986,0,"\n"],[7167,0,"\n"],[7206,0,"\n"],[7368,0,"\n"],[7425,0,"\n"],[7477,0,"\n"],[5363,0,"\n\n\n\n\n"],[5364,0,"We "],[5366,1,""],[5365,1,""],[5364,1,""],[5364,0,"For benchmarking, I'm using [Marin"],[5397,1,""],[5396,1,""],[5396,0,"tin's editing trace](https://github.com/automerge/automerge-perf/)"],[5401,0," atuomera"],[5402,8,""],[5402,0,"automerge-perf"],[5477,0,". Martin rec"],[5479,10,""],[5479,0,"This is an editing history where m"],[5512,1,""],[5512,0,"Martin just"],[5518,5,""],[5518,0," recorded each keystroke while writing an academic paper. "],[5575,1,""],[5575,0," How does it do?\n\n"],[5356,6,""],[5356,0,"Yeah, I have no idea whats going on here."],[5356,6,""],[5241,0," ss"],[5243,1,""],[5242,1,""],[5242,0,"*some o"],[5248,1,""],[5247,1,""],[5247,0,"*"],[5247,1,""],[5247,0," of*"],[5250,1,""],[5242,1,""],[5613,15,""],[5612,1,""],[5612,0," How does it do?"],[5622,2,""],[5622,0,"automerge"],[5613,0,"So "],[5616,1,""],[5616,0,"h"],[5639,0,"\nTest"],[5640,0,"| "],[5646,0,"    | Time taken |\n| ------- | ---------- |"],[5665,0,"| ------- | ---------- |\n"],[5692,7,""],[5692,0,"automerge"],[5704,10,""],[5704,0,"26"],[5705,1,""],[5705,0,"70s"],[5232,0," after typing\""],[5245,1,""],[5245,0," \"abc\""],[5362,19,""],[5612,0," There's no concurrent edits in this trace (its just a single user), but its "],[5688,1,""],[5687,1,""],[5686,1,""],[5685,1,""],[5685,0,"concurrent edits "],[5685,17,""],[5685,0,"thats probably fine for now."],[5714,25,""],[5714,0,"As I said before, automerge takes a little under 5 minutes to process this editing trace:"],[5802,1,""],[5802,0,". I'm also going to in c"],[5825,1,""],[5824,1,""],[5824,0,"clude a simple baseo"],[5843,1,""],[5843,0,"line comparison, where we just splice() "],[5874,0,"use javascripts'"],[5889,1,""],[5888,1,""],[5888,0,"'s "],[5874,26,""],[5874,0,"create a javascript s"],[5959,0,"@ 1.0.0-preview2 "],[5704,8,""],[5705,0," Users typing "],[5712,7,""],[5712,0,"concurrently typing in the same location is super rare anyway."],[5774,1,""],[5774,0,"\n\n"],[5957,0,"tring and split"],[5971,1,""],[5963,0,"in the obvious way "],[5990,0,"ce into it:"],[6053,0,"| automerge @ 1.0.0-preview2 | 270s |\n"],[6084,3,""],[6084,0,"291"],[6122,3,""],[6093,26,""],[6093,0,"baseline"],[6093,0,"JS "],[6107,0,"0.61"],[6010,0,"                   "],[6056,0," "],[6056,1,""],[6056,0,"-------------------"],[6143,0,"               "],[6165,0,"     "],[6127,0,"      "],[6180,0,"### Why is atuomer"],[6191,7,""],[6191,0,"automerge slow?"],[6179,0,"\n"],[6208,0,"\nA"],[6209,1,""],[6209,0,"Automerge is slow for 3 reasons:\n\n1. Automerge uses "],[6256,5,""],[6256,0,"makes heavy use of immutable.js. Immutablejs is a library which gives you closure-like "],[6333,1,""],[6333,0,"j"],[6343,0,"semantis "],[6351,1,""],[6350,1,""],[6350,0,"cs in javascript"],[6352,3,""],[6352,0," for"],[6367,0," objects"],[6343,0,"copy-on-write "],[6389,0,". The "],[6391,4,""],[6391,0,"This is a cool set of functionality, but the optimizer *hates* this"],[6446,12,""],[6446,0,"gets"],[6436,0,"v8 "],[6436,1,""],[6436,0,"V"],[6453,0," really confused by immutablejs and it dramatics "],[6501,1,""],[6500,1,""],[6500,0,"ally decreases "],[6504,0," "],[6492,13,""],[6492,0,"increases memory usage and"],[6529,0,"performance\n2. Automerge'"],[6540,0,"."],[6555,0,"d "],[6556,1,""],[6555,1,""],[6555,0,"s data structures"],[6571,1,""],[6571,0,"s aren't very good."],[6449,35,""],[6449,0,"has no idea how to optimize immutablejs"],[6477,0,"code that makes heavy use of "],[6517,0,"."],[6518,4,""],[6518,0," As a result, "],[6531,1,""],[6448,0," & GC"],[6602,36,""],[6602,0," needs to do a lot of data "],[6628,1,""],[6623,5,""],[6620,3,""],[6616,4,""],[6614,2,""],[6611,3,""],[6608,3,""],[6602,6,""],[6602,0,"'s data structures aren't very good."],[6602,36,""],[6602,0," uses the wrong data structure for RGA (!!)"],[6632,0,"s"],[6633,8,""],[6638,0,"\n3. Atuomerg"],[6642,8,""],[6642,0,"Automerge is s"],[6655,1,""],[6655,0,"written "],[6639,24,""],[6639,0,"3. Automerge is written"],[6231,2,""],[6231,0,"a handful of "],[6663,10,""],[6663,0,"treats each inserted character as a separate item. Remember that paper I talked about earlier? Automerge makes the same mistake!"],[6790,1,""],[6790,0,".\n\n"],[6792,1,""],[6792,0,"4. Javascript"],[6502,19,""],[6502,0," uses"],[6465,18,""],[6465,0,"struggles to"],[6736,0," "],[6736,1,""],[6736,0,", where copy+paste operations are slow"],[6808,1,""],[6808,0,"!"],[6823,0," just isn"],[6831,1,""],[6831,0,"nn't "],[6835,1,""],[6834,1,""],[6833,1,""],[6832,1,""],[6832,0,"'t very faste "],[6845,1,""],[6844,1,""],[6844,0," anyway"],[6824,27,""],[6823,1,""],[6813,0,"Complex data structures are extra slow because of "],[6873,0,"\n\nYou can see most of these"],[6887,13,""],[6887,0,"some of these issues looking at "],[6887,32,""],[6887,0,"a lot of this stuff o"],[6907,1,""],[6907,0,"going on in this function from automerge:\n\n```javascript\n\n"],[6964,1,""],[6964,0,"function insertionsAfter(opSet, objectId, parentId, childId) {\n  let childKey = null\n  if (childId) childKey = Map({opId: childId})\n\n  return opSet\n    .getIn(['byObject', objectId, '_following', parentId], List())\n    .filter(op => op.get('insert') && (!childKey || lamportCompare(op, childKey) < 0))\n    .sort(lamportCompare)\n    .reverse() // descending order\n    .map(op => op.get('opId'))\n}\n```"],[6924,13,""],[6923,1,""],[6933,0," functoin"],[6941,1,""],[6940,1,""],[6939,1,""],[6939,0,"ion"],[7358,0,"\n\nThis is called on each insert, to figure out how to sort"],[7411,5,""],[7409,2,""],[7409,0,"the children onf"],[7424,1,""],[7423,1,""],[7423,0,"f an item should be sorted."],[6599,4,""],[6594,5,""],[6594,0,"picks the wrong "],[6604,6,""],[6629,0," we'll talk about this soon!"],[6842,60,""],[6842,0,"Javascript"],[6842,10,""],[6842,0,"Complex data structures are extra slow in ajvas"],[6884,5,""],[6884,0,"javascript."],[6894,1,""],[6896,68,""],[6896,0,"Look at this function from automerge:"],[7440,0," There are so many things slow about this:\n\n- There are 5 objects"],[7496,1,""],[7496,0,"6"],[7497,8,""],[7497,0," allocations in this function. Can you"],[7528,0,"("],[7536,0," spot them all?)"],[7485,11,""],[7485,0,"I "],[7486,1,""],[7485,1,""],[7485,0," I can spot "],[7497,1,""],[7497,0,"6"],[7497,1,""],[7497,0,"7"],[7527,0," "],[7527,1,""],[7527,0,". 5 if you don't include the two closures"],[7570,1,""],[7570,0,"("],[7579,4,""],[7579,0,"find"],[7528,41,""],[7528,0," (Though 2 should be hoisted)."],[7530,0,"t"],[7530,1,""],[7536,0," the 2 closures"],[7551,2,""],[7572,1,""],[7594,1,""],[7594,0,")"],[7572,0,"("],[7596,0,"\n- The items are already sorted by lamportCompare"],[7613,8,""],[7637,0," before this method is called"],[7622,0," "],[7622,1,""],[7622,0," the inverse of"],[7681,0,". Sorting a list"],[7596,0,"\n- The List()`"],[7603,0,"`"],[7611,0," argument has no effect"],[7621,0,"to `getO"],[7628,1,""],[7628,0,"In`"],[7597,47,""],[7596,1,""],[6909,8,""],[6909,0,"code in"],[6916,5,""],[6914,2,""],[6914,0,"r"],[6914,1,""],[6914,0,"from"],[6944,0,"\nfunction lamportCompare(op1, op2) {\n  return opIdCompare(op1.get('opId'), op2.get('opId'))\n}\n"],[7702,0," already"],[7717,19,""],[7717,0," -"],[7733,0,")"],[7733,1,""],[7733,0,"()"],[7718,0,"reverse-"],[7725,1,""],[7741,1,""],[7740,1,""],[6207,0,"\n\nwheneve"],[6209,7,""],[6209,0,"Whenever"],[6209,8,""],[6209,0,"The p"],[6209,5,""],[6209,0,"My philosophy with performance tuning"],[6209,37,""],[6209,0,"There's an old saying with performance tuning: "],[6255,1,""],[6255,0,"\n\n> You can't make a program faster. You can only make it do less work."],[6209,119,""],[6895,0,"\n\n"],[6896,0,"There"],[6896,6,""],[6895,1,""],[6209,0,"There's an old saying with performance tuning:\n\n> You can't make a program faster. You can only make it do less work.\n\n"],[6209,119,""],[6895,0,"\nThere's an old saying with performance tuning:\n\n> You can't make a program faster. You can only make it do less work.\n\n"],[7014,1,""],[7014,0,"\nSo we wan"],[7018,6,""],[7018,0,"how do we make the computer *do *"],[7050,1,""],[7049,1,""],[7046,3,""],[7046,0,"do l"],[7049,1,""],[7048,1,""],[7047,1,""],[7046,1,""],[7046,0,"c"],[7046,1,""],[7046,0,"do all the work of "],[7049,16,""],[7049,0,"less work here?\n"],[7066,0,"T"],[7066,1,""],[7066,0,"Exhibit A: Take a look "],[7089,5,""],[7116,1,""],[7116,0,":"],[7729,0,"*"],[7744,0,"*"],[7718,0," I don't know how hot it is, but"],[7751,1,""],[7751,0,"t"],[8007,0," is "],[8003,8,""],[8002,1,""],[8002,0,"n anti-sorted list is slow"],[8024,4,""],[8024,0,"the slowest sort. You could easily just"],[8042,21,""],[8042,0,"The code could easily just swap the j"],[8078,1,""],[8035,0," way to"],[8047,0," anything"],[8058,36,""],[8058,0,"Rather than sorting, then reverse()'ing, this could j"],[8110,1,""],[8109,1,""],[8104,5,""],[8104,0,"code should just invert the arguments of `lamportCompare` (or negat e"],[8172,1,""],[8171,1,""],[8171,0,"e the return value)."],[8141,3,""],[8141,0," in"],[8161,0,", or make "],[8162,9,""],[8161,1,""],[8191,0,"\n- The goal is to insert the new item into the list"],[8194,0,"If "],[8197,1,""],[8197,0,"t"],[8244,1,""],[8244,0,"t, you can do that with a for loop."],[8263,0,"much faster "],[8237,3,""],[8237,0,"an already sorted"],[8296,0,"single "],[8194,4,""],[8194,0,"T"],[8216,4,""],[8216,0,"a "],[8254,1,""],[8254,0,"."],[8256,1,""],[8256,0,"Y"],[8291,7,""],[8300,0,"\n- This code wrapped"],[8319,1,""],[8318,1,""],[8317,1,""],[8317,0,"s childId with "],[8327,5,""],[8327,0,"into a "],[8333,1,""],[8333,0,"n immutablejs Map, just so the argument matches lamportCompare`"],[8381,0,"`"],[8397,0," - which just "],[8406,5,""],[8406,0,"unwraps it again. "],[8423,1,""],[8423,0," This work is all avoidable."],[8440,0," computat"],[8440,9,""],[8453,0,"\n\n\n"],[8405,0," then"],[8429,27,""],[8429,0,"Don't do that!"],[8429,0,"Nooo! "],[8435,14,""],[8435,0,"Stopp"],[8439,1,""],[8439,0,"!!!"],[8441,1,""],[8440,1,""],[8440,0,"\n\n### "],[8445,1,""],[8445,0,"# Alg"],[8447,3,""],[8447,0,"Data structures\n\n"],[8441,0,"\n"],[8465,0,"But the much bigger reason"],[8465,26,""],[8465,0,"The biggest reason atu"],[8486,1,""],[8485,1,""],[8485,0,"utomerge is slow is that"],[2504,3,""],[2504,0,"But this is"],[2581,1,""],[2581,0,"!"],[2782,0," Super wrong."],[2796,6,""],[2796,0,"Running"],[2927,3,""],[2927,0,"291"],[3031,0," over"],[3066,1,""],[3066,0,"2"],[3067,1,""],[3067,0,"5"],[3067,1,""],[3067,0,"6"],[3067,1,""],[3066,1,""],[3066,0,"26"],[3067,1,""],[3067,0,"7"],[6259,0," whole slew"],[6270,8,""],[6924,0,"\n\nReally, it was just never written wtih "],[6964,1,""],[6963,1,""],[6962,1,""],[6961,1,""],[6961,0,"ith performance in mind."],[8556,44,""],[8556,0,"But all this is window dressing. The real read"],[8601,1,""],[8601,0,"so"],[8556,47,""],[8556,0,"The first"],[8556,0,"But the real"],[8568,3,""],[8574,0," thing to fix here is the a"],[8560,41,""],[8560,0,"this is all a big distraction. The big "],[8598,1,""],[8598,0,"gest thing to fi i"],[8615,1,""],[8614,1,""],[8614,0,"x is the algorithm. Th"],[8635,1,""],[8634,1,""],[8633,1,""],[8632,1,""],[8603,0,"and first "],[8633,0,"core "],[8647,0," & data stru"],[8658,1,""],[8658,0,"cu"],[8659,1,""],[8658,1,""],[8658,0,"ucture. "],[8638,12,""],[8654,0,"In automerge"],[8654,12,""],[8654,0,"Automerge seems to store a bunch of nested lists, but there's a better way to do this."],[6688,0,"\n1. Automerge makes heavy use of immutable.js. Immutablejs is a library which gives you clojure-like copy-on-write semantics for javascript objects. This is a cool set of functionality, but the V8 optimizer & GC struggles to optimize code that uses immutablejs. As a result, it increases memory usage and decreases performance."],[6284,328,""],[6284,0,"1"],[6362,1,""],[6362,0,"2"],[7156,0,"\n\n\n\n"],[7157,0,"\n"],[7157,0,"\n"],[7157,1,""],[7157,0,"The most important"],[7157,18,""],[7157,0,"i"],[7157,1,""],[7157,0,"With this sort of thing the first step always has"],[7181,25,""],[7181,0,"we always have to start with macro optimizations. As in "],[7231,6,""],[7231,0,"And in this case, the biggest problem is Automerge"],[7272,9,""],[7272,0,"automerge's complex tree based data structure.\n\nI wish I could take credit for this insight. Kevin Jahns - who wrote a "],[7390,1,""],[7390,0," ("],[7391,1,""],[7390,1,""],[7390,0,"nohter ("],[7389,9,""],[7389,0,"another (much better) CRDT"],[7320,95,""],[7320,0,"There's a better "],[7320,17,""],[7320,0,"The first change"],[7318,0," Complex data structures are "],[7319,28,""],[7318,1,""],[7336,0," we'll make here is replacing Automer"],[7366,7,""],[7366,0,"automerge's tree with a list. So instead of:\n\n```\n\n\n```"],[7416,0,"state = {\n  \n  "],[7426,2,""],[7427,2,""],[7427,0,"}"],[7428,1,""],[7426,0,"  {i"],[7429,1,""],[7429,0,"\n    "],[7432,2,""],[7430,2,""],[7429,1,""],[7429,0," item: 'a', children:"],[7441,0,"id, seq, "],[7459,0," [\n    \n    "],[7462,4,""],[7463,4,""],[7463,0,"  ]}"],[7426,0,"  { item: 'a', id, seq, children: [\n"],[7464,0,"  "],[7475,1,""],[7475,0,"b"],[7462,0,"    { item: 'b', id, seq, children: [\n"],[7504,0,"  "],[7515,1,""],[7515,0,"c"],[7540,0,"      ]"],[7500,47,""],[7500,0,"      { item: 'c', id, seq, children: [ ]"],[7539,1,""],[7540,0,"}\n      "],[7542,6,""],[7542,0,"    ])"],[7547,1,""],[7547,0,"}"],[7409,0," somethingl ike"],[7423,1,""],[7422,1,""],[7421,1,""],[7420,1,""],[7419,1,""],[7419,0," like"],[7253,19,""],[7264,0," biggest problem is its"],[7324,0,"So "],[7327,1,""],[7327,0,"t"],[7563,0,"\n      { item: 'c', id, seq, children: []}"],[7563,0,"\n    { item: 'b', id, seq, children: ["],[7484,44,""],[7484,0,"    "],[7437,0,"javascript"],[7507,1,""],[7507,0,"X"],[7533,0,","],[7632,0,"\n\nWe'll put all the items in a single flat list:"],[7682,0,"```javascript\nstate = {\n  { item: 'a', id, seq, children: [\n    { item: 'X', id, seq, children: []},\n    { item: 'b', id, seq, children: [\n      { item: 'c', id, seq, children: []}\n    ]}\n  ]}\n}\n```\n"],[7704,1,""],[7704,0,"["],[7875,1,""],[7875,0,"]"],[7730,11,""],[7730,0,"parent"],[7730,6,""],[7730,0,"children: ["],[7849,11,""],[7849,0,"p"],[7809,11,""],[7809,0,"p"],[7768,11,""],[7768,0,"p"],[7730,11,""],[7730,0,"p"],[7820,0,"a"],[7790,0,"a"],[7759,0,"a"],[7731,0,"a"],[7824,0,"r"],[7793,0,"r"],[7761,0,"r"],[7732,0,"r"],[7828,0,"e"],[7796,0,"e"],[7763,0,"e"],[7733,0,"e"],[7832,0,"n"],[7799,0,"n"],[7765,0,"n"],[7734,0,"n"],[7836,0,"t"],[7802,0,"t"],[7767,0,"t"],[7735,0,"t"],[7840,0,":"],[7805,0,":"],[7769,0,":"],[7736,0,":"],[7844,0," "],[7808,0," "],[7771,0," "],[7737,0," "],[7847,1,""],[7810,1,""],[7772,1,""],[7737,1,""],[7843,1,""],[7807,1,""],[7770,1,""],[7736,1,""],[7840,0," "],[7805,0," "],[7769,0," "],[7736,0," "],[7844,0,"}"],[7808,0,"}"],[7771,0,"}"],[7737,0,"}"],[7773,3,""],[7809,6,""],[7809,0,"    "],[7774,4,""],[7774,0,"  "],[7739,4,""],[7739,0,"  "],[7805,4,""],[7805,0,"  "],[7840,12,""],[7475,0,": {}"],[7478,1,""],[7477,1,""],[7477,0,"[]"],[7478,0,"'seph', 0"],[7493,0,": 0"],[7529,0,": [..]"],[7576,0,": [..]"],[7622,0,": [..]"],[7872,1,""],[7871,1,""],[7772,0,","],[7806,0,","],[7840,0,","],[7874,0,","],[7874,1,""],[7324,25,""],[7324,0,"Ther's a"],[7331,1,""],[7330,1,""],[7329,1,""],[7328,1,""],[7328,0,"e's a better way "],[6332,28,""],[7127,0," There's lots of performance wins to be had, but"],[7175,3,""],[7175,0," w"],[7200,17,""],[7200,0,"its always best to"],[7249,0,", since the mmicr"],[7257,9,""],[7257,0,"there's no point optimizing code you might be about to throw out anyway"],[7330,5,""],[7330,0,"I"],[7419,0,"Luckily, "],[7428,1,""],[7428,0,"t"],[7449,0,"to implement CRDTs which we can steal from Yjs - "],[7492,6,""],[7492,0,"mt "],[7494,1,""],[7493,1,""],[7493,0,"y favorite CRDT implementation - Yjs. Yjs "],[7467,0,". I wish I could claim I invented this, b"],[7469,39,""],[7468,1,""],[7467,1,""],[7467,0,", which we can see in my favorite CRDT "],[7506,42,""],[7520,0,":"],[7521,2,""],[7531,0,"make a "],[7537,1,""],[7536,1,""],[7535,1,""],[7535,0,"s a clever, obvious trick that"],[7565,83,""],[7565,0," I don't think anyone else noticed. Instead of implementing the CRDT as a tree like this:"],[7890,5,""],[7890,0,"Yjs"],[7897,0,"s"],[7925,5,""],[7986,0,": null"],[8026,0,": null"],[8031,1,""],[8030,1,""],[8029,1,""],[8028,1,""],[7973,0,": ['seph', 0]"],[8041,0,"['seph', 0]"],[8086,0,": ['seph', 0]"],[8133,0,": ..."],[8137,1,""],[8136,1,""],[8135,1,""],[8134,1,""],[8134,0," [..]"],[8148,0,"\nYjs implements a different"],[8152,0," actually does a few things differently. It"],[8207,11,""],[8207,0,"lg"],[8208,1,""],[8207,1,""],[8207,0,"a different CRDT (so d"],[8228,1,""],[8228,0,"it has different semantics)"],[8254,0," than RGA"],[8244,0,", b"],[8246,1,""],[8246,0,"slight"],[8244,8,""],[8234,0," slightly"],[8273,0,". But"],[8275,3,""],[8275,0,"And it uses a linked list, "],[8301,1,""],[8300,1,""],[8300,0," instead of an array, but we're jumping ahead."],[8149,0,"(Actually "],[8162,9,""],[8346,1,""],[8346,0,"!)\n\n"],[7527,0,"Yhs"],[7529,1,""],[7528,1,""],[7528,0,"hs does"],[7527,8,""],[7527,0,"Yjs doesn't need a whole blog post about how to make it faster because its alreadt "],[7609,1,""],[7608,1,""],[7608,0,"y fast. It got there by using"],[7637,9,""],[7995,0,"just "],[8302,0," also"],[8335,50,""],[8411,0,"The question is, how do you insert a new item into a list like this? With automerge the anse"],[8502,1,""],[8502,0,"wer is:\n\n- Find t"],[8511,1,""],[8511,0,"1."],[8520,0,"he parent item\n2. Add"],[8538,3,""],[8538,0,"Find"],[8538,4,""],[8538,0,"Add the new item to the parents' children in the approp"],[8587,6,""],[8587,0,"right spot\n\nWt"],[8600,1,""],[8600,0,"ith the list approach"],[8253,0,"\n\nSo, put the"],[8255,11,""],[8254,1,""],[8253,1,""],[8621,0," its:\n\n1. Find the parent item\n2. Scan "],[8655,5,""],[8655,0,"Skip over items"],[8655,0,"Iterate through the list, "],[8681,1,""],[8681,0,"s"],[8685,0,"ping"],[8700,0," whih "],[8705,1,""],[8704,1,""],[8704,0,"ch should om"],[8715,1,""],[8714,1,""],[8714,0,"come before t"],[8726,1,""],[8726,0,"the new item\n3. Insert"],[8538,3,""],[8538,0,"Insert"],[8557,3,""],[8557,0," into"],[8576,8,""],[8576,0,"list of children"],[8761,0," it there\n\nBasically we're doing an insertion sort."],[8788,5,""],[8788,0,"implementing"],[8801,2,""],[8801,0,"a fancy"],[8824,0,"\n\n\n\n"],[6841,55,""],[6840,1,""],[8731,0," going to replace Automerge's tree"],[8777,1,""],[8776,1,""],[8775,1,""],[8775,0,"ation with"],[8554,0,"\n3.W"],[8557,1,""],[8557,0," Walk up the tree to figure out the in"],[8593,2,""],[8593,0,"positional insert location"],[8555,64,""],[8554,1,""],[8554,0,"\n3. Walk up the tree to figure out the positional insert location"],[8589,30,""],[8589,0,"where we're actually inserting"],[8589,30,""],[8589,0,"the index where we're actually inserting"],[8555,74,""],[8554,1,""],[8695,0," ("],[8696,1,""],[8695,1,""],[8810,0,"\nThis code sounds complex, but its"],[8841,3,""],[8841,0,"it ends up being about 20 lines of code, ri"],[8883,1,""],[8882,1,""],[8882,0,"written using "],[8890,6,""],[8890,0,"in long form"],[8882,0,"["],[8903,0,"]"],[8903,1,""],[8903,0," here](https://github.com/josephg/reference-crdts/blob/fed747255df9d457e11f36575de555b39f07e909/crdts.ts#L401-L459). This code"],[9020,9,""],[8811,209,""],[8811,0,"This code sounds complex, but it ends up being about 20 lines of code, [written in long form here](https://github.com/josephg/reference-crdts/blob/fed747255df9d457e11f36575de555b39f07e909/crdts.ts#L401-L459)."],[8731,9,""],[8726,5,""],[8726,0,"I'm prompo"],[8735,1,""],[8734,1,""],[8733,1,""],[8733,0,"posii"],[8737,1,""],[8737,0,"ng"],[8746,1,""],[8746,0,"ing"],[8750,1,""],[8750,0,"a"],[8821,23,""],[8817,4,""],[8812,5,""],[8812,0,"You can write the whole algorithm"],[8836,9,""],[8836,0,"implementation"],[8850,15,""],[8850,0," in "],[8836,14,""],[8836,0,"insertion"],[8844,1,""],[8843,1,""],[8842,1,""],[8842,0," function"],[8877,1,""],[8877,0,"."],[8880,25,""],[8880,0,"Or 50 lines "],[8891,1,""],[8891,0," if you want to be v"],[8904,7,""],[8904,0,"com"],[8892,15,""],[8891,1,""],[8891,0," if I feel like it. You're not the boss of me."],[8810,0," The semantics are the same, the implementation is different."],[8810,61,""],[9050,0,"This implem"],[9055,6,""],[9055,0,"is semantically the same"],[9058,0,"*"],[9071,0,"*"],[9048,0,"\n\nThe beauti"],[9059,1,""],[9058,1,""],[9057,1,""],[9057,0,"utiful thing"],[9050,19,""],[9050,0,"There's a few beautiful things about this approach:\n\n1. You can implement C"],[9124,1,""],[9124,0,"Yjs, Automerge and Sync9 an"],[9138,4,""],[9138,0,","],[9148,0,"d other semantics in the same codebase. That github project ha"],[9188,22,""],[9188,0,"My [reference-crdts](https://github.com/josephg/reference-crdts) project implements all 3 of those algorithms using the same "],[9297,16,""],[9297,0,", just "],[9299,5,""],[9299,0,"mostly just swapping out the insert function."],[9334,0," (integrate)"],[9356,0,"\n2. Its faster\n3. "],[9371,3,""],[9370,1,""],[9360,10,""],[9360,0,"This is semant"],[9368,6,""],[9357,12,""],[9357,0,"2. This is "],[9357,43,""],[9357,0,"2. This is This is *semantically* the same"],[9360,8,""],[9383,8,""],[9383,0,"identical to the real automerge. (I checked with a fuzzer)"],[9426,0," it"],[9444,0,".T"],[9445,1,""],[9445,0," "],[9360,4,""],[9360,0,"Even though this implementation is di"],[9396,1,""],[9395,1,""],[9395,0,"very differe,"],[9407,1,""],[9407,0,"nt, this"],[9497,0,"So is"],[9500,2,""],[9500,0,"are the "],[9497,11,""],[9496,1,""],[9416,2,""],[9416,0,"approach"],[9449,22,""],[9482,0,"\n\n\n\n---"],[9484,0,"\n\n\n"],[9482,0,"\n| Test                       | Time taken |\n| -------------------------- | ---------- |\n| automerge @ 1.0.0-preview2 | 291s       |\n| JS baseline                | 0.61s      |\n\n"],[9481,0,"\nHow much better?"],[9588,0,"| automerge @ 1.0.0-preview2 | 291s       |\n"],[9634,9,""],[9634,0,"reference-crdts"],[9650,17,""],[9650,0,"           "],[9663,3,""],[9663,0,"31"],[9664,1,""],[9663,1,""],[9663,0,"31"],[9666,0," "],[9498,0," It tak"],[9499,6,""],[9499,0,"About 10"],[9506,1,""],[9506,0,"0x better."],[9497,0," is this approach"],[9685,10,""],[9685,0,"(automerge / yjs)"],[9686,10,""],[9686,0,"AM "],[9686,3,""],[9686,0,"automerge "],[9491,7,""],[9491,0,"faster "],[9526,6,""],[9526,0,"faster"],[9533,0," Its also much more em"],[9554,1,""],[9553,1,""],[9553,0,"memory-efficient and smaller."],[9569,13,""],[9569,0,"."],[9615,44,""],[9572,0,"| -------------------------- | ---------- |\n"],[9659,44,""],[9616,0,"| automerge @ 1.0.0-preview2 | 291s       |\n"],[9703,0,"\n| automerge @ 1.0.0-preview2 | 291s       |"],[9616,44,""],[9659,0,"\n| -------------------------- | ---------- |"],[9572,44,""],[9689,0," "],[9645,0," "],[9601,0," "],[9692,0," "],[9647,0," "],[9602,0," "],[9695,0," "],[9649,0," "],[9603,0," "],[9698,0," "],[9651,0," "],[9604,0," "],[9701,0," "],[9653,0," "],[9605,0," "],[9704,0," "],[9655,0," "],[9606,0," "],[9707,0," "],[9657,0," "],[9607,0," "],[9804,0,"       "],[9772,1,""],[9763,0,"  "],[9712,0,"  "],[9712,1,""],[9723,1,""],[9773,1,""],[7361,0,"\n\n\n### Algorithmic improvements"],[7379,0," / data structure"],[7368,28,""],[7368,0,"Improving the data structure"],[7396,13,""],[9391,0,"\n3. "],[9394,1,""],[9393,1,""],[9392,1,""],[9392,0,"2. When there are no concurrent edits in tha tlo"],[9439,1,""],[9438,1,""],[9437,1,""],[9436,1,""],[9436,0,"t location, you don't have to iterate "],[9395,79,""],[9395,0,"You almost always just insert atht"],[9428,1,""],[9427,1,""],[9427,0," the "],[9425,7,""],[9425,0,"right afte t"],[9436,1,""],[9435,1,""],[9435,0,"r the parent item."],[9395,0,"Concurrent inserts int he same"],[9414,11,""],[9414,0,"in the same location are super rare in practice, and "],[9461,5,""],[9461,0,". So"],[9466,1,""],[9466,0,"y"],[9524,0," Although this algorithm has a (linear time) loop, its almost"],[9575,10,""],[9575,0,"the loop gets ex"],[9584,7,""],[9584,0,"is almost never l"],[9600,1,""],[9600,0,"does anything."],[9600,13,""],[9600,0,"runs"],[9605,0," This makes it fast!"],[9606,4,""],[9606,0,"I"],[9606,1,""],[9606,0,"So its"],[9612,9,""],[9612,0," really"],[9624,0," in practice"],[8647,0,"Starting right after the parent item, "],[8685,1,""],[8685,0,"i"],[8709,1,""],[8709,0,"."],[8711,8,""],[8711,0,"Skip"],[8709,55,""],[8709,0," until we find the location the new item should be inserted"],[9799,0,"\n"],[9676,1,""],[9676,0,"3"],[9800,0,"4. Its neat! Use a list to implement a list? Genius!"],[9811,0," and obvious"],[9811,12,""],[9843,0," CR"],[9813,33,""],[9813,0,"Implement a list CRDT with a list"],[9855,0,"!"],[9945,1,""],[9945,0,", though I'm not measure "],[9969,1,""],[9968,1,""],[9968,0,"ing that here."],[6901,0," Or memory usage - th"],[6921,1,""],[6921,0,"hat simple editing trace con"],[6946,3,""],[6946,0,"makes "],[6920,32,""],[6920,0,"running this simple tra"],[6940,3,""],[6940,0,"editing trace in automerge consumes 1.6"],[6978,1,""],[6978,0,"7GB of ram "],[6988,1,""],[6988,0,"!!"],[6989,1,""],[6953,0," to produce a 100lb"],[6971,1,""],[6970,1,""],[6970,0,"h"],[6970,1,""],[6970,0,"kb document"],[6981,13,""],[7296,1,""],[7296,0,"."],[7298,5,""],[7298,0,"After all,"],[7364,16,""],[7364,0,"delete"],[7004,0," Holy cow!"],[7308,12,""],[7308,0,"T"],[7371,0,"\n"],[7135,236,""],[7135,0,"So how do we make the computer do less work here? There's lots of performance wins to be had, but with this sort of thing its always best to start with macro optimizations. There's no point optimizing code you might be about to delete."],[7371,0,"\n"],[7459,0," And I "],[7460,6,""],[7459,1,""],[10338,0,"Well, it"],[10344,2,""],[10344,0,"the performance improvement"],[10344,0,"some of "],[10379,0,"s might also come from the fact I'm not using automerge"],[10425,9,""],[10425,0,"immutablejs "],[10338,99,""],[10338,0,"Well, some of the performance improvements might also come from the fact I'm not using immutablejs"],[10338,7,""],[10338,0,"S"],[10430,0," here"],[10409,0,"also "],[10435,5,""],[10435,0,". But"],[10439,1,""],[10438,1,""],[10437,1,""],[10436,1,""],[10438,0,"\n\n"],[10438,0,"\n#### "],[10443,1,""],[10442,1,""],[10442,0," Micro optimizations for the win"],[10462,12,""],[10462,0,"\n\nNow we've covered the macro optimizations and picked our sem"],[10521,3,""],[10521,0,"data structure, there's another big prob"],[10473,88,""],[10473,0," go"],[10475,1,""],[10474,1,""],[10473,1,""],[10472,1,""],[10471,1,""],[10471,0,"re using the right algorithm in our implementation, we have a new hotspot in performance: Findingth"],[10569,1,""],[10568,1,""],[10568,0," the location to insert.\n\nThis "],[10594,5,""],[10594,0,"My reference-C"],[10607,1,""],[10607,0,"crdts implementation "],[10594,34,""],[10594,0,"My reference-crdts implementation"],[6993,1,""],[6992,1,""],[6991,1,""],[6991,0,"880"],[6994,2,""],[6994,0,"MB"],[6971,1,""],[6970,1,""],[6970,0,"KB"],[7014,0," Thats nearly as much ram as "],[7014,29,""],[7014,0," The document isn't even very big!"],[7014,0," Thats neraly "],[7021,7,""],[7021,0,"nearly as much as slack."],[7015,30,""],[7015,0,"~"],[7015,1,""],[7015,0,"Thats nearly as much as slack."],[7015,0,"``"],[7016,1,""],[7015,1,""],[7015,0,"~~"],[7047,0,"~~"],[7048,1,""],[7047,1,""],[7047,0,"--"],[7047,2,""],[7047,0,"~~"],[10662,0,"\n"],[10662,0,"\nSo imagine the user types an 'a' in the middle of the document (at position 50000"],[10743,1,""],[10743,0,"). "],[10663,83,""],[10663,0,"So imagine the user types an 'a' in the middle of the document (at position 5000)."],[10746,1,""],[10745,1,""],[10745,0," "],[10779,0," needs to find "],[10663,131,""],[10663,0,"So imagine the user types an 'a' in the middle of the document (at position 5000). My reference-crdts implementation needs to find"],[10662,0,"\n"],[10662,0,"\n```javascript\nstate = [\n  { item: 'a', id: ['seph', 0], seq, parent: null },\n  { item: 'X', id, seq, parent: ['seph', 0] },\n  { item: 'b', id, seq, parent: ['seph', 0] },\n  { item: 'c', id, seq, parent: [..] }\n]\n```"],[10662,0,"\nSo we have a document like this:\n"],[10663,0,"Including "],[10663,10,""],[10694,0,", now"],[10694,5,""],[10694,0,". ("],[10696,1,""],[10696,0,"Oh, it also has del"],[10708,7,""],[10708,0,"marks which items are deleted"],[10684,10,""],[10684,0,", which is a list of items"],[10712,2,""],[10712,0,"And"],[10715,4,""],[10715,0," we're"],[10731,1,""],[10731,0,"ing"],[10758,1,""],[10758,0,", like this:"],[10758,12,""],[10758,0,":"],[10837,47,""],[10785,0,"  { item: 'X', id, seq, parent: ['seph', 0] },\n"],[10884,0,"\n  { item: 'X', id, seq, parent: ['seph', 0] },"],[10785,47,""],[10947,0,"i"],[10900,0,"i"],[10853,0,"i"],[10800,0,"i"],[10951,0,"s"],[10903,0,"s"],[10855,0,"s"],[10801,0,"s"],[10955,0,"D"],[10906,0,"D"],[10857,0,"D"],[10802,0,"D"],[10959,0,"e"],[10909,0,"e"],[10859,0,"e"],[10803,0,"e"],[10963,0,"l"],[10912,0,"l"],[10861,0,"l"],[10804,0,"l"],[10967,0,"e"],[10915,0,"e"],[10863,0,"e"],[10805,0,"e"],[10971,0,"t"],[10918,0,"t"],[10865,0,"t"],[10806,0,"t"],[10975,0,"e"],[10921,0,"e"],[10867,0,"e"],[10807,0,"e"],[10979,0,"D"],[10924,0,"D"],[10869,0,"D"],[10808,0,"D"],[10982,1,""],[10926,1,""],[10870,1,""],[10808,1,""],[10979,0,"d"],[10924,0,"d"],[10869,0,"d"],[10808,0,"d"],[10983,0,":"],[10927,0,":"],[10871,0,":"],[10809,0,":"],[10987,0," "],[10930,0," "],[10873,0," "],[10810,0," "],[10991,0,"f"],[10933,0,"f"],[10875,0,"f"],[10811,0,"f"],[10995,0,"a"],[10936,0,"a"],[10877,0,"a"],[10812,0,"a"],[10999,0,"l"],[10939,0,"l"],[10879,0,"l"],[10813,0,"l"],[11003,0,"s"],[10942,0,"s"],[10881,0,"s"],[10814,0,"s"],[11007,0,"e"],[10945,0,"e"],[10883,0,"e"],[10815,0,"e"],[11011,0,","],[10948,0,","],[10885,0,","],[10816,0,","],[11015,0," "],[10951,0," "],[10887,0," "],[10817,0," "],[11114,0,"in ra rea"],[11122,1,""],[11121,1,""],[11120,1,""],[11119,1,""],[11118,1,""],[11117,1,""],[11117,0,"a real document, this "],[11114,25,""],[11114,0,"at like, "],[11123,3,""],[11186,0," which item in th e"],[10947,5,""],[10947,0,"true"],[10952,0," "],[10711,4,""],[10711,0," Oh, and unlike above"],[10712,20,""],[10712,0,"I didn't mention this above but"],[10743,6,""],[10743,0," we"],[10751,0," need"],[10752,4,""],[10751,1,""],[10758,1,""],[10757,1,""],[10756,1,""],[11209,18,""],[11209,0,"the "],[11209,4,""],[11209,0,"where to insert"],[11204,20,""],[11204,0,"correlate that position with a list item, so we can figure out:\n\n- Where t"],[11277,1,""],[11271,6,""],[11271,0,"What our new"],[11276,7,""],[11276,0,"the new item's parent should be\n- and then where the new item will be inserted"],[11342,0," actually"],[11355,8,""],[11355,0,"spliced in"],[11367,0,"My im"],[10660,1,""],[10660,0,", "],[10661,1,""],[10660,1,""],[10660,0,"."],[10601,0," few"],[10610,7,""],[10609,4,""],[10621,0," hotspots"],[10662,1,""],[10662,0,", and inserting"],[10668,0,"actually "],[10686,0,"."],[11398,0,"lementat"],[11396,10,""],[11396,0,"implementation does a linear scan through the document to find this location. Its a for() loop. we "],[11494,1,""],[11493,1,""],[11492,1,""],[11492,0,"We count all the not-deleted items until "],[11473,0," That sounds fancy - but "],[11498,4,""],[11498,0,"its"],[11557,0,"we've counted past 10"],[11577,1,""],[11576,1,""],[11576,0,"5000 items which aren't deleted and return the index "],[11628,1,""],[11623,0,"resulting "],[11638,0," (eg"],[11641,1,""],[11640,1,""],[11639,1,""],[11638,1,""],[11638,0,". E"],[11640,1,""],[11640,0,"(Eg 555"],[11646,1,""],[11646,0,"000"],[11648,1,""],[11647,1,""],[11646,1,""],[11645,1,""],[11644,1,""],[11638,6,""],[11638,0," - which will be bi"],[11638,19,""],[11638,0,". If 1000 items have been deleted"],[11648,5,""],[11648,0,"characters"],[11676,0," before position 5000, the index position might be 6000."],[11494,3,""],[11493,1,""],[11505,0,"`"],[11500,0,"`"],[11730,0," But unfor"],[11731,9,""],[11731,0,"Unfortunately for us, this is "],[11393,368,""],[11393,0,"My implementation does a linear scan through the document to find this location. That sounds fancy - its a `for()` loop. We count all the not-deleted items until we've counted past 5000 items which aren't deleted and return the resulting index. If 1000 characters have been deleted before position 5000, the index position might be 6000. Unfortunately for us, this is"],[11474,21,""],[11474,0,"I"],[11474,0,"Which means, I use"],[11492,3,""],[11480,5,""],[11480,0,"is to say"],[11706,8,""],[11705,1,""],[11700,0,"destination "],[11732,30,""],[11097,0,"\nLets imagine the document has 1000"],[11131,1,""],[11131,0," 000 items in it, and the"],[11156,15,""],[11226,0," 0"],[11379,0,", and"],[11387,10,""],[11387,0,"W"],[11393,0,"in the list "],[11379,0," (o"],[11381,1,""],[11380,1,""],[11380,0,"(its the id of the preceeding item!)"],[11414,1,""],[11381,4,""],[11381,0,"we need "],[11510,0," th"],[11512,1,""],[11511,1,""],[11510,1,""],[11510,0,"this with "],[11505,15,""],[11505,0,"implements this with "],[11560,22,""],[11665,0,"0"],[11663,0," "],[11781,0,"0 "],[11731,0,"0 "],[11823,0," 0"],[11828,0," This is l"],[11837,1,""],[11837,0,"pretty slow"],[11829,19,""],[11829,0,"Javascript's optimizer will do what ic "],[11867,1,""],[11866,1,""],[11866,0,"t can, but this is always going to be slow.\n\nThen "],[11911,5,""],[11911,0,"Then th"],[11917,1,""],[11916,1,""],[11916,0,"after we've found the new location, we need to splice it in:\n\n```javascript\ndoc.content.splice(destIdx, 0, newItem)\n```\n\n"],[12011,7,""],[12011,0,"60000"],[12011,5,""],[12011,0,"destIdx"],[12031,0," // inser"],[12031,9,""],[12037,0,"If the array currently has 1000 "],[12068,1,""],[12067,1,""],[12067,0," 000 items, javs"],[12082,1,""],[12082,0,"ascript (conceptually) needs"],[12090,20,""],[12043,0," list use"],[12051,1,""],[12050,1,""],[12049,1,""],[12049,0,"is implme"],[12057,1,""],[12056,1,""],[12049,7,""],[12048,1,""],[12043,5,""],[12043,0," "],[12043,1,""],[12090,0,"needs to move every item from position 60 000 forward by one space. (Well, if javascript uses an array for lists. "],[12203,1,""],[12202,1,""],[12197,5,""],[12193,4,""],[12193,0,"internally for lists. Who knows what it actually does - v8 is complex!)"],[12247,1,""],[12246,1,""],[12246,0," -"],[12157,0," This is also slow."],[12178,7,""],[12178,0,"This is assuming"],[12194,1,""],[12206,0,"actually "],[12244,0,"its "],[10631,1,""],[10631,0,"\n- "],[10633,1,""],[10632,1,""],[10632,0,"\n- "],[10666,1,""],[10665,1,""],[10665,0,"\n- "],[10665,0," and"],[10672,5,""],[10672,0,"A"],[10690,0," into the array"],[10705,1,""],[10788,18,""],[10788,0,"some of those"],[10808,3,""],[10808,0,"have been"],[10825,0,", "],[10826,1,""],[10825,1,""],[10808,5,""],[10808,0,"might also have "],[11120,0,",\n  ..."],[11323,4,""],[11323,0,"tihs"],[11326,1,""],[11325,1,""],[11324,1,""],[11324,0,"his"],[11353,1,""],[11353,0,"."],[11355,9,""],[11355,0,"We need to"],[11363,2,""],[11363,0,"thi"],[11365,1,""],[11365,0,"e index to"],[11367,0,"this "],[11372,6,""],[11431,9,""],[11431,0,"copy the "],[11269,0," We need to figure out"],[11281,10,""],[11281,0,"first create a new item - and for that we need to know what its parent"],[11331,20,""],[11331,0,"figure out what its p"],[11331,21,""],[11331,0,"copy its parent ID from the item "],[11331,33,""],[11331,0,"figure out what its parent should be."],[11368,117,""],[11368,0," And then when we insert, we need to find that parent in th elis"],[11431,1,""],[11430,1,""],[11429,1,""],[11428,1,""],[11427,1,""],[11427,0,"e list and splice i"],[11445,1,""],[11444,1,""],[11444,0," the new item in."],[11461,147,""],[11461,0,"\n"],[11490,1,""],[11490,0,"does"],[11481,13,""],[11481,0,"does"],[11490,5,""],[11490,0," using"],[11510,21,""],[11510,0,", "],[11511,1,""],[11510,1,""],[11560,4,""],[11626,6,""],[11626,0,"haven't been"],[11780,1,""],[11780,0,"\n\n"],[11862,0," O(n) slow."],[11863,0,"*"],[11868,0,"*"],[12144,7,""],[12144,0,"Well,"],[12219,35,""],[12219,0,"V"],[12225,0,"really "],[12243,0,"So each time"],[12243,12,""],[12243,0,"Each time we insert, we need to take as"],[12281,1,""],[12281,0,"bout as amny "],[12289,5,""],[12289,0,"many steps "],[12275,25,""],[12275,0,"loop"],[12275,4,""],[12275,0,"take about as many steps as there are i"],[12313,1,""],[12313,0,"characters in the document. Well, characters which have *ever been* in the document (s"],[12398,1,""],[12398,0,"because "],[12396,10,""],[12396,0,". So the lon"],[12398,10,""],[12398,0,"This isn't just slow. Its slow and getting slower."],[10512,19,""],[10512,0,"Fixing linear time"],[10512,18,""],[10512,0,"Removing scanning"],[12447,0,"\n\nYjs "],[12449,4,""],[12448,0,"Thei"],[12451,1,""],[12450,1,""],[12450,0,"ere's a few solutions to this, but lets start with the obvious"],[12505,7,""],[12505,0,"simplest: Replacing the array with a linked list.\n\nThis has a few benefits:\n\n- "],[12582,2,""],[12582,0,"-"],[12505,78,""],[12505,0,"simplest: Replacing the array with a linked list.\n\nThis has a few benefits:\n\n-"],[12514,0," To find an "],[12525,1,""],[12524,1,""],[12523,1,""],[12515,8,""],[12515,0,"Wehn item"],[12515,9,""],[12515,0,"When items are inserted"],[12515,0,"Usually when a human is typing, they don't actually move around the document that much. M"],[12603,1,""],[12602,0," We can cache the last inserted"],[12632,1,""],[12631,1,""],[12631,0," l"],[12625,8,""],[12625,0,"location the user inserted, anad "],[12657,1,""],[12656,1,""],[12655,1,""],[12655,0,"d when they insert again we"],[12681,1,""],[12680,1,""],[12679,1,""],[12679,0,", if they insert close to the old insert"],[12713,6,""],[12713,0,"curor"],[12717,1,""],[12716,1,""],[12716,0,"sor poit"],[12723,1,""],[12722,1,""],[12722,0,"sition we can just track "],[12592,4,""],[12592,0,"very"],[12624,9,""],[12624,0," index and posi"],[12625,14,""],[12625,0,"(index, position) pair where"],[12663,8,""],[12663,0,"typed something"],[12446,0,"\n\n#### Fixy fix fix"],[10593,0,"ca"],[10594,1,""],[10593,1,""],[10593,0,"need to "],[10556,10,""],[10556,0," core data structure"],[10611,36,""],[10611,0,"fix two performance hotspots:"],[10642,1,""],[10642,0,"1."],[10680,1,""],[10680,0,"2."],[11379,93,""],[11281,98,""],[11281,0,"Where on earth is that? "],[11304,1,""],[11304,0," We'll need to scan through the document to fin"],[11344,7,""],[11344,0," (skipping deleted items) to figure out where the new item goes, and what its "],[11413,9,""],[11413,0,"l"],[11413,1,""],[11413,0,"see whats nearby to name its parent.\n\nThats going to "],[11451,15,""],[11451,0,"If they insert at position 50 000, we'll probably have to scan about 60 000 "],[11514,0,"past "],[11532,0,"items to find the insert position! Yikes!\n\nAnd then when we actually insert, we do this:"],[11620,481,""],[11680,0,"\n"],[11680,0,"\nDouble yikes!"],[11694,2,""],[11694,0," "],[11747,0," will"],[11757,1,""],[11772,0,"single "],[11783,0," once space forward."],[11803,63,""],[11803,0," "],[11803,0," Oof"],[11804,3,""],[11804,0,"Its "],[11804,4,""],[11804,0,"This part happens from C++, but stil, "],[11841,1,""],[11840,1,""],[11840,0,"l oof."],[11921,0,", and who knows if thats actually true"],[11960,22,""],[11937,23,""],[11937,0,"whats really going on down there."],[11973,0,"So "],[11976,1,""],[11976,0,"e"],[12005,7,""],[12004,1,""],[11997,2,""],[11997,0,"the computer does"],[12014,5,""],[12076,5,""],[12076,0,"Sorry, as many st"],[12083,10,""],[12082,1,""],[12184,0," Its O(n%"],[12192,1,""],[12192,0,"^2)."],[12185,4,""],[12185,0,"Inserting n characters will take "],[12245,0,"\n"],[12245,0,"\n"],[12246,40,""],[12246,0,"L"],[12245,0,"\n"],[12245,0,"\nWe can fix both of these problems "],[12246,34,""],[12245,1,""],[12244,1,""],[12244,0,"\n\n"],[12246,32,""],[12334,0,"We can solve the scanning problem by "],[12371,7,""],[12375,1,""],[12375,0,"ing"],[12405,0,"*"],[12388,0,"*"],[12427,6,""],[12427,0," edited"],[12444,1,""],[12444,0,"."],[12446,5,""],[12446,0,"W"],[12469,0," we can hope they"],[12486,8,""],[12526,83,""],[12526,0," and just scan a bit forward or backwards from there to fi"],[12583,1,""],[12582,1,""],[12581,1,""],[12580,1,""],[12579,1,""],[12578,1,""],[12578,0,". "],[12579,1,""],[12579,0," This sounds kind of dodgy, but it works great in practice."],[12591,0," a little bit"],[12604,8,""],[12643,0,"\n\nThen we need to insert efficiently. We can do that by"],[12681,17,""],[12681,0,"Well, we can do that by pl"],[12706,1,""],[12705,1,""],[12705,0,"replacing the array with a linked list"],[12732,0,"doubly-"],[12732,7,""],[12743,0,". Its"],[12747,1,""],[12746,1,""],[12745,1,""],[12745,0,"(Its going to have to be a doubly-linked list to "],[12791,3,""],[12791,0,"for the scanning to work).\n\nYjs does these two optimizations "],[12851,1,""],[12851,0," and one bonus optimization: Instead of storing"],[12880,18,""],[12880,0,"U"],[12880,1,""],[12880,0,"Humans also type in runs of characters. Instead of "],[12819,112,""],[12819,0,"Yjs does these two optimizations and one bonus optimization: Humans also type in runs of characters. Instead of typing a "],[12939,1,""],[12937,2,""],[12937,0," a "],[12860,0,"more "],[12892,4,""],[12891,1,""],[12819,121,""],[12819,0,"Yjs does these two optimizations and one more bonus optimization: Humans type in runs of characters. Instead of typing a"],[12938,1,""],[12920,18,""],[12920,0,"If I type \"hello\", instead of storing:\n\n```javascript\nstate = [\n  { item: 'a', isDeleted: false, id: ['seph', 0], seq, parent: null },\n  { item: 'X', isDeleted: false, id, seq, parent: ['seph', 0] },\n  { item: 'b', isDeleted: true,  id, seq, parent: ['seph', 0] },\n  { item: 'c', isDeleted: false, id, seq, parent: [..] },\n  ...\n]\n```\n"],[12995,1,""],[12995,0,"h"],[13066,1,""],[13066,0,"e"],[13131,1,""],[13131,0,"l"],[13196,1,""],[13196,0,"l"],[13185,0,"  { item: 'l', isDeleted: false, id, seq, parent: [..] },\n"],[13254,1,""],[13254,0,"o"],[13301,5,""],[13300,1,""],[13146,4,""],[13146,0,"false"],[13153,1,""],[12984,0,"  { item: 'h', isDeleted: false, id: ['seph', 0], seq, parent: null },\n"],[13118,4,""],[13118,0,"['seph', 1"],[13132,246,""],[13055,0,"  { item: 'h', isDeleted: false, id: ['seph', 0], seq, parent: ['seph', 1 },\n  { item: 'h', isDeleted: false, id: ['seph', 0], seq, parent: ['seph', 1 },\n  { item: 'h', isDeleted: false, id: ['seph', 0], seq, parent: ['seph', 1 },\n"],[13143,1,""],[13143,0,"e"],[13066,1,""],[13066,0,"e"],[13143,1,""],[13143,0,"l"],[13220,1,""],[13220,0,"l"],[13297,1,""],[13297,0,"o"],[13101,1,""],[13101,0,"1"],[13179,0,"2"],[13179,1,""],[13178,1,""],[13178,0,"2"],[13255,1,""],[13255,0,"3"],[13332,1,""],[13332,0,"4"],[13127,1,""],[13127,0,"0]"],[13206,0,"]"],[13283,1,""],[13283,0,"2]"],[13361,1,""],[13361,0,"3]"],[13372,0,"\n\nYjs just stores:"],[13391,0,"\n```javascript\nstate = [\n  { item: 'h', isDeleted: false, id: ['seph', 0], seq, parent: null },\n  { item: 'e', isDeleted: false, id: ['seph', 1], seq, parent: ['seph', 0] },\n  { item: 'l', isDeleted: false, id: ['seph', 2], seq, parent: ['seph', 1] },\n  { item: 'l', isDeleted: false, id: ['seph', 3], seq, parent: ['seph', 2] },\n  { item: 'o', isDeleted: false, id: ['seph', 4], seq, parent: ['seph', 3] },\n]\n```"],[13428,0,"ello"],[13491,312,""],[13497,0,"\n"],[13497,0,"\nAaah much better! This reuc"],[13524,1,""],[13523,1,""],[13523,0,"duces the number of i"],[13543,1,""],[13543,0,"items in the list"],[13515,0," For our benchmark,"],[13535,1,""],[13535,0,"t"],[13579,0," from 180 000 down to about 40 000."],[13615,29,""],[13614,0," And it "],[13498,124,""],[13498,0,"Aaah much better! For our benchmark, this reduces the number of items in the list from 180 000 down to about 40 000. And it"],[6073,0," RAM used"],[6078,4,""],[6078,0,"usage"],[6127,0," --------- "],[6084,54,""],[6084,0,"| -------------------------- | ---------- | ---------"],[6083,0," |"],[6139,0," |"],[6185,0," 880MB     |"],[6241,0,"           |"],[10249,0," RAM usage |"],[10312,0," --------- |"],[10375,0," 880 MB    |"],[10438,0,"           |"],[10501,0,"          |"],[10511,1,""],[10511,0," |"],[13628,4,""],[13628,0,"this "],[13648,0," optimization"],[13623,0," We can't collapse the whole list like this - this io"],[13675,1,""],[13674,1,""],[13674,0,"only works when all the itme"],[13701,1,""],[13700,1,""],[13699,1,""],[13699,0,"i"],[13699,1,""],[13699,0,"tems come one after"],[13704,14,""],[13704,0,"line up  li"],[13714,1,""],[13713,1,""],[13712,1,""],[13712,0,"like this. But"],[13727,1,""],[13727,0,"f"],[13727,20,""],[13776,3,""],[13776,0,"our"],[13819,7,""],[13819,0,"\n\n| Test                              | Time taken | RAM usage |\n| --------------------------        | ---------- | --------- |\n| automerge @ 1.0.0-preview2        |  291s      | 880 MB    |\n| reference-crdts (automerge / yjs) |   31s      |           |\n| JS baseline                       | 0.61s      |           |\n"],[13819,0,"\n\nAnd it performs *great*:"],[14036,0,"| reference-crdts (automerge / yjs) |   31s      |           |\n"],[14101,33,""],[14101,0,"Yjs                              "],[14141,1,""],[14140,1,""],[14139,1,""],[14139,0," 0."],[14141,1,""],[14140,1,""],[14139,1,""],[14138,1,""],[14137,1,""],[14137,0,"0.97s"],[14150,6,""],[14150,0,"3 MB"],[14151,0,".7"],[14152,1,""],[14152,0,"6"],[13844,1,""],[13844,0," - its 30x faster:"],[10441,1,""],[10440,1,""],[10440,0,"23"],[10441,1,""],[10441,0,"7"],[10441,1,""],[10441,0,"8 MB"],[10445,3,""],[14105,5,""],[14105,0,"27"],[14106,1,""],[14106,0,"8 MB"],[13861,1,""],[13861,0," and uses just over 1/10th as much RAM:"],[13821,5,""],[13821,0,"I"],[13604,0,"\n\nBut in a link"],[13606,13,""],[13605,1,""],[13604,1,""],[12931,4,""],[12931,0,"has"],[13622,0," Finally paste events will be fast!"],[13657,1,""],[13657,0,"\n\n"],[13631,0,"those pesky "],[13744,6,""],[13744,0," feilds"],[13750,1,""],[13749,1,""],[13748,1,""],[13747,1,""],[13747,0,"i"],[13747,1,""],[13746,1,""],[13746,0,"ields"],[13759,10,""],[13759,0,". And we'll need so e"],[13779,1,""],[13778,1,""],[13778,0,"me special logic to split items back out if the user later inserts something in the middle of a span li"],[13872,9,""],[13872,0,"oen "],[13875,1,""],[13874,1,""],[13873,1,""],[13873,0,"ne of these spans"],[13896,4,""],[13896,0,"when all is said "],[13912,1,""],[13911,1,""],[13910,1,""],[13909,1,""],[13909,0,"aid and done, this"],[13928,12,""],[13928,0,"trick"],[13928,5,""],[13928,0,"change"],[14011,23,""],[14011,0,"These changes perform great, and "],[14043,1,""],[14042,1,""],[14041,1,""],[14040,1,""],[14039,1,""],[14038,1,""],[14038,0,". The result is"],[14053,2,""],[14068,0," we're using"],[14080,5,""],[14081,9,""],[14081,0,"about"],[14086,20,""],[14086,0," 10% o"],[14091,1,""],[14091,0,"as much RAM:"],[14473,1,""],[14472,1,""],[14472,0,"0.1"],[14471,1,""],[14475,0,"MB"],[14477,2,""],[10451,62,""],[10451,0,"| JS baseline                       | 0.61s      | 0.1 MB    |"],[6198,55,""],[6198,0,"| JS baseline                       | 0.61s      | 0.1 MB    |"],[6233,1,""],[6232,1,""],[6231,1,""],[6230,1,""],[6229,1,""],[6228,1,""],[6227,1,""],[5813,6,""],[5812,1,""],[5885,0," And wow is that - yep, 880MB. "],[5915,1,""],[5914,1,""],[5914,0," of RAM.\n\n"],[7085,44,""],[6981,138,""],[5922,0," Holy cow! ~~Thats nearly as much as slack.~~"],[5923,10,""],[5959,1,""],[6093,0,". Javascript"],[6095,10,""],[6095,0,"V8 is pretty fast!"],[6113,1,""],[6094,19,""],[14368,0,"\n"],[14368,0,"\n### Moving away from JAvascf"],[14390,7,""],[14390,0,"Javascript, and moving away from linked lists\n\nThe next big perfo"],[14437,18,""],[14437,0,"There isn't"],[14437,11,""],[14437,0,"Just "],[14441,1,""],[14440,1,""],[14439,1,""],[14438,1,""],[14438,0,"avascript won't go much faster than this. To improve performance more, we need to start decreasing the number of"],[14437,0,"I'm sad to say it but "],[14501,0," Yjs is very well optimized "],[14528,1,""],[14528,0,","],[14528,1,""],[14528,0," already."],[14536,1,""],[14536,0,", and "],[14541,1,""],[14540,1,""],[14539,1,""],[14538,1,""],[14537,1,""],[14536,1,""],[14536,0,"."],[14538,3,""],[14538,0,"If we want to continue to "],[14584,4,""],[14583,1,""],[14593,33,""],[14592,1,""],[14592,0," the computer to do fewer reads in memory"],[14609,24,""],[14593,16,""],[14593,0,"to pack memory"],[14596,11,""],[14596,0,"make better use of memory.\n\nIn javascript, an object like this:\n\n"],[14660,1,""],[14659,1,""],[14624,15,""],[14624,0,"Imagine "],[14651,0," in javascript"],[14667,0,"\n```\n{ item: 'hello', isDeleted: false, id: ['seph', 0], seq, parent: null }\n```"],[14671,0,"javascript"],[14671,10,""],[14671,0,"json"],[14671,4,""],[14671,0,"javascript"],[14757,0,"\n\nThis object actually looks liek"],[14789,1,""],[14788,1,""],[14788,0,"ke this:\n\n> Diagram..."],[14809,1,""],[14808,1,""],[14807,1,""],[14807,0,"\n\nNote how each "],[14809,14,""],[14809,0,"Note how each"],[14730,1,""],[14730,0,"100"],[14732,1,""],[14748,4,""],[14748,0,"[se"],[14750,1,""],[14749,1,""],[14749,0,"'mike', 2]"],[14830,0," "],[14817,14,""],[14817,0,"Each part of the object"],[14834,6,""],[14834,0,"data structure is separated from the rest"],[14852,23,""],[14852,0,"connected to the rest via pointers. Unforun"],[14894,1,""],[14893,1,""],[14893,0,"tunately, "],[14888,15,""],[14888,0,"In modern computers, following pointere"],[14926,1,""],[14926,0,"s is actually verys "],[14945,1,""],[14944,1,""],[14944,0," slow. If 1 clock cycle was 1 second, following a pointer ("],[14373,62,""],[14373,0,"Better "],[14379,1,""],[14373,6,""],[14373,0,"Moving away from Javascript, and moving away from linked lists"],[14930,9,""],[14930,0," realy"],[14935,1,""],[14935,0,"ly"],[14937,5,""],[14946,0," the computer t"],[14947,14,""],[14944,3,""],[14944,0,"If the computer did"],[14978,3,""],[14978,0,"every"],[15015,0,"doing "],[14994,27,""],[14994,0,"reading data from main memory would take"],[14984,2,""],[15032,0," a few minutes."],[15039,8,""],[15035,4,""],[15035,0,"couple of minutes"],[15035,0,"["],[15053,0,"](https://gist.github.com/hellerbarde/2843375). "],[14817,284,""],[14817,0,"Each part of the data structure is connected to the rest via pointers. In modern computers, following pointers is really slow. If the computer did 1 clock cycle every second, reading data from main memory would take a [couple of minutes](https://gist.github.com/hellerbarde/2843375)."],[14816,0,"\n"],[14816,0,"\nThis is awful for the computer."],[14817,5,""],[14817,0,"The computer hates this."],[14841,26,""],[14843,0,"See, "],[14848,1,""],[14848,0,"e"],[14861,4,""],[14861,0,"that "],[14894,12,""],[14908,0,"In order to follow a pointer, "],[14938,19,""],[14938,0,"your o"],[14943,1,""],[14943,0,"copute"],[14943,6,""],[14943,0,"computer needs to "],[14961,84,""],[14952,0,"usually "],[14969,0," re"],[14971,1,""],[14970,1,""],[14969,1,""],[14968,1,""],[14975,1,""],[14974,1,""],[14973,1,""],[14973,5,""],[14973,0," data"],[14995,0,". If every "],[15000,6,""],[15000,0,"normal memory accesses took 0.5 seconds,"],[15000,27,""],[15000,0,"L1 cache reads took"],[15032,0," reading from am"],[15047,1,""],[15046,1,""],[15046,0,"main memory"],[15070,0,"bout "],[15077,9,""],[15077,0,"2"],[15075,1,""],[15132,0,"\n\n"],[15133,1,""],[15132,1,""],[14841,0,"\n\nTo get there, the computer has to allocate memory with"],[14893,4,""],[14892,1,""],[14892,0,", which si sl"],[14900,5,""],[14900,0,"is slow. The garbage collected"],[14929,1,""],[14928,1,""],[14928,0,"or needs to understand "],[14940,11,""],[14940,0,"track that memory, "],[14958,1,""],[14957,1,""],[14957,0," and do some book "],[14974,1,""],[14974,0,"keeping (also slow)."],[14995,0,"\nAnd once the me"],[15009,2,""],[15009,0,"data is there,"],[15023,5,""],[15023,0," well,"],[15133,8,""],[15142,0," go and fetch that"],[15160,10,""],[15160,0," data"],[15090,28,""],[15090,0,"The data at the eo"],[15107,1,""],[15106,1,""],[15106,0,"other end of a pointer could be anywhere. In order to read"],[15160,4,""],[15160,0,"fetch that data"],[15175,47,""],[15175,0,", your computer needs to read from"],[15210,5,""],[15222,0," In "],[15223,3,""],[15223,0,"If "],[15225,1,""],[15224,1,""],[15224,0,"n computer time if"],[15241,1,""],[15240,1,""],[15239,1,""],[15239,0,", if"],[15243,3,""],[15258,5,""],[15258,0," take"],[14817,3,""],[14817,0,"C"],[14817,1,""],[14817,0,"Your"],[14817,0,"*"],[14843,0,"*"],[14845,0,"\n"],[14845,0,"\nAll the data is separated by pointers."],[14889,9,""],[14889,0,"put data into these boxes"],[14902,0," all"],[14955,1,""],[14955,0,". This"],[14961,6,""],[14970,0," Then"],[14976,1,""],[14976,0,"t"],[15007,0,"keep "],[15017,0," of"],[15032,25,""],[15032,0," "],[15075,64,""],[15075,0,"we need to read it"],[15151,0,"*"],[15143,0,"*"],[15155,30,""],[15155,0,"Y"],[15168,0," willusually"],[15179,1,""],[15178,1,""],[15177,1,""],[15176,1,""],[15175,1,""],[15174,1,""],[15173,1,""],[15173,0," "],[15155,19,""],[15155,0,"To read it, your computer usually"],[15197,0," go fetch it"],[15209,5,""],[15226,0,", which is a"],[15237,1,""],[15237,0,"also slow"],[15401,0,"\n\nWe can't do better in java"],[15411,18,""],[15411,0," fix this in javascript. If we make our data structures more complex, we run into the same limitations Automerge has with immutablejs - which is, the "],[15557,4,""],[15557,0,"if we make our data structures o"],[15588,1,""],[15588,0,"comple,"],[15594,1,""],[15594,0,"x, "],[15403,194,""],[15403,0,"We can't fix this in javascript. If we make our data structures more complex, we run into the same limitations Automerge has with immutablejs - which is, if we make our data structures complex,"],[15402,0,"\n"],[15402,0,"\n"],[15033,1,""],[15032,1,""],[15032,0,", which is "],[15052,1,""],[15055,5,""],[15055,0,"O"],[15081,0,"'re going to"],[15055,25,""],[15055,0,"Later we"],[15062,1,""],[15089,2,""],[15089,0,"that data"],[15100,60,""],[15099,1,""],[15099,0,","],[15099,1,""],[15098,1,""],[15098,0,", and it could be *anywhere*. "],[15374,0," Its like if your shopping list"],[15390,1,""],[15390,0," wrote a"],[15412,0,", but instead of writing \"mil"],[15440,1,""],[15439,1,""],[15438,1,""],[15438,0,"i"],[15438,1,""],[15438,0,"Mili"],[15441,1,""],[15441,0,"k\" you had a little scavenger hunt"],[15437,0,"each item, "],[15486,0," describing where in your house the note with \"milk\" on it is hidden."],[15533,1,""],[15533,0,"M"],[15555,0," Reading the whole list would take ages."],[15596,1,""],[15595,1,""],[15596,0,"\n"],[15596,0,"\nIdeally "],[15597,8,""],[15597,0,"To run faster, we need to move all the fields together. And we n"],[15600,4,""],[15600,0,"go "],[15634,7,""],[15634,0," data to"],[15641,1,""],[15640,1,""],[15639,1,""],[15658,0,"eed to move away from linked lists - as clever as they are, the user *does* sometimes hop around the document and we don't want to ever scan "],[15789,0,"*"],[15794,0,"* do those"],[15809,1,""],[15809,0,"s."],[15857,24,""],[15857,0,"fancy data structures in javascript, the language fights us ("],[15907,11,""],[15907,0,"forces us to "],[15907,13,""],[15894,13,""],[15894,0,"we end up fra"],[15904,3,""],[15904,0,"with even more fragmented memory."],[15937,25,""],[15937,0," In "],[15940,1,""],[15939,1,""],[15939,0,"s"],[15939,1,""],[15939,0,"ts sort of the"],[16001,52,""],[16001,0,". Clever data structures"],[15908,5,""],[15913,0," objects and more"],[15930,11,""],[15937,0," fragmentation"],[15896,0," confuse the optimizer, and"],[15948,30,""],[15948,0," o"],[15949,1,""],[15949,0,"all over the place in memory"],[15982,8,""],[16002,20,""],[16014,0," has"],[16019,23,""],[16019,0,"\n\nB"],[16021,1,""],[16021,0,"But its ok, there's one more "],[16032,18,""],[16032,0," we have webassembly."],[16035,0," don't need to write web app"],[16056,7,""],[16056,0,"javascript antmo"],[16071,1,""],[16070,1,""],[16069,1,""],[16069,0,"y more. "],[16076,1,""],[16075,1,""],[16075,0,", even on the web. We"],[16114,0,"\n\n[e"],[16117,1,""],[16116,1,""],[16116,0,"[Here](https://github.com/josephg/text-crdt-rust/) I've been quite"],[16181,1,""],[16180,1,""],[16180,0,"etly buliding a"],[16185,10,""],[16185,0,"build"],[16189,1,""],[16189,0,"ding yet another implementation"],[16206,14,""],[16206,0,"CRDT impelment"],[16211,9,""],[16211,0,"implementation in Rust. This implementation has all"],[16259,3,""],[16258,1,""],[16255,3,""],[16254,1,""],[16254,0,":\n\n- Does yjs's "],[16257,13,""],[16256,1,""],[16255,1,""],[16254,1,""],[16254,0," is essn"],[16261,1,""],[16261,0,"entially the same as yjs but:\n\n- It doesn't "],[16292,13,""],[16292,0,"- It doesn't"],[16297,7,""],[16297,0,"uses a B-Tree instead of "],[16305,2,""],[16305,0,"-t"],[16322,0,"a linked list to stro"],[16342,1,""],[16341,1,""],[16341,0,"ore the items. This a"],[16356,6,""],[16356,0,"The b-tree "],[16356,11,""],[16356,0,"At ec"],[16360,1,""],[16360,0,"ach node of the b-tree we store the number of "],[16355,0," This solves both of our linear scanning problems rom"],[16407,1,""],[16406,1,""],[16405,1,""],[16405,0,"from earlier."],[16356,62,""],[16355,1,""],[16396,10,""],[16396,0,"length of all of that item's children."],[16293,1,""],[16292,1,""],[16291,1,""],[16290,1,""],[16289,1,""],[16289,0," "],[16290,1,""],[16290,0,"i"],[16430,0,"\n\nThis solves both of our linear scanning problems from earlier. When we want to find where in the list to insert, "],[16516,29,""],[16516,0,"which item in the list"],[16516,6,""],[16516,0,"w"],[16516,1,""],[16520,0," 1000"],[16524,1,""],[16523,1,""],[16522,1,""],[16521,1,""],[16521,0,"50 0000"],[16527,1,""],[16539,0,", we can just traverse down the tree. The "],[16577,4,""],[16577,0,"Trees are really tiy"],[16596,1,""],[16596,0,"dy - storing all these itme"],[16622,1,""],[16621,1,""],[16621,0,"ems"],[16587,37,""],[16587,0,"very tidy - storing all these items we just need 5 "],[16432,206,""],[16432,0,"This solves both of our linear scanning problems from earlier. When we want to find item 50 000 in the list, we can just traverse down the tree. Trees are very tidy - storing all these items we just need 5"],[16430,0,"\n\n> Diagram here"],[16434,0,"B-tree "],[16441,1,""],[16441,0,"d"],[16630,30,""],[16630,0,"this sho"],[16637,1,""],[16636,1,""],[16635,1,""],[16635,0,"whole document  j"],[16651,1,""],[16650,1,""],[16650,0,"just needs 5 l"],[16663,1,""],[16663,0,"layers in the tree.\n\nWea "],[16687,1,""],[16686,1,""],[16685,1,""],[16684,1,""],[16684,0,"Each leaf node (where we store the actual data) packs a whole group of 32 items into the same chunk of memory."],[14367,0,"\nI honeslty "],[14370,9,""],[14370,0,"honestly"],[14369,0,"'m"],[14371,9,""],[14371,0," chocked"],[14372,7,""],[14372,0,"shocked how little ram yjs uses for this.\n"],[14403,10,""],[14403,0,". Its "],[14405,4,""],[14405,0,"I'm sure there's all sorts of wizardry in V8 that I don't understand which makes this possible. Its impresi"],[14511,1,""],[14511,0,"sive all "],[14519,1,""],[14519,0,"-round."],[14403,0," with this appo"],[14417,1,""],[14417,0,"roach"],[14524,0,"extremely "],[14544,11,""],[14544,0,"."],[14403,19,""],[14454,26,""],[14450,4,""],[14450,0,"which "],[14509,62,""],[14509,0,"Rust and B-tr"],[14521,1,""],[14520,1,""],[14520,0,"Treee"],[14524,1,""],[14524,0,"s"],[14509,9,""],[14509,0,"Everything is faster in rust, with "],[14533,1,""],[14533,0,"R"],[16341,0,". This time"],[16412,0," (including yjs's spans). "],[16438,2,""],[16438,0,"B"],[16503,1,""],[16503,0,"\n\n"],[16504,1,""],[16503,1,""],[16503,0," "],[16668,1,""],[16668,0,":\n\n- "],[16672,1,""],[16709,3,""],[16709,0,"our"],[16805,12,""],[16805,0,"only needs 4"],[16817,7,""],[16817,0," "],[16817,1,""],[16816,1,""],[16816,0,"5 levels"],[16827,4,""],[16827,0," our"],[16776,0," we can "],[16783,1,""],[16790,1,""],[16789,1,""],[16788,1,""],[16788,0,"e"],[16810,4,""],[16810,0,"in just"],[16817,6,""],[16753,0," "],[16753,1,""],[16694,0,"the "],[16702,0," at position"],[16721,12,""],[16843,0,"\n- Updating in the tree is easy "],[16870,5,""],[16870,0,"fast too. Usually we can just in"],[16879,23,""],[16879,0," If there's room in the current item, we just insert the new content there. If not, we \""],[16966,1,""],[16965,1,""],[16965,0," split the current item and insert in the parent. The worst case"],[17015,14,""],[17015,0,"In the worst case, we splill"],[17042,1,""],[17041,1,""],[16878,163,""],[16878,0," - it takes O(depth) - or about 5 steps no matter what."],[16918,0,"in this case "],[16945,0," happens"],[16954,0," Much better than needing to shift every ti"],[16996,1,""],[16995,1,""],[16995,0,"item in our javascript ara"],[17020,1,""],[17020,0,"ray!\n\n"],[17025,1,""],[17024,1,""],[17073,0," "],[17073,1,""],[17026,4,""],[17026,0,"In j"],[17029,1,""],[17028,1,""],[17027,1,""],[17027,0,"n Javascript we can't pack a single item into the"],[17073,3,""],[17073,0,"contiguous memory. In rust we can pack each"],[17126,0," into a single memory chunk"],[17153,56,""],[17127,0,"with 32 items all together "],[17180,40,""],[17180,0,"."],[17049,0,"even "],[17111,0,"! In fact, we can"],[17148,0," in r"],[17152,1,""],[17152,0,"our tree with"],[17165,5,""],[17174,0,". A"],[17176,1,""],[17177,1,""],[17176,1,""],[17176,0,"A"],[17111,55,""],[17111,0," pack groups of "],[17135,42,""],[17135,0," t"],[17136,1,""],[17136,0,"all together in chunks. This will result in a bit of memcop"],[17194,1,""],[17193,1,""],[17193,0,"py"],[17180,15,""],[17180,0,"some memcpy-ing when we insert, but memcpy is way faster than "],[17216,26,""],[17216,0,"thats faster than you think."],[15322,0," - you guesed i"],[15329,8,""],[15329,0,"guessed it -"],[15356,16,""],[15356,0,"We can scale up computer time by 1 billion to make it more intuitive. On this time sta"],[15441,1,""],[15440,1,""],[15440,0,"cale, each"],[15450,4,""],[15464,1,""],[15469,0,"s"],[15482,0," (about a heart beat)"],[15503,1,""],[15503,0,"."],[15505,0,"And "],[15552,9,""],[15551,1,""],[15551,0,"2 minutes"],[15560,46,""],[15363,0,"["],[15425,0,"]"],[15425,1,""],[15425,0,"](https://gist.github.com/hellerbarde/2843375)"],[15473,2,""],[15473,0,"At"],[15552,3,""],[15552,0,"Each"],[15552,4,""],[15552,0,"And eah"],[15558,1,""],[15558,0,"ch"],[15567,1,""],[15566,1,""],[15565,1,""],[15610,0," Arranging memory like javascript does here is like"],[15661,9,""],[15724,0," in your list"],[15737,8,""],[15737,0,","],[15745,1,""],[15745,0,"ve"],[15742,0,"r list is full of scavenger hunt clues."],[15782,28,""],[15782,0,"Ecah "],[15786,1,""],[15785,1,""],[15784,1,""],[15783,1,""],[15783,0,"ach clue names"],[15797,11,""],[15797,0," somewhere "],[15808,7,""],[15822,3,""],[15822,0,"with a tiny"],[15838,5,""],[15838,0," saying"],[15858,10,""],[15898,1,""],[15898,0,", and thats what Javascript does."],[15898,1,""],[15898,0,"."],[15899,6,""],[15899,0," T"],[15752,4,""],[15752,0,"actually a"],[15762,3,""],[15777,6,""],[15777,0," full of clues"],[15832,0," - and if you go there you'll find"],[15866,5,""],[15892,0," or \"Cheee"],[15901,1,""],[15901,0,"se\""],[15911,1,""],[15911,0,"\n\n"],[16007,4,""],[16007,0,"squish"],[16192,0,"sl"],[16193,1,""],[16192,1,""],[16192,0,"long slow "],[16208,0," (Remember, its a scavenger hunt each time we move to the n"],[16220,0,"we do"],[16225,3,""],[16269,0,"ext item with linked lists)"],[16295,0,"!"],[15952,28,""],[16575,4,""],[16575,0,"So I've been "],[16575,13,""],[16574,0,"So I've been quietly building "],[16605,0,"yet another CRDT imeplem"],[16622,7,""],[16622,0,"implementation, this time"],[16605,42,""],[16605,0,"a CRDT implementation in rust"],[16679,78,""],[16731,24,""],[16788,3,""],[16788,0,"all of its"],[16814,0,"inern"],[16818,1,""],[16817,1,""],[16816,1,""],[16816,0,"ternal "],[17055,0,"across and down "],[17071,4,""],[17070,1,""],[17164,1,""],[17164,0,", so we only need 5 reads to find the item."],[17265,9,""],[17265,0,"the same "],[17276,0,"or so "],[17288,35,""],[17287,1,""],[17300,58,""],[17300,0," than nee"],[17306,3,""],[17306,0,"when n"],[17311,1,""],[17311,0,"we need "],[17318,1,""],[17318,0,"e"],[17306,13,""],[17306,0,"that javascript array.\n\nIt might al"],[17340,1,""],[17339,1,""],[17339,0,"be faster te"],[17350,1,""],[17349,1,""],[17349,0,"yet to *also* cache the location"],[17373,0,"last "],[17386,0,". I haven't trued th"],[17398,8,""],[17398,0,"tried that yet. But its really fast anyway.\n\n"],[17663,0,"\n"],[17444,1,""],[17662,0,"\n"],[17443,1,""],[17661,0,"\n"],[17442,1,""],[17660,1,""],[17442,0,"\n"],[17363,0,"use yjs's trick and "],[17433,28,""],[17435,219,""],[17435,0,"We"],[17435,2,""],[17435,0,"In Javascript we can't even pack a single item into contiguous memory. In rust we can pack groups of 32 items all together in chunks. This will result in some memcpy-ing when we insert, but thats faster than you think.\n"],[17435,219,""],[17435,0,"We can also pack all the items tightly in memory. Each leaf in the b-tree is stored in a single block fo"],[17538,1,""],[17537,1,""],[17537,0,"of memory. That block "],[17548,11,""],[17548,0,"At that block we store 32 entries - each storing in turn a span of characters. Th"],[17628,1,""],[17627,1,""],[17626,1,""],[17626,0," This "],[17627,5,""],[17627,0,"So inserting *does* need a few memcpy"],[17652,12,""],[17652,0,"some memcopy"],[17663,1,""],[17662,1,""],[17661,1,""],[17661,0,"py-ing, but thats"],[17673,5,""],[17673,0,"I'm"],[17675,1,""],[17674,1,""],[17673,1,""],[17673,0,"thats seriously faster than you think it is. Much faster"],[17704,0," ui"],[17706,1,""],[17705,1,""],[17705,0,"intuitie"],[17712,1,""],[17712,0,"vely"],[17730,11,""],[17729,1,""],[17672,0," its fine -"],[17690,0,"still "],[17717,29,""],[17717,0," doing"],[17673,50,""],[17673,0,"memcpy"],[17672,1,""],[17672,0," a little bit of "],[17695,0," is fine. Its faster than you think"],[17709,0,"seriously "],[17740,0,".\n\nAnyway, how m"],[17755,1,""],[17755,0,"fast?"],[17759,1,""],[17759,0," does it go?\n\nCalled from javascript through webap"],[17808,1,""],[17808,0,"ssembly, the benchmark"],[17817,13,""],[17817,0,"we're down to 0.2 seconds. Called directly from rust, t"],[17871,1,""],[17871,0,"we can proe"],[17881,1,""],[17881,0,"cess this editing trace in "],[17833,1,""],[17832,1,""],[17831,1,""],[17830,1,""],[17830,0," 200 milli"],[17840,1,""],[17913,0,"65 n"],[17916,1,""],[17916,0,"milliseconds. And "],[17929,5,""],[17741,0,"\n\nThere's one last thing I've done. I don't know if its a good idea, but I suspect its "],[17816,12,""],[17816,0,"di i"],[17819,1,""],[17818,1,""],[17818,0,"d it "],[17822,1,""],[17822,0," anyway.\n\n"],[17831,1,""],[17830,1,""],[17830,0," I moved the text content itself into a "],[17869,1,""],[17869,0,"nother structures."],[17886,1,""],[17885,1,""],[17885,0,". S"],[17887,1,""],[17887,0,"When you're actually doing collaborative editing "],[17935,1,""],[17935,0,", you have all the car"],[17956,1,""],[17955,1,""],[17955,0,"haracters in your odnw"],[17973,4,""],[17973,0,"document in "],[17940,0," probably want to"],[18002,0,"an actual array, or an actual string or something. So I made it so the CRDT data structure onol"],[18096,1,""],[18095,1,""],[18095,0,"ly"],[17829,0," because it seemed clever at the time"],[17854,12,""],[17893,7,""],[17893,0,"a separate data"],[17920,0,"See, "],[17925,1,""],[17925,0,"w"],[17992,8,""],[18072,9,""],[18072,0,"in VS Code's data structures or h"],[18104,1,""],[18104,0,"whatever. It doesn't make sense to store the content twice"],[18189,14,""],[18188,1,""],[18193,0," stores "],[18194,0,"needs to "],[18209,1,""],[18208,1,""],[18208,0," the spans and such. Just enough that it can merge changes.s"],[18267,1,""],[17868,4,""],[17867,1,""],[17883,0,"out "],[18028,0,"to be stored "],[18059,21,""],[18059,0,","],[18077,27,""],[18077,0,"editor r "],[18085,1,""],[18084,1,""],[18084,0,"or something"],[18173,78,""],[18164,9,""],[18164,0,"my CRDT stores"],[18366,0,"\n"],[18179,1,""],[18365,0,"\nThere's one last thing I've done. I don't know if its a good idea, but I did it anyway because it seemed clever. I moved the content itself out into a separate data structure. See, when you're actually doing collaborative editing, you probably want all the characters in your document to be stored in an actual array, or in VS Code's editor or something. It doesn't make sense to store the content twice. So I made it so my CRDT stores"],[17743,436,""],[17929,0,"\n"],[17742,1,""],[17928,0,"\nWe can also pack all the items tightly in memory. Each leaf in the b-tree is stored in a single block of memory. At that block we store 32 entries - each storing in turn a span of characters. So inserting *does* need some memcpy-ing, but a little bit of memcpy is fine. Its seriously faster than you think."],[17435,307,""],[17621,307,""],[17435,0,"We can also pack all the items tightly in memory. Each leaf in the b-tree is stored in a single block of memory. At that block we store 32 entries - each storing in turn a span of characters. So inserting *does* need some memcpy-ing, but a little bit of memcpy is fine. Its seriously faster than you think.\n"],[17928,1,""],[17742,0,"\n"],[17929,0,"\n\n\n"],[17931,0,"\n| Test                              | Time taken | RAM usage |\n| --------------------------        | ---------- | --------- |\n| automerge @ 1.0.0-preview2        |  291s      | 880 MB    |\n| reference-crdts (automerge / yjs) |   31s      |  28 MB    |\n| Yjs                               | 0.97s      | 3.6 MB    |\n| JS baseline                       | 0.61s      | 0.1 MB    |"],[17930,1,""],[18308,0,"\n| Rust via web"],[18316,7,""],[18316,0,"called from JS"],[18316,14,""],[18316,0,"(through WASM)               | 0.65s\n| JS baseline                       | 0.61s      | 0.1 MB    |"],[18246,63,""],[18289,0,"      | 2.3 MB    |"],[18246,0,"| Rust (through WASM)               | 0.65s      | 2.3 MB    |\n"],[18317,12,""],[18317,0,"native"],[18324,0,"      "],[18254,7,""],[18254,0,"Via JS +"],[18254,3,""],[18254,0,"Called from"],[18269,1,""],[18269,0,"via"],[18279,11,""],[18287,1,""],[18286,1,""],[18286,0,"20"],[18287,1,""],[18287,0,"0"],[18349,0,"0"],[18354,1,""],[18434,0,"\n| Rust (native)                     | 0.065s     | 2.3 MB    |"],[18309,63,""],[18371,0,"\n| Rust (Called from JS via WASM)    | 0.20s      | 2.3 MB    |"],[18246,63,""],[18069,0,"("],[18071,1,""],[18085,0,")"],[18086,1,""],[18191,20,""],[18191,0,"(&"],[18192,1,""],[18192,0,"$"],[18192,1,""],[18192,0,"#"],[18192,1,""],[18192,0,"@13.5.5)           "],[18189,3,""],[18189,0,"("],[18198,0,"  "],[18070,1,""],[18070,0,"v"],[18190,1,""],[18190,0,"v"],[18790,81,""],[18790,0,"\n\nThese times assume your "],[18804,12,""],[18792,12,""],[18792,0,"S"],[18792,1,""],[18792,0,"So the data strucut"],[18810,1,""],[18809,1,""],[18809,0,"ture looks like this:\n\n```\n{\n  \n  "],[18838,2,""],[18839,2,""],[18839,0,"}\n```"],[18838,0,"  text: <R"],[18847,1,""],[18846,1,""],[18846,0,"Rope implementation"],[18846,19,""],[18846,0,"\"abc\","],[18837,0,"\n  tree: <Range tree storing spans and offsets and such"],[18847,45,""],[18847,0,"B-tree storing the content>,\n  index: I"],[18885,1,""],[18884,1,""],[18884,0," <Index "],[18876,16,""],[18876,0,"  index: <Index"],[17328,0,"\n\nI'm also storing a "],[17348,1,""],[17348,0,"n index bac"],[17355,4,""],[17355,0," "],[17355,1,""],[17355,0,", so we can easily find \""],[17379,1,""],[17374,5,""],[17374,0,"look up items byt"],[17390,1,""],[17390,0," their ID ("],[17400,1,""],[17400,0,"*("],[17401,1,""],[17400,1,""],[17400,0,"(*("],[17402,1,""],[17402,0,"[Seph"],[17406,1,""],[17405,1,""],[17404,1,""],[17403,1,""],[17403,0,"'seph', 100]("],[17415,1,""],[17415,0,"*)"],[17374,7,""],[17374,0,"find"],[17374,4,""],[17367,7,""],[17367,0,"quickly find"],[17414,0," -> "],[17417,1,""],[17416,1,""],[17415,1,""],[17414,1,""],[17415,0,"."],[17429,0," even"],[17441,7,""],[17441,0," if I"],[17469,4,""],[17469,0," of"],[17477,1,""],[17477,0,"ing"],[17527,0,"Rust lets us"],[17539,11,""],[17602,61,""],[17602,0,"stores"],[17619,0,", with even"],[17629,1,""],[17629,0,"rything contiguous."],[17649,44,""],[17648,1,""],[17649,2,""],[17649,0,"I"],[17649,3,""],[17649,0,"I"],[17658,0," like this"],[17737,0," also"],[17741,1,""],[17740,1,""],[17740,0,"ways"],[17744,10,""],[17756,0," I"],[17758,4,""],[17764,0," it will be"],[17778,7,""],[17778,0,"Speaking of fast,"],[18859,0,"actually "],[18939,6,""],[18930,9,""],[18930,0,"  index: <in"],[18941,1,""],[18940,1,""],[18940,0,"Index of ID => "],[18954,1,""],[18953,1,""],[18952,1,""],[18952,0,"-> "],[18954,1,""],[18953,1,""],[18952,1,""],[18952,0,"=> b-tree node>,"],[18978,3,""],[18978,0,"oh hai!"],[18859,0,"*"],[18868,0,"*"],[18996,0,"\nBut gues "],[19005,1,""],[19005,0,"s"],[18997,9,""],[18997,0,"For the text I'm "],[19009,5,""],[19009,0," content I'm using [Ropey](https://docs.rs/ropey/1.2.0/ropey/). But guess what? I"],[19089,1,""],[19089,0,"My code is faster than ropey. And "],[19119,4,""],[19118,1,""],[19118,0," If I turn it off"],[19118,17,""],[19119,0,"\n| Test                              | Time taken | RAM usage |\n| --------------------------        | ---------- | --------- |\n| automerge (v1.0.0-preview2)       |  291s      | 880 MB    |\n| reference-crdts (automerge / yjs) |   31s      |  28 MB    |\n| Yjs (v13.5.5)                     | 0.97s      | 3.6 MB    |\n| JS baseline                       | 0.61s      | 0.1 MB    |\n| Rust (Called from JS via WASM)    | 0.20s      | 2.3 MB    |\n| Rust (native)                     | 0.065s     | 2.3 MB    |\n"],[19118,0," And that content is stored "],[19139,7,""],[19139,0,"going to be stored in someone else's"],[19151,24,""],[19151,0,"someone else's problem anyway. What happens if I turn that off?"],[19182,0,"Its cheating, but "],[19200,1,""],[19200,0,"w"],[19675,0,"| Rust (native)                     | 0.065s     | 2.3 MB    |\n"],[19753,0,", not sto"],[19761,1,""],[19760,1,""],[19759,1,""],[19758,1,""],[19757,1,""],[19757,0," string"],[19764,19,""],[19764,0,"        "],[19758,8,""],[19758,0,"content "],[19780,1,""],[19779,1,""],[19779,0,"23"],[19791,1,""],[19791,0,"1"],[19182,0,"Look, I know I'm"],[19198,3,""],[19197,1,""],[19196,1,""],[19195,1,""],[19195,0,"its"],[19231,0,"just ... "],[19774,1,""],[19786,0,")"],[19779,7,""],[19779,0,"doc content"],[19792,4,""],[19685,6,""],[19685,0,"???   "],[18405,6,""],[18405,0,"???    "],[18411,1,""],[18657,6,""],[18657,0,"W"],[18830,0," And that stru"],[18831,13,""],[18831,0,"It doesn't make sense to duplicate the document content."],[18878,0,"'s"],[18888,1,""],[18888,0," in my library."],[19141,0,"Its pretty fast... but "],[19164,4,""],[19179,4,""],[19179,0,"B-tree"],[19342,1,""],[19342,0," to see how fast this puppy can really go?"],[19953,0,"\nBoom.\n\n"],[19959,0," 14000 "],[19965,1,""],[19965,0,"x faster."],[19973,0,"; as promised"],[225,0,"all of "],[236,4,""],[419,0,"this is awkward but .. "],[587,0,"which, by the way, "],[677,18,""],[677,0,"Oi!"],[679,1,""],[679,0," - whats going on?"],[696,1,""],[696,0," here?"],[773,14,""],[773,0,"code"],[944,0,". And"],[949,2,""],[955,5,""],[955,0,"of those inserts"],[1007,16,""],[1007,0,"O"],[1007,0,"Duh - "],[1013,1,""],[1013,0,"o"],[1183,0,"so many "],[1197,10,""],[1207,0,"me a link to"],[1219,7,""],[1254,6,""],[1257,0," Bad!"],[1271,0," Y "],[1273,1,""],[1272,1,""],[1272,0,"My code isn't slow, "],[1271,21,""],[1408,0,". Jupiter os an "],[1423,1,""],[1422,1,""],[1421,1,""],[1420,1,""],[1419,1,""],[1418,1,""],[1418,0,"is an Algorithm. RGA is an Algorithm."],[1456,3,""],[1456,0,"B"],[1435,0,"The "],[1442,6,""],[1443,1,""],[1443,0,"a"],[1653,13,""],[1652,1,""],[1795,1,""],[1804,1,""],[1896,128,""],[1896,0,"Years ago "],[1907,9,""],[1918,1,""],[1917,1,""],[1916,1,""],[1916,0,"ed"],[1928,6,""],[1922,6,""],[1921,1,""],[183,0,"s"],[2126,38,""],[2149,4,""],[2149,0,"does"],[2294,0," I think they're the future of collaborative editing."],[2378,0," for years"],[2211,1,""],[2222,0," is slow!"],[2495,0,"I think "],[2536,1,""],[2537,3,""],[2537,0,"as "],[2666,16,""],[2666,0,"anything about efficient "],[2708,10,""],[2708,0," of those systems"],[2727,6,""],[2727,0,"Wow, I was"],[2737,16,""],[2737,0," was"],[2737,0," turns out I"],[2733,4,""],[2731,2,""],[2727,4,""],[2727,0,"But it"],[2717,8,""],[2717,0," systems"],[2727,6,""],[2727,0,"Wow, I was"],[2737,16,""],[2763,11,""],[2763,0,"Well"],[2801,0,"["],[2811,0,"](https://github.com/automerge/automerge/)"],[2798,0,"https://github.com/automerge/automerge-perf/"],[2998,0," to run"],[3082,1,""],[3081,1,""],[3081,0,"54"],[3082,1,""],[3081,1,""],[3081,0,"65"],[3099,32,""],[3098,1,""],[3099,0,"nearly "],[3106,6,""],[3106,0,"5000x faster"],[3264,0,"I'll take you through "],[3285,33,""],[3285,0," I "],[3287,1,""],[3286,1,""],[3285,1,""],[3285,0," I "],[3287,1,""],[3285,2,""],[3285,0," all the steps that make it fast."],[3300,18,""],[3300,0,"to make it super fast."],[3324,4,""],[3324,0,"But"],[3353,0,":"],[2254,0,"https://josephg.com/blog/crdts-are-the-future/"],[3570,0,"["],[3586,0,"](https://martin.kleppmann.com/2020/07/06/crdt-hard-parts-hydra.html)"],[4147,27,""],[4147,0,"Sounds like a tree, dawg!"],[4147,24,""],[4147,0,"Its a tree"],[4438,0,"\n> Diagram here\n"],[5151,8,""],[5151,0,"When"],[5196,6,""],[5224,0,"their "],[5239,0," resulting"],[5254,0," (or d"],[5259,1,""],[5259,0,"text document) can be made by"],[5288,26,""],[5288,0," "],[5425,11,""],[5429,0,", which is to store a "],[5450,1,""],[5449,1,""],[5449,0,"all the data as a tree"],[5529,1,""],[5528,1,""],[5527,1,""],[5526,1,""],[5525,1,""],[5524,1,""],[5523,1,""],[5522,1,""],[5652,0," (Wh"],[5655,1,""],[5654,1,""],[5653,1,""],[5652,1,""],[5653,0," (What are all those Uint8Arrays doing all of t"],[5699,1,""],[5698,1,""],[5697,1,""],[5697,0,"ver the place?)"],[5655,0,"And "],[5659,1,""],[5659,0,"w"],[5716,0,"."],[5718,0,"\nThrough this po"],[5719,15,""],[5719,0,"We're going to go through a lot of different algri"],[5768,1,""],[5767,1,""],[5767,0,"orh"],[5769,1,""],[5769,0,"ithms here"],[5773,1,""],[5773,0,"ic app"],[5775,4,""],[5773,2,""],[5773,0,"s"],[5779,0,"."],[5780,1,""],[5780,0," To"],[5783,3,""],[5795,1,""],[5794,1,""],[5793,1,""],[5793,0," all of them"],[5781,24,""],[5781,0,"So t"],[5784,1,""],[5784,0,"for a simple benchmark"],[5784,3,""],[5784,0,"as"],[5810,0," going to"],[5819,6,""],[5819,0," use"],[5937,6,""],[5944,0," himself"],[5961,0," where"],[5962,21,""],[6001,1,""],[6000,1,""],[6000,0," aren't any"],[6011,3,""],[6046,1,""],[6051,0," ja"],[6053,1,""],[6052,1,""],[6052,0,"has edits from"],[6081,1,""],[6081,0,"."],[6083,1,""],[6083,0,"B"],[6106,1,""],[6106,0," -"],[6109,1,""],[6109,0,"u"],[6114,0," almost never "],[6127,1,""],[6128,13,""],[6128,0,"put their cursors a t"],[6148,1,""],[6147,1,""],[6147,0,"t exactly the same place and start "],[6188,43,""],[6188,0," at the same time."],[6127,0," actually"],[6197,18,""],[6197,0,"."],[6185,6,""],[6190,1,""],[6189,1,""],[6188,1,""],[6188,0,"e"],[6190,0," And I'm just counting the time from applying this trace *locally*. Not ideal, but eh. You want the good stuff, ou"],[6273,31,""],[6273,0,"good enough"],[6273,11,""],[6273,0,"eh."],[6273,3,""],[6273,0,"its "],[6276,1,""],[6275,1,""],[6274,1,""],[6274,0,"it"],[6275,1,""],[6274,1,""],[6274,0,"t'll do."],[3033,0,"nearly 5 minutes to run. "],[3058,20,""],[3131,1,""],[3130,1,""],[3129,1,""],[3132,0,"millin"],[3137,1,""],[3144,0,". 0.6"],[3148,1,""],[3148,0,"065 seconds"],[3392,3,""],[3392,0,"Wait, no."],[3401,10,""],[3401,0," First"],[3436,0," an"],[3437,2,""],[3436,1,""],[3434,0,"on earth "],[3798,0,"\n\nI"],[3800,1,""],[3800,0,"I don't recomend"],[3815,1,""],[3814,1,""],[3813,1,""],[3813,0,"mend using it. If you want a production grade CRDT implementation today, "],[3800,0,"("],[3818,0," actually"],[3801,0,"Just an aside: "],[3851,0," t"],[3852,1,""],[3851,1,""],[3851,0," yet - its not ready"],[3931,0,"https://github.com/yjs/yjs"],[3930,0," Yjs is the "],[3938,4,""],[3938,0,"currently the best in the business"],[3972,27,""],[3972,0,". Kevin "],[3979,1,""],[3979,0," Y"],[3980,1,""],[3980,0,"Jahns is a class act"],[3986,14,""],[3974,12,""],[3974,0,"Youl'"],[3978,1,""],[3977,1,""],[3977,0,"'ll see why soon!)"],[3849,2,""],[3849,0,"automerge"],[3938,0,"["],[3942,0,"]( https://github.com/yjs/yjs)"],[3944,1,""],[3974,10,""],[3859,4,""],[3858,1,""],[3858,0," at the moment."],[3873,3,""],[3873,0," I"],[3887,0," for prime time"],[3892,10,""],[3891,1,""],[3890,1,""],[3889,1,""],[3888,1,""],[3888,0,"yet"],[3988,24,""],[3988,0,"as "],[3990,1,""],[3989,1,""],[3989,0,"n easy recommendation. It "],[4014,1,""],[4013,1,""],[4012,1,""],[4011,1,""],[4010,1,""],[4023,3,""],[4023,0,"some of the reasons"],[3801,7,""],[3801,0,"Oh and a quick"],[4058,0,"Si "],[4060,1,""],[4059,1,""],[4059,0,"o "],[4058,3,""],[4073,0,"Yjs and other "],[4087,5,""],[4086,1,""],[4086,0,"s"],[4086,1,""],[4446,11,""],[4446,0,"We can draw this as a tree!"],[4954,0,"argh, "],[4968,0," actually"],[5006,1,""],[5006,0," because"],[5014,14,""],[5014,0," "],[4780,1,""],[4780,0,"X"],[4818,0," Hang on, which one goes first?"],[4828,0,"how do we figure out "],[4854,4,""],[4854,0," character shoul"],[4865,5,""],[4864,1,""],[4981,10,""],[4981,0," sorting them based on "],[5003,1,""],[5030,0,"then we'd end up with \"abXc\"."],[5059,118,""],[5060,3,""],[5060,0,"Automerge"],[5148,0,". The sequence number is bi"],[5173,2,""],[5173,0,"1 bigger than the biggest sequence number you've ever seen"],[5150,0,"When you make a change, "],[5174,1,""],[5174,0,"t"],[5159,15,""],[5159,0,"insert anything, you set "],[5204,2,""],[5204,0,"to"],[5207,0,"be "],[5268,1,""],[5268,0,". Yjs has a different approach, but its "],[5268,40,""],[5268,0,":"],[5270,0,"\n"],[5270,0,"\n(Yjs has a different approach to the e"],[5308,1,""],[5308,0,"sequence numner th"],[5317,9,""],[5317,0,"m"],[5317,1,""],[5317,0,"number thing, but the difference is "],[5335,18,""],[5335,0,"lets not get into that now)"],[5282,0,"slightly "],[5344,26,""],[5344,0,"whatever"],[5344,8,""],[5344,0,"its fine,"],[5352,1,""],[5344,8,""],[5344,0,"you"],[5271,77,""],[5270,1,""],[5269,1,""],[5082,0,"with a bit of a hack. It "],[5107,3,""],[5112,1,""],[5111,1,""],[5110,1,""],[5110,0,"s"],[5174,0,"ever"],[5211,0," new item's"],[5524,0,"\n\n(Wo "],[5529,1,""],[5526,4,""],[5525,1,""],[5525,0,"\n\n"],[5526,0,"> Wow I saw a sequence number, and it was *this big*!"],[5578,1,""],[5577,0,"!"],[5526,53,""],[5525,1,""],[5524,1,""],[5524,0,"\n\n> Wow I saw a sequence number, and it was *this big!*. Y"],[5581,1,""],[5581,0,"\""],[5581,1,""],[5581,0,"Yeah? Mine is *even bige"],[5604,1,""],[5604,0,"ger!*"],[5528,0,"\""],[5581,0,"\""],[5583,0,"\""],[5612,0,"\". Ahem."],[6180,0,"Uh, uhm, "],[6225,1,""],[6286,1,""],[6285,1,""],[6285,0," I think"],[6286,7,""],[6286,0,"Yes, the automerge library implements"],[6312,11,""],[6286,26,""],[6286,0,"Whta"],[6289,1,""],[6288,1,""],[6288,0,"atever. The automerge library implements"],[6318,10,""],[6318,0,"works by building a tree of items."],[6285,1,""],[6285,0,"\n\n"],[6286,1,""],[6285,1,""],[6285,0," "],[6286,8,""],[6285,3,""],[6285,0,"\n\n"],[6286,1,""],[6285,1,""],[6285,0," Any"],[6288,1,""],[6287,1,""],[6286,1,""],[6286,0,"Waht"],[6289,1,""],[6288,1,""],[6287,1,""],[6287,0,"hatever. "],[6035,0,"("],[6286,0,")"],[6356,61,""],[6356,0,"So how e"],[6363,1,""],[6363,0,"we"],[6364,1,""],[6363,1,""],[6363,0,"fas"],[6356,10,""],[6356,0,"How fast is it?"],[6372,4,""],[6372,0,"A"],[6408,3,""],[6408,0,"run"],[6408,3,""],[6408,0,"test it using"],[6432,0,"own "],[6436,15,""],[6423,0,"an editin "],[6432,1,""],[6432,0,"g trace "],[6446,20,""],[6446,0," himself made"],[6526,8,""],[6526,0," trace of"],[6542,8,""],[6550,1,""],[6549,1,""],[6549,0,"in"],[6550,1,""],[6549,1,""],[6543,6,""],[6543,0,"typing up"],[6552,15,""],[6552,0," "],[6356,16,""],[6356,0,"How fast is it? "],[6356,16,""],[6356,0,"For "],[6360,1,""],[6360,0,"a"],[6361,1,""],[6363,1,""],[6362,1,""],[6397,0," automerge"],[6407,3,""],[6656,22,""],[6736,0," anyawy"],[6742,1,""],[6741,1,""],[6740,1,""],[6740,0,"way"],[6745,4,""],[6748,5,""],[6748,0," only"],[6832,0," Kevin Jahns (the Yjs author) has a much better"],[6873,6,""],[6873,0,"more extensive benchmarking suite"],[6878,0,"["],[6907,0," here](https://github.com/dmonad/crdt-benchmarks). All the benchmarks here are done using Nodes"],[7001,1,""],[7001,0,"js 16.1 on my hc"],[7016,1,""],[7015,1,""],[7015,0,"chonky chonk ryzen 5800x workstation."],[7022,5,""],[7021,1,""],[6991,18,""],[7027,1,""],[7027,0,", with using Nodejs 16.1 "],[7034,6,""],[7046,0,"and rustc 1.52 when thats appropriate. Spoilers!"],[6525,2,""],[6525,0,"from"],[6613,40,""],[6613,0,","],[6615,1,""],[6615,0,"b"],[6711,0," also"],[6774,1,""],[6774,0,", which"],[6781,4,""],[6781,0," isn't"],[6793,1,""],[6821,4,""],[6927,0," if you're into that sort of thing"],[6967,3,""],[6967,0,"my"],[6967,2,""],[6967,0,"the"],[7090,0,"("],[7100,0,")"],[7075,1,""],[7075,0," becomes"],[7110,0,"Anyway, "],[7118,1,""],[7118,0,"a"],[7127,0," above"],[7233,0," "],[7244,35,""],[7108,0,"\n\nThe editing trace "],[7110,18,""],[7110,0,"M"],[7110,1,""],[7110,0,"The editing trace has 2800"],[7135,1,""],[7135,0," 000 edits, and the final document size is about 100kb."],[7188,0," "],[7188,1,""],[7187,0," "],[7188,2,""],[7188,0,"000 characters"],[7205,9,""],[7204,1,""],[7203,1,""],[7203,0," A"],[7203,1,""],[7203,0,"\n\n"],[7278,8,""],[7290,18,""],[7290,0,"by the time its donw"],[7309,1,""],[7309,0,"e, automerge uses"],[7341,0," Wow."],[7345,1,""],[7345,0,"!"],[7345,1,""],[7345,0,"!"],[7342,4,""],[7342,0,"Whoa! Thats 10kb f"],[7359,1,""],[7359,0,"of ram *per key press*."],[7384,54,""],[7384,0,"We can compare"],[7384,14,""],[7384,0,"W"],[7384,1,""],[7384,0,"If we just process that in javascript directly"],[7430,24,""],[7430,0,", using a"],[7457,39,""],[7457,0,", well "],[7463,1,""],[7463,0,", its much slower:"],[7467,1,""],[7467,0," might allow concurrent edits but its"],[7504,12,""],[7504,0," slow"],[7671,0," "],[7674,1,""],[7764,0," "],[7764,1,""],[7763,1,""],[7763,0," though?"],[8360,8,""],[8360,0,"that"],[8372,0," too"],[8438,0," The automerge team is working on a rust \"backend\""],[8487,1,""],[8479,1,""],[8486,0," for the algorithm, but it hasn't been merged yet."],[8474,0,"replacement "],[8490,16,""],[8490,0," implementation of the"],[8554,0," And in the meantime they haven't bothered making the javascript code fast because"],[8554,82,""],[8528,0,"at the time of writing "],[8579,118,""],[8578,0,"\n"],[8578,1,""],[8579,0,"There's an old saying with performance tuning:\n\n> You can't make a program faster. You can only make it do less work.\n"],[8386,3,""],[8386,0," automerge"],[8400,5,""],[8379,9,""],[8379,0,"A"],[8437,10,""],[8436,1,""],[8436,0,"ir "],[8546,17,""],[8546,0," landed yet."],[8661,2,""],[8661,0,"the computer"],[8560,0,"So how do"],[8560,9,""],[8689,4,""],[8689,0,"H"],[8778,0," from goin ght"],[8791,1,""],[8790,1,""],[8789,1,""],[8788,1,""],[8788,0,"g through the code and improving things"],[8832,0," I agree with the atuomer"],[8850,7,""],[8850,0,"automerge team:"],[8866,1,""],[8866,0,"W"],[8864,1,""],[8864,0,"."],[9005,19,""],[9005,0,"A"],[9074,0," Lets "],[9079,1,""],[9078,1,""],[9077,1,""],[9076,1,""],[9075,1,""],[9074,1,""],[9074,0," We can "],[9075,7,""],[9075,0,"LEts"],[9078,1,""],[9077,1,""],[9076,1,""],[9076,0,"ets \"Im"],[9082,1,""],[9081,1,""],[9081,0,"improve\" it."],[9080,9,""],[9080,0,"fix"],[9172,1,""],[9172,0,"."],[9174,5,""],[9174,0,"You can"],[9172,1,""],[9172,0,", which Ke"],[9180,2,""],[9174,6,""],[9174,0,"pioneered by"],[9186,55,""],[9227,5,""],[9227,0,"talking about"],[9261,1,""],[9260,1,""],[9260,0,","],[9260,1,""],[9281,0,"pretty "],[9334,0,"data structure \""],[9355,0,"\""],[9388,0,"in the field has "],[9461,0," automerge does"],[9476,5,""],[9753,0,"flat "],[10027,84,""],[10026,1,""],[10025,1,""],[10025,0,", bu"],[10028,1,""],[10027,1,""],[10026,1,""],[10026,0," "],[10035,1,""],[10034,1,""],[10034,0,"ll get there"],[10046,14,""],[9983,9,""],[10041,0,"With this structure, the way we insert items changes."],[10093,1,""],[10093,0," slightly. "],[10104,68,""],[10103,1,""],[10094,9,""],[10093,1,""],[10093,0,"."],[10110,3,""],[10110,0,"wi"],[10111,1,""],[10111,0,"e insert by"],[10122,10,""],[10122,0," answer is"],[10119,3,""],[10112,7,""],[10111,1,""],[10111,0,"i"],[10110,2,""],[10110,0,"the"],[10093,1,""],[10093,0," slightly. ?"],[10104,0,"The question is, how do you insert a new item into a list like this"],[10104,18,""],[10104,0,"H"],[10144,10,""],[10062,42,""],[10041,21,""],[10041,0,"That looks simple, but "],[10064,1,""],[10064,0,"h"],[10121,14,""],[10121,0,"its easy:"],[10213,18,""],[10213,0,", keeping the sor"],[10226,4,""],[10226,0,"m sorted."],[10213,1,""],[10213,0,". ("],[10216,8,""],[10216,0,"Keep"],[10213,20,""],[10188,0,"right location in the "],[10235,0,"."],[10235,1,""],[10245,0," tyj"],[10248,1,""],[10247,1,""],[10246,1,""],[10246,0,"yjs"],[10387,0,"where "],[10428,0,"And uh, "],[10436,1,""],[10436,0,"i"],[10428,9,""],[10428,0,"I"],[10434,9,""],[10434,0," it!"],[10440,33,""],[10440,0,"This is"],[10447,39,""],[10447,0," just a"],[10440,0,"Essentially, "],[10453,4,""],[10453,0,"this approach"],[10500,0,"It sounds sort of complicated, but "],[10535,1,""],[10535,0,"y"],[10603,0,"Here's a"],[10610,1,""],[10610,0,"the algorithm in "],[10627,3,""],[10635,45,""],[10635,0,", with lots o"],[10642,6,""],[10642,0,"comments"],[10869,0," CRDT"],[10837,0," lots of R"],[10846,1,""],[10846,0,"CRDTs like this."],[10894,0,"s all work, and y"],[10904,7,""],[10904,0,"\n2. Doing it this way lets you implement the semantics of multiple"],[10975,0,"s"],[10976,10,""],[11107,2,""],[11107,0,"s. "],[11110,2,""],[11110,0,"M"],[11116,0," you"],[11125,0," need to"],[11141,1,""],[11140,1,""],[11139,1,""],[11138,1,""],[11174,0,"s"],[11177,1,""],[11177,0,"3"],[11423,1,""],[11423,0,"4"],[11547,1,""],[11547,0,"5"],[11179,0," The algorithm iss"],[11196,1,""],[11196,0," super fast"],[11194,13,""],[11194,0,"only slows down when there are"],[11225,1,""],[11225,0,"c"],[11264,0,". u"],[11266,1,""],[11266,0,"But thats"],[11275,4,""],[11298,4,""],[11298,0," -"],[11360,85,""],[11360,0,"I"],[11387,1,""],[11387,0,"."],[11404,4,""],[11404,0,"the"],[11408,0,"*"],[11423,0,"*"],[11423,1,""],[11408,1,""],[11426,4,""],[11425,1,""],[11450,0," is"],[11478,0," to actual automerge, and yjs and sync9"],[11519,1,""],[11546,1,""],[11545,1,""],[11545,0,".)"],[11519,0,"("],[11520,21,""],[11520,0,"F"],[11526,0," verfi"],[11531,1,""],[11530,1,""],[11530,0,"ified (TM)"],[11520,0,"["],[11536,0,"](https://github.com/josephg/reference-crdts/blob/main/reference_test.ts)"],[11609,6,""],[11617,0," kind"],[11618,4,""],[11618,0,"also really"],[11630,4,""],[11630,0,"elegant"],[11639,0,"We "],[11642,1,""],[11642,0,"i"],[11675,1,""],[11675,0,"."],[11684,1,""],[11676,8,""],[11676,0," Genius!"],[11676,8,""],[11676,0," Genius!"],[11720,5,""],[11720,0,"ITs a"],[11724,1,""],[11723,1,""],[11722,1,""],[11721,1,""],[11721,0,"ts about"],[11777,37,""],[11777,0,":"],[12096,0,"Mind you, "],[12106,1,""],[12106,0,"s"],[12143,10,""],[12142,1,""],[12193,0," This "],[12194,5,""],[12194,0,"These "],[12194,6,""],[12194,0,"These are completely different codebases being tested."],[10235,0,"\n3. Uh"],[10239,2,""],[10239,0,"S"],[10239,1,""],[10239,0,"Traverse the tree"],[10248,8,""],[10248,0,"backwa"],[10248,6,""],[10248,0,"up the tree to figure out where "],[10274,6,""],[10274,0,"the insert position of th e"],[10300,1,""],[10300,0,"e"],[10300,1,""],[10299,1,""],[10299,0,"e new item, and update"],[10250,0," through"],[10329,0," our copy of the document. (Automerge also sto"],[10236,139,""],[10236,0,"3. Traverse up through the tree to figure out the insert position of the new item, and update our copy of the document. (Automerge also sto"],[10239,0,"("],[10239,1,""],[10318,4,""],[10318,0," so you can"],[10329,53,""],[10329,0," add "],[10333,1,""],[10329,4,""],[10329,0," update our copy of the document. (Automerge also sto"],[10337,12,""],[10349,21,""],[10349,0," in your editor / "],[10366,1,""],[10365,1,""],[10364,1,""],[10364,0,"."],[10341,0,"actual "],[10383,1,""],[10383,0,"Y"],[10666,0," (And it"],[10668,6,""],[10668,0,"and it si"],[10676,1,""],[10675,1,""],[10675,0,"is a bit hairy translating the semantics)"],[10716,1,""],[10716,0,"."],[10718,1,""],[10718,0,"B"],[10761,0," for automerge or yjs "],[10782,1,""],[10822,9,""],[10822,0,"insert function"],[10978,38,""],[10978,0,"This approach is pretty beautiful"],[11011,12,""],[10995,7,""],[10995,0,"pretty "],[10995,7,""],[11004,0," for lot sof reasons"],[11016,1,""],[11015,1,""],[11014,1,""],[11013,1,""],[11012,1,""],[11012,0,"s of "],[11820,0,"\n5. Its faster *and* simpler. Holy grail."],[11850,0,"Thats wal"],[11858,1,""],[11857,1,""],[11856,1,""],[11856,0,"always the "],[11867,1,""],[11867,0,"h"],[11850,28,""],[11850,0,"Holy grail, right there."],[11848,26,""],[11848,0,"."],[11849,28,""],[11931,10,""],[11931,0,"Its "],[11897,34,""],[11897,0,"This approach is about"],[11919,3,""],[11930,0,", and"],[11935,10,""],[12302,0,"se"],[12434,0,", so its"],[12436,6,""],[12435,1,""],[12434,1,""],[12434,0,". The performance difference is nevr j"],[12471,1,""],[12470,1,""],[12469,1,""],[12469,0,"er just one thing"],[12462,0,"s aren't"],[12470,9,""],[12434,1,""],[12434,0,", so"],[12439,1,""],[12439,0,"t"],[12479,0,"this "],[12484,4,""],[12281,0,"> Note: "],[12289,11,""],[12289,0,"S"],[12289,90,""],[12398,0," Some of these performance improvements come from the fact I'm also not using immutablejs. "],[12399,58,""],[12430,1,""],[12430,0," here"],[12434,1,""],[12433,1,""],[12432,1,""],[12431,1,""],[12430,1,""],[12429,1,""],[12429,0," here - which will also make a big performane "],[12474,1,""],[12473,1,""],[12473,0,"ce difference."],[12443,4,""],[12443,0,"is"],[12454,1,""],[12454,0,"ing"],[12464,11,""],[12464,0,"performance"],[12446,0,"probably "],[12473,11,""],[12473,0,"impact on performance"],[12494,12,""],[12494,0,"."],[12520,0,"\n"],[12520,0,"\nThis is better, but its still not *fast*."],[12673,0,"\n"],[12563,1,""],[12672,0,"\nThis is better, but its still not *fast*."],[12521,42,""],[12566,0," / abstraction"],[12525,0,"that "],[12546,6,""],[12546,0,"correct "],[12564,12,""],[12575,22,""],[12575,0,","],[12575,1,""],[12575,0," its time to "],[12588,12,""],[12587,1,""],[12591,0," our"],[12594,1,""],[12593,1,""],[12592,1,""],[12591,1,""],[12521,10,""],[12521,0,"W"],[12567,0,", "],[12568,1,""],[12567,1,""],[12566,1,""],[12566,0,", but the implementation iss"],[12593,1,""],[12593,0," still not *fast*. "],[12612,1,""],[12612,0,"I"],[12631,0," big"],[12656,1,""],[12656,0,"."],[12657,43,""],[12656,1,""],[12656,0,":"],[12692,0,","],[12648,8,""],[12648,0,"bottlenecks in this algorithm"],[12757,4,""],[12757,0,"W"],[12861,5,""],[13177,6,""],[13177,0,"I"],[13282,6,""],[13427,1,""],[13427,0,". We also need to figureout "],[13454,1,""],[13453,1,""],[13452,1,""],[13451,1,""],[13450,1,""],[13450,0," "],[13450,1,""],[13450,0,"e out the parent of thi"],[13472,1,""],[13472,0,"e new item."],[13483,41,""],[13445,0,"take a look at nearby operations to "],[13523,0,"th"],[13524,1,""],[13523,1,""],[13523,0," the user"],[13532,5,""],[13539,0,"s"],[13640,1,""],[13640,0,"."],[13687,7,""],[13687,0,"t"],[13684,4,""],[13684,0,"the cod d"],[13692,1,""],[13691,1,""],[13691,0,"e does this"],[13866,0," *after* the new item"],[13906,0," in the array"],[13965,6,""],[13964,1,""],[13963,1,""],[13963,0,"\n\n> T"],[13967,1,""],[13966,1,""],[13965,1,""],[13964,1,""],[13963,1,""],[13963,0," (I'm "],[13965,0,"Well, "],[13983,11,""],[13983,0," v8"],[13985,1,""],[13984,1,""],[13984,0,"V8"],[13986,9,""],[14012,13,""],[14012,0,"here"],[14016,1,""],[14016,0,"."],[14018,5,""],[14018,0,"W"],[13953,9,""],[13953,0,"its still probably slow when we're moving thousands of items"],[14016,6,""],[14016,0,"Well, "],[14016,4,""],[14016,0,"Aside:"],[14022,1,""],[14035,0," here that"],[14073,5,""],[14075,0,"u"],[14075,1,""],[14075,0,"gut"],[14077,1,""],[14076,1,""],[14075,1,""],[14075,0,"But "],[14079,1,""],[14079,0,"w"],[14116,5,""],[14116,0,"in th"],[14120,1,""],[14119,1,""],[14119,0,"th"],[14118,3,""],[14116,2,""],[14116,0,"there"],[13995,9,""],[13995,0,"a"],[13995,1,""],[13995,0,"so many"],[14002,3,""],[13938,9,""],[13938,0," in native code"],[14148,0," in"],[14126,25,""],[14126,0,"Every time we insert into a document with n items"],[14201,53,""],[14201,0,"n steps of work"],[14168,0,"*"],[14170,0,"*"],[14203,0,"*"],[14205,0,"*"],[14212,8,""],[14221,21,""],[14221,0,"ee"],[14222,1,""],[14222,0,"very time we insert into a document where there have"],[14287,0,"*n* items "],[14312,0," - d"],[14315,1,""],[14314,1,""],[14313,1,""],[14312,1,""],[14312,0,". D"],[14314,1,""],[14313,1,""],[14312,1,""],[14312,0,", because deleted items are never really removed"],[14366,0," algorithm"],[14422,1,""],[14422,0," "],[14124,0,"\n\nInsert "],[14132,1,""],[14132,0,"ing an item will tak"],[14144,8,""],[14144,0,"into a document"],[14159,38,""],[14174,35,""],[14174,0," "],[14174,1,""],[14174,0,", the computer does about *n* steps"],[14174,25,""],[14174,0," will take"],[14196,5,""],[14196,0,"Nope, its worse than that."],[14222,15,""],[14223,1,""],[14223,0,"I"],[14229,0,"ing"],[14276,1,""],[14266,1,""],[14266,0,"*"],[14276,0,"*"],[14287,16,""],[14221,0," beau"],[14225,1,""],[14224,1,""],[14224,0,"cause deleted items aren't really removed"],[14331,48,""],[14331,0," will take n steps"],[14342,0,"*"],[14344,0,"*"],[14414,0,"In Big-O notation, "],[14433,1,""],[14433,0,"i"],[14466,0,"*"],[14473,0,"*"],[14443,0,"*"],[14445,0,"*"],[14477,0,"\n"],[14498,0,"\n"],[14498,0,"\nCan we fix this? Yes we can!"],[14529,0,"We need t"],[14537,1,""],[14529,8,""],[14962,0,", without sliding "],[14972,8,""],[14972,0,"copying all the existing items around"],[15009,7,""],[15009,0,"."],[15011,1,""],[15011,0,"W"],[15067,0," - because linked lists allow inser"],[15091,11,""],[15091,0,"c"],[15091,1,""],[15091,0,"allow inserts in the middle in O(1) time"],[15134,0,"Well, "],[15140,1,""],[15140,0,"i"],[15132,79,""],[15137,0," adds"],[15142,4,""],[15180,18,""],[15180,0,"thing"],[15800,18,""],[15800,0,"Aaah "],[15805,1,""],[15805,0,"f"],[15895,0,". Coll"],[15897,4,""],[15897,0,"We can only collapse runs of items "],[15932,18,""],[15931,1,""],[15951,8,""],[15937,14,""],[15937,0,"the iD"],[15942,1,""],[15941,1,""],[15941,0,"IDs and parents are sequential"],[15976,0," the code"],[15985,6,""],[15990,0,"s"],[15996,0," tricky"],[16003,8,""],[16034,0,"again "],[16066,10,""],[16082,4,""],[16082,0," a"],[16084,9,""],[16095,26,""],[16094,1,""],[16094,0,"t "],[16096,2,""],[16130,5,""],[16130,0,"entries"],[16096,0,"for this editing trace, "],[16096,24,""],[16096,0,"in Martin's editing trace, "],[15885,10,""],[15885,0," into a single item"],[15853,0,"Note "],[15858,1,""],[15858,0,"w"],[15860,0," unfortunately"],[15946,13,""],[15946,0,"inserts"],[15978,4,""],[15978,0," line up"],[15979,7,""],[15979,0,"are"],[15979,3,""],[15979,0,"line up"],[15997,0,"ly"],[16001,5,""],[16001,0,"T"],[16009,0," also"],[16026,6,""],[16025,1,""],[16001,33,""],[16001,0,"We'll also sometimes need to"],[16068,6,""],[16093,0," one of our"],[16104,2,""],[16115,26,""],[16115,0," in Martin's editing trace"],[16115,26,""],[16115,0,", with this benchmark data"],[16233,29,""],[16233,0,"How fast is it now? Yjs"],[16256,10,""],[16270,0," than the reference-crdts implementation, and it only "],[16324,16,""],[16324,0,"uses"],[16743,0," and confused"],[16748,8,""],[16748,0,"b"],[16748,1,""],[16748,0,"b"],[16748,1,""],[16748,0,"confused"],[16747,9,""],[16743,4,""],[16785,4,""],[16785,0," some"],[16790,9,""],[16811,0," is"],[16819,1,""],[16818,1,""],[16818,0,"ing"],[16869,42,""],[16869,0,"Leaving "],[16876,1,""],[16869,7,""],[16869,0,"Everything is faster in Rust, with B-Trees"],[16869,42,""],[16869,0,"Its"],[16869,3,""],[16869,0,"Everything is faster in Rust, with B-Trees"],[16869,42,""],[16869,0,"Javascript"],[16869,10,""],[16869,0,"Faster than Javascript"],[16893,22,""],[16970,1,""],[16970,0,", and"],[16976,1,""],[16976,0,"i"],[16936,36,""],[16893,0,"Yjs is very well optimized already, and I doub"],[16935,4,""],[16935,0,"suspect "],[16943,1,""],[16943,0,"j"],[16954,5,""],[16954,0,"can't"],[16942,0," we can't make"],[16967,9,""],[16967,0," run"],[16984,9,""],[16984,0,"in this test"],[16998,5,""],[16998,0,"I"],[16997,1,""],[16997,0,"\n\n"],[16998,1,""],[16997,1,""],[16997,0," "],[17081,1,""],[17081,0," w"],[17082,1,""],[17082,0,"- which we can only do"],[17053,51,""],[17053,0,"more control over the memory layout - which we can only do in a lower"],[17117,5,""],[17117,0,"sst"],[17119,1,""],[17118,1,""],[17118,0,"ystems "],[17104,5,""],[17120,0,"language like Rust."],[17320,0," in memory"],[17344,0,"By the way, "],[17357,1,""],[17357,0,"y"],[17385,0,"Its "],[17388,1,""],[17387,1,""],[17386,1,""],[17385,1,""],[17385,0,"Its terrible because "],[17406,1,""],[17406,0,"a"],[17422,0,"fragmented - "],[17434,1,""],[17433,1,""],[17432,1,""],[17432,0,". Its all "],[17468,30,""],[17468,0," arrange data like this"],[17528,0," for each item"],[17529,0,"one by one "],[17605,5,""],[17611,0,"all of those "],[17624,14,""],[17624,0,"objects"],[17602,0,"extra data "],[17674,12,""],[17674,0,"ll "],[17699,1,""],[17699,0,"."],[17700,6,""],[17700,0," I"],[17723,0," in memory"],[17699,1,""],[17699,0,", and"],[17705,1,""],[17705,0,"i"],[17699,38,""],[17801,5,""],[17806,0," as well"],[17816,2,""],[17816,0,"If we"],[17821,4,""],[17858,26,""],[17904,1,""],[17904,0,","],[17906,19,""],[17905,1,""],[17930,0," about"],[17949,1,""],[17949,0," -"],[17950,1,""],[17949,1,""],[17949,0,"- "],[17969,1,""],[17971,0,"At t"],[17974,1,""],[17973,1,""],[17972,1,""],[17972,0,"nd at this speed, "],[17990,4,""],[18016,17,""],[18016,0," takes the computer"],[17971,0,"In comps"],[17978,1,""],[17978,0,"arons"],[17982,1,""],[17981,1,""],[17980,1,""],[17980,0,"ison, "],[17986,4,""],[17999,1,""],[18094,5,""],[18103,6,""],[18102,1,""],[18107,1,""],[18106,1,""],[18105,1,""],[18105,0,"iting"],[18168,0," shopping "],[18177,1,""],[18056,1,""],[18056,0,"\n\n"],[18127,1,""],[18127,0,"."],[18129,1,""],[18129,0,"B"],[18223,14,""],[18229,5,""],[18229,0," item in the scavenger hunt names"],[18262,6,""],[18289,33,""],[18288,1,""],[18287,1,""],[18286,1,""],[18286,0,", with a hiddne"],[18300,1,""],[18299,1,""],[18299,0,"en"],[18301,5,""],[18333,0,"or whatever "],[18351,41,""],[18351,0," "],[18351,1,""],[18351,0,"\n\nReading the whole list would take ages."],[18352,1,""],[18351,1,""],[18350,1,""],[18350,0," "],[18350,1,""],[18350,0,". Needless to say, "],[18369,1,""],[18369,0,"r"],[18391,0," takes the computer"],[18410,11,""],[18416,0," ("],[18417,1,""],[18416,1,""],[18415,1,""],[18415,0," (in computer time)."],[18675,0,"linked li"],[18665,19,""],[18665,0,"F"],[18665,1,""],[18665,0,"With linked lists "],[18688,2,""],[18688,0," that"],[18743,18,""],[18727,16,""],[18727,0,"between items, and we do that a lot"],[18740,22,""],[18777,12,""],[18777,0,"F"],[18812,0," need a lot of objects, "],[18836,27,""],[18835,1,""],[18835,0," so"],[18838,4,""],[18838,0," we"],[18834,1,""],[18834,0,". So there's"],[18836,10,""],[18826,0," weird"],[18840,1,""],[18840,0,", which willen"],[18853,1,""],[18852,1,""],[18852,0," end up"],[18859,32,""],[18840,0," (like fixed size ara"],[18860,1,""],[18860,0,"rays)"],[18865,1,""],[18865,0,". These"],[18867,5,""],[18867,0,"In javascript"],[18880,11,""],[18880,0," "],[18867,14,""],[18867,0,"And that makes fragmentation worse, even as we're making the "],[18903,25,""],[18902,1,""],[18901,1,""],[18901,0,". Its a "],[18902,45,""],[18902,0," "],[18901,0,", which makes"],[18909,5,""],[18909,0,"can make things slow, "],[18930,1,""],[18929,1,""],[18929,0,"er, not faster"],[18999,0,"even "],[19004,49,""],[19014,0," we don't have to use javascript any more"],[18986,1,""],[18985,1,""],[18985,0," "],[18496,10,""],[18496,0,"I want to"],[18534,1,""],[18533,1,""],[18533,0,"."],[18535,1,""],[18535,0,"A"],[18639,6,""],[18655,79,""],[18655,0," (With linked lists we do that scavenger hunt each time we move between items!)"],[18675,25,""],[18675,0,"you incur a memory read"],[18708,3,""],[18708,0," you"],[18858,3,""],[18858,0,"All those extra objects"],[18881,5,""],[18909,0,"so the result is often"],[18931,21,""],[18952,0,"This is "],[18960,3,""],[18959,1,""],[19000,8,""],[19067,11,""],[19067,0,"WebAssembly"],[19081,2,""],[19081,0,"To see how fast we can *really* go,"],[19268,0,"the "],[19275,0," implemen"],[19276,8,""],[19275,1,""],[19272,0,"previous "],[19272,9,""],[19268,4,""],[19241,30,""],[19241,0,"works the same as yjs"],[19262,1,""],[19262,0,","],[19264,1,""],[19264,0,"b"],[19309,0," internally"],[19740,9,""],[19740,0,"any item."],[19784,4,""],[19784,0,". Updates"],[19793,1,""],[19798,1,""],[19810,0,"so again"],[19818,8,""],[19832,0," and we're done"],[19889,0,"\n"],[19889,0,"\nWhen we"],[19890,7,""],[19890,0,"It doesn't compe"],[19905,1,""],[19904,1,""],[19904,0,"e into play here, but when merging remote edits we also need to find items by their ID ("],[19992,71,""],[20009,0," My rust implementation has an index to make this fast, too."],[20071,39,""],[20071,0,"I'm not using"],[20125,0," - which might make it "],[20128,20,""],[20128,0,"at least not yet"],[20148,0,"just "],[20166,10,""],[20166,0," it."],[20146,0,"Mayb eit w"],[20155,1,""],[20154,1,""],[20153,1,""],[20152,1,""],[20151,1,""],[20150,1,""],[20150,0,"e it would help? "],[20168,5,""],[20192,45,""],[20192,0," avoids "],[20199,1,""],[20192,7,""],[20192,0," lets us pack all the items tightly in memory"],[20192,45,""],[20192,0," gives us total control over the memory lat"],[20234,1,""],[20234,0,"yout, so we can pack everything in tightly"],[20309,0,"a run of "],[20328,28,""],[20328,0," "],[20328,1,""],[20328,0,", all packed"],[20334,6,""],[20334,0,"adjacent in RAM"],[20436,3,""],[20436,0,"Memcpy"],[20442,7,""],[20442,0," is always"],[20483,1,""],[20483,0," - its a few hearb"],[20500,1,""],[20500,0,"t beats. Not a scavenger hunt."],[20486,4,""],[20486,0,"its "],[20513,0,"the "],[20517,2,""],[20531,0," of a main memory lookup"],[20642,6,""],[20642,0,"we can now proces "],[20659,1,""],[20659,0,"s the whole trace in"],[20679,7,""],[20598,12,""],[20598,0,"Driven from "],[20621,7,""],[20621,0,"to"],[20598,25,""],[20598,0,"If we compile this code to"],[20636,0," and drive it from javascript"],[20723,0,"And if we compile it to native code and "],[20763,6,""],[20763,0,"call it"],[20828,0,"*"],[20844,0,"*"],[20845,1,""],[20845,0,":"],[20845,1,""],[20845,0,"."],[21353,0,"I've done "],[21363,8,""],[21377,10,""],[21352,0,"\n"],[21352,0,"\n---"],[21461,0," and I couldn't help myself"],[21490,0,"In this implementation, "],[21541,4,""],[21525,0," text"],[21577,0," The reason is that"],[21597,1,""],[21597,0,"w"],[21842,0," too"],[21772,1,""],[21772,0," don't think it"],[21787,8,""],[21792,0,"s"],[21859,3,""],[21859,0,"m"],[21859,1,""],[21856,3,""],[21856,0,"My"],[21917,28,""],[21917,0,"[i"],[21918,1,""],[21917,1,""],[21917,0,"Btree"],[21917,0,"<"],[21923,0," of {"],[21927,1,""],[21927,0,"[item, item item"],[21938,0,","],[21944,0,", ...]"],[21932,0," span"],[21943,0," span"],[21950,6,""],[21954,1,""],[21954,0,">,"],[16869,0,"Making it "],[16879,1,""],[16879,0,"f"],[21362,0,"\n"],[21362,0,"\nThi"],[21365,1,""],[21364,1,""],[21363,1,""],[21363,0,"This code is faster than using a raw javascript string."],[21388,0,"editing"],[21395,5,""],[21397,0," normal"],[21404,4,""],[21363,0,"Even from webassembly "],[21384,1,""],[21384,0,", "],[21368,4,""],[21368,0,"through"],[21389,1,""],[21389,0,"t"],[21401,0," 3x"],[21426,0," nai"],[21429,1,""],[21429,0,"tive"],[21433,7,""],[21458,0,"\nBut"],[21462,1,""],[21462,0," "],[21552,7,""],[21552,0," sounded"],[21622,5,""],[21622,0,"split out"],[21635,0," document's"],[21660,7,""],[22136,0,"I'm "],[22136,4,""],[21968,0," "],[21968,1,""],[21968,0," Its a \"struct of arrays\" rather than \"array of structs\" approach."],[21968,1,""],[21968,0,"\n\n"],[22037,0,"So "],[22040,1,""],[22040,0,"m"],[22036,1,""],[22035,1,""],[22035,0," "],[22036,4,""],[22036,0,"M"],[22034,1,""],[22034,0,", with"],[22041,1,""],[22041,0,"m"],[22074,1,""],[22074,0,"ing"],[22415,0,"So "],[22418,1,""],[22418,0,"l"],[23120,14,""],[23120,0,". Thats how you implement a CRDT."],[22595,0," Semantics | LAng"],[22611,1,""],[22610,1,""],[22609,1,""],[22609,0,"anguage | Data structure"],[22696,0," ---------"],[22769,0," AM"],[22771,1,""],[22770,1,""],[22770,0,"RGA"],[22836,0,"RGA"],[22838,1,""],[22837,1,""],[22836,1,""],[22836,0," RGA / YATA"],[22910,0," YATA"],[22978,0," (none)"],[23048,0," YATA"],[23116,0," YATA"],[23184,0," YATA"],[22706,0," "],[22634,73,""],[22634,0,"| --------------------------        | ---------- | --------- | ---------"],[22847,0," |"],[22773,0,"        |"],[22606,0," "],[22707,0,"--"],[22708,1,""],[22708,0," | --------"],[22795,0," Javascript"],[22796,10,""],[22796,0,"JS"],[22874,0," JS"],[22945,0,"       | JS"],[22596,23,""],[22595,1,""],[22674,21,""],[22674,0,"---------- | --------"],[22685,10,""],[22684,1,""],[22684,0,"-----|"],[22610,0," |"],[22756,15,""],[22756,0,"T"],[22756,1,""],[22756,0,"Naive-tree     |"],[22761,1,""],[22761,0," "],[22836,15,""],[22836,0,"Array          |"],[22916,15,""],[22916,0,"Linked list    |"],[22996,6,""],[22996,0,"(none)         |"],[23076,4,""],[23013,63,""],[23013,0,"| Rust (Called from JS via WASM)    | 0.20s      | ???       |"],[23002,0,"*"],[22996,0,"*"],[23004,2,""],[23075,0," B-Tree"],[23146,4,""],[23146,0,"B-Tree"],[23216,4,""],[23216,0,"B-Tree"],[23082,0,"         |"],[23162,0," "],[23093,70,""],[23093,0,"| Rust (native)                     | 0.065s     | 2.3 MB    | B-Tree         |"],[23242,0,"         |"],[22946,0,"*"],[22935,0,"*"],[22948,2,""],[23306,0,"\n\n\n"],[28386,64,""],[28386,0,"You can't tell from looking at this method, but insertionsAfter"],[24905,4073,""],[24694,211,""],[23308,0,"\n\n"],[7740,1,""],[9091,1,""],[12498,1,""],[14480,1,""],[14479,1,""],[16861,1,""],[16858,0,"\nBut we"],[16859,6,""],[16859,0,"We"],[16860,1,""],[16859,1,""],[16859,0,"But we can go faster"],[16859,5,""],[16859,0,"W"],[16859,16,""],[17144,0,"\n"],[16897,1,""],[17143,0,"\n## Making it faster than Javascript"],[16861,36,""],[17107,0,"\n"],[16860,1,""],[17106,0,"\n"],[16859,1,""],[16858,0,"\n"],[16858,0,"\nBut can we still go "],[16859,5,""],[16859,0,"C"],[16875,0,"faster?"],[16859,0,"But "],[16863,1,""],[16863,0,"c"],[16859,5,""],[16859,0,"C"],[16859,24,""],[16859,0,"Can we still go faster?"],[16859,270,""],[16859,0,"Can we still go faster? Yjs is very well optimized already, and I suspect we can't make javascript run much faster in this test. If we want to continue to improve performance, we need more control over the memory layout - which we can do in a systems language like Rust."],[17078,51,""],[17078,0,"."],[17085,11,""],[17085,0,"F"],[17043,0,"to go lower level. W"],[17062,1,""],[17061,1,""],[17061,0," We need"],[17069,4,""],[16988,113,""],[16859,129,""],[16859,0,"Can we still go faster? Yjs is very well optimized already, and I suspect we can't make javascript run much faster in this test."],[17016,0,"\nIf we want to continue to improve performance, we need to go lower level. We need control over the memory layout."],[16987,0," But maybe.. just maybe we can be"],[17020,1,""],[17104,6,""],[17104,0,"a "],[17117,0," language, and we need"],[17139,9,""],[17128,0,"so we"],[17133,11,""],[17133,0," can"],[17145,5,""],[17369,12,""],[17370,1,""],[17370,0,"Y"],[17398,3,""],[17398,0,"This is"],[17833,0,"How slow? "],[17681,1,""],[17680,1,""],[17680,0," "],[17831,1,""],[17831,0,"\n\n"],[17841,0," are main memory reads"],[17973,0," would"],[17984,1,""],[18002,8,""],[18002,0,". The omp"],[18010,1,""],[18009,1,""],[18008,1,""],[18008,0,"computer "],[18002,15,""],[18002,0," - about"],[18012,0," human"],[18060,4,""],[18060,0,"every"],[18087,0," wl"],[18089,1,""],[18089,0,"ill"],[18112,0,"almost "],[18128,1,""],[18128,0,"!"],[18131,0,"This is what we do do to"],[18154,1,""],[18154,0,"he "],[18150,7,""],[18150,0,"do"],[18151,1,""],[18150,1,""],[18150,0,"to the computer when it runs javascript. In "],[18194,9,""],[18193,1,""],[18193,0," Arranging"],[18193,1,""],[18190,3,""],[18178,12,""],[18173,5,""],[18170,3,""],[18165,5,""],[18156,9,""],[18152,4,""],[18150,2,""],[18150,0,"do"],[18150,2,""],[18150,0,"do the "],[18156,1,""],[18154,2,""],[18154,0,"o"],[18152,3,""],[18149,3,""],[18146,3,""],[18143,3,""],[18138,5,""],[18135,3,""],[18131,4,""],[18200,1,""],[18200,0,"."],[18129,0," Imagine instead of "],[18130,19,""],[18129,1,""],[18471,13,""],[16471,1,""],[16471,0,":"],[16459,1,""],[16459,0,":"],[22711,1,""],[21019,1,""],[16459,1,""],[12074,1,""],[7609,1,""],[22707,0,":"],[21016,0,":"],[16457,0,":"],[12073,0,":"],[7609,0,":"],[22723,1,""],[21031,1,""],[16471,1,""],[12086,1,""],[7621,1,""],[22719,0,":"],[21028,0,":"],[16469,0,":"],[12085,0,":"],[7621,0,":"],[16727,0,"Honestly "],[16747,0," and a little suspicious of"],[22992,1,""],[21249,1,""],[16653,1,""],[22990,0,"2"],[21248,0,"2"],[16653,0,"2"],[22992,1,""],[21249,1,""],[16653,1,""],[22990,0,"3"],[21248,0,"3"],[16653,0,"3"],[17084,0,"\n\n"],[17085,0,"I "],[17086,1,""],[17085,1,""],[17085,0,"When I told Kevin that h"],[17108,1,""],[17108,0,"I thought I could "],[17085,41,""],[17085,0,"When I told Kevin that I thought I could"],[17056,0,"..."],[17128,0," we "],[17121,11,""],[17121,0,"a good rust impleemntation"],[17133,14,""],[17133,0,"implementation would go faster"],[17121,0,"I could make a"],[17134,1,""],[17160,0," that went "],[17171,10,""],[17177,0," than yjs, he didn't believe me. EH"],[17211,1,""],[17210,1,""],[17210,0,"He said yjs was already so optimized, he"],[17134,11,""],[17134,0,"CRDT"],[17134,0,"a "],[17160,5,""],[17160,0," goes"],[17244,1,""],[17243,1,""],[17243,0,"he doubted i"],[17254,1,""],[17253,1,""],[17243,10,""],[17243,0,"there wasn't much "],[17243,18,""],[17243,0,"going even faster was going to be basically impossible."],[17264,0,"n't"],[17280,20,""],[17280,0,"possibe"],[17286,1,""],[17286,0,"l"],[17286,1,""],[17286,0,"le"],[17160,5,""],[17160,0,"s"],[17228,0,"well "],[17261,0," probably"],[17277,12,""],[17287,0,"\n\nBut I knew about"],[17300,5,""],[17300,0,"something he dd"],[17314,1,""],[17314,0,"idn't: The way the computer organizes memory and memory lookups"],[17321,0,"U"],[17321,1,""],[17321,0,"We can use rust to "],[17321,18,""],[17321,0,"If we can control"],[17338,8,""],[17342,0," way the"],[17321,74,""],[17289,32,""],[17289,0,"But I knew something he didn't:"],[17287,0," \"Maybe a little faster... but not a lot faster!\""],[17310,0," in "],[17313,1,""],[17312,1,""],[17312,0,"f you just port it to rust"],[17338,2,""],[17338,0,"."],[17338,1,""],[17334,1,""],[17334,0,"R"],[17340,1,""],[17340,0,"B"],[17162,0,"way "],[17165,1,""],[17165,0," "],[17348,4,""],[17348,0,"it won't go "],[17374,0,"."],[17374,1,""],[17397,2,""],[17397,0,"Kevin"],[17409,0," know"],[17415,0," I knew about memory fragmentation c"],[17450,1,""],[17450,0,"and cache coherent structures."],[17347,12,""],[17347,0," not"],[17213,1,""],[17213,0,"Y"],[17258,0," a little bit"],[17253,18,""],[17253,0," a lot"],[17367,0," V"],[17368,1,""],[17367,1,""],[17366,0," V8 is really fast these days!"],[17405,4,""],[17405,0,"know"],[17405,4,""],[17405,0,"knew"],[17490,1,""],[17490,0,"cy"],[17492,11,""],[17509,31,""],[17509,0,"keep making yjs"],[17520,4,""],[17520,0," our algorithms "],[17493,54,""],[17493,0," Rust isn't just *faster*. It "],[17522,1,""],[17522,0,"s also"],[17551,21,""],[17551,0,"and that gives us the tools we need to control allocations and the"],[17614,3,""],[17613,1,""],[16893,0," Apparently some parts of yjs have been rewritten about 11 tives"],[16956,1,""],[16955,1,""],[16954,1,""],[16954,0,"mes in order to make it go that fast"],[16977,13,""],[16977,0," work so well. "],[16991,1,""],[16991,0," ITs super"],[16992,9,""],[16992,0,"Its super impressive!"],[16923,9,""],[16923,0,"were"],[16923,4,""],[16923,0,"have been"],[16950,1,""],[16950,0,"2"],[16991,22,""],[16990,1,""],[16990,0,"!"],[16993,0,"But "],[16997,1,""],[16997,0,"c"],[16993,5,""],[16993,0,"C"],[17017,40,""],[16993,0,"But "],[16997,1,""],[16997,0,"c"],[17019,0," anyway"],[17028,0,"Honestly "],[17039,21,""],[17039,0,"doubt I can mae"],[17053,1,""],[17053,0,"ke"],[17071,14,""],[17070,1,""],[17080,0," any faster than Kevin did"],[17039,5,""],[17038,1,""],[17038,0,"'m nervous about running"],[17054,8,""],[17048,6,""],[17040,8,""],[17038,2,""],[17038,0," doubt"],[17056,0,"pure "],[17165,0,"Pure "],[17165,5,""],[17484,0,"!"],[17718,0,"\n\n(I k"],[17723,1,""],[17723,0,"sway"],[17726,1,""],[17725,1,""],[17724,1,""],[17724,0,"ay *n"],[17728,1,""],[17728,0,"knew"],[17731,1,""],[17731,0,"w* because Kevin h"],[17748,1,""],[17748,0,"is copying me right back, and ork"],[17780,1,""],[17779,1,""],[17778,1,""],[17778,0,"working on "],[17723,11,""],[17723,0,"use the past tense here "],[17802,0,"[Yrs](https://github.com/yjs/y-crdt) - a rust port"],[17841,2,""],[17841,0,"his own "],[17858,0," of Yjs that "],[17870,1,""],[17869,1,""],[17868,1,""],[17868,0,"at "],[17870,1,""],[17869,1,""],[17868,1,""],[17867,1,""],[17866,1,""],[17865,1,""],[17865,0,"!)"],[17720,0,"> "],[17722,1,""],[17867,1,""],[18072,0,"Bad news: "],[18456,7,""],[18456,0,"will often"],[18471,1,""],[18746,16,""],[18746,0,"A"],[18811,7,""],[18811,0," close to"],[18831,0,"\n\n> Interactive vis showing 100 seconds vs 0.5 seconds"],[18886,0,"\n"],[18886,0,"\nIts the difference between reading a piece of paper, and reading a piece of paper witha sca"],[18977,1,""],[18976,1,""],[18975,1,""],[18974,1,""],[18973,1,""],[18973,0," location in your house. Then you have to go there, search around and *then* you find a pi"],[19044,19,""],[19044,0,"there"],[19048,1,""],[19047,1,""],[19046,1,""],[19045,1,""],[19044,1,""],[19043,1,""],[19043,0,"there you find another"],[18923,0," note on a"],[18964,0,"scavenger hunt"],[18978,14,""],[18983,0," a"],[19009,7,""],[19009,0," Y"],[19065,0,"*"],[19073,0,"* piece of paper with the actual note on it."],[18886,231,""],[18885,1,""],[18956,5,""],[18956,0,", only"],[18974,0,"\"Cheese, Milk, Bread\", "],[18997,20,""],[18996,1,""],[19015,25,""],[19015,0," has"],[19018,1,""],[19017,1,""],[19016,1,""],[19016,0,"lists a series of"],[19048,0,"s"],[19061,28,""],[19084,1,""],[19084,0," - and only when you search around there will you find"],[19138,5,""],[19153,6,""],[19153,0,"which actually says you need"],[19188,30,""],[19236,5,""],[19237,3,""],[19251,0," ages"],[19312,0," so our data is all together in memory"],[19315,12,""],[19315,0," its"],[19344,3,""],[19343,1,""],[19345,0," also"],[19343,0,"\n\n\n"],[19343,0," This is why linked"],[19344,18,""],[19344,0,"There's a reason why alno"],[19368,1,""],[19367,1,""],[19367,0,"most nobody uses linked lists"],[18596,8,""],[18596,0,"everything t"],[18607,1,""],[18607,0,"your computer does"],[18625,8,""],[19029,5,""],[19029,0,"is"],[19066,4,""],[19066,0,"thin "],[19070,1,""],[19070,0,"g you need to buy"],[19061,22,""],[19061,0,"The name"],[19061,36,""],[19061,0,"Each item on your shopping list names somewhere in your house"],[19122,6,""],[19122,0,"."],[19124,1,""],[19124,0,"Y"],[19124,1,""],[19124,0,"O"],[19215,1,""],[19219,1,""],[19215,1,""],[19215,0,"m"],[19267,15,""],[19267,0,"you"],[19269,1,""],[19268,1,""],[19267,1,""],[19266,1,""],[19271,0," for your computer)"],[19272,0,"("],[19273,17,""],[19273,0,"relatively speaking"],[19293,0," ages"],[19297,1,""],[19296,1,""],[19295,1,""],[19294,1,""],[19293,1,""],[19353,7,""],[19353,0,"thecompu"],[19360,1,""],[19359,1,""],[19358,1,""],[19357,1,""],[19356,1,""],[19356,0," computer can fetch it all in one go"],[19392,19,""],[19446,0," and this is u"],[19459,1,""],[19459,0,"it - memory fragmentation su"],[19486,1,""],[19485,1,""],[19485,0,"ruins performance in the real world."],[19415,19,""],[19427,0," are almost never used in the real world"],[19523,18,""],[19526,2,""],[19568,24,""],[19568,0," because"],[19674,78,""],[19658,0,"those "],[19525,1,""],[19524,1,""],[19524,0," "],[19714,0,"The problem with "],[19731,1,""],[19731,0,"f"],[19767,0,"is that you end up "],[19790,0,"ing"],[19871,1,""],[19896,19,""],[19896,0,"as a result your programs often end up running"],[19949,12,""],[19949,0," anyway"],[19908,0,"of all that work "],[20018,0,", and why it han"],[20033,1,""],[20033,0,"sn't gotten faster in"],[20037,17,""],[20037,0," really gotten any faster"],[20502,0," And at l"],[20510,1,""],[20510,0,"each leaf, ew "],[20523,1,""],[20522,1,""],[20521,1,""],[20521,0,"we store 32 spans of inserts (!)"],[20549,0,", a"],[20551,1,""],[20550,1,""],[20549,1,""],[20530,0,"a chunk of "],[20560,0,", all congi"],[20570,1,""],[20569,1,""],[20569,0,"tiguous in memory"],[20587,1,""],[20586,1,""],[20587,1,""],[20543,9,""],[20550,1,""],[20550,0," spans"],[20872,0,"about "],[20972,0," after"],[21208,0," "],[21208,1,""],[21208,0," also"],[21212,1,""],[21211,1,""],[21210,1,""],[21209,1,""],[21208,1,""],[20502,81,""],[21357,32,""],[21357,0,"I'm storing an inline array"],[21384,4,""],[21398,0," in each leaf node"],[21379,0,"packed "],[21423,21,""],[21445,1,""],[21449,6,""],[21449,0," result in"],[21586,0,"Its "],[21590,1,""],[21590,0,"n"],[21584,0," per word"],[21595,4,""],[21594,1,""],[21593,1,""],[21593,0,", as opposed to "],[21609,4,""],[21567,26,""],[21567,0,"a few bytes per heartbeat"],[21611,0," epic "],[21616,1,""],[21946,0," Thats 4400"],[21956,1,""],[21955,1,""],[21954,1,""],[21954,0,"500x faster than the"],[21971,3,""],[21971,0,"where we started with automerge."],[22002,1,""],[22002,0,", or about 4.3 million p"],[22025,1,""],[22025,0,"operations every second."],[22003,1,""],[22002,1,""],[22002,0,". It can process"],[22018,2,""],[22019,6,""],[22023,0,"*"],[22031,0,"*"],[22376,0,"*"],[22388,0,"*"],[22389,2,""],[22660,511,""],[25386,0,"\nBut I've done one last thing. I don't know if its a good idea, but I did it anyway because it sounded clever and I couldn't help myself. In this implementation, I split out the document's text content into a separate data structure. The reason is that when you're actually doing collaborative editing, you probably want all the characters in your document to be stored in an actual array, or in VS Code's editor or something. I don't think it makes sense to duplicate the document's content in my library too.\n\n"],[22659,0,"\nThis implementation uses a"],[22686,6,""],[22705,0," approach"],[22754,0," for the string content."],[22778,9,""],[22778,0," The complete"],[22783,8,""],[22783,0,"whole"],[22783,5,""],[22782,1,""],[22808,8,""],[22808,0," looks"],[22852,9,""],[22852,0,"{}"],[22853,0,"id, parent, ..."],[22855,0," len"],[22858,1,""],[22857,1,""],[22856,1,""],[22855,1,""],[22855,0,", length"],[22871,5,""],[22874,9,""],[22874,0,"{id, length, parent}"],[22967,0,"\n"],[22967,0,"\nAll the tet"],[22978,1,""],[22978,0,"xt content itslef"],[22994,1,""],[22993,1,""],[22992,1,""],[22992,0,"elf is pulled out into a rope library "],[23029,1,""],[23029,0,". (Smart"],[23032,5,""],[23032,0,"Ropes are smart strings)"],[23055,0,". Get it?"],[23041,6,""],[23041,0," fancy"],[23065,2,""],[23065,0,". "],[23087,0," here"],[23147,1,""],[23146,1,""],[23146,0,", work"],[23151,1,""],[23150,1,""],[23149,1,""],[23149,0,"hich works great"],[23165,15,""],[23197,0," so fast that"],[23210,12,""],[23216,0," "],[23216,1,""],[23216,0," is actually dominating"],[23211,28,""],[23211,0,"most of the algorithm's time is spent in ropey"],[23249,0,"updating things "],[23274,97,""],[23275,1,""],[23275,0,"W"],[23307,4,""],[23307,0,"ropey"],[23275,0,"Its not "],[23275,8,""],[24101,0," 11 million operations / e"],[24126,1,""],[24126,0,"second."],[24138,1,""],[24138,0,", my friends, is"],[24182,0,"\n# Conco"],[24189,1,""],[24189,0,"liution"],[24195,1,""],[24194,1,""],[24193,1,""],[24192,1,""],[24191,1,""],[24190,1,""],[24190,0,"usion\n\nI'm really g"],[24201,8,""],[24201,0,"kind of grateful for that paper now. I'"],[24239,1,""],[24238,1,""],[24237,1,""],[24237,0," I mean, you don't lik"],[24237,22,""],[24227,0,"silly academic "],[24252,0," I used to think that academics were really clever, but it turns out there'"],[24326,1,""],[24325,1,""],[24324,1,""],[24324,0,"y're just like the rest of us."],[24334,0,"as myopic and obsessive as "],[24361,8,""],[24360,1,""],[24360,0," the"],[24376,0," (I'm no"],[24383,1,""],[24382,1,""],[24381,1,""],[24380,1,""],[24379,1,""],[24378,1,""],[24378,0,"Well not me - "],[24321,71,""],[24321,0,"that"],[24308,17,""],[24308,0,"apparenyl"],[24316,1,""],[24315,1,""],[24315,0,"tly being good at writing papers is a "],[24197,156,""],[24197,0,"I'm kind of grateful for that silly academic paper now. I used to think that academics were really clever, but apparently being good at writing papers is a"],[24100,0," than automerge"],[24317,50,""],[24317,0," (and maybe I'm not that"],[24333,0,"just "],[24342,4,""],[24342,0,"smart enough)"],[24354,0,"!"],[24356,0,"."],[24354,1,""],[24355,1,""],[24355,0,"!"],[24331,23,""],[24331,0,"ll just enver be"],[24339,8,""],[24339,0,"never be that smart"],[24360,0," Now I know that "],[24212,165,""],[24212,0,"I'm kind of grateful for that silly academic paper now. I used to think that academics were really clever (and maybe I'll just never be that smart)! Now I know that"],[24361,15,""],[24361,0,"But I'm starting to realise that t"],[24394,1,""],[24394,0,"they're just a "],[24408,1,""],[24408,0,"s "],[24407,3,""],[24407,0,"like the rest of us - obsessed "],[24427,1,""],[24426,1,""],[24426,0,". They're smart in one domain, and kinf "],[24465,1,""],[24464,1,""],[24464,0,"d of"],[24468,10,""],[24468,0," terrible"],[24299,18,""],[24299,0,"must be the smartest people around"],[24381,29,""],[24388,0," reaj"],[24392,1,""],[24392,0,"lly"],[24430,5,""],[24430,0,"great at"],[24438,3,""],[24442,7,""],[24442,0," obsession"],[24420,0," mugs"],[24443,0," theri"],[24448,1,""],[24447,1,""],[24447,0,"ir"],[24454,9,""],[24454,0,"special interest area"],[24497,0," everywhere else.\n\nInventing a CRDT al"],[24534,1,""],[24533,1,""],[24526,0,"the semantics for concurrent editing is really hard "],[24566,11,""],[24565,1,""],[24564,1,""],[24563,1,""],[24563,0,"sounds"],[24563,6,""],[24544,0,"per"],[24546,1,""],[24546,0,"er-to-peer "],[24576,0,"sounds terrifying"],[24516,85,""],[24516,0,"Inventing the semantics for peer-to-peer concurrent editing sounds terrifying a CRDT"],[24424,1,""],[24423,1,""],[24422,1,""],[24421,1,""],[24420,1,""],[24444,4,""],[24535,56,""],[24535,0,"a CRDT"],[24507,0,"I wasn't smart enough "],[24528,0," to figure out the semantics for "],[24561,29,""],[24507,0,"I really wa"],[24517,1,""],[24517,0,"anted list cRD"],[24530,1,""],[24529,1,""],[24528,1,""],[24528,0,"CRDTs "],[24507,9,""],[24507,0,"We really needed a "],[24526,7,""],[24535,1,""],[24535,0," "],[24284,5,""],[24293,5,""],[24293,0," were"],[24298,3,""],[24528,0,"on Wave"],[24528,7,""],[24527,1,""],[24499,0,"Google wave, all those years ago "],[24531,1,""],[24531,0,", really wa"],[24541,1,""],[24540,1,""],[24540,0,"needed"],[24546,16,""],[24548,0," high performance"],[24575,0,". I wasn't "],[24586,61,""],[24586,0,"smart enough to invent one"],[24577,0,"I li"],[24580,1,""],[24579,1,""],[24579,0,"think pretty highly of myself, but "],[24649,0," back then. "],[24660,1,""],[24660,0," So "],[24660,0," And because the academics didn't make CRDTs fast, I assumed nobd"],[24724,1,""],[24724,0,"ody could. "],[24734,5,""],[24734,0," I might"],[24735,0,"But, "],[24739,1,""],[24738,1,""],[24738,0," "],[24746,0," not me "],[24753,1,""],[24752,1,""],[24751,1,""],[24751,0,"be clever enough to in"],[24577,37,""],[24577,0,"And "],[24616,10,""],[24580,0," back then"],[24628,0,"I assumed that"],[24642,3,""],[24651,3,""],[24650,1,""],[24661,0,"couldn't "],[24670,7,""],[24674,0," their"],[24686,0," run"],[24697,10,""],[24710,1,""],[24710,0,"\n\n"],[24710,0," That was wrong - I "],[24729,1,""],[24728,1,""],[24728,0,"my forte isn't "],[24499,244,""],[24499,0,"Google wave, all those years ago, really needed a high performance list CRDT. And back then I wasn't smart enough to invent one. I assumed that because academics couldn't make their CRDTs run fast, nobody could. That was wrong - my forte isn't"],[24392,0," mugs"],[24477,8,""],[24477,0,"middling"],[24582,5,""],[24582,0,"B"],[24594,22,""],[24594,0,"didn't manage to"],[24623,0,"When papers like LOGOOT and WOOT came out and their algorithms ran really slowly, "],[24665,3,""],[24665,0,"I was exce"],[24674,1,""],[24674,0,"ited - but"],[24719,1,""],[24719,0,"."],[24744,0,"the "],[24757,0," involved"],[24553,17,""],[24553,0," good quality"],[24577,0," Our federation model was bonkers, and it would b"],[24625,1,""],[24625,0,"have been so simple with  a"],[24651,1,""],[24650,1,""],[24650,0,"a CRDT. But"],[24663,1,""],[24663,0,"b"],[24663,1,""],[24662,1,""],[24662,0,"ba"],[24658,45,""],[24658,0,"So "],[24661,1,""],[24661,0,"w"],[24705,3,""],[24705,0,"got"],[24758,0," And "],[24762,1,""],[24777,0," mea"],[24778,3,""],[24778,0,"meant the a"],[24773,16,""],[24773,0,"the aca"],[24773,7,""],[24773,0,"that was as fast as those algorithms could ever go, "],[24824,1,""],[24832,4,""],[24832,0," if"],[24845,0,"th"],[24846,1,""],[24845,1,""],[24836,0,"the "],[24849,9,""],[24899,1,""],[24899,0,"\n\n"],[24582,0,"wave "],[24582,0,"["],[24604,0,"]https://web.archive.org/web/20130330144116/http://www.waveprotocol.org/federation"],[24605,81,""],[24605,0,"(https://web.archive.org/web/20130330144116/http://www.waveprotocol.org/federation)"],[24604,84,""],[24582,1,""],[24616,0," "],[24616,1,""],[24616,0," and really buggy."],[24634,6,""],[24634,0," I"],[24621,6,""],[24621,0,"it never worked properly"],[24645,6,""],[24774,7,""],[24774,0," so "],[24777,8,""],[24777,0," slow they were unworkable"],[24647,21,""],[24647,0,"The whole thing would have been so much"],[24693,0,"r"],[24701,0," good"],[24713,4,""],[24713,0,"W"],[24578,135,""],[24578,0,"So "],[24581,1,""],[24581,0,"w"],[24578,19,""],[24578,0,"I got excited when"],[24621,16,""],[24597,0,"papers describing "],[24639,0,". But that excitemtn "],[24659,1,""],[24658,1,""],[24657,1,""],[24656,1,""],[24655,1,""],[24655,0,"ment "],[24650,10,""],[24650,0,"excitement turned to dust when I realised how slow and inefficient their algoirth"],[24723,8,""],[24723,0,"algi"],[24726,1,""],[24726,0,"orithms were"],[24738,21,""],[24738,0,". They"],[24777,1,""],[24777,0," - and"],[24783,74,""],[24821,9,""],[24820,1,""],[24819,1,""],[24818,1,""],[24818,0,"m "],[24819,1,""],[24855,0,"."],[24856,17,""],[24856,0," My gift to the world"],[24857,0,"Par t"],[24861,1,""],[24860,1,""],[24860,0,"t of "],[24865,1,""],[24865,0,"m"],[24857,9,""],[24857,0,"M"],[24877,0," isn't"],[24878,5,""],[24878,0,"might not be CRDT"],[24891,0,"inventing new classes of "],[24920,0,". But I do know how to make code run fast. And I was letting down the academics in turn b "],[25009,1,""],[25009,0,"y not showing up and doing my part.\n\n"],[24857,20,""],[24857,0,"I might have no idea how to "],[24885,14,""],[24893,1,""],[24892,1,""],[24891,1,""],[24891,15,""],[24896,0,"s"],[24933,0," really"],[24947,4,""],[24966,21,""],[24966,0,"everyone"],[24966,8,""],[24965,1,""],[24953,0,"quietly "],[24968,0," everyone"],[25018,1,""],[25018,0," in "],[25021,1,""],[25020,1,""],[25019,1,""],[25018,1,""],[25018,0," to m"],[25022,1,""],[25021,1,""],[25020,1,""],[25019,1,""],[25018,1,""],[25018,0," here."],[24222,1,""],[24221,1,""],[24220,1,""],[24219,1,""],[24218,1,""],[24217,1,""],[24216,1,""],[24216,0,"a little bit"],[24582,0," so"],[24584,1,""],[24583,1,""],[24583,0,"So"],[24605,0,"the "],[24615,11,""],[24615,0," for"],[24771,0," just"],[24793,0," I figured"],[24861,4,""],[24861,0,"But I"],[24886,19,""],[24886,0,"not be any good at"],[24911,0,"ing"],[24920,1,""],[24920,0,","],[24922,1,""],[24922,0,"b"],[24956,7,""],[24928,3,""],[24959,0," But I didn't even try to help out"],[24990,0,"those al"],[24997,1,""],[24997,0,"cademics "],[25009,0," and improve "],[25014,8,""],[25014,0,"fix up their algorithms."],[24978,0,"*"],[24982,0,"*"],[24982,1,""],[24978,1,""],[24966,0,"*"],[24982,0,"*"],[25029,10,""],[25029,0,"implementations"],[24520,22,""],[24509,0,"A decade ago "],[24533,7,""],[24566,3,""],[24566,0," So"],[24575,0," really"],[24610,0," the"],[24630,0," CRDTs"],[24773,4,""],[24773,0,"totally"],[24791,0," outside of the lab"],[24882,0," So I "],[24887,1,""],[24886,1,""],[24885,1,""],[24884,1,""],[24884,0,"o I ign'red them"],[24883,17,""],[24883,0,"And I ignored them."],[24970,0," do"],[24999,0," really"],[25061,20,""],[25061,0,"make good"],[25087,0," They were t"],[25098,1,""],[25098,0,"doing their part in this bi"],[25123,2,""],[25123,0,"dance, and I wasn't doing mine"],[25000,6,""],[25000,0,"stupidly"],[25000,8,""],[25000,0,"really"],[25016,0," here, in my own field,"],[25038,1,""],[25087,0," their"],[25093,5,""],[25109,0," work well"],[25186,0,"."],[25187,78,""],[25189,0,"I "],[25190,1,""],[25189,1,""],[25189,0,"I"],[25189,1,""],[25189,0,"I think the idea that everyone has some hiddne"],[25234,1,""],[25233,1,""],[25233,0,"en te"],[25237,1,""],[25237,0,"alent is tosh"],[25246,0,"a bit of "],[25246,9,""],[25250,0,". But I do think we all "],[25189,85,""],[25189,0,"I think the idea that everyone has some hidden talent is tosh. But I do think we all"],[24970,0," am prety"],[24978,1,""],[24978,0,"ty good at"],[24988,15,""],[24992,1,""],[24992,0,"ing"],[25004,7,""],[25011,3,""],[25011,0,"And"],[25036,0,","],[25036,1,""],[25036,0,","],[25082,10,""],[25082,0,"improve their"],[25111,10,""],[25265,0," have different proclivities and interests. We all have different songs to sing"],[25309,35,""],[25309,0,"Each of us a"],[25320,1,""],[25320,0,"has a song to sing over the city. A"],[25354,1,""],[25353,1,""],[25179,0," They figured out the semnatics"],[25201,9,""],[25201,0,"semantics, nut t"],[25216,1,""],[25215,1,""],[25214,1,""],[25213,1,""],[25212,1,""],[25212,0,"bnut t"],[25217,1,""],[25216,1,""],[25215,1,""],[25214,1,""],[25213,1,""],[25213,0,"ut the "],[25219,1,""],[25219,0,"y "],[24904,317,""],[24904,0,"But I was wrong. I might not be any good at inventing CRDTs, but I am pretty good at making code run fast. And here, in my own field, I *didn't even try* to help those academics improve their implementations. They were doing their part in this dance, and I wasn't doing mine. They figured out the semantics, but they"],[24615,0,"["],[24622,0,"](https://hal.inria.fr/inria-00432368/document)"],[24674,0,"["],[24679,0,"](https://hal.inria.fr/inria-00445975/document)"],[24741,0," 12 years ago"],[24996,0,"so "],[25177,46,""],[25213,0," strage"],[25219,1,""],[25218,1,""],[25217,1,""],[25216,1,""],[25216,0,"range"],[24507,0," (Is that a masis"],[24523,1,""],[24522,1,""],[24522,0,"sive"],[22655,3,""],[22655,0,"###"],[22657,1,""],[22657,0," Struct of arrays vs Array of structs"],[22695,0,"\n"],[22695,0,"\nI'm doing a slight of hand here - t"],[22730,1,""],[22729,1,""],[22728,1,""],[22727,1,""],[22727,0,". This implme"],[22739,1,""],[22738,1,""],[22738,0,"ementation isn't"],[22749,5,""],[22749,0,"has another small change - and I'm not sure ifI like"],[22793,8,""],[22793,0,"if I like it.\n\nIn javascript we have this:\n\n```\n{ item: 'hello', isDeleted: false, id: ['seph', 0], seq, parent: null },"],[22841,0,"doc = "],[22840,0,"javascript"],[22854,0,"."],[22854,1,""],[22857,0,"\n"],[22851,6,""],[22851,0,"doc ="],[22857,0,"["],[22857,1,""],[22856,1,""],[22856,0,"{"],[22856,1,""],[22856,0," {\n  content: [\n    "],[22872,0,"    { item: 'hello', isDeleted: false, id: ['seph', 0], seq, parent: null },\n"],[22962,5,""],[22962,0,"world"],[22981,5,""],[22981,0,"true"],[22993,4,""],[22993,0,"mike"],[23017,4,""],[23017,0,"['seph', 0]"],[23031,0,"\n    ...\n    "],[23040,4,""],[23040,0,"  ]\n  "],[23044,2,""],[23044,0,"}\n```\n\nIn rust I'm doing this:"],[22851,20,""],[22851,0,"doc = { content: ["],[22947,4,""],[22947,0,"  "],[22870,4,""],[22870,0,"  "],[23034,5,""],[23034,0,"] }"],[23035,1,""],[23060,0,"the equivalent of "],[23084,0,"\n"],[23084,0,"\n\n```javascript\ndoc = { content: [\n  { item: 'hello', isDeleted: false, id: ['seph', 0], seq, parent: null },\n  { item: 'world', isDeleted: true, id: ['mike', 0], seq, parent: ['seph', 0] },\n    ...\n]}\n```"],[23084,1,""],[23122,13,""],[23122,0,"length: 5"],[23133,18,""],[23175,13,""],[23175,0,"length: -5"],[23187,17,""],[23117,0,"\n  // No string content!"],[23106,1,""],[23106,0,"\n  "],[23258,4,""],[23258,0,"      "],[23197,2,""],[23197,0,"    "],[23144,2,""],[23144,0,"    "],[23120,2,""],[23120,0,"    "],[23264,6,""],[23264,0,"    "],[23271,1,""],[23271,0,"\n    "],[23272,4,""],[23272,0,"  "],[23275,0,"\n  "],[23276,2,""],[23275,0,",\n  \n  "],[23277,2,""],[23280,0,"textContent: 'hello' // Actually in a rope"],[23318,4,""],[23318,0,"Rope, not a string."],[23318,1,""],[23318,0,"r"],[23059,18,""],[23059,0," something l"],[23070,1,""],[23070,0,"more like"],[23108,0,"\n  clients: ['seph', 'mmi"],[23132,1,""],[23131,1,""],[23131,0,"ike'],\n  "],[23138,2,""],[23282,6,""],[23282,0,"0"],[23200,6,""],[23200,0,"0"],[23251,6,""],[23251,0,"1"],[23220,4,""],[23220,0,"[-1, -"],[23225,1,""],[23224,1,""],[23223,1,""],[23223,0,", 0]"],[23225,1,""],[23224,1,""],[23223,1,""],[23223,0,", -1"],[23231,0," // root "],[23232,8,""],[23231,1,""],[23141,7,""],[23141,0,"items"],[23148,0,"RangeTree "],[23322,0,"Rope "],[23334,37,""],[23326,0,"y Rope {"],[23342,0," }"],[23327,1,""],[23148,9,""],[23148,0,"BTree"],[23148,5,""],[23148,0,"RangeTree"],[23158,0,"{"],[23305,0,"}"],[23229,8,""],[23229,0,"NULL"],[23232,1,""],[23231,1,""],[23230,1,""],[23229,1,""],[23229,0,"null"],[23229,4,""],[23229,0,"ROOT"],[23341,0,"\n"],[23304,1,""],[23340,0,"\n  ]},"],[23298,6,""],[23334,0,"\n    ..."],[23290,8,""],[23326,0,"\n    { length: -5, id: [1, 0], seq, parent: [0, 0] },"],[23237,53,""],[23273,0,"\n    { length: 5, id: [0, 0], seq, parent: ROOT },"],[23187,50,""],[23223,0,"\n    // No string content!"],[23187,2,""],[23187,0,"    "],[23161,26,""],[23199,0,"\n  items: RangeTree {["],[23139,22,""],[23177,0,"\n"],[23138,5,""],[23138,0,"  "],[23174,0,","],[23137,0,"\n  "],[23138,2,""],[23137,1,""],[23175,0,"\n  clients: ['seph', 'mike'],"],[23109,29,""],[23146,0,"\n  "],[23147,2,""],[23342,1,""],[23349,0,"\n"],[23350,308,""],[23349,1,""],[23349,0,"\n"],[23349,0,"\nThere's a few tweaks here, but "],[23350,31,""],[23349,1,""],[23349,0,"\nNotice the tet"],[23363,1,""],[23363,0,"xt"],[23350,0,"There's a bunch of small tweaks here, but "],[23393,0,"t"],[23393,1,""],[23392,1,""],[23392,0,"n"],[23407,0," content? Its "],[23420,1,""],[23419,1,""],[23418,1,""],[23418,0," pulled it out into its own structure. The been"],[23464,1,""],[23463,1,""],[23463,0,"nefit "],[23457,12,""],[23457,0,"This is a tradeoff:\n\n- "],[23478,2,""],[23478,0,"-"],[23457,10,""],[23457,0,"Welom"],[23461,1,""],[23460,1,""],[23460,0,"come to "],[23438,7,""],[23438,0,"a separate data"],[23484,0," "],[23476,0,"the land of "],[23496,0,"s"],[23497,1,""],[23488,0,"Engineering "],[23500,1,""],[23500,0,"T"],[23480,1,""],[23480,0,"L"],[23650,43,""],[23650,0,"[Ropey](https://docs.rs/ropey/1.2.0/ropey/)"],[23463,0,"( "],[23464,1,""],[23464,0," "],[23464,1,""],[23463,1,""],[23463,0," ([Ropey](https://docs.rs/ropey/1.2.0/ropey/)"],[23465,0,"U"],[23465,1,""],[23465,0,"using a list"],[23476,1,""],[23475,1,""],[23474,1,""],[23473,1,""],[23472,1,""],[23472,0," rust library calle d"],[23492,1,""],[23491,1,""],[23491,0,"d "],[23536,0,")"],[23536,0,", which i "],[23545,1,""],[23545,0,"s *"],[23547,1,""],[23546,1,""],[23545,1,""],[23544,1,""],[23544,0,"implements *another* b-tree!"],[23623,0," Havin "],[23629,1,""],[23629,0,"g the texxt conte"],[23638,1,""],[23645,0,"nt self contained like this means the "],[23679,4,""],[23679,0,"ropey can do text-specific optimizations"],[23673,0,"allows "],[23680,6,""],[23685,0," to"],[23688,4,""],[23719,0,", like packing all the chara"],[23719,28,""],[23719,0,". So we use less ram.\n- "],[23741,2,""],[23741,0,"-"],[23721,19,""],[23721,0,"The biggest advantage is we use a lot less ram this way."],[23597,0," Uncomfortable"],[23793,0," But inserting into both"],[23798,19,""],[23798,0,"ei"],[23799,1,""],[23798,1,""],[23798,0,"with ech"],[23805,1,""],[23804,1,""],[23804,0,"ach insert we'"],[23817,1,""],[23817,0," need to update 2 data structures. Rop"],[23854,1,""],[23853,1,""],[23852,1,""],[23851,1,""],[23850,1,""],[23850,0," instead of 1, which makes everything more than"],[23871,0,"in this case "],[23910,0," "],[23910,1,""],[23910,0," twice as slow as it could be"],[23861,0," just"],[23875,13,""],[23892,19,""],[23897,0,"er"],[23899,15,""],[23899,0,"\n- "],[23900,2,""],[23900,0,"-"],[23399,3,""],[23399,0,"what I did with the"],[23431,1,""],[23431,0," here."],[23485,1,""],[23484,1,""],[23484,0,", "],[23557,1,""],[23557,0,". Ropey implements"],[23575,17,""],[23594,1,""],[23593,1,""],[23591,0," t"],[23592,1,""],[23591,1,""],[23592,0," "],[23592,1,""],[23592,0," to efficiently manage text inserts"],[23627,1,""],[23627,0,". This isn't a net win."],[23651,10,""],[23651,0,"We have unfortunately arrived at"],[23386,5,""],[23386,0,". But"],[23399,0,"in particular "],[23388,44,""],[23350,38,""],[23350,0,"One big "],[23357,1,""],[23070,10,""],[23070,0,"closer to "],[23350,26,""],[23350,0,"One "],[23353,1,""],[23352,1,""],[23351,1,""],[23350,1,""],[23350,0,"Note"],[23364,2,""],[23364,0,"the text"],[22766,0,", important"],[23361,5,""],[23361,0,"To "],[23363,1,""],[23362,1,""],[23361,1,""],[23379,0,"content "],[23712,10,""],[23792,6,""],[23918,0,"."],[23921,0," And the b"],[23926,5,""],[23926,0,"it doubles the compiled"],[23941,0,"size of the "],[23961,0," binary - with wasm "],[23968,7,""],[23968,0,", which matters on the web. The"],[24005,0,"bundle goes from 60kb to 120kb."],[24012,4,""],[24012,0,"increases"],[24040,1,""],[24040,0," when we depend on Ropey."],[23968,26,""],[24039,0,"\n- But it makes it way a"],[24062,1,""],[24062,0,"faster to read off "],[24042,5,""],[24042,0,"I"],[24044,0," also"],[24040,42,""],[24040,0,"- It also makes it way faster to read off"],[22818,234,""],[28308,0,"\nIn javascript we have this:\n\n```javascript\ndoc = { content: [\n  { item: 'hello', isDeleted: false, id: ['seph', 0], seq, parent: null },\n  { item: 'world', isDeleted: true, id: ['mike', 0], seq, parent: ['seph', 0] },\n    ...\n]}\n```\n"],[22847,9,""],[22847,0,"like "],[22851,1,""],[23122,12,""],[23122,0,"Notice te"],[23130,1,""],[23130,0,"he document's"],[23156,0," is "],[23159,1,""],[23158,1,""],[23157,1,""],[23157,0,"has been pulled"],[23207,0,". I'm"],[23212,1,""],[23212,0," "],[23212,1,""],[23463,47,""],[23463,0,"C"],[23463,1,""],[23463,0,"R"],[23468,0," can"],[23508,26,""],[23508,0,"W"],[23514,0," much"],[23515,4,""],[23514,1,""],[23539,10,""],[23539,0," when "],[23544,1,""],[23551,0,"ing"],[23601,5,""],[23603,1,""],[23603,0,". This"],[23609,6,""],[23637,6,""],[23637,0,"Depending on ropey"],[23676,3,""],[23676,0,"our"],[23741,25,""],[23741,0," - which is"],[23741,11,""],[23744,0,"Ropey "],[23750,8,""],[23781,0," the document's"],[23742,54,""],[23741,1,""],[24535,0,"| *JS baseline*                     | 0.61s      | 0.1 MB    | *(none)*       |\n"],[24618,2,""],[24618,0,"Ropey (rust)"],[24640,10,""],[24655,2,""],[24655,0,"029"],[24660,1,""],[24694,80,""],[24615,0,"| Rust (Called from JS via WASM)    | 0.20s      | ???       | B-Tree         |\n"],[24774,80,""],[24695,0,"| Rust (native)                     | 0.065s     | 2.3 MB    | B-Tree         |\n"],[24828,1,""],[24828,0,"2"],[22675,2,""],[22675,0,"or"],[22694,0,"?"],[23742,0,"."],[23742,1,""],[23744,217,""],[23747,6,""],[23747,0,"CRDT implementation "],[23766,1,""],[23777,0," at this point"],[23902,3,""],[23902,0," and"],[23742,0,"\n- Sometimes we "],[23743,15,""],[23742,1,""],[23742,0,"\n\nI'm still not sure "],[23744,19,""],[23744,0,"I'm still not sure if I like this change."],[23763,22,""],[23763,0,"whether I like this approach."],[23635,0," It also"],[23643,62,""],[23643,0," increases the size of the"],[23670,4,""],[23682,10,""],[23700,0,"."],[23644,9,""],[23644,0,"doubles"],[23537,5,""],[23537,0,"W"],[23695,0,"\n- We sometimes don't need the text content at all - like when"],[23698,59,""],[23698,0,"Most applications"],[23698,17,""],[23698,0,"There's a bunch of use cases where don"],[23735,1,""],[23734,1,""],[23733,1,""],[23733,0,"we don't "],[23696,46,""],[23696,0,"- There's a bunch of use cases where we don't"],[23157,0," doesn't live in the items"],[23178,5,""],[23178,0,"list of items anymore. Now its"],[23208,25,""],[23208,0," in "],[23211,1,""],[23263,0," for this"],[23359,0,"which ca"],[23366,1,""],[23365,1,""],[23364,1,""],[23363,1,""],[23362,1,""],[23361,1,""],[23360,1,""],[23359,1,""],[23358,1,""],[23358,0," "],[23288,34,""],[23288,0,"https://crates.io/crates/ropey"],[23358,12,""],[23339,0,"et "],[23341,1,""],[23340,1,""],[23339,1,""],[23339,0,"yet "],[23339,4,""],[23357,0," efficiently"],[23376,0," the document's"],[23396,8,""],[23396,0," content"],[23583,0," (Ropey only uses 200kb for the "],[23607,8,""],[23607,0,"to store the whole document - its way more efficient than"],[23645,19,""],[23645,0,"tighter than my code!)"],[23641,0,"apparently "],[23583,95,""],[23543,13,""],[23543,0,"packing"],[23543,0,"byte "],[23600,0,"like this "],[23764,10,""],[23764,0,"some"],[23793,0," care about the document's contents."],[23828,0," anyway"],[23753,83,""],[23805,0,"But "],[23809,1,""],[23809,0,"m"],[23967,0,"?"],[23968,12,""],[23968,0," How"],[23978,0,"can "],[24659,1,""],[24659,0,"R"],[24659,1,""],[24659,0,"r"],[24072,4,""],[24072,0,"CRDT"],[24925,0,"\n("],[24926,1,""],[24926,0,"(Why is it slower"],[24931,12,""],[24931,0,"d"],[24931,1,""],[24931,0,"is it slower"],[24937,6,""],[24937,0,"faster to "],[24931,16,""],[24931,0,"don't "],[24927,10,""],[24927,0,"Weird - 29ms + 23ms ! "],[24948,1,""],[24948,0,"= 65ms. I wonder if its "],[24971,1,""],[24971,0," "],[24956,16,""],[24956,0,"We're "],[24926,1,""],[24926,0,"Oh look"],[24933,5,""],[24926,37,""],[24926,0,"Oh look - 29ms + 23ms != 65ms. We're"],[24906,17,""],[24906,0," make the computer do less work"],[24938,0,"\n\nAnd just to "],[24940,12,""],[24939,1,""],[24938,1,""],[24976,0," probably fill"],[24971,19,""],[24971,0,"I "],[24971,2,""],[24971,0,"I'm probably thrashing the cPU c"],[25002,1,""],[25001,1,""],[25000,1,""],[24999,1,""],[24998,1,""],[24998,0,"CPU's cache inserting one character at a time"],[25010,0,"by processing "],[25024,10,""],[25027,10,""],[25027,0," edit"],[24970,72,""],[24970,0," It look"],[24971,7,""],[24971,0,"I can "],[24973,4,""],[24973,0,"smell more"],[24979,4,""],[24979,0,"faster performance "],[24979,19,""],[24979,0,"opppo"],[24983,1,""],[24982,1,""],[24982,0,"ortunities for even more performance."],[24979,27,""],[24979,0,"a batch_update() methods "],[25003,1,""],[25002,1,""],[25002,0," with faster"],[24971,9,""],[24971,0,"It looks like a"],[25009,4,""],[25009,0,"would have even"],[24971,16,""],[24971,0,"I smell a *"],[24996,0,"*"],[25004,0," in my future"],[25017,35,""],[25017,0," with *another* 20"],[25018,17,""],[25018,0,"which can process this trace in 52ms"],[25055,0,"\n"],[25046,0,", rope and all,"],[25272,5,""],[25292,1,""],[25292,0," -"],[25295,8,""],[25317,0,"ty"],[25319,14,""],[25358,19,""],[25380,1,""],[25380,0,"W"],[25385,6,""],[25385,0,"really needed"],[25425,3,""],[25431,6,""],[25431,0,"super"],[25465,0,"CRDTs started to emerge."],[25489,3,""],[25601,0," werea "],[25607,1,""],[25606,1,""],[25606,0," a big deal - and they're"],[25631,15,""],[25644,0," no1"],[25647,1,""],[25647,0,"w!"],[25649,1,""],[25617,31,""],[25602,4,""],[25602,0,"seemd"],[25606,1,""],[25606,0,"ed like"],[25741,0,"ly"],[25773,18,""],[25754,19,""],[25754,0,"pretty uni"],[25763,1,""],[25763,0,"usable for real world editing"],[25793,1,""],[25792,1,""],[25792,0,","],[25792,1,""],[25792,0,". "],[25795,1,""],[25794,1,""],[25794,0,"A"],[25799,0," made a "],[25800,7,""],[25799,1,""],[25799,0," made a big mistake - I"],[25823,7,""],[25823,0,"assumed"],[25887,5,""],[25887,0,"S"],[25924,48,""],[24970,0," The reason"],[24947,0," at those last three rows"],[24988,1,""],[24987,1,""],[24987,0,"is less than"],[24978,1,""],[24977,1,""],[24983,1,""],[24982,1,""],[24999,1,""],[24998,1,""],[24983,12,""],[24983,0,"<"],[24973,1,""],[24972,1,""],[24972,0,"!"],[24987,0," We're probably seeing t"],[24988,23,""],[24988,0,"There's "],[24988,8,""],[24988,0,"I'm probably thrashing the CPU cache."],[25024,0," w"],[25025,1,""],[25025,0,"by bouncing between thoses "],[25045,7,""],[25045,0,"these two B-trees"],[25064,11,""],[25158,0,"just "],[25158,4,""],[25157,1,""],[25045,5,""],[25045,0,"the"],[25059,1,""],[25059,0," i"],[25060,1,""],[25059,1,""],[25059,0,"s"],[25059,1,""],[25059,0," "],[25059,1,""],[25059,0,"s"],[26015,0,"It turns out "],[26029,0,"'m"],[26031,3,""],[26015,0,"I'm "],[26018,1,""],[26017,1,""],[26016,1,""],[26016,0," don't know who"],[26030,1,""],[26029,1,""],[26028,1,""],[26028,0,"'"],[26016,0,"'"],[26017,12,""],[26017,0,"m terib"],[26023,1,""],[26022,1,""],[26022,0,"rible at academic papers, but "],[26053,1,""],[26052,1,""],[26052,0,"i"],[26151,1,""],[26159,0,"*"],[26155,0,"use my skills and "],[26183,1,""],[26183,0," researchers"],[26239,0," of inventing CRDT semantics. But"],[26272,5,""],[26293,41,""],[26293,0," Oops!"],[26294,0,"And I "],[26299,1,""],[26298,1,""],[26298,0,"if I did, we could have f"],[26322,1,""],[26322,0,"had fast, workable CD"],[26342,1,""],[26342,0,"RDTs a decade ago. "],[26311,0,"might"],[26316,5,""],[26341,0,"te"],[26342,1,""],[26341,1,""],[26346,0," for text editing"],[26385,0,"For the record, "],[26513,14,""],[26467,11,""],[26470,4,""],[26470,0," do all"],[26506,0," We "],[26506,4,""],[26506,0," Different dharmas. "],[26525,1,""],[26541,1,""],[26541,0,"our own gift for the world"],[26567,27,""],[26567,0,", if we can find it"],[26587,0,"\n\nInstead of being frustrated at that paper, I shoud"],[26638,1,""],[26638,0,"ld n"],[26641,1,""],[26641,0,"have"],[26632,13,""],[26631,1,""],[26630,1,""],[26589,32,""],[26589,0,"T"],[26599,0," was a call to adventure "],[26623,1,""],[26623,0,". That was the world saying \"Your skills are rare\""],[26625,10,""],[26625,0,"T"],[26641,0," was sayinh"],[26651,1,""],[26651,0,"g"],[26670,4,""],[26670,0,"valuable. W"],[26680,1,""],[26679,1,""],[26678,1,""],[26678,0," an"],[26670,11,""],[26670,0,"needed here."],[26579,7,""],[26579,0,"figure out th"],[26591,1,""],[26590,1,""],[26590,0,"what that is"],[26605,4,""],[26605,0,"In this spirit,"],[26605,15,""],[26605,0,"That"],[26620,0,"really "],[26648,0,"It was "],[26655,3,""],[26654,1,""],[26654,0," the"],[26684,0,"He "],[26686,1,""],[26686,0,"y seph, "],[26688,1,""],[26688,0,"S"],[26694,27,""],[26694,0,"We "],[26696,1,""],[26695,1,""],[26694,1,""],[26694,0,"we need your help over here. You're holding a piece of the puzzle"],[26749,3,""],[26749,0,"this"],[26762,0," In my ou"],[26770,1,""],[26769,1,""],[26769,0,"youthn"],[26774,1,""],[26774,0,"ful "],[26726,3,""],[26726,0,"r skils"],[26732,1,""],[26732,0,"ls are"],[26738,8,""],[26761,0,", and we can't get it owrking"],[26783,7,""],[26783,0,"wi"],[26784,1,""],[26784,0,"orking without you"],[26820,0,"arrogance I "],[26605,227,""],[26605,0,"That paper was really a call to adventure. It was the world saying was saying \"Hey Seph, we need your help over here. Your skills are a piece of this puzzle, and we can't get it working without you.\" In my youthful arrogance I"],[26017,1,""],[26016,1,""],[26016,0," might be"],[26260,0,"P2P collaborative editing"],[26285,14,""],[26312,5,""],[26312,0,"I"],[26662,10,""],[26662,0,"The"],[26671,0," came knocking at my door"],[26703,11,""],[26705,4,""],[26778,5,""],[26779,1,""],[26778,1,""],[26778,0,". W"],[26788,4,""],[26788,0," "],[26789,3,""],[26789,0,"this"],[26842,0," turned away. "],[26855,1,""],[26854,1,""],[26854,0,". I di"],[26859,1,""],[26858,1,""],[26857,1,""],[26856,1,""],[26855,1,""],[26855,0," I didn't enter the dragon's cave, and didn't "],[26894,7,""],[26894,0,"it took me another decades"],[26919,1,""],[26919,0," to find the treat"],[26936,1,""],[26936,0,"sure inside.\n\nBut we've found it now. P2P"],[26974,3,""],[26974,0,"Realtime collaborative editing"],[26974,0,"Decentralized "],[26988,1,""],[26988,0,"r"],[27018,0,"? We're coming for you.\n\n\n"],[27044,45,""],[27044,0,"# Appending X"],[27056,1,""],[27056,0,"A: "],[27058,1,""],[27058,0," Lying with benchmarks\n\nI've odne a"],[27087,6,""],[27087,0,"done a few lgi"],[27100,1,""],[27099,1,""],[27098,1,""],[27098,0,"gliths "],[27098,7,""],[27098,0,"slights of hands"],[27082,11,""],[27082,0,"There are a"],[27113,1,""],[27113,0," above that I want to admit, justi"],[27142,5,""],[27142,0,"efe"],[27142,3,""],[27141,1,""],[27140,1,""],[27140,0," and defend"],[27135,6,""],[27135,0,"f"],[27135,1,""],[27135,0,"confe"],[27139,1,""],[27138,1,""],[27137,1,""],[27136,1,""],[27135,1,""],[27135,0,"'fess up to "],[27157,0,".\n\n1. I'"],[27164,1,""],[27163,1,""],[27163,0,"I've written this post b"],[27163,24,""],[27163,0,"I've played fast and loose with two CRDT algoir"],[27204,6,""],[27204,0,"semantics"],[27190,0,"directly comparing implementations which use "],[27235,4,""],[27234,1,""],[27239,0,"different "],[27263,0,": Y"],[27265,1,""],[27265,0,"RGA (automerge) and YARTA"],[27289,1,""],[27288,1,""],[27287,1,""],[27287,0,"TA (yjs + my rust code). This i"],[27317,1,""],[27316,1,""],[27315,1,""],[27314,1,""],[27313,1,""],[27312,1,""],[27312,0,"My claim "],[27312,9,""],[27312,0,"I'm making a "],[27324,1,""],[27324,0,"n assumption"],[27189,0," with numbers,"],[27319,4,""],[27319,0,"implementation"],[27347,3,""],[27347,0,"the "],[27361,0," that both algorithms are "],[27372,15,""],[27367,5,""],[27367,0,"the implementation speed is identical - because in my reference CRDT implementation "],[27450,1,""],[27450,0,", it is. A"],[27459,1,""],[27421,0,"["],[27436,0,"]"],[27436,1,""],[27451,0,"](https://github.com/josephg/reference-crdts)"],[27505,0,"With a "],[27511,1,""],[27510,1,""],[27510,0,"this editing trace, "],[27164,84,""],[27164,0,"'ve written th"],[27163,44,""],[27163,0,"I'm comp"],[27170,1,""],[27169,1,""],[27168,1,""],[27167,1,""],[27167,0,"directly comparing the performance of implementations im"],[27222,1,""],[27221,1,""],[27221,0,"of"],[27223,1,""],[27163,0,"Through this post "],[27297,0," interchangably"],[27308,0,"e"],[27314,0," This only makes sense if"],[27339,69,""],[27339,0," the algorithms are intern"],[27364,1,""],[27364,0,"changable"],[27369,0,"e"],[27315,59,""],[27315,0,"This rests on the assumption that both algorithms run just as fast as each other"],[27398,13,""],[27397,1,""],[27396,1,""],[27395,1,""],[27395,0,"."],[27314,0," YATA "],[27315,5,""],[27315,0,"When there are no concurrent edits, all CRDT"],[27355,0,"list "],[27364,0,"s "],[27315,51,""],[27314,1,""],[27329,3,""],[27329,0,"a"],[27329,1,""],[27329,0,"the"],[27354,10,""],[27354,0,"semantics "],[27349,5,""],[27349,0,"the "],[27362,0," are interchangable"],[27377,0,"e"],[27382,32,""],[27382,0,", and the performance"],[27388,15,""],[27388,0,"if you swap semantics, the perfomra"],[27422,1,""],[27421,1,""],[27420,1,""],[27420,0,"rmance won't change."],[27439,1,""],[27441,0,"I've demonstrated this interchangability in my "],[27464,18,""],[27464,0,"property "],[27441,0,"This is actually a bold l"],[27465,1,""],[27465,0,"claim - which "],[27497,14,""],[27578,34,""],[27578,0,". And "],[27580,4,""],[27580,0,"You "],[27580,4,""],[27580,0,"I believe you could use the same approach to modify yjs to impement"],[27639,8,""],[27639,0,"implement RGA semantics - you'd just have to change"],[27581,0,"'m convinced"],[27593,8,""],[27694,0," yjs's *integrate* method, and store *ma"],[27733,1,""],[27732,1,""],[27732,0,"se"],[27721,4,""],[27730,0,"q* isntead of"],[27733,10,""],[27733,0,"instead of *originRight* in *Item* and store *maxSeq*"],[27777,0," and update"],[27797,0," in the document. This "],[27815,5,""],[27815,0,"The"],[27580,15,""],[27580,0,"Y"],[27652,0," if you wanted"],[27667,1,""],[27666,1,""],[27666,0,"."],[27668,1,""],[27668,0,"Y"],[27666,0," to"],[27762,0," each"],[27774,0,","],[27775,4,""],[27817,0," and h"],[27822,1,""],[27822,0,"change the binary encoding format"],[27857,3,""],[27857,0,"I talked to Kevin about this and he doesn't see t"],[27905,1,""],[27905,0,"any point."],[27889,1,""],[27889,0,", while cool, "],[27927,0," in "],[27930,1,""],[27929,1,""],[27928,1,""],[27927,1,""],[27918,4,""],[27918,0,"the "],[27927,0," of making"],[27931,6,""],[27931,0,"addin"],[27931,5,""],[27931,0,"making yjs compatible"],[27927,25,""],[27918,4,""],[27918,0,"any "],[27387,0,"t aht"],[27391,1,""],[27390,1,""],[27389,1,""],[27388,1,""],[27387,1,""],[27387,0," that"],[27444,0," (at least for single user editing traces)"],[27506,0," kin"],[27509,1,""],[27508,1,""],[27507,1,""],[27506,1,""],[27506,5,""],[27506,0," noven"],[27511,1,""],[27510,1,""],[27509,1,""],[27509,0,"vel"],[27518,0,"."],[27520,8,""],[27537,0," that this is true"],[27637,0,", which has identical performance for yjs and automerge"],[27671,0,"when using "],[27682,3,""],[27681,1,""],[27686,3,""],[27686,0,"or"],[27698,0," a"],[27699,1,""],[27699,0,"semantics"],[27710,0,"And I think "],[27722,1,""],[27722,0,"y"],[27716,7,""],[27715,1,""],[27715,0,"'m confident y"],[27159,0,"\n\n"],[27160,0,"### Yjs ==="],[27164,7,""],[27164,0,"Are these CRDTs actull"],[27185,1,""],[27184,1,""],[27184,0,"ally the same?"],[27202,1,""],[27201,1,""],[27200,1,""],[27351,1,""],[27350,1,""],[27350,0,".\n\n"],[27404,16,""],[27404,0," bascai"],[27410,1,""],[27409,1,""],[27409,0,"i"],[27409,1,""],[27408,1,""],[27408,0,"ically the same"],[27547,0," big bold"],[27548,8,""],[27547,1,""],[27559,0,","],[27559,2,""],[27559,0,"!"],[27537,16,""],[27537,0,"a new"],[27542,6,""],[27542,0," idea tha"],[27550,1,""],[27549,1,""],[27548,1,""],[27547,1,""],[27547,0," and I think I "],[27548,14,""],[27548,0,"that I think I "],[27539,24,""],[27539,0,"novel idea that nobody "],[27555,0,"I think "],[27570,0,"has discovered before"],[27591,1,""],[27591,0,"."],[27592,1,""],[27592,0,"\n\n"],[27611,5,""],[27616,8,""],[27616,0,"proper"],[27621,1,""],[27620,1,""],[27619,1,""],[27618,1,""],[27617,1,""],[27616,1,""],[27616,0," property"],[27751,0," either"],[27775,0,"'s"],[27904,4,""],[27903,1,""],[27911,0,":\n\n-"],[27916,1,""],[27916,0,"C"],[27923,1,""],[27923,0,"Y"],[27947,0," (or make an alternative with at"],[27977,2,""],[27977,0,"auto"],[27972,9,""],[27971,1,""],[27971,0,") which used slightly different logic for concurrent edits"],[28029,3,""],[28029,0,"\n- S"],[28083,3,""],[28083,0,"\n- S"],[28092,11,""],[28116,0,", and keep it up to doa"],[28138,1,""],[28137,1,""],[28137,0,"ate"],[28144,1,""],[28144,0,"\n- "],[28147,1,""],[28147,0,"C"],[28154,0,"yjs's "],[28160,3,""],[28159,1,""],[28183,1,""],[28183,0,"\n\n"],[28255,0," "],[28255,1,""],[28255,0," in adding this hinge into his library"],[28294,0,"\n\nFor my rust code, I probably will at some point add a "],[28344,6,""],[28344,0,"make my CRDT implementation ha"],[28373,1,""],[28372,1,""],[28372,0,"accecpt a"],[28380,1,""],[28379,1,""],[28378,1,""],[28377,1,""],[28376,1,""],[28376,0,"e"],[28376,1,""],[28376,0,"pt a type parameter which switches between yjs and automerge semantics."],[27164,9,""],[27164,0,"Hang on - A"],[27174,1,""],[27174,0,"are these"],[28457,0,"\n\n### "],[28459,4,""],[28459,0,"###"],[27043,0,"\n"],[27043,0,"\n# Appending"],[27054,1,""],[27053,1,""],[27053,0,"x\n\n# Wh"],[27059,1,""],[27058,1,""],[27057,1,""],[27057,0,"#"],[27061,0,"#"],[27063,13,""],[27063,0,"Appending A: "],[27063,23,""],[27063,0,"More information on my"],[27058,0," What if I want to use"],[27059,21,""],[27059,0,"Thats coo"],[27059,9,""],[27059,0,"What now? I want to use a CRDT for my application. What should I do?\n\nUse yjs. Yjs has excellent performance"],[27129,0,"If you're building an application today you should "],[27180,1,""],[27180,0,"u"],[27218,0,", low memory usage, great support (+ paid support if ou want"],[27271,7,""],[27271,0,"you need"],[27236,1,""],[27236,0," and"],[27254,0,". Kevin "],[27256,6,""],[27256,0,"You can also get"],[27272,3,""],[27286,11,""],[27286,0,"if you need it"],[27269,3,""],[27269,0,"become a sponsor of yjs t"],[27293,29,""],[27293,0,"if you want - which g"],[27313,1,""],[27313,0,"(if Kevin has time) will"],[27256,81,""],[27256,0,"You "],[27259,1,""],[27258,1,""],[27257,1,""],[27256,1,""],[27256,0,"If you have money"],[27263,10,""],[27263,0,"want help imeplm"],[27278,1,""],[27277,1,""],[27276,1,""],[27275,1,""],[27275,0,"plementing yjs in your application, Kevin "],[27149,1,""],[27149,0," a"],[27150,1,""],[27150,0,"co"],[27151,1,""],[27150,1,""],[27150,0,"document based collaborative"],[27196,0,", and you want ti t"],[27214,1,""],[27213,1,""],[27212,1,""],[27211,1,""],[27211,0,"to do it on top of CRDTs"],[27384,0,"might be able to "],[27377,24,""],[27377,0," get in conte"],[27389,1,""],[27389,0,"act with Kevin Jahns"],[27378,20,""],[27378,0,"yjs"],[27380,1,""],[27379,1,""],[27378,1,""],[27377,1,""],[27377,0," "],[27389,0," accepts some paid work in exchange for "],[27425,4,""],[27424,1,""],[27413,11,""],[27413,0,"so ke"],[27417,1,""],[27416,1,""],[27416,0,"he can work on yjs ful "],[27438,1,""],[27438,0,"l time."],[27413,0,"to fund working"],[27428,14,""],[27435,0," (and adjacent p"],[27450,1,""],[27450,0,"work)"],[27466,0,"\n\nMy rust code is really fast, but it m"],[27504,1,""],[27504,0,"probably"],[27504,0,"will "],[27517,0," never turn into a reliable"],[27536,8,""],[27536,0,"useful r"],[27543,1,""],[27543,0,"general purpose CRDT library. I simply don't have"],[27573,0,"There's 100 other things that "],[27573,30,""],[27573,0,"To be compatible "],[27579,11,""],[27579,0,"able to compete with yjs there are "],[27604,10,""],[27604,0,"on functionality there are 100 other things "],[27648,19,""],[27648,0," it "],[27651,1,""],[27650,1,""],[27649,1,""],[27648,1,""],[27648,0,"it needs to do well. "],[27603,0,"'s"],[27605,3,""],[27667,1,""],[27666,1,""],[27666,0,", including binary encoding and "],[27694,4,""],[27693,1,""],[27693,0,", network protocols, support for non-list structures, presence (curos"],[27761,1,""],[27760,1,""],[27760,0,"sor positions) and so on."],[27571,0," like yjs"],[27613,1,""],[27612,1,""],[27612,0,","],[27613,14,""],[27779,0,"\n\nIf you want database like semantics for realtime editing, you na"],[27844,1,""],[27843,1,""],[27843,0,"can"],[27839,7,""],[27839,0,"nobody has m"],[27850,1,""],[27850,0,"done this well yet."],[27839,0,"as far as I know "],[27882,4,""],[27882,0,"on top of CRDTs yet. You can use Shared"],[27920,1,""],[27920,0,"DB"],[27915,0,"my "],[27915,3,""],[27922,0," (which I wrote yesr"],[27941,1,""],[27940,1,""],[27940,0,"ars ago, and has been continually improved by an army oc "],[27996,1,""],[27995,1,""],[27995,0,"f contributors since then). "],[27982,28,""],[27982,0," "],[27996,0,"I'm excited for Redwoor"],[28018,1,""],[28018,0,"d."],[27915,0,"["],[27923,0,"](https://github.com/share/sharedb/)."],[27961,7,""],[27962,0," "],[27962,1,""],[27969,0,"shard"],[27973,1,""],[27973,0,"edb "],[28032,1,""],[28033,1,""],[28033,0," Looking forward, "],[28067,0,"["],[28075,0,"](https://github.com/redwood/redwood)"],[28033,1,""],[28033,0,"\n\nIf you want P2P support "],[28035,24,""],[28113,1,""],[28113,0," - which promises "],[28122,9,""],[28122,0,"is impl"],[28122,7,""],[28122,0,"has planned full CRDT support."],[28122,0,"uses "],[28122,5,""],[28122,0,"supports p2p editing and "],[28131,3,""],[28131,0,"P2P"],[29597,0," "],[29594,4,""],[29594,0,"###"],[27408,7,""],[27408,0,"support"],[27390,25,""],[27390,0,"sometimes accepts money in exchann"],[27423,1,""],[27423,0,"ge for help integrate"],[27443,1,""],[27443,0,"ing yjs into various applications. He usess t"],[27487,1,""],[27486,1,""],[27486,0," "],[27486,1,""],[27485,1,""],[27485,0," this to"],[27498,11,""],[27498,0," working on"],[27701,5,""],[27701,0," lot "],[27705,1,""],[27705,0,"s of "],[29679,0," This is the wrong benchmark"],[29698,9,""],[29698,0,"measure of performance\n\nYes, I agree.\n\nThe "],[29737,4,""],[29737,0,"The"],[29728,0," know and I"],[29748,3,""],[29748,0,"Accepting incoming changes from the usero"],[29788,1,""],[29788,0," only needs to happen fast enough "],[29821,1,""],[29815,0,"*"],[29822,0,"*. Fingers simply don't type very fast - so once a cR"],[29874,1,""],[29873,1,""],[29873,0,"CRDT gets "],[29878,5,""],[29878,0,"can handle any user edit in "],[29893,0,"local "],[29912,0,"under 1ms, going faster probably doesn't matte."],[29958,1,""],[29958,0,"r.\n\nThe important metrics are:"],[29966,0,"more "],[29993,0,"\n\n- How long the document takes to load from disk\n- "],[30043,2,""],[30043,0,"-"],[30027,0," save and"],[30053,0," Howm"],[30057,1,""],[30057,0," much spae"],[30066,1,""],[30066,0,"ce the do"],[30069,6,""],[30069,0,"it takes to send and rev"],[30092,1,""],[30092,0,"ceive the document"],[30058,52,""],[30058,0,"many bytes a document takes over the wo"],[30096,1,""],[30096,0,"ire"],[30095,4,""],[30095,0,"network"],[30086,0,"to en"],[30090,1,""],[30089,1,""],[30089,0,"send "],[30089,5,""],[30089,0,"store or send "],[30119,0,"\n\nWe"],[30122,1,""],[30121,1,""],[30121,0,"I'm also "],[30121,9,""],[30121,0,"All of these "],[30121,13,""],[30121,0,"The editing trace I'm using here also only has a single user making edits - "],[30196,1,""],[30195,1,""],[30194,1,""],[30194,0,". There might "],[30202,6,""],[30202,0,"could be pathological cases lurking in the shadows"],[30224,0,"performance "],[30264,0," when concurrent edits happen here."],[29965,0," actually"],[29974,5,""],[30290,13,""],[30274,0,"users make "],[30301,0,"."],[27054,0," A:"],[27057,14,""],[28251,1,""],[28251,0," Appending B: Your benchmarks are wrong"],[28290,34,""],[28285,0,"weird / "],[28298,0," / misleading"],[28265,4,""],[28265,0,"These"],[28464,9,""],[28586,0,"I"],[28586,1,""],[28586,0,"Doing this"],[28596,4,""],[28596,0," "],[28596,1,""],[28640,0,"for YATA and RGA "],[28701,0," between CRDT"],[28754,42,""],[28690,3,""],[28693,0," can"],[28725,0," without change"],[28739,1,""],[28739,0,"ing your implementation, or your implementation performance"],[28798,30,""],[28845,10,""],[28845,0,"n"],[28845,1,""],[28845,0,"looked at"],[28865,3,""],[28865,0," feel confident in this claim because I"],[28923,9,""],[29049,7,""],[29038,0,"(and an i"],[29046,1,""],[29045,1,""],[29044,1,""],[29044,0," almost-identical codepath) "],[29112,0," There might be some performance chang"],[29145,5,""],[29145,0,"differences with conflict-heavy editing traces - but thats extremely rare in ra"],[29223,1,""],[29222,1,""],[29222,0,"practice."],[29232,4,""],[29231,1,""],[29231,0,"\n\n"],[29236,0," also"],[29261,25,""],[29316,0,", without changing yjs's pef"],[29343,1,""],[29343,0,"rformance"],[29340,0," resulting"],[29341,9,""],[29340,1,""],[29354,13,""],[29354,0,"I know how you'd do it, too"],[29687,0," he a"],[29691,1,""],[29690,1,""],[29689,1,""],[29688,1,""],[29687,1,""],[29686,1,""],[29685,1,""],[29684,1,""],[29683,1,""],[29683,0,"."],[29684,1,""],[29685,1,""],[29685,0,"W"],[29732,4,""],[29732,0,"RGA support"],[29743,11,""],[29743,0," into"],[29761,0," I sort of "],[29764,8,""],[29763,1,""],[29763,0," "],[29763,1,""],[29762,1,""],[29761,1,""],[29761,0," Its a lot of "],[29762,13,""],[29762,0,"Changing the binary format in particular is a lot of work - and there"],[29819,12,""],[29819,0,", and "],[29761,64,""],[29761,0," Its not a feature anyob"],[29784,1,""],[29783,1,""],[29783,0,"body actually asks for."],[30006,25,""],[30006,0,"\nYes, I know and I agree. This post only measure "],[30054,1,""],[30054,0,"s the time toa"],[30067,1,""],[30066,1,""],[30066,0,"aken to replac"],[30079,1,""],[30079,0,"y an "],[30081,3,""],[30081,0,"a local editing trace. There's lot o"],[30116,1,""],[30115,1,""],[30115,0,"s"],[30065,0,"and memory "],[30065,11,""],[30102,0,", and the resulting RAM usage"],[30145,0," of mo"],[30150,1,""],[30132,20,""],[30132,0," But arguably, "],[30147,1,""],[30147,0,"a"],[30145,1,""],[30364,0,"("],[30364,1,""],[30364,0,"*"],[30383,0,"*"],[30360,24,""],[30360,0,"B"],[30360,1,""],[30360,0,"The *actually important*"],[30702,0,"\n\nI did it this way becasue both "],[30722,13,""],[30722,0,"because my reference-crdts"],[30730,18,""],[30729,1,""],[30729,0,":\n\n- Yjs and automerge both impleemtn"],[30734,0,"The "],[30738,1,""],[30738,0,"y"],[30756,14,""],[30756,0,"libraries implement very fast"],[30781,4,""],[30781,0,"compact binary representations"],[30766,0,"both "],[30816,0,". Th"],[30818,2,""],[30818,0,"An existence proof is enough for me h"],[30854,1,""],[30853,1,""],[30853,0," - I think you could port those binary packing formats to any inm"],[30917,1,""],[30916,1,""],[30916,0,"mplementation"],[30731,0,"\n- My re"],[30738,1,""],[30737,1,""],[30736,1,""],[30735,1,""],[30734,1,""],[30734,0,"I don't "],[30732,10,""],[30731,1,""],[30730,1,""],[30729,1,""],[30729,0," I don't have a binary"],[30732,5,""],[30732,0,"haven't implemented"],[30765,0," format in my reference-crdts or rust"],[30795,0,"implementation "],[30812,0," my"],[30820,0," code.\n"],[30826,0," I think it would be roughly "],[30835,0,"the performance "],[30827,11,""],[30827,0,"If I didn"],[30835,1,""],[30835,0,", I'd copy yjs & automerge's binary formats (they're extremely compact)"],[30841,0,"probably "],[30915,0," - so size would be identical. And I think"],[30990,0,"in "],[30990,3,""],[30990,0,"proportional w"],[31003,1,""],[31003,0,"to the time taken to process this editing trace - "],[31052,1,""],[31051,1,""],[31050,1,""],[31032,18,""],[31032,0,"editing traces."],[31047,200,""],[31047,0,"\n\n"],[31047,0," But I've been wrong before"],[30831,0," wrote that code"],[30847,4,""],[30851,1,""],[30850,1,""],[30849,1,""],[30849,0,"it would"],[30851,6,""],[30849,2,""],[30849,0,"I'd"],[30847,0," did"],[30842,5,""],[30837,5,""],[30831,6,""],[30887,0," because"],[30895,9,""],[30895,0," they're so"],[30906,10,""],[30914,1,""],[30914,0,"."],[30916,3,""],[30916,0,"S"],[30918,0," I expect"],[30928,0,"the resulting "],[30965,0," between all of these implementations"],[31009,0," suspect (claim)"],[31017,14,""],[31030,0,"for loading and saving "],[31053,3,""],[31061,28,""],[31061,0," pretty similar to the"],[31121,0," Probab"],[31121,7,""],[31121,0," Probably a bit faster e"],[31144,1,""],[31144,0,"because you only have to pro"],[31152,20,""],[31152,0,"the "],[31152,4,""],[31152,0,"in this format the document is alread st"],[31191,1,""],[31190,1,""],[31189,1,""],[31189,0,"y stored in order."],[31122,86,""],[31148,0,".\n\nI "],[31152,1,""],[31151,1,""],[31151,0,"There's a few small differences"],[30316,0,"about "],[30364,0," "],[30364,1,""],[30364,0," "],[30364,1,""],[30364,0,"\n\nIt is really fun though."],[31188,26,""],[31188,0," is one difference which might matter - yjs's binary format does run-length encoding of the "],[31231,49,""],[31231,0," packa"],[31236,1,""],[31236,0,"s th"],[31239,1,""],[31238,1,""],[31238,0,"information about deleted eleemnts "],[31264,9,""],[31264,0,"elements"],[31232,40,""],[31232,0,"and automerge treat dele"],[31252,4,""],[31252,0,"informatoin ab"],[31252,14,""],[31252,0,"information about deleted items l"],[31284,1,""],[31284,0,"slightly differentlt."],[31304,1,""],[31303,1,""],[31303,0,"y. "],[31305,1,""],[31305,0," (Ys"],[31308,1,""],[31308,0,"hs"],[31309,1,""],[31308,1,""],[31308,0,"js packs"],[31311,5,""],[31311,0,"RLE-e"],[31315,1,""],[31314,1,""],[31313,1,""],[31312,1,""],[31311,1,""],[31311,0,"run-el"],[31316,1,""],[31315,1,""],[31315,0,"length-encodes them and packa"],[31343,1,""],[31343,0,"s that information into the version structure. "],[31389,1,""],[31388,1,""],[31388,0,". Automerge put a"],[31404,1,""],[31403,1,""],[31403,0,"s that into the operation log)"],[31405,5,""],[31405,0,"deletes "],[31435,0,"."],[31437,0," This probably has some real-world "],[31461,11,""],[31461,0,"implications in terms pf "],[31485,1,""],[31484,1,""],[31483,1,""],[31483,0,"of implementation, but whatever"],[31505,9,""],[31505,0," I'"],[31507,1,""],[30437,4,""],[30437,0,"muuc"],[30440,1,""],[30439,1,""],[30439,0,"ch time"],[30560,0,"\n- How much time the document takes to save and load from disk"],[30431,62,""],[30465,16,""],[30465,0,"on disk or"],[30544,10,""],[31489,7,""],[31489,0,", because for automerge you need to store *when* each delete happened. Not just i"],[31569,1,""],[31569,0,"*if* the item has been deleted."],[31599,0," ("],[31600,1,""],[31599,1,""],[31600,0,"\n\nThere'"],[31602,6,""],[31601,1,""],[31600,1,""],[30544,0,"\n- T"],[30547,1,""],[30547,0,"The time taken "],[30547,15,""],[30547,0,"The time taken to update a docuemn"],[30580,1,""],[30579,1,""],[30578,1,""],[30578,0,"ment at rest (assuming a document is infrequently editing"],[30634,1,""],[30633,1,""],[30632,1,""],[30632,0,"ed and living "],[30590,56,""],[30590,0," ("],[30590,2,""],[30590,0," (more below)"],[31660,0,"\n"],[31660,0,"\nThe question nobody in the community seems to be thinking about is updaintg"],[31735,1,""],[31734,1,""],[31733,1,""],[31732,1,""],[31732,0,"ting a document at rest. If I have a CRDT "],[31769,0,"list "],[31779,0,"stored in P"],[31789,1,""],[31789,0,"postgres, and its very infrequently wr"],[31807,17,""],[31807,0,"wr"],[31808,1,""],[31807,1,""],[31806,1,""],[31809,0,"itten to infrequently, a"],[31832,1,""],[31832,0,"yjs and automerge seem to assume the ri"],[31850,21,""],[31850,0,"are written to "],[31862,3,""],[31862,0,"assuming you wan t"],[31879,1,""],[31878,1,""],[31878,0," t"],[31879,1,""],[31878,1,""],[31878,0,"t to:\n\n1. Load the docuemn"],[31903,1,""],[31902,1,""],[31901,1,""],[31901,0,"ment into RAM\n2. Make your change\n3. Save thew "],[31947,1,""],[31946,1,""],[31946,0," "],[31935,12,""],[31935,0,"3. Save the"],[31897,0,"whole "],[31952,0," whole document back to disk again\n\nThis"],[31988,4,""],[31988,0,"We do this for "],[31988,15,""],[31988,0,"This is actually really inefficient"],[31660,0,"\n---\n"],[28265,5,""],[28265,0,"Your"],[28325,3,""],[28325,0,"couple of"],[32006,15,""],[32006,0,"extremely"],[32027,0,", n"],[32029,1,""],[32029,0,"and it matter "],[32042,1,""],[32042,0,"s for some "],[32047,6,""],[32047,0," reall appli"],[32052,1,""],[32058,0,"cations ("],[32066,1,""],[32065,1,""],[32065,0," if we "],[32066,6,""],[32065,1,""],[32036,0,"will "],[32047,1,""],[32069,0," if we want CRDTs to be anything"],[32093,8,""],[32093,0,"u"],[32093,1,""],[32093,0,"u"],[32093,1,""],[32093,0,"mo"],[32094,1,""],[32093,1,""],[32093,0,"useful outside the context of text editing."],[32073,0,"(like me) you"],[32086,2,""],[32035,5,""],[32042,0,"s"],[32082,0,"'re hoping we add collaborative editing to more applicatoins tha"],[32130,16,""],[32130,0,"a"],[32130,1,""],[32065,0,". Espe"],[32066,5,""],[32065,1,""],[32065,0,". Especially if w"],[32067,10,""],[32048,19,""],[32048,0,"all the "],[32048,8,""],[32048,0,"the 99% of applications a"],[32072,1,""],[32072,0,"out there which aren't collaborative text editi"],[32118,1,""],[32117,1,""],[32117,0,"o"],[32117,1,""],[32117,0,"tors."],[32087,0," might want concurrent"],[32099,0,"to support "],[32120,0," editing, but"],[32168,131,""],[32168,0,"\n\nAs far as I know, nobody is thinking about this problem at the moment.\n\nI'm "],[32242,4,""],[32242,0,"I'm"],[32241,0,"\n\n---"],[32241,1,""],[32245,0,"\n"],[32250,0," also not looking into pruning. CRDTs like this grow u"],[32303,1,""],[32303,0,"over time (since we keep toms"],[32331,1,""],[32331,0,"bstones from all deleted items). This i"],[32364,6,""],[32364,0,"There are some "],[32364,15,""],[32364,0,"T"],[32364,1,""],[32364,0,"We don't actually need"],[32364,22,""],[32364,0,"You don't "],[32364,10,""],[32364,0,"There are some algorithms fr"],[32391,1,""],[32391,0,"or fixing this "],[32405,1,""],[32405,0,", and trimming down the document size from time to time. But a"],[32364,103,""],[32364,0,"This can be fixed, but fixing this is orthogonal to o"],[32416,1,""],[32412,4,""],[32412,0,"."],[32387,6,""],[32386,1,""],[32386,0," its "],[32387,4,""],[32387,0,"these fixes"],[32381,0," (eg Yjs's GC algorithm or "],[32407,1,""],[32406,1,""],[32405,1,""],[32404,1,""],[32404,0,", or Antimatter)"],[32420,1,""],[32420,0,"."],[32422,1,""],[32422,0,"B"],[32409,0,"To"],[32410,1,""],[32409,1,""],[32438,4,""],[32438,0,"are"],[32441,3,""],[32452,0," to what I'm doing above"],[32432,5,""],[32432,0,"a"],[32432,1,""],[32432,0,"things should work with any of the approaches I've listed"],[32489,34,""],[32489,0," "],[32498,0,"\n### Appendig"],[32510,1,""],[32510,0,"x C: Holy cow, automerge is really slow!"],[32551,57,""],[32551,0,"\nI know!! Take a loook "],[32573,1,""],[32572,1,""],[32571,1,""],[32571,0,"k at "],[32561,15,""],[32561,0,"Iyd "],[32564,1,""],[32563,1,""],[32562,1,""],[32562,0,"ts really just"],[32565,11,""],[32565,0,"not even trying to be fast. Look at this code:\n"],[32564,0," e"],[32565,1,""],[32565,0,"really"],[33943,746,""],[32532,0,"'"],[32532,1,""],[32534,0,"'s javascript c"],[32548,1,""],[32547,1,""],[33955,0,"\nT"],[33956,1,""],[33956,0,"But this code is all going tobe re"],[33989,1,""],[33988,1,""],[33987,1,""],[33986,1,""],[33985,1,""],[33985,0," be replaced by [automerge-rs](https://github.com/automerge/automerge-rs), whene"],[34064,1,""],[34063,1,""],[34063,0,"ver"],[34065,1,""],[34064,1,""],[34063,1,""],[34062,1,""],[34062,0,"enever that finally lands. (Maybe this week"],[34090,15,""],[34089,1,""],[34089,0,"Its been \"real son"],[34106,1,""],[34106,0,"on now\" for months. Maybe its landed"],[33997,0," i"],[33998,1,""],[33997,1,""],[33959,0," in practice"],[34012,0," calls "],[34013,6,""],[34013,0,"WASM calls through to"],[34176,0," by the time you're reading this! How fast is au"],[34214,10,""],[34214,0,"does automerge-rs compare? Good ue"],[34247,1,""],[34246,1,""],[34246,0,"question - I'd lo"],[34257,6,""],[34257,0,"maybe "],[34257,6,""],[34257,0,"I'd love to know too. Run"],[34279,3,""],[34278,1,""],[34277,1,""],[34277,0,"!"],[0,0,"\n\n\n"],[1,0,"! "],[2,1,""],[1,1,""],[1,0,"# Autom"],[3,5,""],[3,0,"Making CRDTs go BRRR "],[23,1,""],[22,1,""],[21,1,""],[20,1,""],[19,1,""],[3,7,""],[12,0,"BRRR: Improving performance byt "],[43,1,""],[42,1,""],[42,0," 4000x"],[3211,5,""],[3211,0,"Its"],[3416,0,"I took "],[3416,7,""],[3422,1,""],[3422,0,"ing"],[7952,1,""],[7952,0,"I"],[7952,0,"["],[7965,0,"](https://immutable-js.github.io/)"],[7962,1,""],[8476,0,"just "],[9062,21,""],[9062,0,"when you can"],[9081,0," it"],[9070,0,"'"],[9070,1,""],[9062,12,""],[9062,0,"before"],[9074,1,""],[9074,0,"ing"],[9062,7,""],[9062,0,"and then "],[9078,1,""],[9077,1,""],[9076,1,""],[9076,0,"ing"],[9062,17,""],[9062,0,"before rewriting"],[9062,16,""],[9062,0,"when yuo're a"],[9067,8,""],[9067,0,"you're about to throw it away in a rewrite"],[9109,3,""],[9279,0," as fa"],[9284,1,""],[9283,1,""],[9282,1,""],[9281,1,""],[9280,1,""],[9279,1,""],[9301,0," is another (competing) CRDT algorithm n "],[9341,1,""],[9340,1,""],[9340,0,"on github"],[9330,10,""],[9330,0,"implementation "],[9354,0," made by J"],[9363,1,""],[9363,0,"H"],[9363,1,""],[9363,0,"Kevin Jahns. Ke"],[9377,1,""],[9376,1,""],[9376,0,"A"],[9376,1,""],[9376,0,"And its really fast, well dou"],[9404,1,""],[9404,0,"cumented and well made. Yjs"],[9517,6,""],[9517,0,"really"],[9517,6,""],[9517,0,"really"],[9517,6,""],[9517,0,"pretty"],[9427,1,""],[9427,0,"\n\n"],[10218,58,""],[10217,1,""],[10414,136,""],[10413,1,""],[10424,3,""],[10415,9,""],[10415,0,"But with this"],[10445,1,""],[10445,0," l"],[10446,1,""],[10445,1,""],[10445,0,"s more complicated"],[10620,0," (?)"],[10637,0," there, splicing into the array"],[10668,1,""],[10740,8,""],[10751,0," - how do you figure out where the new item should go?"],[10805,51,""],[10805,0," But it "],[10812,1,""],[10812,0,"s only complicated like *math*. The logic for ordering ends up being 2l"],[10882,1,""],[10882,0," "],[10881,2,""],[10881,0,"just a few if statements."],[10842,64,""],[10842,0," - the "],[10845,4,""],[10845,0,"once you f"],[10854,1,""],[10843,0,"is complicate."],[10856,1,""],[10856,0,"d."],[10858,11,""],[10859,8,""],[10859,0,"Its hard to understand, but when you do, you "],[11042,0," if you're interested"],[11408,2,""],[11408,0,"I made a"],[11414,2,""],[11414,0," a"],[11486,0," whivh"],[11491,1,""],[11490,1,""],[11490,0,"ch"],[11529,0," side-by-sided"],[11542,1,""],[11544,66,""],[11544,0,"For "],[11547,1,""],[11546,1,""],[11545,1,""],[11544,1,""],[11544,0,"You can (mostly) swap imle"],[11569,1,""],[11568,1,""],[11568,0,"plementations y"],[11582,1,""],[11582,0,"by just changing your inte"],[11607,1,""],[11606,1,""],[11605,1,""],[11604,1,""],[11604,0,"insertion function."],[11604,9,""],[11590,14,""],[11590,0,"sapp"],[11593,1,""],[11592,1,""],[11591,1,""],[11591,0,"wapping out your insertion"],[11644,5,""],[11644,0," does"],[11654,1,""],[11810,17,""],[11810,0,"I"],[11821,0,", its really fast"],[11810,0,"So "],[11813,1,""],[11813,0,"i"],[11824,1,""],[11824,0," "],[11824,1,""],[11989,0," (TM)"],[12097,46,""],[11194,10,""],[11194,0,"better "],[11220,0," "],[11177,0,"This approach is better for lots of reasons :\n"],[11177,46,""],[11220,1,""],[11200,1,""],[11194,6,""],[11194,0,"beautiful "],[12097,0," We implement a list CRDT with a list. Genius!"],[12097,46,""],[11194,10,""],[11194,0,"better "],[11220,0," "],[11177,0,"This approach is better for lots of reasons :\n"],[11177,46,""],[11221,0," We implement a list CRDT with a list. Genius!"],[11221,46,""],[11220,1,""],[11176,0,"\n We implement a list CRDT with a list. Genius!"],[11178,1,""],[11177,1,""],[11177,0,"W"],[11177,0,"In short"],[11177,8,""],[11222,0,"\n"],[10831,4,""],[10814,5,""],[10826,0,"like"],[10895,70,""],[10895,0,"you can do the whoel "],[10915,1,""],[10914,1,""],[10913,1,""],[10913,0,"le thing in about "],[11003,21,""],[11117,45,""],[10728,0," We implement a list CRDT with a list. Genius!"],[10731,0,"'re"],[10744,0,"ing"],[11169,1,""],[11168,1,""],[12085,1,""],[12085,0," - w"],[12088,1,""],[12087,1,""],[12086,1,""],[12085,1,""],[12085,0,". Moving the fronteir"],[12085,1,""],[12085,0,", which is the "],[12100,20,""],[12100,0,"kind of idea that makes you"],[12085,42,""],[12085,0," "],[12085,1,""],[12085,0,". These idae"],[12096,1,""],[12095,1,""],[12087,8,""],[12087,0,"Ideas which do this are golden."],[12111,0,"truly "],[12110,0," rare and"],[12119,6,""],[12119,0," truly"],[12134,0,"\n\n"],[12135,0,"I'"],[12136,1,""],[12136,0," "],[12135,2,""],[12135,0,"I"],[11396,220,""],[11395,1,""],[11395,0,", if you want to."],[11932,0," made"],[11932,5,""],[11408,4,""],[11403,5,""],[11399,4,""],[11396,3,""],[11395,1,""],[11395,0,", if you want to."],[11932,0," made"],[11000,0,"\n\n\n"],[11002,1,""],[11001,1,""],[11000,1,""],[10781,0,"\n"],[10781,0,"\nIn an eff"],[10782,9,""],[10782,0,"I implemented both Yjs and Automerge myself using this approach in a toy CRDT "],[10855,5,""],[10855,0,"codebase, so I could understand"],[10865,21,""],[10865,0," "],[10865,1,""],[10865,0,"to prove I could"],[10845,36,""],[10845,0,". The code"],[10851,0,"["],[10856,0," is here](https://github.com/josephg/reference-crdts)"],[10860,0,"all "],[10913,0," if you want to "],[10870,42,""],[10870,0,"https://github.com/josephg/reference-crdts/blob/main/crdts.ts"],[10948,0,"figure this out in m"],[10948,20,""],[10948,0,"understan "],[10957,1,""],[10957,0,"d this in more detail."],[11199,1,""],[11199,0,"\n\n\n"],[10979,1,""],[10782,0,"\n"],[10980,219,""],[10783,0,"It sounds complicated - how do you figure out where the new item should go? But its complicated like *math* is complicated. Its hard to understand, but when you do, you can do the whole thing in about 20 lines of code.\n"],[11199,1,""],[11002,0,"\n"],[10781,1,""],[11199,2,""],[11199,0," "],[11366,0," Both "],[11371,1,""],[11370,1,""],[11369,1,""],[11368,1,""],[11367,1,""],[11366,1,""],[11366,0," C"],[11367,1,""],[11367,0,"Automer"],[11367,7,""],[11367,0,"Implemented like this, all the e"],[11398,1,""],[11390,8,""],[11390,0,"the difference "],[11390,15,""],[11390,0,"the CRDT semantics "],[11390,0,"auot"],[11393,1,""],[11392,1,""],[11392,0,"tomerge and yjs's "],[11410,4,""],[11425,0,"are identical"],[11410,28,""],[11410,0,"performance"],[11389,0," the performance differences "],[11394,24,""],[11393,1,""],[11366,59,""],[12130,6,""],[12130,0," Implemented like this, the automerge and yjs's performance"],[12130,59,""],[12130,0,"I made"],[12130,6,""],[12129,1,""],[12129,0,"\n"],[12690,5,""],[12724,1,""],[12724,0," too."],[12130,0,"B"],[12130,1,""],[12130,0,"In this codebase I have an implementation of ys"],[12176,1,""],[12175,1,""],[12175,0,"both RGA (au"],[12186,1,""],[12185,1,""],[12184,1,""],[12175,0,"the sma"],[12181,1,""],[12180,1,""],[12180,0,"emantics of "],[12201,0,"(automerge) and yjs ("],[12221,1,""],[12220,1,""],[12219,1,""],[12218,1,""],[12217,1,""],[12217,0,"YATA (js"],[12224,1,""],[12223,1,""],[12223,0,"yjs). But "],[12229,4,""],[12229,0,"They have identical performance."],[12229,0,"But "],[12233,19,""],[12233,0,"the"],[12248,0," is identical anyway"],[12261,7,""],[12249,0,"in this test "],[12277,0,"How fast? "],[12277,10,""],[12990,19,""],[12990,0,"There are two"],[13040,9,""],[13040,0,"code"],[13122,0,"\n\nIts t"],[13128,1,""],[13127,1,""],[13126,1,""],[13125,1,""],[13124,1,""],[13123,1,""],[13122,1,""],[13044,0," we need to fix"],[13139,0,"L"],[13139,1,""],[13139,0,"Lets say "],[13148,1,""],[13148,0,"w"],[13194,33,""],[13194,0,"S"],[13193,45,""],[13489,0,"\n Some of those items might have been deleted:"],[13490,1,""],[13490,0,"\nNote that "],[13501,1,""],[13501,0,"s"],[13544,1,""],[13544,0,", so I've added an `isDeleted` flag to mark them s"],[13593,1,""],[13593,0,"as such."],[13579,22,""],[13579,0,"."],[13579,0," to mark which ones"],[13599,0," We can't just remove them from the array because other peers might insert a"],[13655,20,""],[13655,0,"inserts might depend on them. (Oops)"],[13690,0,"!"],[13686,0,"Dang"],[13690,4,""],[13692,0,". "],[13693,1,""],[13692,1,""],[13686,4,""],[13686,0,"Drat"],[13691,0," But lets not worry about that for now."],[13695,6,""],[13695,0," I'm "],[13721,7,""],[13721,0,"in this post"],[13491,11,""],[13491,0,"S"],[13873,0," in my array"],[13753,1,""],[13753,0,"5"],[13771,0,". M"],[13773,1,""],[13772,1,""],[13771,1,""],[13771,0,", representing 100 00 "],[13792,1,""],[13792,0,"0 items which haven't been deleted."],[13827,5,""],[13759,0," array"],[13800,5,""],[13800,0,"characters"],[13839,1,""],[13839,0,"If t"],[13898,0,"document "],[13898,0,"*"],[13916,0,"*"],[13925,1,""],[13925,0,","],[13927,1,""],[13927,0,"w"],[13932,9,""],[13945,1,""],[13944,1,""],[13944,0,"our document"],[13948,8,""],[13947,1,""],[13955,0,"To find out, "],[13968,1,""],[13968,0,"w"],[13972,1,""],[13971,1,""],[13970,1,""],[14043,24,""],[14043,0," the right array location"],[14069,91,""],[14071,0,"So "],[14074,1,""],[14074,0,"i"],[14147,5,""],[14146,1,""],[14160,0,"or something "],[14262,0,", which is double yikes"],[14347,14,""],[14375,1,""],[14375,0,"5"],[14983,20,""],[14983,0,"I"],[15691,23,""],[15690,5,""],[15694,0," extra optimizatoin"],[15713,11,""],[15712,1,""],[15711,1,""],[15710,1,""],[15710,0,"ion here"],[15685,5,""],[15685,0," does"],[15720,0,"Because "],[15728,1,""],[15728,0,"h"],[15761,1,""],[15761,0,","],[15763,1,""],[15763,0,"i"],[15763,4,""],[15763,0,"when we"],[15783,0," in a document"],[16409,0,"\n\nSemantically this is the s"],[16436,1,""],[16435,1,""],[16434,1,""],[16433,1,""],[16432,1,""],[16432,0,"equivalent to the expanded version above - but the p"],[16483,1,""],[16483,0,"id, seq and parents of the internal elements is implicif"],[16538,1,""],[16538,0,"c"],[16538,1,""],[16538,0,"t."],[16539,0," when "],[16544,1,""],[16543,1,""],[16542,1,""],[16541,1,""],[16540,1,""],[16539,1,""],[16540,9,""],[16540,0," So"],[16557,0," we"],[16609,0," or something like that"],[16709,1,""],[16709,0,"\n\n"],[16710,1,""],[16709,1,""],[16709,0," "],[16710,5,""],[16710,0,"Yjs"],[16733,0,"s"],[16809,3,""],[16809,0,"these"],[16820,0," - since the id and sequence numbesr won'"],[16849,12,""],[16849,0,"numbers "],[16856,1,""],[16856,0," won'tli"],[16863,1,""],[16862,1,""],[16862,0," line up"],[16871,1,""],[16871,0,"\n\n"],[16873,14,""],[16873,0,"In our"],[17652,10,""],[17652,0,"I "],[17653,1,""],[17652,1,""],[17652,0,"Kevin says"],[17701,5,""],[17700,1,""],[17721,0," find the fas"],[17722,12,""],[17722,0,"make this code run so fast"],[17748,22,""],[17748,0,"."],[17721,0," figure out "],[17722,11,""],[17721,1,""],[18480,33,""],[18479,1,""],[18485,0," knows this now too, and he's"],[18514,3,""],[18526,10,""],[18523,3,""],[18523,0,"my approach in turn."],[18543,1,""],[18543,0," He's now"],[18552,4,""],[18600,28,""],[18600,0," which "],[18601,6,""],[18601,0,"to see if he can beat me in perfora"],[18635,1,""],[18634,1,""],[18634,0,"rmance."],[18515,37,""],[18514,1,""],[18806,0," with all the parts separate "],[18834,1,""],[18834,0," "],[18834,1,""],[18834,0,"d by pointers"],[26293,0,"So "],[26631,0," much"],[26783,15,""],[26783,0,"That was a mistake"],[26847,12,""],[26846,1,""],[27342,0," we can give"],[27354,4,""],[27354,0," to"],[27403,0," Some people are great parents. I"],[27404,0,"("],[27404,1,""],[27436,0," lok"],[27439,1,""],[27438,1,""],[27438,0,"ike performance."],[27442,0,"ob"],[27443,1,""],[27442,1,""],[27442,0,"thinking about "],[27457,11,""],[27457,0,"software performance tuning"],[27441,16,""],[27441,0," "],[27442,21,""],[27448,0," software"],[27442,7,""],[27442,0,"making "],[27457,0," o"],[27458,1,""],[27458,0,"o"],[27458,1,""],[27458,0,"go really fast"],[27435,0,"Me? "],[27440,5,""],[27440,0," can"],[27450,1,""],[27449,1,""],[27448,1,""],[27448,0,"e"],[27435,4,""],[27435,0,"Thats great, but "],[27659,4,""],[27659,0,"making "],[27665,1,""],[27664,1,""],[27663,1,""],[27662,1,""],[27662,0,"e this"],[27675,1,""],[27674,1,""],[27673,1,""],[27673,0," fast"],[27693,24,""],[27693,0,"Instead of entering"],[27704,8,""],[27704,0,"doing that work"],[27721,0," "],[27721,1,""],[27720,1,""],[27719,1,""],[27719,0,", I was sbu"],[27729,1,""],[27728,1,""],[27728,0,"b"],[27728,1,""],[27727,1,""],[27727,0,"busy and"],[27840,0," and bring it back"],[27884,0," Practical "],[27896,1,""],[27895,1,""],[27895,0,"d"],[27940,1,""],[27940,0,"\n\n"],[27941,1,""],[27940,1,""],[27940,0," "],[27452,10,""],[27452,0,"check out hos"],[27464,1,""],[27464,0,"w fast I can mek"],[27479,1,""],[27478,1,""],[27478,0,"ake"],[27493,13,""],[27493,0,"!"],[27482,8,""],[27482,0,"CRDTs"],[27404,0,"("],[27492,0,")"],[27509,7,""],[27609,40,""],[28413,0," Yjs already runs fast and eventua"],[28440,7,""],[28440,0,"soon it will "],[28448,5,""],[28448,0,"should become even faster."],[28492,0,"*"],[28499,0,"*"],[28793,0," Kevin has got this."],[28993,1,""],[28993,0,", which does this stuff on top p"],[29024,1,""],[29024,0,"of OT."],[29312,0,"Yes, I know. "],[29325,5,""],[29325,0,"I've made a few gl"],[29342,1,""],[29341,1,""],[29341,17,""],[29356,11,""],[29356,0," which"],[33169,0," Ther "],[33174,1,""],[33174,0,"e are e"],[33180,1,""],[33180,0,"better aprpoa"],[33192,1,""],[33191,1,""],[33190,1,""],[33189,1,""],[33189,0,"proaches to doing this sort of thing on top of a database, but"],[33251,2,""],[33251,0," "],[33252,1,""],[33252,0,"a"],[33311,0,"all at "],[32999,36,""],[32999,0,"This is s"],[33007,1,""],[33007,0,"the workflow that "],[33025,17,""],[33025,0,"y"],[33025,1,""],[33011,0,"cure"],[33014,1,""],[33014,0,"rentl"],[33018,1,""],[33017,1,""],[33017,0,"t "],[33018,1,""],[33018,0,"ly recommended "],[33042,4,""],[33042,0,"for"],[33045,1,""],[33046,0,"the "],[33086,6,""],[33090,11,""],[33091,10,""],[33091,0,"collaborative"],[33124,14,""],[33051,1,""],[33051,0,"5"],[33167,48,""],[33166,1,""],[33166,0," -"],[33168,1,""],[33235,15,""],[33235,0,". Help!"],[33241,1,""],[33241,0," please!"],[33237,0,"We could use yur"],[33252,1,""],[33251,1,""],[33251,0,"our "],[33255,1,""],[33255,0,"h"],[33259,7,""],[25654,0," This is fast enough to saturate 100mb"],[25691,1,""],[25690,1,""],[25690,0," "],[25687,4,""],[25687,0,"me"],[25688,1,""],[25687,1,""],[25687,0,"100 megabit ethernet."],[25678,0,"be "],[25675,35,""],[25675,0,"that my h"],[25683,1,""],[25682,1,""],[25681,1,""],[25680,1,""],[25668,12,""],[25667,1,""],[25667,0,"er than the fiber ethernet comin "],[25699,1,""],[25699,0,"g into my apartment"],[25719,1,""],[25719,0,"\n\n"],[25783,0,"And "],[25787,1,""],[25787,0,"o"],[25789,0,"!"],[25789,0," look"],[25794,6,""],[25835,0,"It l"],[25838,1,""],[25837,1,""],[25836,1,""],[25835,1,""],[26003,0,"*"],[26008,0,"*"],[33468,5,""],[33468,0,"addressed"],[33517,0," Or ignored (eg g"],[33533,1,""],[33533,0,"Git)"],[33536,0," grows forever and nobody cares"],[33568,0,".\n\n"],[33571,4,""],[33571,0,"But thats orthogonal "],[33591,1,""],[33591,0," to everything"],[33605,52,""],[33521,0,"you could just ignore it like git does"],[33559,47,""],[33560,0," Nobody seems to mind too much."],[33560,31,""],[33536,0,"mostly "],[33566,0," - nobody seems to care that their git repos grow without bound, forever"],[33811,0,"Gosh, "],[33817,1,""],[33817,0,"l"],[0,1,""],[27,0,"list "],[17,30,""],[17,0,"Making collaborative editing "],[51,0," faster"],[1856,9,""],[1855,1,""],[1854,1,""],[1853,1,""],[1853,0,"OT"],[1853,2,""],[1853,0,"operational transform"],[1852,0," sompe"],[1857,1,""],[1856,1,""],[1856,0,"e particular"],[1891,0,"algorithm "],[2299,0," But were the academics using the slow version or th "],[2351,1,""],[2351,0,"e fast e"],[2358,1,""],[2358,0,"version"],[2299,1,""],[2299,0,"\n\n"],[2366,0,"? Were they "],[2368,10,""],[2368,0,"did "],[2368,4,""],[2368,0,"id"],[2369,1,""],[2368,1,""],[2368,0,"Did they have fast versions of some algorithms and slow versions of ther"],[2439,1,""],[2438,1,""],[2437,1,""],[2436,1,""],[2436,0,"others, which might mess up their results? Its impiss"],[2488,1,""],[2487,1,""],[2486,1,""],[2486,0,"ossible"],[2479,3,""],[2479,0,"Reading the "],[2479,12,""],[2479,0,"Its"],[2493,0," to tell1"],[2501,1,""],[2501,0,"!"],[2479,3,""],[2479,0,"From the paper, its"],[2917,1,""],[2917,0,"."],[23861,0,"T"],[23861,1,""],[23861,0,"See, i"],[23867,1,""],[23867,0,"i"],[23867,1,""],[23877,0," actually"],[24156,0," // negative = deleted."],[24178,1,""],[24178,0," content"],[24110,6,""],[24110,0,"l"],[24060,6,""],[24060,0,"l"],[24106,0,"e"],[24061,0,"e"],[24108,0,"n"],[24062,0,"n"],[24163,0,"len "],[24322,0,"For"],[24324,1,""],[24323,1,""],[24322,1,""],[24402,0," for this"],[24469,0,"just "],[24502,1,""],[24502,0,"\n\n"],[24516,4,""],[24516,0," "],[24516,1,""],[24515,1,""],[24515,0,"universally a"],[24663,25,""],[24663,0,"So using ropey"],[24666,6,""],[24666,0,"with "],[24676,0,", we use less RAM."],[24712,10,""],[24714,0," now"],[24788,0,"more "],[24792,1,""],[24791,1,""],[24790,1,""],[24789,1,""],[24788,1,""],[24788,0,"2+x"],[24790,1,""],[24789,1,""],[24788,1,""],[24788,0,"more than twice as "],[24813,0,","],[24813,1,""],[24812,1,""],[24811,1,""],[24811,0,", and it makes the wasm bundle"],[24841,50,""],[24841,0," twice as big ("],[24856,1,""],[24862,1,""],[24861,1,""],[24861,0,"->"],[24869,0,")"],[24873,0,"So "],[25936,0," This is kind of uselesss"],[25960,1,""],[25960,0,", but its now"],[26060,14,""],[26056,4,""],[26056,0,"my internet connection"],[26078,25,""],[26036,7,""],[26036,0,"I can process edits"],[26049,6,""],[26041,8,""],[26037,4,""],[26036,1,""],[26036,0,"This is"],[26036,7,""],[26036,0,"Its"],[26036,39,""],[26036,0,"This could saturate "],[26036,20,""],[26036,0,"I could saturate my internet connection and have CPU to spare."],[26076,0,"with this "],[26260,36,""],[26260,0," by interleaving b"],[26277,1,""],[26277,0,"the b-treeu "],[26288,1,""],[26287,1,""],[26287,0," updates"],[26330,57,""],[26330,0,"whic"],[26333,1,""],[26332,1,""],[26331,1,""],[26330,1,""],[26330,0," which should work"],[26351,0," just"],[26331,0,"in my future "],[26349,20,""],[26349,0,"brings "],[26355,1,""],[26354,1,""],[26353,1,""],[26352,1,""],[26351,1,""],[26350,1,""],[26349,1,""],[26349,0," brings that 54"],[26363,1,""],[26362,1,""],[26362,0,"65ms down to"],[27443,0," to invent"],[27453,35,""],[28101,13,""],[28206,0,"(super fast CRDTs) "],[28252,9,""],[28251,1,""],[28251,0," have "],[28264,0," "],[28264,1,""],[28264,0," S"],[28265,1,""],[28264,1,""],[28341,0," next"],[28493,4,""],[28496,34,""],[29223,5,""],[29233,21,""],[29233,0," instead of document semantics"],[29393,25,""],[29392,1,""],[29392,0," uss"],[29395,1,""],[29395,0,"es"],[31062,12,""],[31062,0,"And "],[31065,1,""],[31064,1,""],[31063,1,""],[31062,1,""],[31061,1,""],[31060,1,""],[31060,0,", and h"],[31066,1,""],[31139,9,""],[31139,0,"something"],[31131,0,"It would add complexity, but"],[31131,28,""],[33990,1,""],[33989,1,""],[34100,7,""],[34100,0,"L"],[0,0,"\n\n"],[0,0,"> R"],[2,1,""],[2,0,"DRAFT: Needs diagrams before publishing."],[23,0,", maybe some tidy up"],[62,0," Don't share the link too widelyp"],[94,1,""],[94,0," please! This isn't ready for N"],[124,1,""],[124,0,"HN."],[34114,0,"\n\n### on"],[34121,1,""],[34120,1,""],[34120,0,"All of thee "],[34131,1,""],[34130,1,""],[34130,0,"se benchmarks show the e"],[34153,1,""],[34153,0,"result from multip"],[34170,1,""],[34169,1,""],[34169,0,"iple changes\n\n"],[34119,0," This doesn't "],[34120,13,""],[34119,1,""],[34120,61,""],[34120,0,"You have too many variables changing"],[34115,0,"\n"],[34159,0,"Yeah, well spotted. Each of these tests changes multiple ve"],[34217,1,""],[34217,0,"ariables. Maybe my d"],[34236,1,""],[34236,0,"reference implementation is faster than automerge simply "],[34159,134,""],[34159,0,"Yeah, well spotted. Each of these tests changes multiple variables. Maybe my reference implementation is faster than automerge simply"],[33271,0," whole data "],[33282,1,""],[33282,0,"base full of"],[33294,5,""],[33299,0,"s"],[33300,7,""],[33314,0,"I want to be able to update a single itme"],[33354,1,""],[33353,1,""],[33353,0,"em quickly."],[33364,84,""],[33364,0," With yjs and automerge today you need to:"],[33510,0,"\nThis is going to be awuf"],[33534,1,""],[33533,1,""],[33533,0,"fully slow, "],[33544,1,""],[33543,1,""],[33364,0,"\n\n"],[33366,1,""],[33259,0," Most applications aren "],[33282,1,""],[33282,0,"'t collaborative text edti"],[33307,1,""],[33306,1,""],[33306,0,"itors."],[33416,1,""],[33312,0," "],[33312,1,""],[33312,0," Most aapps"],[33318,5,""],[33318,0,"apps have lots of small objects which are each "],[33360,5,""],[33360,0,"rarely written to."],[33313,65,""],[33312,1,""],[33311,0,", where there's one document l"],[33340,1,""],[33340,0,"you can load once, keep open and then e"],[33378,1,""],[33378,0,"save"],[33311,71,""],[33311,0,". Intea"],[33317,1,""],[33316,1,""],[33315,1,""],[33315,0,"stead they have ad"],[33332,1,""],[33331,1,""],[33331,0,"databases full"],[33321,0,"most apps "],[33331,5,""],[33350,0," of tiny objects, each of which is almost never"],[33385,12,""],[33385,0,"very rarely written to"],[33408,1,""],[33408,0,"\n\n"],[33410,104,""],[33409,1,""],[33408,1,""],[33408,0,"j"],[33408,1,""],[33408,0,"\n"],[33409,1,""],[33408,1,""],[33408,0," "],[33587,0,"."],[33588,140,""],[33616,0," than this"],[33681,8,""],[33661,14,""],[33661,0,"working on "],[33671,1,""],[33735,5,""],[33735,0," at"],[33746,0," here"],[31861,0," much"],[33172,0," other"],[33178,9,""],[33178,0," perof"],[33183,1,""],[33182,1,""],[33182,0,"formance measure"],[33252,0," how"],[33255,1,""],[33254,1,""],[33253,1,""],[33252,1,""],[33335,22,""],[33335,0,"Usually we"],[33343,2,""],[33343,0,"applications have"],[33391,1,""],[33391,0,". Each "],[33398,6,""],[33400,0," those objects"],[33414,6,""],[33441,1,""],[33441,0,"\n\nIf you want to update a single object in da "],[33486,1,""],[33485,1,""],[33485,0," "],[33485,1,""],[33484,1,""],[33484,0,"a data "],[33490,1,""],[33490,0,"base "],[33495,4,""],[33494,1,""],[33499,3,""],[33499,0,"or"],[33517,0,","],[33517,1,""],[34348,48,""],[34348,0,"Wh"],[34348,2,""],[34348,0,"Holy cow, automerge's javascript is really slow!"],[427,0," ("],[428,1,""],[427,1,""],[427,0," (wow"],[431,1,""],[430,1,""],[429,1,""],[429,0,"wow, "],[433,1,""],[432,1,""],[431,1,""],[430,1,""],[429,1,""],[429,0,"Wow, yess!)"],[248,1,""],[248,0,"\n\n"],[928,53,""],[928,0," - something was fishy here"],[929,0,"at the paper to see what was going on "],[969,0,"because "],[1003,0,"It turns out "],[1016,1,""],[1016,0,"w"],[1003,14,""],[1003,0,"In their paper w"],[1366,11,""],[1366,0," implementation"],[1362,4,""],[1362,0,"this particular"],[1362,4,""],[1362,0,"their"],[1395,0," Written in a "],[1404,5,""],[1404,0,"up as Science Paper"],[1410,0,"ub"],[1411,1,""],[1410,1,""],[1410,0,"PUbli"],[1414,1,""],[1413,1,""],[1412,1,""],[1411,1,""],[1411,0,"ublished "],[1433,0," it makes people think this"],[798,10,""],[798,0,"hang on -"],[807,1,""],[798,0,"- "],[881,6,""],[881,0,"W"],[937,24,""],[936,1,""],[1366,65,""],[1366,0,"\n"],[903,463,""],[903,0,"I took a closer look at the paper - because something was fishy here. In their paper when a user pasted a big chunk of text (say, 1000 characters), instead of creating 1 operation with 1000 characters, their code split the insert into 1000 operations. And each of those inserts needed to be processed separately. Duh - of course it'll be slow if you do that! This isn't a problem with the algorithm. This is just a problem with *their particular implementation*."],[1478,0," Written up as Published Science Paper it makes people think this\n"],[1479,0,"?Be"],[1481,1,""],[1480,1,""],[1479,1,""],[1479,0,"Because, "],[1488,1,""],[1488,0,"w"],[1552,0," is a Fact rather than a "],[1563,14,""],[1563,0,"Of The Universe rather than a "],[1592,1,""],[1592,0,"n implemetnation de"],[1594,17,""],[1594,0,"implementation detail of some "],[1367,257,""],[1367,0,"I wouldn't mind so much if I didn't have so many people flipping me a link to the paper and asking me about it. Because, written up as Published Science Paper it makes people think this is a Fact Of The Universe rather than an implementation detail of some"],[1623,1,""],[1623,0,"\n"],[1616,7,""],[1616,0,"in some "],[1616,8,""],[1616,0,"of some code write"],[1633,1,""],[1633,0,"ten by a "],[1641,1,""],[1641,0,"n overworked researcher."],[1666,0,"\n"],[1423,11,""],[1423,0,"sending"],[1423,10,""],[1427,0,"ing"],[1430,3,""],[1444,0," (pointedly)"],[1467,5,""],[1467,0,"what I think about"],[1490,10,""],[1490,0,"W"],[1669,0,"So, "],[1674,1,""],[1673,1,""],[1673,0,"n"],[1676,0," "],[1677,14,""],[1677,0,"the sci"],[1677,7,""],[1677,0,"The science isn't real! I'm"],[1703,1,""],[1702,1,""],[1701,1,""],[1700,1,""],[1695,5,""],[1695,0,"right! Please believe me!"],[1669,5,""],[1669,0,"N"],[1671,0,"oo"],[1693,5,""],[1693,0,"real"],[2349,13,""],[2362,0,"\n\nAnd differen"],[2375,1,""],[2375,0,"ent"],[2377,1,""],[2376,1,""],[2375,1,""],[2364,11,""],[2363,1,""],[2362,1,""],[2738,0," of this code"],[2938,1,""],[2950,49,""],[3018,0,"["],[3050,0,"]((https://josephg.com/blog/crdts-are-the-future/)). And maybe other kinds of f"],[3128,1,""],[3128,0,"sof"],[3113,18,""],[3113,0,"all our software - but I'm not ready to talk about that yet"],[3185,0,"today "],[3185,6,""],[3185,0,"you read about in academic papers "],[3799,0," "],[3799,1,""],[3799,0," Martin Kleppmann"],[4142,0," currently"],[4201,0,"ward"],[4245,4,""],[4245,0,"we need to "],[4255,1,""],[3799,17,""],[5034,0,"you "],[5045,9,""],[5045,0,"into th ed"],[5054,1,""],[5053,1,""],[5053,0,"e"],[5053,1,""],[5052,1,""],[5052,0,"e document"],[5896,0,", and the user *clearly* inserted before"],[5898,38,""],[5898,0,"even though the user inserted before the 'b'*"],[5939,0,"*"],[5940,1,""],[5941,1,""],[5890,1,""],[5890,0,"*"],[5895,1,""],[5895,0,"*"],[5943,1,""],[5943,0,"\n\n"],[6506,0,"\n"],[6506,0,"\nFor reference, Yjs "],[6507,15,""],[6507,0,"(Aside: "],[6519,0,"solves this with a *different* hack; but the difference isn't really importnat"],[6596,1,""],[6595,1,""],[6594,1,""],[6594,0,"ant)"],[6597,0,"."],[6581,6,""],[6581,0,"actually"],[6581,8,""],[6580,1,""],[6590,0," here"],[6518,0," is identical, except that it"],[6559,0," problem"],[6591,1,""],[6591,0,"."],[6592,6,""],[6592,0," T"],[6587,4,""],[6587,0,"tweak"],[6515,0,"If you're curious, "],[6550,1,""],[6550,0,","],[6515,19,""],[6587,5,""],[6587,0,"hack"],[6587,4,""],[6587,0,"trick"],[5974,13,""],[5974,0,"neat hack"],[6583,5,""],[6583,0,"hack"],[7457,0," wh"],[7459,1,""],[7459,0,"hile writing a p"],[7457,18,""],[7712,0,", so I'm no t"],[7724,1,""],[7723,1,""],[7723,0,"t too worried"],[7769,5,""],[7769,0," taken to "],[7778,1,""],[7786,1,""],[7785,1,""],[7784,1,""],[8504,0," not"],[8508,6,""],[8508,0," "],[8508,1,""],[8438,0," editing trace"],[8455,0," a javascript string"],[8475,11,""],[8484,33,""],[8486,0,"we can't merge concud"],[8506,1,""],[8506,0,"rrent edits but"],[8521,43,""],[8521,0," its "],[8525,1,""],[8521,4,""],[8521,0,"it might not concurrent edits but its slow:"],[8517,4,""],[8511,6,""],[8506,5,""],[8506,0,"d"],[8500,7,""],[8494,6,""],[8488,6,""],[8486,2,""],[8484,0,", using a javascript string, well"],[8475,0," javascript"],[8468,7,""],[8457,11,""],[8455,2,""],[8446,6,""],[8438,8,""],[8508,0," "],[8508,1,""],[8508,0," allow"],[8504,4,""],[7784,0,"ing"],[7784,3,""],[8504,0," not"],[8504,4,""],[8504,0," not"],[8508,6,""],[8508,0," "],[8508,1,""],[8438,0," editing trace"],[8455,0," a javascript string"],[8475,11,""],[8484,33,""],[8486,0,"we can't merge concud"],[8506,1,""],[8506,0,"rrent edits but"],[8521,43,""],[8521,0," its "],[8517,9,""],[8517,0,". But its a lt"],[8530,1,""],[8530,0,"ot faster:"],[8853,25,""],[8853,0,"A tree is "],[8862,1,""],[8855,9,""],[8855,0,"T"],[8853,3,""],[8853,0,"The d"],[8871,1,""],[8871,0," "],[8871,1,""],[8857,0,"tree based "],[8882,0," isn't very fast"],[9409,0," "],[9409,1,""],[9420,19,""],[9420,0," does that"],[8882,16,""],[8882,0," automerge uses gets big and slow"],[8906,14,""],[8903,3,""],[8903,0,"huge"],[9900,16,""],[9900,0,"the"],[9918,0," has the right approach"],[10016,0,". Fix the core algorihtm and"],[10031,13,""],[10031,0,"an"],[10032,1,""],[10032,0,"lgorithm and data "],[10049,1,""],[10049,0,"structures"],[10049,0," "],[10060,0,". Then "],[10062,5,""],[10062,0,"b"],[10062,1,""],[10061,1,""],[10060,1,""],[10060,0," before moving to optimizing individual methods"],[10137,4,""],[10137,0,"a function"],[10153,6,""],[10153,0,"it won't survive"],[10161,8,""],[10155,6,""],[10153,2,""],[10153,0,"you're"],[10195,0," anyway"],[10205,0,"But by far, "],[10292,7,""],[10292,0,"replaci"],[10298,1,""],[10298,0,"e it with something faster."],[12009,4,""],[12009,0,"in the same way"],[12076,4,""],[12076,0,"once"],[12085,2,""],[12085,0,"understand it"],[12108,2,""],[12108,0,"implement"],[12319,0,"'re curious and"],[12339,22,""],[12351,0,"s"],[12351,1,""],[12225,0,", both in the same"],[12225,18,""],[13286,4,""],[13286,0,"my reference-crdts"],[13342,16,""],[13341,1,""],[13427,0,"Its not exactly like-for-like - I'mn"],[13462,1,""],[13462,0," not impleenting "],[13459,20,""],[13459,0,"my o"],[13462,1,""],[13462,0,"implementi"],[13471,1,""],[13471,0,"ation also doe"],[13477,8,""],[13477,0,"doesn't use immutablejs. But"],[13505,4,""],[13505,0," my code, using t"],[13521,1,""],[13520,1,""],[13520,0," this"],[13534,0,","],[13536,3,""],[13536,0,"ends up "],[13560,1,""],[13560,0,". Its also"],[13570,9,""],[13911,215,""],[13459,0,"for example, "],[13573,0," than automerge"],[14107,0,"base"],[14760,0," going to"],[14782,17,""],[14782,0,"(*"],[14783,1,""],[14782,1,""],[14782,0,"("],[14782,1,""],[14782,0,"*jere"],[14786,1,""],[14785,1,""],[14784,1,""],[14783,1,""],[14783,0,"here*"],[14753,37,""],[14753,0,"thats a problem for another day.)"],[15209,1,""],[15208,1,""],[15208,0,"75"],[15826,0,"Wait, no - "],[15837,6,""],[15878,22,""],[15878,0," stick around"],[16011,0,"The a"],[16015,1,""],[16015,0,"system starts off fast, but it gets slower with every keystroke"],[16078,27,""],[16011,4,""],[16011,0,"This "],[16126,0,"\n\n"],[16127,1,""],[16127,0,"> Insert diagram"],[16136,0,"n^2 "],[16147,0,"?"],[16129,7,""],[16129,0,"Can has, "],[16737,0,". This is faster"],[16753,2,""],[16788,0," "],[16788,1,""],[16781,0,"you to "],[16794,15,""],[16197,0," And by we, I mean yjs has fixed these problems. So l"],[16249,1,""],[16249,0,"what did it do?"],[16246,17,""],[16246,0,"How did it mak"],[16257,3,""],[16257,0,"do that"],[16355,0,"Yjs "],[16359,7,""],[16364,0,"s"],[16437,0,"ever"],[16437,4,""],[16454,9,""],[16454,0,"the document"],[16477,0," try to"],[16478,6,""],[16477,1,""],[16485,0,"something later"],[16500,5,""],[16505,13,""],[16504,1,""],[16503,1,""],[16502,1,""],[16502,0,"they probably"],[16506,0,"'ll"],[16558,0,". So the system"],[16573,4,""],[16583,0,"s"],[16574,0,"usually "],[16593,6,""],[16619,5,""],[16619,0,"the cached location"],[16639,1,""],[16639,0,"\n\n"],[16640,1,""],[16639,1,""],[16639,0," "],[16670,0," (and it probably owu"],[16690,1,""],[16689,1,""],[16689,0,"wo"],[16690,1,""],[16689,1,""],[16689,0,"wo"],[16690,1,""],[16689,1,""],[16688,1,""],[16688,0,"wouldn't work as well for non-text-editing applications)"],[16745,1,""],[16744,1,""],[16744,0,". B"],[16747,1,""],[17740,0," \""],[17741,1,""],[17740,1,""],[17739,1,""],[17738,1,""],[17738,0,"\"run\" is"],[17742,1,""],[17738,1,""],[17720,42,""],[17720,0,"This is  j"],[17729,1,""],[17728,1,""],[17728,0,"just a compressed version of what we wrote"],[17770,17,""],[17776,0,"."],[17778,7,""],[17778,0,"T"],[17805,0,"all "],[17842,0," "],[17842,1,""],[17842,0,". ("],[17844,1,""],[17843,1,""],[17843,0," (We assume each parent is the"],[17855,18,""],[17855,0,"the ids got up"],[17868,1,""],[17867,1,""],[17866,1,""],[17865,1,""],[17865,0," up by 1 each time, and each item has thepre"],[17908,1,""],[17907,1,""],[17906,1,""],[17906,0," previous item as a"],[17898,27,""],[17898,0,"'s parent is the previous item)"],[18109,15,""],[18109,0,"needs"],[18201,1,""],[18200,1,""],[18200,0,","],[18201,49,""],[18201,0," "],[18157,0,"later "],[18208,0,"so the logic is a bit complex."],[18240,0,"But "],[18244,1,""],[18244,0,"i"],[18260,0,"ing"],[18247,4,""],[18247,0,"this "],[18269,0," set"],[18324,4,""],[18324,0,"array"],[18356,1,""],[18355,1,""],[18354,1,""],[18353,1,""],[18352,1,""],[18351,1,""],[18998,0,", but"],[19003,3,""],[19003,0," i"],[19958,4,""],[19958,0,"reclaim"],[19965,6,""],[19965,0," the"],[19958,11,""],[19958,0,"claim the "],[19967,1,""],[19979,0," crown back"],[21597,12,""],[21597,0,"so rarely"],[21647,0,"*"],[21686,0,"*"],[21789,0,". n"],[21791,1,""],[21790,1,""],[21790,0," And this code will be used"],[21805,12,""],[21805,0,"should be fast for intera"],[21824,6,""],[21824,0,"stuf "],[21828,1,""],[21824,4,""],[21824,0,"non-text e"],[21833,1,""],[21832,1,""],[21832,0,"-editing tasks."],[21847,5,""],[21847,0,"I"],[21848,2,""],[21869,0," have to"],[21880,0," one of"],[21899,5,""],[21899,0,"document "],[22150,4,""],[22150,0,"your"],[22208,0,", just from "],[22208,12,""],[22297,0," in the last few years"],[22324,16,""],[22365,0,", even we"],[22373,1,""],[22373,0,"hen making webpages"],[22356,10,""],[22356,0,"."],[22358,1,""],[22358,0,"E"],[22383,1,""],[22383,0,","],[22385,1,""],[22385,0,"w"],[22404,1,""],[22404,0,"!"],[23036,0," that means wec"],[23050,1,""],[23050,0," can find any ti"],[23065,1,""],[23064,1,""],[23064,0,"item in"],[23071,19,""],[23071,0," about"],[23085,0," from main memory"],[23102,17,""],[23115,3,""],[23158,0,"."],[23160,16,""],[23160,0,"Again,"],[23214,0,"shuffling everything in a "],[23240,5,""],[23554,1,""],[23553,1,""],[23552,1,""],[23551,1,""],[23551,0," it uet"],[23557,1,""],[23556,1,""],[23555,1,""],[23555,0,"yet."],[23651,0,"Each leaf noe"],[23663,1,""],[23663,0,"de in my b-tree "],[23679,4,""],[23685,1,""],[23684,1,""],[23683,1,""],[23683,0,"es"],[23685,26,""],[23696,18,""],[23696,0,", all "],[23696,6,""],[23686,0,"a block of "],[23707,0,", all packed together in memory"],[23898,9,""],[23898,0,"clock cycle"],[23909,1,""],[23909,0,". Not"],[23914,14,""],[27669,13,""],[27886,3,""],[27886,0,"but we're"],[27869,5,""],[27869,0,"our"],[27881,1,""],[27881,0,"ies"],[27889,6,""],[27869,4,""],[27869,0,"what we"],[27876,11,""],[27876,0," obsess over"],[27927,0," I can code p"],[27939,1,""],[27939,0,"well enough "],[27950,1,""],[27950,0,", but do't"],[27959,1,""],[27958,1,""],[27958,0,"n't"],[27956,5,""],[27956,0,"I still get zuccini and cucubmer "],[27988,1,""],[27987,1,""],[27986,1,""],[27985,1,""],[27984,1,""],[27984,0,"mber mixed up"],[27971,1,""],[27971,0,"h"],[27971,1,""],[27971,0,"c"],[27857,0,"."],[27859,1,""],[27859,0,"We're all"],[27882,0,"ever"],[27865,4,""],[28006,0,"."],[28333,9,""],[28329,4,""],[28329,0,"the algorithms were too "],[28364,22,""],[28364,0," for practical "],[28365,14,""],[28353,0,"slow and "],[28374,0,"to be practical"],[28390,74,""],[28380,9,""],[28380,0,"useful"],[28486,8,""],[28486,0,"dim"],[28488,1,""],[28488,0,"smissed "],[28545,0," writing (and"],[28557,1,""],[28556,1,""],[28555,1,""],[28554,1,""],[28553,1,""],[28546,0,"reading and "],[28543,2,""],[28543,0,"when it comes to"],[28559,20,""],[28737,6,""],[28737,0,"make"],[28767,0," work"],[29148,11,""],[29148,0,"I do well enough with my ne"],[29148,27,""],[29148,0,"But me? I don't mik"],[29166,1,""],[29166,0,"nd kids"],[29148,8,""],[29149,0,"'m ok at"],[29157,11,""],[29148,0,"M"],[29148,1,""],[29148,0,"Me? "],[29155,3,""],[29155,0," fine"],[29160,8,""],[29160,0," with kids"],[29175,0," -"],[29176,1,""],[29175,1,""],[29206,6,""],[29206,0,"p"],[29206,1,""],[29206,0,"software "],[29512,19,""],[29523,3,""],[29527,0," super fast CRDTs for the world"],[29488,8,""],[29488,0,"o"],[29488,1,""],[29488,0,"go looking for the"],[29522,0,". In th"],[29524,5,""],[29523,1,""],[29523,0," In this case,"],[29531,6,""],[29526,5,""],[29523,3,""],[29523,0," In th"],[29526,3,""],[29523,3,""],[29522,1,""],[29502,4,""],[29502,0," the"],[29522,0,"."],[29516,0,"of fast CRDTs "],[29529,54,""],[29499,0,"inside "],[28308,4,""],[28308,0,"ah"],[28309,1,""],[28309,0,"sh"],[28379,6,""],[28379,0,"practically useful"],[28492,3,""],[15839,0,"'"],[1143,0,"indivdiual "],[1143,11,""],[1143,0,"individual "],[1183,8,""],[1183,0," operations"],[1230,3,""],[1230,0,"Do'h"],[1565,0,"that these speed"],[1576,5,""],[1576,0,"benchmark s"],[1576,11,""],[1576,0,"published sp"],[1586,2,""],[1586,0,"algorithm speeds are "],[1607,7,""],[1606,1,""],[1718,0,"\""],[1767,0,"\""],[1747,0," everybody"],[1778,0,"-"],[1778,1,""],[1778,0," - but I didn't have a "],[1786,15,""],[1786,0," was nobody, "],[1798,1,""],[1797,1,""],[1797,0,"; "],[1798,1,""],[1797,1,""],[1797,0,". I didn't have a scientific "],[1815,11,""],[1815,0,"published paper justifying my claims. Just working code."],[1853,0,"("],[1872,0,"..)"],[1852,23,""],[1585,10,""],[1591,1,""],[1591,0," cmp"],[1594,1,""],[1593,1,""],[1593,0,"omparisons"],[1667,0,","],[1667,1,""],[1706,0,"university "],[1716,1,""],[1706,10,""],[3379,5,""],[3379,0,"a decade"],[3389,0,"'ve"],[3392,7,""],[3392,0," been"],[3404,1,""],[3403,1,""],[3403,0,"ing"],[3449,15,""],[3449,0,"CRDTs. That they were doomed to always be slow and unwor"],[3504,1,""],[3504,0,"rkable"],[3515,0," - and"],[3537,0," to admit"],[3048,18,""],[3048,0,"Making CRDTs"],[3048,12,""],[3048,0,"Mak"],[3050,1,""],[3049,1,""],[3048,1,""],[3048,0,"Imple"],[3046,7,""],[3045,1,""],[3044,1,""],[1438,7,""],[1438,0,"sending me links to"],[1531,0,"a "],[1556,0,","],[1557,9,""],[1673,3,""],[1673,0," in"],[1859,0," I had some "],[1866,5,""],[1866,0,"working code but - "],[1884,1,""],[1883,1,""],[1882,1,""],[1882,0," nobo"],[1883,4,""],[1883,0,"I"],[1883,1,""],[1883,0,"it felt like nobody cared about htat."],[1915,5,""],[1915,0,"that."],[1903,0,"really "],[1896,6,""],[1896,0,"none of the smart science people"],[1914,7,""],[1914,0,"computer sicnec"],[1928,1,""],[1927,1,""],[1926,1,""],[1925,1,""],[1924,1,""],[1924,0,"cience"],[1937,7,""],[1791,14,""],[1941,0," I was nobody. "],[1955,1,""],[1955,0,"\n\nAnd I "],[1960,3,""],[1960,0,", at some point around then, I dismissed CRDTs altogether. If the researchers involved "],[2038,9,""],[2038,0,"who invented them couldn't make them fast, who was I?"],[2093,0,"But "],[2097,1,""],[2097,0,"w"],[1962,20,""],[1962,0,"somewhere around that time"],[1988,6,""],[2092,0,"\n"],[2092,0,"\n---"],[2098,5,""],[2098,0,"W"],[1956,135,""],[1955,1,""],[2477,3,""],[2477,0,"show that"],[2502,22,""],[2502,0," "],[2502,1,""],[2534,12,""],[2534,0,"actually showing"],[2550,6,""],[2551,36,""],[2543,8,""],[2543,0,"proving? It seems like tests - you can prove the absence of bugs, but th"],[2614,1,""],[2613,1,""],[2592,7,""],[2592,0,"existence "],[2601,1,""],[2615,0,"not their absence. P"],[2634,1,""],[2634,0,"Benchmarks feel like that too - you can prove the "],[2680,4,""],[2680,0,"fast code is possible, but "],[2680,9,""],[2680,0,"speed ups"],[2689,3,""],[2689,0," are"],[2708,0,"you can't prove something is slow."],[2737,0,"inherently "],[3064,5,""],[3064,0,"W"],[2551,202,""],[3088,0,"\n\n It seems like tests - you can prove the existence of bugs, but not their absence. Benchmarks feel like that too - you can prove speed ups are possible, but you can't prove something is inherently slow."],[3090,14,""],[3090,0,"Maybe benchmarks"],[3090,16,""],[3090,0,"There's a rule with"],[3100,9,""],[3100,0,"saying about"],[3117,1,""],[3117,0,"ing:"],[3122,2,""],[3122,0,"\""],[3123,1,""],[3123,0,"Y"],[3160,7,""],[3159,1,""],[3158,1,""],[3158,0,". You can't "],[3123,0,"Tests can "],[3133,8,""],[3162,4,""],[3162,0,"They ca"],[3168,1,""],[3167,1,""],[3173,0,"prove"],[3192,0,"\""],[3220,4,""],[3281,29,""],[3281,0,"an algorithm will always be slow."],[3294,12,""],[3294,0,"has to "],[2477,4,""],[2477,0,"say"],[2486,15,""],[2486,0,"an"],[2477,3,""],[2476,1,""],[2475,1,""],[2474,1,""],[2474,0,"our implementation run s"],[2497,1,""],[2496,1,""],[2496,0,"s"],[2497,21,""],[2502,0,"ly"],[2537,10,""],[2538,0,"'ve"],[2556,0,"old "],[2650,3,""],[2650,0,"is"],[2683,11,""],[2682,1,""],[2705,0,"runs "],[2834,0,"\n"],[2834,0,"\nIf you ma"],[2835,9,""],[2835,0,"But if you made a chart of that \"Ot-text is fast, and ot-text is slow\""],[2835,31,""],[2835,0,"It would be silly making a chart showing how"],[2881,3,""],[2885,0,"-t"],[2886,1,""],[2886,0,"ot"],[2880,1,""],[2890,0," both"],[2900,16,""],[2900,0," and"],[2909,1,""],[2909,0,". The difference is in the implementation. And thats true here too - "],[2835,143,""],[2835,0,"It would be silly making a chart showing how text-ot is both fast and slow. The difference is in the implementation. And thats true here too -"],[1382,48,""],[1382,0,"The annoying part was when"],[1415,8,""],[1415,0," sent around"],[1427,3,""],[1463,6,""],[1463,0,"asked"],[1536,18,""],[1570,3,""],[1570,0,"seem like"],[1582,1,""],[1582,0,"f"],[1587,1,""],[1587,0,"o"],[1590,1,""],[1590,0,"t"],[1594,1,""],[1594,0,"u"],[1640,2,""],[1640,0,"of"],[1614,0," what they were"],[1628,1,""],[1627,1,""],[1626,1,""],[1625,1,""],[1625,0,"really wor"],[1634,1,""],[1633,1,""],[1633,0,"ere -"],[1672,0,"java "],[1681,0,","],[2176,5,""],[2176,0,"aspects"],[2467,66,""],[2467,0,"W"],[2467,1,""],[2467,0,"When our implementation runs slowly, what are we actually proving?"],[2504,29,""],[2504,0,"we "],[2506,1,""],[2505,1,""],[2504,1,""],[2504,0,"I don't know if t"],[2520,1,""],[2520,0,"wher"],[2523,1,""],[2522,1,""],[2521,1,""],[2521,0,"e're proving anything about the semantics."],[2553,0,"res"],[2555,1,""],[2554,1,""],[2553,1,""],[2562,0," involved"],[2504,68,""],[2504,0,"what does that mean?"],[2504,19,""],[2504,0,"is that meaningful"],[2504,18,""],[2504,0,"does that teach us anything"],[2504,27,""],[2504,0,"what should "],[2502,14,""],[2467,0,"What s"],[2472,1,""],[2472,0,"can we learn from "],[2490,23,""],[2490,0,"a slow"],[2496,12,""],[2496,0," implementation"],[2512,0," Maybe its like tests - a passing test suite doesn't prove the absence of bugs. It just proves you aren't l"],[2618,1,""],[2592,26,""],[2591,1,""],[2557,5,""],[2557,0,"cant"],[2560,1,""],[2589,0," And a slow implementation p"],[2616,1,""],[2616,0,"sa"],[2617,1,""],[2617,0,"uggests the semantics"],[2629,9,""],[2629,0,"system is slow - ut "],[2648,1,""],[2647,1,""],[2646,1,""],[2646,0,"but it only proves"],[2616,48,""],[2615,1,""],[2557,0,"suggests, but "],[2629,0," suggests, but can't prove the system will always be slow."],[2575,1,""],[2574,1,""],[2574,0," never"],[2652,1,""],[2652,0," "],[2652,1,""],[2651,1,""],[2651,0," never"],[2995,143,""],[2994,1,""],[3071,0,"Maybe its worse - maybe "],[3095,4,""],[3099,0," had"],[3103,5,""],[3178,0,"have "],[3187,0,"ed"],[3248,221,""],[1952,0,"\n"],[1952,0,"\na"],[1953,1,""],[1953,0,"Some time around then I "],[1953,24,""],[1952,1,""],[1951,1,""],[3555,0," an"],[3557,1,""],[3556,1,""],[3555,1,""],[3735,8,""],[3959,0,"And "],[3963,1,""],[3963,0,"w"],[4644,9,""],[4656,8,""],[4656,0,"?"],[5559,0,"  "],[5607,0,"    "],[5919,0,"  "],[5873,0,"  "],[5827,0,"  "],[5925,0,"  "],[6250,21,""],[6250,0,"we can't sort them bae"],[6271,1,""],[6271,0,"sed on their ID."],[6286,1,""],[6286,0,", because the X *has to* go before the b"],[6249,77,""],[6249,0," then the document might end up as"],[6802,1,""],[6801,1,""],[6801,0,"Its the algorithmic version of "],[6918,6,""],[6744,0,"  "],[6688,0,"  "],[6632,0,"  "],[6750,0,"  "],[7006,1,""],[6996,1,""],[6952,0," to RGA"],[6956,3,""],[6956,0,"a"],[6956,1,""],[6956,0,"a"],[6956,1,""],[6956,0,"RGA"],[6939,0," is im"],[6944,1,""],[6943,1,""],[6942,1,""],[6941,1,""],[6940,1,""],[6940,0,"implements a librar"],[6953,6,""],[6952,1,""],[6952,0," CRDT called YATA which"],[7038,0," slightly"],[6939,0," - which we'll see more of later -"],[7003,0,". YATA is"],[7012,9,""],[7568,0,"thats what automerge does"],[7593,2,""],[7593,0,"so"],[7588,5,""],[7578,10,""],[7573,5,""],[7568,5,""],[7801,1,""],[363,1,""],[362,1,""],[362,0,", using various "],[387,1,""],[405,2,""],[405,0,"."],[407,1,""],[407,0,"A"],[979,4,""],[978,1,""],[969,4,""],[974,0," was going on"],[986,1,""],[986,0,"n"],[1420,4,""],[1420,0,"that several"],[1444,7,""],[1444,0," me"],[1594,0,"ed"],[1624,0,". And not"],[1633,12,""],[1737,0,", rushing"],[1739,7,""],[1739,0,"who'"],[1742,1,""],[1742,0," has a bunch of im"],[1755,5,""],[1755,0,"more implementations to code up"],[1814,4,""],[1814,0,"right"],[1851,1,""],[1850,1,""],[1850,0,"."],[1852,1,""],[1852,0,"B"],[2006,0,"Who was I? "],[2031,0,"\n"],[2031,0,"\n"],[1799,0," peer reviewed"],[2046,1,""],[2045,1,""],[2673,0," quite"],[2763,0,"that this "],[2773,3,""],[2772,1,""],[2802,0,"But "],[2810,0," trie"],[2810,5,""],[2882,0,"The "],[2882,4,""],[2882,0,"I o"],[2884,1,""],[2884,0,"took the same semantis"],[2905,1,""],[2905,0,"cs, and the s"],[2917,2,""],[2917,0,"s"],[2931,0,"."],[2933,3,""],[2933,0,"B"],[3008,4,""],[3008,0,"ran"],[3221,1,""],[3221,0," was"],[3316,0," woiu"],[3320,1,""],[3319,1,""],[3318,1,""],[3318,0,"ould have totally"],[3335,11,""],[3359,1,""],[3359,0,"."],[3361,17,""],[3361,0,"I"],[3383,0," from just reading tha p"],[3406,1,""],[3405,1,""],[3404,1,""],[3404,0,"e paper"],[3414,3,""],[3414,0,"# Making CRDTs fast"],[3615,0," the future of"],[3633,4,""],[3764,5,""],[3764,0," I assumed"],[3774,19,""],[3767,0,"dismissed them, "],[3766,0," stop "],[3771,1,""],[3771,0,"ped reading papers and"],[3783,0,"academic "],[3859,10,""],[3858,1,""],[3858,0,". A GUID a"],[3867,1,""],[3867,0,"for every character? Madness!"],[3896,1,""],[3897,55,""],[3896,1,""],[4096,15,""],[4096,0," how to make those"],[4114,10,""],[4101,0,"the best way to "],[4117,14,""],[4118,15,""],[4118,0,"implement"],[4129,3,""],[6435,4,""],[6435,0,"if i"],[6438,1,""],[6438,0,"we do that"],[6481,1,""],[6482,0,"X"],[6531,0," That would be super wrong."],[6543,14,""],[6543,0,"really"],[6543,0,"be "],[6552,0," confusing"],[8248,21,""],[8248,0,"a record of"],[8250,0,"character by character "],[8273,6,""],[8273,0,"recording"],[8486,0," about that"],[8616,0,"'s"],[11050,5,""],[11050,0,"And we can "],[11190,2,""],[11190,0,"in"],[11429,0,", as we'll see soon"],[12916,8,""],[12916,0,"insert function in"],[12982,0,"'s "],[12984,1,""],[12984,0," cR"],[12986,1,""],[12985,1,""],[12985,0,"CRDT (YATA)"],[10388,0," I've been told its about 5x faster, but I haven't "],[10429,10,""],[10429,0,"I couldn't get the version in git working."],[10392,1,""],[10391,1,""],[10391,0,"m"],[10392,5,""],[1604,1,""],[1604,0,"F"],[1609,2,""],[1609,0,"bo"],[1610,1,""],[1609,1,""],[1609,0,"about"],[1609,18,""],[1609,0,"About The Universe"],[1661,3,""],[1682,0,"s"],[1715,1,""],[1715,0," probably"],[1724,11,""],[1724,0," overstretched"],[1749,1,""],[1749,0,". One of a "],[1760,11,""],[1765,5,""],[1765,0," of"],[1785,2,""],[1785,0,"they needed to"],[1760,0,"whole "],[2827,0," With time there's always"],[2828,5,""],[2828,0,"If you wait long enouu"],[2849,1,""],[2849,0,"gh "],[2851,1,""],[2851,0,", "],[2853,5,""],[2867,0," more bugs. And always bigger smart-arses with faster im"],[2909,14,""],[2909,0,"w"],[2909,1,""],[2909,0,"to "],[2890,22,""],[2890,0,"new ways to do "],[2890,15,""],[2890,0,"faster implementations."],[2915,4,""],[2991,15,""],[2991,0,"I"],[2991,1,""],[2991,0,"Each implementation has the same"],[3339,22,""],[3339,0,"M"],[3344,0,", without noticing,"],[3433,50,""],[3487,0,"\n"],[3486,0," Benchmarking is an art, not a sciecne"],[3523,1,""],[3522,1,""],[3521,1,""],[3487,34,""],[3486,1,""],[3630,1,""],[3676,1,""],[3890,1,""],[3890,0,". I"],[3902,6,""],[3902,0,"CRDTs had"],[3911,3,""],[3963,0,"Only "],[3968,1,""],[3968,0,"m"],[3975,0," comes from those tunnels"],[3993,7,""],[3993,0,"lands"],[4113,0," h"],[4114,1,""],[4114,0,"which described"],[4129,14,""],[4172,1,""],[4171,1,""],[4170,1,""],[4169,1,""],[4169,0,". And I"],[4184,1,""],[4183,1,""],[4182,1,""],[4182,0,"ed"],[4159,10,""],[4159,0,"systems"],[3963,4,""],[3963,0,"Naught but "],[3973,1,""],[3999,5,""],[3999,0,"strange lands"],[10541,42,""],[10535,6,""],[10535,0,". I ran an early benchmark and it was barely f"],[10569,12,""],[10569,0,"glig"],[10572,1,""],[10571,1,""],[10570,1,""],[10569,1,""],[10569,0,"slightly faster"],[10569,0,"only "],[10535,1,""],[10535,0,", but"],[10570,23,""],[10570,0,"performance was almost h"],[10593,1,""],[10593,0,"the same. I'm going to "],[10586,30,""],[10586,0,"remarkably close to the javascript version - so "],[10606,0,"that of "],[10636,6,""],[10636,0,"."],[10541,96,""],[10541,0,"performance in this test was almost the same as the JS version."],[10456,0," to run through wasm"],[10555,5,""],[10555,0,". I ran the "],[10555,0,", but I see similar "],[10575,12,""],[10574,1,""],[10567,8,""],[10561,0,"at the moment "],[10576,0,"'m "],[10578,1,""],[10582,0,"ing"],[10561,88,""],[10561,0,"I'm not seeing much improvement using it yet. I suspect thin"],[10620,1,""],[10619,1,""],[10619,0,"ey have some kinks to work out before its redad"],[10665,1,""],[10664,1,""],[10663,1,""],[10663,0,"ady for release."],[10616,5,""],[10616,0," it"],[10619,5,""],[10619,0," has"],[10561,44,""],[10561,0,"I couldn't"],[10563,8,""],[10562,1,""],[10561,1,""],[10561,0,"it ran slower than that in my tests"],[10568,0,"a fair bit "],[10677,1,""],[10677,0,"; and I'll hold off on adding benchmarks at"],[10719,1,""],[10718,1,""],[10718,0,"until then."],[10561,29,""],[10561,0,"d"],[10561,1,""],[10561,0,"it didn't run that fast"],[10584,5,""],[10608,2,""],[10608,0,"they"],[10613,4,""],[10613,0,"have "],[10669,1,""],[10669,0,","],[10689,3,""],[10695,0," them to my little table"],[10719,11,""],[10689,31,""],[10689,0,"adding b"],[10696,1,""],[10696,0,"them to my table "],[10707,5,""],[10707,0,"results table"],[10539,0," supposed to be"],[10554,6,""],[10564,0," or so"],[10663,14,""],[10670,62,""],[10671,0,"\n\n---"],[9733,0," Automerge stores st"],[9752,1,""],[9751,1,""],[9751,0,"too many objects "],[9767,1,""],[9744,0,"creates and "],[9779,0,"'"],[9743,0,"'"],[9744,36,""],[9744,0,"s data structure is slow"],[9768,1,""],[9768,0,"."],[9746,0,"core "],[9769,60,""],[9768,1,""],[9768,0,"n't "],[9771,1,""],[9770,1,""],[9769,1,""],[9768,1,""],[9768,0," too l"],[9773,1,""],[9773,0,"slow."],[9768,4,""],[9751,0,"tree based "],[9780,0,"hug"],[9780,3,""],[9777,3,""],[9777,0,"gets big and "],[9794,0," as the document grows"],[10701,5,""],[10741,6,""],[10740,1,""],[10740,0," tuning"],[10767,9,""],[10767,0,"the computer run"],[10809,4,""],[10809,0," it"],[10812,9,""],[10783,1,""],[10782,1,""],[10781,1,""],[10780,1,""],[10955,0," small"],[11017,25,""],[11017,0,"I"],[13618,0," The yjs version is slightly different"],[13638,18,""],[13638,0,"almost identical."],[13638,16,""],[13638,0,"in the same file, if you want to ah"],[13672,1,""],[13671,1,""],[13671,0,"have a look. They're almost identica"],[13699,8,""],[13699,0,"impossil"],[13706,1,""],[13706,0,"ble to tell apart"],[13699,24,""],[13699,0,"identical"],[13683,0," Despite being very diffi"],[13707,1,""],[13707,0,"erent papers, the implementations"],[13740,8,""],[13740,0," are"],[13725,15,""],[13725,0,"semantics are"],[13737,1,""],[13736,1,""],[13735,1,""],[13734,1,""],[13635,0,"of this function "],[13742,9,""],[13742,0,"lig"],[13744,1,""],[13743,1,""],[13743,0,"ogic is"],[13750,4,""],[13747,0," for inserting"],[14335,0,"the "],[14374,0," codebases"],[14375,9,""],[14375,0,"code"],[14651,8,""],[14651,0,"Their "],[14695,0," (And it will be until "],[14712,6,""],[14712,0,"eh"],[14713,1,""],[14712,1,""],[14712,0,"whenever users don't"],[14695,37,""],[14697,0,"Mode"],[14700,1,""],[14699,1,""],[14698,1,""],[14698,0,"y code is "],[14704,4,""],[14704,0,"base os ob"],[14713,1,""],[14712,1,""],[14711,1,""],[14710,1,""],[14709,1,""],[14709,0,"is obviousy"],[14719,1,""],[14719,0,"ly "],[14722,31,""],[14722,0,"very different from automerge."],[14753,1,""],[14753,0,"F"],[14765,26,""],[14765,0," I'm not using"],[14779,4,""],[14712,25,""],[14711,1,""],[14710,1,""],[14709,1,""],[14709,0,"has lots of differences "],[14737,0," the real"],[14756,0," library"],[14769,9,""],[14769,0," instance,"],[14769,10,""],[14769,0," example,"],[14756,8,""],[14741,5,""],[14737,4,""],[14732,1,""],[14720,12,""],[14717,3,""],[14712,5,""],[14709,3,""],[14709,0,"is obviously very different "],[14779,0," use"],[14773,6,""],[14769,4,""],[14765,4,""],[14765,0," my implementation doesn't"],[14753,1,""],[14753,0,"f"],[14741,11,""],[14736,5,""],[14726,10,""],[14722,4,""],[14722,0,"Its not exactly like-for-like -"],[14721,1,""],[14719,2,""],[14719,0,"y"],[14711,9,""],[14709,2,""],[14709,0,"os ob"],[14711,3,""],[14708,3,""],[14704,4,""],[14704,0," is "],[14707,1,""],[14704,3,""],[14699,5,""],[14698,1,""],[14698,0,"ode"],[14697,92,""],[15120,0,"\nBut a lot of that difference really is immutablejs.\n"],[15121,0,"("],[15121,1,""],[15121,0,"(But bear in mind there's only so much we can conclude from this. "],[15186,1,""],[15185,1,""],[15185,0," about the data"],[15121,79,""],[15121,0,"I wish I could take full c "],[15136,11,""],[15136,0,"give Kevin's approach"],[15135,22,""],[15135,0," attribute all of that to this sweet data structure. "],[15187,1,""],[15238,0," gumming up th eworke"],[15258,1,""],[15252,6,""],[15252,0,"e works"],[15205,0," performance"],[15271,0," "],[15271,1,""],[15205,12,""],[15259,0," for automerge"],[14770,0,", and 30x more"],[14784,15,""],[15156,0," diffee"],[15162,1,""],[15162,0,"rence"],[15175,0," super"],[15182,5,""],[15182,0,"simple"],[15176,12,""],[15176,0,"sweet and simple"],[15260,24,""],[15259,1,""],[15259,0," making"],[15267,0,"everything "],[15287,0," does slower"],[15298,1,""],[15297,1,""],[15287,10,""],[15267,11,""],[15276,0," slow"],[15267,0,"all of "],[15283,0,"'s code"],[15295,0,"dow"],[15297,1,""],[15296,1,""],[15295,1,""],[15295,0," down"],[15299,1,""],[15298,1,""],[15297,1,""],[15296,1,""],[15295,1,""],[15145,0,"*"],[15149,0,"*"],[15249,0," just"],[15240,10,""],[15257,35,""],[15257,0,"slow"],[15257,0,"being "],[15240,4,""],[15240,0,"is probably attributat"],[15261,1,""],[15260,1,""],[15260,0,"able to"],[15279,11,""],[15279,0," alone"],[15240,27,""],[15240,0,"can probably"],[15244,8,""],[15240,4,""],[15240,0,"is just"],[15247,18,""],[15247,0," automerge's lack of "],[15260,8,""],[15260,0," im"],[15262,1,""],[15261,1,""],[15261,0,"implementations"],[15275,1,""],[15260,1,""],[15274,0," (and immutablejs)"],[15224,4,""],[15224,0,"the"],[15238,0," here"],[15247,5,""],[15247,0,"probably just quirks of "],[15297,0,"."],[15300,0,"Oh, "],[15260,10,""],[15260,0," due to "],[15267,1,""],[15247,9,""],[15247,0,"probabl "],[15254,1,""],[15254,0,"y "],[15260,0," little microoptimizations"],[15286,34,""],[15288,22,""],[15288,0,"My code ex"],[15297,1,""],[15296,1,""],[15295,1,""],[15294,1,""],[15293,1,""],[15292,1,""],[15291,1,""],[15291,0,"implementation executes less code, and "],[15288,42,""],[15287,1,""],[15256,30,""],[15256,0,"from immutablejs"],[15256,4,""],[15256,0,"just"],[15272,0," gumming things up"],[15316,0,"Now that "],[15325,1,""],[15325,0,"w"],[15337,3,""],[15337,0,"a fast"],[15343,8,""],[15339,0,"clean and "],[15316,10,""],[15316,0,"W"],[15355,0," "],[15355,1,""],[15366,0," now"],[20491,0," If there was a programming "],[20507,12,""],[20507,0,"programmer version of speedrunning"],[20529,0,"the "],[20545,0," community, Kevin would be there with bells on."],[20557,34,""],[20557,0,"they would adore KEv"],[20576,1,""],[20575,1,""],[20575,0,"evin"],[20405,4,""],[20405,0,"he rewrote"],[20428,20,""],[20408,0,"wrote and "],[20474,4,""],[20474,0," run"],[20488,14,""],[20488,0,"If there was a"],[22875,0,"would "],[22885,1,""],[22885,0," you"],[22875,0,"like that "],[22904,22,""],[22987,16,""],[22987,0,"as much as possible with each rae"],[23019,1,""],[23018,1,""],[23018,0,"ead to main ma"],[23031,1,""],[23031,0,"emory"],[23273,0," I wannt"],[23280,1,""],[23279,1,""],[23279,0,"t"],[23291,6,""],[23291,0,"to"],[23329,0," "],[23342,0," it"],[23356,7,""],[23355,1,""],[23359,6,""],[23358,1,""],[23768,22,""],[23744,24,""],[23744,0,"been able to improve its performance"],[23736,0,"s"],[23737,33,""],[23737,0," "],[23749,0," ahs"],[23752,1,""],[23751,1,""],[23750,1,""],[23750,0,"hasn't improved"],[23851,0," We "],[23854,1,""],[23853,1,""],[23852,1,""],[23851,1,""],[23766,1,""],[23766,0,"\n\n"],[23851,1,""],[23851,0," these days. We can d"],[23871,1,""],[23871,0,"coe t"],[23875,1,""],[23874,1,""],[23873,1,""],[23873,0,"de this is "],[23883,1,""],[23882,1,""],[23882,0,"n anything."],[23892,0,"*"],[23884,0,"*"],[23881,2,""],[23881,0,"up in"],[24065,0," also"],[24069,1,""],[24068,1,""],[24068,0,"most"],[24060,13,""],[24060,0,"is almos ti"],[24070,1,""],[24069,1,""],[24068,1,""],[24068,0,"t identical to"],[24082,11,""],[24258,1,""],[24258,0,", w"],[24260,1,""],[24260,0,"so we can qui"],[24270,3,""],[24270,0,"find anything "],[24258,26,""],[24258,0,"."],[24172,4,""],[24172,0,"E"],[24204,3,""],[24210,0,"s"],[24629,0," We update a leaf, then its parent, and its parent, all the way up to th eroo"],[24705,1,""],[24704,1,""],[24703,1,""],[24702,1,""],[24701,1,""],[24701,0,"e root"],[24707,22,""],[24708,0," A"],[24709,1,""],[24709,0,"So"],[24712,1,""],[24712,0,"a"],[24653,0,"the"],[24655,1,""],[24654,1,""],[24653,1,""],[24653,0,"the character oun"],[24669,1,""],[24668,1,""],[24667,1,""],[24667,0,"counts at "],[24742,0," after"],[24763,3,""],[24762,1,""],[24837,37,""],[24837,0,"W"],[24837,1,""],[24837,0,"It doesn't come into play here, but w"],[24837,0,"We never merge edits from remote peers in this test,"],[24889,35,""],[24889,0," but I made that fast too anyway."],[24923,1,""],[24923,0,"W"],[24989,0,"eg "],[25049,20,""],[25049,0,"search by ID."],[25039,1,""],[25038,1,""],[25037,1,""],[25037,0,"little "],[25060,0,"the b-tree "],[25154,20,""],[25154,0,"It might help -"],[25171,0," just"],[25602,0," I picked 32 by trying a few numbers"],[25631,0,"different numbers and benchmarking "],[25665,1,""],[25665,0,"."],[25666,7,""],[25666,0," Higher"],[25667,6,""],[25667,0,"T"],[25667,1,""],[25667,0,"32 seems"],[25674,1,""],[25674,0,"ed pretty good."],[25618,35,""],[25630,0," the system with a few different sizes"],[25679,0," to work"],[25694,5,""],[25694,0," well"],[25635,0,"whole "],[26747,33,""],[27673,0,"But "],[27677,1,""],[27677,0,"w"],[27694,4,""],[27902,5,""],[27902,0,"M"],[28002,6,""],[28002,0,"the document"],[28024,0," Ropey on its own takes 29ms to process this string"],[28069,6,""],[28069,0,"docu"],[28069,4,""],[28069,0,"editing trace."],[29220,0," -"],[29222,4,""],[29222,0," "],[29222,1,""],[29222,0," "],[29244,0," are *weird*"],[29325,11,""],[29332,0," in the two b-trees"],[29406,0,"should "],[29418,1,""],[29802,1,""],[29802,0," - to the "],[29802,10,""],[29802,0,"."],[30289,0," turned my back on academia i"],[30317,1,""],[30317,0,"and"],[31178,0," figure out how to"],[31206,5,""],[31237,15,""],[31237,0,"turning toward th"],[31251,3,""],[31244,7,""],[31237,7,""],[31237,0,"doing that work"],[31237,15,""],[31237,0,"answering that call"],[31340,2,""],[31340,0,"start"],[31353,7,""],[31353,0," to a"],[31357,1,""],[31357,0,"make"],[31361,25,""],[31367,0," fast"],[31373,0," And return with the treat"],[31398,1,""],[31398,0,"sure of these algirh"],[31417,1,""],[31416,1,""],[31416,0,"o"],[31416,1,""],[31415,1,""],[31415,0,"orithms. (Well, it took a decade and *k"],[31453,1,""],[31453,0,"Kevin*)"],[31459,0,"."],[31447,0,", some hard work"],[31476,0," Thanks dude!"],[31477,12,""],[31468,0,"some great ideas from"],[31489,1,""],[31489,0," "],[31495,1,""],[31495,0," and Martin"],[31496,0,"Jahns "],[31512,0," Kleppmann"],[31523,1,""],[31423,1,""],[31423,0,"\n\n"],[31425,1,""],[31523,1,""],[31523,0," I couln"],[31530,1,""],[31530,0,"dn't have done it "],[31524,24,""],[31524,0,"Automerge's run-"],[31536,4,""],[31536,0,"document encoding system is fantastic - and "],[31576,4,""],[31575,1,""],[31574,1,""],[31573,1,""],[31573,0,"."],[31524,12,""],[31524,0,"The "],[31552,0," Martin made for Automerge"],[31591,0,", and was the inpsi"],[31609,1,""],[31608,1,""],[31607,1,""],[31607,0,"spiration for Yjs's "],[31621,0,"the euqu"],[31628,1,""],[31627,1,""],[31626,1,""],[31626,0,"quivalent in "],[31644,1,""],[31643,1,""],[31642,1,""],[31643,0," And "],[31644,4,""],[31644,0,"Using incrementing sequence numbers"],[31489,0," a bunch of clever people."],[31515,34,""],[31551,0," Kell"],[31555,1,""],[31554,1,""],[31553,1,""],[31553,0,"leppmann"],[31646,0,"The system of "],[31660,5,""],[31660,0,"using"],[31695,0," instead of UUIDs"],[31696,11,""],[31696,0,"to save storing "],[31704,0,"generating an d"],[31717,1,""],[31718,0," "],[31678,0," (agent id,"],[31698,8,""],[31698,0,") tuples"],[31709,0," avoid"],[31715,5,""],[31744,0," is genius. And"],[31501,0,"other "],[31604,0," it"],[31765,3,""],[31765,0,"I have no idea who came up with that. And Kevin's list approach I describe here is the sort of obvious j"],[31868,1,""],[31860,0,"fantastic, "],[31879,0,"idea that 100 smart p"],[31893,7,""],[31893,0,"p"],[31893,1,""],[31893,0,"smart pp"],[31900,1,""],[31900,0,"eople have surely walked tirhg "],[31925,6,""],[31925,0,"right past without noticing it."],[31501,5,""],[31500,1,""],[31507,7,""],[31507,0," folks"],[31624,4,""],[31624,0," its"],[31592,5,""],[31592,0,"."],[31594,1,""],[31594,0,"I"],[31594,50,""],[31561,4,""],[31561,0,"in"],[31562,1,""],[31561,1,""],[31551,10,""],[31551,0,"invented for"],[31564,4,""],[31753,0,"representi"],[31762,1,""],[31762,0,"ation "],[31768,9,""],[31768,0,"approach "],[31768,9,""],[31845,0,"must "],[31900,0," I don't know"],[31901,12,""],[31901,0,"I don't know that I wouldn't "],[31929,1,""],[31928,1,""],[31927,1,""],[31926,1,""],[31926,0," have thouhg"],[31909,29,""],[31909,0,"think I woul"],[31903,18,""],[31903,0,"think I wouldn't"],[31918,1,""],[31917,1,""],[31916,1,""],[31916,0," have walked right past that "],[31902,43,""],[31902,0," wouldn't have thought of that either."],[31519,8,""],[31519,0,"binary"],[31575,9,""],[31575,0,"brilliant"],[31647,0,"in order "],[31665,23,""],[31670,0," everywhere"],[31691,1,""],[31691,0,", and"],[31738,0," of course,"],[31750,7,""],[31750,0,"The"],[31752,1,""],[31751,1,""],[31750,1,""],[31750,0,"the"],[31773,0," + insertion approack"],[31793,1,""],[31793,0,"h"],[31750,0,"Kevin's "],[31758,3,""],[31757,1,""],[31886,7,""],[31920,3,""],[31922,39,""],[31922,0,"I wouldn"],[31929,1,""],[31929,0," n"],[31930,1,""],[31930,0,"have "],[31929,6,""],[31929,0,"n't have thought of that either."],[31924,8,""],[31924,0,"don't think I would "],[31943,1,""],[31817,12,""],[31827,1,""],[31827,0,". Its the"],[31829,25,""],[31829,0,"I bet"],[31879,0," that iea"],[31887,1,""],[31886,1,""],[31886,0,"dea over the last decade"],[31918,0," any of them"],[31939,0," it"],[31982,11,""],[31982,0,"it either"],[37968,9,""],[37968,0,"Why is"],[37998,15,""],[37998,0,"so slow?"],[38008,9,""],[38019,0,"just "],[38027,5,""],[37968,0,"I don't get it - "],[37985,1,""],[37985,0,"w"],[39399,1,""],[39398,1,""],[39397,1,""],[39396,1,""],[39395,1,""],[39394,1,""],[39394,0,"Im "],[39396,1,""],[39395,1,""],[39395,0,"'m dying."],[39404,5,""],[39403,1,""],[39403,0,"!"],[39394,0,"Stop - "],[39442,4,""],[39545,66,""],[39555,1,""],[39555,0," already has been replaced with w"],[39587,1,""],[39587,0,"automerge-rs"],[39599,8,""],[39599,0," "],[39632,0," So itd "],[39639,1,""],[39638,1,""],[39638,0," doesn' "],[39645,1,""],[39645,0,"t matter"],[39653,70,""],[39653,0,".\n"],[39654,0," Try not to think about it. *Twitch*"],[39683,1,""],[39683,0,"t"],[39689,0,"."],[39681,0," Definitely don't submit any PRs to fi"],[39682,37,""],[39681,1,""],[39681,0," Definitely don't submit any PRs to fix all the low hanging fruit."],[37885,0," Moving from automerge to au"],[37912,1,""],[37911,1,""],[37911,0,"reference-crdts"],[37911,0,"my "],[37929,66,""],[37929,0," changes:\n\n- Core"],[37942,4,""],[37942,0,"The core data structure (list -> "],[37974,1,""],[37973,1,""],[37972,1,""],[37971,1,""],[37967,4,""],[37967,0,"tree to list)\n- Removed immutablejs\n- Removed automerge's frontend / backend protocol\n- Use d"],[38059,1,""],[38058,1,""],[38058,0,"d a different javascript style\n\nWhich "],[38090,6,""],[38090,0,"Which"],[37930,0,"resulted in changes to"],[37952,7,""],[38110,0," of these changes made the"],[38105,31,""],[38105,0,"W"],[38105,1,""],[38105,0,"How can "],[38105,8,""],[38105,0,"The change from reference-crdts to yjs is"],[38145,1,""],[38144,1,""],[38143,1,""],[38143,0,", and yjs to my rust code "],[38115,0,"s"],[38150,0,"from "],[38175,0,"are similarly big. "],[38193,1,""],[38193,0," Its possible I'm mi"],[38194,0,"So "],[38197,1,""],[38197,0,"i"],[38216,0,"sattributing the performance"],[38216,0,"s"],[38216,1,""],[38233,0,"speedups"],[38241,11,""],[38241,0," here; wheras "],[38246,9,""],[38246,0,".\n\nI suppose to answer that"],[38103,0,"\n\nTh"],[38106,1,""],[38105,1,""],[38105,0,"My code"],[38105,7,""],[38105,0,"We got 10x performance from this change. How "],[38146,4,""],[38146,0,"But which ch"],[38156,2,""],[38156,0,"part of this"],[38150,18,""],[38150,0,"to what should we attribute the speedup?"],[38067,0,". And all the Uint8Arrays that appeared"],[38098,8,""],[38098,0,"pop up throughout automerge's "],[38127,1,""],[38126,1,""],[38125,1,""],[38125,0," for whatever reason."],[38229,40,""],[38229,0,"I don't *really* know how to attribute that speedup amongst all the changes."],[38395,54,""],[38391,4,""],[38391,0,"monolo"],[38396,1,""],[38396,0,"ithic."],[38404,24,""],[38404,0,"And yes, this is a reasonabile"],[38433,1,""],[38432,1,""],[38431,1,""],[38431,0,"le criticism of this appar"],[38456,1,""],[38455,1,""],[38455,0,"roach. I covered too much territory here."],[38495,0," to be thorough"],[38502,0,"as "],[38513,0," as I'd like. We"],[38527,2,""],[38527,0,"I did benchmakr "],[38542,1,""],[38541,1,""],[38540,1,""],[38540,0,"rk 4 different CRDT implementations - 2 of which I wrote myself from scratch"],[38575,0," here"],[38258,10,""],[38258,0,"distribute "],[38305,0," that happened"],[38417,0," Maybe rust is just that much faster than javascript, and all my discussion"],[38469,0," for this sort of thing"],[38515,0," of pointers is just made up?"],[38543,1,""],[38543,0,"."],[38546,5,""],[38546,0,"Y"],[38549,1,""],[38549,0,"."],[38551,1,""],[38551,0,"T"],[38760,0," And this post is "],[38546,232,""],[38546,0,"Yes. This is a reasonable criticism of this approach. I covered too much territory here to be as thorough as I'd like. I did benchmark 4 different CRDT implementations here - 2 of which I wrote myself from scratch. And this post is nearly 7000 words already."],[38149,8,""],[38149,0,"A"],[38149,1,""],[38149,0,"Tje"],[38151,1,""],[38150,1,""],[38150,0,"he"],[38152,8,""],[38169,0," is totally different ("],[38191,1,""],[38190,1,""],[38190,0,". (FP javascript -> imperitive)"],[38215,1,""],[38215,0,"a"],[38270,5,""],[38269,1,""],[38269,0,"'m only guessing"],[38285,14,""],[38293,10,""],[38293,0,"assign t"],[38300,1,""],[38299,1,""],[38351,0," And for what its worth - I ssu"],[38381,1,""],[38380,1,""],[38380,0,"uspect just removing immutablejs and tidying up automerge"],[38416,0," doing some obvious"],[38435,21,""],[38435,0," "],[38435,1,""],[38435,0," tidying up automerge"],[38427,8,""],[38422,5,""],[38416,6,""],[38427,10,""],[38424,3,""],[38416,8,""],[38412,4,""],[38400,12,""],[38391,9,""],[38386,5,""],[38380,6,""],[38380,0,"su"],[38378,4,""],[38376,2,""],[38374,2,""],[38368,6,""],[38364,4,""],[38359,5,""],[38355,4,""],[38351,4,""],[38455,0,"my "],[38462,0," code"],[38470,5,""],[38504,22,""],[38504,0,"because rust is fast"],[38512,12,""],[38512,0,"of"],[38512,2,""],[38512,0,"the rust omp"],[38523,1,""],[38522,1,""],[38521,1,""],[38521,0,"compiler"],[38512,0,"of"],[38514,3,""],[38528,0," specifics"],[38529,9,""],[38529,0,"stuff"],[38573,12,""],[38573,0,"fake news"],[38573,9,""],[38573,0,"invented"],[38834,7,""],[38833,1,""],[38834,0," So I suppose"],[38835,12,""],[38835,0,"If this bothers you, please do those benchmarks. I'd love to "],[38866,6,""],[38866,0,"more detailed "],[38584,320,""],[38584,0,"Yes. This is a reasonable criticism of this approach. I covered too much territory here to be as thorough as I'd like. I did benchmark 4 different CRDT implementations here - 2 of which I wrote myself from scratch. And this post is nearly 7000 words. If this bothers you, please do more detailed benchmarks. I'd love to"],[38059,8,""],[38059,0,"malarky"],[38059,7,""],[38059,0,"protocol"],[38068,0," And"],[38072,4,""],[38077,3,""],[38077,0,"those"],[38147,0," are gone too, obviously"],[38610,0,"And, "],[38615,1,""],[38615,0,"y"],[38669,161,""],[38669,0,"I "],[38670,1,""],[38670,0,"f this bothers, "],[38685,1,""],[38684,1,""],[38684,0," you'"],[38688,1,""],[38688,0,", I'd *love* to "],[38701,3,""],[38701,0,"for someone to pull apart each of these changes and "],[38741,12,""],[38741,0,"performance differences and show me"],[38768,8,""],[38768,0," publish a more detailed guide. I'd read the heck out of that."],[38830,104,""],[38765,0,"between implementations I show here "],[38866,0,"\n\n\n### You haven't published"],[38873,21,""],[38873,0,"Where is the code to re-run your benchmarks?"],[38873,0,"I don't believe you. "],[38873,21,""],[38917,0," I want to verify &"],[38935,1,""],[38935,0,"t"],[38935,1,""],[38934,1,""],[38928,6,""],[38928,0,"play\n\nThe benchmark code for yjs and automerge I'm running is [here](https://gist.github.com/josephg/13efc1444660c07870fcbd0b3e917638). For my rust implementation I'm benchmarking [this code](https://github.com/josephg/text-crdt-rust/tree/ba20b6386c0472958f33024ce0b806e75470e1ca). Run it with `car"],[38991,4,""],[38991,0,"in this github gist"],[39078,1,""],[39078,0,"\n\n"],[39242,0,"go criterion yjs` or `cargo criterion ropey` for the ropey baseline. Turn on oa"],[39320,1,""],[39319,1,""],[39319,0,"and off the inline rope updates in "],[39351,3,""],[39351,0,"near the o"],[39360,1,""],[39350,10,""],[39350,0," my commenting out lines near the top of src/universal/doc.rs."],[38956,0," javascript"],[38957,10,""],[38957,0,"my JS string baseline,"],[38998,12,""],[39089,0," Its a mess."],[39100,1,""],[39100,0,"; but messy is better than missing."],[39111,0," links"],[39112,5,""],[39112,0,"code"],[39139,0," code"],[39326,0," "],[39326,1,""],[39354,3,""],[39354,0,"to isolate"],[39486,0,"\n\nI haven't uploaded my wasm wrapper anywhere."],[39510,0,"rust "],[39514,0," crdt"],[39486,0," You can add `--features memusage` to print out memory allocator statistics. (T"],[39564,1,""],[39563,1,""],[39562,1,""],[39561,1,""],[39561,0,". (This is how I'm generating "],[39580,11,""],[39580,0,"figurout "],[39588,1,""],[39587,1,""],[39586,1,""],[39585,1,""],[39585,0,"ing out how much r"],[39602,1,""],[39602,0,"RAM I'm using)."],[39563,1,""],[39614,1,""],[39561,1,""],[39561,0," - which is"],[39572,8,""],[39145,0," "],[39145,1,""],[38918,14,""],[38917,1,""],[38872,0," IS thi"],[38878,1,""],[38877,1,""],[38876,1,""],[38875,1,""],[38874,1,""],[38874,0,"s this reproducable?"],[38881,12,""],[38881,0,"reproducable"],[38912,27,""],[38912,0," that e"],[38918,1,""],[38918,0,"generated these benchmark results?"],[38895,57,""],[38895,0,"Show me the code"],[38907,0,"benchmarking "],[38924,0," please"],[38924,7,""],[38924,0,"!"],[33461,7,""],[33461,0,"sleights"],[31273,0,"I got frustrated with academia a"],[31304,1,""],[31304,0,"on the whole and "],[31353,1,""],[31353,0,"."],[31355,5,""],[31355,0,"I"],[31294,0," c"],[31295,1,""],[31295,0,"disappointing app"],[31311,1,""],[31310,1,""],[31309,1,""],[31309,0,"app"],[31311,1,""],[31310,1,""],[31309,1,""],[31308,1,""],[31308,0," papers and"],[31341,0,","],[31424,2,""],[31424,0,"at how we can"],[31458,0," to"],[31455,6,""],[31454,47,""],[31454,0," And bring us to this point."],[31455,27,""],[31454,1,""],[31454,0," "],[31454,1,""],[31453,1,""],[31453,0," and no time at all to arrive at these performance numbers."],[31688,0," avoiding UUIDs by"],[31753,36,""],[31753,0," "],[31764,4,""],[31763,1,""],[31763,0,"."],[31801,0,", but its brilliant"],[31807,13,""],[31807,0,"I love it"],[31897,13,""],[31897,0," makes everything si"],[31916,1,""],[31916,0,"o much simpler"],[32049,11,""],[32049,0,"doubt"],[32103,2,""],[32103,0,"fast CRDTs"],[32102,6,""],[32102,0," the formula for fast "],[32129,0,", "],[32130,1,""],[32129,1,""],[32123,1,""],[32123,0,", lightwa"],[32131,1,""],[32131,0,"eight "],[32141,1,""],[32141,0," implementations"],[32094,0,", after a decade of waiting,"],[32190,1,""],[32190,0,"\n\n"],[32191,1,""],[32190,1,""],[32190,0," "],[39104,740,""],[39045,59,""],[39044,1,""],[33694,0,"\n\nIf you want to play with any of the benchmarks yourself, the "],[33753,4,""],[33753,0,"here's "],[33751,9,""],[33751,0,":\n\n\nThe benchmark code for my JS string baseline, yjs and automerge is [in this github gist](https://gist.github.com/josephg/13efc1444660c07870fcbd0b3e917638). Its a mess; but messy code is better than missing code.\n\nFor my rust implementation I'm benchmarking [this code](https://github.com/josephg/text-crdt-rust/tree/ba20b6386c0472958f33024ce0b806e75470e1ca). Run it with `cargo criterion yjs` or `cargo criterion ropey` to isolate the ropey baseline. Turn on and off the inline rope updates my commenting out lines near the top of src/universal/doc.rs. You can add `--features memusage` to print out memory allocator statistics - which is how I'm figuring out how much RAM I'm using.\n\nI haven't uploaded my rust crdt wasm wrapper anywhere."],[33753,1,""],[33752,1,""],[33751,1,""],[33751,0,", most of t"],[33751,11,""],[33751,0,":\n"],[33742,0," I ran"],[33757,0,", everything is a bit of a hodge b"],[33790,1,""],[33790,0,"podge"],[33695,0,"\n\n"],[33696,0,"### You haven't published the code which generated your results"],[33860,1,""],[33860,0,". But its almost all online."],[34129,0," results"],[34318,0,"if you want "],[34593,0," You'll need `automerge-paper.json.gz` from [this repositor"],[34643,9,""],[34643,0,"repository"],[34593,1,""],[34593,0,"\n\n"],[34654,0,"](https://github.com/josephg/crdt-benchmarks) for most of these tests."],[34602,0,"also "],[34705,3,""],[34705,0,"in order to run"],[34101,0,"\n\nThe reference "],[34116,1,""],[34116,0,"-crdts benchmark is in th"],[34133,8,""],[34133,0,"code is [in thi"],[34147,1,""],[34147,0,"e repository here](https://github.com/josephg/reference-crdts/blob/main/bench.ts). You ca"],[34230,6,""],[34230,0,"If you want to measuer m"],[34253,1,""],[34252,1,""],[34251,1,""],[34250,1,""],[34250,0,"re memory usage you can use the same approach as I did i"],[34305,1,""],[34103,202,""],[34103,0,"The reference-crdts benchmark code is [in the repository here](https://github.com/josephg/reference-crdts/blob/main/bench.ts). If you want to measure memory usage you can use the same approach as I did"],[33913,3,""],[33913,0,"the "],[33954,0," tests"],[34152,3,""],[34152,0,"its"],[34166,5,""],[34166,0," here"],[34311,0,"'"],[34276,0,"'"],[34277,35,""],[34277,0,"ll need to add"],[34291,1,""],[34291,0," queries"],[34272,27,""],[34272,0,", follow the approach from the gist and "],[34307,5,""],[34307,0,". You can run tihs code "],[34321,10,""],[34321,0,"this code with `node --loader ts-node/esm --expose-gc bench.ts`"],[34307,0," of printing out"],[33940,4,""],[33940,0,","],[33951,0," and reference-crdts"],[33980,0," all jammed into"],[33998,3,""],[33985,11,""],[33985,0,"in"],[34166,2,""],[34166,0,"needs"],[34131,295,""],[34165,4,""],[34165,0," come from"],[34435,2,""],[34435,0,"by"],[34449,25,""],[34449,0,"editing the global c"],[34461,8,""],[34461,0,"constant at the top of"],[34581,0,"while benchmarking "],[34602,12,""],[34602,0,"thats how"],[34642,9,""],[34642,0,"its using. (Note you can't measure memory using "],[34684,6,""],[34684,0,"su"],[34685,1,""],[34684,1,""],[34684,0,"usage during tests because test mode changes the memory"],[34702,37,""],[34702,0,")"],[34668,0," accurately"],[34701,7,""],[34701,0,"in the unit testing environment"],[34732,5,""],[34882,0," The reference-crdts implementation depends on ["],[34902,15,""],[34902,0," benchmarks"],[34912,1,""],[34925,0,"crdts.ts]("],[34934,1,""],[34933,0," from this repository"],[34955,0,"(https://github.com/josephg/reference-crdts/tree/fed747255df9d457e11f36575de555b39f07e909)"],[34954,0,", at this version"],[34199,0,", at this version"],[33699,60,""],[33699,0," How do I reproduce your results?"],[33709,22,""],[33709,0,"re-run your benchmark results"],[33699,0," I don't believe you"],[33699,20,""],[33709,3,""],[33727,0,"s myself"],[33735,8,""],[33713,4,""],[33713,0,"these"],[38416,53,""],[38416,0,"we need to take a lot more seriously is how we"],[38470,1,""],[38469,1,""],[38468,1,""],[38468,0,"e"],[38648,1,""],[38648,0," - so the model of \"load an objet"],[38680,1,""],[38680,0,"ct, keep it in ram for "],[38699,4,""],[38699,0,"while its open and then save it"],[38723,0,"eventually "],[38741,0,"\" doesn't work."],[38751,4,""],[38751,0,"apply"],[39104,0,"\n\n"],[39105,1,""],[39104,1,""],[39104,0,"\n\n> Edit: Kevin says there are "],[39125,10,""],[39125,0,"you can do this "],[39133,8,""],[39133,0,"adapt Yjs's providers to implement this in a reasonable way. Id"],[39195,1,""],[39195,0,"'d"],[39194,3,""],[39194,0,"I"],[39194,1,""],[39194,0,"Kevin is usually right; but I'd sure love to see that in action."],[39194,64,""],[39193,1,""],[39193,0," I'd love to see that in action."],[39194,31,""],[39193,1,""],[39193,0," I'd ove"],[39200,1,""],[39199,1,""],[39198,1,""],[39198,0,"love to see that in action."],[40111,4,""],[40111,0,"I can "],[40129,1,""],[40128,1,""],[40127,1,""],[40146,0," 10x"],[40171,0,"of "],[40185,14,""],[40178,7,""],[40178,0,"differences"],[40288,0,"How much f"],[40297,1,""],[40297,0,"of the speed difference beween"],[40321,6,""],[40321,0,"between my"],[40331,8,""],[40341,0," and yjs is simply due to"],[40366,67,""],[40360,6,""],[40360,0,"thnks"],[40364,1,""],[40363,1,""],[40362,1,""],[40362,0,"anks to the rust compiler?"],[40388,48,""],[40349,0," has nothing to do with memory layout, and everything to do wtih"],[40412,1,""],[40411,1,""],[40410,1,""],[40410,0,"ith"],[40413,20,""],[40432,0," I don't know."],[40432,1,""],[40432,0,"\n\n"],[40449,3,""],[40449,0,"So"],[40446,1,""],[40446,0,"!"],[40643,7,""],[40643,0,"tease apart"],[40708,0," I love benhc"],[40720,1,""],[40719,1,""],[40719,0,"chmarking stories. That "],[40742,1,""],[40742,0,"s normal, right?"],[948,39,""],[959,6,""],[959,0,"implementation "],[1333,5,""],[1333,0,"yout"],[1336,1,""],[1336,0,"r"],[1531,9,""],[1530,1,""],[2203,3,""],[2202,1,""],[2201,1,""],[2200,1,""],[2199,1,""],[2198,1,""],[2198,0," RGA is an"],[2209,1,""],[2209,0,"A"],[2401,20,""],[2401,0,"What are the rules?"],[2419,1,""],[2419,0," which describe the system's behaviour?"],[2585,0,"When "],[2585,5,""],[2585,0,"If my "],[2591,24,""],[2591,0,"implementation runs"],[2615,0,"ly,"],[2618,15,""],[2618,0," what can we infer from that"],[2631,0,"really s"],[2638,1,""],[2624,29,""],[2624,0,"does that actul"],[2638,1,""],[2638,0,"ally tll"],[2645,1,""],[2644,1,""],[2644,0,"ell us"],[2673,1,""],[2672,1,""],[2672,0,"."],[2674,1,""],[2674,0,"A"],[2719,6,""],[2728,0,"re are no more"],[2742,11,""],[2738,4,""],[2737,1,""],[2725,0,"that "],[2897,0,", maybe,"],[2905,7,""],[2905,0," writes"],[3305,5,""],[3305,0,"testing"],[3487,13,""],[3837,6,""],[3837,0,"a "],[3845,0," or so "],[3851,1,""],[3850,1,""],[3849,1,""],[3848,1,""],[3847,1,""],[3846,1,""],[3846,0,"ago"],[3851,0," decided to"],[3869,1,""],[3868,1,""],[3867,1,""],[4071,0,"I think "],[5241,0,"i nThe "],[5247,1,""],[5246,1,""],[5245,1,""],[5244,1,""],[5243,1,""],[5242,1,""],[5241,1,""],[5241,0,"in The Literature "],[5244,15,""],[5244,0,"the academic literature "],[5267,1,""],[5256,11,""],[5247,9,""],[5244,3,""],[5244,0,"The Literature "],[5244,15,""],[5244,0,"the academic literature "],[5267,1,""],[5256,11,""],[5247,9,""],[5244,3,""],[5243,1,""],[5242,1,""],[5241,1,""],[5282,0,"n academic"],[7310,8,""],[7508,1,""],[7471,0," But"],[7476,1,""],[7476,0,"t"],[7496,0," really"],[29306,1,""],[29306,0,"&lt;"],[29248,240,""],[29248,0,"\nAnd oh look - those last three rows are *weird*! 29 and 23 don't add up to 65. I'm probably thrashing the CPU cache by interleaving updates in the two b-trees. Looks like a *batch_update()* method would bring that 65ms down to *52ms*.\n"],[33600,46,""],[33600,0,"Benchmarks"],[33600,0,"All "],[33604,1,""],[33604,0,"b"],[33614,0," are lies"],[33628,0," yes"],[33634,80,""],[33634,0,"very clever."],[33632,14,""],[33625,7,""],[33625,0,"Yes yes, very clever."],[33791,27,""],[33791,0," I'm not sorry  "],[33806,1,""],[33806,0,"- writing "],[33805,11,""],[33805,0,"."],[33799,0," even"],[33647,43,""],[33647,0,"\n### How do I run these benchmarks myself?\n"],[33799,5,""],[33805,1,""],[33805,0," - writing "],[33815,1,""],[33807,8,""],[33806,1,""],[33806,0," "],[33806,1,""],[33805,1,""],[33799,6,""],[33795,4,""],[33791,4,""],[33791,0," But its almost all online."],[33638,8,""],[33634,4,""],[33634,0,"I know. I've made a few sleights of hand which I want to 'fess up to and defend."],[33628,4,""],[33618,5,""],[33614,4,""],[33604,1,""],[33604,0,"B"],[33603,1,""],[33600,13,""],[33600,0,"Your benchmarks are weird / wrong / misleading"],[33600,46,""],[33600,0,"Benchmarks"],[33600,0,"All "],[33604,1,""],[33604,0,"b"],[33614,0," are lies"],[33628,0," yes"],[33634,80,""],[33634,0,"very clever."],[33791,27,""],[33791,0," I'm not sorry  "],[33806,1,""],[33806,0,"- writing "],[33805,11,""],[33805,0,"."],[33799,0," even"],[33647,43,""],[33600,23,""],[33600,0,"Your benchmarks are weird / wrong / misleading"],[33600,46,""],[33600,0,"We need to talk about ben"],[33600,25,""],[33600,0,"These benchmarks "],[33600,17,""],[33600,0,"B"],[33600,1,""],[33600,0,"These benchmarks "],[33616,1,""],[33605,11,""],[33600,5,""],[33600,0,"We need to talk about ben"],[33621,4,""],[33600,21,""],[33600,0,"Tge"],[33602,1,""],[33601,1,""],[33601,0,"hese bencmkar"],[33613,1,""],[33612,1,""],[33611,1,""],[33610,1,""],[33610,0,"h"],[33600,11,""],[33600,0,"Are the be"],[33609,1,""],[33609,0,"enchmarks"],[33603,15,""],[33603,0," these benchmarking"],[33621,1,""],[33620,1,""],[33619,1,""],[33619,0,"s for real?"],[33584,0,"\n"],[33636,18,""],[33636,0,"; though its"],[33645,3,""],[33645,0,"there's a few slippery sleights of hands "],[33685,1,""],[33684,1,""],[33684,0," doing"],[33689,1,""],[33688,1,""],[33687,1,""],[33686,1,""],[33685,1,""],[33685,0,"going on here."],[33636,8,""],[33636,0,"B"],[33636,1,""],[33636,0," "],[33636,1,""],[33636,0,". But"],[33641,8,""],[33641,0," there are a"],[33652,1,""],[33651,1,""],[33800,20,""],[33800,0," I'm not even sorry."],[33799,21,""],[33799,0," mess."],[34107,9,""],[34107,0,"josehpg/te"],[34107,10,""],[34107,0,"josephg/text-crdt-rust"],[34238,6,""],[34238,0,"Benchmakr"],[34246,1,""],[34245,1,""],[34245,0,"rk by running"],[34258,5,""],[34307,0,","],[34352,17,""],[34352,0,"T"],[34367,0," structure"],[34385,0," can be enabled or disabled"],[34416,11,""],[34480,0," also"],[34571,8,""],[34571,0,"."],[34573,45,""],[34652,0,". I've been running the benchmarks with that flag, c"],[34703,1,""],[34703,0,"then CT"],[34709,1,""],[34709,0,"c"],[34709,1,""],[34708,1,""],[34708,0,"ctl_"],[34711,1,""],[34710,1,""],[34710,0,"rl+C as"],[34716,1,""],[34715,1,""],[34714,1,""],[34713,1,""],[34712,1,""],[34711,1,""],[34708,3,""],[34708,0,"killing the benchmarks as soon as "],[34729,13,""],[34729,0," run as soon as numbers start coming out."],[34769,1,""],[34822,15,""],[34822,0,"josephg/crdt-benchmarks"],[34984,15,""],[34984,0,"my reference"],[34984,12,""],[34984,0,"josephg/reference-crdts"],[40800,0,"'"],[39603,0,"'"],[35983,0,"'"],[26041,0,"'"],[20874,0,"'"],[16160,0,"'"],[14164,0,"'"],[9304,0,"'"],[3265,0,"'"],[3985,1,""],[3985,0,"o"],[188,0,"\n\n"],[189,0,"<seph-foo />"],[199,1,""],[198,1,""],[199,0,"</seph-foo>"],[199,11,""],[198,0," /"],[198,2,""],[199,0,"</seph-foo>"],[199,0,"oh hai"],[216,0," -->"],[189,0,"<!-- "],[206,0,"dsfdsdf"],[206,7,""],[221,4,""],[189,5,""],[217,0,"\n"],[217,1,""],[195,3,""],[195,0,"time-btn"],[217,3,""],[217,0,"time-btn"],[203,0," timeM"],[208,1,""],[208,0,"Ms=1000"],[209,1,""],[208,1,""],[208,0,"-ms"],[208,3,""],[208,0,"ms"],[209,1,""],[208,1,""],[208,0,"Ms"],[208,0,"-"],[209,1,""],[209,0,"m"],[209,1,""],[209,0,"M"],[208,1,""],[209,1,""],[208,1,""],[204,4,""],[204,0,"ms"],[205,1,""],[205,0,"illisect"],[212,1,""],[212,0,"onds"],[244,0," -->"],[189,0,"<!-- "],[249,4,""],[189,5,""],[26592,0,"**"],[26624,0,"**"],[26626,4,""],[26668,0,"*"],[26655,0,"*"],[26669,0,"*"],[26656,0,"*"],[26672,4,""],[20202,0,"*"],[20199,0,"*"],[20203,0,"*"],[20200,0,"*"],[20206,4,""],[15128,0,"*"],[15095,0,"*"],[15129,0,"*"],[15096,0,"*"],[9662,0,"*"],[9636,0,"*"],[9663,0,"*"],[9637,0,"*"],[9394,0,"\n"],[9394,0,"\nI'm comparing it here to a baseline where all the edits are just applied directly to a javascript string."],[9499,0,", which should be the theori"],[9526,1,""],[9526,0,"etical "],[9499,34,""],[9460,7,""],[9460,0,"spliced "],[9467,1,""],[9477,0,"into "],[9482,3,""],[9395,3,""],[9395,0,"We can "],[9395,7,""],[9395,0,"As a baseline"],[9395,13,""],[9395,0,"To get a sense of how fast"],[9417,4,""],[9417,0,"inefficient that is, we can"],[9453,1,""],[9452,1,""],[9451,1,""],[9451,0,"e"],[9455,0," "],[9456,6,""],[9541,0," Splicing into a string directly can't "],[9542,38,""],[9542,0,"T"],[9542,1,""],[9541,1,""],[9540,1,""],[9540,0,". ("],[9542,1,""],[9541,1,""],[9453,3,""],[9453,0,"the "],[9453,4,""],[9453,0,"this "],[9471,0," benchmark"],[9552,1,""],[9552,0,"; which shoulw"],[9565,1,""],[9564,1,""],[9564,0,"ws"],[9565,1,""],[9564,1,""],[9563,1,""],[9563,0,"ws about how fast h"],[9581,1,""],[9581,0,"javascript"],[9559,32,""],[9559,0," gives us a se "],[9573,1,""],[9573,0,"se "],[9575,1,""],[9574,1,""],[9573,1,""],[9573,0,"nse of how fast javascript could go, if it wasn't loaded down with all our code."],[9653,128,""],[9653,0,"\n"],[9653,0," (Sp"],[9656,1,""],[9655,1,""],[9654,1,""],[9654,0,"And "],[9657,1,""],[9657,0,", javascript"],[9659,0,"raw "],[9673,0," is very fast."],[9659,14,""],[9659,0,"javascript runnign"],[9676,1,""],[9675,1,""],[9675,0,"ng on v8"],[9681,1,""],[9681,0,"V"],[20389,0," @ 13.5.5"],[20400,9,""],[20389,9,""],[20389,0," (v13.5.5)"],[20269,1,""],[20268,1,""],[20268,0,"(v"],[20284,0,")"],[20285,1,""],[20411,1,""],[26991,0,"\n\n"],[26992,0,"\n(I have no idea how to measure memory usage in "],[27024,16,""],[27024,0,"wasm memory usage. It should be the same as the native version)"],[27086,0,"."],[26992,96,""],[26991,1,""],[26990,1,""],[26990,0,". (!)"],[20127,1,""],[20127,0,". Its *300x faster than automerge*!"],[20161,1,""],[20160,0,"!"],[20162,0,"."],[27029,1,""],[27028,1,""],[27027,1,""],[27026,1,""],[27025,1,""],[27025,0,"!"],[27025,0," directly, and its doing way more "],[27050,9,""],[27050,0,"a whole lot of extra work to support c"],[27087,1,""],[27087,0,"collaborative editing too"],[26496,1,""],[26496,0,":"],[26496,1,""],[26496,0," "],[28659,1,""],[26496,1,""],[20229,1,""],[15149,1,""],[9756,1,""],[28655,0,":"],[26493,0,":"],[20227,0,":"],[15148,0,":"],[9756,0,":"],[29329,0,"*"],[29300,0,"*"],[29330,0,"*"],[29301,0,"*"],[29334,4,""],[29870,0,"\n\n"],[29871,0,"That academic paper made claims "],[29896,0,"benchmarking "],[29896,13,""],[29903,0,"about how "],[29891,22,""],[29891,0,"claimed to know how fast t"],[29916,1,""],[29916,0,"various CRDTs run, but its performance measuer"],[29961,1,""],[29960,1,""],[29960,0,"res were off by "],[29891,15,""],[29891,0,"m"],[29891,1,""],[29875,0," silly"],[29897,0,"I real"],[29902,1,""],[29902,0,"d all tohse "],[29913,1,""],[29912,1,""],[29911,1,""],[29910,1,""],[29909,1,""],[29909,0,"hose years ago made claims about"],[29929,0,"some bol"],[29929,8,""],[29968,1,""],[29968,0,". But"],[29973,4,""],[29989,22,""],[29989,0," numbers o"],[29998,1,""],[29998,0,"were "],[29969,0," And because its *published science* we "],[30006,3,""],[30005,1,""],[30005,0,", everyone believed the researchers."],[30004,1,""],[29986,1,""],[30073,0,"off by thou"],[30080,4,""],[30080,0,"3 orders of magnitude."],[30072,0,"n't just wrong. They were wrong by a factor"],[30115,30,""],[30107,8,""],[30107,0,"thousa"],[30112,1,""],[30111,1,""],[30111,0,"sands of times."],[30107,19,""],[30107,0,"several orders of magnitude."],[29970,43,""],[29970,0,"And we all"],[30005,0,", because "],[29974,6,""],[29974,0,"everyone"],[29924,17,""],[29924,0,"tried "],[29924,6,""],[29924,0,"told us all"],[30011,0,"it was published sciec"],[30032,1,""],[30032,0,"nce"],[30041,3,""],[30041,0,"the"],[30132,0," Who knows what the paper would have concluded if they "],[30133,54,""],[30132,1,""],[30132,0," It turns out, the paper wasn't written by gods."],[30132,1,""],[30132,0,"\n\n"],[29924,0,"claimed to "],[29935,4,""],[29935,0,"tell"],[29938,1,""],[29938,0,"l"],[30001,11,""],[30001,0,"paper"],[30108,29,""],[30108,0," sa"],[30110,1,""],[30109,1,""],[30109,0,"thousands of times."],[30129,0,"\nBut thats ok."],[30143,50,""],[30143,0," Actually "],[30156,0," sort of"],[30157,7,""],[30157,0,"weirdly"],[30314,14,""],[30314,0,"this whole thing made me learn something that "],[30339,21,""],[30339,0,"realise something that should have been obvious a"],[30387,1,""],[30387,0,"dea"],[30389,1,""],[30389,0,"cades ago. "],[30399,1,""],[30399,0," Scientists aren't gods. They're"],[30422,0,", sent from the heavens to bring Truth to mortals"],[30473,0,"No, "],[30477,1,""],[30477,0,"t"],[30511,0,"Great"],[30516,11,""],[29924,27,""],[29924,0,"proported to tell us all how "],[29924,9,""],[29924,0,"tried"],[30126,0," They were wrong like a billionare "],[30160,1,""],[30159,1,""],[30158,1,""],[30158,0,"ire guessing ab"],[30172,1,""],[30172,0," banana"],[30137,5,""],[30137,0,"as accurate as"],[30151,5,""],[30183,0," costs $1000."],[30137,0,"about "],[30207,0," you know?"],[30218,1,""],[30218,0,"T"],[30227,0," Thats human, and"],[30244,9,""],[30265,34,""],[30239,26,""],[30251,47,""],[30251,0,"feel sort of inadequate with academics - "],[30292,5,""],[30291,1,""],[30303,5,""],[30322,1,""],[30371,22,""],[30378,13,""],[30378,0,":"],[30425,1,""],[30424,1,""],[30424,0,"s with the gift of"],[30442,8,""],[30448,11,""],[30631,533,""],[42881,0,"\n\n\n\n\n\n\n\n---\n\n\n\nA decade ago Google Wave really needed a good quality list CRDT. So I got super excited when the papers for CRDTs started to emerge. [LOGOOT](https://hal.inria.fr/inria-00432368/document) and [WOOT](https://hal.inria.fr/inria-00445975/document) seemed like a big deal! But that excitement turned to ash when I realised the algorithms were too slow and inefficient to be practically useful. And I made a big mistake - I assumed if the academics couldn't make them fast, nobody could. I turned my back on academia and dismissed them.\n"],[30631,0,"\n"],[30631,0,"\nAnd its important to know that, because the best collaborations "],[30672,0,"sometimes "],[30706,0,"don't come from two chefs working together. They come"],[30706,53,""],[30706,0,"come from "],[30706,10,""],[30706,0,"lok"],[30708,1,""],[30708,0,"ok like Gilbert & Sullivan. M"],[30736,1,""],[30736,0,"O"],[30736,1,""],[30736,0,"The same love, and the same dream"],[30735,0," Or Jobs and Wozniak."],[30790,0," but different skill sets. Different perspectives headed toward the same goal."],[43134,532,""],[43133,1,""],[43132,1,""],[43131,1,""],[43130,1,""],[43129,1,""],[43128,1,""],[43127,1,""],[43126,1,""],[43125,1,""],[43124,1,""],[43123,1,""],[43122,1,""],[43121,1,""],[30635,4,""],[30635,0," thats"],[30659,5,""],[30703,0,"aren't between two "],[30718,4,""],[30718,0,"peers. Instead they "],[30826,0," tto"],[30829,1,""],[30828,1,""],[30828,0,"otally"],[30857,9,""],[30857,0,"Two "],[30857,4,""],[30857,0,"Many minds"],[30862,5,""],[30862,0,"different"],[30871,13,""],[30871,0," minds"],[30877,14,""],[30877,0," s"],[30872,7,""],[30872,0,"strengths fighting for"],[30909,0,"\n\nA decade ago Google Wave really needed a good quality list CRDT. So I got super excited when the papers for CRDTs started to emerge. [LOGOOT](https://hal.inria.fr/inria-00432368/document) and [WOOT](https://hal.inria.fr/inria-00445975/document) seemed like a big deal! But that excitement turned to ash when I realised the algorithms were too slow and inefficient to be practically useful. And I made a big mistake - I assumed if the academics couldn't make them fast, nobody could. I turned my back on academia and dismissed them.\n"],[31442,1,""],[30976,3,""],[31197,20,""],[31197,0,"died when I"],[31288,4,""],[31377,49,""],[31389,0," big"],[31455,0," - ( *"],[31460,1,""],[31459,1,""],[31459,0,"I *H"],[31462,1,""],[31462,0,"hate* reading them) "],[31481,1,""],[31459,0,"to my eternal shame "],[31501,1,""],[31501,0,"."],[31503,3,""],[31503,0,"But"],[31458,1,""],[31458,0,"I haven't written any and "],[31484,42,""],[31484,0,"I'll do almost anything to avoid reading them"],[31576,5,""],[31576,0,"H"],[31455,74,""],[31502,0,"And "],[31506,1,""],[31506,0,"h"],[31763,1,""],[31762,1,""],[31762,0,"s."],[31763,1,""],[31763,0,"!"],[30202,0," It"],[30204,1,""],[30203,1,""],[30202,1,""],[30126,0," It turns out we cah"],[30145,1,""],[30145,0,"n make fast CRDTs."],[30152,5,""],[30157,0," which a"],[30158,7,""],[30157,1,""],[30152,0,"small and fast "],[30172,0,", if we're willing to be a bit clever about it"],[30220,4,""],[30220,0,"And that ma"],[30230,1,""],[30230,0,"eaks"],[30233,1,""],[30232,1,""],[30232,0,"ns that aca"],[30220,23,""],[30220,0,"That"],[30151,15,""],[30157,0," as f"],[30158,4,""],[30158,0,"work almost as fast as a string"],[30181,2,""],[30181,0,"editing a "],[30197,1,""],[30197,0,"."],[30199,46,""],[30199,0,"So that paper "],[30213,10,""],[30213,0,"was "],[30126,73,""],[30039,0," It turns out we can make CRDTs work almost as fast as editing a string. "],[30040,0,"But "],[30044,1,""],[30044,0,"i"],[30075,39,""],[30075,0,"fast. We can make them crazy fast - lik"],[30111,3,""],[30111,0,"about"],[30108,8,""],[30108,0,". We can make them about as fast as native string operations"],[30170,4,""],[30170,0,"So"],[30196,0," in that paper"],[30231,38,""],[30231,0,"They were"],[30240,17,""],[30250,8,""],[30250,0,"wrong"],[30317,0," what"],[30567,0," people"],[30683,5,""],[30683,0," pretty well"],[30695,7,""],[30743,0," "],[30743,1,""],[30743,0," And thats ok."],[30756,1,""],[30756,0,", no matter what "],[30756,17,""],[30756,0,"."],[30759,36,""],[30759,0,"And"],[30949,0," brought together brought together to achieve something none of us could achieve on our own"],[31005,4,""],[31005,0,"no one"],[31043,53,""],[31422,0," And in that moment"],[31532,24,""],[31532,0,"But, even though "],[31550,0,"'m"],[31552,9,""],[31562,16,""],[31562,0,"at"],[31580,1,""],[31580,0,","],[31582,4,""],[31887,334,""],[31886,1,""],[32922,3,""],[32922,0,"And now"],[33020,4,""],[31650,46,""],[31650,0,"I left the researchers to it."],[31535,1,""],[31651,0,"didn't try "],[31648,0," with a task I really wanted,"],[31690,0," to help."],[31699,28,""],[31686,0," even"],[31649,29,""],[31625,0," yet"],[31862,0," Collaborative editing needed a collaboration."],[31907,0," between all of us"],[31927,5,""],[31926,1,""],[31863,0,"Oops! It turned out "],[31883,1,""],[31883,0,"c"],[31912,0,"to e "],[31916,1,""],[31915,1,""],[31915,0,"be "],[31953,458,""],[30021,1,""],[30021,0,"P"],[30031,1,""],[30031,0,"S"],[30056,0," the a"],[30061,1,""],[30061,0,"paer"],[30064,1,""],[30063,1,""],[30063,0,"per was wrong."],[30078,1,""],[30078,0,"W"],[30119,0,"*"],[30130,0,"*"],[30150,41,""],[30150,0,"run so fast you'd think you were using native strings"],[30205,4,""],[30205,0,"T"],[30355,0," I'm sort of "],[30357,11,""],[30357,0," sort of appreciate that paper now."],[30392,6,""],[30392,0," Its"],[30393,3,""],[30393,0,"Their mistake is"],[30414,5,""],[30414,0,"Its"],[30418,0,"*"],[30424,0,"*"],[30828,0,"despite what I've been told, "],[30841,14,""],[30836,5,""],[30836,0,"some"],[30836,4,""],[30836,0,"what some people think"],[30853,0,"seem to "],[30841,0,"*"],[30853,0,"*"],[30881,286,""],[31367,0,"\nAnd sometimes the best collaborations aren't between peers. Instead they look like Gilbert & Sullivan. Or Jobs and Wozniak. The same love, and the same dream but totally different skill sets brought together brought together to achieve something no one of us could achieve on our own.\n\n"],[31653,1,""],[31368,0,"But the truth is"],[31384,3,""],[31403,0," work needs a"],[31430,1,""],[31430,0,". And those collaborations can work best when they"],[31503,14,""],[31503,0,"L"],[31507,5,""],[31507,0," al"],[31509,1,""],[31509,0,"t"],[31529,0," - one guy did the music, the other the lyrics"],[31596,0," - on "],[31601,1,""],[31601,0,"e guy was the storyteller, the other the engineer"],[31652,0,"They shared"],[31663,3,""],[31663,0," "],[31664,19,""],[31664,0,"a"],[31665,5,""],[31676,0,"needed "],[31683,8,""],[31703,0," to be"],[31726,17,""],[31737,49,""],[31737,0," it. Together they made something no no"],[31775,1,""],[31774,1,""],[31774,0,"one of them could make along"],[31801,1,""],[31801,0,"e."],[31805,5,""],[31805,0,"E"],[31891,7,""],[31891,0,"But"],[31891,3,""],[31891,0,"And yet"],[32221,0," Who could have guessed!"],[32656,0,"faster and "],[32773,4,""],[32773,0,"us"],[32773,2,""],[32773,0,"them"],[32873,0," finally "],[32881,1,""],[30081,0,"*"],[30085,0,"*"],[29941,12,""],[29941,0,"that lots of"],[29953,8,""],[29959,0," are pretty slow"],[29975,4,""],[30279,9,""],[30284,0," like"],[30289,3,""],[30279,12,""],[30278,1,""],[30278,0," a"],[30322,0," kind of wrong"],[30650,0,"*"],[30657,0,"*. They're"],[30859,7,""],[30859,0," people"],[31524,0,"["],[31543,0,"](https://en.wikipedia.org/wiki/Gilbert_and_Sullivan)"],[31669,12,""],[31730,0," that dream"],[31772,34,""],[31772,0,"b"],[31772,1,""],[31772,0," be achieved"],[32225,5,""],[32224,1,""],[9472,9,""],[9471,1,""],[9478,0,"instea "],[9484,1,""],[9484,0,"d of stro"],[9492,1,""],[9491,1,""],[9491,0,"oring information "],[9497,12,""],[9497,0,"all the exta"],[9508,1,""],[9508,0,"ra information to make collaborative editing work, we just"],[9566,22,""],[9573,1,""],[9572,1,""],[9572,0,"e all the content"],[9623,0,"."],[9624,1,""],[9417,11,""],[9417,0,"much overhead there"],[9436,5,""],[9481,80,""],[9480,1,""],[9546,0," This obviu"],[9556,1,""],[9556,0,"ously won'"],[9565,1,""],[9564,1,""],[9564,0,"uldn't"],[9552,18,""],[9552,0,"throws away all the infroma"],[9578,1,""],[9577,1,""],[9576,1,""],[9575,1,""],[9575,0,"ormation we need for a"],[9596,1,""],[9596,0,"collaborait"],[9606,1,""],[9605,1,""],[9604,1,""],[9604,0,"ative editing, but it"],[9625,6,""],[9572,0,"extra "],[9598,3,""],[9598,0,"to make"],[9627,0," work"],[9681,5,""],[9681,0,"can"],[9687,44,""],[9689,6,""],[9689,0,"J"],[9726,1,""],[9726,0,":"],[9466,0,"["],[9475,0,"](https://gist.github.com/josephg/13efc1444660c07870fcbd0b3e917638#file-js_baseline-js-L37-L41)"],[9475,0," benchmark"],[9475,10,""],[9569,1,""],[9477,92,""],[9475,2,""],[9466,1,""],[9571,6,""],[9683,0,"It turns out "],[9696,1,""],[9696,0,"j"],[9723,5,""],[9724,0,"*"],[9729,0,"*"],[15247,26,""],[15247,0,"automerge (v1.0.0-preview2)"],[9849,26,""],[9849,0,"automerge (v1.0.0-preview2)"],[15276,1,""],[9877,1,""],[10870,86,""],[10870,0,"I"],[10870,59,""],[10869,1,""],[10868,1,""],[10868,0,", and the code"],[10868,1,""],[10868,0,"."],[10751,0,"["],[10751,1,""],[10763,0,"["],[10800,0,"](https://github.com/automerge/automerge-rs/)"],[10916,12,""],[10916,0,"On this test the code"],[10933,4,""],[10933,0,"rust code performs l"],[10952,1,""],[10952,0,"almost "],[10665,294,""],[10665,0,"Automerge was just never written with performance in mind. Their team is working on a replacement [rust implementation of the algorithm](https://github.com/automerge/automerge-rs/) to run through wasm, but at the time of writing it hasn't landed yet. On this test the rust code performs almost"],[9877,0,"*"],[10944,15,""],[10944,0,"is br"],[10948,1,""],[10948,0,"arely faster than the javascript."],[10946,0," only"],[10975,0,"equivalent "],[10975,11,""],[10916,70,""],[10916,0," I got the master branch working, but they obviously have some kinks to work out - its barely faster than"],[10999,0,"on this test "],[11034,0," the javascript equiva"],[11055,1,""],[11054,1,""],[11035,19,""],[11035,0,"automerge's javascript code."],[11064,0,"]"],[11064,1,""],[11064,0,"\n\n"],[11065,0,"---"],[11614,6,""],[11613,1,""],[11616,5,""],[11616,0,"B"],[30001,35,""],[30001,0,"said CRDTs and OT algorithms"],[30033,7,""],[30001,4,""],[30001,0,"says"],[30110,13,""],[30218,27,""],[30218,0,"we can compete with the performance of "],[30341,0,"\""],[30385,0,"\""],[30341,1,""],[30341,0,"*"],[30385,1,""],[30385,0,"*"],[30385,1,""],[30385,0,"\""],[30341,1,""],[30341,0,"\""],[30356,8,""],[30356,0,"guesses"],[30356,7,""],[30356,0,"guessing"],[30508,8,""],[30519,4,""],[30519,0,"around"],[30718,7,""],[30718,0,"And in that regard, they're"],[30932,27,""],[30927,5,""],[30927,0,"being sometimes laughed at"],[30954,0," "],[30954,1,""],[30953,1,""],[30953,0,","],[30943,0,"rudely "],[30943,7,""],[31348,14,""],[31347,1,""],[31527,3,""],[31527,0,"sometimes"],[31660,0,"(t"],[31661,1,""],[31661,0,"they're famous for"],[31661,18,""],[31661,0,"they made a bunch of famous musicals). "],[31700,3,""],[31700,0,"O"],[31700,0,"But they w"],[31709,1,""],[31700,9,""],[31708,3,""],[31708,0,"wrote"],[31665,8,""],[31665,0," wrote a "],[31921,12,""],[31921,0,"body"],[31932,4,""],[31932,0,"do"],[32354,23,""],[32354,0,"Ironic!"],[32354,7,""],[32354,0,"Who could have guessed!"],[32354,0,"How ironic! "],[32388,1,""],[32388,0,"?!"],[244,0," -->"],[188,0,"<!-- "],[249,4,""],[188,62,""],[378,4,""],[377,1,""],[803,1,""],[22542,3,""],[22572,10,""],[22572,0," to human scale"],[22635,0,"we can imagine "],[22530,5,""],[22530,0,"The numbers s"],[22542,1,""],[22542,0,"are t"],[22546,1,""],[22530,16,""],[22529,1,""],[22531,38,""],[22531,0,"At a"],[22594,1,""],[22593,1,""],[22593,0," "],[22594,15,""],[22613,5,""],[22613,0,"might"],[22641,0,"."],[22612,17,""],[22612,0," takes"],[22631,0," And"],[22635,49,""],[22635,0," every"],[22640,1,""],[22639,1,""],[22638,1,""],[22637,1,""],[22636,1,""],[22636,0,"a "],[22660,23,""],[22660,0,"takes"],[22671,0,"r"],[22671,1,""],[22685,0," T"],[22686,1,""],[22686,0,"It "],[22688,1,""],[22688,0,"s the difference between a single heart beat, and the time taken to brush your teeth."],[27782,9,""],[29652,0," They should add"],[29653,15,""],[29653,0,"The bottom two rows should add up to our rust performance - but"],[29720,3,""],[29720,0,"+"],[29725,15,""],[29725,0,"iss "],[29728,1,""],[29727,1,""],[29727,0," less than"],[29652,0," The rust impleem"],[29668,1,""],[29667,1,""],[29667,0,"menet"],[29671,1,""],[29670,1,""],[29670,0,"tation "],[29653,24,""],[29652,1,""],[29591,0," a lot"],[29674,4,""],[29674,0,"entries"],[29659,22,""],[29659,0,"The rust performance (65ms) is the "],[29687,7,""],[29687,0,"should be the sum of the time spent in ropey (29ms) + the time spent in "],[29756,3,""],[29756,0,"updat "],[29761,1,""],[29761,0,"ing my b-tree (23ms). But its not"],[29794,69,""],[29794,0,"."],[29796,0,"The difference is probably caused by"],[29832,13,""],[29832,0," "],[29856,43,""],[29856,0," or something"],[29920,4,""],[29920,0,"my per"],[29925,1,""],[29924,1,""],[29923,1,""],[29922,1,""],[29927,0," performance all the way"],[29871,0,"It "],[29874,1,""],[29874,0,"l"],[29871,0,"If I'm writ"],[29881,1,""],[29880,1,""],[29879,1,""],[29878,1,""],[29878,0,"right "],[29884,13,""],[29883,1,""],[29435,0," Remember, these perfora"],[29458,1,""],[29458,0,"mance t"],[29464,1,""],[29464,0,"numbers describe how much time it take s"],[29503,1,""],[29502,1,""],[29502,0,"s to process 27"],[29516,1,""],[29516,0,"60 000 operations. S"],[29535,1,""],[29534,1,""],[29515,0,"a "],[29516,1,""],[29515,1,""],[29533,0," from a single user"],[29553,0," "],[29533,19,""],[29515,0,"an editing trace of "],[29436,120,""],[29435,0," We're processing 260 000 operations in 23ms, or "],[29483,1,""],[29481,2,""],[29481,0,"which is"],[29512,1,""],[29512,0,"per"],[29543,0," home"],[29574,4,""],[29574,0,"edits"],[29583,5,""],[29580,3,""],[29580,0,"I'd still ahve"],[29593,1,""],[29592,1,""],[29591,1,""],[29590,1,""],[29590,0,"have"],[29731,0,"full "],[29753,0," "],[29753,1,""],[29753,0,"benchmark "],[29866,11,""],[29866,0,"But those numbers don't addu "],[29894,1,""],[29893,1,""],[29893,0," up!"],[29897,1,""],[29958,13,""],[29972,0,","],[29934,14,""],[29944,0," thrashing, because all the up"],[29972,2,""],[29972,0,"b-tree updates are interleaved"],[29954,48,""],[22960,12,""],[22960,0," a"],[22977,1,""],[22958,2,""],[22958,0,"first requires"],[22939,4,""],[22939,0,"figuring out your"],[23004,37,""],[23004,0,"You just have a list of places"],[23034,11,""],[23034,0," "],[23048,0," - \"Under the couch\", \"On top of the r"],[23085,1,""],[23085,0,"fridge\", and so on."],[23104,1,""],[23105,96,""],[23105,0,"And you have to "],[23105,16,""],[23105,0,"On top of your fridge is a little note saying you need toothpaste."],[23144,6,""],[23144,0,"mentioning"],[23158,0," actually"],[23209,0," through your"],[23202,20,""],[23202,0,"its going to take you a long time to"],[23238,46,""],[23238,0," "],[23238,1,""],[23238,0," go "],[23239,3,""],[23239,0,"figure out what to uy"],[23259,1,""],[23258,1,""],[23258,0,"buy."],[22939,38,""],[22939,0,"your shopping list "],[22958,8,""],[22958,0,"describes"],[22958,9,""],[22958,0,"invol"],[22958,5,""],[22958,0,"is"],[22534,1,""],[22533,1,""],[22684,3,""],[22684,0,"This is"],[22723,11,""],[22723,0," beat of your heart"],[22756,0," it takes"],[22765,6,""],[22724,0,"heart"],[22733,14,""],[22962,2,""],[22962,0,"actually"],[22962,0,"is "],[22965,8,""],[22964,1,""],[22964,0," actually"],[22990,48,""],[22990,0,":"],[23046,14,""],[23046,0,"Under the couch "],[23062,8,""],[23093,9,""],[23128,59,""],[23128,0,"going to tho"],[23139,1,""],[23139,0,"e "],[23128,13,""],[23128,0,"doing the grocery shopping will be a chore."],[23170,1,""],[23128,5,""],[23128,0,"this makes doing "],[23144,1,""],[23166,8,""],[22871,7,""],[22871,0,"would be like"],[22953,9,""],[23163,7,""],[23163,0,"a laot of "],[23172,1,""],[23171,1,""],[23170,1,""],[23169,1,""],[23168,1,""],[23167,1,""],[23166,1,""],[23166,0,"ot of work"],[23177,0," We "],[23180,1,""],[23179,1,""],[23178,1,""],[23177,1,""],[23177,0," "],[23177,1,""],[23177,0," We can fix this"],[22908,1,""],[22908,0,". But"],[22914,5,""],[23177,15,""],[23176,1,""],[23308,0," (So when I pick up my grocery list, it has all the information I need)."],[23381,22,""],[23381,0,"L"],[23397,3,""],[23427,0," for this reason"],[23432,11,""],[23432,0,"exactly this reason"],[23451,15,""],[23637,1,""],[23637,0," "],[23634,16,""],[23634,0,"h"],[23634,1,""],[23634,0,"things other than text editing"],[23664,6,""],[23679,2,""],[23679,0,"the progrm"],[23688,1,""],[23688,0,"am"],[23313,18,""],[23313,0,"a single read of my "],[23345,0," tells me"],[23354,8,""],[23381,0," to know"],[23609,4,""],[23609,0,"And "],[23607,0,", which in yjs has linear performance"],[23626,0,"a "],[23646,0," cost"],[23653,0,"This doesn't happe "],[23671,1,""],[23671,0,"n num"],[23675,1,""],[23674,1,""],[23673,1,""],[23673,0,"much in a text docu"],[23678,14,""],[23678,0,"when text editing, but "],[23701,4,""],[23728,35,""],[23728,0," in other cases too"],[23784,2,""],[23784,0,"need"],[23346,5,""],[23346,0,"would con"],[23352,3,""],[23352,0,"tell us"],[23359,25,""],[23357,2,""],[23357,0,"me"],[23358,1,""],[23357,1,""],[23357,0,"us everything we"],[38705,5,""],[39950,9,""],[39966,0," "],[39966,1,""],[39950,0,"database using "],[31793,20,""],[31792,1,""],[31792,0,"'re be"],[31797,1,""],[31796,1,""],[31795,1,""],[31794,1,""],[31793,1,""],[31792,1,""],[31792,0," involve people with different skillsets"],[31831,1,""],[31830,1,""],[31829,1,""],[32452,8,""],[32452,0,"maybe we would"],[5329,258,""],[5328,0,"\n\nMartin explains i"],[5330,17,""],[5330,0,"Martin explains Automerge"],[5346,1,""],[5346,0,"a"],[5355,0," far better than I will in this talk:\n\n<iframe width=\"560\" height=\"315\" src=\"https://www.youtube-nocookie.com/embed/x7drE24geUw?start=1237\" title=\"YouTube video player\" frameborder=\"0\" allow=\"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture\" allowfullscreen></iframe>"],[5374,0,"v"],[5374,1,""],[5374,0,"ev"],[5375,1,""],[5374,1,""],[5391,0," from 2020"],[5891,1,""],[5891,0,"\n\nImagine I"],[5902,7,""],[5913,1,""],[5913,0,"."],[5913,1,""],[5913,0," into an empty document."],[5939,0,"A"],[5939,1,""],[5938,1,""],[5938,0,"A"],[6135,15,""],[6135,0,"<img src=\"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB2ZXJzaW9uPSIxLjEiIHdpZHRoPSIxOTFweCIgaGVpZ2h0PSIxNjFweCIgdmlld0JveD0iLTAuNSAtMC41IDE5MSAxNjEiPjxkZWZzLz48Zz48cGF0aCBkPSJNIDUwIDYwIEwgMjAgNjAgTCAyMCA0Ni4zNyIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjMjQyNDI0IiBzdHJva2UtbWl0ZXJsaW1pdD0iMTAiIHBvaW50ZXItZXZlbnRzPSJzdHJva2UiLz48cGF0aCBkPSJNIDIwIDQxLjEyIEwgMjMuNSA0OC4xMiBMIDIwIDQ2LjM3IEwgMTYuNSA0OC4xMiBaIiBmaWxsPSIjMjQyNDI0IiBzdHJva2U9IiMyNDI0MjQiIHN0cm9rZS1taXRlcmxpbWl0PSIxMCIgcG9pbnRlci1ldmVudHM9ImFsbCIvPjxyZWN0IHg9IjUwIiB5PSI0MCIgd2lkdGg9IjQwIiBoZWlnaHQ9IjQwIiBmaWxsPSIjZmZmZmZmIiBzdHJva2U9IiMwMDAwMDAiIHBvaW50ZXItZXZlbnRzPSJhbGwiLz48ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgtMC41IC0wLjUpIj48c3dpdGNoPjxmb3JlaWduT2JqZWN0IHN0eWxlPSJvdmVyZmxvdzogdmlzaWJsZTsgdGV4dC1hbGlnbjogbGVmdDsiIHBvaW50ZXItZXZlbnRzPSJub25lIiB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiByZXF1aXJlZEZlYXR1cmVzPSJodHRwOi8vd3d3LnczLm9yZy9UUi9TVkcxMS9mZWF0dXJlI0V4dGVuc2liaWxpdHkiPjxkaXYgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGh0bWwiIHN0eWxlPSJkaXNwbGF5OiBmbGV4OyBhbGlnbi1pdGVtczogdW5zYWZlIGNlbnRlcjsganVzdGlmeS1jb250ZW50OiB1bnNhZmUgY2VudGVyOyB3aWR0aDogMzhweDsgaGVpZ2h0OiAxcHg7IHBhZGRpbmctdG9wOiA2MHB4OyBtYXJnaW4tbGVmdDogNTFweDsiPjxkaXYgc3R5bGU9ImJveC1zaXppbmc6IGJvcmRlci1ib3g7IGZvbnQtc2l6ZTogMDsgdGV4dC1hbGlnbjogY2VudGVyOyAiPjxkaXYgc3R5bGU9ImRpc3BsYXk6IGlubGluZS1ibG9jazsgZm9udC1zaXplOiAxMnB4OyBmb250LWZhbWlseTogSGVsdmV0aWNhOyBjb2xvcjogIzAwMDAwMDsgbGluZS1oZWlnaHQ6IDEuMjsgcG9pbnRlci1ldmVudHM6IGFsbDsgd2hpdGUtc3BhY2U6IG5vcm1hbDsgd29yZC13cmFwOiBub3JtYWw7ICI+YTwvZGl2PjwvZGl2PjwvZGl2PjwvZm9yZWlnbk9iamVjdD48dGV4dCB4PSI3MCIgeT0iNjQiIGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJIZWx2ZXRpY2EiIGZvbnQtc2l6ZT0iMTJweCIgdGV4dC1hbmNob3I9Im1pZGRsZSI+YTwvdGV4dD48L3N3aXRjaD48L2c+PHBhdGggZD0iTSAxMDAgMTAwIEwgNzAgMTAwIEwgNzAgODYuMzciIGZpbGw9Im5vbmUiIHN0cm9rZT0iIzI0MjQyNCIgc3Ryb2tlLW1pdGVybGltaXQ9IjEwIiBwb2ludGVyLWV2ZW50cz0ic3Ryb2tlIi8+PHBhdGggZD0iTSA3MCA4MS4xMiBMIDczLjUgODguMTIgTCA3MCA4Ni4zNyBMIDY2LjUgODguMTIgWiIgZmlsbD0iIzI0MjQyNCIgc3Ryb2tlPSIjMjQyNDI0IiBzdHJva2UtbWl0ZXJsaW1pdD0iMTAiIHBvaW50ZXItZXZlbnRzPSJhbGwiLz48cmVjdCB4PSIxMDAiIHk9IjgwIiB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIGZpbGw9IiNmZmZmZmYiIHN0cm9rZT0ibm9uZSIgcG9pbnRlci1ldmVudHM9ImFsbCIvPjxnIHRyYW5zZm9ybT0idHJhbnNsYXRlKC0wLjUgLTAuNSkiPjxzd2l0Y2g+PGZvcmVpZ25PYmplY3Qgc3R5bGU9Im92ZXJmbG93OiB2aXNpYmxlOyB0ZXh0LWFsaWduOiBsZWZ0OyIgcG9pbnRlci1ldmVudHM9Im5vbmUiIHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIHJlcXVpcmVkRmVhdHVyZXM9Imh0dHA6Ly93d3cudzMub3JnL1RSL1NWRzExL2ZlYXR1cmUjRXh0ZW5zaWJpbGl0eSI+PGRpdiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94aHRtbCIgc3R5bGU9ImRpc3BsYXk6IGZsZXg7IGFsaWduLWl0ZW1zOiB1bnNhZmUgY2VudGVyOyBqdXN0aWZ5LWNvbnRlbnQ6IHVuc2FmZSBjZW50ZXI7IHdpZHRoOiAzOHB4OyBoZWlnaHQ6IDFweDsgcGFkZGluZy10b3A6IDEwMHB4OyBtYXJnaW4tbGVmdDogMTAxcHg7Ij48ZGl2IHN0eWxlPSJib3gtc2l6aW5nOiBib3JkZXItYm94OyBmb250LXNpemU6IDA7IHRleHQtYWxpZ246IGNlbnRlcjsgIj48ZGl2IHN0eWxlPSJkaXNwbGF5OiBpbmxpbmUtYmxvY2s7IGZvbnQtc2l6ZTogMTJweDsgZm9udC1mYW1pbHk6IEhlbHZldGljYTsgY29sb3I6ICMwMDAwMDA7IGxpbmUtaGVpZ2h0OiAxLjI7IHBvaW50ZXItZXZlbnRzOiBhbGw7IHdoaXRlLXNwYWNlOiBub3JtYWw7IHdvcmQtd3JhcDogbm9ybWFsOyAiPmI8L2Rpdj48L2Rpdj48L2Rpdj48L2ZvcmVpZ25PYmplY3Q+PHRleHQgeD0iMTIwIiB5PSIxMDQiIGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJIZWx2ZXRpY2EiIGZvbnQtc2l6ZT0iMTJweCIgdGV4dC1hbmNob3I9Im1pZGRsZSI+YjwvdGV4dD48L3N3aXRjaD48L2c+PHBhdGggZD0iTSAxNTAgMTQwIEwgMTIwIDE0MCBMIDEyMCAxMjYuMzciIGZpbGw9Im5vbmUiIHN0cm9rZT0iIzI0MjQyNCIgc3Ryb2tlLW1pdGVybGltaXQ9IjEwIiBwb2ludGVyLWV2ZW50cz0ic3Ryb2tlIi8+PHBhdGggZD0iTSAxMjAgMTIxLjEyIEwgMTIzLjUgMTI4LjEyIEwgMTIwIDEyNi4zNyBMIDExNi41IDEyOC4xMiBaIiBmaWxsPSIjMjQyNDI0IiBzdHJva2U9IiMyNDI0MjQiIHN0cm9rZS1taXRlcmxpbWl0PSIxMCIgcG9pbnRlci1ldmVudHM9ImFsbCIvPjxyZWN0IHg9IjE1MCIgeT0iMTIwIiB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIGZpbGw9IiNmZmZmZmYiIHN0cm9rZT0ibm9uZSIgcG9pbnRlci1ldmVudHM9ImFsbCIvPjxnIHRyYW5zZm9ybT0idHJhbnNsYXRlKC0wLjUgLTAuNSkiPjxzd2l0Y2g+PGZvcmVpZ25PYmplY3Qgc3R5bGU9Im92ZXJmbG93OiB2aXNpYmxlOyB0ZXh0LWFsaWduOiBsZWZ0OyIgcG9pbnRlci1ldmVudHM9Im5vbmUiIHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIHJlcXVpcmVkRmVhdHVyZXM9Imh0dHA6Ly93d3cudzMub3JnL1RSL1NWRzExL2ZlYXR1cmUjRXh0ZW5zaWJpbGl0eSI+PGRpdiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94aHRtbCIgc3R5bGU9ImRpc3BsYXk6IGZsZXg7IGFsaWduLWl0ZW1zOiB1bnNhZmUgY2VudGVyOyBqdXN0aWZ5LWNvbnRlbnQ6IHVuc2FmZSBjZW50ZXI7IHdpZHRoOiAzOHB4OyBoZWlnaHQ6IDFweDsgcGFkZGluZy10b3A6IDE0MHB4OyBtYXJnaW4tbGVmdDogMTUxcHg7Ij48ZGl2IHN0eWxlPSJib3gtc2l6aW5nOiBib3JkZXItYm94OyBmb250LXNpemU6IDA7IHRleHQtYWxpZ246IGNlbnRlcjsgIj48ZGl2IHN0eWxlPSJkaXNwbGF5OiBpbmxpbmUtYmxvY2s7IGZvbnQtc2l6ZTogMTJweDsgZm9udC1mYW1pbHk6IEhlbHZldGljYTsgY29sb3I6ICMwMDAwMDA7IGxpbmUtaGVpZ2h0OiAxLjI7IHBvaW50ZXItZXZlbnRzOiBhbGw7IHdoaXRlLXNwYWNlOiBub3JtYWw7IHdvcmQtd3JhcDogbm9ybWFsOyAiPmM8L2Rpdj48L2Rpdj48L2Rpdj48L2ZvcmVpZ25PYmplY3Q+PHRleHQgeD0iMTcwIiB5PSIxNDQiIGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJIZWx2ZXRpY2EiIGZvbnQtc2l6ZT0iMTJweCIgdGV4dC1hbmNob3I9Im1pZGRsZSI+YzwvdGV4dD48L3N3aXRjaD48L2c+PHJlY3QgeD0iMCIgeT0iMCIgd2lkdGg9IjQwIiBoZWlnaHQ9IjQwIiBmaWxsPSIjZmZmZmZmIiBzdHJva2U9IiMwMDAwMDAiIHBvaW50ZXItZXZlbnRzPSJhbGwiLz48ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgtMC41IC0wLjUpIj48c3dpdGNoPjxmb3JlaWduT2JqZWN0IHN0eWxlPSJvdmVyZmxvdzogdmlzaWJsZTsgdGV4dC1hbGlnbjogbGVmdDsiIHBvaW50ZXItZXZlbnRzPSJub25lIiB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiByZXF1aXJlZEZlYXR1cmVzPSJodHRwOi8vd3d3LnczLm9yZy9UUi9TVkcxMS9mZWF0dXJlI0V4dGVuc2liaWxpdHkiPjxkaXYgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGh0bWwiIHN0eWxlPSJkaXNwbGF5OiBmbGV4OyBhbGlnbi1pdGVtczogdW5zYWZlIGNlbnRlcjsganVzdGlmeS1jb250ZW50OiB1bnNhZmUgY2VudGVyOyB3aWR0aDogMzhweDsgaGVpZ2h0OiAxcHg7IHBhZGRpbmctdG9wOiAyMHB4OyBtYXJnaW4tbGVmdDogMXB4OyI+PGRpdiBzdHlsZT0iYm94LXNpemluZzogYm9yZGVyLWJveDsgZm9udC1zaXplOiAwOyB0ZXh0LWFsaWduOiBjZW50ZXI7ICI+PGRpdiBzdHlsZT0iZGlzcGxheTogaW5saW5lLWJsb2NrOyBmb250LXNpemU6IDEycHg7IGZvbnQtZmFtaWx5OiBIZWx2ZXRpY2E7IGNvbG9yOiAjMDAwMDAwOyBsaW5lLWhlaWdodDogMS4yOyBwb2ludGVyLWV2ZW50czogYWxsOyBmb250LXN0eWxlOiBpdGFsaWM7IHdoaXRlLXNwYWNlOiBub3JtYWw7IHdvcmQtd3JhcDogbm9ybWFsOyAiPihyb290KTwvZGl2PjwvZGl2PjwvZGl2PjwvZm9yZWlnbk9iamVjdD48dGV4dCB4PSIyMCIgeT0iMjQiIGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJIZWx2ZXRpY2EiIGZvbnQtc2l6ZT0iMTJweCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1zdHlsZT0iaXRhbGljIj4ocm9vdCk8L3RleHQ+PC9zd2l0Y2g+PC9nPjwvZz48c3dpdGNoPjxnIHJlcXVpcmVkRmVhdHVyZXM9Imh0dHA6Ly93d3cudzMub3JnL1RSL1NWRzExL2ZlYXR1cmUjRXh0ZW5zaWJpbGl0eSIvPjxhIHRyYW5zZm9ybT0idHJhbnNsYXRlKDAsLTUpIiB4bGluazpocmVmPSJodHRwczovL3d3dy5kaWFncmFtcy5uZXQvZG9jL2ZhcS9zdmctZXhwb3J0LXRleHQtcHJvYmxlbXMiIHRhcmdldD0iX2JsYW5rIj48dGV4dCB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LXNpemU9IjEwcHgiIHg9IjUwJSIgeT0iMTAwJSI+Vmlld2VyIGRvZXMgbm90IHN1cHBvcnQgZnVsbCBTVkcgMS4xPC90ZXh0PjwvYT48L3N3aXRjaD48L3N2Zz4=\" />\n"],[6135,6616,""],[6135,0,"<svg xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" version=\"1.1\" width=\"192px\" viewBox=\"-0.5 -0.5 192 162\" style=\"max-width:100%;max-height:162px;\"><defs/><g><path d=\"M 51 61 L 21 61 L 21 47.37\" fill=\"none\" stroke=\"#242424\" stroke-miterlimit=\"10\" pointer-events=\"stroke\"/><path d=\"M 21 42.12 L 24.5 49.12 L 21 47.37 L 17.5 49.12 Z\" fill=\"#242424\" stroke=\"#242424\" stroke-miterlimit=\"10\" pointer-events=\"all\"/><rect x=\"51\" y=\"41\" width=\"40\" height=\"40\" fill=\"#ffffff\" stroke=\"#808080\" stroke-width=\"2\" pointer-events=\"all\"/><g transform=\"translate(-0.5 -0.5)\"><switch><foreignObject style=\"overflow: visible; text-align: left;\" pointer-events=\"none\" width=\"100%\" height=\"100%\" requiredFeatures=\"http://www.w3.org/TR/SVG11/feature#Extensibility\"><div xmlns=\"http://www.w3.org/1999/xhtml\" style=\"display: flex; align-items: unsafe center; justify-content: unsafe center; width: 38px; height: 1px; padding-top: 61px; margin-left: 52px;\"><div style=\"box-sizing: border-box; font-size: 0; text-align: center; \"><div style=\"display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; \">a</div></div></div></foreignObject><text x=\"71\" y=\"65\" fill=\"#000000\" font-family=\"Helvetica\" font-size=\"12px\" text-anchor=\"middle\">a</text></switch></g><path d=\"M 101 101 L 71 101 L 71 87.37\" fill=\"none\" stroke=\"#242424\" stroke-miterlimit=\"10\" pointer-events=\"stroke\"/><path d=\"M 71 82.12 L 74.5 89.12 L 71 87.37 L 67.5 89.12 Z\" fill=\"#242424\" stroke=\"#242424\" stroke-miterlimit=\"10\" pointer-events=\"all\"/><rect x=\"101\" y=\"81\" width=\"40\" height=\"40\" fill=\"#ffffff\" stroke=\"#808080\" stroke-width=\"2\" pointer-events=\"all\"/><g transform=\"translate(-0.5 -0.5)\"><switch><foreignObject style=\"overflow: visible; text-align: left;\" pointer-events=\"none\" width=\"100%\" height=\"100%\" requiredFeatures=\"http://www.w3.org/TR/SVG11/feature#Extensibility\"><div xmlns=\"http://www.w3.org/1999/xhtml\" style=\"display: flex; align-items: unsafe center; justify-content: unsafe center; width: 38px; height: 1px; padding-top: 101px; margin-left: 102px;\"><div style=\"box-sizing: border-box; font-size: 0; text-align: center; \"><div style=\"display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; \">b</div></div></div></foreignObject><text x=\"121\" y=\"105\" fill=\"#000000\" font-family=\"Helvetica\" font-size=\"12px\" text-anchor=\"middle\">b</text></switch></g><path d=\"M 151 141 L 121 141 L 121 127.37\" fill=\"none\" stroke=\"#242424\" stroke-miterlimit=\"10\" pointer-events=\"stroke\"/><path d=\"M 121 122.12 L 124.5 129.12 L 121 127.37 L 117.5 129.12 Z\" fill=\"#242424\" stroke=\"#242424\" stroke-miterlimit=\"10\" pointer-events=\"all\"/><rect x=\"151\" y=\"121\" width=\"40\" height=\"40\" fill=\"#ffffff\" stroke=\"#808080\" stroke-width=\"2\" pointer-events=\"all\"/><g transform=\"translate(-0.5 -0.5)\"><switch><foreignObject style=\"overflow: visible; text-align: left;\" pointer-events=\"none\" width=\"100%\" height=\"100%\" requiredFeatures=\"http://www.w3.org/TR/SVG11/feature#Extensibility\"><div xmlns=\"http://www.w3.org/1999/xhtml\" style=\"display: flex; align-items: unsafe center; justify-content: unsafe center; width: 38px; height: 1px; padding-top: 141px; margin-left: 152px;\"><div style=\"box-sizing: border-box; font-size: 0; text-align: center; \"><div style=\"display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; \">c</div></div></div></foreignObject><text x=\"171\" y=\"145\" fill=\"#000000\" font-family=\"Helvetica\" font-size=\"12px\" text-anchor=\"middle\">c</text></switch></g><rect x=\"1\" y=\"1\" width=\"40\" height=\"40\" fill=\"#ffffff\" stroke=\"#808080\" stroke-width=\"2\" pointer-events=\"all\"/><g transform=\"translate(-0.5 -0.5)\"><switch><foreignObject style=\"overflow: visible; text-align: left;\" pointer-events=\"none\" width=\"100%\" height=\"100%\" requiredFeatures=\"http://www.w3.org/TR/SVG11/feature#Extensibility\"><div xmlns=\"http://www.w3.org/1999/xhtml\" style=\"display: flex; align-items: unsafe center; justify-content: unsafe center; width: 38px; height: 1px; padding-top: 21px; margin-left: 2px;\"><div style=\"box-sizing: border-box; font-size: 0; text-align: center; \"><div style=\"display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; font-style: italic; white-space: normal; word-wrap: normal; \">(root)</div></div></div></foreignObject><text x=\"21\" y=\"25\" fill=\"#000000\" font-family=\"Helvetica\" font-size=\"12px\" text-anchor=\"middle\" font-style=\"italic\">(root)</text></switch></g></g><switch><g requiredFeatures=\"http://www.w3.org/TR/SVG11/feature#Extensibility\"/><a transform=\"translate(0,-5)\" xlink:href=\"https://www.diagrams.net/doc/faq/svg-export-text-problems\" target=\"_blank\"><text text-anchor=\"middle\" font-size=\"10px\" x=\"50%\" y=\"100%\">Viewer does not support full SVG 1.1</text></a></switch></svg>"],[6134,5033,""],[6134,0,"\n\n"],[6135,0,"> automerge1.drawio.svg"],[6433,12,""],[6433,0,"automerge2.draio"],[6448,1,""],[6447,1,""],[6447,0,"wio.svg"],[6505,58,""],[6581,1,""],[6581,0,". Hang on, how do we figure out which character goes first? "],[6641,6,""],[6641,0,"W"],[6583,0,"But "],[6587,1,""],[6587,0,"h"],[6543,12,""],[6542,1,""],[6635,3,""],[6635,0,"could just picked"],[6651,1,""],[6650,1,""],[6547,0," concurrently"],[6581,0," in the document"],[6675,49,""],[6675,0,"sort by their "],[6689,4,""],[6689,0,"u"],[6689,1,""],[6689,0,"agent"],[6698,0," or something"],[6515,10,""],[6587,0,", o"],[6589,1,""],[6588,1,""],[6587,1,""],[6592,9,""],[6661,2,""],[6661,0,"using"],[6734,5,""],[6734,0,"could"],[6770,17,""],[6770,0,"m"],[6770,1,""],[6770,0,"Mike inserted *X*"],[6963,8,""],[6963,0,"sometin"],[6969,1,""],[6968,1,""],[6968,0,"hing"],[6846,0," (RGA)"],[7431,0," "],[7431,1,""],[7431,0," The rule is that the bigge"],[7449,9,""],[7449,0,"whenever"],[7449,8,""],[7449,0,"children are sorted first based on theisr"],[7489,1,""],[7488,1,""],[7487,1,""],[7487,0,"r"],[7487,1,""],[7487,0,"ir sequence numbers (bug"],[7510,1,""],[7509,1,""],[7509,0,"igger sequence number first). Then they're "],[7539,13,""],[7539,0,"On"],[7540,1,""],[7539,1,""],[7539,0,"If the sequence numbers match, they get"],[7539,3,""],[7539,0,"Only if "],[7583,0," sorted based on their "],[7539,6,""],[7539,0,"I"],[7569,0," they must be concurrent changes. In that case"],[7632,0,"arbitrarily "],[7659,0,"agent IDs."],[7431,1,""],[7431,0,"\n\n"],[7571,4,""],[7571,0,"the changes"],[7601,8,""],[7616,8,""],[7616,0,"we"],[7618,7,""],[7618,0," sort them"],[7619,0,"can "],[7670,0," (We do this because we"],[7692,1,""],[7691,1,""],[7691,0,"all peers"],[7691,9,""],[7691,0,"its important all peers ne"],[7716,1,""],[7715,1,""],[7715,0,"end up with the same document)"],[7744,0,"."],[7677,0," it this way"],[7689,5,""],[7690,21,""],[7690,0,"so"],[7723,0," resulting"],[9521,1,""],[9521,0,"6"],[9819,2,""],[9819,0,"I'm"],[9822,4,""],[9829,1,""],[9829,0,"ing"],[9821,11,""],[9821,0,"ll compare"],[9879,8,""],[9879,0," edits"],[9937,4,""],[9964,5,""],[9964,0," do"],[9989,5,""],[11635,0,"from microoptimizations - "],[11645,0,"-"],[11635,27,""],[11699,1,""],[11699,0,"."],[11701,1,""],[11701,0,"B"],[11686,0," lots of"],[12342,0," If I werwe"],[12352,1,""],[12351,1,""],[12351,0,"e going to build col"],[12368,3,""],[12368,0,"c"],[12368,1,""],[12368,0,"software which supporte"],[12390,1,""],[12390,0,"s collaborative editing today, I'd build it on yjs."],[12437,1,""],[12437,0,"Y"],[12425,12,""],[12425,0,"use "],[10325,0,"\nWe"],[10327,1,""],[10326,1,""],[10326,0,"This is a chart of automerge's "],[10326,31,""],[10326,0,"Automerge"],[10326,9,""],[10326,0,"This is a chart of automerge\n\n<svg class=\"plot\" fill=\"currentColor\" text-anchor=\"middle\" width=\"700\" height=\"400\" viewBox=\"0 0 700 400\"><g transform=\"translate(40,0)\" fill=\"none\" text-anchor=\"end\"><g class=\"tick\" opacity=\"1\" transform=\"translate(0,370.5)\"><line stroke=\"currentColor\" x2=\"-6\"></line><line stroke=\"currentColor\" x2=\"600\" stroke-opacity=\"0.1\"></line><text fill=\"currentColor\" x=\"-9\" dy=\"0.32em\">0.0</text></g><g class=\"tick\" opacity=\"1\" transform=\"translate(0,322.49637377865497)\"><line stroke=\"currentColor\" x2=\"-6\"></line><line stroke=\"currentColor\" x2=\"600\" stroke-opacity=\"0.1\"></line><text fill=\"currentColor\" x=\"-9\" dy=\"0.32em\">0.5</text></g><g class=\"tick\" opacity=\"1\" transform=\"translate(0,274.4927475573099)\"><line stroke=\"currentColor\" x2=\"-6\"></line><line stroke=\"currentColor\" x2=\"600\" stroke-opacity=\"0.1\"></line><text fill=\"currentColor\" x=\"-9\" dy=\"0.32em\">1.0</text></g><g class=\"tick\" opacity=\"1\" transform=\"translate(0,226.48912133596485)\"><line stroke=\"currentColor\" x2=\"-6\"></line><line stroke=\"currentColor\" x2=\"600\" stroke-opacity=\"0.1\"></line><text fill=\"currentColor\" x=\"-9\" dy=\"0.32em\">1.5</text></g><g class=\"tick\" opacity=\"1\" transform=\"translate(0,178.48549511461982)\"><line stroke=\"currentColor\" x2=\"-6\"></line><line stroke=\"currentColor\" x2=\"600\" stroke-opacity=\"0.1\"></line><text fill=\"currentColor\" x=\"-9\" dy=\"0.32em\">2.0</text></g><g class=\"tick\" opacity=\"1\" transform=\"translate(0,130.48186889327476)\"><line stroke=\"currentColor\" x2=\"-6\"></line><line stroke=\"currentColor\" x2=\"600\" stroke-opacity=\"0.1\"></line><text fill=\"currentColor\" x=\"-9\" dy=\"0.32em\">2.5</text></g><g class=\"tick\" opacity=\"1\" transform=\"translate(0,82.47824267192972)\"><line stroke=\"currentColor\" x2=\"-6\"></line><line stroke=\"currentColor\" x2=\"600\" stroke-opacity=\"0.1\"></line><text fill=\"currentColor\" x=\"-9\" dy=\"0.32em\">3.0</text></g><g class=\"tick\" opacity=\"1\" transform=\"translate(0,34.47461645058467)\"><line stroke=\"currentColor\" x2=\"-6\"></line><line stroke=\"currentColor\" x2=\"600\" stroke-opacity=\"0.1\"></line><text fill=\"currentColor\" x=\"-9\" dy=\"0.32em\">3.5</text></g><text fill=\"currentColor\" transform=\"translate(-40,20)\" dy=\"-1em\" text-anchor=\"start\"> time per txn (ms)</text></g><g transform=\"translate(0,370)\" fill=\"none\" text-anchor=\"middle\"><g class=\"tick\" opacity=\"1\" transform=\"translate(40.5,0)\"><line stroke=\"currentColor\" y2=\"6\"></line><line stroke=\"currentColor\" y2=\"-350\" stroke-opacity=\"0.1\"></line><text fill=\"currentColor\" y=\"9\" dy=\"0.71em\">0</text></g><g class=\"tick\" opacity=\"1\" transform=\"translate(155.98322028809213,0)\"><line stroke=\"currentColor\" y2=\"6\"></line><line stroke=\"currentColor\" y2=\"-350\" stroke-opacity=\"0.1\"></line><text fill=\"currentColor\" y=\"9\" dy=\"0.71em\">50,000</text></g><g class=\"tick\" opacity=\"1\" transform=\"translate(271.46644057618425,0)\"><line stroke=\"currentColor\" y2=\"6\"></line><line stroke=\"currentColor\" y2=\"-350\" stroke-opacity=\"0.1\"></line><text fill=\"currentColor\" y=\"9\" dy=\"0.71em\">100,000</text></g><g class=\"tick\" opacity=\"1\" transform=\"translate(386.94966086427644,0)\"><line stroke=\"currentColor\" y2=\"6\"></line><line stroke=\"currentColor\" y2=\"-350\" stroke-opacity=\"0.1\"></line><text fill=\"currentColor\" y=\"9\" dy=\"0.71em\">150,000</text></g><g class=\"tick\" opacity=\"1\" transform=\"translate(502.43288115236857,0)\"><line stroke=\"currentColor\" y2=\"6\"></line><line stroke=\"currentColor\" y2=\"-350\" stroke-opacity=\"0.1\"></line><text fill=\"currentColor\" y=\"9\" dy=\"0.71em\">200,000</text></g><g class=\"tick\" opacity=\"1\" transform=\"translate(617.9161014404607,0)\"><line stroke=\"currentColor\" y2=\"6\"></line><line stroke=\"currentColor\" y2=\"-350\" stroke-opacity=\"0.1\"></line><text fill=\"currentColor\" y=\"9\" dy=\"0.71em\">250,000</text></g><text fill=\"currentColor\" transform=\"translate(700,30)\" dy=\"-0.32em\" text-anchor=\"end\">txns </text></g><g fill=\"none\" stroke=\"purple\" stroke-width=\"1.5\" stroke-miterlimit=\"1\" transform=\"translate(0.5,0.5)\"><path d=\"M42.30966440576184,334.968453217152L44.61932881152369,347.3297060008833L46.92899321728553,352.3034286308774L49.238657623047374,353.85148461209457L51.54832202880921,353.99288937369545L53.85798643457106,353.119184685576L56.1676508403329,353.5882125643014L58.47731524609475,353.94662789479634L60.78697965185658,354.0068946236547L63.096644057618434,354.1490683078529L65.40630846338027,353.5765641960213L67.71597286914212,353.6863778677001L70.02563727490396,353.28293398339684L72.3353016806658,352.9293209351293L74.64496608642764,352.9794113749642L76.9546304921895,350.64519971937096L79.26429489795132,347.5166021671373L81.57395930371317,346.34497410983045L83.88362370947502,346.06483080366127L86.19328811523685,329.7538633679724L88.5029525209987,341.20606687397316L90.81261692676054,344.17714897508205L93.12228133252239,344.02096322473784L95.43194573828421,339.15071317905466L97.74161014404606,337.4161803915942L100.05127454980791,345.529651911968L102.36093895556976,334.43219213151616L104.6706033613316,332.6128071740481L106.98026776709344,329.1433388486094L109.28993217285529,330.72351626400473L111.59959657861712,327.0967618490162L113.90926098437896,329.89010082727265L116.21892539014081,339.2226639901794L118.52858979590265,331.50890378474145L120.8382542016645,325.2647309122023L123.14791860742633,324.43846311967076L125.45758301318818,323.29314824950376L127.76724741895003,324.4245276667778L130.07691182471186,297.0018474059277L132.3865762304737,327.2634034611283L134.69624063623556,318.67958991494424L137.0059050419974,320.79089999648323L139.31556944775923,317.08631403777366L141.62523385352108,317.1262170522847L143.93489825928293,315.5594217036104L146.24456266504478,313.9409277935827L148.55422707080663,315.99555768979025L150.86389147656845,313.1872971679967L153.1735558823303,311.8466137798146L155.48322028809213,311.6192958724972L157.79288469385398,312.18679733346215L160.10254909961583,275.0526459267001L162.41221350537768,307.67335132936387L164.7218779111395,312.81199444924806L167.03154231690135,312.0217097908432L169.3412067226632,319.40058767560174L171.65087112842502,303.2904382256132L173.96053553418687,306.0601856298547L176.27019993994872,323.22592646787865L178.57986434571058,338.4754829397754L180.8895287514724,324.0422604860777L183.19919315723425,311.7291642678771L185.5088575629961,317.5852446235697L187.81852196875795,325.754799163999L190.1281863745198,273.2218301538354L192.43785078028165,307.0379464344723L194.74751518604347,308.3675182314111L197.0571795918053,305.8125952144778L199.36684399756714,315.50578542817016L201.676508403329,310.0300645885391L203.98617280909085,304.62440782643097L206.29583721485267,302.907305923881L208.60550162061452,300.7181531616053L210.91516602637637,309.3549651114627L213.22483043213822,334.854562309457L215.53449483790007,256.6764747401852L217.8441592436619,306.02416966122115L220.1538236494237,310.3887761981957L222.46348805518556,303.43580943104564L224.77315246094741,297.79652458815247L227.08281686670927,300.0300648629319L229.39248127247112,331.8233899414033L231.70214567823297,308.30299991729026L234.01181008399482,294.57287976030636L236.32147448975667,306.4273207234548L238.63113889551846,250.2423452782171L240.9408033012803,299.7219722136838L243.25046770704216,310.1519343708049L245.560132112804,298.3395931638715L247.86979651856586,296.9839028824633L250.17946092432769,294.8186880886822L252.48912533008954,315.4002676011884L254.7987897358514,328.7540567058032L257.10845414161327,296.1958934037708L259.41811854737506,285.1752623706938L261.7277829531369,223.7808467136446L264.0374473588987,293.1937300104379L266.3471117646606,289.9869132376882L268.65677617042246,291.6462404722998L270.96644057618425,289.42647291779764L273.27610498194616,288.73305852091545L275.58576938770796,285.40769612092686L277.8954337934698,211.52907397574947L280.20509819923166,296.8787805094819L282.5147626049935,282.295329170959L284.82442701075536,280.7163715275385L287.1340914165172,272.5731189417396L289.443755822279,275.0129783224233L291.75342022804085,276.9126581770053L294.0630846338027,189.08334506829772L296.37274903956455,269.75095167386496L298.6824134453264,267.29315698612555L300.9920778510882,265.8590805276817L303.30174225685005,264.501607487239L305.6114066626119,269.3548107729358L307.92107106837375,268.8816247241124L310.23073547413566,202.03719512981164L312.54039987989745,283.08538581221364L314.8500642856593,286.0625855919234L317.15972869142115,285.31391182056876L319.469393097183,283.6213318017489L321.7790575029448,191.616563149324L324.0887219087067,279.98515686757565L326.3983863144685,289.1524945249947L328.70805072023035,263.5754665180542L331.0177151259922,266.8788627463574L333.32737953175405,255.23313406131842L335.6370439375159,153.86730210866077L337.9467083432777,301.99399449969684L340.2563727490396,290.8151097199587L342.5660371548014,271.37666532881445L344.8757015605633,243.9075814030077L347.1853659663251,247.42484492269904L349.49503037208694,143.05820126289254L351.80469477784874,241.84426073806134L354.1143591836106,239.0242903080998L356.4240235893725,292.0706584851939L358.7336879951343,320.2314768731976L361.04335240089614,320.6956649302387L363.353016806658,320.0829015220471L365.66268121241984,321.2679022376054L367.9723456181817,322.1500064081641L370.2820100239436,279.7812966036057L372.59167442970534,150.62350929459564L374.90133883546713,257.0801537460953L377.21100324122904,255.46705246774198L379.5206676469909,248.08051474050524L381.83033205275274,318.5028032163361L384.1399964585146,276.7833899801005L386.44966086427644,152.70123680729728L388.75932527003823,256.6348536760652L391.06898967580014,245.0570589547315L393.378654081562,270.61816627165695L395.6883184873238,291.8337743186176L397.99798289308563,280.8975785923264L400.3076472988474,253.8488537800058L402.61731170460934,147.2092245933975L404.92697611037113,267.5180237332205L407.23664051613304,269.12887056904947L409.54630492189483,263.69664792804076L411.8559693276567,261.98689326829947L414.16563373341853,139.71486284935736L416.4752981391804,261.370087858105L418.78496254494223,255.87257318100725L421.0946269507041,251.42154830828582L423.40429135646593,131.12237322332066L425.7139557622277,249.9432022329065L428.02362016798963,256.1754197061827L430.3332845737514,254.50504213301897L432.64294897951333,146.26343237985773L434.9526133852751,315.7184830632591L437.2622777910369,302.10868524317397L439.57194219679883,255.69386672151452L441.8816066025606,256.41916570277965L444.19127100832253,248.13793562231044L446.5009354140843,114.02454935610312L448.8105998198462,287.79113971980667L451.120264225608,312.85080038886963L453.42992863136993,247.3359109086496L455.7395930371317,243.34848556827768L458.04925744289346,257.7248076918354L460.35892184865537,119.47206998493448L462.6685862544172,265.91938940330715L464.97825066017907,242.72561048392126L467.2879150659409,282.8106164159161L469.5975794717028,107.43905265210508L471.90724387746457,262.2833716323476L474.2169082832265,252.86015026091383L476.5265726889883,269.4731244463173L478.8362370947501,233.83269544419872L481.14590150051197,100.98776160576477L483.45556590627376,244.24007151106983L485.76523031203567,301.8079308123864L488.07489471779746,92.276266478406L490.38455912355937,244.46197624194338L492.6942235293212,310.48604681001416L495.003887935083,312.8078811147665L497.31355234084486,313.28568309617674L499.6232167466067,314.5272652056339L501.93288115236857,314.03204683685385L504.2425455581304,314.7672865055629L506.55220996389227,314.0681960634063L508.86187436965406,314.9782533216905L511.17153877541597,278.2343911738366L513.4812031811778,103.58778921321984L515.7908675869396,256.7088159354081L518.1005319927015,252.40193097464996L520.4101963984633,310.27312490170635L522.7198608042252,313.89856161738174L525.029525209987,117.09933023463333L527.3391896157488,250.46510226563396L529.6488540215107,252.63180133148424L531.9585184272726,281.29381511586587L534.2681828330344,97.4889116048936L536.5778472387963,254.0046295795242L538.887511644558,268.9243289417631L541.1971760503199,236.43463906860703L543.5068404560817,243.32870538611743L545.8165048618436,84.21007881810141L548.1261692676054,248.48442243559901L550.4358336733673,235.82050822847495L552.7454980791291,250.43728877275638L555.055162484891,81.18646414056792L557.3648268906528,257.0717637683346L559.6744912964147,253.72565890605804L561.9841557021764,249.73066156932813L564.2938201079384,254.28819573630133L566.6034845137001,78.48691944732096L568.9131489194621,224.2537264993702L571.2228133252238,239.2663311199341L573.5324777309856,232.68035053927576L575.8421421367475,69.11175796229507L578.1518065425093,250.54871478950017L580.4614709482713,267.08943890964383L582.771135354033,249.6621817083864L585.0807997597949,47.52002115006532L587.3904641655568,217.37818785303227L589.7001285713186,203.3479695705606L592.0097929770805,60.56641231392514L594.3194573828423,232.57566269516408L596.629121788604,228.98581452406694L598.938786194366,214.00566179434387L601.2484506001277,100.80896576366655L603.5581150058896,203.38959245872059L605.8677794116514,260.22470453529644L608.1774438174134,282.70516752262176L610.4871082231753,20L612.796772628937,219.03020807171086L615.106437034699,238.11778445410738L617.4161014404607,58.48072724002276L619.7257658462227,291.5684325466767L622.0354302519844,306.4843494155757L624.3450946577461,297.73916524730816L626.6547590635081,260.0212592150145L628.9644234692698,209.87775537831772L631.2740878750318,29.030959931952616L633.5837522807935,287.9655590713959L635.8934166865554,262.31117053219054L638.2030810923173,271.11027026144575L640,274.7612139915496\"></path></g><g stroke=\"currentColor\" transform=\"translate(0,0.5)\"><line x1=\"40\" x2=\"640\" y1=\"370\" y2=\"370\"></line></g></svg>"],[10356,13540,""],[10354,0,"'s performance "],[10342,27,""],[10342,0,"showing how long each in"],[10350,16,""],[10350,0,"the time taken d"],[10365,1,""],[10365,0,"for each chunk of 10"],[10384,1,""],[10384,0,"000 operations while running the test. "],[10359,9,""],[10359,0,"spent processing"],[10406,13,""],[10406,0,"during"],[10423,0," "],[10423,1,""],[10423,0,"There's a lot going on here. "],[10423,29,""],[10423,0,"I think those spikes h"],[10444,1,""],[10444,0,"are the garbage "],[10448,4,""],[10448,0,"V8's "],[10461,0,"collector trying to free up memory. The spikes get both slower and more frequent as the "],[10326,223,""],[10326,0,"This is a chart showing the time spent processing each chunk of 1000 operations during the test. I think those spikes are V8's garbage collector trying to free up memory. The spikes get both slower and more frequent as the"],[10550,0,"> am_perf1.svg"],[10511,5,""],[10543,0," document grows."],[10359,5,""],[10359,0,"taken to"],[10409,6,""],[10409,0,"throughout"],[10429,0," T"],[10430,1,""],[10430,0,"(The times show average"],[10435,5,""],[10435,0,"y"],[10435,1,""],[10435,0,"Y axis shows"],[10453,0,"*"],[10461,0,"* time "],[10429,39,""],[10377,1,""],[10376,1,""],[10375,1,""],[10375,19,""],[10375,0," each"],[10390,1,""],[10410,0,", "],[10411,1,""],[10410,1,""],[10410,0,", bucketed into groups of 1000 operations"],[10412,8,""],[10412,0,"averaged"],[10421,4,""],[10421,0,"in"],[10547,40,""],[10547,0,"as the test "],[10524,35,""],[13430,0,":"],[13383,0,":"],[13336,0,":"],[13433,0," "],[13385,0," "],[13337,0," "],[13436,0,"["],[13387,0,"["],[13338,0,"["],[13439,0,"."],[13389,0,"."],[13339,0,"."],[13442,0,"."],[13391,0,"."],[13340,0,"."],[13445,0,"]"],[13393,0,"]"],[13341,0,"]"],[13301,0,": 0"],[13450,1,""],[13397,1,""],[13344,1,""],[13149,1,""],[13103,1,""],[13056,1,""],[13444,1,""],[13392,1,""],[13340,1,""],[13146,1,""],[13101,1,""],[13055,1,""],[13438,1,""],[13387,1,""],[13336,1,""],[13143,1,""],[13099,1,""],[13054,1,""],[13432,1,""],[13382,1,""],[13332,1,""],[13140,1,""],[13097,1,""],[13053,1,""],[13426,1,""],[13377,1,""],[13328,1,""],[13137,1,""],[13095,1,""],[13052,1,""],[13420,1,""],[13372,1,""],[13324,1,""],[13134,1,""],[13093,1,""],[13051,1,""],[15078,0," a bit"],[15080,4,""],[15078,2,""],[13415,0,": [..]"],[13368,0,": [..]"],[13321,0,": [..]"],[13132,0,": [..]"],[13092,0,": [..]"],[13051,0,": [..]"],[13445,6,""],[13392,6,""],[13339,6,""],[13144,6,""],[13098,6,""],[13051,6,""],[15078,0," a bit"],[15079,6,""],[15133,0," in the document"],[15246,4,""],[15246,0,"I"],[15539,0," We're moving the Pareto fronteir "],[15572,1,""],[15571,1,""],[15570,1,""],[15569,1,""],[15569,0,"ier."],[15538,1,""],[15538,0,", which moves"],[15551,13,""],[15563,0,"efficieny "],[15568,1,""],[15568,0,"i"],[15571,0,"c"],[15556,0,"["],[15583,0,"](https://en.wikipedia.org/wiki/Pareto_efficiency)"],[10524,0," That big spike? A group of 1000 edits took 3"],[10568,1,""],[10568,0,"over 3.5"],[10524,52,""],[10540,0,"\n\n That big spike? A group of 1000 edits took over 3.5"],[10542,1,""],[10593,0," seconds to process.\n"],[10613,0," Oof."],[18703,23,""],[18703,0,"We can "],[18703,7,""],[18703,0,"If we s"],[18709,1,""],[18709,0,"zoom in on the diagram above"],[18703,2,""],[18703,0,"You can see this if"],[18754,0,". Th"],[18757,1,""],[18756,1,""],[18755,1,""],[18755,0," The amount of ti"],[18756,16,""],[18755,1,""],[18755,0,"\n\n> ref_perf3.svg"],[18755,0," There's a lot going on here because the insert cursor moves all over the place, and shuffi"],[18845,1,""],[18845,0,"ling elements in an array "],[18834,37,""],[18834,0," during this trace, but you "],[18858,4,""],[18858,0,"the"],[18741,0,"referencer"],[18750,1,""],[18750,0,"-crdts part of the "],[18889,0,"'re s a"],[18895,1,""],[18894,1,""],[18893,1,""],[18892,1,""],[18891,1,""],[18890,1,""],[18889,1,""],[18889,0,"e'"],[18890,1,""],[18889,1,""],[18889,0,"'e s"],[18892,1,""],[18891,1,""],[18890,1,""],[18889,1,""],[18889,0,"re's a strong trend *up and to the right*."],[18903,0,"linear "],[18734,30,""],[18734,0,"on"],[18792,23,""],[18792,0,"inserts are"],[18822,18,""],[18858,0,"during this "],[18857,13,""],[18857,0," "],[18880,0," I assume the section at thee"],[18908,1,""],[18908,0," end was martin "],[18917,7,""],[18917,0,"Martin coming back trhoguh the d"],[18936,13,""],[18935,1,""],[18916,0," when"],[18880,60,""],[18792,0,"the "],[18792,4,""],[18792,0,"martin"],[18792,6,""],[18792,0,"Martin's "],[18808,0," are"],[18792,43,""],[18792,0,"inserts happened all over the place"],[18840,0," obviously"],[18873,22,""],[18873,0,"upwards."],[18873,7,""],[18873,0,"up and to the right"],[18911,0,"\n"],[20517,20,""],[20517,0," the same information"],[21082,0,"the resulting "],[21096,4,""],[22019,0,"\n\n> yjs_perf3"],[22031,1,""],[22031,0,"4.svg"],[22019,0,"\n\nMy reference-crdts implmeention"],[22040,12,""],[22040,0,"implementation gets "],[22021,39,""],[22021,0,"Yjs is a"],[22028,1,""],[22028,0,"basically a line at the "],[22021,31,""],[22021,0,"You can't really tell anything about yjs if we put it on the same scale as "],[22021,75,""],[22021,0,"I can't really put yjs on the same scale as the other algoir"],[22080,1,""],[22079,1,""],[22079,0,"rithms because its so fast."],[22105,1,""],[22105,0,":"],[22124,0,"\n"],[22124,0,"\nBut if we isolate yjs, you can see it (m"],[22164,1,""],[22163,1,""],[22163,0,"(mostly) having linear "],[22179,7,""],[22179,0,"constnat per"],[22179,12,""],[22179,0,"constant performance for any"],[22204,3,""],[22179,8,""],[22179,0,"flat"],[22172,28,""],[22172,0,"performing just as well at the start of the test and at the end."],[22235,1,""],[22235,0,":\n\n> <svg class=\"plot\" fill=\"currentColor\" text-anchor=\"middle\" width=\"700\" height=\"400\" viewBox=\"0 0 700 400\" style=\"background: white none repeat scroll 0% 0%;\"><g transform=\"translate(40,0)\" fill=\"none\" text-anchor=\"end\"><g class=\"tick\" opacity=\"1\" transform=\"translate(0,370.5)\"><line stroke=\"currentColor\" x2=\"-6\"></line><line stroke=\"currentColor\" x2=\"600\" stroke-opacity=\"0.1\"></line><text fill=\"currentColor\" x=\"-9\" dy=\"0.32em\">0.000</text></g><g class=\"tick\" opacity=\"1\" transform=\"translate(0,330.51486076085445)\"><line stroke=\"currentColor\" x2=\"-6\"></line><line stroke=\"currentColor\" x2=\"600\" stroke-opacity=\"0.1\"></line><text fill=\"currentColor\" x=\"-9\" dy=\"0.32em\">0.002</text></g><g class=\"tick\" opacity=\"1\" transform=\"translate(0,290.5297215217089)\"><line stroke=\"currentColor\" x2=\"-6\"></line><line stroke=\"currentColor\" x2=\"600\" stroke-opacity=\"0.1\"></line><text fill=\"currentColor\" x=\"-9\" dy=\"0.32em\">0.004</text></g><g class=\"tick\" opacity=\"1\" transform=\"translate(0,250.5445822825633)\"><line stroke=\"currentColor\" x2=\"-6\"></line><line stroke=\"currentColor\" x2=\"600\" stroke-opacity=\"0.1\"></line><text fill=\"currentColor\" x=\"-9\" dy=\"0.32em\">0.006</text></g><g class=\"tick\" opacity=\"1\" transform=\"translate(0,210.5594430434178)\"><line stroke=\"currentColor\" x2=\"-6\"></line><line stroke=\"currentColor\" x2=\"600\" stroke-opacity=\"0.1\"></line><text fill=\"currentColor\" x=\"-9\" dy=\"0.32em\">0.008</text></g><g class=\"tick\" opacity=\"1\" transform=\"translate(0,170.57430380427223)\"><line stroke=\"currentColor\" x2=\"-6\"></line><line stroke=\"currentColor\" x2=\"600\" stroke-opacity=\"0.1\"></line><text fill=\"currentColor\" x=\"-9\" dy=\"0.32em\">0.010</text></g><g class=\"tick\" opacity=\"1\" transform=\"translate(0,130.58916456512665)\"><line stroke=\"currentColor\" x2=\"-6\"></line><line stroke=\"currentColor\" x2=\"600\" stroke-opacity=\"0.1\"></line><text fill=\"currentColor\" x=\"-9\" dy=\"0.32em\">0.012</text></g><g class=\"tick\" opacity=\"1\" transform=\"translate(0,90.60402532598107)\"><line stroke=\"currentColor\" x2=\"-6\"></line><line stroke=\"currentColor\" x2=\"600\" stroke-opacity=\"0.1\"></line><text fill=\"currentColor\" x=\"-9\" dy=\"0.32em\">0.014</text></g><g class=\"tick\" opacity=\"1\" transform=\"translate(0,50.61888608683553)\"><line stroke=\"currentColor\" x2=\"-6\"></line><line stroke=\"currentColor\" x2=\"600\" stroke-opacity=\"0.1\"></line><text fill=\"currentColor\" x=\"-9\" dy=\"0.32em\">0.016</text></g><text fill=\"currentColor\" transform=\"translate(-40,20)\" dy=\"-1em\" text-anchor=\"start\"> avg time per txn (ms)</text></g><g transform=\"translate(0,370)\" fill=\"none\" text-anchor=\"middle\"><g class=\"tick\" opacity=\"1\" transform=\"translate(40.5,0)\"><line stroke=\"currentColor\" y2=\"6\"></line><line stroke=\"currentColor\" y2=\"-350\" stroke-opacity=\"0.1\"></line><text fill=\"currentColor\" y=\"9\" dy=\"0.71em\">0</text></g><g class=\"tick\" opacity=\"1\" transform=\"translate(155.98322028809213,0)\"><line stroke=\"currentColor\" y2=\"6\"></line><line stroke=\"currentColor\" y2=\"-350\" stroke-opacity=\"0.1\"></line><text fill=\"currentColor\" y=\"9\" dy=\"0.71em\">50,000</text></g><g class=\"tick\" opacity=\"1\" transform=\"translate(271.46644057618425,0)\"><line stroke=\"currentColor\" y2=\"6\"></line><line stroke=\"currentColor\" y2=\"-350\" stroke-opacity=\"0.1\"></line><text fill=\"currentColor\" y=\"9\" dy=\"0.71em\">100,000</text></g><g class=\"tick\" opacity=\"1\" transform=\"translate(386.94966086427644,0)\"><line stroke=\"currentColor\" y2=\"6\"></line><line stroke=\"currentColor\" y2=\"-350\" stroke-opacity=\"0.1\"></line><text fill=\"currentColor\" y=\"9\" dy=\"0.71em\">150,000</text></g><g class=\"tick\" opacity=\"1\" transform=\"translate(502.43288115236857,0)\"><line stroke=\"currentColor\" y2=\"6\"></line><line stroke=\"currentColor\" y2=\"-350\" stroke-opacity=\"0.1\"></line><text fill=\"currentColor\" y=\"9\" dy=\"0.71em\">200,000</text></g><g class=\"tick\" opacity=\"1\" transform=\"translate(617.9161014404607,0)\"><line stroke=\"currentColor\" y2=\"6\"></line><line stroke=\"currentColor\" y2=\"-350\" stroke-opacity=\"0.1\"></line><text fill=\"currentColor\" y=\"9\" dy=\"0.71em\">250,000</text></g><text fill=\"currentColor\" transform=\"translate(700,30)\" dy=\"-0.32em\" text-anchor=\"end\">txns </text></g><g fill=\"none\" stroke=\"blue\" stroke-width=\"1.5\" stroke-miterlimit=\"1\" transform=\"translate(0.5,0.5)\"><path d=\"M42.30966440576184,331.3045814071602L44.61932881152369,331.3281726513708L46.92899321728553,317.2031623359376L49.238657623047374,320.30996767031394L51.54832202880921,324.5561494998344L53.85798643457106,318.80054861881143L56.1676508403329,322.17045619910107L58.47731524609475,317.9318914709247L60.78697965185658,322.536120335409L63.096644057618434,320.6676347178808L65.40630846338027,318.42368870722214L67.71597286914212,325.6765331047233L70.02563727490396,320.6674348185915L72.3353016806658,324.34220899853125L74.64496608642764,320.00146236735725L76.9546304921895,321.81180946626955L79.26429489795132,318.92290314557437L81.57395930371317,323.10450901416675L83.88362370947502,320.64124458570836L86.19328811523685,320.2583868017046L88.5029525209987,323.0325358113214L90.81261692676054,317.763134167238L93.12228133252239,326.08038306978705L95.43194573828421,324.9763932920026L97.74161014404606,325.2328780819742L100.05127454980791,303.1731166207364L102.36093895556976,313.42500655935237L104.6706033613316,322.56730864634795L106.98026776709344,319.5774598876221L109.28993217285529,322.68466509505504L111.59959657861712,318.30173405351576L113.90926098437896,320.89694951522637L116.21892539014081,309.4595202730632L118.52858979590265,320.2042069444228L120.8382542016645,318.2851401781658L123.14791860742633,316.12078462065284L125.45758301318818,298.8351689520023L127.76724741895003,291.3212414850521L130.07691182471186,297.56706021924L132.3865762304737,287.8023693119221L134.69624063623556,323.15089183095284L137.0059050419974,320.82577590953804L139.31556944775923,321.2006366792788L141.62523385352108,324.31483918109416L143.93489825928293,320.1688201525851L146.24456266504478,325.1025264664701L148.55422707080663,320.0064804055508L150.86389147656845,325.4477981195858L153.1735558823303,319.86935142956924L155.48322028809213,323.3210286184828L157.79288469385398,321.120466413925L160.10254909961583,319.88972380366755L162.41221350537768,323.44298327218917L164.7218779111395,318.79135205985676L167.03154231690135,321.3613568994709L169.3412067226632,290.84303926237556L171.65087112842502,324.6245240686047L173.96053553418687,315.76869546334996L176.27019993994872,270.62895196043087L178.57986434571058,204.0013745776499L180.8895287514724,262.0046372681377L183.19919315723425,317.71955038736985L185.5088575629961,276.9875287148924L187.81852196875795,288.72382690772554L190.1281863745198,297.9105325553182L192.43785078028165,320.5408818109297L194.74751518604347,324.52656053216555L197.0571795918053,321.20223602254885L199.36684399756714,289.9629463706867L201.676508403329,305.4076661731511L203.98617280909085,325.24769252594626L206.29583721485267,321.27600861690973L208.60550162061452,326.00778998550203L210.91516602637637,301.6272712117183L213.22483043213822,238.40504823043395L215.53449483790007,318.3081316500306L217.8441592436619,308.71399736343693L220.1538236494237,300.18526715281536L222.46348805518556,317.24952504362983L224.77315246094741,324.93220981426674L227.08281686670927,320.8783564235497L229.39248127247112,299.5511028194817L231.70214567823297,320.8437692288689L234.01181008399482,321.686636016929L236.32147448975667,314.55818535727093L238.63113889551846,310.9775361111746L240.9408033012803,316.84569518766L243.25046770704216,309.83596035145825L245.560132112804,320.4817038755921L247.86979651856586,323.59332734887266L250.17946092432769,319.6206438689118L252.48912533008954,307.6216033084685L254.7987897358514,287.8947550325755L257.10845414161327,305.25092442547464L259.41811854737506,319.6879988321421L261.7277829531369,316.2449384644532L264.0374473588987,310.47672225507415L266.3471117646606,319.4948905328851L268.65677617042246,326.31307656730263L270.96644057618425,323.49054559905113L273.27610498194616,326.7847012543128L275.58576938770796,324.0901427723198L277.8954337934698,302.22207013174227L280.20509819923166,243.24856808823785L282.5147626049935,319.4276955486686L284.82442701075536,322.8252128404381L287.1340914165172,321.6952527636756L289.443755822279,325.2934754959085L291.75342022804085,317.5032308312992L294.0630846338027,325.47760702115966L296.37274903956455,321.3213917882935L298.6824134453264,321.39014619550466L300.9920778510882,326.1225673311962L303.30174225685005,320.41552842243766L305.6114066626119,322.7730322739611L307.92107106837375,315.57716662170344L310.23073547413566,324.18250838387917L312.54039987989745,323.83101899892216L314.8500642856593,327.1049822937151L317.15972869142115,323.63111330457184L319.469393097183,322.67107015591233L321.7790575029448,327.1557433071173L324.0887219087067,323.0679226776373L326.3983863144685,318.1496105454543L328.70805072023035,279.397792945101L331.0177151259922,324.4581859633952L333.32737953175405,322.0938846423003L335.6370439375159,321.9853250284475L337.9467083432777,324.1815087384768L340.2563727490396,326.59757079285436L342.5660371548014,336.09354164371956L344.8757015605633,336.34304880153394L347.1853659663251,338.5556065274863L349.49503037208694,335.47819026148954L351.80469477784874,337.3090698624702L354.1143591836106,332.5620940625089L356.4240235893725,308.5890437735233L358.7336879951343,306.7671609811643L361.04335240089614,299.8325782231667L363.353016806658,305.57436423114183L365.66268121241984,294.0060236703604L367.9723456181817,289.4551551058633L370.2820100239436,308.44829612885104L372.59167442970534,325.80506536857416L374.90133883546713,330.6798136065485L377.21100324122904,327.5802056148002L379.5206676469909,332.6212720723246L381.83033205275274,207.6065946787434L384.1399964585146,284.108602092771L386.44966086427644,325.4592139032503L388.75932527003823,316.9858431344646L391.06898967580014,332.191431773667L393.378654081562,316.76372567974687L395.6883184873238,262.98145415682063L397.99798289308563,262.72876812364757L400.3076472988474,319.2657557491691L402.61731170460934,324.8604364362326L404.92697611037113,320.5371032377032L407.23664051613304,324.3348317912298L409.54630492189483,322.29161118117236L411.8559693276567,322.34859000089403L414.16563373341853,321.89257942949104L416.4752981391804,325.9654057503255L418.78496254494223,321.66526399742827L421.0946269507041,322.2050433193038L423.40429135646593,325.1463301802433L425.7139557622277,322.11967507660495L428.02362016798963,326.14152030117594L430.3332845737514,319.83094566690846L432.64294897951333,235.32461306809228L434.9526133852751,75.91829753787508L437.2622777910369,166.21079974512585L439.57194219679883,324.22787152064717L441.8816066025606,319.73820014243006L444.19127100832253,326.10955220426155L446.5009354140843,322.6142912354799L448.8105998198462,176.58686333872367L451.120264225608,83.42800656378876L453.42992863136993,311.36719129027165L455.7395930371317,312.4791580477033L458.04925744289346,298.11045820980615L460.35892184865537,312.8952034334508L462.6685862544172,310.59487830093826L464.97825066017907,325.9474125054728L467.2879150659409,299.280983170092L469.5975794717028,324.93938712227896L471.90724387746457,316.1473747265925L474.2169082832265,316.7793198352163L476.5265726889883,322.8709958104003L478.8362370947501,322.93777103590054L481.14590150051197,325.76707943910765L483.45556590627376,321.23782286263213L485.76523031203567,308.2479705268284L488.07489471779746,320.70002272246745L490.38455912355937,317.4416736922379L492.6942235293212,278.8441986756996L495.003887935083,157.1250764558391L497.31355234084486,84.79489853924105L499.6232167466067,71.64552552793683L501.93288115236857,65.63359998491238L504.2425455581304,76.58820854134962L506.55220996389227,76.58103123333747L508.86187436965406,86.7671455173775L511.17153877541597,220.09323392010714L513.4812031811778,323.38780376950496L515.7908675869396,319.9820894897051L518.1005319927015,320.7833916743615L520.4101963984633,48.230647902170475L522.7198608042252,20L525.029525209987,234.41697034533672L527.3391896157488,318.8339362688006L529.6488540215107,326.0302016451587L531.9585184272726,306.1575675028279L534.2681828330344,322.95836334390395L536.5778472387963,325.42042830214876L538.887511644558,306.96326806767235L541.1971760503199,320.13823146503574L543.5068404560817,274.2893515642087L545.8165048618436,269.0293464528473L548.1261692676054,280.27104844694315L550.4358336733673,277.58808553880993L552.7454980791291,322.2740376950358L555.055162484891,316.5819931694009L557.3648268906528,279.9989695015021L559.6744912964147,249.68333656105924L561.9841557021764,309.12944297683856L564.2938201079384,276.3615414094514L566.6034845137001,298.3803579252909L568.9131489194621,311.3117918536824L571.2228133252238,304.58599161439633L573.5324777309856,292.6017456122655L575.8421421367475,276.9658967667332L578.1518065425093,282.3808443087335L580.4614709482713,303.58716279015715L582.771135354033,305.0545974050616L585.0807997597949,320.97050217568227L587.3904641655568,310.4371569424752L589.7001285713186,324.76027370969933L592.0097929770805,316.59958661567515L594.3194573828423,321.7128262498121L596.629121788604,282.7173392360888L598.938786194366,308.06443877392303L601.2484506001277,188.83277207355542L603.5581150058896,308.9111241299632L605.8677794116514,286.98589280499056L608.1774438174134,281.5791622111582L610.4871082231753,323.5951267403882L612.796772628937,291.2160806059849L615.106437034699,233.74921853720272L617.4161014404607,214.3130421494712L619.7257658462227,55.90869424962041L622.0354302519844,62.69273295716713L624.3450946577461,52.62697390908525L626.6547590635081,183.19672675685553L628.9644234692698,313.11612134347683L631.2740878750318,318.630012032703L633.5837522807935,107.19075490582142L635.8934166865554,200.7048397186645L638.2030810923173,216.57058317375066L640,273.51763834722107\"></path></g><g text-anchor=\"start\" transform=\"translate(0.5,0.5)\"><text dx=\"3\" dy=\"0.32em\" x=\"640\" y=\"273.51763834722107\">yjs</text></g><g stroke=\"currentColor\" transform=\"translate(0,0.5)\"><line x1=\"40\" x2=\"640\" y1=\"370\" y2=\"370\"></line></g></svg>"],[22240,13966,""],[22240,0,"yjs_pef"],[22246,1,""],[22246,0,"rf5.svg"],[22181,1,""],[22180,1,""],[22179,1,""],[22179,0,"s"],[22219,3,""],[22219,0,"or"],[22172,61,""],[22172,0,"takes constant time"],[22163,28,""],[22163,0,"has mostly flat performance. Its almost always fast:"],[22233,0,"\n"],[22233,0,"\n(Though I have no idea what"],[22234,1,""],[22260,0," those spikes are "],[22277,1,""],[22277,0,". Kevin thinks it might be from "],[22278,31,""],[22278,0," "],[22234,7,""],[22272,0," "],[22272,1,""],[22272,0,"Remen"],[22276,1,""],[22276,0,"mber, the "],[22234,52,""],[22234,0,"I have no idea what those spikes are. Remember, the"],[22167,0,"*"],[22174,0,"*"],[22216,0,", and it des"],[22227,1,""],[22226,1,""],[22226,0,"oesn't get slower over time"],[22194,29,""],[22194,0,"I"],[22215,0," "],[22215,1,""],[22225,0," in this test"],[22225,13,""],[22194,0,"Unlike the other algorithms, "],[22223,1,""],[22223,0,"i"],[22310,15,""],[22310,0,". But remember, the scale here is "],[22310,34,""],[22310,0," hou"],[22313,1,""],[22312,1,""],[22311,1,""],[22311,0,"though. They're pretty small in absolute terms, but its stilla "],[22373,1,""],[22372,1,""],[22372,0," a bit weird."],[22373,12,""],[22373,0,"pretty curious!"],[22380,7,""],[22380,0,"weird"],[22373,7,""],[22367,6,""],[22367,0,"still "],[22381,5,""],[22381,0,"C"],[21837,182,""],[21836,1,""],[21838,0,"Kevin says he wrote and rewrote parts of yjs 12 times in order to make this code run so fast. If there was a programmer version of the speedrunning community, they would adore Kevin. "],[22028,7,""],[22028,0," even"],[22029,4,""],[22028,1,""],[22118,5,""],[22118,0,"I"],[22243,0,", as the document grows"],[22391,0," Maybe that"],[22401,1,""],[22400,1,""],[22400,0,"ey happen when the user moves their cursor a long way"],[22443,10,""],[22443,0,"around the document? Or when the user deletes chunks of "],[22495,4,""],[22495,0,"? I have on idea"],[22504,7,""],[22504,0,"no idea."],[22514,0,"The real question is: "],[22543,6,""],[22545,0," even"],[22546,0,"*"],[22558,0,"*"],[22559,7,""],[22619,3,""],[22619,0,"mu"],[22619,2,""],[22619,0,"any"],[22641,3,""],[22641,0,"managed here"],[23514,0,"; 5"],[23458,0,"item = "],[23458,0,"var "],[23471,4,""],[23471,0,"content"],[23528,1,""],[23528,0,":"],[23611,48,""],[23611,0,"mem-frag.drawio.svg"],[23572,0,"is "],[23583,16,""],[23583,0," a mess like this"],[24393,54,""],[24906,40,""],[24906,0,"des"],[24906,3,""],[24906,0,"would tell us everything we need to know"],[25752,0," much"],[25758,0," The v8"],[25764,1,""],[25763,1,""],[25763,0,"V8 optimizer does "],[25617,0,","],[25777,5,""],[25777,0,"helps a lot here - small string inlining "],[25782,6,""],[25777,35,""],[25777,0,"does a"],[25777,6,""],[25777,0,"has a lot of tricks"],[25782,0,"n awful l"],[25790,1,""],[25789,1,""],[25803,0," "],[25803,1,""],[25803,0,". But its not magic."],[25803,0," "],[25803,1,""],[25804,0," (Small stringi "],[25819,1,""],[25818,1,""],[25818,0," inling wou"],[25819,10,""],[25819,0,"inlining would help here)."],[25850,3,""],[25850,0,"V8 isn't"],[25858,4,""],[25853,5,""],[25853,0,"will "],[25857,1,""],[25853,4,""],[25853,0,"isn't"],[25496,0,"small, "],[25496,7,""],[25805,41,""],[25804,1,""],[25803,1,""],[25803,0,", "],[25805,1,""],[25805,0,"b"],[25824,0," It doesn't actually un"],[25825,22,""],[25824,1,""],[25823,1,""],[25823,0," and its tricks only get us so far."],[26350,19,""],[26350,0,"btree.drawio.svg"],[26566,19,""],[26566,0,"Martin's editing trace"],[26618,3,""],[26618,0," which"],[26624,5,""],[26743,0,"update "],[28889,0,"\n"],[28889,0,"\nTh"],[28891,1,""],[28891,0,"ecnhi"],[28895,1,""],[28894,1,""],[28893,1,""],[28893,0,"hnically this is O(log n)"],[28912,0,"n * "],[28922,0,". Teach "],[28924,6,""],[28924,0,"Each insert should "],[28936,0,"*"],[28943,0,"*"],[28936,9,""],[28936,0,"takes "],[28924,18,""],[28924,0,"Inserts slowly "],[28932,7,""],[28932,0,"get gradually slower as our document grows. But in reality, its fast"],[28980,20,""],[28980,0,"ec"],[28981,1,""],[28980,1,""],[28980,0,"because the whole thing fits in CPU cache, it "],[29025,1,""],[29024,1,""],[29023,1,""],[29023,0,"you c"],[29027,1,""],[29027,0,"honestly can't tell in th eb"],[29054,1,""],[29053,1,""],[29052,1,""],[29052,0,"e bne"],[29056,1,""],[29055,1,""],[29055,0,"enhcm"],[29059,1,""],[29058,1,""],[29057,1,""],[29057,0,"chmark data."],[29027,9,""],[29037,22,""],[29027,10,""],[29027,0,"wouldn't know"],[29041,0,"\n\n> rust_perf6.svg"],[28907,25,""],[28890,126,""],[28890,0,"Performance is also smooth as butter. Because "],[28928,8,""],[28928,0,"From rust"],[28928,9,""],[28928,0,"Rust doesn't need a grab"],[28951,1,""],[28950,1,""],[28949,1,""],[28949,0,"arbage collector to track allocations, so "],[28974,0," memory"],[28905,5,""],[28890,103,""],[28890,0,"Performance is smooth as butter. Rust doesn't need a garbage collector to track memory allocations, so"],[28888,0,"\n\nI have no idea how to track "],[28890,28,""],[28889,1,""],[28888,1,""],[28990,2,""],[28990,0,"so there's no big GC spikes. Usin"],[29019,4,""],[29019,0,"Because da"],[29028,1,""],[29027,1,""],[29027,0,"each b-tree node is"],[29019,27,""],[29019,0,"The entire "],[29019,11,""],[29019,0,"I'm not sure what those spikes are. They aren't "],[29055,12,""],[29054,1,""],[29053,1,""],[29049,0," in the time char"],[29057,9,""],[29057,0,"e"],[29057,1,""],[29057,0,"performance"],[29018,54,""],[29037,0,"\n I'm not sure what those spikes in the performance are"],[29039,1,""],[29038,1,""],[29038,0,"I"],[29069,2,""],[29069,0,"are in"],[29075,20,""],[29075,0," "],[29075,1,""],[29074,1,""],[29073,1,""],[29038,35,""],[29038,0,"I'm not sure what those spikes are"],[29037,0,"\n"],[29037,0,"\nNote I'm only g"],[29052,1,""],[29052,0,"showing the WASM version of this code, called from javascript. T"],[29115,1,""],[29115,0,"Performance is 3x better"],[29115,24,""],[29115,0,"I simply haven't written the code"],[29144,4,""],[29144,0,"ntaiv"],[29148,1,""],[29147,1,""],[29146,1,""],[29145,1,""],[29145,0,"ative code"],[29144,7,""],[29132,16,""],[29132,0,"implemented"],[29132,11,""],[29132,0,"instrumented my rust code"],[29148,0,"native "],[29164,0,"."],[29201,0,"\n"],[29166,1,""],[29200,0,"\nNote I'm only showing the WASM version of this code, called from javascript. I simply haven't instrumented my native rust code."],[29038,128,""],[29072,0,"\n"],[29037,1,""],[29071,1,""],[29037,0,"\n"],[29072,128,""],[29038,0,"Note I'm only showing the WASM version of this code, called from javascript. I simply haven't instrumented my native rust code.\n"],[29200,1,""],[29166,0,"\n"],[29089,0," here"],[29038,5,""],[29064,25,""],[29064,0,"performance here"],[29107,7,""],[29185,0,"."],[29175,0,"sml"],[29177,1,""],[29177,0,"all "],[29192,0," They're stable between runs.\n"],[29197,24,""],[29197,0," v"],[29198,1,""],[29198,0,"overlap perfecte"],[29213,1,""],[29213,0,"ly between subsequent runs."],[29107,0," simply"],[29107,7,""],[29107,0," simply"],[29158,23,""],[29158,0,"I wonder what those"],[29194,1,""],[29194,0,"?"],[29158,36,""],[29158,0,"What are those small spikes"],[29209,19,""],[29200,9,""],[29200,0,"perfectly"],[29200,9,""],[29192,8,""],[29192,0,"line up perfectly between "],[29217,1,""],[29218,0,"benchmark "],[29158,27,""],[29158,0,"I wonder what those spikes are"],[29018,0," Actually this entire data set only needs 414"],[29062,1,""],[29061,1,""],[29061,0,"100 allocations"],[29049,0,"(all 260000"],[29057,0," "],[29061,0,") operations "],[29090,0,"em"],[29091,1,""],[29090,1,""],[29090,0,"memory "],[29108,0," in total durin"],[29118,5,""],[29117,1,""],[29117,0,"."],[29063,11,""],[29028,0,"pro"],[29028,3,""],[29019,9,""],[29019,0,"Processing "],[29070,5,""],[29070,0,"calls malloc"],[29087,29,""],[29087,0," times."],[29069,0," ends "],[29070,5,""],[29069,1,""],[29447,6,""],[29447,0,"I"],[32256,0,"\n\nWe can put all the"],[32269,7,""],[32269,0,"a lot of this stuff on one graph, but i"],[32258,50,""],[32258,0,"If I "],[32262,1,""],[32260,2,""],[32258,2,""],[32258,0,"We can put a lot of this stuff on one graph, but i"],[32258,2,""],[32258,0,"I"],[32258,1,""],[32258,0,"We"],[32301,7,""],[32301,0," if it a"],[32308,1,""],[32308,0,"has a log scale, though its pretty min"],[32345,1,""],[32344,1,""],[32323,21,""],[32323,0,"."],[32305,2,""],[32305,0,"I give it"],[32314,4,""],[32327,0," Its re"],[32333,1,""],[32332,1,""],[32332,0,"pretty meaningless, but ou "],[32358,1,""],[32357,1,""],[32356,1,""],[32258,98,""],[32258,0,"We can put a lot of this stuff on one graph if I give it a log scale. Its pretty meaningless, but"],[32356,0,"\n> all_perf.svg"],[32355,0," you can see some features"],[32350,31,""],[32338,0,". And pretty"],[32362,0,"!"],[32338,1,""],[32338,0,", but"],[32343,4,""],[32340,23,""],[32340,0,"nobo"],[32340,4,""],[32340,0,"bugl"],[32343,1,""],[32342,1,""],[32342,0,"t log scales are seriously meaning"],[32359,17,""],[32359,0,"meaningless to humans."],[31680,11,""],[31680,0,". Thats "],[31772,0,"CRDT "],[31782,0," and"],[32338,0,"really "],[32338,7,""],[32344,0," "],[32338,7,""],[32338,0,"remarkable how neatly they stack up like this"],[32359,5,""],[32359,0," it"],[32313,7,""],[32313,0,"use"],[32364,0,"s"],[32368,10,""],[32354,1,""],[32353,1,""],[32353,0," it looks"],[32362,13,""],[32405,0," If"],[32407,1,""],[32406,1,""],[32405,1,""],[32422,0,"\n\n"],[32423,0,"If I use a normal linear scale, yjs and my "],[32463,3,""],[32463,0,"the rust implementation are just "],[32423,73,""],[32422,1,""],[32421,1,""],[32263,158,""],[32262,1,""],[31884,0,"\n"],[31884,0,"\n"],[31884,1,""],[31883,1,""],[32263,0,"\n"],[32263,0,"\n\nWe can put a lot of this stuff on one graph if I use a log scale. Its remarkable how neat it looks, but log scales are meaningless to humans.\n\n> all_perf.svg"],[32263,1,""],[32302,5,""],[32302,0,"chart"],[32274,23,""],[32274,0," everything on"],[31937,5,""],[36730,7,""],[36730,0,"/Sh"],[36732,1,""],[36731,1,""],[36730,1,""],[36730,0,"ShareDB"],[36753,0,"it "],[36765,12,""],[36760,5,""],[36768,0," by leaps"],[36759,18,""],[36759,0," been maintained by a di"],[36782,1,""],[36782,0,"edicated team"],[36795,12,""],[36795,0,"."],[36764,0," ac"],[36756,11,""],[36755,1,""],[36755,0,"s still well used and well"],[36792,21,""],[36792,0," by the people"],[36753,3,""],[36752,1,""],[36752,0," well used, "],[36763,1,""],[36762,1,""],[36762,0," and battle tested"],[36780,50,""],[36780,0,"."],[36753,0,"its "],[36766,0,", well maintained "],[36783,1,""],[38593,0,"out"],[38609,1,""],[38609,0,"ve been"],[39385,0," Yjs's semantics also take slightly morememory"],[39421,10,""],[39421,0,"more memory in practice."],[39385,60,""],[41168,0,"binary "],[41292,0,"mirror the benchmarks I showed above"],[41328,61,""],[41328,0,","],[41328,1,""],[41333,0," I'd like to know"],[41329,21,""],[41352,0,", and it would be fun to find out"],[41401,0,"semantic "],[41420,19,""],[41420,0," worth mentioning."],[41438,2,""],[41439,1,""],[41439,0,"Y"],[41517,1,""],[41598,1,""],[41598,0,", wheras"],[41604,0,"e"],[41654,1,""],[41727,4,""],[41736,0," stores"],[41743,18,""],[43888,0," Although"],[43889,8,""],[43888,1,""],[43888,0,"\n\n"],[43889,1,""],[43888,1,""],[43888,0," I have "],[43889,7,""],[43888,1,""],[43888,0," "],[43888,1,""],[43888,0,"\n\n"],[43889,1,""],[43888,1,""],[43888,0," We'll "],[43888,7,""],[127,0,"\n\n> automerge1.drawio.svg"],[130,1,""],[129,1,""],[129,0,"<img src="],[159,0,">"],[129,31,""],[128,1,""],[127,1,""],[6135,0,"<img src=automerge1.drawio.svg>"],[6166,23,""],[6438,0,"\n<img src=automerge1.drawio.svg>"],[6457,1,""],[6457,0,"2"],[6471,24,""],[10541,0,"\n<img src=automerge1.drawio.svg>"],[10551,17,""],[10551,0,"am_perf1"],[10565,15,""],[18918,0,"\n<img src=automerge1.drawio.svg>"],[18928,17,""],[18928,0,"ref_perf3"],[18943,16,""],[22132,0,"\n<img src=automerge1.drawio.svg>"],[22142,17,""],[22142,0,"yjs_perf4"],[22157,15,""],[22156,1,""],[22309,15,""],[22309,0,"<img src=yjs_perf4.svg>"],[22326,1,""],[22326,0,"5"],[23660,0,"\n<img src=yjs_perf4.svg>"],[23670,17,""],[23689,0,">"],[26403,0,"\n<img src=yjs_perf4.svg>"],[26413,17,""],[26429,0,">"],[29159,0,"\n<img src=yjs_perf4.svg>"],[29169,17,""],[29183,0,">"],[32464,0,"\n<img src=yjs_perf4.svg>"],[32474,17,""],[32486,0,">"],[5329,0,"\n\n"],[5330,1,""],[5329,1,""],[5329,0,"\n\n"],[5331,1,""],[5331,0,"\n"],[5330,1,""],[5329,1,""],[7282,0,"*"],[7222,0,"*"],[7164,0,"*"],[7111,0,"*"],[6401,0,"*"],[6351,0,"*"],[6303,0,"*"],[6260,0,"*"],[6068,0,"*"],[6018,0,"*"],[5975,0,"*"],[7293,0,"*"],[7232,0,"*"],[7173,0,"*"],[7119,0,"*"],[6408,0,"*"],[6357,0,"*"],[6308,0,"*"],[6264,0,"*"],[6071,0,"*"],[6020,0,"*"],[5976,0,"*"],[7303,1,""],[7241,1,""],[7181,1,""],[7126,1,""],[6414,1,""],[6362,1,""],[6312,1,""],[6267,1,""],[6073,1,""],[6021,1,""],[5976,1,""],[7296,0,"*"],[7235,0,"*"],[7176,0,"*"],[7122,0,"*"],[6411,0,"*"],[6360,0,"*"],[6311,0,"*"],[6267,0,"*"],[6074,0,"*"],[6023,0,"*"],[5979,0,"*"],[10665,0,"\n<img src=am_perf1.svg>"],[10683,0,"_smooth"],[10665,0,"\nThe chart is a bit easier to read when we smooth everything "],[10708,18,""],[10708,0,"average everythign out "],[10716,15,""],[10716,0,"everything out a bit - but "],[10736,7,""],[10736,0,". Clearly performance is slowly "],[10761,7,""],[10761,0,"gradually getting wo"],[10761,20,""],[10761,0,"getting gradu"],[10773,1,""],[10773,0,"ually worse over time.\n"],[10738,9,""],[10738,0,"P"],[10749,11,""],[10749,0," gets"],[10132,0,"\n\n\n| Test                              | Time taken | RAM usage |\n|:--------------------------        | ----------:| ---------:|\n| automerge (v1.0.0-preview2)       |  291s      | 880 MB    |\n| **reference-crdts (automerge / yjs)** |   31s      |  28 MB    |\n| JS baseline                       | 0.61s      | 0.1 MB    |"],[10263,0,"**"],[10292,0,"**"],[10328,66,""],[10327,1,""],[10391,229,""],[10390,1,""],[10590,0,"\n\n"],[10591,1,""],[10590,1,""],[10133,1,""],[9809,0,"\n\nThe "],[9811,4,""],[9811,0,"Processing "],[9811,11,""],[9810,1,""],[9809,1,""],[9711,0," Thats about "],[9718,6,""],[9718,0,"just shy of 900 edits per seoc"],[9747,1,""],[9746,1,""],[9746,0,"cond, which is honestly fine"],[9761,13,""],[9761,0,"probably fine. But"],[9779,4,""],[9812,4,""],[9812,0,"is using"],[10774,1,""],[10773,1,""],[10773,4,""],[10825,0," and zoom in"],[10913,0,"\n\n(Note the y "],[10915,12,""],[10914,1,""],[10913,1,""],[10835,2,""],[10835,0,"the Y axis"],[10873,0," (roughly linearly)"],[12823,0,"["],[12827,0,"](https://github.com/yjs/yjs)"],[12904,10,""],[12885,0,"opensource "],[12937,5,""],[12937,0,"I"],[12940,7,""],[15466,0,"\n3. Its much faster, because"],[15470,24,""],[15470,0,"Th"],[15470,2,""],[15470,0,"We can use a much simpler data structure, which makes the algorithm much faster."],[15483,67,""],[15483,0,"flat array to store all the"],[15503,7,""],[15503,0,"everything, rather than a "],[15528,1,""],[15528,0," weird tree."],[15529,5,""],[15529,0,"sp"],[15530,1,""],[15529,1,""],[15528,1,""],[15534,0," This makes "],[15528,0,"n unbalanced"],[15558,0,"everything smaller and faster for the compilt"],[15602,1,""],[15601,1,""],[15600,1,""],[15600,0,"uter to process."],[15844,236,""],[15617,0,"4. Even though the implementation is different, this approach is *semantically* identical to the actual automerge, and yjs and sync9 code. ([Fuzzer verified (TM)](https://github.com/josephg/reference-crdts/blob/main/reference_test.ts))\n"],[16080,171,""],[15853,0,"5. Its faster *and* simpler, which moves the [Pareto efficiency frontier](https://en.wikipedia.org/wiki/Pareto_efficiency). Ideas which do this are rare and truly golden.\n"],[16251,1,""],[16024,0,"\n"],[16252,0,"\n"],[16024,1,""],[16023,0,"\n\n"],[15616,0,"\n2. Doing it this way lets you implement the semantics of multiple CRDTs in the same codebase, if you want to."],[15357,110,""],[15506,0,"\n1. You can implement lots of CRDTs like this. Yjs, Automerge, Sync9 and others all work"],[15269,89,""],[15269,0,"1"],[15418,0,"\n2. The code s"],[15431,1,""],[15431,0,"is i"],[15434,1,""],[15434,0,"simple"],[15434,0,"really "],[15434,7,""],[15434,0,"m"],[15434,1,""],[15434,0,"really "],[15447,0,"."],[15886,10,""],[15886,0,"Being faster"],[15886,169,""],[15883,3,""],[15882,1,""],[15448,0," Being faster *and* simpler, which moves the [Pareto efficiency frontier](https://en.wikipedia.org/wiki/Pareto_efficiency). Ideas which do this are rare and truly golden."],[15476,6,""],[15475,1,""],[15612,1,""],[15612,0,"3"],[15700,110,""],[15699,0,". You can implement ment"],[15722,1,""],[15721,1,""],[15720,1,""],[15720,0,"m"],[15720,1,""],[15720,0,"any lo"],[15725,1,""],[15725,0,"ist CRDT "],[15733,1,""],[15733,0,"s in the same codebase."],[15757,236,""],[15221,0," And even though the code is very different, the Even though the implementation is different, this approach is *semantically* identical to the actual automerge, and yjs and sync9 code. ([Fuzzer verified (TM)](https://github.com/josephg/reference-crdts/blob/main/reference_test.ts))\n"],[15269,44,""],[15266,4,""],[15265,1,""],[15355,0,"bases"],[15459,1,""],[15994,1,""],[15995,3,""],[15995,0,"It does"],[16002,13,""],[15995,7,""],[15995,0,"Ther"],[15998,1,""],[15997,1,""],[15997,0,"ore"],[15999,1,""],[15998,1,""],[15997,1,""],[15997,0,"eoretically this algorithm"],[16122,5,""],[16122,0,"really"],[16024,5,""],[16028,0,"s"],[16203,13,""],[16203,0,"I"],[16218,0," in practice"],[16024,0,"can "],[16032,1,""],[14763,0," in a "],[14767,2,""],[14767,0,"my *reference-crdts*"],[14770,22,""],[14769,1,""],[14771,16,""],[14771,0,"reference-crdts"],[14850,0," codebase."],[14860,40,""],[14769,0," proot "],[14775,1,""],[14774,1,""],[14774,0,"f of concept"],[14770,16,""],[14770,0,"experimental"],[14864,8,""],[14864,0,"library"],[14864,7,""],[14864,0,"codebase"],[14784,0,"*"],[14800,0,"*"],[16363,14,""],[16363,0,"I"],[16363,1,""],[16363,0,"YU"],[16364,1,""],[16363,1,""],[16363,0,"U"],[16383,0," my implementation of automerge's algorithm is"],[16429,8,""],[16451,0," the real"],[16470,1,""],[16470,0,". And its"],[16479,4,""],[16989,9,""],[16989,0,"automerge up"],[17002,0,"\n\nIts a lot faster than "],[17004,22,""],[17003,1,""],[17003,0,"\nIts a lot faster than automerge:\n\nref_vs_am_perf.svg"],[17038,0,"<img src="],[17065,0,">"],[17037,0,"\n![]"],[17041,10,""],[17041,0,"("],[17060,1,""],[17060,0,")"],[17040,0,"Automerge is much slower than reference-crdts"],[33045,9,""],[33045,0,"!"],[29740,9,""],[29740,0,"!"],[26984,9,""],[26984,0,"!"],[24241,9,""],[24241,0,"!"],[22889,9,""],[22889,0,"!"],[22713,9,""],[22713,0,"!"],[19499,9,""],[19499,0,"!"],[10911,9,""],[10911,0,"!"],[10659,9,""],[10659,0,"!"],[6453,9,""],[6453,0,"!"],[6141,9,""],[6141,0,"!"],[32966,0,"["],[29669,0,"["],[26921,0,"["],[24186,0,"["],[22842,0,"["],[22674,0,"["],[19468,0,"["],[10888,0,"["],[10644,0,"["],[6446,0,"["],[6142,0,"["],[32977,0,"]"],[29679,0,"]"],[26930,0,"]"],[24194,0,"]"],[22849,0,"]"],[22680,0,"]"],[19473,0,"]"],[10892,0,"]"],[10647,0,"]"],[6448,0,"]"],[6143,0,"]"],[32988,0,"("],[29689,0,"("],[26939,0,"("],[24202,0,"("],[22856,0,"("],[22686,0,"("],[19478,0,"("],[10896,0,"("],[10650,0,"("],[6450,0,"("],[6144,0,"("],[33011,1,""],[29713,1,""],[26964,1,""],[24229,1,""],[22876,1,""],[22705,1,""],[19496,1,""],[10919,1,""],[10665,1,""],[6473,1,""],[6166,1,""],[33001,0,")"],[29704,0,")"],[26956,0,")"],[24222,0,")"],[22870,0,")"],[22700,0,")"],[19492,0,")"],[10916,0,")"],[10663,0,")"],[6472,0,")"],[6166,0,")"],[10651,0,"automm"],[10656,1,""],[10655,1,""],[10655,0,"moe"],[10657,1,""],[10656,1,""],[10656,0,"erge performance chart"],[10925,0,"automerge performance chart smoothed u"],[10962,1,""],[10962,0,"out"],[6143,0,"treee"],[6147,1,""],[6147,0," with \"abc\" inserts"],[6473,0,"tree with \"aXbc\""],[19587,0,"reference crdts implmentation zoomed in"],[19531,9,""],[19530,1,""],[19539,7,""],[19566,0," Perofr"],[19572,1,""],[19571,1,""],[19570,1,""],[19570,0,"formance gets better near tha "],[19599,1,""],[19598,1,""],[19598,0,"e end when Martin star"],[19616,4,""],[19616,0,"went back to the start of his paper and started editing it."],[19664,8,""],[19664,0,"making edits"],[19676,3,""],[19676,0,"."],[19663,7,""],[19668,1,""],[19668,0,"ing"],[19780,25,""],[19780,0,"Kevin "],[19785,1,""],[19806,0," in Yjs"],[19780,0,"And by \"we\", I mean "],[19856,0,"eK"],[19857,1,""],[19856,1,""],[19856,0,"Kevin solved this problem by thinking about how p"],[19904,1,""],[19904,0,"humans actually edit documents. "],[19949,7,""],[19949,0,"we"],[19951,3,""],[19958,0,"'"],[19951,0,"'"],[19952,7,""],[19952,0,"re typing"],[19961,1,""],[19963,4,""],[19963,0,"we"],[19944,4,""],[19944,0,"while"],[19994,3,""],[19994,0,"a "],[19995,1,""],[19924,0," text"],[20161,5,""],[20160,1,""],[20160,0," later"],[20168,0,"the new "],[20134,0,"The next edit will probably be pretty close to the previous edit"],[20198,98,""],[20198,0,", so Kevin just scans from "],[20220,5,""],[20220,0,"forwards or backwards from the last position"],[20266,80,""],[20265,1,""],[20265,0,"\n\n"],[20266,1,""],[20265,1,""],[20265,0," "],[20296,0," to me"],[20297,5,""],[20296,1,""],[20296,0," to me, b"],[20304,1,""],[20303,1,""],[20302,1,""],[20302,0," - wouldn't Yjs ha"],[20305,15,""],[20304,1,""],[20303,1,""],[20302,1,""],[20303,7,""],[20303,0,"- I mean, thats a big assumption!"],[20336,67,""],[20340,0," apparen"],[20341,7,""],[20340,1,""],[20335,0," to make"],[20376,0,"\n\n(And I'm simplif"],[20378,16,""],[20378,0,"(And I'm simplifying a bit here - Yjs actualy"],[20422,1,""],[20422,0,"ly stores i"],[20432,1,""],[20432,0,"a whole set of cach"],[20378,73,""],[20378,0,"And w"],[20378,5,""],[20378,0,"What i"],[20378,6,""],[20377,1,""],[20376,1,""],[20376,0,"\n\n(And what if two users are editing different parts of a document? Yjs cac"],[20448,3,""],[20448,0,"stores a whole set of cache locations, so there's usually a cached marker location nearby.)"],[20498,0,"almost always "],[20512,7,""],[20511,1,""],[20526,1,""],[20526,0,"cur"],[20521,8,""],[20521,0,"cursor"],[20379,5,""],[20379,0,"W"],[20444,0,"actually "],[20439,0," "],[20439,1,""],[20439,0," I"],[20440,1,""],[20439,1,""],[20439,0," I'm simplifying here -"],[20513,5,""],[20513,0," "],[20513,1,""],[20513,0,". "],[20515,1,""],[20515,0,"T"],[20568,0," no matter where users make changes in the document"],[20706,2,""],[20706,0,"Yjs does that"],[20719,12,""],[21868,6,""],[21868,0,"The algorithm can"],[21953,0," - but that happens any time"],[21960,21,""],[21960,0,"c"],[21960,1,""],[21960,0,"that happens whenever a user types a series of characters without moving their cursor"],[21997,6,""],[21997,0,"run"],[22048,5,""],[22140,5,""],[22140,0,"runs"],[22328,0,"This blows me away but - "],[22352,1,""],[22351,1,""],[22347,4,""],[22347,0,"- "],[22372,4,""],[22372,0,"my "],[22411,0,"thanks to the spans approach "],[23494,0,". Ch"],[23497,1,""],[23496,1,""],[23495,1,""],[23494,1,""],[23517,0,"But "],[23558,6,""],[23558,0,"near the end"],[23604,0,"*"],[23596,0,"*"],[24053,3,""],[24053,0,"Yjs"],[24713,1,""],[24713,0,"\n  "],[24797,1,""],[24797,0,"\n  "],[24798,2,""],[24733,1,""],[24733,0,"\n  "],[24753,1,""],[24753,0,"\n  "],[24773,1,""],[24773,0,"\n  "],[24783,1,""],[24783,0,"\n  "],[24651,9,""],[24651,0,"one of our document items"],[24676,10,""],[27020,0," in the decade since it was released"],[24874,0,"javascript objects fragmented in memory"],[23328,0,"yjs performance a"],[23344,1,""],[23344,0,"vs other oa"],[23354,1,""],[23353,1,""],[23353,0,"alogi"],[23357,1,""],[23356,1,""],[23355,1,""],[23355,0,"gorithms"],[23534,0,"yjs performance isolated"],[27746,0,"b-tree diagram"],[27659,0," This isn't a btreemap"],[27673,8,""],[27672,1,""],[27672,0," "],[27672,1,""],[27671,1,""],[27671,0,"you"],[27673,1,""],[27672,1,""],[27671,1,""],[27671,0,"a "],[27672,1,""],[27672,0,"n ordinera"],[27681,1,""],[27680,1,""],[27679,1,""],[27678,1,""],[27677,1,""],[27677,0,"inary b-tree. Instead of storing offsets,"],[27719,1,""],[27719,0,"e"],[27801,0," This i"],[27807,1,""],[27807,0,"lets u"],[27812,1,""],[27812,0,"the "],[27812,4,""],[27812,0,"us resize children"],[27822,0,"a node's "],[27839,0," with *log n*"],[27849,1,""],[27849,0,"("],[27851,0,")"],[27822,1,""],[27822,0,"the"],[27822,3,""],[27822,0,"any ti"],[27827,1,""],[27826,1,""],[27826,0,"item"],[27830,7,""],[27853,0," mo"],[27855,1,""],[27854,1,""],[27853,1,""],[27845,0,"just "],[27858,0," edits. (We just walk up the "],[27865,22,""],[28222,0," In practice, most of these reads will already be in your CPU's cache."],[28780,0," That codepath doesn't get benchmarked here though - you'll have to tam"],[28850,1,""],[28850,0,"ke my word for it."],[28832,1,""],[28831,1,""],[28830,1,""],[28830,0,". Its fast but for now "],[28904,3,""],[28904,0,"Yjs"],[28935,0," edit"],[28984,1,""],[28983,1,""],[28983,0,"."],[29418,0,"Why 32? "],[29426,14,""],[29426,0,"I ran my"],[29446,1,""],[29445,1,""],[29444,1,""],[29444,18,""],[29444,0," "],[29471,1,""],[29471,0," and"],[29615,0," like in the other tests"],[29670,0,"editing "],[29686,0," just"],[29709,0," This is faster than editing a string in javascript."],[29761,1,""],[29761,0,"\n\n"],[29846,0,"all 260k edits in "],[29885,0," just"],[30564,140,""],[30528,36,""],[30528,0,"Even through webassembly, this code"],[30527,36,""],[29715,46,""],[29715,0,"is 3x faster than editing a native javascript string directly, and its doing a whole lot of extra work to support collaborative editing too!"],[29776,1,""],[29776,0,"!"],[29778,1,""],[29778,0,"A"],[30621,1,""],[30735,0," mysterious"],[30746,4,""],[30758,0,"And because memory is packed in, "],[30780,0,"so "],[30789,3,""],[30791,1,""],[30791,0,"p"],[31039,1,""],[31010,0," have no idea"],[31023,7,""],[31045,0,"."],[31093,0," Maybe the allocator?"],[30782,0," tightly"],[30757,0," We don't care where inserts happen - this system si fas"],[30807,6,""],[30807,0,"is uniformly fast no matter"],[30825,9,""],[30825,0,"across the whole document."],[30758,94,""],[30655,0,"We don't care where inserts happen - this system is uniformly fast across the whole document. "],[30655,0,"The b-tree gives us *log "],[30679,1,""],[30679,0,"(n) p"],[30683,1,""],[30682,1,""],[30682,0," "],[30682,1,""],[30682,0,"* performance for every edit, no matter"],[30655,68,""],[30655,0,"A b-tree doesn't"],[30671,6,""],[30683,7,""],[30683,0,"edits"],[30697,1,""],[30696,1,""],[30695,1,""],[30695,0,". "],[30697,1,""],[30697,0,"T"],[30977,0,"rust per"],[30982,3,""],[30982,0,"implementation in was "],[31003,1,""],[31003,0,"m vs yjs"],[31148,0," But I expect the r"],[31149,18,""],[31149,0,"I expect the rust implementation to look the same "],[31162,37,""],[31162,0,"only change will be the "],[31148,38,""],[31148,0," I don't "],[31149,8,""],[31149,0,"The rust version of this code"],[31149,0,"I don't know why "],[31166,1,""],[31166,0,"t"],[31195,0," is 3x faster. Is it the javascript / WASM i"],[31238,1,""],[31238,0,"bounary"],[31238,7,""],[31238,0,"boundary? Or are the re"],[31260,1,""],[31259,1,""],[31258,1,""],[31258,0,"re optimizations"],[31251,9,""],[31251,0,"does"],[31248,7,""],[31248,0,"Does LLVM make"],[31258,4,""],[31258,0,"have more tricks when"],[31280,13,""],[31280,0,"optimizing native x65"],[31300,1,""],[31299,1,""],[31298,1,""],[31298,0,"x75"],[31300,1,""],[31299,1,""],[31299,0,"65"],[31300,1,""],[31299,1,""],[31299,0,"86 code? Or"],[31147,0,", though I assume its just the same but 3x "],[31147,43,""],[31213,0,"the performance costc "],[31234,1,""],[31233,1,""],[31233,0," coming from "],[31246,3,""],[31261,1,""],[31261,0,"-"],[31261,1,""],[31260,1,""],[31260,0,"-to-"],[31264,1,""],[31341,0," is the s"],[31349,1,""],[31349,0,"wasm virtual machine"],[31345,24,""],[31345,0,"it all the bounds checks wasm needs"],[31370,10,""],[31370,0,"the WASM VM needs? A"],[31389,1,""],[31389,0,"In an"],[31389,5,""],[31389,0,"No matter - its lightning"],[31413,1,""],[31412,1,""],[31412,0,"ng fast."],[31405,0,"truly "],[31405,6,""],[31419,0," anyway"],[31429,0,"And "],[31429,4,""],[31431,34,""],[31431,0,"wonder what those spikes are"],[32290,0,"\n\n"],[32291,1,""],[32290,1,""],[32290,0,"\n\nI figure this is better for mo"],[32321,1,""],[32320,1,""],[32320,0,"lots of use cases, "],[32338,1,""],[32337,1,""],[32337,0," anyway - for e"],[32337,15,""],[32337,0,". For example, if the "],[32355,4,""],[32355,0,"you're editing text in VS Code, the VS Vode "],[32394,5,""],[32394,0,"Code editing i"],[32407,1,""],[32407,0,"environment will need "],[32424,5,""],[32424,0,"have a copy of the document anyway, so there's no i"],[32474,1,""],[32474,0,"need to duplicate everything in the b-tree."],[32506,3,""],[32506,0,"my"],[31812,9,""],[31812,0,"BTree"],[31812,0,"Spanning"],[31819,1,""],[31818,1,""],[31817,1,""],[31816,1,""],[31812,4,""],[32286,226,""],[32478,0,"\n- Lots of use cases will store the co"],[32515,1,""],[32514,1,""],[32514,0,"document content somewhere "],[32541,177,""],[32479,0,"- But when inserting we need to update 2 data structures instead of 1. This makes everything more than twice as slow, and it makes the wasm bundle twice as big (60kb -> 120kb).\n"],[32718,0,"\n- But when inserting we need to update 2 data structures instead of 1. This makes everything more than twice as slow, and it makes the wasm bundle twice as big (60kb -> 120kb)."],[32479,177,""],[32541,0,"else anyway. Eg, if you're using VS c"],[32577,1,""],[32577,0,"Code"],[32564,3,""],[32564,0," hook this up to"],[32580,6,""],[32588,0,", the text content doesn't need to be stored in the CRDT at all."],[32607,0,"probably "],[32642,2,""],[32642,0,"by"],[32664,5,""],[32664,0,"W"],[32834,0,"\n- Lots of use cases will store the document content somewhere else anyway. Eg, if you hook this up to VS Code, the text content probably doesn't need to be stored by the CRDT at all."],[32479,183,""],[32834,0," In that case, its"],[32835,17,""],[32835,0,"Implemented like this, it'd be really east to "],[32880,1,""],[32879,1,""],[32878,1,""],[32877,1,""],[32876,1,""],[32876,0,"y to just turn that code off."],[32891,13,""],[32891,0,"the "],[32886,9,""],[32886,0,"stop storing the content at all"],[32762,0," vs code has"],[32771,3,""],[32771,0,"will have a cop o"],[32787,1,""],[32786,1,""],[32786,0,"y of the document at all times anyway. So"],[32827,34,""],[32827,0," there's no need to "],[32847,12,""],[32852,1,""],[32851,1,""],[32851,0,"e the document in the "],[32873,8,""],[32869,4,""],[32869,0,"my "],[32876,0," structures as well"],[32895,7,""],[32896,84,""],[32896,0," Implemented like this, it'd be really easy to just stop storing the content at all."],[33035,0,"But whatever. "],[33049,1,""],[33049,0,"M"],[33035,14,""],[33147,0," contents"],[34827,2,""],[34827,0,"in a pre"],[34832,3,""],[34832,0,"single, pretty"],[34846,4,""],[34954,0,"all data in one chart"],[34990,0,"\n\nI"],[34992,1,""],[34991,1,""],[34990,1,""],[34990,0,"\n\nRemember "],[35000,1,""],[35000,0,", log scales trick your brain. The data actually looks like this:\n\ntype: 'log', domain: [0.0005, 4], tickFormat: ',',"],[35067,50,""],[35067,0,"![all data in one chart](all_perf.svg)"],[35100,0,"_linear"],[35090,0,", with a linear sscale"],[35106,1,""],[35064,1,""],[35064,0,". Automerge makes everything look fast."],[35066,37,""],[35065,1,""],[35064,1,""],[35064,0,":"],[35064,1,""],[35064,0,". In comparison"],[35065,14,""],[35064,1,""],[35064,0,":"],[34804,0,"\n"],[34804,0,"\n#["],[34806,1,""],[34805,1,""],[34805,0,"@"],[34805,1,""],[34805,0,"#["],[34806,1,""],[34805,1,""],[34805,0,"![](totals.svg)"],[41222,0,"\n"],[41222,0,"\n"],[41222,1,""],[41221,1,""],[41221,0,"\n\nYou can play with the charts"],[41250,1,""],[41250,0,"ing "],[41223,31,""],[41223,0,"The charts were made using Obj"],[41252,1,""],[41252,0,"servableHQ's "],[41264,1,""],[41263,1,""],[41262,1,""],[41244,5,""],[41244,0,"on"],[41247,0,"["],[41260,0,"](https://observablehq.com/@josephg/crdt-algorithm-performance-benchmarks)."],[42054,0,"n"],[42062,1,""],[42062,0," "],[42366,28,""],[42366,0,"You would just need to:"],[42805,0," And "],[42809,1,""],[42808,1,""],[42807,1,""],[42806,1,""],[42805,1,""],[42805,0," "],[42805,1,""],[42805,0," And "],[42806,4,""],[42805,1,""],[42805,0," And RGA has slightly worse ordering semantics in some"],[42818,41,""],[42818,0,"an interleaving problem when prefixing"],[42841,15,""],[42841,0," th"],[42843,1,""],[42842,1,""],[42842,0,"in "],[42844,1,""],[42843,1,""],[42842,1,""],[42842,0,"when pre"],[42821,0,"["],[42842,0,"](https://www.cl.cam.ac.uk/~arb33/papers/KleppmannEtAl-InterleavingAnomalies-PaPoC2019.pdf)"],[42942,0,"fixing"],[42819,1,""],[42818,1,""],[42817,1,""],[42832,7,""],[42832,0,"anomolies"],[42832,9,""],[42832,0,"no"],[42833,1,""],[42832,1,""],[42832,0,"anomalies"],[42947,0,"p"],[42947,1,""],[42938,9,""],[42938,0,"prepending text "],[42953,1,""],[42953,0," "],[42953,1,""],[42953,0,"."],[42817,0," weird"],[42838,9,""],[42838,0,"problems"],[42813,0," can have"],[42822,4,""],[42842,9,""],[42950,4,""],[42950,0,"items"],[42977,56,""],[42977,0," make my code"],[43015,6,""],[43015,0,"for "],[43026,1,""],[43025,1,""],[43025,0,"ing"],[43054,0,"'as"],[43056,1,""],[43055,1,""],[43055,0,"s"],[43073,0,"Your performance "],[43078,12,""],[43078,0,"benchmarks"],[43088,40,""],[43088,0," measure the wron "],[43105,1,""],[43105,0,"g thing"],[43068,0,"\n"],[43210,5,""],[43210,0,". And I' m"],[43219,1,""],[43218,1,""],[43218,0,"m measuring"],[43254,6,""],[43254,0," A"],[43379,3,""],[43378,1,""],[43377,1,""],[43376,1,""],[43376,0,". "],[43378,1,""],[43378,0,"O"],[43483,0," (And automerge is basically"],[43499,12,""],[43499,0,"usually performacn"],[43516,1,""],[43515,1,""],[43514,1,""],[43514,0,"s that well)"],[43525,0,"."],[43525,0," already"],[43536,26,""],[43593,0,"does "],[43613,1,""],[43658,0,"does "],[43680,1,""],[43700,3,""],[43700,0,"How much time it takes"],[43722,11,""],[43743,0," stored"],[44841,6,""],[44863,0," as a community"],[46057,0," Any pruning system should work with all of the algorithms I've shown here."],[46139,17,""],[46139,0,"Each ste"],[46144,3,""],[46144,0,"improvement changes too many"],[46182,9,""],[46962,0," LLVM?"],[46968,19,""],[46983,0," (Although"],[46983,10,""],[47373,12,""],[47369,4,""],[47369,0,"Because its "],[49099,1,""],[49098,1,""],[31166,32,""],[31166,0,"this code runs"],[31184,6,""],[31184,0,"slower through WASM"],[31208,36,""],[31208,0,"it the"],[31211,0,"because "],[31219,3,""],[31218,1,""],[31229,4,""],[31229,0," calls to the "],[31247,9,""],[31247,0," VM are  slo"],[31258,1,""],[31257,1,""],[31256,1,""],[31255,1,""],[31255,0,"slow"],[31271,21,""],[31271,0,"simply"],[31287,1,""],[31286,1,""],[31285,1,""],[31285,0,"e"],[31302,0," better,"],[31309,1,""],[31309,0,", since it can use"],[31309,18,""],[31286,0," & vectorize"],[31414,0," also"],[31455,17,""],[31455,0,"stea"],[31458,1,""],[31457,1,""],[31457,0,"ay put"],[31471,0," subsequent"],[31460,3,""],[31455,5,""],[31454,1,""],[31454,0,"'re "],[31455,3,""],[31455,0,"d"],[31455,1,""],[31454,1,""],[31454,0," don't move between"],[31473,29,""],[31478,0,"s"],[31478,1,""],[31455,10,""],[31455,0,"have exactly the same shape"],[31490,0," benchmark"],[31513,0,"its "],[31520,0," memory"],[31964,1,""],[31963,1,""],[31962,1,""],[31961,1,""],[31960,1,""],[31960,0,"ative"],[31971,8,""],[31979,0," was deleted"],[31971,1,""],[31970,1,""],[31970,0," m"],[31971,1,""],[31970,1,""],[31970,0,"means the "],[31868,0," "],[35071,0,"i"],[35071,1,""],[35071,0,"With a linear scale "],[35091,1,""],[35091,0,"t"],[35100,8,""],[35099,1,""],[34843,0,"\n\nI'"],[34846,1,""],[34845,1,""],[34845,0,"I've been resisting listing op"],[34874,1,""],[34873,1,""],[34872,1,""],[34872,0," the "],[34845,32,""],[34845,0,"But remember, t"],[34859,1,""],[34859,0,"automerge au"],[34870,1,""],[34869,1,""],[34869,0,"and ref-crdts "],[34859,0,"the "],[34887,0,"impleemntations w"],[34887,17,""],[34887,0,"implementations aren't consistentl"],[34920,1,""],[34920,0,". These numbers change a lot "],[34845,0,"I've been generally rse"],[34867,1,""],[34866,1,""],[34866,0,"eiss"],[34869,1,""],[34868,1,""],[34867,1,""],[34867,0,"sisting showing perfomrance n"],[34883,13,""],[34883,0,"performance numbers like this because "],[34921,17,""],[34920,1,""],[34961,17,""],[34961,0,"get slower over time"],[34983,27,""],[34983,0,"They'd be "],[34988,5,""],[34988,0,"re much faster than this with small dco"],[35026,1,""],[35025,1,""],[35025,0,"ocuments, and slower with large n"],[35057,1,""],[35057,0,"documents."],[34845,75,""],[34845,0,"But these totals for"],[34889,37,""],[34889,0," are entirel "],[34893,9,""],[34893,0," extreml"],[34900,1,""],[34900,0,"ely benchmark dependant"],[34926,3,""],[34926,0,"he algorithms are"],[34943,8,""],[34950,15,""],[34950,0," with"],[34994,0,"r"],[34961,0,"er"],[12023,10,""],[12050,0," before its ready."],[12069,3,""],[12069,0,"O"],[12082,3,""],[12082,0,"the code is "],[12091,3,""],[12091,0,"performs nearly the"],[12100,10,""],[12100,0,"almost the same as"],[12118,19,""],[12146,1,""],[12146,0,":\n\n#"],[12149,1,""],[12149,0,"@"],[12149,1,""],[12149,0,"![](am_vs_amrs.svg)"],[12069,78,""],[12069,0,"W"],[12069,1,""],[12069,0,"Swict"],[12073,1,""],[12072,1,""],[12072,0,"tching to this "],[12082,5,""],[12082,0,"the rust back"],[12086,9,""],[12086,0,"automerge-rs backend doesn't make any "],[12120,4,""],[12120,0,"this test any faster."],[12141,21,""],[12141,0," (Though it does use 3x less R"],[12170,1,""],[12170,0,"memory)"],[12141,36,""],[19853,6,""],[19853,0,"does Yjs"],[19861,3,""],[19861,0," "],[19861,6,""],[19861,0," solve the"],[19849,23,""],[19849,0,"How did he manage that?\n\nSo remember, there are two problems"],[19876,33,""],[19876,0," t"],[19877,1,""],[19877,0,"remember, there are two problems to fix:\n\n- How do we find"],[19921,14,""],[19921,0,"If a user inserted at position 100 in the document, how do we find "],[19921,67,""],[19921,0,"How do we find a specific insert position "],[19962,1,""],[19962,0,"?\n- How do we insert content at that location in a fast way?"],[19975,0," efficiently"],[20019,14,""],[19919,1,""],[19919,0,"1."],[19966,1,""],[19966,0,"2"],[19966,1,""],[19965,1,""],[19965,0,"2. "],[20037,4,""],[20037,0,"the first "],[20046,1,""],[20160,11,""],[20160,0,"bounce around"],[20196,0,"Rather than scanning the document each time an edit hape"],[20251,1,""],[20251,0,"pens, "],[20260,31,""],[20267,1,""],[20266,1,""],[20265,1,""],[20265,0,"es"],[20316,0," mae an"],[20322,1,""],[20321,1,""],[20320,1,""],[20319,1,""],[20319,0,"de an"],[20330,1,""],[20329,1,""],[20329,13,""],[20452,0," editing"],[20550,0,"What if edits happn"],[20568,1,""],[20568,0,"en randomly?!"],[20580,1,""],[20580,0," "],[20580,1,""],[20579,1,""],[20579,0,"?! "],[20581,0," But people don't actually edit documents randomly, so "],[20636,5,""],[20727,23,""],[20777,1,""],[20777,0,", so"],[20782,1,""],[20782,0,"t"],[20829,6,""],[20829,0,"near each user"],[20860,5,""],[20860,0,"they're"],[20871,1,""],[20871,0,"ing"],[20725,0," at the same time"],[20784,0,"d"],[20920,0,"Once yjs finds the target insert location, it needs to"],[20974,15,""],[20925,1,""],[20925,0,"Y"],[21033,7,""],[21039,4,""],[21039,0,"solves "],[21045,1,""],[21153,0,"*"],[21158,0,"*"],[21153,6,""],[21153,0,"constnat"],[21160,1,""],[21159,1,""],[21158,1,""],[21158,0,"tan"],[21160,1,""],[21159,1,""],[21158,1,""],[21158,0,"ant"],[21173,0,"has an extra bonus"],[21191,14,""],[21849,4,""],[21849,0,"So"],[21897,0," too"],[21911,29,""],[21932,0,", just stored more compactly"],[22077,0," internal"],[22124,4,""],[22124,0,"U"],[22165,5,""],[22165,0," o"],[22166,1,""],[22166,0,"document"],[22193,0," using t"],[22200,1,""],[22199,1,""],[22198,1,""],[22197,1,""],[22196,1,""],[22195,1,""],[22194,1,""],[22193,1,""],[22216,0," using this trick"],[22327,0,"conveniently "],[22423,0," And that happens a lot."],[22809,0," in this test"],[22822,1,""],[22822,0,"."],[22824,3,""],[22824,0,"And"],[22828,6,""],[22828,0,"because"],[22828,30,""],[36732,26,""],[36732,0,"what some of my fie"],[36750,1,""],[36749,1,""],[36749,0,"riends"],[36732,23,""],[36732,0,"what some friends would"],[36742,0,"of my "],[36732,29,""],[36732,0,"the reactions of some of my friends"],[36735,0," ridicule"],[36744,13,""],[36744,0," from"],[38902,0," list"],[38912,15,""],[38912,0," implementation"],[39527,0,"\n\nAutomerge is also in the process of dramatically improving performance based on "],[39529,0,"The "],[39533,1,""],[39533,0,"a"],[39542,0," team is also fantastic. They've been receptive to a lo"],[39567,30,""],[39567,0,"I've chatted with them about a lot of these issues and they're "],[39630,9,""],[39683,9,""],[39683,0,"using these tricks. I"],[39703,1,""],[39703,0,"By the time your ea"],[39703,19,""],[39703,0,"In a "],[39703,5,""],[39702,1,""],[39702,0," Performance might have impro"],[39726,5,""],[39726,0,"dramatically"],[39703,0,"Automerge "],[39713,1,""],[39713,0,"p"],[39748,0," improved by the time"],[39758,11,""],[39758,0,"between whe"],[39768,1,""],[39767,1,""],[39766,1,""],[39766,0,"time time I"],[39766,11,""],[39766,0,"the time I wrote this and"],[39758,33,""],[39758,0,"by the time you're reading this too."],[39572,33,""],[39572,0,"had some great conversations with them about "],[39629,0,". They care about '"],[39635,0,"'"],[39636,12,""],[39636,0,"re making performance then "],[39662,1,""],[39661,1,""],[39661,0," #1 issue of 2021 "],[39679,2,""],[39691,18,""],[39691,0,"planning on using a lot of these tricks to "],[39734,53,""],[39734,0,"make the"],[39739,3,""],[39739,0,"automerge fast."],[39753,1,""],[39755,55,""],[39755,0,"It might already be much faster "],[39819,3,""],[39818,1,""],[39856,0,"there's a lot of work that"],[39856,26,""],[39856,0,"I'll probably"],[39869,16,""],[39932,0," and automerge"],[40138,0,", editor bindings"],[40167,19,""],[40166,1,""],[39880,0," it"],[39950,0," Good CRDT libraries need a "],[39951,27,""],[39951,0,"There's "],[39958,1,""],[39957,1,""],[39956,1,""],[39956,0," is a lot more that goes into a good CRDT library than speed."],[40017,84,""],[40017,0," CRDT libraries also need to support"],[40053,10,""],[40090,12,""],[40098,0," data"],[40655,0,"all benchmarks are lies"],[40678,55,""],[40678,0,", and I'm not immune"],[40646,0,"Well, "],[40652,1,""],[40652,0,"y"],[40660,0," "],[40660,1,""],[40661,44,""],[40646,15,""],[40646,0,"Well, yes. But"],[40613,31,""],[40613,0," Lies, damned lies and benchmarks"],[40648,14,""],[40647,1,""],[40646,1,""],[40646,0,"\n\nIs this for real? Yes, but .."],[40676,1,""],[40675,1,""],[40674,1,""],[40674,0,"..."],[40678,0,"\nFirst, "],[40686,2,""],[40686,0,"i"],[40669,0,". And hopefully this is all reproducable."],[40710,1,""],[40711,1,""],[40711,0,"B"],[40670,47,""],[40670,0," But I'm not telling the full picture here."],[40675,0,"pefo"],[40678,1,""],[40677,1,""],[40677,0,"rofmr"],[40681,1,""],[40680,1,""],[40679,1,""],[40678,1,""],[40678,0,"formance is complicated and "],[40816,0,"you can but "],[42356,11,""],[42356,0,"A"],[42351,0,"\n"],[42357,3,""],[42357,0,"Is it fair"],[42357,10,""],[42357,0,"Are CRDT and "],[42361,9,""],[42361,0,"Yjs "],[42361,0,"Automerge and "],[42379,31,""],[42379,0,"doing the same thing? IS it"],[42405,1,""],[42404,1,""],[42403,1,""],[42402,1,""],[42401,1,""],[42400,1,""],[44077,20,""],[44472,0,", a"],[44474,1,""],[44474,0,"barring some unlucky GC pauses"],[45624,3,""],[45624,0,"an"],[45606,4,""],[45606,0,"stores"],[45644,63,""],[45644,0,"The result is that"],[45662,8,""],[45749,0," This uses extra RAM, that none o "],[45782,1,""],[45782,0,"f the other"],[45769,24,""],[45769,0," for a sweet feature, which none of the other implementations"],[45644,0,"As a "],[45649,4,""],[45655,0,","],[45656,8,""],[45725,0," in question"],[45775,61,""],[45775,0,"."],[45761,0,"justifyable "],[45772,1,""],[45771,1,""],[45770,1,""],[45770,0,"ly "],[45767,1,""],[45767,0,"i"],[45794,0,"\nThere's a performance mesa"],[45820,1,""],[45819,1,""],[45819,0,"ausre"],[45817,7,""],[45817,0,"measure nobody is taking seriously enough at the moment. And ti"],[45879,1,""],[45878,1,""],[45878,0,"that is, "],[45886,1,""],[45885,1,""],[45885,0,", "],[45795,92,""],[45795,0,"There's a performance measure nobody is taking seriously enough at the moment. And that is,"],[45886,80,""],[45886,0," "],[45919,0," (in a database)"],[45990,0,"And "],[45994,1,""],[45994,0,"u"],[46015,0,"are actually interat"],[46034,1,""],[46034,0,"cting with "],[46045,4,""],[46044,1,""],[46219,13,""],[46219,0,"isn't very"],[46225,4,""],[46225,0,"often useful"],[46124,0,"."],[46126,6,""],[46126,0,"T"],[46221,13,""],[46221,0,"how we should interact wti"],[46246,1,""],[46245,1,""],[46245,0,"ith this sort of data."],[46125,142,""],[47052,11,""],[47052,0,"step in this sto"],[47065,3,""],[47065,0,"journey"],[47213,0,"implementation "],[47228,12,""],[47234,1,""],[47234,0,"d"],[47235,3,""],[47560,11,""],[47560,0,"all of thes"],[47567,4,""],[47567,0,"t"],[47564,4,""],[47564,0,"this"],[47574,10,""],[47574,0,"I'm "],[47577,1,""],[47582,1,""],[47582,0,"sing"],[47590,11,""],[47590,0," "],[47607,0," should be distributed"],[47641,19,""],[47641,0," those changes"],[47884,0,"'s optimizer"],[47912,0," (Though if "],[47920,4,""],[47920,0," the fact automerge-rs is still pretty so"],[47960,1,""],[47960,0,"low"],[47945,18,""],[47945,0,"n't any faster than automerge gives me some confidence)"],[47999,0,"."],[47999,0," that its not just rust"],[47914,8,""],[47914,0,"T"],[47914,102,""],[47898,0,"\nThe fact automerge-rs isn't any faster than automerge gives me some confidence that its not just rust."],[47907,0," that"],[47931,4,""],[48002,0," But honestly"],[48015,1,""],[48015,0," "],[48031,1,""],[48030,1,""],[48029,1,""],[48028,1,""],[48028,0,"."],[40823,0,". "],[40824,1,""],[40823,1,""],[40823,0,": (Though"],[40878,1,""],[40878,0,")"],[40861,12,""],[40866,0,"."],[40832,4,""],[40823,1,""],[40823,0,"."],[40826,6,""],[40826,0,"But"],[40825,1,""],[40859,1,""],[1327,4,""],[1327,0,"their"],[1362,28,""],[1362,0,"S"],[1369,0," smart"],[1369,6,""],[1369,0," smart"],[1369,6,""],[1362,1,""],[1362,0,"s"],[1362,0,"The annoying part was that "],[1365,9,""],[1365,0," infuriating"],[2903,0," someone out "],[2874,6,""],[2866,8,""],[2866,0,"somebody will find"],[2920,0,"there will write a"],[2938,7,""],[2960,1,""],[4708,3,""],[4708,0,"Thats"],[21087,25,""],[21087,0,"using "],[21106,0," instead of an array"],[21128,24,""],[21128,0,"L"],[21147,7,""],[21153,0,"s"],[21128,0,"Ao lo"],[21132,1,""],[21131,1,""],[21130,1,""],[21129,1,""],[21128,1,""],[21128,0,"so lon"],[21128,6,""],[21128,0,"So long as we have an insert position, "],[21167,1,""],[21167,0,"l"],[21186,8,""],[21186,0,"us to insert "],[21186,6,""],[21192,0,"s"],[21094,0," bidirectional"],[21200,0,"th"],[21201,1,""],[21200,1,""],[21231,36,""],[21231,0,"does one more thing to makep"],[21258,1,""],[21254,4,""],[21254,0,"improve perofrman"],[21262,9,""],[21262,0,"performance"],[21273,1,""],[21273,0,"."],[21275,9,""],[21275,0,"H"],[21281,0," usually"],[21316,1,""],[21316,0,"."],[21318,1,""],[21318,0,"W"],[21317,0," So"],[21320,2,""],[21320,0," w"],[21916,4,""],[21916,0,"F"],[22026,161,""],[22025,1,""],[22229,13,""],[22336,133,""],[22338,5,""],[22338,0,"I"],[22346,12,""],[22345,1,""],[22356,4,""],[22356,0,"using space"],[22366,1,""],[22365,1,""],[22365,0,"ns"],[22367,7,""],[22398,16,""],[22397,1,""],[22390,0,"array "],[22403,6,""],[23072,0," oni "],[23076,1,""],[23075,1,""],[23074,1,""],[23073,1,""],[23073,0,"in this test"],[23153,1,""],[23153,0,"."],[23155,3,""],[23154,1,""],[23155,1,""],[23155,0,"I"],[23124,9,""],[23355,0," Look -"],[23370,0," even"],[23356,7,""],[23881,16,""],[23881,0,"Kevin"],[23881,5,""],[23881,0,"Or when the user"],[23931,0,"Bu"],[23932,1,""],[23931,1,""],[23931,0,"This is neat, but "],[23949,1,""],[23949,0,"t"],[26311,19,""],[26311,0,"more information"],[26343,2,""],[26343,0,"of"],[26360,0,"We want"],[26367,2,""],[26401,5,""],[26401,0,"to"],[26702,42,""],[26702,0,"thats "],[26702,6,""],[26702,0,"Thats probably no "],[26719,1,""],[26719,0,"t a big ea"],[26728,1,""],[26727,1,""],[26727,0,"deal in text editing"],[26789,0," use"],[26851,4,""],[26851,0,"slow"],[26855,9,""],[26986,6,""],[26986,0,"exotic "],[27304,20,""],[27304,0,"is very clever"],[27318,6,""],[27323,0," its not "],[27332,10,""],[27342,3,""],[27342,0,"microoptimization"],[27342,17,""],[27342,0,"small"],[27342,5,""],[27342,0,"clever"],[27412,0," at all"],[27413,6,""],[27412,1,""],[27401,0,"'"],[27383,0,"'"],[27384,18,""],[27384,0,"re not limited to"],[27401,1,""],[27412,0," here"],[27412,5,""],[27449,0,"'"],[27449,1,""],[27770,3,""],[27770,0,"the"],[27780,1,""],[27780,0,"\n\nUsually when people talk about b-trees they meana  "],[27832,1,""],[27831,1,""],[27830,1,""],[27830,0," a BTreeMap "],[27841,1,""],[27841,0,". But my implementation"],[27864,4,""],[27864,0," insn"],[27868,1,""],[27867,1,""],[27866,1,""],[27866,0,"sn't"],[27870,6,""],[27842,0," Thats not what I'm doing here."],[27873,48,""],[27893,7,""],[27893,0,"keys"],[27980,0," (recursively)"],[28009,34,""],[28009,0,"do insertions and delete"],[28032,1,""],[28032,0,"ions in"],[28049,6,""],[28049,0,"time, while updating the position of every character in the wole docu"],[28109,9,""],[28109,0,"whole document. It "],[28127,1,""],[28126,1,""],[28125,1,""],[28124,1,""],[27833,0,"["],[27842,0,"](https://doc.rust-lang.org/std/collections/struct.BTreeMap.html)"],[28009,21,""],[28009,0,"number of characters in that"],[28053,14,""],[28009,0,"totall "],[28015,1,""],[28014,1,""],[28014,0," "],[28118,71,""],[28118,0,"."],[28073,0," find any imt"],[28085,1,""],[28084,1,""],[28084,0,"tem by characte"],[28074,25,""],[28074,0,"look up any item by b"],[28094,1,""],[28094,0,"character position,"],[28113,3,""],[28123,1,""],[28122,1,""],[28121,1,""],[28120,1,""],[28120,0," or"],[28120,0,","],[28120,1,""],[28124,3,""],[28123,1,""],[28132,1,""],[28131,1,""],[28130,1,""],[28129,1,""],[28129,0,"e"],[28035,0," (recursively)"],[28075,4,""],[28075,0,"So we can"],[28084,8,""],[28101,0," in the document"],[28140,0," or"],[28161,0,"all "],[28160,0," anywhere in th edocument"],[28175,1,""],[28176,0," "],[28186,4,""],[28241,0,"\n"],[28241,0,"\n> Does this have a name? I've been calling it a \"range tree\", but that name see"],[28318,3,""],[28318,0,"is ["],[28321,1,""],[28321,0,"[taken by another al"],[28339,2,""],[28339,0,"data structure](https://en.wikipedia.org/wiki/Range_tree)"],[28308,0,"I think "],[28315,1,""],[28314,1,""],[28313,1,""],[28312,1,""],[28311,1,""],[28310,1,""],[28309,1,""],[28308,1,""],[28308,4,""],[28308,0,"I think that"],[35329,0,"\n"],[35329,0,"\nThe total "],[35330,10,""],[35330,0,"I"],[35330,1,""],[35330,0,"In this benchmark the average"],[35330,29,""],[35330,0,"The number of operations per second looks like this"],[35330,3,""],[35330,0,"In this benchn"],[35343,1,""],[35343,0,"mark the"],[35362,10,""],[35362,0,"edits each algorithm can process"],[35421,0,":"],[35444,0," reem"],[35448,1,""],[35447,1,""],[35447,0,"member,"],[35455,17,""],[35445,10,""],[35445,0,"particularly for "],[35485,0,", these perorman"],[35493,8,""],[35493,0,"performance numbers"],[35563,3,""],[35563,0,"run"],[35631,0," "],[35631,1,""],[35631,0," And in the case of automerge, it may be able to do about 900 edits per second"],[35680,2,""],[35680,0,"process"],[35714,0," *on average*, but the slowest edit during this benchmark took "],[35772,5,""],[35772,0,"stalle "],[35778,1,""],[35778,0,"d the jav"],[35780,7,""],[35780,0,"javascript for 1.8 *"],[35799,1,""],[35799,0,"seconds."],[35780,10,""],[35780,0,"V8"],[35772,0,"entirely "],[35772,9,""],[35772,0,"completely "],[35546,1,""],[35546,0," because"],[35554,4,""],[35554,0," the"],[35570,45,""],[35570,0,"slow down as the document grows"],[35601,22,""],[35632,0," although"],[35644,15,""],[35644,0," can"],[35697,4,""],[35736,0," run"],[35740,11,""],[35768,0," In a res"],[35776,1,""],[35776,0,"al usage "],[35778,7,""],[35778,0," appli"],[35774,10,""],[35774,0,"web application this woudl"],[35799,1,""],[35798,1,""],[35798,0,"ld make the whole webpage hang "],[35828,1,""],[35828,0,"."],[35816,8,""],[35816,0,"app"],[35818,1,""],[35817,1,""],[35816,1,""],[35816,0,"web app "],[10839,4,""],[10838,1,""],[10838,0," Its "],[10839,4,""],[10839,0,"This chart averaes"],[10856,1,""],[10855,1,""],[10855,0,"ges over "],[10767,97,""],[10767,0,"That big spike? A group of 1000 edits took over 3.5 seconds to process. This chart averages over"],[10783,80,""],[10783,0,"It happened because a single edit took *1.2"],[10825,1,""],[10825,0,"8 seconds* to process. (Presumably"],[10849,10,""],[10848,1,""],[10847,1,""],[10817,4,""],[10817,0,"was processing for"],[10849,12,""],[10849,0,". Of"],[10852,1,""],[10852,0,"f"],[10852,1,""],[10852,0,"of. In a real application that would feel like the whole website freezing up for a couple of seconds hli"],[10955,1,""],[10954,1,""],[10953,1,""],[10953,0,"while you're trying "],[10966,7,""],[10966,0,"in the middle of typing."],[10783,21,""],[10783,0,"A"],[10863,33,""],[10863,0,"means the whole applicatoin"],[10889,1,""],[10888,1,""],[10887,1,""],[10887,0,"ion would"],[10904,1,""],[10903,1,""],[10902,1,""],[10902,0,"e"],[10903,3,""],[10862,6,""],[10862,0," would translate to"],[10863,6,""],[10872,0,"s"],[10898,6,""],[10904,1,""],[10904,0,"ing up"],[10863,11,""],[10863,0,"would translate to "],[10879,3,""],[10863,22,""],[10863,0,"would result in the"],[10863,15,""],[10863,0,"means"],[10890,0," would"],[10904,1,""],[10903,1,""],[10902,1,""],[10901,1,""],[10901,0,"e"],[10901,1,""],[10901,0,"ze"],[10930,0," sometimes"],[10954,17,""],[10879,11,""],[10879,0,"app"],[10883,0,"("],[10883,1,""],[10883,0,"(or browser tab) "],[10939,10,""],[10952,0," in the middle of"],[10939,0," sometimes"],[11075,0,"We can see the "],[11090,1,""],[11090,0,"p"],[11090,0,"average "],[10858,11,""],[35486,19,""],[35486,0,"T"],[35489,0," average"],[35540,0," in this test"],[35489,24,""],[35489,0," speed of processing edits"],[35496,3,""],[35496,0,"each algorithm "],[35520,1,""],[35519,1,""],[35518,1,""],[35518,0,"es"],[35526,51,""],[35565,0," remember -"],[35566,0,"these numbers are misleading. "],[35596,29,""],[35596,0,"In a"],[35596,0,"Remember, "],[35606,1,""],[35606,0,"i"],[35606,3,""],[35629,84,""],[35630,0,"gradually "],[35673,46,""],[35673,0,"Automerge can "],[35735,0," but"],[35673,0,"And even though "],[35689,1,""],[35689,0,"a"],[35826,61,""],[35486,0,"A"],[35486,1,""],[35486,0,"We can make a chart showing "],[35514,1,""],[35514,0,"t"],[35554,16,""],[35641,0," aren't steady. They"],[35661,10,""],[35661,0,"'re fast at first "],[35678,1,""],[35678,0,", then "],[35684,1,""],[35797,3,""],[35796,1,""],[35854,0," a full"],[35808,0," single"],[35808,7,""],[35801,7,""],[35800,1,""],[35800,0,"re was an"],[35806,3,""],[35802,4,""],[35800,2,""],[35800,0," slowest"],[35518,0,"average "],[35803,0," (wh"],[35806,1,""],[35805,1,""],[35804,1,""],[35804,0,"(which f"],[35811,1,""],[35811,0,"is fast enough that users's "],[35838,1,""],[35837,1,""],[35836,1,""],[35835,1,""],[35835,0,"s won't notice)"],[35929,0," "],[35929,1,""],[35851,0," memory usage pac"],[35867,1,""],[35866,1,""],[35866,0,"eaked at 2.6GB and"],[9939,0," The peak memory usage is "],[9940,25,""],[9940,0,"At peak, automerge u"],[9959,1,""],[9949,10,""],[9949,0,"the benchmark used 2.6 GB of RAM."],[9962,5,""],[9962,0," needed"],[9534,0,"v"],[9534,1,""],[9534,0,"v"],[9550,0,"v"],[9550,1,""],[9548,1,""],[9549,0,"v"],[9549,1,""],[35897,0,"in this test "],[35936,0," "],[36021,0," I "],[36023,1,""],[36022,1,""],[36022,0,"My test be"],[36031,1,""],[36030,1,""],[36025,5,""],[36025,0,"workstation has CPU and RAM for days, but your users w"],[36078,1,""],[36078,0,"w"],[36078,1,""],[36078,0,"don't."],[36021,63,""],[35897,47,""],[36316,0,"\n"],[37233,0," write "],[37234,6,""],[37234,0,"optimize"],[37320,26,""],[37320,0,"wa"],[37321,1,""],[37321,0,"hat "],[37311,25,""],[37318,2,""],[37318,0,"normal"],[37325,0," (Howls o"],[37327,7,""],[37327,0,"l"],[37327,1,""],[37327,0,"Laughter of my friends notwithstanding)"],[37365,0,"."],[37318,6,""],[37318,0,"ok"],[37323,38,""],[37323,0,"Despite what my feien"],[37343,1,""],[37342,1,""],[37341,1,""],[37340,1,""],[37340,0,"riends would have you think"],[37367,1,""],[37367,0,"!"],[37366,1,""],[37365,1,""],[37364,1,""],[37363,1,""],[37362,1,""],[37361,1,""],[37360,1,""],[37359,1,""],[37358,1,""],[37357,1,""],[37356,1,""],[37355,1,""],[37354,1,""],[37353,1,""],[37352,1,""],[37351,1,""],[37350,1,""],[37349,1,""],[37348,1,""],[37347,1,""],[37347,0,"think"],[37890,0," between wp"],[37900,1,""],[37899,1,""],[37899,0,"people with "],[37911,76,""],[37910,1,""],[38907,0,". Fr"],[38910,1,""],[38910,0,"or all O"],[38917,1,""],[38917,0,"of Kevin's "],[38909,19,""],[38909,0,"Kevin is "],[38909,9,""],[38909,0,"For all of Kevin's "],[38909,19,""],[38909,0,"Yjs is excellent in part because"],[38909,32,""],[38909,0,"Kevin adapt"],[38915,5,""],[38914,1,""],[38913,1,""],[38912,1,""],[38911,1,""],[38910,1,""],[38909,1,""],[38908,1,""],[38907,1,""],[38908,0," k"],[38909,1,""],[38909,0,"Kevin"],[38909,5,""],[38909,0,"Yjs's "],[38914,1,""],[38913,1,""],[38912,1,""],[38912,0," owes its serialization"],[38913,22,""],[38913,0,"adapted"],[38912,8,""],[38909,0,"Kevin copied it "],[38909,19,""],[38908,1,""],[31851,0," Remember, the WASM version s"],[31879,1,""],[31879,0,"(shown here) is "],[31895,33,""],[31905,12,""],[31895,0,"still "],[31911,0,"than how"],[31916,3,""],[31916,0,"the speed this code runs nativelay"],[31949,1,""],[31948,1,""],[31948,0,"y"],[31950,0," I wonder why?"],[31965,13,""],[31965,0,"Are th"],[31970,1,""],[31969,1,""],[31968,1,""],[32000,4,""],[32119,13,""],[32119,0,"I"],[32119,1,""],[32119,0,"No matter - i"],[32283,0," requesting morem"],[32299,1,""],[32299,0," memory form "],[32311,1,""],[32310,1,""],[32309,1,""],[32308,1,""],[32308,0,"rom "],[32259,5,""],[32259,0,"t"],[32280,0,"is "],[32253,58,""],[32253,0,"I suse"],[32258,1,""],[32258,0,"pect its the"],[32263,7,""],[32263,0,"the memory allocator"],[32273,10,""],[32266,7,""],[32263,3,""],[32263,0,"its the"],[32266,4,""],[32262,4,""],[32258,4,""],[32258,0,"e"],[32254,5,""],[32253,1,""],[32253,0,"Maybe the memory allocator is requesting more memory from "],[32282,1,""],[32280,2,""],[32259,1,""],[32259,0,"its t"],[32311,1,""],[32308,3,""],[32308,0,"orm "],[32311,1,""],[32306,5,""],[32299,7,""],[32299,0,"m"],[32294,6,""],[32283,11,""],[32000,0," are"],[32000,4,""],[32253,5,""],[32253,0,"Its probably"],[32265,4,""],[32286,1,""],[32286,0,"."],[31951,10,""],[31951,0,"W"],[31753,0," performance through"],[31778,17,""],[31778,0," in the"],[31784,1,""],[31784,0,"is chart"],[31869,0,"And "],[31873,1,""],[31873,0,"r"],[31883,79,""],[31883,0,"this is the slow version. The code runs 3x faster "],[31923,0,"another "],[31951,0,"But "],[31955,1,""],[31955,0,"w"],[32114,11,""],[32114,0,"I"],[32115,2,""],[32114,0,"Mayb "],[32118,1,""],[32118,0,"e it doesn't matter too much - "],[32149,1,""],[32149,0,"i"],[32271,0,"I assume its"],[32283,12,""],[32271,10,""],[32271,0,"I"],[32274,0," probably"],[31909,3,""],[31909,0,"When I run this benchmark natively it"],[31946,5,""],[31969,9,""],[31952,7,""],[31951,1,""],[31961,0," again"],[31962,5,""],[31961,1,""],[31961,0," than this"],[32171,3,""],[32171,0,"the code is"],[31652,5,""],[31652,0,"needs"],[31657,7,""],[31662,0," calls to malloc"],[31678,6,""],[31652,5,""],[31652,0,"makes"],[32638,0,"Note: "],[33483,0,"For "],[33487,1,""],[33487,0,"l"],[33504,5,""],[33504,0," we'll end up"],[33522,1,""],[33522,0,"ing"],[33483,3,""],[33483,0,"In"],[33483,2,""],[33483,0,"For"],[33570,2,""],[33570,0,"For example"],[33599,0," CRDT"],[33620,7,""],[33620,0,"the editor"],[33636,4,""],[33636,0,"keep"],[33755,0,", at all"],[33765,83,""],[33765,0,"This implementation approach makes it easy to just turn that part of the code off."],[33902,0,"But regardless, "],[33918,1,""],[33918,0,"m"],[19104,0,"'"],[19945,0,"w"],[19945,1,""],[19945,0,"e"],[2658,0,"'"],[3489,0,"'"],[4739,0,"'"],[5084,0,"'"],[5249,0,"'"],[5247,4,""],[5247,0,"Automerge is"],[7427,3,""],[7427,0,"This is"],[8152,3,""],[8152,0,"i'"],[8153,1,""],[8153,0,"t's"],[9874,0,"'"],[12313,0,"'"],[12727,0,"'"],[12998,0,"'"],[12998,1,""],[12998,0,"'"],[12998,1,""],[12727,1,""],[12727,0,"'"],[12727,1,""],[12313,1,""],[12313,0,"'"],[12727,0,"'"],[13294,0,"'"],[13505,0,"'"],[14303,0,"'"],[14448,0,"'"],[14868,0,"'"],[14924,0,"'"],[16554,0,"'"],[16840,0,"'"],[17369,0,"'"],[22821,0,"'"],[23382,0,"'"],[23664,0,"'"],[24030,0,"'"],[24827,0,"'"],[24834,0," a"],[25463,0,"'"],[27567,0,"'"],[29578,0,"'"],[30079,0,"'"],[30530,0,"'"],[32350,0,"'"],[32957,0,"'"],[35076,0,"'"],[36252,0,"'"],[36252,1,""],[36252,0,"'"],[36275,2,""],[36275,0,"this"],[36270,4,""],[36270,0,"tiy"],[36272,1,""],[36272,0,"dy"],[37073,0,"'"],[41132,0,"'"],[41775,0,"'"],[44440,0,"'"],[48705,0,"'"],[49145,0,"'"],[12999,0,"  "],[13000,1,""],[12999,1,""],[28446,0,"\n"],[28446,0,"\nIn "],[28447,3,""],[28447,0,"This example shows a docuen"],[28473,1,""],[28472,1,""],[28472,0,"ment with 1000 charat"],[28492,1,""],[28492,0,"cters"],[28477,0,"which currently has "],[28497,5,""],[28512,0,"."],[28512,1,""],[28512,0,":"],[28466,0,"the tree storing "],[28841,4,""],[28841,0,"5"],[28892,0," In th e"],[28899,1,""],[28898,1,""],[28898,0,"e examlpe abo"],[28900,11,""],[28900,0,"example above, we "],[28841,1,""],[28841,0,"2"],[28915,3,""],[28915,0,"the item with position 200 must be in the "],[28938,3,""],[28938,0,"345"],[28940,1,""],[28939,1,""],[28939,0,"50"],[28957,0,"middle node in the in"],[28964,14,""],[28964,0,"leaf node here."],[29079,0," in this benchmark"],[30036,0," Unlike in the diagram,"],[30060,1,""],[30060,0,"e"],[30287,10,""],[30287,0,"CPUs can copy several"],[30332,0,"Its "],[30336,1,""],[30336,0,"n"],[30395,0," entries"],[30411,2,""],[30411,0,"this"],[30447,0,"bucket "],[30697,0," Thats 5x faster than yjs, and"],[30727,8,""],[30727,0," m"],[30728,1,""],[30728,0,"remarkably"],[30788,10,""],[30788,0,", "],[30789,1,""],[30788,1,""],[30788,0,"."],[30722,1,""],[30722,0,"."],[30724,4,""],[30724,0,"And "],[30754,0,"our baseline test "],[30806,1,""],[30806,0,", despite"],[30815,9,""],[30822,36,""],[30822,0,"all the work to support"],[30867,4,""],[30870,5,""],[30870,0,"I"],[30870,1,""],[30870,0,"And i"],[30870,5,""],[30870,0,"I"],[30884,2,""],[30884,0,"this benchmark"],[30918,0,"["],[30945,0,"](https://github.com/josephg/text-crdt-rust/blob/ba20b6386c0472958f33024ce0b806e75470e1ca/benches/yjs.rs)"],[36122,12,""],[36122,0,"calculate"],[36131,8,""],[36344,5,""],[36344,0,"E"],[37087,0," As Ive"],[37093,1,""],[37092,1,""],[37092,0,"'ve shown,"],[37103,1,""],[37103,0,"w"],[10831,14,""],[10831,0,"In the big spike"],[10831,16,""],[10831,0,"In the slowest spike near the end,"],[10865,1,""],[10866,1,""],[10866,0,"a"],[10880,18,""],[10880,0,"took"],[10898,0," to process"],[10937,0,","],[12412,0," (Although it does smooth out pre"],[12444,1,""],[12443,1,""],[12443,0,"erformance)"],[12431,0,"halve memory usage and "],[12477,0,"."],[12477,1,""],[12476,0,"."],[12391,9,""],[12391,0,"average perofma"],[12405,1,""],[12404,1,""],[12403,1,""],[12402,1,""],[12402,0,"formance in this test"],[45279,5,""],[47003,1,""],[47003,0,"one other"],[47033,0,"I think "],[47206,5,""],[47206,0,"U"],[47599,4,""],[47599,0,"for"],[47817,0,"There's another per"],[47835,1,""],[47834,1,""],[47833,1,""],[47833,0,"aprp"],[47836,1,""],[47835,1,""],[47835,0,"proach to making CRDTs fast, which is pruning. Essentially, "],[47881,52,""],[47881,0," "],[47869,0," I haven't mentioned here at all and that"],[47914,0,"*"],[47922,0,"*"],[47925,0,"By e"],[47928,1,""],[47928,0,"default, list "],[47953,4,""],[47953,0,"e"],[47953,1,""],[47953,0,"these"],[47959,0,"only ever "],[47993,0," m"],[47994,1,""],[47994,0,"have to"],[48018,4,""],[48018,0,"for"],[48041,0," There are a few apr"],[48060,1,""],[48060,0,"proaches which pull"],[48041,0," Storing and"],[48042,11,""],[48042,0,"A lot of the performance and memory cost of CRDTs coem"],[48095,1,""],[48094,1,""],[48094,0,"mes from storing"],[48103,0,"loading, "],[48119,0," and searching that growing data set."],[48194,0," this data out entirely."],[48218,22,""],[48219,1,""],[48219,0,"Fo"],[48220,1,""],[48219,1,""],[48167,5,""],[48167,0,"some"],[48216,0,", and "],[48216,6,""],[48218,0,"For example, "],[48231,3,""],[48264,1,""],[48254,0,"["],[48265,0,"](https://braid.org/antimatter)"],[48189,0,"solve this problem by finding ways to "],[48227,9,""],[48227,0,"discard this"],[48244,5,""],[48244,0," "],[48227,7,""],[48227,0,"hs"],[48228,1,""],[48227,1,""],[48227,0,"shed"],[48232,0,"some of "],[48339,0," That said,"],[48350,40,""],[48354,0," just has its "],[48355,13,""],[48355,0,"repositories have tehi"],[48376,1,""],[48375,1,""],[48374,1,""],[48374,0,"heir data "],[48368,16,""],[48368,0,"only grow over time"],[48373,0,"ever "],[48392,5,""],[48392,0," and"],[48396,2,""],[48422,45,""],[48422,0,". So maaby"],[48431,1,""],[48430,1,""],[48429,1,""],[48429,0,"ybe"],[48424,8,""],[48424,0,"Maybe it doesn't matter so long as the underlying system is fast enough?"],[48418,0,"about "],[48410,18,""],[48410,0,"mind too much"],[48503,6,""],[48503,0,"pruning is"],[48557,4,""],[48557,0," A"],[48575,0,"also "],[48574,0," should also"],[48586,17,""],[48586,0," be abl"],[48590,3,""],[48590,0,"applicable to"],[48603,9,""],[48603,0," any"],[48642,0," Maybe thats how "],[48648,11,""],[48648,0," ruthlessly pruning & archiving old dta"],[48686,1,""],[48685,1,""],[48685,0,"ata is how "],[48692,4,""],[48692,0,"the patch"],[48700,1,""],[48699,1,""],[48699,0,"t"],[48699,1,""],[48698,1,""],[48698,0,"th to getting another 5x "],[48712,11,""],[48712,0,"evebn "],[48717,1,""],[48716,1,""],[48715,1,""],[48715,0,"b "],[48716,1,""],[48715,1,""],[48715,0,"m "],[48716,1,""],[48715,1,""],[48715,0,"n better performance, yet "],[48735,6,""],[48735,0,"."],[48558,1,""],[48558,0,"Any good"],[48593,17,""],[48593,0," work with"],[48603,4,""],[48603,0," all"],[48631,0,"talk a"],[48636,1,""],[48635,1,""],[48635,0,"ed about"],[48643,5,""],[48649,94,""],[48713,1,""],[48712,1,""],[48712,0,"s"],[48712,1,""],[48712,0,"ah"],[48735,14,""],[48735,0,"step in this optimization ho"],[48762,1,""],[48761,1,""],[48761,0,"jui"],[48763,1,""],[48762,1,""],[48762,0,"ourney involves"],[48785,0," to "],[48788,1,""],[48809,0,"For example, "],[48822,1,""],[48822,0,"m"],[48807,0," and I'm not isolating them"],[48830,4,""],[48830,0,"those changes"],[49265,1,""],[49264,1,""],[49263,1,""],[49263,0,"I can only"],[49281,1,""],[49280,1,""],[49279,1,""],[49361,1,""],[49355,6,""],[49355,0,"jump"],[49485,0,"yjs and "],[49485,8,""],[49698,9,""],[49700,0,"hoest"],[49704,1,""],[49703,1,""],[49702,1,""],[49702,0,"nestly "],[49765,5,""],[49765,0,"my "],[49785,0," problem"],[49852,5,""],[49852,0,"the"],[49948,5,""],[49948,0,"bread"],[49952,1,""],[49952,0,"kdown"],[50059,0,"still "],[50164,0,"["],[50164,1,""],[50164,0,"["],[50164,1,""],[50173,0," [from automerge:"],[50189,1,""],[50189,0,"](https://github.com/automerge/automerge/blob/d2e7ca2e141de0a72f540ddd738907bcde234183/backend/op_set.js#L649-L659)"],[15151,0," If yo're "],[15152,9,""],[15152,0,"It looks "],[15152,9,""],[15152,0,"Autom"],[15152,5,""],[15152,0,"Comp"],[15152,4,""],[15152,0,"Compacted, automerge looks like this:"],[15152,12,""],[15152,0,"A"],[15178,0,"\n\n"],[15179,0,"\n```javascript\n\n\n```"],[15194,1,""],[15194,0,"const integrateAutomergeSmol = <T>(doc: Doc<T>, newItem: Item<T>) => {\n  const {id} = newItem\n  doc.version[id[0]] = id[1]\n\n  let parent = findItem(doc, newItem.originLeft)\n\n  let i\n\n  // Scan to find the insert location\n  for (i = parent + 1; i < doc.content.length; i++) {\n    let o = doc.content[i]\n    let oparent = findItem(doc, o.originLeft)\n\n    // Should we insert here?\n    if (oparent < parent\n      || (oparent === parent\n        && (newItem.seq === o.seq)\n        && id[0] < o.id[0])\n    ) break\n  }\n\n  // We've found the position. Insert at position *i*.\n  doc.content.splice(i, 0, newItem)\n  doc.maxSeq = Math.max(doc.maxSeq, newItem.seq)\n}"],[15183,10,""],[15183,0,"typescript"],[15221,1,""],[15220,1,""],[15219,1,""],[15218,1,""],[15320,0,"i, "],[15366,9,""],[15842,1,""],[15562,0," (Thisi s "],[15571,1,""],[15570,1,""],[15569,1,""],[15568,1,""],[15564,4,""],[15564,0,"Black magic incoming)"],[15584,0,"!"],[15584,1,""],[15316,5,""],[15316,0,"let"],[15319,1,""],[15316,3,""],[15316,0,"const"],[15365,0,"  let i"],[15372,38,""],[15365,0,"  // Scan to find the insert location\n"],[15364,0,"\n  "],[15365,2,""],[15618,63,""],[15618,0,"      || (oparent === parent && (newItem.seq === o.seq)"],[15618,83,""],[15618,0,"      || (oparent === parent && (newItem.seq === o.seq) && id[0] < o.id[0])"],[15618,75,""],[15618,0,"      || (oparent === parent && (newItem.seq === o.seq)\n        && id[0] < o.id[0])"],[15618,55,""],[15618,0,"      || (oparent === parent\n        && (newItem.seq === o.seq)"],[15618,63,""],[15618,0,"      || (oparent === parent && (newItem.seq === o.seq)"],[15618,83,""],[15618,0,"      || (oparent === parent && (newItem.seq === o.seq) && id[0] < o.id[0])"],[15618,75,""],[15618,0,"      || (oparent === parent && (newItem.seq === o.seq)\n        && id[0] < o.id[0])"],[15618,55,""],[15618,0,"      || (oparent === parent\n        && (newItem.seq === o.seq)"],[15571,0,"Warning: "],[15591,9,""],[15580,0,"Deep sourcery"],[15593,11,""],[15593,0,"Black magic"],[15584,9,""],[15580,4,""],[15591,0,"."],[15591,1,""],[15152,10,""],[15152,0,"Written this way, automerge "],[15382,0," /** "],[15386,1,""],[15385,1,""],[15384,1,""],[15384,0,"/ SLOW"],[15382,8,""],[15160,8,""],[15160,0,"in thi"],[15160,6,""],[15160,0,"in thi s"],[15167,1,""],[15166,1,""],[15166,0,"s style"],[15184,11,""],[15184,0," turns into"],[14892,2,""],[14892,0,"This"],[15154,49,""],[15154,0,"Specifically, these 20 lines of code:"],[15551,0,"\n        if (newItem.seq > o.seq) break\n"],[15552,8,""],[15552,0,"      "],[15552,6,""],[15552,0,"    "],[15586,1,""],[15586,0,"\n    let oparent = findItem(doc, o.originLeft)"],[15506,46,""],[15540,0," // Optimizatin"],[15554,1,""],[15553,1,""],[15553,0,"on"],[15554,1,""],[15553,1,""],[15553,0,"ion for non-concurrent editing case"],[15556,32,""],[15556,0," only"],[15556,5,""],[15544,0,"This is just an "],[15560,1,""],[15560,0,"o"],[15572,0,".\n    "],[15574,4,""],[15544,29,""],[15544,0,"Optimization."],[15544,0,"Unnecessary "],[15556,1,""],[15556,0,"o"],[15296,29,""],[15296,0,"x"],[15298,0,"z"],[15298,1,""],[15296,1,""],[15296,0,"\n  doc.version[id[0]] = id[1]"],[15296,30,""],[15865,0,"\n  \n  doc.version[id[0]] = id[1]"],[15866,2,""],[15866,0,"\n// "],[15869,1,""],[15868,1,""],[15867,1,""],[15867,0,"  // And s"],[15876,1,""],[15876,0,"assorted bookkeeping."],[15876,0,"do "],[15879,8,""],[15879,0,"various"],[15173,3,""],[15179,8,""],[15152,0,", like this"],[15163,28,""],[15163,0,":"],[15956,0,"\n\n<video controls>\n  <source src=https://invisiblecollege.s3-us-west-1.amazonaws.com/braid-meeting-10.mp4'"],[15989,0,"'"],[16062,0,"#t-"],[16064,1,""],[16064,0,"=270"],[16069,0,"\n  </div"],[16076,1,""],[16075,1,""],[16074,1,""],[16074,0,"video>"],[16070,2,""],[16069,0,">"],[16069,0," type=video/mp4"],[15973,0," height=400"],[16076,3,""],[16076,0,"300"],[15209,1,""],[15208,1,""],[15207,1,""],[15218,1,""],[15217,1,""],[15216,1,""],[15233,1,""],[15232,1,""],[15231,1,""],[15478,13,""],[15478,0,"O"],[15152,12,""],[15152,0,". Automerge looks like this, "],[15180,1,""],[15179,1,""],[15179,0,", though there's probably"],[15187,17,""],[15187,0," the people who understand this code probably fit in a small room, so don't or"],[15264,1,""],[15263,1,""],[15263,0,"worry"],[15253,1,""],[15252,1,""],[15252,0,". "],[15254,4,""],[15254,0,"D"],[15265,0," if this looks like"],[15274,10,""],[15274,0,"makes nose "],[15284,1,""],[15283,1,""],[15282,1,""],[15282,0," sense."],[16105,78,""],[16061,70,""],[16060,1,""],[15154,25,""],[15154,0,"H"],[15154,1,""],[15154,0,"This is what it actually looks lik e"],[15189,1,""],[15188,1,""],[15188,0,"e in practice, but"],[15206,23,""],[15206,0," don't worry if it makes no sense. The"],[15244,21,""],[15244,0," set of people who do understand this code"],[15287,9,""],[15307,36,""],[15241,0,"I think "],[15249,1,""],[15249,0,"t"],[15304,0,"s"],[15304,1,""],[16845,0,". If you'"],[16853,1,""],[16853,0,"wan"],[16855,1,""],[16854,1,""],[16853,1,""],[16853,0," want to learn more, I gave a "],[16876,0,"["],[16884,0,"talk](https://invisiblecollege.s3-us-west-1.amazonaws.com/braid-meeting-10.mp4#t=300)"],[16888,0," a few weeks ago about this approach"],[17005,0,"."],[17005,1,""],[16883,0,"n informal"],[17015,0,", going into alot m"],[17033,1,""],[17032,1,""],[17031,1,""],[17030,1,""],[17029,1,""],[17029,0," lot more detail about how and *why "],[17064,1,""],[17064,0,"* CRDTs work li"],[17078,1,""],[17077,1,""],[17077,0,"this way."],[15678,10,""],[15678,0,"p"],[15451,10,""],[15451,0,"p"],[15670,0,"a"],[15452,0,"a"],[15672,0,"r"],[15453,0,"r"],[15674,0,"e"],[15454,0,"e"],[15676,0,"n"],[15455,0,"n"],[15678,0,"t"],[15456,0,"t"],[15378,4,""],[15378,0,"{}"],[15379,0,"P"],[15379,1,""],[15379,0,"parent"],[15379,0,"Id, "],[15389,0,", content"],[15379,1,""],[15379,0,"i"],[15382,0," seq,"],[15448,0,"Idx"],[15548,0,"Idx"],[15788,0,"Idx"],[15820,0,"Idx"],[15683,0,"Idx"],[15782,0,"IDx"],[15783,1,""],[15783,0,"d"],[15815,0,"Idx"],[15239,0," to you"],[15248,9,""],[15248,0,"T"],[15269,3,""],[15290,0," probably"],[15251,7,""],[15248,14,""],[15248,0,"We could probably fit everyone who"],[15293,0,"s"],[15304,13,""],[16346,27,""],[16346,0," with a few more comments"],[16690,0," "],[16690,1,""],[16664,3,""],[16664,0,"my"],[16884,1,""],[16884,0,"\n\n"],[16911,0," about all of this, and where those black magic "],[16941,18,""],[16941,0,"that black magic logic came from"],[16978,4,""],[16977,0,"gave "],[16983,1,""],[17116,0," at a braidjs meeting. In my talk I went"],[17156,8,""],[17156,0," "],[16912,62,""],[16911,1,""],[16911,0,","],[17060,0,"["],[17067,1,""],[17066,1,""],[17074,0,"](https://braid.org/)"],[17067,7,""],[17066,1,""],[17087,0," meeting"],[16921,16,""],[16921,0,"a talk"],[16927,16,""],[17069,0," a few weeks ago"],[17168,0," But"],[15384,26,""],[15383,1,""],[15382,1,""],[15368,5,""],[15326,10,""],[15326,0,"javascript"],[16313,6,""],[16313,0,", with "],[16339,1,""],[16475,8,""],[16475,0,"code"],[16475,4,""],[16475,0,"function"],[15343,18,""],[15343,0,"automergeInsert"],[16143,7,""],[17125,4,""],[16849,0,"'re interested in"],[16866,8,""],[16872,0,"ing"],[17055,82,""],[17057,0,"Bu"],[17058,1,""],[17057,1,""],[17057,0,"The important point is, "],[17081,1,""],[17081,0,"t"],[17108,5,""],[17108,0," a few"],[17114,3,""],[17079,1,""],[15307,0,"to"],[15308,1,""],[15307,1,""],[15278,0," on the planet"],[15329,0," meeting"],[15324,6,""],[15322,9,""],[15322,0,"my k"],[15325,1,""],[15325,0,"lounge"],[15331,1,""],[15331,0," "],[15325,6,""],[15325,0,"k"],[15324,2,""],[15322,2,""],[15322,0,"a meeting"],[16023,78,""],[15995,0," ..."],[15998,1,""],[15865,0,"newItem."],[15397,22,""],[15396,1,""],[15974,1,""],[15486,7,""],[15485,1,""],[15485,0,"\n  let i"],[15629,1,""],[15881,1,""],[15446,1,""],[15446,0,"\n  "],[15447,2,""],[15881,0,"\n  "],[15882,2,""],[15881,1,""],[15972,0,"\n  "],[15973,2,""],[15727,0," part"],[17032,18,""],[17450,0,"probably lots of "],[17473,4,""],[17473,0," all"],[17466,1,""],[17463,3,""],[17458,5,""],[17450,8,""],[17457,4,""],[17731,4,""],[17731,0,"Ths "],[17734,1,""],[17733,1,""],[17733,0,"is algorithm is"],[17775,141,""],[17518,0," In my reference-crdts codebase I have an implementation of both RGA (automerge) and YATA (yjs). Their performance in this test is identical.\n"],[17659,1,""],[17614,0," They share most of their code (ex"],[17647,1,""],[17647,0,"verything except this one function) and "],[17688,1,""],[17687,1,""],[17687,0,"t"],[17687,6,""],[17687,0,"their "],[17987,1,""],[17943,43,""],[15674,0," "],[15674,1,""],[15446,0," // SLOW"],[15453,1,""],[15452,1,""],[15451,1,""],[15450,1,""],[15450,0,"(slow)"],[15987,0," // (slow)"],[18986,0,"\n\nIe, the two lines I marked *"],[19015,1,""],[19015,0,"`*"],[19016,1,""],[19016,0,"(slow`"],[19021,1,""],[19021,0,")` in the code listing above."],[19835,6,""],[19835,0,"what index th"],[19847,1,""],[19846,1,""],[19846,0,"does that correspond to"],[19869,7,""],[20000,4,""],[20000,0,"I"],[20063,0,"linearly "],[21175,0," - which "],[21183,1,""],[21150,0,"linear "],[21190,0," is what we expect for "],[21209,4,""],[21209,0,"when "],[21182,32,""],[21269,11,""],[21269,0,"to"],[21278,1,""],[21277,1,""],[21276,1,""],[21343,12,""],[21343,0,"F"],[21343,1,""],[21343,0,"Changing data structures"],[21343,24,""],[21343,0,"Faster "],[21343,7,""],[21343,0,"F"],[21343,1,""],[21343,0,"Fix"],[21343,3,""],[21343,0,"Changing the data structure"],[15323,0," "],[15323,1,""],[15245,1,""],[15244,1,""],[15243,1,""],[15242,1,""],[15241,1,""],[15240,1,""],[15239,1,""],[15152,1,""],[15152,0,":"],[15154,176,""],[15153,1,""],[15153,0,"\n\n(But don't be alarmed if this makes"],[15185,5,""],[15185,0,"looks d"],[15191,1,""],[15191,0,"confusing - everyone who ca"],[15216,2,""],[15216,0,"understands this code "],[15203,35,""],[15203,0,"the peole"],[15211,1,""],[15210,1,""],[15210,0,"ple who understnad th"],[15218,13,""],[15218,0,"understand this code fit around a sm"],[15239,15,""],[15239,0,"today fit in a small meeting room.)"],[15245,0,"probably "],[16762,13,""],[16762,0,"goind e"],[16768,1,""],[16767,1,""],[16766,1,""],[16766,0,"g deeper on this"],[15203,0,"we could probably fit everyone"],[15233,10,""],[15248,0,"s"],[15265,13,""],[15234,0,"on the planet "],[15273,6,""],[15273,0," today"],[15282,0,"to"],[15421,4,""],[15421,0,"1"],[15959,4,""],[15959,0,"2"],[18915,0,"(&*"],[18917,1,""],[18916,1,""],[18915,1,""],[18915,0," (*1)"],[18919,1,""],[18918,1,""],[18917,1,""],[18916,1,""],[18915,1,""],[18959,17,""],[18959,0,"These are thw "],[18972,1,""],[18971,1,""],[18971,0,"e"],[18959,14,""],[18959,0,"These are the linkes"],[18959,64,""],[18959,0,"(These linesa re"],[18974,1,""],[18973,1,""],[18972,1,""],[18971,1,""],[18971,0," are marked (1) and (2) in the code listing above)."],[18983,0,"*"],[18987,0,"*"],[18996,0,"*"],[18993,0,"*"],[19028,0,"To understand why these lines are en"],[19063,1,""],[19062,1,""],[19046,16,""],[19046,0,"this is needed, "],[19062,1,""],[19062,0,"l"],[19051,0,"code "],[19058,7,""],[19058,0," necessary"],[19422,0,"Note, "],[19428,1,""],[19428,0,"s"],[19471,1,""],[19471,0,"."],[19473,3,""],[19422,4,""],[19422,0,"And"],[19425,1,""],[19522,0,"(Unfortunately "],[19537,1,""],[19537,0,"w"],[19403,1,""],[19402,1,""],[19402,0,"'seph', 1"],[20041,0,"So "],[20044,1,""],[20044,0,"i"],[21382,0,"\n\n"],[21383,0,"Why does the graph have this shape? Here's the "],[21396,5,""],[21396,0,"chart"],[21430,0,"graph of the e"],[21443,1,""],[21443,0,"ins"],[21443,3,""],[21443,0,"edit position for every change"],[21467,6,""],[21466,1,""],[21465,1,""],[21465,0,"y keyt"],[21470,1,""],[21470,0,"stroke."],[21476,1,""],[21476,0,", with the same averaging "],[21492,10,""],[21492,0,"bucketing and smoothing applied:"],[21525,0,"\n![reference crdts implementation zoomed in](ref_perf3.svg)"],[21570,9,""],[21570,0,"inspos"],[21528,40,""],[21528,0,"Editin"],[21533,1,""],[21532,1,""],[21532,0," position throughout document "],[21561,1,""],[21417,0," in particular"],[21392,3,""],[21392,0,"this"],[21434,0,"If we "],[21440,11,""],[21445,7,""],[21445,0," where"],[21452,0,"each "],[21461,29,""],[21461,0," happened throguhout"],[21471,10,""],[21471,0,"throughout the editing trace"],[21500,0," and use"],[21508,5,""],[21542,7,""],[21541,1,""],[21541,0,", the reusl"],[21551,1,""],[21550,1,""],[21549,1,""],[21549,0,"sult is remarkably familiar"],[21433,0," Thats "],[21433,7,""],[20241,23,""],[20241,0,", which "],[20248,1,""],[20242,6,""],[20241,1,""],[20241,0,", which is double yikes"],[20573,23,""],[20575,0," is actually super fast at this, so maybe its not"],[20624,8,""],[20624,0," using an"],[20650,0,"?"],[20651,49,""],[20651,0," Who knows!"],[20650,0," to implement an arra"],[20664,7,""],[20664,0,"Arras"],[20668,1,""],[20668,0,"ys"],[20588,0,"suspiciously "],[20601,6,""],[20613,0," part"],[20629,3,""],[20629,0,"v8 isn't"],[20637,4,""],[20698,0,"But the general rule is, "],[20723,1,""],[20723,0,"i"],[20702,0,"in fe"],[20706,1,""],[20705,1,""],[20705,0,"general"],[20712,19,""],[20773,0,"about "],[20976,32,""],[20975,1,""],[20974,1,""],[20974,0,"."],[20976,1,""],[20976,0,"I"],[21112,0,"The time taken to perform each insert looks "],[21155,1,""],[21155,0," like this. "],[21166,1,""],[21165,1,""],[21165,0,":"],[21166,221,""],[20959,15,""],[20959,0,"is reasonably fast, but"],[20981,2,""],[20981,0,"t"],[20983,1,""],[20983,0,"i"],[20983,1,""],[20983,0,"i"],[21172,1,""],[21119,53,""],[21119,0,"There's a lot going on here because inserts happened all over the document"],[21155,38,""],[21155,0,"Martin's editign ps"],[21173,1,""],[21172,1,""],[21171,1,""],[21170,1,""],[21169,1,""],[21169,0,"ng position bounced around the docuen"],[21205,1,""],[21204,1,""],[21204,0,"ment. But there's a l"],[21224,1,""],[21224,0,"strong linear trend up and to thr "],[21257,1,""],[21256,1,""],[21256,0,"e right, which is what we would expect for a"],[21299,1,""],[21298,1,""],[21297,1,""],[21296,1,""],[21295,1,""],[21295,0,"when each insert takes ("],[21318,1,""],[21318,0,"O(n) time ."],[21328,1,""],[21327,1,""],[21327,0,"."],[21318,0,"*"],[21323,0,"*"],[21300,5,""],[21306,0,"s"],[21312,1,""],[21324,1,""],[21324,0,":"],[21396,0,"performance get better near the end? And why"],[21440,15,""],[21472,0," simply"],[21486,0,"*"],[21492,0,"*"],[21543,3,""],[21543,0,"with"],[21547,4,""],[21433,33,""],[21432,1,""],[21387,0,"And why this shape in particular? And "],[21425,1,""],[21425,0,"w"],[21600,11,""],[21600,0,"eerily "],[38425,16,""],[38425,0,"are junk food for your inu"],[38450,1,""],[38450,0,"tuition"],[38404,9,""],[38404,0,"But"],[38453,0,"Remember, "],[38463,1,""],[38463,0,"w"],[38453,11,""],[38453,0,"W"],[38482,0,"still "],[21586,20,""],[21586,0,"we end up with the same cur"],[21601,12,""],[21601,0,"a very"],[21616,0," curve"],[39064,0," How we implement our alog"],[39089,1,""],[39088,1,""],[39088,0,"gorithms mat"],[39082,18,""],[39082,0,"things matters, "],[39097,1,""],[39096,1,""],[39096,0,"."],[39082,15,""],[39082,0,"our algorithms matters."],[39064,41,""],[39064,0," How we implement our algorithms matters."],[39064,1,""],[39064,0,"\n\n"],[39066,42,""],[38850,0," if we get creative with implementation"],[38875,0,"our "],[38893,0," strategies"],[38906,0,"With the right approach, "],[38931,1,""],[38931,0,"w"],[38942,0," CRDTs"],[38948,9,""],[38957,0,"that "],[38460,0,"The same data on "],[38477,4,""],[38476,1,""],[38474,2,""],[38474,0,"with"],[38494,15,""],[38411,5,""],[38411,0,"L"],[38469,5,""],[38469,0," on"],[38647,0,"some "],[39681,32,""],[39680,1,""],[39670,0,", no matter how "],[39682,4,""],[39682,0,"the e"],[39686,1,""],[39686,0,"teasing from my friends,"],[39693,0," I get"],[9982,6,""],[9982,0,"was using"],[9972,9,""],[9968,4,""],[9968,0,"nodejs"],[9998,1,""],[9998,0,"!"],[9979,6,""],[9979,0,"sitting on "],[9968,21,""],[9968,0,"tho"],[9970,1,""],[9970,0,"is code was using"],[9968,9,""],[9968,0,"automerge"],[10071,0,"["],[10082,0," benchmark](https://gist.github.com/josephg/13efc1444660c07870fcbd0b3e917638#file-js_baseline-js)"],[10267,3,""],[10267,0,"all the"],[10371,3,""],[10371,0,"is caa"],[10376,1,""],[10376,0,"pable of going"],[10390,3,""],[21788,0,"\n"],[21788,0,"\nThis te"],[21789,7,""],[21789,0,"So editing performance is dominated"],[21792,0,"the time spent applying changes"],[21823,19,""],[21836,0," by the time spent scanning f"],[21864,1,""],[21863,1,""],[21863,0," our document array."],[21864,3,""],[21864,0,"the"],[21876,0,"'s item"],[21879,5,""],[21836,0," (1) -"],[21842,3,""],[21841,1,""],[21840,1,""],[21839,1,""],[21838,1,""],[21837,1,""],[21836,1,""],[21836,0," by"],[21849,5,""],[21849,0,"it takes to"],[21868,1,""],[21867,1,""],[21866,1,""],[21865,1,""],[21865,0," through"],[21700,14,""],[21700,0,"the result is"],[21710,3,""],[21710,0," is"],[18801,17,""],[18801,0,"Death by 1000 scans"],[21790,6,""],[21790,0,"It looks like the"],[21907,0," Edits at the end of the document are much slower than edits at the start "],[21907,74,""],[1008,4,""],[1008,0,"like"],[1286,0," Operational Transformation"],[1299,1,""],[1299,0,"o"],[1299,1,""],[1299,0,"t"],[1287,1,""],[1287,0,"p"],[1287,1,""],[1287,0,"o"],[1774,0," that"],[2267,1,""],[2266,1,""],[2266,0," are"],[2305,0," black-box"],[2331,29,""],[2331,0,"concurrent end"],[2344,1,""],[2343,1,""],[2343,0,"dits"],[2354,10,""],[2354,0,"twp cli"],[2360,1,""],[2359,1,""],[2358,1,""],[2357,1,""],[2356,1,""],[2356,0,"o clients"],[2370,1,""],[2370,0," the same region of text at the e"],[2402,1,""],[2402,0,"same time,"],[2412,45,""],[2427,57,""],[2427,0,"Are they merged? Do they conflict"],[2444,0,"How? "],[2442,7,""],[2442,0,", or do the"],[2442,11,""],[2442,0,"? "],[2460,0,"? "],[2461,1,""],[2461,0," What are the rules?"],[2442,0,", na"],[2445,1,""],[2444,1,""],[2444,0,"and if so in what order"],[2469,18,""],[2495,0," white-box"],[2522,0," of the system"],[2542,0," programming"],[2609,29,""],[2609,0,"does it perform in different editing"],[2637,8,""],[2627,10,""],[2624,3,""],[2616,8,""],[2613,3,""],[2609,4,""],[2609,0,"optimized is it, and for what"],[2621,3,""],[2621,0," the code"],[2630,24,""],[2744,0,"*"],[2753,0,"*"],[2770,0,"*"],[2776,0,"*"],[2802,0,"Likewise "],[2811,1,""],[2811,0,"a"],[2811,4,""],[2833,0,"*"],[2842,0,"*"],[2859,0,"*"],[2865,0,"*"],[2872,11,""],[2872,0,"all"],[2872,3,""],[2872,0,"every implementation"],[2897,7,""],[2893,0," o"],[2894,1,""],[2893,1,""],[2893,0,"of the system "],[2921,48,""],[2921,0,"No mate"],[2927,1,""],[2927,0,"ter "],[2921,10,""],[2920,7,""],[2801,0," But no m"],[2802,8,""],[2802,0,"No matter how many tests you write, there are a"],[2838,11,""],[2838,0,"given enough time someone usually finds anohter"],[2878,7,""],[2878,0,"more bugs. And"],[2888,4,""],[2882,6,""],[2878,4,""],[2878,0,"anohter"],[2877,8,""],[2871,6,""],[2863,8,""],[2855,8,""],[2850,5,""],[2843,7,""],[2838,5,""],[2838,0,"there are a"],[2847,2,""],[2843,4,""],[2837,6,""],[2830,7,""],[2826,4,""],[2820,6,""],[2815,5,""],[2811,4,""],[2804,7,""],[2802,2,""],[2802,0,"But no m"],[2808,2,""],[2805,3,""],[2801,4,""],[2920,0," bugs."],[2920,0," No matter "],[2930,1,""],[2927,3,""],[2927,0,"e"],[2923,5,""],[2921,2,""],[2921,0,"If you wait long enough, somebody will find more"],[3006,12,""],[3006,0,"can design a"],[4284,9,""],[4284,0,"b"],[3152,9,""],[3152,0,"b"],[2317,9,""],[2317,0,"b"],[4269,0,"e"],[3145,0,"e"],[2318,0,"e"],[4272,0,"h"],[3147,0,"h"],[2319,0,"h"],[4275,0,"a"],[3149,0,"a"],[2320,0,"a"],[4278,0,"v"],[3151,0,"v"],[2321,0,"v"],[4281,0,"i"],[3153,0,"i"],[2322,0,"i"],[4284,0,"o"],[3155,0,"o"],[2323,0,"o"],[4287,0,"u"],[3157,0,"u"],[2324,0,"u"],[4290,0,"r"],[3159,0,"r"],[2325,0,"r"],[4284,9,""],[4284,0,"semantics"],[3152,9,""],[3152,0,"semantics"],[2317,9,""],[2317,0,"semantics"],[4284,9,""],[4284,0,"b"],[3152,9,""],[3152,0,"b"],[2317,9,""],[2317,0,"b"],[4269,0,"e"],[3145,0,"e"],[2318,0,"e"],[4272,0,"h"],[3147,0,"h"],[2319,0,"h"],[4275,0,"a"],[3149,0,"a"],[2320,0,"a"],[4278,0,"v"],[3151,0,"v"],[2321,0,"v"],[4281,0,"i"],[3153,0,"i"],[2322,0,"i"],[4284,0,"o"],[3155,0,"o"],[2323,0,"o"],[4287,0,"u"],[3157,0,"u"],[2324,0,"u"],[4290,0,"r"],[3159,0,"r"],[2325,0,"r"],[2833,1,""],[2841,1,""],[2857,1,""],[2862,1,""],[4770,0,"Thats "],[4789,1,""],[4789,0,"."],[4791,7,""],[4791,0,"N"],[4790,1,""],[4789,1,""],[4789,0,", which is "],[4800,1,""],[4800,0,"n"],[7598,1,""],[7630,1,""],[8175,9,""],[8175,0,"hebavi"],[8175,6,""],[8175,0,"behaviour"],[8186,3,""],[8186,0,"is defined by this algorithm"],[8261,1,""],[8855,0,")"],[25190,11,""],[25190,0,"P"],[18561,11,""],[18561,0,"P"],[10744,11,""],[10744,0,"P"],[25171,0,"l"],[18552,0,"l"],[10745,0,"l"],[25174,0,"a"],[18554,0,"a"],[10746,0,"a"],[25177,0,"i"],[18556,0,"i"],[10747,0,"i"],[25180,0,"n"],[18558,0,"n"],[10748,0,"n"],[25183,0," "],[18560,0," "],[10749,0," "],[25186,0,"s"],[18562,0,"s"],[10750,0,"s"],[25189,0,"t"],[18564,0,"t"],[10751,0,"t"],[25192,0,"r"],[18566,0,"r"],[10752,0,"r"],[25195,0,"i"],[18568,0,"i"],[10753,0,"i"],[25198,0,"n"],[18570,0,"n"],[10754,0,"n"],[25201,0,"g"],[18572,0,"g"],[10755,0,"g"],[25204,0," "],[18574,0," "],[10756,0," "],[25207,0,"e"],[18576,0,"e"],[10757,0,"e"],[25210,0,"d"],[18578,0,"d"],[10758,0,"d"],[25213,0,"i"],[18580,0,"i"],[10759,0,"i"],[25216,0,"t"],[18582,0,"t"],[10760,0,"t"],[25219,0,"s"],[18584,0,"s"],[10761,0,"s"],[25222,0," "],[18586,0," "],[10762,0," "],[25225,0,"i"],[18588,0,"i"],[10763,0,"i"],[25228,0,"n"],[18590,0,"n"],[10764,0,"n"],[25231,0," "],[18592,0," "],[10765,0," "],[25234,0,"J"],[18594,0,"J"],[10766,0,"J"],[25237,0,"S"],[18596,0,"S"],[10767,0,"S"],[25240,1,""],[18598,1,""],[10768,1,""],[25238,1,""],[18597,1,""],[10768,1,""],[25236,1,""],[18596,1,""],[10768,1,""],[25234,1,""],[18595,1,""],[10768,1,""],[25232,1,""],[18594,1,""],[10768,1,""],[25230,1,""],[18593,1,""],[10768,1,""],[25228,1,""],[18592,1,""],[10768,1,""],[25226,1,""],[18591,1,""],[10768,1,""],[25224,1,""],[18590,1,""],[10768,1,""],[25222,1,""],[18589,1,""],[10768,1,""],[25220,1,""],[18588,1,""],[10768,1,""],[25218,1,""],[18587,1,""],[10768,1,""],[25216,1,""],[18586,1,""],[10768,1,""],[17821,3,""],[17821,0,"Y"],[16853,3,""],[16853,0,"Y"],[16579,3,""],[16579,0,"Y"],[17818,0,"j"],[16852,0,"j"],[16580,0,"j"],[17821,0,"s"],[16854,0,"s"],[16581,0,"s"],[18525,3,""],[18525,0,"Yjs"],[25093,3,""],[25093,0,"Yjs"],[25902,3,""],[25902,0,"Y"],[25763,3,""],[25763,0,"Y"],[25696,3,""],[25696,0,"Y"],[25625,3,""],[25625,0,"Y"],[25466,3,""],[25466,0,"Y"],[25315,3,""],[25315,0,"Y"],[25893,0,"j"],[25756,0,"j"],[25691,0,"j"],[25622,0,"j"],[25465,0,"j"],[25316,0,"j"],[25899,0,"s"],[25761,0,"s"],[25695,0,"s"],[25625,0,"s"],[25467,0,"s"],[25317,0,"s"],[28925,1,""],[28925,0,"Y"],[29951,1,""],[29951,0,"Y"],[32737,0,"Y"],[32737,1,""],[32736,1,""],[32736,0,"Y"],[34155,3,""],[34155,0,"Y"],[33481,3,""],[33481,0,"Y"],[34154,0,"j"],[33482,0,"j"],[34156,0,"s"],[33483,0,"s"],[36906,0,"Yjs"],[36909,3,""],[44141,3,""],[44141,0,"Y"],[43164,3,""],[43164,0,"Y"],[42664,3,""],[42664,0,"Y"],[42601,3,""],[42601,0,"Y"],[42507,3,""],[42507,0,"Y"],[42405,3,""],[42405,0,"Y"],[44132,0,"j"],[43157,0,"j"],[42659,0,"j"],[42598,0,"j"],[42506,0,"j"],[42406,0,"j"],[44138,0,"s"],[43162,0,"s"],[42663,0,"s"],[42601,0,"s"],[42508,0,"s"],[42407,0,"s"],[46529,3,""],[46529,0,"Y"],[46463,3,""],[46463,0,"Y"],[46276,3,""],[46276,0,"Y"],[45730,3,""],[45730,0,"Y"],[46524,0,"j"],[46460,0,"j"],[46275,0,"j"],[45731,0,"j"],[46528,0,"s"],[46463,0,"s"],[46277,0,"s"],[45732,0,"s"],[46813,1,""],[46813,0,"Y"],[48288,3,""],[48288,0,"Y"],[47220,3,""],[47220,0,"Y"],[48287,0,"j"],[47221,0,"j"],[48289,0,"s"],[47222,0,"s"],[49416,3,""],[49416,0,"Yjs"],[51403,3,""],[51403,0,"Yjs"],[51521,3,""],[51521,0,"Y"],[51417,3,""],[51417,0,"Y"],[51520,0,"j"],[51418,0,"j"],[51522,0,"s"],[51419,0,"s"],[27509,0,"\n\n> And yes, I know, V9"],[27531,1,""],[27531,0,"8 d"],[27533,1,""],[27533,0,"tries its harr"],[27546,1,""],[27546,0,"dest to prevent this. But its not magic."],[27580,0,"made of "],[27566,0," sor t"],[27571,1,""],[27570,1,""],[27570,0,"t o fthi"],[27577,1,""],[27576,1,""],[27575,1,""],[27574,1,""],[27573,1,""],[27573,0,"f thing when it can"],[27606,8,""],[40084,0,"h"],[44228,0,"plain "],[44240,0," editing"],[47358,9,""],[47358,0,"b"],[46602,9,""],[46602,0,"b"],[46413,9,""],[46413,0,"b"],[46026,9,""],[46026,0,"b"],[45940,9,""],[45940,0,"b"],[47327,0,"e"],[46579,0,"e"],[46398,0,"e"],[46019,0,"e"],[45941,0,"e"],[47332,0,"h"],[46583,0,"h"],[46401,0,"h"],[46021,0,"h"],[45942,0,"h"],[47337,0,"a"],[46587,0,"a"],[46404,0,"a"],[46023,0,"a"],[45943,0,"a"],[47342,0,"v"],[46591,0,"v"],[46407,0,"v"],[46025,0,"v"],[45944,0,"v"],[47347,0,"i"],[46595,0,"i"],[46410,0,"i"],[46027,0,"i"],[45945,0,"i"],[47352,0,"o"],[46599,0,"o"],[46413,0,"o"],[46029,0,"o"],[45946,0,"o"],[47357,0,"u"],[46603,0,"u"],[46416,0,"u"],[46031,0,"u"],[45947,0,"u"],[47362,0,"r"],[46607,0,"r"],[46419,0,"r"],[46033,0,"r"],[45948,0,"r"],[45940,0,"merging "],[45940,0,"concurrent "],[46246,5,""],[46246,0," it"],[46618,0,"'s"],[30073,6,""],[30073,0,"range tree"],[30073,0,"["],[30084,0,"](https://en.wikipedia.org/wiki/Range_tree)"],[30190,0," "],[30190,1,""],[30190,0," "],[30190,1,""],[30192,0,"A "],[30193,1,""],[30192,1,""],[30192,0,"My range"],[30192,8,""],[30192,0,"And "],[30192,4,""],[30192,0,"I'm "],[30194,2,""],[30193,1,""],[30192,1,""],[30190,0," Inter"],[30191,5,""],[30191,0,"The range tree internl"],[30212,1,""],[30212,0,"ally uses a "],[30191,33,""],[30190,1,""],[30192,0,"The range tree is really"],[30192,24,""],[30192,0,"Under the hood, my range tree s "],[30223,1,""],[30222,1,""],[30222,0,"is acutall"],[30231,1,""],[30230,1,""],[30229,1,""],[30228,1,""],[30227,1,""],[30227,0,"ually j"],[30225,9,""],[30225,0,"actually just a b-tree. But "],[30253,1,""],[30253,0,"u"],[30241,0,"slightly modified "],[30266,4,""],[30267,1,""],[30267,0,"But u"],[30816,163,""],[30815,1,""],[30815,0,"\n> Does this have a name? I've been calling it a \"range tree\", but I think that name is [taken by another data structure](https://en.wikipedia.org/wiki/Range_tree)\n"],[30818,160,""],[30818,0,"I'm sure I didn't"],[30818,17,""],[30818,0,"I k"],[30820,1,""],[30819,1,""],[30818,1,""],[30818,0,"That wikipedia ari"],[30835,1,""],[30835,0,"ticle "],[30818,0,"This is a range tree, right? "],[30870,0,"its pretty"],[30870,0,"on range trees "],[30885,10,""],[30885,0,"is a pretty poor mat"],[30904,1,""],[30903,1,""],[30902,1,""],[30902,0,"description of what I'm doing here."],[30847,4,""],[30847,0,"The"],[30851,0,"["],[30884,0,"](https://en.wikipedia.org/wiki/Range_tree)"],[30940,4,""],[30940,0,"bad"],[30940,3,""],[30940,0,"weak"],[31295,1,""],[31295,0,"4"],[31377,1,""],[31377,0,"4"],[31632,1,""],[31632,0,"4"],[24677,0,"62"],[24678,1,""],[24677,1,""],[24676,1,""],[24675,1,""],[24675,0,"62"],[24653,0," by 3x,"],[24661,1,""],[24660,1,""],[24659,1,""],[24659,0,". ("],[24662,4,""],[24680,0,"k down to "],[24690,5,""],[24689,1,""],[24688,1,""],[24687,1,""],[24686,1,""],[24686,0," from 180"],[24694,1,""],[24693,1,""],[24692,1,""],[24691,1,""],[24690,1,""],[24689,1,""],[24688,1,""],[24687,1,""],[24686,1,""],[24685,1,""],[24684,1,""],[24683,1,""],[24682,1,""],[24681,1,""],[24666,3,""],[24665,1,""],[24665,0,"k down"],[24671,5,""],[24678,0,")."],[24667,0,"entries "],[33817,11,""],[33817,0,"Plain string edits in JS"],[33842,21,""],[33842,0,"        "],[25196,0,"*"],[18561,0,"*"],[10744,0,"*"],[25223,0,"*"],[18587,0,"*"],[10769,0,"*"],[25226,1,""],[18589,1,""],[10770,1,""],[25224,1,""],[18588,1,""],[10770,1,""],[37276,11,""],[37276,0,"Plain string edits in JS"],[37301,21,""],[37301,0,"        "],[34360,0,"![rust implementation in wasm vs Yjs](rust_perf6.svg)\n"],[34413,0,"\n"],[34462,1,""],[34462,0,"7"],[37541,1,""],[33993,1,""],[37539,1,""],[33992,1,""],[37537,1,""],[33991,1,""],[37536,0,"1"],[33991,0,"1"],[37538,0,"."],[33992,0,"."],[37540,0,"1"],[33993,0,"1"],[33368,2,""],[33368,0,"56"],[33392,0," over"],[33398,4,""],[33398,0,"1"],[33398,1,""],[33398,0,"5000"],[33466,1,""],[33466,0,"5"],[33466,1,""],[33466,0,"6"],[32935,0,"under "],[33929,1,""],[33928,1,""],[33928,0,"12"],[33929,1,""],[33929,0,"0"],[33929,1,""],[33929,0,"9"],[32930,14,""],[32930,0,"193"],[29972,42,""],[29972,0,"https://github.com/josephg/diamond-types"],[29970,0," a"],[29971,1,""],[29970,1,""],[29940,1,""],[29969,0," called D"],[29977,1,""],[29977,0,"[Diamond types"],[29978,1,""],[29978,0,"d"],[29978,1,""],[29978,0,"D"],[30036,19,""],[30036,0,"Diamond"],[30237,9,""],[32371,4,""],[32377,0," in an array"],[32389,9,""],[32382,1,""],[32382,0," fixed size"],[32411,16,""],[32411,0,"T"],[32411,1,""],[32411,0,"Inserting like t"],[32421,4,""],[32421,0,"with a structure like"],[32447,5,""],[32454,0,"s"],[32459,4,""],[32459,0,"a little bit of"],[32675,0,"And "],[32679,1,""],[32679,0,"w"],[32772,7,""],[32772,0,"reasonably "],[32634,10,""],[32665,0,"\n"],[32200,465,""],[32200,0,"Rust gives us total control over the memory layout, so we can pack everything in tightly. Unlike in the diagram, each leaf node in my b-tree stores a block of 32 entries, packed in a fixed size array in memory. Inserting with a structure like this results in a little bit of memcpy-ing, but a little bit of memcpy is fine. Memcpy is always faster than I think it will be - CPUs can copy several bytes per clock cycle. Its not the epic hunt of a main memory lookup."],[32665,0,"\n"],[32665,1,""],[32664,1,""],[32664,0,"\n\n"],[32779,0," I don't know "],[32779,14,""],[32666,0,"("],[32780,0,")"],[32666,1,""],[32779,1,""],[32779,0," I have no idea why thats "],[32780,25,""],[32779,1,""],[32778,1,""],[32778,0," on my computer."],[32785,8,""],[32785,0,"hardware"],[32774,4,""],[32774,0,"fast"],[31299,1,""],[31299,0,"3"],[31381,1,""],[31381,0,"3"],[31636,1,""],[31636,0,"3"],[33242,102,""],[33242,0,"https://github.com/josephg/diamond-types/blob/yjs-style/benches/yjs.rs"],[33165,0,"It gets even faster if we "],[33191,19,""],[33191,0,"skip wasm and "],[33165,21,""],[33165,0,"I"],[33180,0," and run this"],[33193,4,""],[33204,0," "],[33204,1,""],[33204,0,"th"],[33205,1,""],[33204,1,""],[33204,3,""],[33210,0,"ly"],[33212,9,""],[33214,26,""],[33213,1,""],[33212,1,""],[33204,0,"["],[33165,0,"It gets even faster "],[33185,1,""],[33185,0,"i"],[33196,0,"javascript and "],[33224,4,""],[33224,0,"the"],[33320,1,""],[33320,0,". Like t"],[33322,6,""],[33322,0,"Running natively"],[33247,0," through rust"],[33168,4,""],[33168,0,"goes"],[33215,0,"."],[33217,21,""],[33217,0,"The benchmark "],[33221,10,""],[33221,0,"same benchmark ported"],[33244,21,""],[33244,0,"to rust"],[33243,1,""],[33236,0,"["],[33324,21,""],[175,5,""],[175,0,"5000x"],[137,50,""],[131,0,"5000x faster "],[150,0,":"],[150,1,""],[149,1,""],[149,0,": A case study in optimization"],[131,13,""],[136,0," that go 5000 "],[149,1,""],[149,0,"x faster"],[131,0,"Making "],[143,8,""],[143,0," go"],[162,14,""],[162,0,"n"],[176,0," "],[176,1,""],[176,0," adventure"],[131,6,""],[131,0,"How I made a"],[148,4,""],[143,1,""],[142,1,""],[146,0,"s go"],[168,13,""],[131,4,""],[173,0," in optimization"],[9,54,""],[4639,0,"["],[4658,0,"](https://github.com/josephg/diamond-types)"],[4746,1,""],[4745,1,""],[4745,0,"54"],[4746,1,""],[4746,0,"6"],[4746,1,""],[4746,0,"4"],[4745,2,""],[4745,0,"65"],[4745,2,""],[4745,0,"54"],[4746,1,""],[4746,0,"6"],[4772,1,""],[4771,1,""],[4771,0,"45"],[4772,1,""],[4771,1,""],[4771,0,"56"],[4791,7,""],[4791,0," over"],[10703,1,""],[10702,1,""],[10701,1,""],[10700,1,""],[24670,1,""],[24669,1,""],[24669,0,"12"],[24643,1,""],[24643,0,"14"],[32672,0," I have no idea."],[32717,3,""],[32717,0,"bunch of"],[32756,0,"just "],[32768,18,""],[32756,12,""],[32756,0,"seemed "],[32762,1,""],[32756,7,""],[32756,0,"happened to be "],[32756,35,""],[32756,0,"ran the fastest."],[32673,16,""],[32756,0," I have no idea. "],[32772,1,""],[32771,1,""],[32771,0," why thats the best"],[32780,10,""],[32780,0," worked out to be the best."],[32743,4,""],[32750,1,""],[32749,1,""],[32748,1,""],[32740,8,""],[32740,0,"worked well"],[32851,0,"["],[32884,0,"](https://github.com/josephg/diamond-js)"],[33215,21,""],[33215,0,"I"],[33215,0,"Javascript and WASM is now a bottleneck. "],[33266,20,""],[33266,0," all that and run"],[33283,5,""],[33283,0," the"],[33320,70,""],[33320,0,"https://github.com/josephg/diamond-types/blob/42a8bc8fb4d44671147ccaf341eee18d77b2d532/benches/yjs.rs"],[33267,8,""],[33267,0,"javascd"],[33273,1,""],[33273,0,"ript"],[33289,5,""],[33301,9,""],[33301,0,"directly in rust"],[33426,0,", we"],[33443,3,""],[33443,0,"the"],[33443,3,""],[33443,0,"all"],[34463,4,""],[34463,0,"1394"],[34457,6,""],[34457,0,"results in "],[34599,0," -->"],[34546,0,"<!-- "],[34604,4,""],[34546,5,""],[34545,0,"\n"],[34545,0,"\nHm, lets zoom in a bit there and just "],[34546,8,""],[34546,0,"Oh, its so fast you can barely see it next to yjs ("],[34596,1,""],[34596,0,"*fleexxxx*. Lets"],[34636,6,""],[34635,1,""],[34634,1,""],[34633,1,""],[34633,0,"and bask in that flat line:"],[34549,0," what a pity."],[34563,1,""],[34563,0,"I"],[34570,0,"consistently "],[34622,0,"("],[34633,0,")"],[34719,7,""],[34687,1,""],[34687,0,":"],[34687,1,""],[34687,0,":"],[34736,0,"\n\nWell, nearly flat line. I have no idea what the jitteryness is "],[34800,1,""],[34797,3,""],[34777,4,""],[34777,0,"why its a bit"],[34790,4,""],[34801,1,""],[34800,1,""],[34799,1,""],[34798,1,""],[34798,0,"."],[34798,1,""],[34798,0," - though the s"],[34798,15,""],[34798,0,". Its probab"],[34800,10,""],[34800,0,"Maybe deletes are faster than inserts or something."],[34818,0,"slightly "],[34818,9,""],[34818,0,"marginally "],[34861,1,""],[34861,0,", so we're seeing the insert / delete ratio aga"],[34907,1,""],[34906,1,""],[34905,1,""],[34904,1,""],[34904,0,"."],[34904,0," pop out of the timing data"],[34849,12,""],[34848,1,""],[35140,1,""],[35140,0,"~4"],[35151,9,""],[35151,0,"again"],[34762,24,""],[34762,0,"I wonder if the"],[34777,4,""],[34785,0,"ness"],[34789,1,""],[34789,0," shows"],[34790,5,""],[34790,0,"is showing"],[34800,6,""],[34793,8,""],[34835,0," or something?"],[34849,71,""],[34744,0,"a "],[34737,114,""],[34736,1,""],[34736,0,"\n\nWell, a nearly flat line. I wonder if the jitteryness is deletes are marginally faster than inserts or something?"],[34773,78,""],[34773,0,"what that k"],[34783,1,""],[34783,0,"jitteryness is about?"],[34803,1,""],[34803,0,"..?"],[34808,0,"And remember ,this is"],[34820,1,""],[34821,0," "],[34829,0," "],[34830,9,""],[34866,14,""],[34880,10,""],[34880,0,"nodejs"],[34889,7,""],[34808,15,""],[34808,0,"T"],[34917,4,""],[34917,0," So"],[34943,0,"*"],[34948,0,"*"],[34959,4,""],[34959,0,"If"],[34994,0,"s"],[34996,4,""],[34996,0,"another"],[35083,7,""],[35092,0,"("],[35104,0,")"],[35121,0," that much"],[35156,0," memory"],[35197,16,""],[35197,0,"Eh, I "],[35196,60,""],[35198,131,""],[36323,0," "],[37654,1,""],[34108,1,""],[37652,1,""],[34107,1,""],[37651,0,"5"],[34107,0,"5"],[37653,0,"6"],[34108,0,"6"],[37825,1,""],[37824,1,""],[37823,1,""],[37823,0,"1.1"],[38175,374,""],[38174,0,"\n---\n"],[38715,43,""],[38715,0,":"],[38758,0,"But "],[38762,1,""],[38762,0,"l"],[38807,15,""],[38807,0,"O"],[38824,0," the data"],[44423,14,""],[44423,0,"diamond-types"],[44455,87,""],[44455,0,"https://github.com/josephg/diamond-types/tree/42a8bc8fb4d44671147ccaf341eee18d77b2d532"],[44566,0," RUSTFLAGS='-C target-cpu=native' "],[44620,70,""],[44694,0,"["],[44742,0,"](https://github.com/josephg/diamond-types/blob/42a8bc8fb4d44671147ccaf341eee18d77b2d532/src/list/doc.rs#L15)"],[44726,9,""],[44726,0,"list"],[44856,8,""],[44856,0,"look at memory statistics by running"],[44894,19,""],[44894,0,"cargo run --release --features memusage --example stats"],[44950,60,""],[44951,199,""],[45411,20,""],[45411,0,"M"],[45446,0,"\nMy rust crdt wasm wrapper anywhere."],[45446,36,""],[45446,0,"\n"],[45410,1,""],[45445,0,"\nThe charts were made on [ObservableHQ](https://observablehq.com/@josephg/crdt-algorithm-performance-benchmarks)."],[45297,113,""],[45332,0,"\n"],[45296,1,""],[45331,0,"\nYou'll also need `automerge-paper.json.gz` from [josephg/crdt-benchmarks](https://github.com/josephg/crdt-benchmarks) in order to run most of these tests. The reference-crdts benchmark depends on [crdts.ts from josephg/reference-crdts, at this version](https://github.com/josephg/reference-crdts/tree/fed747255df9d457e11f36575de555b39f07e909)"],[44953,343,""],[44988,0,"\n"],[44952,1,""],[44987,0,"\nFor my rust implementation results come from benchmarking [josephg/diamond-types, at this version](https://github.com/josephg/diamond-types/tree/42a8bc8fb4d44671147ccaf341eee18d77b2d532). Benchmark by running ` RUSTFLAGS='-C target-cpu=native' cargo criterion yjs`. The inline rope structure updates can be enabled or disabled by editing [the constant at the top of src/list/doc.rs](https://github.com/josephg/diamond-types/blob/42a8bc8fb4d44671147ccaf341eee18d77b2d532/src/list/doc.rs#L15). You can look at memory statistics by running `cargo run --release --features memusage --example stats`."],[44356,596,""],[44391,0,"\n"],[44355,1,""],[44390,1,""],[44355,0,"\n"],[44391,596,""],[44356,0,"For my rust implementation results come from benchmarking [josephg/diamond-types, at this version](https://github.com/josephg/diamond-types/tree/42a8bc8fb4d44671147ccaf341eee18d77b2d532). Benchmark by running ` RUSTFLAGS='-C target-cpu=native' cargo criterion yjs`. The inline rope structure updates can be enabled or disabled by editing [the constant at the top of src/list/doc.rs](https://github.com/josephg/diamond-types/blob/42a8bc8fb4d44671147ccaf341eee18d77b2d532/src/list/doc.rs#L15). You can look at memory statistics by running `cargo run --release --features memusage --example stats`.\n"],[44987,1,""],[44952,0,"\n"],[44988,0,"\n"],[44956,4,""],[44956,0,"diamond"],[44963,5,""],[44356,34,""],[44356,0,"My diamond benchmarking result"],[44386,23,""],[44386,0,"s were generated from"],[44356,51,""],[44356,0,"Diamond's benchmarks come from this repo"],[44386,10,""],[44926,33,""],[44926,0,"[This repository](https://github.com/josephg/diamond-js/tree/6e8a95670b651c0aaa7701a1a763778d3a486b0c) contains d"],[45038,1,""],[45038,0,"the diamond-js wrapp"],[45042,16,""],[45042,0,"wasm wrapper"],[44926,0,"Diamond is compiled"],[44937,8,""],[44937,0,"wrapped"],[44937,7,""],[44937,0,"compiled & "],[44947,1,""],[44946,1,""],[44946,0,"to wasm using "],[44961,4,""],[44961,0,"this"],[44966,10,""],[44966,0,"project"],[45059,0,", o"],[45061,1,""],[45061,0,"though I've bee"],[45061,15,""],[45061,0,"hardcoded to point to a local copy of diamond-types from git"],[45121,26,""],[45121,0,"."],[45466,0,"\n"],[45123,1,""],[45465,0,"\nDiamond is compiled to wasm using [this project](https://github.com/josephg/diamond-js/tree/6e8a95670b651c0aaa7701a1a763778d3a486b0c), hardcoded to point to a local copy of diamond-types from git."],[44926,197,""],[45268,0,"\n"],[44925,1,""],[45267,0,"\nDiamond's benchmarks come from [josephg/diamond-types, at this version](https://github.com/josephg/diamond-types/tree/42a8bc8fb4d44671147ccaf341eee18d77b2d532). Benchmark by running ` RUSTFLAGS='-C target-cpu=native' cargo criterion yjs`. The inline rope structure updates can be enabled or disabled by editing [the constant at the top of src/list/doc.rs](https://github.com/josephg/diamond-types/blob/42a8bc8fb4d44671147ccaf341eee18d77b2d532/src/list/doc.rs#L15). You can look at memory statistics by running `cargo run --release --features memusage --example stats`."],[44356,569,""],[44698,0,"\n"],[44355,1,""],[44697,1,""],[44355,0,"\n"],[44698,0,".\n"],[45467,1,""],[45311,7,""],[45311,0,"wrapper"],[45467,0," The bench"],[45471,6,""],[45471,0," wasm bundle is optimized with was"],[45502,3,""],[45502,0,"b"],[45502,1,""],[45502,0,"wasm-opt."],[45487,0,"also "],[45487,5,""],[45625,1,""],[43059,12,""],[43059,0,"Diamond"],[43089,0,"there's a lot of work before its "],[43118,4,""],[43118,0,"I have feature parity with "],[43145,76,""],[43153,1,""],[43153,0,"A"],[43224,0,"operation "],[43394,0," And they need to be optimized for"],[43404,0,"also "],[43433,0," loading and saving documents from "],[43394,74,""],[43394,0," And they also need to be optimized for loading and saving documents from "],[43394,74,""],[43394,0," Diamond is "],[43403,3,""],[43403,0,"does almost none of this "],[43395,0,"So far"],[43401,1,""],[43401,0," d"],[43434,1,""],[43434,0,"."],[43434,1,""],[43434,0," "],[43434,1,""],[43434,0," thankless work."],[43435,14,""],[43434,1,""],[43395,6,""],[43395,0,"At the time of writing,"],[47365,0,"\n\n"],[47366,0,"That said, there is one way in which Yjs has a definite edge over the other implemtn"],[47449,1,""],[47448,1,""],[47447,1,""],[47447,0,"mentations: Yjs doesn'st "],[47471,1,""],[47470,1,""],[47469,1,""],[47469,0,"t store "],[47442,15,""],[47432,10,""],[47432,0,"automerge"],[47447,14,""],[47447,0,"treats deletes"],[47447,14,""],[47447,0,"doesn't store which items in a document have been deleted. Only that they have"],[47521,0,"*"],[47526,0,"* b"],[47528,1,""],[47527,1,""],[47526,1,""],[47526,0," been* deleted. This is "],[47547,3,""],[47547,0,"has some weird implications:\n\n- "],[47577,2,""],[47577,0,"-"],[47259,12,""],[47259,0,"diamond"],[47359,0," I'm still"],[47364,5,""],[47364,0,"not sure if I want to. Kevin is probably right - I don't think this is something people ask for."],[47461,0,"\n---\n"],[47467,12,""],[47467,0,"T"],[47467,0,"Well, "],[47473,1,""],[47473,0,"t"],[47537,0,".Its n"],[47542,1,""],[47541,1,""],[47540,1,""],[47539,1,""],[47538,1,""],[47537,1,""],[47537,0,". And it has nothing to do with "],[47539,30,""],[47538,1,""],[47537,1,""],[47557,16,""],[47557,0,"*when* each item in a"],[47587,5,""],[47587,0," has"],[47678,0," Yjs needs to store much less information. Storing when "],[47721,13,""],[47721,0,"It takes about 500kb"],[47679,62,""],[47679,0,"Storing when each delete happened is weirdly large. Diamond's memory usage increases from 1.12mb to 2.34mb when I also to"],[47799,1,""],[47798,1,""],[47798,0,"store delet"],[47786,23,""],[47785,1,""],[47785,0,"."],[47731,0,"Thsi in"],[47737,1,""],[47736,1,""],[47735,1,""],[47734,1,""],[47734,0,"is"],[47735,1,""],[47734,1,""],[47733,1,""],[47733,0,"is increases"],[47745,1,""],[47745,0," d"],[47768,10,""],[47791,0,"\n"],[47731,4,""],[47731,0,"Adding this data"],[47803,0," I think I can optimize that further, but its not t"],[47853,1,""],[47853,0,"nothing."],[47845,3,""],[47845,0,"it aint"],[47852,4,""],[47862,0,"- Storing when each delete"],[47864,24,""],[47862,2,""],[47862,0,"-"],[47641,0," (Deletes are a "],[47643,14,""],[47643,0,"Yjs stores deletes as a state CRDT, not as a "],[47687,1,""],[47687,0,"n operation-based CRDT)."],[47818,9,""],[47818,0,"to"],[47808,4,""],[47808,0,"temporal deletes"],[47824,5,""],[47836,1,""],[47835,1,""],[47835,0," increases"],[47882,8,""],[47931,0," And it'll also have an impact on fil"],[47965,3,""],[47965,0,"storage"],[47965,0,"on-disk "],[47980,0," size."],[47988,0," Yjs can't do character-by-character repl"],[48025,4,""],[48025,0,"editing replays."],[47998,43,""],[47998,0," replay editing sessions"],[47999,0,"give you pretty time slider style "],[48033,7,""],[48048,1,""],[48048,0," replays. "],[48057,1,""],[48057,0," (Do people want that? I"],[48080,1,""],[48079,1,""],[48059,20,""],[48058,1,""],[48058,0,"(Maybe people don't want that, but its cool)"],[48101,0,"."],[48103,0,"\n- Yjs's "],[48111,1,""],[48110,1,""],[48109,1,""],[48109,0," needs to embed information about "],[48119,24,""],[48119,0,"RLE"],[48121,1,""],[48120,1,""],[48119,1,""],[48119,0,"run-length encode the deletes"],[48137,4,""],[48137,0,"information about which items have been "],[48183,1,""],[48182,1,""],[48182,0,"ed into the version field. In diamond, versions are small ("],[48240,1,""],[48239,1,""],[48234,5,""],[48234,0,"a few bytes. In yjs, versions are 4kb."],[48268,0,"~"],[48273,0," And thet"],[48281,1,""],[48281,0,"y grow over time."],[48297,0," "],[48297,1,""],[48297,0," as the document grows"],[48320,0," (B"],[48322,1,""],[48321,1,""],[48320,1,""],[48319,0,", and more items are "],[48319,21,""],[48321,0,"\n"],[48321,0,"\nThe master branch of diamond does"],[48351,4,""],[48351,0,"adds this information back"],[47883,0,"'m going to"],[47894,4,""],[47928,0,"'"],[47940,5,""],[47940,0,"T"],[47940,1,""],[47940,0,"I"],[47950,18,""],[47950,0," increase"],[47882,34,""],[47882,0,"There's room for more optimization"],[47942,3,""],[47956,0,"s the"],[47996,21,""],[47996,0,"do "],[47999,28,""],[47999,0,"per-keystroke editing"],[48028,0," or anything fancy like that"],[48058,45,""],[48057,1,""],[48190,3,""],[48189,1,""],[48188,1,""],[48187,1,""],[48187,0,"t"],[48187,1,""],[48187,0," tens of"],[48312,21,""],[48312,0,"tempo"],[48312,5,""],[48312,0,"del"],[48312,3,""],[48312,0,"temporal deletes, "],[48329,1,""],[48328,1,""],[48328,0,". I've been benchmarking out of a branch"],[48362,0,"special "],[48376,0," with this stuff disabled, to make the comparison "],[48411,0,"a fair"],[48417,3,""],[48429,0,"with yjs. But diamond"],[48443,0,"f"],[48443,1,""],[48443,0,"the released version of "],[48474,0," might end up a little bigger."],[48503,0," than you would expect"],[48509,16,""],[48509,0,"these benchmarks suggest"],[48534,0," I haven'd"],[48543,1,""],[48543,0,"t decided if it should be confi"],[48535,39,""],[48534,1,""],[48534,0," This is not diamond's final form."],[48535,33,""],[48534,1,""],[47801,6,""],[47801,0,"When I add"],[47839,0," "],[47839,1,""],[47839,0,", it"],[47841,13,""],[47853,0," increases"],[47882,1,""],[47882,0,"4"],[47895,0,"lots of "],[47911,5,""],[47911,0," further"],[47938,2,""],[47938,0,"this"],[47958,23,""],[47958,0,"O"],[47978,0," also increases"],[47958,0,"This will also impact "],[47980,1,""],[47980,0,"o"],[48000,16,""],[48000,0,". I won't be able to match"],[48001,25,""],[47555,1,""],[47554,1,""],[47553,1,""],[47552,1,""],[47551,1,""],[47551,0,"record"],[47644,0,"Aka, "],[47789,3,""],[47789,0,"has a "],[47808,0," impact on memory usage"],[47833,8,""],[47833,0,"A"],[47836,0,"ing"],[47867,1,""],[47867,0," b"],[47868,1,""],[47868,0,"pushes"],[47888,10,""],[47868,6,""],[47868,0,"increases"],[47912,1,""],[47912,0,"!"],[47913,115,""],[47831,0," and on-disk storage size"],[47941,0,"Without temporal deletes, "],[47977,2,""],[47977,0,"implement"],[48020,8,""],[48020,0,"other"],[48031,0," stuff"],[48048,0," (Maybe people "],[48056,7,""],[48056,0,"thats what people want?)"],[48079,0," Is it weird to have every keystroke recorded?"],[48105,0," errent "],[48112,1,""],[48111,1,""],[48110,1,""],[48109,1,""],[48109,0,"ant"],[48166,0," the"],[48149,11,""],[48155,4,""],[48213,0,"*"],[48221,0,"*"],[48343,0," This is still pretty s"],[48344,22,""],[48344,0,"Kevin assures me that deletes"],[48366,7,""],[48366,0,"this information is always small in practice, ubt "],[48415,1,""],[48414,1,""],[48413,1,""],[48412,1,""],[48412,0,"but I don't like"],[48416,12,""],[48416,0,"it still gives"],[48425,5,""],[48425,0,"makes me nervous."],[48417,1,""],[48416,1,""],[48415,1,""],[48415,0,"t"],[48415,1,""],[48415,0," this"],[48498,27,""],[48498,0,"This blos"],[48506,1,""],[48506,0,"g post is writte"],[48498,24,""],[48498,0,"All benchmarks in this blog post use "],[48535,4,""],[48535,0,"a"],[48552,0,"of diamond-types "],[48535,1,""],[48535,0,"the [yjs-style]"],[48550,8,""],[48549,1,""],[48556,0,"](https://github.com/josephg/diamond-types/tree/yjs-style)"],[48615,16,""],[48614,1,""],[48556,0," of diamond-types"],[48631,0,", where"],[48638,5,""],[48638,0," t"],[48639,1,""],[48638,1,""],[48650,0,"has been "],[48667,1,""],[48667,0,". This makes for"],[48683,8,""],[48690,0,"er"],[48712,1,""],[48712,0,", but"],[48717,4,""],[48721,0," final"],[48727,9,""],[48760,46,""],[48753,7,""],[48753,0,"be a little bigger than I've suggested above. YMMV."],[48798,6,""],[48798,0," Eh."],[48798,4,""],[47612,21,""],[47612,0,"whether each ti"],[47626,1,""],[47625,1,""],[47625,0,"item has been"],[47646,0," or not"],[47654,74,""],[47653,1,""],[47830,9,""],[47830,0,"doubles"],[38757,0,"\n"],[38757,0,"\nI"],[38758,1,""],[38758,0,"> Its cool"],[38760,8,""],[38760,0,"Huh - the jitterny"],[38777,1,""],[38776,1,""],[38776,0,"yness of yjs and rust-wasm kind of line up."],[38802,8,""],[38811,0," Periods when yjs is slow, rust-wasm gets faster. And vice versa. I wonder what thats "],[38896,1,""],[38895,1,""],[38895,0," is !?"],[38900,1,""],[38899,1,""],[38898,1,""],[38898,0,"!"],[38766,0," "],[38766,1,""],[38766,0,"look at the bottom two lines around 200 0"],[38806,1,""],[38805,1,""],[38805,0,",000. "],[38811,1,""],[38811,0,"T"],[38848,7,""],[38848,0,"mirror each other"],[38914,1,""],[38914,0,"."],[38915,15,""],[38914,1,""],[38929,0,"s"],[38930,8,""],[38930,0," going on there"],[38913,1,""],[38912,1,""],[38105,68,""],[39039,0,"\n\nThat, my friends, is how you make the computer do a lot less work."],[39039,1,""],[39040,0,"\n"],[39040,1,""],[39107,0,"\n"],[39985,0,"beautiful, flawed "],[40011,29,""],[40036,0," mooks"],[40041,1,""],[40041,0,"s"],[40733,13,""],[40733,0," I guess"],[40733,8,""],[40757,0," comes out of"],[40770,6,""],[40825,376,""],[41035,4,""],[41035,0,"And "],[41040,0," just thumbed my nose at them all and kept using O"],[41083,7,""],[41083,0,"work in"],[41089,1,""],[41088,1,""],[41087,1,""],[41087,0,"ing on Operational Tranform"],[41114,18,""],[41110,0,"s"],[41121,0," helped out"],[41132,4,""],[41210,0,"So"],[41211,1,""],[41210,1,""],[41918,0," U"],[41919,1,""],[41918,1,""],[41918,0," My contribution is using b-trees and pu"],[41957,1,""],[41956,1,""],[41955,1,""],[41943,0," RLE-"],[41948,1,""],[41947,1,""],[41947,0," "],[41944,4,""],[41944,0,"run-length encoded "],[41971,3,""],[41970,1,""],[41970,0," alongisde a "],[41971,12,""],[41971,0,"and rare-"],[41979,1,""],[41979,0,"ly-"],[41981,1,""],[41981,0," all"],[41975,10,""],[41974,1,""],[41974,0," clever indexing. And showing Kevin's list representation can be adapted to ang"],[42052,1,""],[42052,0," "],[42052,1,""],[42052,0,"y algorithm. I don't"],[42054,9,""],[42054,0,"CRDT algorithm"],[42070,7,""],[42070,0,"Nobody has noticed"],[42070,18,""],[42070,0,"I don't think anyone noticed that before."],[42012,0,"fast "],[42165,20,""],[42165,0,"figureou"],[42172,1,""],[42171,1,""],[42171,0,"d out how to make"],[42233,0," Gawsh."],[42234,7,""],[34763,43,""],[34770,2,""],[34770,0,"chart shows"],[34781,12,""],[34794,7,""],[34793,1,""],[34782,0,"javascript "],[34804,0,", called"],[34806,6,""],[34806,0,"calling into rust via"],[34832,20,""],[34781,0," the slow version. "],[34765,0,"And "],[34769,1,""],[34769,0,"t"],[34804,0,"This is"],[34809,2,""],[34809,0,"includes"],[34808,9,""],[34808,0," benchmark is run "],[34804,22,""],[34804,0,"For fairness this char"],[34804,22,""],[34804,0,"This chart is j"],[34818,1,""],[34818,0,"generea"],[34824,1,""],[34823,1,""],[34823,0,"ated via"],[34828,3,""],[34828,0,"from"],[34844,11,""],[34843,1,""],[34863,3,""],[34863,0,"through"],[34877,44,""],[34768,0," remember,"],[34800,0,"*"],[34805,0,"*"],[34888,41,""],[34952,4,""],[34952,0,"I wonder "],[34964,0," the gap is so big"],[35036,0,"know how to "],[35056,14,""],[35093,14,""],[35093,0," does WASM's"],[35126,19,""],[35126,0," slow it down that much?"],[35127,0,"reall"],[35131,1,""],[35130,1,""],[35129,1,""],[35128,1,""],[35127,1,""],[35019,0," really that"],[34965,17,""],[34965,0,"wasm is so much slower than native"],[34951,1,""],[34951,0,"\n\n"],[34953,17,""],[34953,0,"Why is WASM"],[34964,3,""],[34984,0," when I run it"],[35005,0,"ly"],[37816,1,""],[37815,1,""],[37814,1,""],[37814,0,"0.0"],[37816,1,""],[37816,0,"96"],[37822,1,""],[42468,0,"["],[42472,0,"](https://github.com/yjs/yjs)"],[42511,9,""],[42511,0,"o"],[42511,1,""],[42511,0,"solid"],[48464,3,""],[48464,0,"For now, the"],[48502,4,""],[48502,0,"has"],[48502,3,""],[48502,0,"includes"],[48529,0,"But "],[48533,1,""],[48533,0,"a"],[48570,3,""],[48570,0,"a"],[48666,34,""],[48666,0,"which works similarly to yhs"],[48693,1,""],[48692,1,""],[48692,0,"js"],[48678,12,""],[48678,0,"like"],[48686,0," intea"],[48691,1,""],[48690,1,""],[48689,1,""],[48689,0,"stead"],[48683,1,""],[48683,0,"Y"],[48780,18,""],[48780,0,"work differently"],[47955,1,""],[47955,0,", and makes the system about 20"],[47985,1,""],[47984,1,""],[47984,0,"10% slower."],[47985,1,""],[47984,1,""],[47984,0,"3"],[47984,1,""],[47984,0,"5"],[48710,10,""],[48710,0,"matches how"],[48725,0," works"],[48790,77,""],[48790,0,"these benchmarks might not be indicitive of diamond 1.0"],[48820,10,""],[48820,0,"indicative"],[48846,0," "],[48846,1,""],[48790,44,""],[48801,0," might be different"],[48811,9,""],[48811,0,"not m"],[48808,8,""],[48808,0,"not match"],[48808,9,""],[48808,0,"have a lisg"],[48818,1,""],[48817,1,""],[48816,1,""],[48815,1,""],[48815,0,"slightly different me"],[48835,1,""],[48834,1,""],[48834,0,"performance profile"],[48854,0," Eh."],[48854,4,""],[48854,0," Its "],[48854,5,""],[48854,0," (I"],[48856,1,""],[48855,1,""],[48855,0,"(E"],[48856,1,""],[48856,0,"There's plenty of puns here about diamond not being polished yet, but I'm not sharp enough for any of those"],[48947,16,""],[48947,0,"to make"],[48947,7,""],[48947,0,"for those right now)"],[48966,0,"."],[50313,413,""],[50312,1,""],[49964,7,""],[49964,0,"dim"],[49966,1,""],[49966,0,"amond yet"],[49975,5,""],[50113,9,""],[50113,0,"similar"],[50158,1,""],[50157,1,""],[50157,0,", an d"],[50162,1,""],[50161,1,""],[50160,1,""],[50159,1,""],[50159,0,"and "],[50163,14,""],[50198,5,""],[50198,0,"will probably appx"],[50215,1,""],[50215,0,"roximately"],[50264,0,"Maybe. "],[50270,0," Or maybe I'm wrong."],[50313,1,""],[50313,0,"."],[50315,5,""],[50315,0,"I"],[50158,0," modulo d"],[50166,1,""],[50166,0,"delete operations. "],[50184,1,""],[50159,6,""],[50159,0,"except for"],[50189,3,""],[50189,0,"And per"],[50195,1,""],[50194,1,""],[50193,1,""],[50192,1,""],[50189,5,""],[50189,0,"O"],[50189,1,""],[50189,0,"P"],[52645,5,""],[52645,0,"'m "],[52658,0,"ing"],[37525,30,""],[37525,0,"D"],[34007,30,""],[34007,0,"D"],[37497,0,"i"],[34008,0,"i"],[37499,0,"a"],[34009,0,"a"],[37501,0,"m"],[34010,0,"m"],[37503,0,"o"],[34011,0,"o"],[37505,0,"n"],[34012,0,"n"],[37507,0,"d"],[34013,0,"d"],[37509,0," "],[34014,0," "],[37511,0,"("],[34015,0,"("],[37513,0,"w"],[34016,0,"w"],[37515,0,"a"],[34017,0,"a"],[37517,0,"s"],[34018,0,"s"],[37519,0,"m"],[34019,0,"m"],[37520,1,""],[34019,1,""],[37518,1,""],[34018,1,""],[37517,0,"s"],[34018,0,"s"],[37519,0,"m"],[34019,0,"m"],[37521,0," "],[34020,0," "],[37523,0,"v"],[34021,0,"v"],[37525,0,"i"],[34022,0,"i"],[37527,0,"a"],[34023,0,"a"],[37529,0," "],[34024,0," "],[37531,0,"n"],[34025,0,"n"],[37533,0,"o"],[34026,0,"o"],[37535,0,"d"],[34027,0,"d"],[37537,0,"e"],[34028,0,"e"],[37539,0,"j"],[34029,0,"j"],[37541,0,"s"],[34030,0,"s"],[37543,0,")"],[34031,0,")"],[37545,0," "],[34032,0," "],[37547,0," "],[34033,0," "],[37549,0," "],[34034,0," "],[37551,0," "],[34035,0," "],[37553,0," "],[34036,0," "],[34032,5,""],[34034,0,"     "],[37605,13,""],[37605,0,"D"],[34070,13,""],[34070,0,"D"],[37594,0,"i"],[34071,0,"i"],[37596,0,"a"],[34072,0,"a"],[37598,0,"m"],[34073,0,"m"],[37600,0,"o"],[34074,0,"o"],[37602,0,"n"],[34075,0,"n"],[37604,0,"d"],[34076,0,"d"],[37606,0," "],[34077,0," "],[37608,0,"("],[34078,0,"("],[37610,0,"n"],[34079,0,"n"],[37612,0,"a"],[34080,0,"a"],[37614,0,"t"],[34081,0,"t"],[37616,0,"i"],[34082,0,"i"],[37618,0,"v"],[34083,0,"v"],[37620,0,"e"],[34084,0,"e"],[37622,0,")"],[34085,0,")"],[37625,3,""],[34090,3,""],[37767,4,""],[37767,0,"a"],[37767,1,""],[37767,0,"Diamond"],[37786,4,""],[37786,0," doc"],[37122,0," Lang"],[37126,1,""],[37125,1,""],[37124,1,""],[37123,1,""],[37123,0,"Language |"],[37213,0," -------- |"],[37304,0," JS       |"],[37395,0," JS       |"],[37486,0," JS       |"],[37577,0," JS       |"],[37668,0," JS       | JS       |"],[37679,11,""],[37759,0," JS       |"],[37850,0," JS       |"],[37944,0," JS       |"],[37913,1,""],[37912,1,""],[37911,1,""],[37669,2,""],[37669,0,"Rust/wasm"],[37677,1,""],[37676,1,""],[37675,1,""],[37674,1,""],[37674,0,"WASM"],[37678,6,""],[37761,2,""],[37761,0,"Rust"],[37765,1,""],[37673,1,""],[37673,0,"+"],[37678,0,"+JS"],[37673,5,""],[37676,0," "],[37767,1,""],[37851,2,""],[37851,0,"Rust"],[37855,2,""],[37942,2,""],[37942,0,"Rust"],[37946,2,""],[37673,1,""],[37673,0," iva"],[37676,1,""],[37675,1,""],[37674,1,""],[37674,0,"via "],[37130,1,""],[37129,1,""],[37128,1,""],[37127,1,""],[37127,0,"    "],[37106,14,""],[37106,0,"Data storage"],[37110,8,""],[37110,0,"          "],[37110,11,""],[37110,0," structure "],[33318,4,""],[33317,1,""],[34565,12,""],[34564,1,""],[34947,33,""],[34947,0,"4x slower than"],[34969,1,""],[34968,1,""],[34968,0," execution"],[35054,1,""],[35053,1,""],[35052,1,""],[35051,1,""],[35050,1,""],[35049,1,""],[35048,1,""],[35047,1,""],[35046,1,""],[35045,1,""],[35044,1,""],[35043,1,""],[35078,1,""],[35077,1,""],[35076,1,""],[35075,1,""],[35074,1,""],[35073,1,""],[35072,1,""],[35071,1,""],[35070,1,""],[35069,1,""],[35083,1,""],[35082,1,""],[35132,1,""],[35131,1,""],[35130,1,""],[35129,1,""],[35128,1,""],[35127,1,""],[35126,1,""],[35125,1,""],[35124,1,""],[35123,1,""],[37610,7,""],[37610,0,"+wasm"],[37610,5,""],[37610,0," via JS"],[37613,1,""],[37612,1,""],[37611,1,""],[37611,0,"+"],[38102,10,""],[38102,0,"keystrokes"],[38767,14,""],[38766,1,""],[38842,1,""],[38841,1,""],[38841,0,"gets"],[38850,0,"er"],[38873,0,"er"],[38905,1,""],[38904,1,""],[38903,1,""],[38902,1,""],[38901,1,""],[38901,0,"there"],[38854,9,""],[38854,0,"d"],[38795,9,""],[38795,0,"d"],[38847,0,"i"],[38796,0,"i"],[38849,0,"a"],[38797,0,"a"],[38851,0,"m"],[38798,0,"m"],[38853,0,"o"],[38799,0,"o"],[38855,0,"n"],[38800,0,"n"],[38857,0,"d"],[38801,0,"d"],[49011,4,""],[49011,0,"These"],[52128,20,""],[47921,19,""],[47921,0,"this data"],[47930,8,""],[47938,0," diamond's"],[48025,0,"Because it doesn't store "],[48050,8,""],[48025,43,""],[48029,0,"doen'"],[48033,1,""],[48032,1,""],[48032,0,"esn't "],[48037,1,""],[48036,1,""],[48035,1,""],[48034,1,""],[48033,1,""],[48032,1,""],[48032,0,"sn't store enough information to "],[48065,6,""],[48474,0,"basically "],[48508,1,""],[48508,0,". He might be right"],[48551,0," weirldy"],[48556,1,""],[48557,0,"l"],[52836,12,""],[52836,0,"diamond"],[52911,12,""],[52911,0,"diamond"],[53094,0," r"],[53095,1,""],[53095,0,"diamond's performance i"],[53117,1,""],[53116,1,""],[53117,4,""],[53117,0,"isn't just thanks to"],[53137,9,""],[31884,22,""],[31884,0,"Diamond"],[77,58,""],[77,0,"5000x faster CRDTs: An adventure in optimization"],[0,75,""],[50,0," -->"],[0,0,"<!-- "],[55,4,""],[0,5,""],[50,0,"\n\n<span class=m="],[65,1,""],[64,1,""],[64,0,"post-meta>July 31 2021</span>"],[21,1,""],[20,1,""],[20,0,"\n\n## "],[24,0,"$$"],[25,1,""],[24,1,""],[24,0,"##"],[26,1,""],[25,1,""],[24,1,""],[23,1,""],[22,1,""],[21,1,""],[20,1,""],[20,0,": "],[22,17,""],[22,0,"O"],[34,0," Adventures"],[34,11,""],[22,1,""],[22,0,"An adventure in o"],[38,1,""],[38,0,"O"],[25,1,""],[25,0,"A"],[55374,0,"\n\n---\n\nJoseph Gentle\n\n"],[55395,1,""],[55381,0,"["],[55395,0,"](https://josephg.com/)"],[55379,0,"\n<footer>"],[55428,0,"\n</fi"],[55432,1,""],[55432,0,"ooter>"],[55375,4,""],[55386,0,"Wri"],[55388,1,""],[55387,1,""],[55386,1,""],[55386,0,"By "],[55390,6,""],[55390,0,"Seph"],[55386,3,""],[55385,0,"\nSeph Gentle\n"],[55400,11,""],[55400,0,"https://josephg.com/"],[55399,0,"[https://josephg.com/](https://josephg.com/)\n\n"],[55454,11,""],[55454,0,"gt"],[55455,1,""],[55455,0,"ithub.com"],[55465,0,"josephg/"],[55475,20,""],[55475,0,"https://github.com/josephg/"],[55386,11,""],[55389,20,""],[55389,0,"Seph Gentle"],[55386,1,""],[55385,1,""],[55387,0,"2021 "],[37076,1,""],[37076,0,":"],[37833,1,""],[37742,1,""],[37651,1,""],[37560,1,""],[37467,1,""],[37376,1,""],[37285,1,""],[37194,1,""],[37103,1,""],[37012,1,""],[37823,1,""],[37733,1,""],[37643,1,""],[37553,1,""],[37461,1,""],[37371,1,""],[37281,1,""],[37191,1,""],[37101,1,""],[37011,1,""],[37813,1,""],[37724,1,""],[37635,1,""],[37546,1,""],[37455,1,""],[37366,1,""],[37277,1,""],[37188,1,""],[37099,1,""],[37010,1,""],[37803,1,""],[37715,1,""],[37627,1,""],[37539,1,""],[37449,1,""],[37361,1,""],[37273,1,""],[37185,1,""],[37097,1,""],[37009,1,""],[37793,1,""],[37706,1,""],[37619,1,""],[37532,1,""],[37443,1,""],[37356,1,""],[37269,1,""],[37182,1,""],[37095,1,""],[37008,1,""],[37783,1,""],[37697,1,""],[37611,1,""],[37525,1,""],[37437,1,""],[37351,1,""],[37265,1,""],[37179,1,""],[37093,1,""],[37007,1,""],[37773,1,""],[37688,1,""],[37603,1,""],[37518,1,""],[37431,1,""],[37346,1,""],[37261,1,""],[37176,1,""],[37091,1,""],[37006,1,""],[37763,1,""],[37679,1,""],[37595,1,""],[37511,1,""],[37425,1,""],[37341,1,""],[37257,1,""],[37173,1,""],[37089,1,""],[37005,1,""],[37753,1,""],[37670,1,""],[37587,1,""],[37504,1,""],[37419,1,""],[37336,1,""],[37253,1,""],[37170,1,""],[37087,1,""],[37004,1,""],[37743,1,""],[37661,1,""],[37579,1,""],[37497,1,""],[37413,1,""],[37331,1,""],[37249,1,""],[37167,1,""],[37085,1,""],[37003,1,""],[37733,1,""],[37652,1,""],[37571,1,""],[37490,1,""],[37407,1,""],[37326,1,""],[37245,1,""],[37164,1,""],[37083,1,""],[37002,1,""],[37483,1,""],[37482,1,""],[55262,0,"\n# Acknowledgements"],[55262,0,"\n"],[55283,0,"\n"],[55283,0,"\nTa"],[55285,1,""],[55285,0,"hanks fo"],[55292,1,""],[55291,1,""],[55291,0,"to everyone who gave "],[55284,28,""],[55284,0,"This work was made possible thanks to "],[55312,10,""],[55312,0,"as part of [braid](b"],[55331,1,""],[55331,0,"https:"],[55331,6,""],[55331,0,"https://braid.org/)"],[55323,0,"the "],[55328,1,""],[55328,0,"B"],[55333,0," project"],[55311,15,""],[55294,17,""],[55294,0,"is part of the"],[55344,0,", ufn"],[55348,1,""],[55347,1,""],[55346,1,""],[55345,1,""],[55344,1,""],[55344,0,", f"],[55346,1,""],[55345,1,""],[55344,1,""],[55344,0," and funded by the [Invisible College](https://invisible.college/).\n\nThankyou to everyone who gave feedback before ths"],[55461,1,""],[55460,1,""],[55460,0,"i"],[55460,1,""],[55460,0,"his post went live."],[55413,0,"Huge "],[55418,1,""],[55418,0,"t"],[55483,1,""],[55483,0,". And Parti"],[55489,5,""],[55489,0,"Martin and Kevin for "],[55506,4,""],[55505,1,""],[55489,0,"special thakns to "],[55497,10,""],[55497,0,"thanks to "],[55513,0," L"],[55514,1,""],[55514,0,"Kleppmann "],[55524,1,""],[55533,0," Jahns for their work on Automerge and Yjs. Diamond "],[55577,8,""],[55577,0,"This wouldn'"],[55582,7,""],[55582,0,"works "],[55587,1,""],[55586,1,""],[55289,4,""],[55289,0,"post"],[55411,0," We're hiring"],[55412,0,"If this is the sort of work you want to contribute towards, "],[55472,1,""],[55472,0,"w"],[55472,0," g"],[55473,1,""],[55472,1,""],[55472,0,"get in touch. "],[55486,1,""],[55486,0,"W"],[55498,0,"."],[55501,6,""],[55501,0,"T"],[55567,1,""],[55567,0,"\n\n"],[55661,9,""],[55661,0,"My CRDT is g"],[55672,1,""],[55672,0,"i"],[55672,1,""],[55672,0,"great because"],[55669,16,""],[55669,0,"is standing on the shoulders of ch"],[55702,1,""],[55701,1,""],[55701,0,"giants."],[55669,11,""],[55669,0,"stands"],[55703,0,"\n"],[55661,7,""],[55661,0,"Diamond"],[5490,25,""],[5490,0,"width=\"560\" height=\"315\" "],[5490,0,"min"],[5492,1,""],[5491,1,""],[5490,1,""],[5490,0,"max-"],[5506,0,"max-"],[5506,4,""],[5490,4,""],[5490,0,"min"],[5490,3,""],[5489,0," max-width: 10"],[5502,1,""],[5501,1,""],[5500,1,""],[5499,1,""],[5499,0,"=100\""],[5500,0,"\""],[5490,40,""],[5490,0,"class=\"typ"],[5499,1,""],[5498,1,""],[5497,1,""],[5497,0,"youtube\""],[5504,0,"-"],[5504,1,""],[3510,0,"#"],[5033,0,"#"],[11458,0,"#"],[38962,0,"#"],[42173,0,"##"],[43828,0,"##"],[45622,0,"#"],[45622,1,""],[43830,1,""],[42173,1,""],[53322,0,"#"],[55262,0,"#"],[250,0,"realtime "],[259,10,""],[259,0,"collaborative"],[280,0," (like google docs)"],[287,1,""],[287,0,"G"],[294,1,""],[294,0,"D"],[299,1,""],[299,0,". They implemented lots of algorithms ("],[338,15,""],[349,11,""],[349,0,")"],[349,0," stuff"],[356,0," and they"],[365,10,""],[378,0,"them "],[386,8,""],[386,0,"to see"],[391,1,""],[390,1,""],[389,1,""],[388,1,""],[387,1,""],[386,1,""],[386,0," to see how they perform"],[412,13,""],[412,0,"(Cool!!) "],[338,0,"["],[343,0,"](https://en.wikipedia.org/wiki/Conflict-free_replicated_data_type)"],[409,1,""],[345,64,""],[343,2,""],[338,1,""],[342,0,"s"],[337,1,""],[337,0," -"],[338,1,""],[337,1,""],[337,0,"- "],[351,0," algorithms and"],[372,1,""],[372,0,"."],[374,3,""],[374,0,"And"],[1712,10,""],[1712,0,"grad student"],[2078,0,"["],[2084,0,"](https://en.wikipedia.org/wiki/Conflict-free_replicated_data_type)"],[2078,0,"Conflict-Free"],[2078,13,""],[2151,0," (thats Conf-"],[2163,1,""],[2163,0,"lict-Free Replicated d"],[2184,1,""],[2184,0,"Data types"],[2057,0,"\nCRDTs are Conflict-Free Replicate D"],[2092,1,""],[2091,1,""],[2091,0,"d Data types. Basically, special algoit"],[2129,1,""],[2128,1,""],[2128,0,"rithms "],[2124,11,""],[2124,0,"constructions wihc"],[2141,1,""],[2140,1,""],[2140,0,"ch "],[2142,1,""],[2141,1,""],[2140,1,""],[2139,1,""],[2139,0,"i"],[2139,1,""],[2139,0,"hich let mutl"],[2151,1,""],[2150,1,""],[2150,0,"ltiple users "],[2148,15,""],[2148,0,"l"],[2148,1,""],[2148,0,"multiple computers / users all edit some data and "],[2194,4,""],[2194,0,"locally without "],[2202,8,""],[2202,0,"nee"],[2202,3,""],[2184,0,"the same data"],[2197,17,""],[2197,0," at the same time, and "],[2219,1,""],[2218,1,""],[2214,4,""],[2214,0,". Once the compuer"],[2231,1,""],[2230,1,""],[2230,0,"ters tell "],[2235,5,""],[2235,0,"share their changes with each other, they"],[2272,4,""],[2272,0,"everyone's copy "],[2215,73,""],[2215,0," "],[2215,1,""],[2214,1,""],[2214,0," without worrying about locking or \n"],[2058,191,""],[2058,0,"CRDTs are Conflict-Free Replicated Data types. Basically, special constructions which let multiple computers / users all edit the same data at the same time without worrying about locking or"],[2249,1,""],[2215,33,""],[2214,1,""],[2214,0,", without worrying about editing conflicts. They "],[2258,5,""],[2257,1,""],[2286,66,""],[2068,0,"["],[2104,0,"]((https://en.wikipedia.org/wiki/Conflict-free_replicated_data_type))"],[2172,1,""],[2105,1,""],[2347,1,""],[2352,45,""],[2352,0," "],[2325,0," They let you build peer-to-peer google docs, or "],[2331,3,""],[2331,0,"can let us"],[2341,4,""],[2377,0,"database replication without"],[2377,0,"make eventuallyc"],[2392,1,""],[2392,0,"-consistent "],[2412,0,"s"],[2413,20,""],[2413,0,"."],[2416,0,"But "],[2420,1,""],[2420,0,"w"],[2347,0," a"],[2384,0,"fast, "],[2184,0,"they're "],[2192,21,""],[2192,0,"fancy programming tricks"],[2235,12,""],[2241,4,""],[2286,0," s"],[2287,1,""],[2287,0,"locking or"],[2369,59,""],[2369,0,"realtime document editing. Or "],[2396,3,""],[2396,0,"So we can take google out of google docs, or "],[2431,0,"'s computers ou "],[2446,1,""],[2446,0,"t of google"],[2467,0,"add collaborative editing to Git."],[2496,1,""],[2496,0,"g"],[2210,6,""],[2210,0,"tools"],[2466,32,""],[2466,0,"do master-master replication without PAXOS"],[2494,14,""],[2483,0,"database "],[2503,0," was "],[2507,1,""],[2506,1,""],[2506,0,"y faster"],[2405,44,""],[2405,0,"do"],[2419,0," without google"],[2439,48,""],[2439,0,"add pair programming to git"],[2404,3,""],[2404,0," build"],[2437,0,"'s computers"],[2331,151,""],[2330,1,""],[2293,0,", without servers"],[2302,8,""],[2294,8,""],[2293,1,""],[2330,0," And "],[2334,1,""],[2334,0,", maybe, without servers."],[2351,0,"some "],[2362,1,""],[2362,0," in control over "],[2378,1,""],[2377,1,""],[2376,1,""],[2375,1,""],[2375,0,"f everything"],[2366,7,""],[2366,0,"charge"],[2336,5,""],[2336,0,"hopefully"],[2359,0," FAANG"],[2355,10,""],[2355,0,"somebody else's compue"],[2376,1,""],[2376,0,"ter (\"the cloud)"],[2391,1,""],[2391,0,"\")"],[2393,20,""],[2393,0," controlling"],[2394,0,"witnessing and "],[2394,14,""],[2394,0,"needing to"],[2405,11,""],[2405,0,"coordinate"],[2173,0,"Th"],[2174,1,""],[2173,1,""],[2058,0,"For the unitn"],[2070,1,""],[2069,1,""],[2069,0,"nitiated, "],[2079,10,""],[2079,0,"CRDTS "],[2086,0,"("],[2122,0,")"],[2190,20,""],[2190,0," are"],[2219,5,""],[2219,0,"to allow"],[2227,4,""],[2242,0," to"],[2219,2,""],[2219,0,"which let"],[2228,6,""],[2282,1,""],[2282,0,". And we can do it"],[2309,0,"worrying about "],[2331,0,", "],[2332,1,""],[2331,1,""],[2334,15,""],[2352,0,", or b"],[2357,1,""],[2357,0,"e"],[2357,1,""],[2356,1,""],[2355,1,""],[2354,1,""],[2353,1,""],[2352,1,""],[2352,0,". People don't even need to be online to "],[2352,41,""],[2352,0," or spotty internet connections"],[2356,0,"lag & "],[2360,1,""],[2360,0,"from"],[2394,23,""],[2394,0,"The best part of CRDT "],[2415,1,""],[2415,0,"s is you can do all that without needing"],[2494,8,""],[2497,0," monitor and"],[2324,11,""],[2445,1,""],[2445,0,"S"],[2454,1,""],[2454,0,"E"],[2461,1,""],[2461,0,"C"],[2445,25,""],[2445,0,"any central computer on "],[2466,2,""],[2466,0,"in"],[2469,1,""],[2480,1,""],[2496,10,""],[2496,0,"control"],[2244,3,""],[2284,3,""],[2284,0," they do it"],[2295,10,""],[2303,0," needing to"],[2322,1,""],[2321,1,""],[2320,1,""],[2347,0," locking or"],[2395,0," an"],[2397,1,""],[2396,1,""],[2396,0,"or anything like that"],[2444,0," that they"],[2454,8,""],[2290,6,""],[2290,0,"work "],[2302,23,""],[2281,112,""],[2281,0,"They let you work locally without the internet"],[2313,1,""],[2312,1,""],[2311,1,""],[2311,0," no lag (you don't even have to be online)"],[2353,13,""],[2354,0," And when you do sync up with other users / devices, everything is "],[2418,3,""],[2418,0,"just mai"],[2425,1,""],[2425,0,"gically"],[2418,0,"should "],[2418,7,""],[2432,0," syncs up and becomes eventually consistent."],[2532,0," even"],[2545,4,""],[2545,0," a"],[2568,1,""],[2577,1,""],[2555,0,"ized"],[2512,0," can"],[2620,0," (Like google) "],[2627,1,""],[2627,0,"G"],[2633,0," Docs"],[2622,0,"Ahem, "],[2628,4,""],[2620,22,""],[2318,0,"."],[2321,1,""],[2321,0,"Y"],[2397,1,""],[2397,0,"&"],[2372,4,""],[2372,0,"connect"],[2383,4,""],[2383,0,"to"],[2383,2,""],[2383,0,"with"],[2372,7,""],[2372,0,"sync"],[2621,0," Think, google docs without goog.e"],[2654,1,""],[2653,1,""],[2653,0,"le."],[2629,1,""],[2629,0,"G"],[2636,1,""],[2636,0,"D"],[2649,1,""],[2649,0,"G"],[2649,1,""],[2649,0,"g"],[2656,0," Or master-master replication without "],[2674,0,"database "],[2058,645,""],[2058,0,"For the uninitiated, CRDTS [(Conflict-Free Replicated Data types)](https://en.wikipedia.org/wiki/Conflict-free_replicated_data_type) are fancy programming tools which let multiple users edit the same data at the same time. They let you work locally with no lag. (You don't even have to be online). And when you do sync up with other users & devices, everything just magically syncs up and becomes eventually consistent. The best part of CRDTs is that they can do all that without even needing a centralized computer in the cloud to monitor and control everything. Think, Google Docs without google. Or master-master database replication without lag. Or seamless "],[2621,1,""],[2621,0,"\n\n"],[2623,98,""],[2623,0,"Think, Google Docs without google. Or master-master database replication without lag. Or seamless cross-device application data, with no startup"],[2760,0,"dodgy "],[2773,0,"'s servers "],[2745,5,""],[2745,0,"s"],[2752,0,"out"],[2756,8,""],[2756,0,"worrying that some"],[2793,0,"are going to go offline"],[2809,7,""],[2809,0,"dark in a couple years."],[2756,76,""],[2756,0,"relying on a flakey startup "],[2783,1,""],[2783,0,"'s sta"],[2788,1,""],[2787,1,""],[2787,0,"ervers to still be around in a decade."],[2817,0,"nother"],[2832,0,"\n"],[2832,0,"\nBut they're famously slow."],[2854,0,"really "],[2865,0,", so nobody really"],[2870,13,""],[2870,0,"basl"],[2873,1,""],[2873,0,"re"],[2874,1,""],[2873,1,""],[2872,1,""],[2872,0,"rely anyone use "],[2887,1,""],[2887,0,"s them"],[2894,0," Wel"],[2897,1,""],[2896,1,""],[2895,1,""],[2894,1,""],[2894,0," Well, "],[2895,6,""],[2895,0,"But they don't have to be!\n\nBut before we can even talk about that, "],[2923,40,""],[2923,0,"But before we can even talk about that,"],[2962,71,""],[2767,1,""],[2767,0,"some"],[2836,11,""],[2836,0,"For text editing they're"],[2836,0,"But "],[2840,1,""],[2840,0,"f"],[2623,6,""],[2623,0,"I want"],[2658,51,""],[2660,22,""],[2660,0," my"],[2664,12,""],[2664,0,"apps to seamlessly work "],[2683,5,""],[2683,0,"share data between all my devices"],[2725,0," me needing to"],[2746,1,""],[2745,1,""],[2744,1,""],[2658,5,""],[2658,0,"I want my"],[2757,0,"["],[2772,0,"](https://ourincrediblejourney.tumblr.com/)"],[2865,3,""],[2865,0,"For"],[2868,4,""],[2888,1,""],[2887,1,""],[2887,0,"ve been"],[2915,0," for a de"],[2923,1,""],[2922,1,""],[2921,1,""],[2920,1,""],[2920,0,"years"],[2881,0," (and other rel"],[2895,1,""],[2895,0,"al application data)"],[2881,34,""],[2915,0," "],[2915,1,""],[2915,0," and clunky"],[2966,26,""],[2966,0,"Well, until now. "],[2982,1,""],[2083,1,""],[2083,0,"s"],[2058,925,""],[2057,1,""],[3589,0,"\n\nFor the uninitiated, CRDTs [(Conflict-Free Replicated Data types)](https://en.wikipedia.org/wiki/Conflict-free_replicated_data_type) are fancy programming tools which let multiple users edit the same data at the same time. They let you work locally with no lag. (You don't even have to be online). And when you do sync up with other users & devices, everything just magically syncs up and becomes eventually consistent. The best part of CRDTs is that they can do all that without even needing a centralized computer in the cloud to monitor and control everything.\n\nI want Google Docs without google. I want my apps to seamlessly share data between all my devices, without me needing to rely on some [flakey startup](https://ourincrediblejourney.tumblr.com/)'s servers to still be around in another decade.\n\nFor text editing they've been famously really slow and clunky for years, so barely anyone uses them. Well, until now.\n\n"],[4584,1,""],[4584,0,"\n\n\n"],[4584,0,"\n"],[4518,1,""],[4583,0,"\n"],[4517,1,""],[4582,0,"\n"],[4516,1,""],[4581,0,"\nFor text editing they've been famously really slow and clunky for years, so barely anyone uses them. Well, until now."],[4398,118,""],[4463,0,"\n"],[4397,1,""],[4462,0,"\nI want Google Docs without google. I want my apps to seamlessly share data between all my devices, without me needing to rely on some [flakey startup](https://ourincrediblejourney.tumblr.com/)'s servers to still be around in another decade."],[4156,241,""],[4221,0,"\n"],[4155,1,""],[4220,0,"\nFor the uninitiated, CRDTs [(Conflict-Free Replicated Data types)](https://en.wikipedia.org/wiki/Conflict-free_replicated_data_type) are fancy programming tools which let multiple users edit the same data at the same time. They let you work locally with no lag. (You don't even have to be online). And when you do sync up with other users & devices, everything just magically syncs up and becomes eventually consistent. The best part of CRDTs is that they can do all that without even needing a centralized computer in the cloud to monitor and control everything."],[3591,564,""],[3656,1,""],[3656,0," "],[4464,118,""],[4468,1,""],[4467,1,""],[4466,1,""],[4465,1,""],[4464,1,""],[4647,1,""],[4647,0,"\n\nBut "],[4653,1,""],[4653,0,"m"],[4712,6,""],[4712,0,". "],[4714,1,""],[4714,0,"A"],[4648,0,"\n"],[4648,0,"\n"],[4648,1,""],[4647,1,""],[5195,0,"\n\n\n"],[2058,42,""],[2058,0,"Even talking about this we"],[2082,0,"stuff "],[2591,2,""],[2591,0,"somebody's"],[2602,14,""],[2602,0,"code"],[2992,4,""],[2992,0,"Years ago I"],[3375,3,""],[3375,0,"a"],[4215,241,""],[4215,0,"I want Google Docs without google. I want my apps to seamlessly share data between all my devices, without me needing to rely on some [flakey startup](https://ourincrediblejourney.tumblr.com/)'s servers to still be around in another decade."],[4215,424,""],[4215,0,"I want Google Docs without google. I want my apps to seamlessly share data between all my devices, without me needing to rely on some [flakey startup](https://ourincrediblejourney.tumblr.com/)'s servers to still be around in another decade. I think they're the [future of collaborative editing](https://josephg.com/blog/crdts-are-the-future/). And maybe the future of all software - but I'm not ready to talk about that yet."],[5189,1,""],[5188,1,""],[5187,1,""],[2591,8,""],[2591,0,"some academic"],[2649,4,""],[2649,0,"teach"],[5895,0,"\n"],[56432,0," "],[56432,1,""],[56432,0," "],[56432,1,""],[35738,0,"Aside: "],[35738,7,""],[35927,0," "],[35927,1,""],[35927,0," I'm so curious!"],[56585,0,"\n[Discuss on HN](https://news.ycombinator.com/item?id=28017204)"],[56594,0,"ion"],[56601,2,""],[56601,0,"Hacker News"],[56596,1,""],[56595,1,""],[56594,1,""],[56593,1,""],[56593,0,"s"],[56587,9,""],[56587,0,"O"],[56587,1,""],[56587,0,"Discuss o"],[56657,1,""],[56586,0,"\n"],[56658,9,""],[56587,0,"<footer>\n"],[56667,1,""],[56596,0,"\n"],[56668,41,""],[56597,0,"[2021 Seph Gentle](https://josephg.com/)\n"],[56709,1,""],[56638,0,"\n"],[56710,59,""],[56639,0,"[https://github.com/josephg/](https://github.com/josephg/)\n"],[56769,1,""],[56698,0,"\n"],[56770,0,"\n"],[56700,7,""],[56700,0,"W"],[56700,1,""],[56700,0,"See al"],[56769,0,"\n"],[56698,1,""],[56768,0,"\n[https://github.com/josephg/](https://github.com/josephg/)"],[56639,59,""],[56709,0,"\n"],[56638,1,""],[56708,0,"\n[2021 Seph Gentle](https://josephg.com/)"],[56597,41,""],[56667,0,"\n"],[56596,1,""],[56666,0,"\n<footer>"],[56587,9,""],[56657,0,"\n"],[56586,1,""],[56768,1,""],[56587,9,""],[56587,0,"S"],[56587,1,""],[56587,0,"And lots "],[56587,9,""],[56587,0,"Read feedback on"],[56587,6,""],[56587,0,"F"],[56587,1,""],[56587,0,"Read f"],[56587,6,""],[56587,0,"F"],[56595,0," is"],[56587,0,"Lots of "],[56587,23,""],[56587,0,"Comments on "],[16813,1,""],[16834,1,""],[27613,10,""],[27613,0,"s"],[20654,1,""],[20698,0,"t"],[20698,1,""],[20698,0,"n"],[20698,1,""],[0,0,"Automerge is too slow and clunky. Martin (its principle architect and programmer) recorded himself typing an academic paper. Running his editing history through automerge (his own code) takes 490 seconds, which is a bit less than 10 minutes. Once processed, the editing trace sits on 1.1 GB of RAM. The newly merged performance branch (designed to fix a lot of these problems) is even slower - taking 750 seconds (12.5 minutes) to process the same editing trace.\nI managed to get that 10 minute time down to 70ms (0.07 seconds). Thats the best result I've ever gotten from optimization work, and I'm delighted by it. Let me tell you what I did!\nWhat does automerge do?\nBefore we can go into detail about how I made automerge fast, we have to spend a moment talking about how automerge itself works.\nAn automerge document is actually a tree of inserted characters. Each character in the document has the following properties:\nA unique ID, made up of a tuple of (client ID, sequence number)\nThe ID (or a pointer to) its parent item, which is the item directly before that character when it was inserted.\nThe character itself ('A')\nThere's a couple more fields (eg to mark when characters have been deleted), but essentially thats it. When a character is inserted in the document, automerge figures out the ID of the character immediately before the new character, and inserts the new character as one of its predecessor's *children*. If you just type a linear sequence of characters (as I'm doing right now), you'll end up with a big long chain of characters going down like a linked list.\nSo why is automerge so slow?\nWhen optimizing, I imagine myself manually doing all the work the computer is doing, one step at a time. Then I imagine asking: \"When I get bored, how would I speed this job up?\".\nAutomerge is slow for 3 main reasons:\nIts written in javascript and uses complex data structures. Javascript is reasonably fast for math, but slow and inefficient when using complex data structures.\nAutomerge uses a complex and inefficient data structure\nAutomerge makes extremely heavy use of immutablejs\nEach of these issues accounts for about an order of magnitude slowdown in performance. You can see all 3 issues showing up in this method from the automerge source tree, which is called on each keystroke. Automerge uses this method to figure out where each new character should be placed in the resulting document:\nfunction insertionsAfter(opSet, objectId, parentId, childId) {\n  let childKey = null\n  if (childId) childKey = Map({opId: childId})\n\n  return opSet\n    .getIn(['byObject', objectId, '_following', parentId], List())\n    .filter(op => op.get('insert') && (!childKey || lamportCompare(op, childKey) < 0))\n    .sort(lamportCompare)\n    .reverse() // descending order\n    .map(op => op.get('opId'))\n}\nWhats wrong with this method?\nThis method allocates all over the place. I can spot 5 allocations, not counting any extra nonsense immutablejs is doing. The call to List() has no effect as far as I can tell from reading immutablejs's documentation.\nThe document is always kept in a sorted order anyway, so the calls to sort() and reverse() are unnecessary. The algorithm only needs to figure out where the new child should be inserted. Re-sorting all children is entirely avoidable. Sort functions are often fast when the input is sorted already, but in this case because the sorting function is inverted, the computer always has to sort the entire list.\nYou can't tell from looking at this method, but insertionsAfter \nDespite CRDTs being the \"new hotness\" in the collaborative editing game for years, I've been resisting them. As I said in my [recent blog post about CRDTs](https://josephg.com/blog/crdts-are-the-future/), they've been generally unworkable for real world collaborative editing because:\nThey take up too much space on disk and in memory. (Automerge takes 1.1GB in RAM to store a 100kb document)\nThey consume way too much CPU to process edits\nUntil these issues are addressed, I can't recommend CRDTs for use in general computing.\n"],[0,0,"\n\n\n\n"],[0,0,"A few years ago I was really bothered by an academic paper. Some graduate students in "],[65,21,""],[65,0,"resera"],[70,1,""],[69,1,""],[68,1,""],[68,0,"earchers in France put together a comarison"],[104,0,"p"],[104,1,""],[105,0,"p"],[112,0," showing lots of ways o"],[134,1,""],[134,0,"CRDT and OT algorithms could be implemented to allow for concurrent editing, and they benchmarks"],[229,1,""],[229,0,"ed them."],[236,0," all"],[241,0," Their paper made "],[242,17,""],[242,0,"Lots of people I knew"],[242,4,""],[242,0,"A bunchof"],[250,1,""],[249,1,""],[266,0," all sent me linke"],[283,1,""],[283,0,"s to the paper asking what I thought"],[241,0," I'd stopped working on Google Wave a few years ab"],[290,1,""],[289,1,""],[289,0,"before and I was knee deep reimplementing ShareJS (a javascript library for collabo"],[371,1,""],[370,1,""],[370,0,"borative eidint"],[384,1,""],[383,1,""],[382,1,""],[381,1,""],[380,1,""],[380,0,"diting) using one o t"],[400,1,""],[399,1,""],[399,0,"f"],[241,1,""],[241,0,"\n\n"],[241,0," Some alori"],[251,1,""],[250,1,""],[249,1,""],[249,0,"gort"],[252,1,""],[252,0,"ithms worked reasonably well. And others"],[282,1,""],[281,1,""],[280,1,""],[280,0,". A"],[292,0," took upwards of 30mx"],[312,1,""],[312,0,"s "],[310,0,"0"],[315,0,"to handle a simple copy+paste operation."],[318,7,""],[318,0,"process "],[335,5,""],[281,4,""],[281,0," But"],[281,4,""],[281,0," And"],[309,5,""],[309,0,"3 seconds"],[354,0," from one of their real world editing sesion"],[397,1,""],[396,1,""],[395,1,""],[395,0,"sions"],[401,0,"\n\nWhich algorithm was that? I"],[429,1,""],[429,0,"Mine. Well, I didn't invent it - but it was the algorithm I was using for ShareD"],[508,1,""],[508,0,"JS"],[133,57,""],[129,4,""],[129,0,"algorithms"],[129,10,""],[129,0,"way yo"],[134,1,""],[133,1,""],[132,1,""],[132,0,"s you could implement"],[172,0," (with CRDT and OT algorithms)"],[394,0," Yikes!"],[394,1,""],[394,0,"\n\n"],[403,1,""],[403,0," "],[403,1,""],[402,1,""],[402,0," "],[429,0,"Well, it was "],[442,1,""],[442,0,"m"],[448,5,""],[448,0,"I mean,"],[525,0," "],[525,1,""],[525,0,". The algorithm we used for Google Wave"],[275,3,""],[275,0,"But"],[323,8,""],[322,1,""],[322,0," simple"],[345,0,"s"],[351,7,""],[358,10,""],[357,1,""],[376,1,""],[375,1,""],[375,0," "],[382,1,""],[382,0,"\n\n"],[545,0,". The algorithm I knew for a fact didn't take 3 seconds to process large paste events. What was going on?\n\nI lo"],[652,4,""],[652,0,"Luckily "],[652,8,""],[652,0,"I took a closer look ad"],[674,1,""],[674,0,"nd it seemed like it was amateur hour in thier im"],[715,8,""],[715,0,"their implementation. "],[652,85,""],[652,0,"I took a closer look and it seemed like it was amateur hour in their implementation."],[637,0,"on earth "],[637,9,""],[736,0," When a large past even"],[754,1,""],[755,0," e"],[760,0,"t happened, instead of inserting one block of text, their algorithm was "],[818,10,""],[818,0,"code "],[827,0,"taking each character"],[839,0,"inserted "],[857,0," one by one and inserted"],[880,1,""],[879,1,""],[879,0,"ing them"],[839,48,""],[839,0,"new character one by one and inserte"],[874,1,""],[874,0,"ing them inti"],[886,1,""],[886,0,"o their obviou"],[894,6,""],[894,0,"ca"],[895,1,""],[895,0,"razy lsow "],[900,5,""],[900,0,"slow data structure. Gah - "],[926,1,""],[925,1,""],[925,0,"~ this isn't a problem"],[920,0," I mean, yeah- "],[934,1,""],[933,1,""],[933,0," - of course it'll be slow if you do that! But"],[980,1,""],[980,0,"g"],[1006,0," with the algorithm. Thisis"],[1032,1,""],[1031,1,""],[1031,0," is a "],[1016,9,""],[1016,0,"approach"],[1036,0,"problem withi "],[1049,1,""],[1048,1,""],[1048,0," *your code*."],[742,1,""],[742,0,"a user pasted a block fo "],[766,1,""],[765,1,""],[764,1,""],[764,0,"fo c"],[767,1,""],[766,1,""],[765,1,""],[764,1,""],[764,0,"of code"],[771,27,""],[758,0,"big "],[762,5,""],[762,0,"chunk"],[798,17,""],[798,0,"that stron"],[807,1,""],[806,1,""],[806,0,"ing in one operatoin"],[825,1,""],[824,1,""],[823,1,""],[823,0,"ion"],[771,4,""],[771,0,"text"],[797,0," all of that content"],[817,12,""],[834,1,""],[901,4,""],[901,0,"each one"],[920,6,""],[775,0," (say, 1000 characters)"],[821,22,""],[821,0,"those 1000 characters in"],[875,55,""],[875,0,"splitting each character"],[899,4,""],[904,0," its own edit"],[917,26,""],[917,0,"ing operation. They were processing 1000 operations rather than 1 and"],[1058,39,""],[1058,0,"isn't science. You just wrote"],[1087,18,""],[1089,4,""],[1089,0,"bad"],[1099,0," I can't le"],[1100,10,""],[1100,0,"That doesn't tell us anything about what you're trying to test. It just tells us something about *you*."],[811,15,""],[811,0,"creating 1 operation with"],[852,23,""],[852,0,", their"],[864,4,""],[873,1,""],[872,1,""],[871,1,""],[870,1,""],[870,0," the insert into"],[886,24,""],[886,0," 10000"],[891,1,""],[891,0," operations - each with its"],[910,30,""],[910,0,"which needed to p"],[926,1,""],[926,0,"be processed separately"],[950,56,""],[1010,3,""],[1009,1,""],[1010,6,""],[1010,0,"we can't learn anything from that"],[1043,15,""],[1043,0,"!"],[1034,0,"about the algorithm "],[1064,0," "],[1064,1,""],[1006,58,""],[1006,0,"This isn't a problem with thei"],[1035,1,""],[1034,1,""],[1034,0,"e algorithm. This is just a problem with"],[1074,15,""],[1074,0," your"],[1075,0,"*"],[1080,5,""],[1086,0," mr researcher"],[1086,14,""],[1081,0,"dodgy "],[1093,104,""],[1093,0," I wouldn't mind so much if people I "],[1121,0,"I didn't have people I respected"],[1153,9,""],[1153,0," reading the paper and asking me about it."],[1093,1,""],[1093,0,"\n\n"],[1153,1,""],[1152,1,""],[1153,7,""],[1153,0,"flipping throuhg"],[1168,1,""],[1167,1,""],[1166,1,""],[1166,0,"ugh"],[1203,0,"\n\n"],[1204,1,""],[1203,1,""],[1202,1,""],[1202,0,". Argh!\n\nWhen we think about CRDTs and other concurrenting"],[1259,1,""],[1258,1,""],[1257,1,""],[1257,0," editing "],[1247,19,""],[1247,0,"collaborative editing sytst"],[1273,1,""],[1272,1,""],[1271,1,""],[1271,0,"se"],[1272,1,""],[1272,0,"tems we have  a"],[1286,1,""],[1285,1,""],[1285,0,"a problem with words. We describe each system as an \"algorithm\" - but really there's two things going on"],[1374,0,"very separate "],[1388,6,""],[1388,0,"parts"],[1393,9,""],[1393,0,":\n\n1. The semantics of the system, which we can describe "],[1426,24,""],[1426,0,". When concurrent edits happen in the same place, how d"],[1480,1,""],[1480,0,"can we tell? What "],[1476,22,""],[1476,0,"what happens?"],[1474,0," in the document"],[1497,8,""],[1497,0,"ho"],[1497,2,""],[1497,0,"happens? How does it know? How does it resolve it"],[1544,2,""],[1544,0,"the situation?"],[1403,0,"*"],[1413,0,"*"],[1413,1,""],[1413,0,"*"],[1413,1,""],[1413,0," "],[1413,1,""],[1413,0,"*"],[1471,6,""],[1471,0,"locatoin "],[1479,1,""],[1478,1,""],[1477,1,""],[1476,1,""],[1476,0,"ion "],[1510,18,""],[1545,0,"\n\n2."],[1548,1,""],[1547,1,""],[1546,1,""],[1546,0,"2. The *implementatoin "],[1568,1,""],[1567,1,""],[1566,1,""],[1565,1,""],[1565,0,"ion* of the system. What langue"],[1595,1,""],[1595,0,"a"],[1595,1,""],[1595,0,"age? What data structures? "],[1621,1,""],[1598,0," are we using"],[1634,0," How well optimized is it, for "],[1661,4,""],[1661,0,"and for what scenarios?\n\nIf the semantics are correct"],[1707,7,""],[1707,0,"incorrect, users' edits won't converge. I'll end up looing "],[1765,1,""],[1764,1,""],[1763,1,""],[1762,1,""],[1762,0,"king at a different fr"],[1783,1,""],[1782,1,""],[1782,0,"ver"],[1685,100,""],[1684,1,""],[1684,0,"\n\n"],[1209,0," No! Stop it!"],[1300,18,""],[1300,0,"language problem"],[1433,0,"concurrent editing "],[1603,4,""],[1603,0,"that"],[1607,6,""],[1606,1,""],[1605,1,""],[1604,1,""],[1603,1,""],[1602,1,""],[1601,1,""],[1600,1,""],[1599,1,""],[1702,0,"My text OT algorithm from a few years ago"],[1702,0,"I've implemented "],[1719,3,""],[1719,0,"plain-"],[1743,20,""],[1743,0,"in a bunch of different languages "],[1776,1,""],[1776,0," - I use it as a way to guage"],[1800,5,""],[1800,0,"get a sense of a language w"],[1826,1,""],[1826,0,"I want to learn"],[1724,1,""],[1724,0," "],[1732,10,""],[1719,0,"a simple "],[1741,0," algorithm"],[1786,1,""],[1785,1,""],[1785,0,"."],[1849,0,". "],[1785,66,""],[1785,0,", because I got curious what it would look l"],[1814,15,""],[1814,0,"the same code would look like in C, and Javascript, and Typescript, and"],[1870,15,""],[1870,0,"swif"],[1870,4,""],[1870,0,"Swift and Go and ru"],[1870,10,""],[1879,0,"st"],[1877,1,""],[1877,0,"R"],[1881,0,". Same algorithm"],[1883,14,""],[1883,0,"The same "],[1883,9,""],[1883,0,"Its the same algorithm in each place. The transform"],[1700,0,"\n\nWhen we say a system is "],[1716,10,""],[1715,1,""],[1715,0,"n \"O"],[1718,1,""],[1717,1,""],[1716,1,""],[1716,0," \"algorithm\" is slow, what are we even talking about?"],[1771,4,""],[1771,0,"I"],[1771,0,"A few years ago "],[1801,1,""],[1801,0,"th"],[1801,2,""],[1801,0,"a"],[1869,7,""],[1869,0,"after"],[1874,6,""],[1874,0,"g "],[1875,1,""],[1874,1,""],[1874,0," getting"],[1896,3,""],[1896,0,"the"],[1898,1,""],[1898,0,"at"],[1900,5,""],[1921,3,""],[1921,0," translated into"],[1974,51,""],[1974,0,"The semantics are the same. The performance was absolutely not. In javs"],[2044,1,""],[2044,0,"ascript I could run my transform function abuot"],[2090,1,""],[2089,1,""],[2088,1,""],[2088,0,"out 1000"],[2095,1,""],[2095,0," 000 times per second. Not bad! But the same code"],[2140,4,""],[2140,0,"function in C ran at a rate of 20M/second."],[2154,0,"could "],[2160,16,""],[2160,0,"do"],[2160,3,""],[2160,0,"run "],[2167,0," times"],[2173,1,""],[2173,0," per "],[2185,0," 200x faster. Wow."],[1769,0," Mr "],[1770,3,""],[1769,1,""],[1702,0,"So "],[1705,1,""],[1705,0,"w"],[1705,1,""],[1705,0,"W"],[1704,1,""],[1702,2,""],[1769,0," (I\""],[1772,1,""],[1772,0,"'m looking at *you* mr "],[1794,1,""],[1793,1,""],[1792,1,""],[1792,0,"Mr French Sicn"],[1805,1,""],[1804,1,""],[1803,1,""],[1803,0,"cientist)."],[1802,9,""],[1802,0,"CS Researcher!"],[1819,0,"\nWhen "],[1820,5,""],[1820,0,"Sometimes when I pick up a new language I want to program something I already understand "],[1908,1,""],[1908,0,", in order to get a sense of things. I translated "],[1820,138,""],[1820,0,"Sometimes when I pick up a new language I want to program something I already understand, in order to get a sense of things. I translated"],[1957,31,""],[1957,0," "],[1958,1,""],[1958,0,"my"],[1945,0,"So I "],[1949,1,""],[1948,1,""],[1949,0," ended up"],[1968,1,""],[1967,1,""],[1967,0,"ing"],[1995,9,""],[1995,0,"code into"],[2004,3,""],[2005,101,""],[2006,5,""],[2006,0,","],[2019,4,""],[2022,4,""],[2022,0,","],[2028,0," and Swift"],[2040,26,""],[2040,0,"Same *semantics*"],[2056,1,""],[2056,0,". Same algri"],[2067,1,""],[2066,1,""],[2045,21,""],[2045,0,"algorithm - but"],[2061,1,""],[2061,0,"t"],[2080,11,""],[2084,0," even close"],[2155,3,""],[2154,1,""],[2154,0,"k"],[2154,1,""],[2154,0," 000"],[2244,0," Thats"],[2267,1,""],[2267,0,"!"],[2268,238,""],[2268,0,"\n\nS"],[2270,1,""],[2270,0,"---\n\nso "],[2277,1,""],[2276,1,""],[2275,1,""],[2274,1,""],[2274,0,"\nSo "],[2277,1,""],[2276,1,""],[2275,1,""],[2275,0,"## Automerge\n\nSo as you may n"],[2303,1,""],[2303,0,"know"],[2295,0,"["],[2308,0,"](), I've been playing with "],[2323,13,""],[2323,0,"getting interested in CRDT "],[2349,1,""],[2349,0,"s lately. Most c"],[2364,1,""],[2364,0,"CRDTs are super slow, and I always chalked that up to "],[2399,19,""],[2399,0,"assumed that aw"],[2413,1,""],[2412,1,""],[2412,0,"was some inherent problemw tih t"],[2443,1,""],[2442,1,""],[2441,1,""],[2440,1,""],[2439,1,""],[2438,1,""],[2437,1,""],[2437,0," with \"the algorithm\". ("],[2460,1,""],[2459,1,""],[2458,1,""],[2458,0," (oops). Anyway, surpri"],[2475,6,""],[2475,0,"in a surprising turn of events, I was making the same mistakes as those researchers. I was assuming "],[2566,9,""],[2566,0,"reading papers talkin g"],[2588,1,""],[2587,1,""],[2587,0,"g about he"],[2596,1,""],[2595,1,""],[2595,0,"the *semantics* and assm"],[2618,1,""],[2618,0,"uming that meant those algorithms needed to be implemented a certain way. A slow way. Because the algorithm"],[2712,0,"\""],[2726,0," is slow\". But I was so wrong.\n\n"],[2757,1,""],[2756,1,""],[2213,5,""],[2212,1,""],[2213,3,""],[2213,0,"ran"],[2190,0,"by using a few implem"],[2210,1,""],[2209,1,""],[2209,0,"ementation traic"],[2224,1,""],[2223,1,""],[2222,1,""],[2222,0,"icks, "],[2236,12,""],[2238,0," code"],[2238,5,""],[2236,0," function in"],[2253,1,""],[2252,1,""],[2252,0,"ru"],[2253,1,""],[2252,1,""],[2252,0,"uns i"],[2256,1,""],[2255,1,""],[2251,4,""],[2251,0,"does"],[2251,4,""],[2251,0,"runs"],[2259,6,""],[2259,0," interations"],[2260,11,""],[2260,0,"iterations"],[2306,0,"!"],[2306,1,""],[2412,5,""],[2412,0,"crazy"],[2449,4,""],[2449,0," there was"],[2502,7,""],[2503,0," Oops!"],[2509,40,""],[2511,0,"'ve been"],[2519,4,""],[2631,66,""],[2631,0,"we knew how"],[2639,3,""],[2639,0,"what those "],[2639,11,""],[2639,0,"how those *implementations* should work"],[2680,0,"That is, they should work *slowly* "],[2714,1,""],[2714,0,". But "],[2720,64,""],[2720,0,"it turns out I was super wrong. T"],[2752,1,""],[2751,1,""],[2751,0,"\n\nHow wrong? "],[2763,1,""],[2763,0,"\n"],[2763,1,""],[2763,0," Automerge"],[2764,0,"To run [this editing trace()"],[2791,1,""],[2790,1,""],[2790,0,"](), "],[2804,0," (a popular CRDT) takes 270 seconds. I've "],[2842,4,""],[2842,0," can run the same editing trace"],[2843,0,"have a new e"],[2854,1,""],[2854,0,"implementation that "],[2904,0," in "],[2841,67,""],[2841,0,"I have a new implementation that can run the same editing trace in 65ms"],[2911,1,""],[2910,1,""],[2909,1,""],[2908,1,""],[2908,0,"0.065 seconds."],[2878,3,""],[2878,0,"process"],[2926,0," Well"],[2915,16,""],[2915,0,"32 "],[2917,1,""],[2916,1,""],[2915,1,""],[2915,0,"23 seconds. Thats about 10 000 "],[2945,1,""],[2945,0,"x "],[2941,1,""],[2941,0," "],[2939,8,""],[2939,0,"ten thousand times faster. T"],[2966,1,""],[2965,1,""],[2965,0," Its the largest speed up I've ever gotten from optimization work - and its *delightful*!"],[3053,1,""],[3052,0,"!"],[3037,17,""],[3037,0,"I'm utterly delighted by it."],[2504,0,"Haha w"],[2509,1,""],[2509,0,"awkward"],[2516,5,""],[2516,0," -"],[2504,6,""],[2504,0,"Hah a"],[2625,0," of different algorithms"],[2671,9,""],[2671,0,"anything about how the"],[2725,35,""],[2690,35,""],[2690,0,"to make the *implementations* efficient."],[2670,15,""],[2751,0," Most "],[2752,5,""],[2752,0,"Lots of CS researchers don't"],[2752,8,""],[2752,0,"Actually "],[2776,5,""],[2776,0,"aren't super geniuses who've spent decades thinking"],[2804,0," also*"],[2805,0,"*"],[2834,0," about optimization"],[2841,0,"c"],[2841,1,""],[2841,0,"how you can "],[2864,1,""],[2863,1,""],[2862,1,""],[2861,1,""],[2860,1,""],[2860,0,"e code."],[2751,116,""],[2663,0,"that meant "],[2831,0,", written by [a popular researcher]()"],[2981,5,""],[2981,0,"a"],[2981,2,""],[3006,0," - 10000x (Y"],[3017,1,""],[3016,1,""],[3015,1,""],[3117,0,"\nLets talk about why automerge is slow, and all thes e"],[3170,1,""],[3169,1,""],[3168,1,""],[3168,0," steps tat "],[3178,1,""],[3177,1,""],[3176,1,""],[3176,0,"hat make it fast.\n\nWell actually, lets start with\n\n## What a"],[3235,1,""],[3235,0,"on earth is an automerge?"],[3247,3,""],[3257,0,"\n\n"],[3234,9,""],[3247,0," anyway"],[3257,0,"Automerge is an algorithm"],[3273,0,"implementation of the RGA "],[3299,9,""],[3299,0,"CRDT. S"],[3305,1,""],[3305,0,"Oops that doesn't help. Automerge"],[3270,68,""],[3270,0,"a library to help you do conc"],[3295,4,""],[3295,0,"collaborative editing. Its based on RGA"],[3322,0,"wrt"],[3324,1,""],[3324,0,"itten by Martin Kleppmann, who's a little bit famous from his Book"],[3389,1,""],[3388,1,""],[3387,1,""],[3386,1,""],[3386,0,"book and excellent talks. Its "],[3424,0," an algo"],[3428,4,""],[3427,1,""],[3426,1,""],[3426,0," "],[3426,2,""],[3426,0,"n algorithm called "],[3448,0,", which c"],[3456,1,""],[3456,0,"you can read about in a paper if you're into that sort of thing.\n\nWhen processing"],[3527,10,""],[3527,0,"doing "],[3522,11,""],[3522,0,"C"],[3522,1,""],[3522,0,"Collaborative text editing works by thinking about a string as a list"],[3548,0," in automerge"],[3522,39,""],[3522,0,"Like"],[3525,1,""],[3524,1,""],[3523,1,""],[3522,1,""],[3522,0,"Automerge (and other CRDTs "],[3548,1,""],[3548,0,") think of a st"],[3562,1,""],[3561,1,""],[3560,1,""],[3560,0," shared document as a list of characters. "],[3602,43,""],[3602,0,"When users"],[3602,10,""],[3602,0,"Each inserted item in the document "],[3606,9,""],[3607,4,""],[3607,0,"character"],[3633,0,"is inserted into a "],[3633,19,""],[3633,0,"gets a unique ID ("],[3650,1,""],[3650,0,"based on "],[3650,9,""],[3649,1,""],[3649,0," - which isn't as bad as you think,"],[3657,27,""],[3657,0," we ca"],[3660,3,""],[3657,3,""],[3657,0," isn't as bad as you think,"],[3657,27,""],[3650,7,""],[3649,1,""],[3649,0," based on "],[3649,10,""],[3649,0,", and each insert specifies that it in"],[3682,5,""],[3682,0,"w"],[3667,16,""],[3667,0,"names which"],[3655,0,"whneever"],[3655,8,""],[3655,0,"whenever you "],[3667,1,""],[3666,1,""],[3665,1,""],[3664,1,""],[3664,0,"insert something, you name"],[3690,23,""],[3690,0," what you're inserting after. Eg if I type \"abc\", automerge creates 3 itme"],[3763,1,""],[3763,0,"e"],[3763,1,""],[3762,1,""],[3762,0,"ems:\n\n- Inser "],[3775,1,""],[3775,0,"t 'a' id (seph, 0)`"],[3784,0,"`"],[3795,0," after (ROOT)"],[3807,1,""],[3807,0,"`"],[3802,1,""],[3802,0,"`"],[3768,0,"- Insert 'a' id `(seph, 0)` after `ROOT`\n"],[3819,1,""],[3819,0,"b"],[3833,1,""],[3833,0,"1"],[3844,4,""],[3844,0,"(seph, 0)"],[3809,0,"- Insert 'b' id `(seph, 1)` after `(seph, 0)`\n"],[3865,1,""],[3865,0,"c"],[3879,1,""],[3879,0,"2"],[3897,1,""],[3897,0,"1"],[3900,0,"\n\nHow w"],[3906,1,""],[3906,0,"should you "],[3902,15,""],[3902,0,"How should you"],[2867,0,"https://martin.kleppmann.com/"],[3945,0," represent that? A tree of course!\n\n> Diagram here"],[3961,0," Well, its a "],[3961,13,""],[3930,0,"\n"],[3930,0,"\nLet s"],[3935,1,""],[3934,1,""],[3934,0,"s say  "],[3940,1,""],[3940,0,"I und"],[3944,1,""],[3943,1,""],[3942,1,""],[3942,0,"insert a '"],[3951,1,""],[3950,1,""],[3950,0,"n 'x' between \""],[3964,1,""],[3964,0,"a and b'"],[3970,0,"'"],[3964,0,"'"],[3966,0,"'"],[3966,1,""],[3964,1,""],[3964,0,"*"],[3966,0,"*"],[3974,1,""],[3974,0,"*"],[3973,1,""],[3972,1,""],[3972,0,"*b"],[3975,0,", so I get \"ab"],[3988,1,""],[3988,0,"Xbc\". I get these items:"],[3994,18,""],[3994,0,"Wh"],[3995,1,""],[3994,1,""],[3994,0,"Then we have:\n\n\n- Insert 'a' id `(seph, 0)` after `ROOT`\n- Insert 'b' id `(seph, 1)` after `(seph, 0)`\n- Insert 'c' id `(seph, 2)` after `(seph, 1)`"],[4008,1,""],[4009,0,"- Insert 'a' id `(seph, 0)` after `ROOT`\n"],[4060,1,""],[4060,0,"x"],[4074,1,""],[4074,0,"3"],[4089,0,")"],[4085,0,"("],[4086,4,""],[4086,0,"seph, 0"],[4188,0,"\n"],[4188,0,"\nThis isn't goo"],[4189,14,""],[4189,0,"Note the 'x' and 'b' both "],[4189,26,""],[4189,0,"Note the 'x' and 'b' both"],[4216,65,""],[3930,0,"\n"],[3930,0,"\nHow should you represent that? A tree of course!\n\n> Diagram here\n"],[3995,1,""],[4280,0," insert at the same location. S"],[4310,1,""],[4310,0,"This will happen when c"],[4332,1,""],[4332,0,"usert"],[4336,1,""],[4336,0,"s type in the same location, and we normally compare the item IDs to figure out which in"],[4423,1,""],[4422,1,""],[4416,6,""],[4416,0,"wh"],[4365,53,""],[4364,1,""],[4363,1,""],[4338,4,""],[4338,0,"concurrently type"],[4376,0,"."],[4281,27,""],[4281,0,"share the samer"],[4295,1,""],[4295,0," parent"],[4313,0," sometimes"],[4380,1,""],[4380,0,", and we can resolve that by comparing their item IDs. But not in this case! In this case I "],[4471,1,""],[4470,1,""],[4470,0,"my new item should "],[4470,19,""],[4470,0,"no matter what the IDs are we should always end up with \"a"],[4019,1,""],[4019,0,"X"],[4126,1,""],[4126,0,"X"],[4005,2,""],[4005,0," Mike"],[4017,0,"s"],[4050,1,""],[4050,0,"we"],[4064,0," "],[4064,1,""],[4139,7,""],[4139,0,"mike, 0"],[4443,4,""],[4443,0," we don't want to do that"],[4496,0,"*"],[4511,0,"*"],[4496,1,""],[4510,1,""],[4554,0,"Xbc\". RGA solves this by adding more information"],[4586,16,""],[4586,0,"a sequ"],[4588,4,""],[4587,1,""],[4587,0,"n extra item to "],[4586,17,""],[4586,0,"a tiny bit more data to each item. "],[4260,361,""],[4260,0,"Note the 'x' and 'b' both share the same parent. This will sometimes happen when users concurrently type in the same location, and we can resolve that by comparing their item IDs. But we don't want to do that in this case! In this case no matter what the IDs are we should always end up with \"aXbc\". RGA solves this by adding a tiny bit more data to each item."],[4587,0,"n extra integer"],[4602,19,""],[4615,1,""],[4615,0,","],[4615,1,""],[4615,0," call "],[4620,1,""],[4620,0,"ed a *sequence number*:"],[4644,0,"\n- Insert 'a' id `(seph, 0)` after `ROOT`\n- Insert 'X' id `(mike, 0)` after `(seph, 0)`\n- Insert 'b' id `(seph, 1)` after `(seph, 0)`\n- Insert 'c' id `(seph, 2)` after `(seph, 1)`\n"],[4685,0,", seq: 0*"],[4692,0,"*"],[4741,0,", seq: *0*"],[4797,0,", seq: *0*"],[4853,0,", seq: *0*"],[4805,1,""],[4805,0,"1"],[4861,1,""],[4861,0,"2"],[4749,1,""],[4749,0,"3"],[4642,1,""],[4642,0,". I"],[4644,1,""],[4643,1,""],[4642,1,""],[4642,0,":"],[4865,0,"Automerge's *semantics* are:\n\n- Everything goes after its"],[4913,9,""],[4913,0,"right after itse "],[4929,1,""],[4928,1,""],[4928,0," parent"],[4897,38,""],[4897,0,"Imagine the tree"],[4897,16,""],[4897,0,"Build the tree\n- If "],[4912,5,""],[4912,0,"- If"],[4911,0," from each item to its parents, all the way up."],[4963,0," two items have"],[4961,17,""],[4961,0,"Whenever you h"],[4970,5,""],[4970,0,"an item has children, put all the "],[4959,45,""],[4959,0,"- Whenever an item has children, put all the"],[4864,0,"\n"],[4864,0,"\nYjs"],[4865,3,""],[4865,0,"This isn't the only approach. Yjs solves this by "],[4865,49,""],[4864,1,""],[4863,1,""],[4911,0,", connecting"],[4923,5,""],[4947,18,""],[4970,0," multiple"],[4990,11,""],[4990,0,"sort them first by sequence number then by ID.\n\n"],[5037,0,"- The list "],[5047,1,""],[5047,0,"'s value is "],[5047,12,""],[5047,0," is whatever you get from flattening the tree with a depth-first so"],[5113,1,""],[5113,0,"earch."],[5111,8,""],[5111,0," traversal."],[5123,0,"\n"],[4874,0," (RGA)"],[5130,0,"So how should you implement"],[3931,48,""],[3931,0,"We can draw t"],[3943,1,""],[3943,0,"that like a "],[3948,7,""],[3948,0,"as a tree!"],[5127,0,"*"],[5137,0,"* automerge? The automerge library does it in the obvious tree based way. Each time an insert happens, we look up"],[5211,39,""],[5210,1,""],[5210,0," Ac"],[5212,1,""],[5212,0,"t least I think so - "],[5109,124,""],[5109,0,"So how should you *implement* automerge? The automerge library does it in the obvious tree based way. At least I think so - I h"],[5235,1,""],[5235,0,"honestly have"],[5233,15,""],[5233,0,"this is automerges"],[5250,1,""],[5250,0,"'s internal state after typing \"abc\""],[5233,0,"["],[5268,0,"](https://gist.github.com/josephg/0522c4aec5021cc1dddb60e778828dbe)"],[5354,0,". Yikes!"],[5826,0,"\n"],[6009,0,"\n"],[6035,0,"\n"],[6496,0,"\n"],[6956,0,"\n"],[6986,0,"\n"],[7167,0,"\n"],[7206,0,"\n"],[7368,0,"\n"],[7425,0,"\n"],[7477,0,"\n"],[5363,0,"\n\n\n\n\n"],[5364,0,"We "],[5366,1,""],[5365,1,""],[5364,1,""],[5364,0,"For benchmarking, I'm using [Marin"],[5397,1,""],[5396,1,""],[5396,0,"tin's editing trace](https://github.com/automerge/automerge-perf/)"],[5401,0," atuomera"],[5402,8,""],[5402,0,"automerge-perf"],[5477,0,". Martin rec"],[5479,10,""],[5479,0,"This is an editing history where m"],[5512,1,""],[5512,0,"Martin just"],[5518,5,""],[5518,0," recorded each keystroke while writing an academic paper. "],[5575,1,""],[5575,0," How does it do?\n\n"],[5356,6,""],[5356,0,"Yeah, I have no idea whats going on here."],[5356,6,""],[5241,0," ss"],[5243,1,""],[5242,1,""],[5242,0,"*some o"],[5248,1,""],[5247,1,""],[5247,0,"*"],[5247,1,""],[5247,0," of*"],[5250,1,""],[5242,1,""],[5613,15,""],[5612,1,""],[5612,0," How does it do?"],[5622,2,""],[5622,0,"automerge"],[5613,0,"So "],[5616,1,""],[5616,0,"h"],[5639,0,"\nTest"],[5640,0,"| "],[5646,0,"    | Time taken |\n| ------- | ---------- |"],[5665,0,"| ------- | ---------- |\n"],[5692,7,""],[5692,0,"automerge"],[5704,10,""],[5704,0,"26"],[5705,1,""],[5705,0,"70s"],[5232,0," after typing\""],[5245,1,""],[5245,0," \"abc\""],[5362,19,""],[5612,0," There's no concurrent edits in this trace (its just a single user), but its "],[5688,1,""],[5687,1,""],[5686,1,""],[5685,1,""],[5685,0,"concurrent edits "],[5685,17,""],[5685,0,"thats probably fine for now."],[5714,25,""],[5714,0,"As I said before, automerge takes a little under 5 minutes to process this editing trace:"],[5802,1,""],[5802,0,". I'm also going to in c"],[5825,1,""],[5824,1,""],[5824,0,"clude a simple baseo"],[5843,1,""],[5843,0,"line comparison, where we just splice() "],[5874,0,"use javascripts'"],[5889,1,""],[5888,1,""],[5888,0,"'s "],[5874,26,""],[5874,0,"create a javascript s"],[5959,0,"@ 1.0.0-preview2 "],[5704,8,""],[5705,0," Users typing "],[5712,7,""],[5712,0,"concurrently typing in the same location is super rare anyway."],[5774,1,""],[5774,0,"\n\n"],[5957,0,"tring and split"],[5971,1,""],[5963,0,"in the obvious way "],[5990,0,"ce into it:"],[6053,0,"| automerge @ 1.0.0-preview2 | 270s |\n"],[6084,3,""],[6084,0,"291"],[6122,3,""],[6093,26,""],[6093,0,"baseline"],[6093,0,"JS "],[6107,0,"0.61"],[6010,0,"                   "],[6056,0," "],[6056,1,""],[6056,0,"-------------------"],[6143,0,"               "],[6165,0,"     "],[6127,0,"      "],[6180,0,"### Why is atuomer"],[6191,7,""],[6191,0,"automerge slow?"],[6179,0,"\n"],[6208,0,"\nA"],[6209,1,""],[6209,0,"Automerge is slow for 3 reasons:\n\n1. Automerge uses "],[6256,5,""],[6256,0,"makes heavy use of immutable.js. Immutablejs is a library which gives you closure-like "],[6333,1,""],[6333,0,"j"],[6343,0,"semantis "],[6351,1,""],[6350,1,""],[6350,0,"cs in javascript"],[6352,3,""],[6352,0," for"],[6367,0," objects"],[6343,0,"copy-on-write "],[6389,0,". The "],[6391,4,""],[6391,0,"This is a cool set of functionality, but the optimizer *hates* this"],[6446,12,""],[6446,0,"gets"],[6436,0,"v8 "],[6436,1,""],[6436,0,"V"],[6453,0," really confused by immutablejs and it dramatics "],[6501,1,""],[6500,1,""],[6500,0,"ally decreases "],[6504,0," "],[6492,13,""],[6492,0,"increases memory usage and"],[6529,0,"performance\n2. Automerge'"],[6540,0,"."],[6555,0,"d "],[6556,1,""],[6555,1,""],[6555,0,"s data structures"],[6571,1,""],[6571,0,"s aren't very good."],[6449,35,""],[6449,0,"has no idea how to optimize immutablejs"],[6477,0,"code that makes heavy use of "],[6517,0,"."],[6518,4,""],[6518,0," As a result, "],[6531,1,""],[6448,0," & GC"],[6602,36,""],[6602,0," needs to do a lot of data "],[6628,1,""],[6623,5,""],[6620,3,""],[6616,4,""],[6614,2,""],[6611,3,""],[6608,3,""],[6602,6,""],[6602,0,"'s data structures aren't very good."],[6602,36,""],[6602,0," uses the wrong data structure for RGA (!!)"],[6632,0,"s"],[6633,8,""],[6638,0,"\n3. Atuomerg"],[6642,8,""],[6642,0,"Automerge is s"],[6655,1,""],[6655,0,"written "],[6639,24,""],[6639,0,"3. Automerge is written"],[6231,2,""],[6231,0,"a handful of "],[6663,10,""],[6663,0,"treats each inserted character as a separate item. Remember that paper I talked about earlier? Automerge makes the same mistake!"],[6790,1,""],[6790,0,".\n\n"],[6792,1,""],[6792,0,"4. Javascript"],[6502,19,""],[6502,0," uses"],[6465,18,""],[6465,0,"struggles to"],[6736,0," "],[6736,1,""],[6736,0,", where copy+paste operations are slow"],[6808,1,""],[6808,0,"!"],[6823,0," just isn"],[6831,1,""],[6831,0,"nn't "],[6835,1,""],[6834,1,""],[6833,1,""],[6832,1,""],[6832,0,"'t very faste "],[6845,1,""],[6844,1,""],[6844,0," anyway"],[6824,27,""],[6823,1,""],[6813,0,"Complex data structures are extra slow because of "],[6873,0,"\n\nYou can see most of these"],[6887,13,""],[6887,0,"some of these issues looking at "],[6887,32,""],[6887,0,"a lot of this stuff o"],[6907,1,""],[6907,0,"going on in this function from automerge:\n\n```javascript\n\n"],[6964,1,""],[6964,0,"function insertionsAfter(opSet, objectId, parentId, childId) {\n  let childKey = null\n  if (childId) childKey = Map({opId: childId})\n\n  return opSet\n    .getIn(['byObject', objectId, '_following', parentId], List())\n    .filter(op => op.get('insert') && (!childKey || lamportCompare(op, childKey) < 0))\n    .sort(lamportCompare)\n    .reverse() // descending order\n    .map(op => op.get('opId'))\n}\n```"],[6924,13,""],[6923,1,""],[6933,0," functoin"],[6941,1,""],[6940,1,""],[6939,1,""],[6939,0,"ion"],[7358,0,"\n\nThis is called on each insert, to figure out how to sort"],[7411,5,""],[7409,2,""],[7409,0,"the children onf"],[7424,1,""],[7423,1,""],[7423,0,"f an item should be sorted."],[6599,4,""],[6594,5,""],[6594,0,"picks the wrong "],[6604,6,""],[6629,0," we'll talk about this soon!"],[6842,60,""],[6842,0,"Javascript"],[6842,10,""],[6842,0,"Complex data structures are extra slow in ajvas"],[6884,5,""],[6884,0,"javascript."],[6894,1,""],[6896,68,""],[6896,0,"Look at this function from automerge:"],[7440,0," There are so many things slow about this:\n\n- There are 5 objects"],[7496,1,""],[7496,0,"6"],[7497,8,""],[7497,0," allocations in this function. Can you"],[7528,0,"("],[7536,0," spot them all?)"],[7485,11,""],[7485,0,"I "],[7486,1,""],[7485,1,""],[7485,0," I can spot "],[7497,1,""],[7497,0,"6"],[7497,1,""],[7497,0,"7"],[7527,0," "],[7527,1,""],[7527,0,". 5 if you don't include the two closures"],[7570,1,""],[7570,0,"("],[7579,4,""],[7579,0,"find"],[7528,41,""],[7528,0," (Though 2 should be hoisted)."],[7530,0,"t"],[7530,1,""],[7536,0," the 2 closures"],[7551,2,""],[7572,1,""],[7594,1,""],[7594,0,")"],[7572,0,"("],[7596,0,"\n- The items are already sorted by lamportCompare"],[7613,8,""],[7637,0," before this method is called"],[7622,0," "],[7622,1,""],[7622,0," the inverse of"],[7681,0,". Sorting a list"],[7596,0,"\n- The List()`"],[7603,0,"`"],[7611,0," argument has no effect"],[7621,0,"to `getO"],[7628,1,""],[7628,0,"In`"],[7597,47,""],[7596,1,""],[6909,8,""],[6909,0,"code in"],[6916,5,""],[6914,2,""],[6914,0,"r"],[6914,1,""],[6914,0,"from"],[6944,0,"\nfunction lamportCompare(op1, op2) {\n  return opIdCompare(op1.get('opId'), op2.get('opId'))\n}\n"],[7702,0," already"],[7717,19,""],[7717,0," -"],[7733,0,")"],[7733,1,""],[7733,0,"()"],[7718,0,"reverse-"],[7725,1,""],[7741,1,""],[7740,1,""],[6207,0,"\n\nwheneve"],[6209,7,""],[6209,0,"Whenever"],[6209,8,""],[6209,0,"The p"],[6209,5,""],[6209,0,"My philosophy with performance tuning"],[6209,37,""],[6209,0,"There's an old saying with performance tuning: "],[6255,1,""],[6255,0,"\n\n> You can't make a program faster. You can only make it do less work."],[6209,119,""],[6895,0,"\n\n"],[6896,0,"There"],[6896,6,""],[6895,1,""],[6209,0,"There's an old saying with performance tuning:\n\n> You can't make a program faster. You can only make it do less work.\n\n"],[6209,119,""],[6895,0,"\nThere's an old saying with performance tuning:\n\n> You can't make a program faster. You can only make it do less work.\n\n"],[7014,1,""],[7014,0,"\nSo we wan"],[7018,6,""],[7018,0,"how do we make the computer *do *"],[7050,1,""],[7049,1,""],[7046,3,""],[7046,0,"do l"],[7049,1,""],[7048,1,""],[7047,1,""],[7046,1,""],[7046,0,"c"],[7046,1,""],[7046,0,"do all the work of "],[7049,16,""],[7049,0,"less work here?\n"],[7066,0,"T"],[7066,1,""],[7066,0,"Exhibit A: Take a look "],[7089,5,""],[7116,1,""],[7116,0,":"],[7729,0,"*"],[7744,0,"*"],[7718,0," I don't know how hot it is, but"],[7751,1,""],[7751,0,"t"],[8007,0," is "],[8003,8,""],[8002,1,""],[8002,0,"n anti-sorted list is slow"],[8024,4,""],[8024,0,"the slowest sort. You could easily just"],[8042,21,""],[8042,0,"The code could easily just swap the j"],[8078,1,""],[8035,0," way to"],[8047,0," anything"],[8058,36,""],[8058,0,"Rather than sorting, then reverse()'ing, this could j"],[8110,1,""],[8109,1,""],[8104,5,""],[8104,0,"code should just invert the arguments of `lamportCompare` (or negat e"],[8172,1,""],[8171,1,""],[8171,0,"e the return value)."],[8141,3,""],[8141,0," in"],[8161,0,", or make "],[8162,9,""],[8161,1,""],[8191,0,"\n- The goal is to insert the new item into the list"],[8194,0,"If "],[8197,1,""],[8197,0,"t"],[8244,1,""],[8244,0,"t, you can do that with a for loop."],[8263,0,"much faster "],[8237,3,""],[8237,0,"an already sorted"],[8296,0,"single "],[8194,4,""],[8194,0,"T"],[8216,4,""],[8216,0,"a "],[8254,1,""],[8254,0,"."],[8256,1,""],[8256,0,"Y"],[8291,7,""],[8300,0,"\n- This code wrapped"],[8319,1,""],[8318,1,""],[8317,1,""],[8317,0,"s childId with "],[8327,5,""],[8327,0,"into a "],[8333,1,""],[8333,0,"n immutablejs Map, just so the argument matches lamportCompare`"],[8381,0,"`"],[8397,0," - which just "],[8406,5,""],[8406,0,"unwraps it again. "],[8423,1,""],[8423,0," This work is all avoidable."],[8440,0," computat"],[8440,9,""],[8453,0,"\n\n\n"],[8405,0," then"],[8429,27,""],[8429,0,"Don't do that!"],[8429,0,"Nooo! "],[8435,14,""],[8435,0,"Stopp"],[8439,1,""],[8439,0,"!!!"],[8441,1,""],[8440,1,""],[8440,0,"\n\n### "],[8445,1,""],[8445,0,"# Alg"],[8447,3,""],[8447,0,"Data structures\n\n"],[8441,0,"\n"],[8465,0,"But the much bigger reason"],[8465,26,""],[8465,0,"The biggest reason atu"],[8486,1,""],[8485,1,""],[8485,0,"utomerge is slow is that"],[2504,3,""],[2504,0,"But this is"],[2581,1,""],[2581,0,"!"],[2782,0," Super wrong."],[2796,6,""],[2796,0,"Running"],[2927,3,""],[2927,0,"291"],[3031,0," over"],[3066,1,""],[3066,0,"2"],[3067,1,""],[3067,0,"5"],[3067,1,""],[3067,0,"6"],[3067,1,""],[3066,1,""],[3066,0,"26"],[3067,1,""],[3067,0,"7"],[6259,0," whole slew"],[6270,8,""],[6924,0,"\n\nReally, it was just never written wtih "],[6964,1,""],[6963,1,""],[6962,1,""],[6961,1,""],[6961,0,"ith performance in mind."],[8556,44,""],[8556,0,"But all this is window dressing. The real read"],[8601,1,""],[8601,0,"so"],[8556,47,""],[8556,0,"The first"],[8556,0,"But the real"],[8568,3,""],[8574,0," thing to fix here is the a"],[8560,41,""],[8560,0,"this is all a big distraction. The big "],[8598,1,""],[8598,0,"gest thing to fi i"],[8615,1,""],[8614,1,""],[8614,0,"x is the algorithm. Th"],[8635,1,""],[8634,1,""],[8633,1,""],[8632,1,""],[8603,0,"and first "],[8633,0,"core "],[8647,0," & data stru"],[8658,1,""],[8658,0,"cu"],[8659,1,""],[8658,1,""],[8658,0,"ucture. "],[8638,12,""],[8654,0,"In automerge"],[8654,12,""],[8654,0,"Automerge seems to store a bunch of nested lists, but there's a better way to do this."],[6688,0,"\n1. Automerge makes heavy use of immutable.js. Immutablejs is a library which gives you clojure-like copy-on-write semantics for javascript objects. This is a cool set of functionality, but the V8 optimizer & GC struggles to optimize code that uses immutablejs. As a result, it increases memory usage and decreases performance."],[6284,328,""],[6284,0,"1"],[6362,1,""],[6362,0,"2"],[7156,0,"\n\n\n\n"],[7157,0,"\n"],[7157,0,"\n"],[7157,1,""],[7157,0,"The most important"],[7157,18,""],[7157,0,"i"],[7157,1,""],[7157,0,"With this sort of thing the first step always has"],[7181,25,""],[7181,0,"we always have to start with macro optimizations. As in "],[7231,6,""],[7231,0,"And in this case, the biggest problem is Automerge"],[7272,9,""],[7272,0,"automerge's complex tree based data structure.\n\nI wish I could take credit for this insight. Kevin Jahns - who wrote a "],[7390,1,""],[7390,0," ("],[7391,1,""],[7390,1,""],[7390,0,"nohter ("],[7389,9,""],[7389,0,"another (much better) CRDT"],[7320,95,""],[7320,0,"There's a better "],[7320,17,""],[7320,0,"The first change"],[7318,0," Complex data structures are "],[7319,28,""],[7318,1,""],[7336,0," we'll make here is replacing Automer"],[7366,7,""],[7366,0,"automerge's tree with a list. So instead of:\n\n```\n\n\n```"],[7416,0,"state = {\n  \n  "],[7426,2,""],[7427,2,""],[7427,0,"}"],[7428,1,""],[7426,0,"  {i"],[7429,1,""],[7429,0,"\n    "],[7432,2,""],[7430,2,""],[7429,1,""],[7429,0," item: 'a', children:"],[7441,0,"id, seq, "],[7459,0," [\n    \n    "],[7462,4,""],[7463,4,""],[7463,0,"  ]}"],[7426,0,"  { item: 'a', id, seq, children: [\n"],[7464,0,"  "],[7475,1,""],[7475,0,"b"],[7462,0,"    { item: 'b', id, seq, children: [\n"],[7504,0,"  "],[7515,1,""],[7515,0,"c"],[7540,0,"      ]"],[7500,47,""],[7500,0,"      { item: 'c', id, seq, children: [ ]"],[7539,1,""],[7540,0,"}\n      "],[7542,6,""],[7542,0,"    ])"],[7547,1,""],[7547,0,"}"],[7409,0," somethingl ike"],[7423,1,""],[7422,1,""],[7421,1,""],[7420,1,""],[7419,1,""],[7419,0," like"],[7253,19,""],[7264,0," biggest problem is its"],[7324,0,"So "],[7327,1,""],[7327,0,"t"],[7563,0,"\n      { item: 'c', id, seq, children: []}"],[7563,0,"\n    { item: 'b', id, seq, children: ["],[7484,44,""],[7484,0,"    "],[7437,0,"javascript"],[7507,1,""],[7507,0,"X"],[7533,0,","],[7632,0,"\n\nWe'll put all the items in a single flat list:"],[7682,0,"```javascript\nstate = {\n  { item: 'a', id, seq, children: [\n    { item: 'X', id, seq, children: []},\n    { item: 'b', id, seq, children: [\n      { item: 'c', id, seq, children: []}\n    ]}\n  ]}\n}\n```\n"],[7704,1,""],[7704,0,"["],[7875,1,""],[7875,0,"]"],[7730,11,""],[7730,0,"parent"],[7730,6,""],[7730,0,"children: ["],[7849,11,""],[7849,0,"p"],[7809,11,""],[7809,0,"p"],[7768,11,""],[7768,0,"p"],[7730,11,""],[7730,0,"p"],[7820,0,"a"],[7790,0,"a"],[7759,0,"a"],[7731,0,"a"],[7824,0,"r"],[7793,0,"r"],[7761,0,"r"],[7732,0,"r"],[7828,0,"e"],[7796,0,"e"],[7763,0,"e"],[7733,0,"e"],[7832,0,"n"],[7799,0,"n"],[7765,0,"n"],[7734,0,"n"],[7836,0,"t"],[7802,0,"t"],[7767,0,"t"],[7735,0,"t"],[7840,0,":"],[7805,0,":"],[7769,0,":"],[7736,0,":"],[7844,0," "],[7808,0," "],[7771,0," "],[7737,0," "],[7847,1,""],[7810,1,""],[7772,1,""],[7737,1,""],[7843,1,""],[7807,1,""],[7770,1,""],[7736,1,""],[7840,0," "],[7805,0," "],[7769,0," "],[7736,0," "],[7844,0,"}"],[7808,0,"}"],[7771,0,"}"],[7737,0,"}"],[7773,3,""],[7809,6,""],[7809,0,"    "],[7774,4,""],[7774,0,"  "],[7739,4,""],[7739,0,"  "],[7805,4,""],[7805,0,"  "],[7840,12,""],[7475,0,": {}"],[7478,1,""],[7477,1,""],[7477,0,"[]"],[7478,0,"'seph', 0"],[7493,0,": 0"],[7529,0,": [..]"],[7576,0,": [..]"],[7622,0,": [..]"],[7872,1,""],[7871,1,""],[7772,0,","],[7806,0,","],[7840,0,","],[7874,0,","],[7874,1,""],[7324,25,""],[7324,0,"Ther's a"],[7331,1,""],[7330,1,""],[7329,1,""],[7328,1,""],[7328,0,"e's a better way "],[6332,28,""],[7127,0," There's lots of performance wins to be had, but"],[7175,3,""],[7175,0," w"],[7200,17,""],[7200,0,"its always best to"],[7249,0,", since the mmicr"],[7257,9,""],[7257,0,"there's no point optimizing code you might be about to throw out anyway"],[7330,5,""],[7330,0,"I"],[7419,0,"Luckily, "],[7428,1,""],[7428,0,"t"],[7449,0,"to implement CRDTs which we can steal from Yjs - "],[7492,6,""],[7492,0,"mt "],[7494,1,""],[7493,1,""],[7493,0,"y favorite CRDT implementation - Yjs. Yjs "],[7467,0,". I wish I could claim I invented this, b"],[7469,39,""],[7468,1,""],[7467,1,""],[7467,0,", which we can see in my favorite CRDT "],[7506,42,""],[7520,0,":"],[7521,2,""],[7531,0,"make a "],[7537,1,""],[7536,1,""],[7535,1,""],[7535,0,"s a clever, obvious trick that"],[7565,83,""],[7565,0," I don't think anyone else noticed. Instead of implementing the CRDT as a tree like this:"],[7890,5,""],[7890,0,"Yjs"],[7897,0,"s"],[7925,5,""],[7986,0,": null"],[8026,0,": null"],[8031,1,""],[8030,1,""],[8029,1,""],[8028,1,""],[7973,0,": ['seph', 0]"],[8041,0,"['seph', 0]"],[8086,0,": ['seph', 0]"],[8133,0,": ..."],[8137,1,""],[8136,1,""],[8135,1,""],[8134,1,""],[8134,0," [..]"],[8148,0,"\nYjs implements a different"],[8152,0," actually does a few things differently. It"],[8207,11,""],[8207,0,"lg"],[8208,1,""],[8207,1,""],[8207,0,"a different CRDT (so d"],[8228,1,""],[8228,0,"it has different semantics)"],[8254,0," than RGA"],[8244,0,", b"],[8246,1,""],[8246,0,"slight"],[8244,8,""],[8234,0," slightly"],[8273,0,". But"],[8275,3,""],[8275,0,"And it uses a linked list, "],[8301,1,""],[8300,1,""],[8300,0," instead of an array, but we're jumping ahead."],[8149,0,"(Actually "],[8162,9,""],[8346,1,""],[8346,0,"!)\n\n"],[7527,0,"Yhs"],[7529,1,""],[7528,1,""],[7528,0,"hs does"],[7527,8,""],[7527,0,"Yjs doesn't need a whole blog post about how to make it faster because its alreadt "],[7609,1,""],[7608,1,""],[7608,0,"y fast. It got there by using"],[7637,9,""],[7995,0,"just "],[8302,0," also"],[8335,50,""],[8411,0,"The question is, how do you insert a new item into a list like this? With automerge the anse"],[8502,1,""],[8502,0,"wer is:\n\n- Find t"],[8511,1,""],[8511,0,"1."],[8520,0,"he parent item\n2. Add"],[8538,3,""],[8538,0,"Find"],[8538,4,""],[8538,0,"Add the new item to the parents' children in the approp"],[8587,6,""],[8587,0,"right spot\n\nWt"],[8600,1,""],[8600,0,"ith the list approach"],[8253,0,"\n\nSo, put the"],[8255,11,""],[8254,1,""],[8253,1,""],[8621,0," its:\n\n1. Find the parent item\n2. Scan "],[8655,5,""],[8655,0,"Skip over items"],[8655,0,"Iterate through the list, "],[8681,1,""],[8681,0,"s"],[8685,0,"ping"],[8700,0," whih "],[8705,1,""],[8704,1,""],[8704,0,"ch should om"],[8715,1,""],[8714,1,""],[8714,0,"come before t"],[8726,1,""],[8726,0,"the new item\n3. Insert"],[8538,3,""],[8538,0,"Insert"],[8557,3,""],[8557,0," into"],[8576,8,""],[8576,0,"list of children"],[8761,0," it there\n\nBasically we're doing an insertion sort."],[8788,5,""],[8788,0,"implementing"],[8801,2,""],[8801,0,"a fancy"],[8824,0,"\n\n\n\n"],[6841,55,""],[6840,1,""],[8731,0," going to replace Automerge's tree"],[8777,1,""],[8776,1,""],[8775,1,""],[8775,0,"ation with"],[8554,0,"\n3.W"],[8557,1,""],[8557,0," Walk up the tree to figure out the in"],[8593,2,""],[8593,0,"positional insert location"],[8555,64,""],[8554,1,""],[8554,0,"\n3. Walk up the tree to figure out the positional insert location"],[8589,30,""],[8589,0,"where we're actually inserting"],[8589,30,""],[8589,0,"the index where we're actually inserting"],[8555,74,""],[8554,1,""],[8695,0," ("],[8696,1,""],[8695,1,""],[8810,0,"\nThis code sounds complex, but its"],[8841,3,""],[8841,0,"it ends up being about 20 lines of code, ri"],[8883,1,""],[8882,1,""],[8882,0,"written using "],[8890,6,""],[8890,0,"in long form"],[8882,0,"["],[8903,0,"]"],[8903,1,""],[8903,0," here](https://github.com/josephg/reference-crdts/blob/fed747255df9d457e11f36575de555b39f07e909/crdts.ts#L401-L459). This code"],[9020,9,""],[8811,209,""],[8811,0,"This code sounds complex, but it ends up being about 20 lines of code, [written in long form here](https://github.com/josephg/reference-crdts/blob/fed747255df9d457e11f36575de555b39f07e909/crdts.ts#L401-L459)."],[8731,9,""],[8726,5,""],[8726,0,"I'm prompo"],[8735,1,""],[8734,1,""],[8733,1,""],[8733,0,"posii"],[8737,1,""],[8737,0,"ng"],[8746,1,""],[8746,0,"ing"],[8750,1,""],[8750,0,"a"],[8821,23,""],[8817,4,""],[8812,5,""],[8812,0,"You can write the whole algorithm"],[8836,9,""],[8836,0,"implementation"],[8850,15,""],[8850,0," in "],[8836,14,""],[8836,0,"insertion"],[8844,1,""],[8843,1,""],[8842,1,""],[8842,0," function"],[8877,1,""],[8877,0,"."],[8880,25,""],[8880,0,"Or 50 lines "],[8891,1,""],[8891,0," if you want to be v"],[8904,7,""],[8904,0,"com"],[8892,15,""],[8891,1,""],[8891,0," if I feel like it. You're not the boss of me."],[8810,0," The semantics are the same, the implementation is different."],[8810,61,""],[9050,0,"This implem"],[9055,6,""],[9055,0,"is semantically the same"],[9058,0,"*"],[9071,0,"*"],[9048,0,"\n\nThe beauti"],[9059,1,""],[9058,1,""],[9057,1,""],[9057,0,"utiful thing"],[9050,19,""],[9050,0,"There's a few beautiful things about this approach:\n\n1. You can implement C"],[9124,1,""],[9124,0,"Yjs, Automerge and Sync9 an"],[9138,4,""],[9138,0,","],[9148,0,"d other semantics in the same codebase. That github project ha"],[9188,22,""],[9188,0,"My [reference-crdts](https://github.com/josephg/reference-crdts) project implements all 3 of those algorithms using the same "],[9297,16,""],[9297,0,", just "],[9299,5,""],[9299,0,"mostly just swapping out the insert function."],[9334,0," (integrate)"],[9356,0,"\n2. Its faster\n3. "],[9371,3,""],[9370,1,""],[9360,10,""],[9360,0,"This is semant"],[9368,6,""],[9357,12,""],[9357,0,"2. This is "],[9357,43,""],[9357,0,"2. This is This is *semantically* the same"],[9360,8,""],[9383,8,""],[9383,0,"identical to the real automerge. (I checked with a fuzzer)"],[9426,0," it"],[9444,0,".T"],[9445,1,""],[9445,0," "],[9360,4,""],[9360,0,"Even though this implementation is di"],[9396,1,""],[9395,1,""],[9395,0,"very differe,"],[9407,1,""],[9407,0,"nt, this"],[9497,0,"So is"],[9500,2,""],[9500,0,"are the "],[9497,11,""],[9496,1,""],[9416,2,""],[9416,0,"approach"],[9449,22,""],[9482,0,"\n\n\n\n---"],[9484,0,"\n\n\n"],[9482,0,"\n| Test                       | Time taken |\n| -------------------------- | ---------- |\n| automerge @ 1.0.0-preview2 | 291s       |\n| JS baseline                | 0.61s      |\n\n"],[9481,0,"\nHow much better?"],[9588,0,"| automerge @ 1.0.0-preview2 | 291s       |\n"],[9634,9,""],[9634,0,"reference-crdts"],[9650,17,""],[9650,0,"           "],[9663,3,""],[9663,0,"31"],[9664,1,""],[9663,1,""],[9663,0,"31"],[9666,0," "],[9498,0," It tak"],[9499,6,""],[9499,0,"About 10"],[9506,1,""],[9506,0,"0x better."],[9497,0," is this approach"],[9685,10,""],[9685,0,"(automerge / yjs)"],[9686,10,""],[9686,0,"AM "],[9686,3,""],[9686,0,"automerge "],[9491,7,""],[9491,0,"faster "],[9526,6,""],[9526,0,"faster"],[9533,0," Its also much more em"],[9554,1,""],[9553,1,""],[9553,0,"memory-efficient and smaller."],[9569,13,""],[9569,0,"."],[9615,44,""],[9572,0,"| -------------------------- | ---------- |\n"],[9659,44,""],[9616,0,"| automerge @ 1.0.0-preview2 | 291s       |\n"],[9703,0,"\n| automerge @ 1.0.0-preview2 | 291s       |"],[9616,44,""],[9659,0,"\n| -------------------------- | ---------- |"],[9572,44,""],[9689,0," "],[9645,0," "],[9601,0," "],[9692,0," "],[9647,0," "],[9602,0," "],[9695,0," "],[9649,0," "],[9603,0," "],[9698,0," "],[9651,0," "],[9604,0," "],[9701,0," "],[9653,0," "],[9605,0," "],[9704,0," "],[9655,0," "],[9606,0," "],[9707,0," "],[9657,0," "],[9607,0," "],[9804,0,"       "],[9772,1,""],[9763,0,"  "],[9712,0,"  "],[9712,1,""],[9723,1,""],[9773,1,""],[7361,0,"\n\n\n### Algorithmic improvements"],[7379,0," / data structure"],[7368,28,""],[7368,0,"Improving the data structure"],[7396,13,""],[9391,0,"\n3. "],[9394,1,""],[9393,1,""],[9392,1,""],[9392,0,"2. When there are no concurrent edits in tha tlo"],[9439,1,""],[9438,1,""],[9437,1,""],[9436,1,""],[9436,0,"t location, you don't have to iterate "],[9395,79,""],[9395,0,"You almost always just insert atht"],[9428,1,""],[9427,1,""],[9427,0," the "],[9425,7,""],[9425,0,"right afte t"],[9436,1,""],[9435,1,""],[9435,0,"r the parent item."],[9395,0,"Concurrent inserts int he same"],[9414,11,""],[9414,0,"in the same location are super rare in practice, and "],[9461,5,""],[9461,0,". So"],[9466,1,""],[9466,0,"y"],[9524,0," Although this algorithm has a (linear time) loop, its almost"],[9575,10,""],[9575,0,"the loop gets ex"],[9584,7,""],[9584,0,"is almost never l"],[9600,1,""],[9600,0,"does anything."],[9600,13,""],[9600,0,"runs"],[9605,0," This makes it fast!"],[9606,4,""],[9606,0,"I"],[9606,1,""],[9606,0,"So its"],[9612,9,""],[9612,0," really"],[9624,0," in practice"],[8647,0,"Starting right after the parent item, "],[8685,1,""],[8685,0,"i"],[8709,1,""],[8709,0,"."],[8711,8,""],[8711,0,"Skip"],[8709,55,""],[8709,0," until we find the location the new item should be inserted"],[9799,0,"\n"],[9676,1,""],[9676,0,"3"],[9800,0,"4. Its neat! Use a list to implement a list? Genius!"],[9811,0," and obvious"],[9811,12,""],[9843,0," CR"],[9813,33,""],[9813,0,"Implement a list CRDT with a list"],[9855,0,"!"],[9945,1,""],[9945,0,", though I'm not measure "],[9969,1,""],[9968,1,""],[9968,0,"ing that here."],[6901,0," Or memory usage - th"],[6921,1,""],[6921,0,"hat simple editing trace con"],[6946,3,""],[6946,0,"makes "],[6920,32,""],[6920,0,"running this simple tra"],[6940,3,""],[6940,0,"editing trace in automerge consumes 1.6"],[6978,1,""],[6978,0,"7GB of ram "],[6988,1,""],[6988,0,"!!"],[6989,1,""],[6953,0," to produce a 100lb"],[6971,1,""],[6970,1,""],[6970,0,"h"],[6970,1,""],[6970,0,"kb document"],[6981,13,""],[7296,1,""],[7296,0,"."],[7298,5,""],[7298,0,"After all,"],[7364,16,""],[7364,0,"delete"],[7004,0," Holy cow!"],[7308,12,""],[7308,0,"T"],[7371,0,"\n"],[7135,236,""],[7135,0,"So how do we make the computer do less work here? There's lots of performance wins to be had, but with this sort of thing its always best to start with macro optimizations. There's no point optimizing code you might be about to delete."],[7371,0,"\n"],[7459,0," And I "],[7460,6,""],[7459,1,""],[10338,0,"Well, it"],[10344,2,""],[10344,0,"the performance improvement"],[10344,0,"some of "],[10379,0,"s might also come from the fact I'm not using automerge"],[10425,9,""],[10425,0,"immutablejs "],[10338,99,""],[10338,0,"Well, some of the performance improvements might also come from the fact I'm not using immutablejs"],[10338,7,""],[10338,0,"S"],[10430,0," here"],[10409,0,"also "],[10435,5,""],[10435,0,". But"],[10439,1,""],[10438,1,""],[10437,1,""],[10436,1,""],[10438,0,"\n\n"],[10438,0,"\n#### "],[10443,1,""],[10442,1,""],[10442,0," Micro optimizations for the win"],[10462,12,""],[10462,0,"\n\nNow we've covered the macro optimizations and picked our sem"],[10521,3,""],[10521,0,"data structure, there's another big prob"],[10473,88,""],[10473,0," go"],[10475,1,""],[10474,1,""],[10473,1,""],[10472,1,""],[10471,1,""],[10471,0,"re using the right algorithm in our implementation, we have a new hotspot in performance: Findingth"],[10569,1,""],[10568,1,""],[10568,0," the location to insert.\n\nThis "],[10594,5,""],[10594,0,"My reference-C"],[10607,1,""],[10607,0,"crdts implementation "],[10594,34,""],[10594,0,"My reference-crdts implementation"],[6993,1,""],[6992,1,""],[6991,1,""],[6991,0,"880"],[6994,2,""],[6994,0,"MB"],[6971,1,""],[6970,1,""],[6970,0,"KB"],[7014,0," Thats nearly as much ram as "],[7014,29,""],[7014,0," The document isn't even very big!"],[7014,0," Thats neraly "],[7021,7,""],[7021,0,"nearly as much as slack."],[7015,30,""],[7015,0,"~"],[7015,1,""],[7015,0,"Thats nearly as much as slack."],[7015,0,"``"],[7016,1,""],[7015,1,""],[7015,0,"~~"],[7047,0,"~~"],[7048,1,""],[7047,1,""],[7047,0,"--"],[7047,2,""],[7047,0,"~~"],[10662,0,"\n"],[10662,0,"\nSo imagine the user types an 'a' in the middle of the document (at position 50000"],[10743,1,""],[10743,0,"). "],[10663,83,""],[10663,0,"So imagine the user types an 'a' in the middle of the document (at position 5000)."],[10746,1,""],[10745,1,""],[10745,0," "],[10779,0," needs to find "],[10663,131,""],[10663,0,"So imagine the user types an 'a' in the middle of the document (at position 5000). My reference-crdts implementation needs to find"],[10662,0,"\n"],[10662,0,"\n```javascript\nstate = [\n  { item: 'a', id: ['seph', 0], seq, parent: null },\n  { item: 'X', id, seq, parent: ['seph', 0] },\n  { item: 'b', id, seq, parent: ['seph', 0] },\n  { item: 'c', id, seq, parent: [..] }\n]\n```"],[10662,0,"\nSo we have a document like this:\n"],[10663,0,"Including "],[10663,10,""],[10694,0,", now"],[10694,5,""],[10694,0,". ("],[10696,1,""],[10696,0,"Oh, it also has del"],[10708,7,""],[10708,0,"marks which items are deleted"],[10684,10,""],[10684,0,", which is a list of items"],[10712,2,""],[10712,0,"And"],[10715,4,""],[10715,0," we're"],[10731,1,""],[10731,0,"ing"],[10758,1,""],[10758,0,", like this:"],[10758,12,""],[10758,0,":"],[10837,47,""],[10785,0,"  { item: 'X', id, seq, parent: ['seph', 0] },\n"],[10884,0,"\n  { item: 'X', id, seq, parent: ['seph', 0] },"],[10785,47,""],[10947,0,"i"],[10900,0,"i"],[10853,0,"i"],[10800,0,"i"],[10951,0,"s"],[10903,0,"s"],[10855,0,"s"],[10801,0,"s"],[10955,0,"D"],[10906,0,"D"],[10857,0,"D"],[10802,0,"D"],[10959,0,"e"],[10909,0,"e"],[10859,0,"e"],[10803,0,"e"],[10963,0,"l"],[10912,0,"l"],[10861,0,"l"],[10804,0,"l"],[10967,0,"e"],[10915,0,"e"],[10863,0,"e"],[10805,0,"e"],[10971,0,"t"],[10918,0,"t"],[10865,0,"t"],[10806,0,"t"],[10975,0,"e"],[10921,0,"e"],[10867,0,"e"],[10807,0,"e"],[10979,0,"D"],[10924,0,"D"],[10869,0,"D"],[10808,0,"D"],[10982,1,""],[10926,1,""],[10870,1,""],[10808,1,""],[10979,0,"d"],[10924,0,"d"],[10869,0,"d"],[10808,0,"d"],[10983,0,":"],[10927,0,":"],[10871,0,":"],[10809,0,":"],[10987,0," "],[10930,0," "],[10873,0," "],[10810,0," "],[10991,0,"f"],[10933,0,"f"],[10875,0,"f"],[10811,0,"f"],[10995,0,"a"],[10936,0,"a"],[10877,0,"a"],[10812,0,"a"],[10999,0,"l"],[10939,0,"l"],[10879,0,"l"],[10813,0,"l"],[11003,0,"s"],[10942,0,"s"],[10881,0,"s"],[10814,0,"s"],[11007,0,"e"],[10945,0,"e"],[10883,0,"e"],[10815,0,"e"],[11011,0,","],[10948,0,","],[10885,0,","],[10816,0,","],[11015,0," "],[10951,0," "],[10887,0," "],[10817,0," "],[11114,0,"in ra rea"],[11122,1,""],[11121,1,""],[11120,1,""],[11119,1,""],[11118,1,""],[11117,1,""],[11117,0,"a real document, this "],[11114,25,""],[11114,0,"at like, "],[11123,3,""],[11186,0," which item in th e"],[10947,5,""],[10947,0,"true"],[10952,0," "],[10711,4,""],[10711,0," Oh, and unlike above"],[10712,20,""],[10712,0,"I didn't mention this above but"],[10743,6,""],[10743,0," we"],[10751,0," need"],[10752,4,""],[10751,1,""],[10758,1,""],[10757,1,""],[10756,1,""],[11209,18,""],[11209,0,"the "],[11209,4,""],[11209,0,"where to insert"],[11204,20,""],[11204,0,"correlate that position with a list item, so we can figure out:\n\n- Where t"],[11277,1,""],[11271,6,""],[11271,0,"What our new"],[11276,7,""],[11276,0,"the new item's parent should be\n- and then where the new item will be inserted"],[11342,0," actually"],[11355,8,""],[11355,0,"spliced in"],[11367,0,"My im"],[10660,1,""],[10660,0,", "],[10661,1,""],[10660,1,""],[10660,0,"."],[10601,0," few"],[10610,7,""],[10609,4,""],[10621,0," hotspots"],[10662,1,""],[10662,0,", and inserting"],[10668,0,"actually "],[10686,0,"."],[11398,0,"lementat"],[11396,10,""],[11396,0,"implementation does a linear scan through the document to find this location. Its a for() loop. we "],[11494,1,""],[11493,1,""],[11492,1,""],[11492,0,"We count all the not-deleted items until "],[11473,0," That sounds fancy - but "],[11498,4,""],[11498,0,"its"],[11557,0,"we've counted past 10"],[11577,1,""],[11576,1,""],[11576,0,"5000 items which aren't deleted and return the index "],[11628,1,""],[11623,0,"resulting "],[11638,0," (eg"],[11641,1,""],[11640,1,""],[11639,1,""],[11638,1,""],[11638,0,". E"],[11640,1,""],[11640,0,"(Eg 555"],[11646,1,""],[11646,0,"000"],[11648,1,""],[11647,1,""],[11646,1,""],[11645,1,""],[11644,1,""],[11638,6,""],[11638,0," - which will be bi"],[11638,19,""],[11638,0,". If 1000 items have been deleted"],[11648,5,""],[11648,0,"characters"],[11676,0," before position 5000, the index position might be 6000."],[11494,3,""],[11493,1,""],[11505,0,"`"],[11500,0,"`"],[11730,0," But unfor"],[11731,9,""],[11731,0,"Unfortunately for us, this is "],[11393,368,""],[11393,0,"My implementation does a linear scan through the document to find this location. That sounds fancy - its a `for()` loop. We count all the not-deleted items until we've counted past 5000 items which aren't deleted and return the resulting index. If 1000 characters have been deleted before position 5000, the index position might be 6000. Unfortunately for us, this is"],[11474,21,""],[11474,0,"I"],[11474,0,"Which means, I use"],[11492,3,""],[11480,5,""],[11480,0,"is to say"],[11706,8,""],[11705,1,""],[11700,0,"destination "],[11732,30,""],[11097,0,"\nLets imagine the document has 1000"],[11131,1,""],[11131,0," 000 items in it, and the"],[11156,15,""],[11226,0," 0"],[11379,0,", and"],[11387,10,""],[11387,0,"W"],[11393,0,"in the list "],[11379,0," (o"],[11381,1,""],[11380,1,""],[11380,0,"(its the id of the preceeding item!)"],[11414,1,""],[11381,4,""],[11381,0,"we need "],[11510,0," th"],[11512,1,""],[11511,1,""],[11510,1,""],[11510,0,"this with "],[11505,15,""],[11505,0,"implements this with "],[11560,22,""],[11665,0,"0"],[11663,0," "],[11781,0,"0 "],[11731,0,"0 "],[11823,0," 0"],[11828,0," This is l"],[11837,1,""],[11837,0,"pretty slow"],[11829,19,""],[11829,0,"Javascript's optimizer will do what ic "],[11867,1,""],[11866,1,""],[11866,0,"t can, but this is always going to be slow.\n\nThen "],[11911,5,""],[11911,0,"Then th"],[11917,1,""],[11916,1,""],[11916,0,"after we've found the new location, we need to splice it in:\n\n```javascript\ndoc.content.splice(destIdx, 0, newItem)\n```\n\n"],[12011,7,""],[12011,0,"60000"],[12011,5,""],[12011,0,"destIdx"],[12031,0," // inser"],[12031,9,""],[12037,0,"If the array currently has 1000 "],[12068,1,""],[12067,1,""],[12067,0," 000 items, javs"],[12082,1,""],[12082,0,"ascript (conceptually) needs"],[12090,20,""],[12043,0," list use"],[12051,1,""],[12050,1,""],[12049,1,""],[12049,0,"is implme"],[12057,1,""],[12056,1,""],[12049,7,""],[12048,1,""],[12043,5,""],[12043,0," "],[12043,1,""],[12090,0,"needs to move every item from position 60 000 forward by one space. (Well, if javascript uses an array for lists. "],[12203,1,""],[12202,1,""],[12197,5,""],[12193,4,""],[12193,0,"internally for lists. Who knows what it actually does - v8 is complex!)"],[12247,1,""],[12246,1,""],[12246,0," -"],[12157,0," This is also slow."],[12178,7,""],[12178,0,"This is assuming"],[12194,1,""],[12206,0,"actually "],[12244,0,"its "],[10631,1,""],[10631,0,"\n- "],[10633,1,""],[10632,1,""],[10632,0,"\n- "],[10666,1,""],[10665,1,""],[10665,0,"\n- "],[10665,0," and"],[10672,5,""],[10672,0,"A"],[10690,0," into the array"],[10705,1,""],[10788,18,""],[10788,0,"some of those"],[10808,3,""],[10808,0,"have been"],[10825,0,", "],[10826,1,""],[10825,1,""],[10808,5,""],[10808,0,"might also have "],[11120,0,",\n  ..."],[11323,4,""],[11323,0,"tihs"],[11326,1,""],[11325,1,""],[11324,1,""],[11324,0,"his"],[11353,1,""],[11353,0,"."],[11355,9,""],[11355,0,"We need to"],[11363,2,""],[11363,0,"thi"],[11365,1,""],[11365,0,"e index to"],[11367,0,"this "],[11372,6,""],[11431,9,""],[11431,0,"copy the "],[11269,0," We need to figure out"],[11281,10,""],[11281,0,"first create a new item - and for that we need to know what its parent"],[11331,20,""],[11331,0,"figure out what its p"],[11331,21,""],[11331,0,"copy its parent ID from the item "],[11331,33,""],[11331,0,"figure out what its parent should be."],[11368,117,""],[11368,0," And then when we insert, we need to find that parent in th elis"],[11431,1,""],[11430,1,""],[11429,1,""],[11428,1,""],[11427,1,""],[11427,0,"e list and splice i"],[11445,1,""],[11444,1,""],[11444,0," the new item in."],[11461,147,""],[11461,0,"\n"],[11490,1,""],[11490,0,"does"],[11481,13,""],[11481,0,"does"],[11490,5,""],[11490,0," using"],[11510,21,""],[11510,0,", "],[11511,1,""],[11510,1,""],[11560,4,""],[11626,6,""],[11626,0,"haven't been"],[11780,1,""],[11780,0,"\n\n"],[11862,0," O(n) slow."],[11863,0,"*"],[11868,0,"*"],[12144,7,""],[12144,0,"Well,"],[12219,35,""],[12219,0,"V"],[12225,0,"really "],[12243,0,"So each time"],[12243,12,""],[12243,0,"Each time we insert, we need to take as"],[12281,1,""],[12281,0,"bout as amny "],[12289,5,""],[12289,0,"many steps "],[12275,25,""],[12275,0,"loop"],[12275,4,""],[12275,0,"take about as many steps as there are i"],[12313,1,""],[12313,0,"characters in the document. Well, characters which have *ever been* in the document (s"],[12398,1,""],[12398,0,"because "],[12396,10,""],[12396,0,". So the lon"],[12398,10,""],[12398,0,"This isn't just slow. Its slow and getting slower."],[10512,19,""],[10512,0,"Fixing linear time"],[10512,18,""],[10512,0,"Removing scanning"],[12447,0,"\n\nYjs "],[12449,4,""],[12448,0,"Thei"],[12451,1,""],[12450,1,""],[12450,0,"ere's a few solutions to this, but lets start with the obvious"],[12505,7,""],[12505,0,"simplest: Replacing the array with a linked list.\n\nThis has a few benefits:\n\n- "],[12582,2,""],[12582,0,"-"],[12505,78,""],[12505,0,"simplest: Replacing the array with a linked list.\n\nThis has a few benefits:\n\n-"],[12514,0," To find an "],[12525,1,""],[12524,1,""],[12523,1,""],[12515,8,""],[12515,0,"Wehn item"],[12515,9,""],[12515,0,"When items are inserted"],[12515,0,"Usually when a human is typing, they don't actually move around the document that much. M"],[12603,1,""],[12602,0," We can cache the last inserted"],[12632,1,""],[12631,1,""],[12631,0," l"],[12625,8,""],[12625,0,"location the user inserted, anad "],[12657,1,""],[12656,1,""],[12655,1,""],[12655,0,"d when they insert again we"],[12681,1,""],[12680,1,""],[12679,1,""],[12679,0,", if they insert close to the old insert"],[12713,6,""],[12713,0,"curor"],[12717,1,""],[12716,1,""],[12716,0,"sor poit"],[12723,1,""],[12722,1,""],[12722,0,"sition we can just track "],[12592,4,""],[12592,0,"very"],[12624,9,""],[12624,0," index and posi"],[12625,14,""],[12625,0,"(index, position) pair where"],[12663,8,""],[12663,0,"typed something"],[12446,0,"\n\n#### Fixy fix fix"],[10593,0,"ca"],[10594,1,""],[10593,1,""],[10593,0,"need to "],[10556,10,""],[10556,0," core data structure"],[10611,36,""],[10611,0,"fix two performance hotspots:"],[10642,1,""],[10642,0,"1."],[10680,1,""],[10680,0,"2."],[11379,93,""],[11281,98,""],[11281,0,"Where on earth is that? "],[11304,1,""],[11304,0," We'll need to scan through the document to fin"],[11344,7,""],[11344,0," (skipping deleted items) to figure out where the new item goes, and what its "],[11413,9,""],[11413,0,"l"],[11413,1,""],[11413,0,"see whats nearby to name its parent.\n\nThats going to "],[11451,15,""],[11451,0,"If they insert at position 50 000, we'll probably have to scan about 60 000 "],[11514,0,"past "],[11532,0,"items to find the insert position! Yikes!\n\nAnd then when we actually insert, we do this:"],[11620,481,""],[11680,0,"\n"],[11680,0,"\nDouble yikes!"],[11694,2,""],[11694,0," "],[11747,0," will"],[11757,1,""],[11772,0,"single "],[11783,0," once space forward."],[11803,63,""],[11803,0," "],[11803,0," Oof"],[11804,3,""],[11804,0,"Its "],[11804,4,""],[11804,0,"This part happens from C++, but stil, "],[11841,1,""],[11840,1,""],[11840,0,"l oof."],[11921,0,", and who knows if thats actually true"],[11960,22,""],[11937,23,""],[11937,0,"whats really going on down there."],[11973,0,"So "],[11976,1,""],[11976,0,"e"],[12005,7,""],[12004,1,""],[11997,2,""],[11997,0,"the computer does"],[12014,5,""],[12076,5,""],[12076,0,"Sorry, as many st"],[12083,10,""],[12082,1,""],[12184,0," Its O(n%"],[12192,1,""],[12192,0,"^2)."],[12185,4,""],[12185,0,"Inserting n characters will take "],[12245,0,"\n"],[12245,0,"\n"],[12246,40,""],[12246,0,"L"],[12245,0,"\n"],[12245,0,"\nWe can fix both of these problems "],[12246,34,""],[12245,1,""],[12244,1,""],[12244,0,"\n\n"],[12246,32,""],[12334,0,"We can solve the scanning problem by "],[12371,7,""],[12375,1,""],[12375,0,"ing"],[12405,0,"*"],[12388,0,"*"],[12427,6,""],[12427,0," edited"],[12444,1,""],[12444,0,"."],[12446,5,""],[12446,0,"W"],[12469,0," we can hope they"],[12486,8,""],[12526,83,""],[12526,0," and just scan a bit forward or backwards from there to fi"],[12583,1,""],[12582,1,""],[12581,1,""],[12580,1,""],[12579,1,""],[12578,1,""],[12578,0,". "],[12579,1,""],[12579,0," This sounds kind of dodgy, but it works great in practice."],[12591,0," a little bit"],[12604,8,""],[12643,0,"\n\nThen we need to insert efficiently. We can do that by"],[12681,17,""],[12681,0,"Well, we can do that by pl"],[12706,1,""],[12705,1,""],[12705,0,"replacing the array with a linked list"],[12732,0,"doubly-"],[12732,7,""],[12743,0,". Its"],[12747,1,""],[12746,1,""],[12745,1,""],[12745,0,"(Its going to have to be a doubly-linked list to "],[12791,3,""],[12791,0,"for the scanning to work).\n\nYjs does these two optimizations "],[12851,1,""],[12851,0," and one bonus optimization: Instead of storing"],[12880,18,""],[12880,0,"U"],[12880,1,""],[12880,0,"Humans also type in runs of characters. Instead of "],[12819,112,""],[12819,0,"Yjs does these two optimizations and one bonus optimization: Humans also type in runs of characters. Instead of typing a "],[12939,1,""],[12937,2,""],[12937,0," a "],[12860,0,"more "],[12892,4,""],[12891,1,""],[12819,121,""],[12819,0,"Yjs does these two optimizations and one more bonus optimization: Humans type in runs of characters. Instead of typing a"],[12938,1,""],[12920,18,""],[12920,0,"If I type \"hello\", instead of storing:\n\n```javascript\nstate = [\n  { item: 'a', isDeleted: false, id: ['seph', 0], seq, parent: null },\n  { item: 'X', isDeleted: false, id, seq, parent: ['seph', 0] },\n  { item: 'b', isDeleted: true,  id, seq, parent: ['seph', 0] },\n  { item: 'c', isDeleted: false, id, seq, parent: [..] },\n  ...\n]\n```\n"],[12995,1,""],[12995,0,"h"],[13066,1,""],[13066,0,"e"],[13131,1,""],[13131,0,"l"],[13196,1,""],[13196,0,"l"],[13185,0,"  { item: 'l', isDeleted: false, id, seq, parent: [..] },\n"],[13254,1,""],[13254,0,"o"],[13301,5,""],[13300,1,""],[13146,4,""],[13146,0,"false"],[13153,1,""],[12984,0,"  { item: 'h', isDeleted: false, id: ['seph', 0], seq, parent: null },\n"],[13118,4,""],[13118,0,"['seph', 1"],[13132,246,""],[13055,0,"  { item: 'h', isDeleted: false, id: ['seph', 0], seq, parent: ['seph', 1 },\n  { item: 'h', isDeleted: false, id: ['seph', 0], seq, parent: ['seph', 1 },\n  { item: 'h', isDeleted: false, id: ['seph', 0], seq, parent: ['seph', 1 },\n"],[13143,1,""],[13143,0,"e"],[13066,1,""],[13066,0,"e"],[13143,1,""],[13143,0,"l"],[13220,1,""],[13220,0,"l"],[13297,1,""],[13297,0,"o"],[13101,1,""],[13101,0,"1"],[13179,0,"2"],[13179,1,""],[13178,1,""],[13178,0,"2"],[13255,1,""],[13255,0,"3"],[13332,1,""],[13332,0,"4"],[13127,1,""],[13127,0,"0]"],[13206,0,"]"],[13283,1,""],[13283,0,"2]"],[13361,1,""],[13361,0,"3]"],[13372,0,"\n\nYjs just stores:"],[13391,0,"\n```javascript\nstate = [\n  { item: 'h', isDeleted: false, id: ['seph', 0], seq, parent: null },\n  { item: 'e', isDeleted: false, id: ['seph', 1], seq, parent: ['seph', 0] },\n  { item: 'l', isDeleted: false, id: ['seph', 2], seq, parent: ['seph', 1] },\n  { item: 'l', isDeleted: false, id: ['seph', 3], seq, parent: ['seph', 2] },\n  { item: 'o', isDeleted: false, id: ['seph', 4], seq, parent: ['seph', 3] },\n]\n```"],[13428,0,"ello"],[13491,312,""],[13497,0,"\n"],[13497,0,"\nAaah much better! This reuc"],[13524,1,""],[13523,1,""],[13523,0,"duces the number of i"],[13543,1,""],[13543,0,"items in the list"],[13515,0," For our benchmark,"],[13535,1,""],[13535,0,"t"],[13579,0," from 180 000 down to about 40 000."],[13615,29,""],[13614,0," And it "],[13498,124,""],[13498,0,"Aaah much better! For our benchmark, this reduces the number of items in the list from 180 000 down to about 40 000. And it"],[6073,0," RAM used"],[6078,4,""],[6078,0,"usage"],[6127,0," --------- "],[6084,54,""],[6084,0,"| -------------------------- | ---------- | ---------"],[6083,0," |"],[6139,0," |"],[6185,0," 880MB     |"],[6241,0,"           |"],[10249,0," RAM usage |"],[10312,0," --------- |"],[10375,0," 880 MB    |"],[10438,0,"           |"],[10501,0,"          |"],[10511,1,""],[10511,0," |"],[13628,4,""],[13628,0,"this "],[13648,0," optimization"],[13623,0," We can't collapse the whole list like this - this io"],[13675,1,""],[13674,1,""],[13674,0,"only works when all the itme"],[13701,1,""],[13700,1,""],[13699,1,""],[13699,0,"i"],[13699,1,""],[13699,0,"tems come one after"],[13704,14,""],[13704,0,"line up  li"],[13714,1,""],[13713,1,""],[13712,1,""],[13712,0,"like this. But"],[13727,1,""],[13727,0,"f"],[13727,20,""],[13776,3,""],[13776,0,"our"],[13819,7,""],[13819,0,"\n\n| Test                              | Time taken | RAM usage |\n| --------------------------        | ---------- | --------- |\n| automerge @ 1.0.0-preview2        |  291s      | 880 MB    |\n| reference-crdts (automerge / yjs) |   31s      |           |\n| JS baseline                       | 0.61s      |           |\n"],[13819,0,"\n\nAnd it performs *great*:"],[14036,0,"| reference-crdts (automerge / yjs) |   31s      |           |\n"],[14101,33,""],[14101,0,"Yjs                              "],[14141,1,""],[14140,1,""],[14139,1,""],[14139,0," 0."],[14141,1,""],[14140,1,""],[14139,1,""],[14138,1,""],[14137,1,""],[14137,0,"0.97s"],[14150,6,""],[14150,0,"3 MB"],[14151,0,".7"],[14152,1,""],[14152,0,"6"],[13844,1,""],[13844,0," - its 30x faster:"],[10441,1,""],[10440,1,""],[10440,0,"23"],[10441,1,""],[10441,0,"7"],[10441,1,""],[10441,0,"8 MB"],[10445,3,""],[14105,5,""],[14105,0,"27"],[14106,1,""],[14106,0,"8 MB"],[13861,1,""],[13861,0," and uses just over 1/10th as much RAM:"],[13821,5,""],[13821,0,"I"],[13604,0,"\n\nBut in a link"],[13606,13,""],[13605,1,""],[13604,1,""],[12931,4,""],[12931,0,"has"],[13622,0," Finally paste events will be fast!"],[13657,1,""],[13657,0,"\n\n"],[13631,0,"those pesky "],[13744,6,""],[13744,0," feilds"],[13750,1,""],[13749,1,""],[13748,1,""],[13747,1,""],[13747,0,"i"],[13747,1,""],[13746,1,""],[13746,0,"ields"],[13759,10,""],[13759,0,". And we'll need so e"],[13779,1,""],[13778,1,""],[13778,0,"me special logic to split items back out if the user later inserts something in the middle of a span li"],[13872,9,""],[13872,0,"oen "],[13875,1,""],[13874,1,""],[13873,1,""],[13873,0,"ne of these spans"],[13896,4,""],[13896,0,"when all is said "],[13912,1,""],[13911,1,""],[13910,1,""],[13909,1,""],[13909,0,"aid and done, this"],[13928,12,""],[13928,0,"trick"],[13928,5,""],[13928,0,"change"],[14011,23,""],[14011,0,"These changes perform great, and "],[14043,1,""],[14042,1,""],[14041,1,""],[14040,1,""],[14039,1,""],[14038,1,""],[14038,0,". The result is"],[14053,2,""],[14068,0," we're using"],[14080,5,""],[14081,9,""],[14081,0,"about"],[14086,20,""],[14086,0," 10% o"],[14091,1,""],[14091,0,"as much RAM:"],[14473,1,""],[14472,1,""],[14472,0,"0.1"],[14471,1,""],[14475,0,"MB"],[14477,2,""],[10451,62,""],[10451,0,"| JS baseline                       | 0.61s      | 0.1 MB    |"],[6198,55,""],[6198,0,"| JS baseline                       | 0.61s      | 0.1 MB    |"],[6233,1,""],[6232,1,""],[6231,1,""],[6230,1,""],[6229,1,""],[6228,1,""],[6227,1,""],[5813,6,""],[5812,1,""],[5885,0," And wow is that - yep, 880MB. "],[5915,1,""],[5914,1,""],[5914,0," of RAM.\n\n"],[7085,44,""],[6981,138,""],[5922,0," Holy cow! ~~Thats nearly as much as slack.~~"],[5923,10,""],[5959,1,""],[6093,0,". Javascript"],[6095,10,""],[6095,0,"V8 is pretty fast!"],[6113,1,""],[6094,19,""],[14368,0,"\n"],[14368,0,"\n### Moving away from JAvascf"],[14390,7,""],[14390,0,"Javascript, and moving away from linked lists\n\nThe next big perfo"],[14437,18,""],[14437,0,"There isn't"],[14437,11,""],[14437,0,"Just "],[14441,1,""],[14440,1,""],[14439,1,""],[14438,1,""],[14438,0,"avascript won't go much faster than this. To improve performance more, we need to start decreasing the number of"],[14437,0,"I'm sad to say it but "],[14501,0," Yjs is very well optimized "],[14528,1,""],[14528,0,","],[14528,1,""],[14528,0," already."],[14536,1,""],[14536,0,", and "],[14541,1,""],[14540,1,""],[14539,1,""],[14538,1,""],[14537,1,""],[14536,1,""],[14536,0,"."],[14538,3,""],[14538,0,"If we want to continue to "],[14584,4,""],[14583,1,""],[14593,33,""],[14592,1,""],[14592,0," the computer to do fewer reads in memory"],[14609,24,""],[14593,16,""],[14593,0,"to pack memory"],[14596,11,""],[14596,0,"make better use of memory.\n\nIn javascript, an object like this:\n\n"],[14660,1,""],[14659,1,""],[14624,15,""],[14624,0,"Imagine "],[14651,0," in javascript"],[14667,0,"\n```\n{ item: 'hello', isDeleted: false, id: ['seph', 0], seq, parent: null }\n```"],[14671,0,"javascript"],[14671,10,""],[14671,0,"json"],[14671,4,""],[14671,0,"javascript"],[14757,0,"\n\nThis object actually looks liek"],[14789,1,""],[14788,1,""],[14788,0,"ke this:\n\n> Diagram..."],[14809,1,""],[14808,1,""],[14807,1,""],[14807,0,"\n\nNote how each "],[14809,14,""],[14809,0,"Note how each"],[14730,1,""],[14730,0,"100"],[14732,1,""],[14748,4,""],[14748,0,"[se"],[14750,1,""],[14749,1,""],[14749,0,"'mike', 2]"],[14830,0," "],[14817,14,""],[14817,0,"Each part of the object"],[14834,6,""],[14834,0,"data structure is separated from the rest"],[14852,23,""],[14852,0,"connected to the rest via pointers. Unforun"],[14894,1,""],[14893,1,""],[14893,0,"tunately, "],[14888,15,""],[14888,0,"In modern computers, following pointere"],[14926,1,""],[14926,0,"s is actually verys "],[14945,1,""],[14944,1,""],[14944,0," slow. If 1 clock cycle was 1 second, following a pointer ("],[14373,62,""],[14373,0,"Better "],[14379,1,""],[14373,6,""],[14373,0,"Moving away from Javascript, and moving away from linked lists"],[14930,9,""],[14930,0," realy"],[14935,1,""],[14935,0,"ly"],[14937,5,""],[14946,0," the computer t"],[14947,14,""],[14944,3,""],[14944,0,"If the computer did"],[14978,3,""],[14978,0,"every"],[15015,0,"doing "],[14994,27,""],[14994,0,"reading data from main memory would take"],[14984,2,""],[15032,0," a few minutes."],[15039,8,""],[15035,4,""],[15035,0,"couple of minutes"],[15035,0,"["],[15053,0,"](https://gist.github.com/hellerbarde/2843375). "],[14817,284,""],[14817,0,"Each part of the data structure is connected to the rest via pointers. In modern computers, following pointers is really slow. If the computer did 1 clock cycle every second, reading data from main memory would take a [couple of minutes](https://gist.github.com/hellerbarde/2843375)."],[14816,0,"\n"],[14816,0,"\nThis is awful for the computer."],[14817,5,""],[14817,0,"The computer hates this."],[14841,26,""],[14843,0,"See, "],[14848,1,""],[14848,0,"e"],[14861,4,""],[14861,0,"that "],[14894,12,""],[14908,0,"In order to follow a pointer, "],[14938,19,""],[14938,0,"your o"],[14943,1,""],[14943,0,"copute"],[14943,6,""],[14943,0,"computer needs to "],[14961,84,""],[14952,0,"usually "],[14969,0," re"],[14971,1,""],[14970,1,""],[14969,1,""],[14968,1,""],[14975,1,""],[14974,1,""],[14973,1,""],[14973,5,""],[14973,0," data"],[14995,0,". If every "],[15000,6,""],[15000,0,"normal memory accesses took 0.5 seconds,"],[15000,27,""],[15000,0,"L1 cache reads took"],[15032,0," reading from am"],[15047,1,""],[15046,1,""],[15046,0,"main memory"],[15070,0,"bout "],[15077,9,""],[15077,0,"2"],[15075,1,""],[15132,0,"\n\n"],[15133,1,""],[15132,1,""],[14841,0,"\n\nTo get there, the computer has to allocate memory with"],[14893,4,""],[14892,1,""],[14892,0,", which si sl"],[14900,5,""],[14900,0,"is slow. The garbage collected"],[14929,1,""],[14928,1,""],[14928,0,"or needs to understand "],[14940,11,""],[14940,0,"track that memory, "],[14958,1,""],[14957,1,""],[14957,0," and do some book "],[14974,1,""],[14974,0,"keeping (also slow)."],[14995,0,"\nAnd once the me"],[15009,2,""],[15009,0,"data is there,"],[15023,5,""],[15023,0," well,"],[15133,8,""],[15142,0," go and fetch that"],[15160,10,""],[15160,0," data"],[15090,28,""],[15090,0,"The data at the eo"],[15107,1,""],[15106,1,""],[15106,0,"other end of a pointer could be anywhere. In order to read"],[15160,4,""],[15160,0,"fetch that data"],[15175,47,""],[15175,0,", your computer needs to read from"],[15210,5,""],[15222,0," In "],[15223,3,""],[15223,0,"If "],[15225,1,""],[15224,1,""],[15224,0,"n computer time if"],[15241,1,""],[15240,1,""],[15239,1,""],[15239,0,", if"],[15243,3,""],[15258,5,""],[15258,0," take"],[14817,3,""],[14817,0,"C"],[14817,1,""],[14817,0,"Your"],[14817,0,"*"],[14843,0,"*"],[14845,0,"\n"],[14845,0,"\nAll the data is separated by pointers."],[14889,9,""],[14889,0,"put data into these boxes"],[14902,0," all"],[14955,1,""],[14955,0,". This"],[14961,6,""],[14970,0," Then"],[14976,1,""],[14976,0,"t"],[15007,0,"keep "],[15017,0," of"],[15032,25,""],[15032,0," "],[15075,64,""],[15075,0,"we need to read it"],[15151,0,"*"],[15143,0,"*"],[15155,30,""],[15155,0,"Y"],[15168,0," willusually"],[15179,1,""],[15178,1,""],[15177,1,""],[15176,1,""],[15175,1,""],[15174,1,""],[15173,1,""],[15173,0," "],[15155,19,""],[15155,0,"To read it, your computer usually"],[15197,0," go fetch it"],[15209,5,""],[15226,0,", which is a"],[15237,1,""],[15237,0,"also slow"],[15401,0,"\n\nWe can't do better in java"],[15411,18,""],[15411,0," fix this in javascript. If we make our data structures more complex, we run into the same limitations Automerge has with immutablejs - which is, the "],[15557,4,""],[15557,0,"if we make our data structures o"],[15588,1,""],[15588,0,"comple,"],[15594,1,""],[15594,0,"x, "],[15403,194,""],[15403,0,"We can't fix this in javascript. If we make our data structures more complex, we run into the same limitations Automerge has with immutablejs - which is, if we make our data structures complex,"],[15402,0,"\n"],[15402,0,"\n"],[15033,1,""],[15032,1,""],[15032,0,", which is "],[15052,1,""],[15055,5,""],[15055,0,"O"],[15081,0,"'re going to"],[15055,25,""],[15055,0,"Later we"],[15062,1,""],[15089,2,""],[15089,0,"that data"],[15100,60,""],[15099,1,""],[15099,0,","],[15099,1,""],[15098,1,""],[15098,0,", and it could be *anywhere*. "],[15374,0," Its like if your shopping list"],[15390,1,""],[15390,0," wrote a"],[15412,0,", but instead of writing \"mil"],[15440,1,""],[15439,1,""],[15438,1,""],[15438,0,"i"],[15438,1,""],[15438,0,"Mili"],[15441,1,""],[15441,0,"k\" you had a little scavenger hunt"],[15437,0,"each item, "],[15486,0," describing where in your house the note with \"milk\" on it is hidden."],[15533,1,""],[15533,0,"M"],[15555,0," Reading the whole list would take ages."],[15596,1,""],[15595,1,""],[15596,0,"\n"],[15596,0,"\nIdeally "],[15597,8,""],[15597,0,"To run faster, we need to move all the fields together. And we n"],[15600,4,""],[15600,0,"go "],[15634,7,""],[15634,0," data to"],[15641,1,""],[15640,1,""],[15639,1,""],[15658,0,"eed to move away from linked lists - as clever as they are, the user *does* sometimes hop around the document and we don't want to ever scan "],[15789,0,"*"],[15794,0,"* do those"],[15809,1,""],[15809,0,"s."],[15857,24,""],[15857,0,"fancy data structures in javascript, the language fights us ("],[15907,11,""],[15907,0,"forces us to "],[15907,13,""],[15894,13,""],[15894,0,"we end up fra"],[15904,3,""],[15904,0,"with even more fragmented memory."],[15937,25,""],[15937,0," In "],[15940,1,""],[15939,1,""],[15939,0,"s"],[15939,1,""],[15939,0,"ts sort of the"],[16001,52,""],[16001,0,". Clever data structures"],[15908,5,""],[15913,0," objects and more"],[15930,11,""],[15937,0," fragmentation"],[15896,0," confuse the optimizer, and"],[15948,30,""],[15948,0," o"],[15949,1,""],[15949,0,"all over the place in memory"],[15982,8,""],[16002,20,""],[16014,0," has"],[16019,23,""],[16019,0,"\n\nB"],[16021,1,""],[16021,0,"But its ok, there's one more "],[16032,18,""],[16032,0," we have webassembly."],[16035,0," don't need to write web app"],[16056,7,""],[16056,0,"javascript antmo"],[16071,1,""],[16070,1,""],[16069,1,""],[16069,0,"y more. "],[16076,1,""],[16075,1,""],[16075,0,", even on the web. We"],[16114,0,"\n\n[e"],[16117,1,""],[16116,1,""],[16116,0,"[Here](https://github.com/josephg/text-crdt-rust/) I've been quite"],[16181,1,""],[16180,1,""],[16180,0,"etly buliding a"],[16185,10,""],[16185,0,"build"],[16189,1,""],[16189,0,"ding yet another implementation"],[16206,14,""],[16206,0,"CRDT impelment"],[16211,9,""],[16211,0,"implementation in Rust. This implementation has all"],[16259,3,""],[16258,1,""],[16255,3,""],[16254,1,""],[16254,0,":\n\n- Does yjs's "],[16257,13,""],[16256,1,""],[16255,1,""],[16254,1,""],[16254,0," is essn"],[16261,1,""],[16261,0,"entially the same as yjs but:\n\n- It doesn't "],[16292,13,""],[16292,0,"- It doesn't"],[16297,7,""],[16297,0,"uses a B-Tree instead of "],[16305,2,""],[16305,0,"-t"],[16322,0,"a linked list to stro"],[16342,1,""],[16341,1,""],[16341,0,"ore the items. This a"],[16356,6,""],[16356,0,"The b-tree "],[16356,11,""],[16356,0,"At ec"],[16360,1,""],[16360,0,"ach node of the b-tree we store the number of "],[16355,0," This solves both of our linear scanning problems rom"],[16407,1,""],[16406,1,""],[16405,1,""],[16405,0,"from earlier."],[16356,62,""],[16355,1,""],[16396,10,""],[16396,0,"length of all of that item's children."],[16293,1,""],[16292,1,""],[16291,1,""],[16290,1,""],[16289,1,""],[16289,0," "],[16290,1,""],[16290,0,"i"],[16430,0,"\n\nThis solves both of our linear scanning problems from earlier. When we want to find where in the list to insert, "],[16516,29,""],[16516,0,"which item in the list"],[16516,6,""],[16516,0,"w"],[16516,1,""],[16520,0," 1000"],[16524,1,""],[16523,1,""],[16522,1,""],[16521,1,""],[16521,0,"50 0000"],[16527,1,""],[16539,0,", we can just traverse down the tree. The "],[16577,4,""],[16577,0,"Trees are really tiy"],[16596,1,""],[16596,0,"dy - storing all these itme"],[16622,1,""],[16621,1,""],[16621,0,"ems"],[16587,37,""],[16587,0,"very tidy - storing all these items we just need 5 "],[16432,206,""],[16432,0,"This solves both of our linear scanning problems from earlier. When we want to find item 50 000 in the list, we can just traverse down the tree. Trees are very tidy - storing all these items we just need 5"],[16430,0,"\n\n> Diagram here"],[16434,0,"B-tree "],[16441,1,""],[16441,0,"d"],[16630,30,""],[16630,0,"this sho"],[16637,1,""],[16636,1,""],[16635,1,""],[16635,0,"whole document  j"],[16651,1,""],[16650,1,""],[16650,0,"just needs 5 l"],[16663,1,""],[16663,0,"layers in the tree.\n\nWea "],[16687,1,""],[16686,1,""],[16685,1,""],[16684,1,""],[16684,0,"Each leaf node (where we store the actual data) packs a whole group of 32 items into the same chunk of memory."],[14367,0,"\nI honeslty "],[14370,9,""],[14370,0,"honestly"],[14369,0,"'m"],[14371,9,""],[14371,0," chocked"],[14372,7,""],[14372,0,"shocked how little ram yjs uses for this.\n"],[14403,10,""],[14403,0,". Its "],[14405,4,""],[14405,0,"I'm sure there's all sorts of wizardry in V8 that I don't understand which makes this possible. Its impresi"],[14511,1,""],[14511,0,"sive all "],[14519,1,""],[14519,0,"-round."],[14403,0," with this appo"],[14417,1,""],[14417,0,"roach"],[14524,0,"extremely "],[14544,11,""],[14544,0,"."],[14403,19,""],[14454,26,""],[14450,4,""],[14450,0,"which "],[14509,62,""],[14509,0,"Rust and B-tr"],[14521,1,""],[14520,1,""],[14520,0,"Treee"],[14524,1,""],[14524,0,"s"],[14509,9,""],[14509,0,"Everything is faster in rust, with "],[14533,1,""],[14533,0,"R"],[16341,0,". This time"],[16412,0," (including yjs's spans). "],[16438,2,""],[16438,0,"B"],[16503,1,""],[16503,0,"\n\n"],[16504,1,""],[16503,1,""],[16503,0," "],[16668,1,""],[16668,0,":\n\n- "],[16672,1,""],[16709,3,""],[16709,0,"our"],[16805,12,""],[16805,0,"only needs 4"],[16817,7,""],[16817,0," "],[16817,1,""],[16816,1,""],[16816,0,"5 levels"],[16827,4,""],[16827,0," our"],[16776,0," we can "],[16783,1,""],[16790,1,""],[16789,1,""],[16788,1,""],[16788,0,"e"],[16810,4,""],[16810,0,"in just"],[16817,6,""],[16753,0," "],[16753,1,""],[16694,0,"the "],[16702,0," at position"],[16721,12,""],[16843,0,"\n- Updating in the tree is easy "],[16870,5,""],[16870,0,"fast too. Usually we can just in"],[16879,23,""],[16879,0," If there's room in the current item, we just insert the new content there. If not, we \""],[16966,1,""],[16965,1,""],[16965,0," split the current item and insert in the parent. The worst case"],[17015,14,""],[17015,0,"In the worst case, we splill"],[17042,1,""],[17041,1,""],[16878,163,""],[16878,0," - it takes O(depth) - or about 5 steps no matter what."],[16918,0,"in this case "],[16945,0," happens"],[16954,0," Much better than needing to shift every ti"],[16996,1,""],[16995,1,""],[16995,0,"item in our javascript ara"],[17020,1,""],[17020,0,"ray!\n\n"],[17025,1,""],[17024,1,""],[17073,0," "],[17073,1,""],[17026,4,""],[17026,0,"In j"],[17029,1,""],[17028,1,""],[17027,1,""],[17027,0,"n Javascript we can't pack a single item into the"],[17073,3,""],[17073,0,"contiguous memory. In rust we can pack each"],[17126,0," into a single memory chunk"],[17153,56,""],[17127,0,"with 32 items all together "],[17180,40,""],[17180,0,"."],[17049,0,"even "],[17111,0,"! In fact, we can"],[17148,0," in r"],[17152,1,""],[17152,0,"our tree with"],[17165,5,""],[17174,0,". A"],[17176,1,""],[17177,1,""],[17176,1,""],[17176,0,"A"],[17111,55,""],[17111,0," pack groups of "],[17135,42,""],[17135,0," t"],[17136,1,""],[17136,0,"all together in chunks. This will result in a bit of memcop"],[17194,1,""],[17193,1,""],[17193,0,"py"],[17180,15,""],[17180,0,"some memcpy-ing when we insert, but memcpy is way faster than "],[17216,26,""],[17216,0,"thats faster than you think."],[15322,0," - you guesed i"],[15329,8,""],[15329,0,"guessed it -"],[15356,16,""],[15356,0,"We can scale up computer time by 1 billion to make it more intuitive. On this time sta"],[15441,1,""],[15440,1,""],[15440,0,"cale, each"],[15450,4,""],[15464,1,""],[15469,0,"s"],[15482,0," (about a heart beat)"],[15503,1,""],[15503,0,"."],[15505,0,"And "],[15552,9,""],[15551,1,""],[15551,0,"2 minutes"],[15560,46,""],[15363,0,"["],[15425,0,"]"],[15425,1,""],[15425,0,"](https://gist.github.com/hellerbarde/2843375)"],[15473,2,""],[15473,0,"At"],[15552,3,""],[15552,0,"Each"],[15552,4,""],[15552,0,"And eah"],[15558,1,""],[15558,0,"ch"],[15567,1,""],[15566,1,""],[15565,1,""],[15610,0," Arranging memory like javascript does here is like"],[15661,9,""],[15724,0," in your list"],[15737,8,""],[15737,0,","],[15745,1,""],[15745,0,"ve"],[15742,0,"r list is full of scavenger hunt clues."],[15782,28,""],[15782,0,"Ecah "],[15786,1,""],[15785,1,""],[15784,1,""],[15783,1,""],[15783,0,"ach clue names"],[15797,11,""],[15797,0," somewhere "],[15808,7,""],[15822,3,""],[15822,0,"with a tiny"],[15838,5,""],[15838,0," saying"],[15858,10,""],[15898,1,""],[15898,0,", and thats what Javascript does."],[15898,1,""],[15898,0,"."],[15899,6,""],[15899,0," T"],[15752,4,""],[15752,0,"actually a"],[15762,3,""],[15777,6,""],[15777,0," full of clues"],[15832,0," - and if you go there you'll find"],[15866,5,""],[15892,0," or \"Cheee"],[15901,1,""],[15901,0,"se\""],[15911,1,""],[15911,0,"\n\n"],[16007,4,""],[16007,0,"squish"],[16192,0,"sl"],[16193,1,""],[16192,1,""],[16192,0,"long slow "],[16208,0," (Remember, its a scavenger hunt each time we move to the n"],[16220,0,"we do"],[16225,3,""],[16269,0,"ext item with linked lists)"],[16295,0,"!"],[15952,28,""],[16575,4,""],[16575,0,"So I've been "],[16575,13,""],[16574,0,"So I've been quietly building "],[16605,0,"yet another CRDT imeplem"],[16622,7,""],[16622,0,"implementation, this time"],[16605,42,""],[16605,0,"a CRDT implementation in rust"],[16679,78,""],[16731,24,""],[16788,3,""],[16788,0,"all of its"],[16814,0,"inern"],[16818,1,""],[16817,1,""],[16816,1,""],[16816,0,"ternal "],[17055,0,"across and down "],[17071,4,""],[17070,1,""],[17164,1,""],[17164,0,", so we only need 5 reads to find the item."],[17265,9,""],[17265,0,"the same "],[17276,0,"or so "],[17288,35,""],[17287,1,""],[17300,58,""],[17300,0," than nee"],[17306,3,""],[17306,0,"when n"],[17311,1,""],[17311,0,"we need "],[17318,1,""],[17318,0,"e"],[17306,13,""],[17306,0,"that javascript array.\n\nIt might al"],[17340,1,""],[17339,1,""],[17339,0,"be faster te"],[17350,1,""],[17349,1,""],[17349,0,"yet to *also* cache the location"],[17373,0,"last "],[17386,0,". I haven't trued th"],[17398,8,""],[17398,0,"tried that yet. But its really fast anyway.\n\n"],[17663,0,"\n"],[17444,1,""],[17662,0,"\n"],[17443,1,""],[17661,0,"\n"],[17442,1,""],[17660,1,""],[17442,0,"\n"],[17363,0,"use yjs's trick and "],[17433,28,""],[17435,219,""],[17435,0,"We"],[17435,2,""],[17435,0,"In Javascript we can't even pack a single item into contiguous memory. In rust we can pack groups of 32 items all together in chunks. This will result in some memcpy-ing when we insert, but thats faster than you think.\n"],[17435,219,""],[17435,0,"We can also pack all the items tightly in memory. Each leaf in the b-tree is stored in a single block fo"],[17538,1,""],[17537,1,""],[17537,0,"of memory. That block "],[17548,11,""],[17548,0,"At that block we store 32 entries - each storing in turn a span of characters. Th"],[17628,1,""],[17627,1,""],[17626,1,""],[17626,0," This "],[17627,5,""],[17627,0,"So inserting *does* need a few memcpy"],[17652,12,""],[17652,0,"some memcopy"],[17663,1,""],[17662,1,""],[17661,1,""],[17661,0,"py-ing, but thats"],[17673,5,""],[17673,0,"I'm"],[17675,1,""],[17674,1,""],[17673,1,""],[17673,0,"thats seriously faster than you think it is. Much faster"],[17704,0," ui"],[17706,1,""],[17705,1,""],[17705,0,"intuitie"],[17712,1,""],[17712,0,"vely"],[17730,11,""],[17729,1,""],[17672,0," its fine -"],[17690,0,"still "],[17717,29,""],[17717,0," doing"],[17673,50,""],[17673,0,"memcpy"],[17672,1,""],[17672,0," a little bit of "],[17695,0," is fine. Its faster than you think"],[17709,0,"seriously "],[17740,0,".\n\nAnyway, how m"],[17755,1,""],[17755,0,"fast?"],[17759,1,""],[17759,0," does it go?\n\nCalled from javascript through webap"],[17808,1,""],[17808,0,"ssembly, the benchmark"],[17817,13,""],[17817,0,"we're down to 0.2 seconds. Called directly from rust, t"],[17871,1,""],[17871,0,"we can proe"],[17881,1,""],[17881,0,"cess this editing trace in "],[17833,1,""],[17832,1,""],[17831,1,""],[17830,1,""],[17830,0," 200 milli"],[17840,1,""],[17913,0,"65 n"],[17916,1,""],[17916,0,"milliseconds. And "],[17929,5,""],[17741,0,"\n\nThere's one last thing I've done. I don't know if its a good idea, but I suspect its "],[17816,12,""],[17816,0,"di i"],[17819,1,""],[17818,1,""],[17818,0,"d it "],[17822,1,""],[17822,0," anyway.\n\n"],[17831,1,""],[17830,1,""],[17830,0," I moved the text content itself into a "],[17869,1,""],[17869,0,"nother structures."],[17886,1,""],[17885,1,""],[17885,0,". S"],[17887,1,""],[17887,0,"When you're actually doing collaborative editing "],[17935,1,""],[17935,0,", you have all the car"],[17956,1,""],[17955,1,""],[17955,0,"haracters in your odnw"],[17973,4,""],[17973,0,"document in "],[17940,0," probably want to"],[18002,0,"an actual array, or an actual string or something. So I made it so the CRDT data structure onol"],[18096,1,""],[18095,1,""],[18095,0,"ly"],[17829,0," because it seemed clever at the time"],[17854,12,""],[17893,7,""],[17893,0,"a separate data"],[17920,0,"See, "],[17925,1,""],[17925,0,"w"],[17992,8,""],[18072,9,""],[18072,0,"in VS Code's data structures or h"],[18104,1,""],[18104,0,"whatever. It doesn't make sense to store the content twice"],[18189,14,""],[18188,1,""],[18193,0," stores "],[18194,0,"needs to "],[18209,1,""],[18208,1,""],[18208,0," the spans and such. Just enough that it can merge changes.s"],[18267,1,""],[17868,4,""],[17867,1,""],[17883,0,"out "],[18028,0,"to be stored "],[18059,21,""],[18059,0,","],[18077,27,""],[18077,0,"editor r "],[18085,1,""],[18084,1,""],[18084,0,"or something"],[18173,78,""],[18164,9,""],[18164,0,"my CRDT stores"],[18366,0,"\n"],[18179,1,""],[18365,0,"\nThere's one last thing I've done. I don't know if its a good idea, but I did it anyway because it seemed clever. I moved the content itself out into a separate data structure. See, when you're actually doing collaborative editing, you probably want all the characters in your document to be stored in an actual array, or in VS Code's editor or something. It doesn't make sense to store the content twice. So I made it so my CRDT stores"],[17743,436,""],[17929,0,"\n"],[17742,1,""],[17928,0,"\nWe can also pack all the items tightly in memory. Each leaf in the b-tree is stored in a single block of memory. At that block we store 32 entries - each storing in turn a span of characters. So inserting *does* need some memcpy-ing, but a little bit of memcpy is fine. Its seriously faster than you think."],[17435,307,""],[17621,307,""],[17435,0,"We can also pack all the items tightly in memory. Each leaf in the b-tree is stored in a single block of memory. At that block we store 32 entries - each storing in turn a span of characters. So inserting *does* need some memcpy-ing, but a little bit of memcpy is fine. Its seriously faster than you think.\n"],[17928,1,""],[17742,0,"\n"],[17929,0,"\n\n\n"],[17931,0,"\n| Test                              | Time taken | RAM usage |\n| --------------------------        | ---------- | --------- |\n| automerge @ 1.0.0-preview2        |  291s      | 880 MB    |\n| reference-crdts (automerge / yjs) |   31s      |  28 MB    |\n| Yjs                               | 0.97s      | 3.6 MB    |\n| JS baseline                       | 0.61s      | 0.1 MB    |"],[17930,1,""],[18308,0,"\n| Rust via web"],[18316,7,""],[18316,0,"called from JS"],[18316,14,""],[18316,0,"(through WASM)               | 0.65s\n| JS baseline                       | 0.61s      | 0.1 MB    |"],[18246,63,""],[18289,0,"      | 2.3 MB    |"],[18246,0,"| Rust (through WASM)               | 0.65s      | 2.3 MB    |\n"],[18317,12,""],[18317,0,"native"],[18324,0,"      "],[18254,7,""],[18254,0,"Via JS +"],[18254,3,""],[18254,0,"Called from"],[18269,1,""],[18269,0,"via"],[18279,11,""],[18287,1,""],[18286,1,""],[18286,0,"20"],[18287,1,""],[18287,0,"0"],[18349,0,"0"],[18354,1,""],[18434,0,"\n| Rust (native)                     | 0.065s     | 2.3 MB    |"],[18309,63,""],[18371,0,"\n| Rust (Called from JS via WASM)    | 0.20s      | 2.3 MB    |"],[18246,63,""],[18069,0,"("],[18071,1,""],[18085,0,")"],[18086,1,""],[18191,20,""],[18191,0,"(&"],[18192,1,""],[18192,0,"$"],[18192,1,""],[18192,0,"#"],[18192,1,""],[18192,0,"@13.5.5)           "],[18189,3,""],[18189,0,"("],[18198,0,"  "],[18070,1,""],[18070,0,"v"],[18190,1,""],[18190,0,"v"],[18790,81,""],[18790,0,"\n\nThese times assume your "],[18804,12,""],[18792,12,""],[18792,0,"S"],[18792,1,""],[18792,0,"So the data strucut"],[18810,1,""],[18809,1,""],[18809,0,"ture looks like this:\n\n```\n{\n  \n  "],[18838,2,""],[18839,2,""],[18839,0,"}\n```"],[18838,0,"  text: <R"],[18847,1,""],[18846,1,""],[18846,0,"Rope implementation"],[18846,19,""],[18846,0,"\"abc\","],[18837,0,"\n  tree: <Range tree storing spans and offsets and such"],[18847,45,""],[18847,0,"B-tree storing the content>,\n  index: I"],[18885,1,""],[18884,1,""],[18884,0," <Index "],[18876,16,""],[18876,0,"  index: <Index"],[17328,0,"\n\nI'm also storing a "],[17348,1,""],[17348,0,"n index bac"],[17355,4,""],[17355,0," "],[17355,1,""],[17355,0,", so we can easily find \""],[17379,1,""],[17374,5,""],[17374,0,"look up items byt"],[17390,1,""],[17390,0," their ID ("],[17400,1,""],[17400,0,"*("],[17401,1,""],[17400,1,""],[17400,0,"(*("],[17402,1,""],[17402,0,"[Seph"],[17406,1,""],[17405,1,""],[17404,1,""],[17403,1,""],[17403,0,"'seph', 100]("],[17415,1,""],[17415,0,"*)"],[17374,7,""],[17374,0,"find"],[17374,4,""],[17367,7,""],[17367,0,"quickly find"],[17414,0," -> "],[17417,1,""],[17416,1,""],[17415,1,""],[17414,1,""],[17415,0,"."],[17429,0," even"],[17441,7,""],[17441,0," if I"],[17469,4,""],[17469,0," of"],[17477,1,""],[17477,0,"ing"],[17527,0,"Rust lets us"],[17539,11,""],[17602,61,""],[17602,0,"stores"],[17619,0,", with even"],[17629,1,""],[17629,0,"rything contiguous."],[17649,44,""],[17648,1,""],[17649,2,""],[17649,0,"I"],[17649,3,""],[17649,0,"I"],[17658,0," like this"],[17737,0," also"],[17741,1,""],[17740,1,""],[17740,0,"ways"],[17744,10,""],[17756,0," I"],[17758,4,""],[17764,0," it will be"],[17778,7,""],[17778,0,"Speaking of fast,"],[18859,0,"actually "],[18939,6,""],[18930,9,""],[18930,0,"  index: <in"],[18941,1,""],[18940,1,""],[18940,0,"Index of ID => "],[18954,1,""],[18953,1,""],[18952,1,""],[18952,0,"-> "],[18954,1,""],[18953,1,""],[18952,1,""],[18952,0,"=> b-tree node>,"],[18978,3,""],[18978,0,"oh hai!"],[18859,0,"*"],[18868,0,"*"],[18996,0,"\nBut gues "],[19005,1,""],[19005,0,"s"],[18997,9,""],[18997,0,"For the text I'm "],[19009,5,""],[19009,0," content I'm using [Ropey](https://docs.rs/ropey/1.2.0/ropey/). But guess what? I"],[19089,1,""],[19089,0,"My code is faster than ropey. And "],[19119,4,""],[19118,1,""],[19118,0," If I turn it off"],[19118,17,""],[19119,0,"\n| Test                              | Time taken | RAM usage |\n| --------------------------        | ---------- | --------- |\n| automerge (v1.0.0-preview2)       |  291s      | 880 MB    |\n| reference-crdts (automerge / yjs) |   31s      |  28 MB    |\n| Yjs (v13.5.5)                     | 0.97s      | 3.6 MB    |\n| JS baseline                       | 0.61s      | 0.1 MB    |\n| Rust (Called from JS via WASM)    | 0.20s      | 2.3 MB    |\n| Rust (native)                     | 0.065s     | 2.3 MB    |\n"],[19118,0," And that content is stored "],[19139,7,""],[19139,0,"going to be stored in someone else's"],[19151,24,""],[19151,0,"someone else's problem anyway. What happens if I turn that off?"],[19182,0,"Its cheating, but "],[19200,1,""],[19200,0,"w"],[19675,0,"| Rust (native)                     | 0.065s     | 2.3 MB    |\n"],[19753,0,", not sto"],[19761,1,""],[19760,1,""],[19759,1,""],[19758,1,""],[19757,1,""],[19757,0," string"],[19764,19,""],[19764,0,"        "],[19758,8,""],[19758,0,"content "],[19780,1,""],[19779,1,""],[19779,0,"23"],[19791,1,""],[19791,0,"1"],[19182,0,"Look, I know I'm"],[19198,3,""],[19197,1,""],[19196,1,""],[19195,1,""],[19195,0,"its"],[19231,0,"just ... "],[19774,1,""],[19786,0,")"],[19779,7,""],[19779,0,"doc content"],[19792,4,""],[19685,6,""],[19685,0,"???   "],[18405,6,""],[18405,0,"???    "],[18411,1,""],[18657,6,""],[18657,0,"W"],[18830,0," And that stru"],[18831,13,""],[18831,0,"It doesn't make sense to duplicate the document content."],[18878,0,"'s"],[18888,1,""],[18888,0," in my library."],[19141,0,"Its pretty fast... but "],[19164,4,""],[19179,4,""],[19179,0,"B-tree"],[19342,1,""],[19342,0," to see how fast this puppy can really go?"],[19953,0,"\nBoom.\n\n"],[19959,0," 14000 "],[19965,1,""],[19965,0,"x faster."],[19973,0,"; as promised"],[225,0,"all of "],[236,4,""],[419,0,"this is awkward but .. "],[587,0,"which, by the way, "],[677,18,""],[677,0,"Oi!"],[679,1,""],[679,0," - whats going on?"],[696,1,""],[696,0," here?"],[773,14,""],[773,0,"code"],[944,0,". And"],[949,2,""],[955,5,""],[955,0,"of those inserts"],[1007,16,""],[1007,0,"O"],[1007,0,"Duh - "],[1013,1,""],[1013,0,"o"],[1183,0,"so many "],[1197,10,""],[1207,0,"me a link to"],[1219,7,""],[1254,6,""],[1257,0," Bad!"],[1271,0," Y "],[1273,1,""],[1272,1,""],[1272,0,"My code isn't slow, "],[1271,21,""],[1408,0,". Jupiter os an "],[1423,1,""],[1422,1,""],[1421,1,""],[1420,1,""],[1419,1,""],[1418,1,""],[1418,0,"is an Algorithm. RGA is an Algorithm."],[1456,3,""],[1456,0,"B"],[1435,0,"The "],[1442,6,""],[1443,1,""],[1443,0,"a"],[1653,13,""],[1652,1,""],[1795,1,""],[1804,1,""],[1896,128,""],[1896,0,"Years ago "],[1907,9,""],[1918,1,""],[1917,1,""],[1916,1,""],[1916,0,"ed"],[1928,6,""],[1922,6,""],[1921,1,""],[183,0,"s"],[2126,38,""],[2149,4,""],[2149,0,"does"],[2294,0," I think they're the future of collaborative editing."],[2378,0," for years"],[2211,1,""],[2222,0," is slow!"],[2495,0,"I think "],[2536,1,""],[2537,3,""],[2537,0,"as "],[2666,16,""],[2666,0,"anything about efficient "],[2708,10,""],[2708,0," of those systems"],[2727,6,""],[2727,0,"Wow, I was"],[2737,16,""],[2737,0," was"],[2737,0," turns out I"],[2733,4,""],[2731,2,""],[2727,4,""],[2727,0,"But it"],[2717,8,""],[2717,0," systems"],[2727,6,""],[2727,0,"Wow, I was"],[2737,16,""],[2763,11,""],[2763,0,"Well"],[2801,0,"["],[2811,0,"](https://github.com/automerge/automerge/)"],[2798,0,"https://github.com/automerge/automerge-perf/"],[2998,0," to run"],[3082,1,""],[3081,1,""],[3081,0,"54"],[3082,1,""],[3081,1,""],[3081,0,"65"],[3099,32,""],[3098,1,""],[3099,0,"nearly "],[3106,6,""],[3106,0,"5000x faster"],[3264,0,"I'll take you through "],[3285,33,""],[3285,0," I "],[3287,1,""],[3286,1,""],[3285,1,""],[3285,0," I "],[3287,1,""],[3285,2,""],[3285,0," all the steps that make it fast."],[3300,18,""],[3300,0,"to make it super fast."],[3324,4,""],[3324,0,"But"],[3353,0,":"],[2254,0,"https://josephg.com/blog/crdts-are-the-future/"],[3570,0,"["],[3586,0,"](https://martin.kleppmann.com/2020/07/06/crdt-hard-parts-hydra.html)"],[4147,27,""],[4147,0,"Sounds like a tree, dawg!"],[4147,24,""],[4147,0,"Its a tree"],[4438,0,"\n> Diagram here\n"],[5151,8,""],[5151,0,"When"],[5196,6,""],[5224,0,"their "],[5239,0," resulting"],[5254,0," (or d"],[5259,1,""],[5259,0,"text document) can be made by"],[5288,26,""],[5288,0," "],[5425,11,""],[5429,0,", which is to store a "],[5450,1,""],[5449,1,""],[5449,0,"all the data as a tree"],[5529,1,""],[5528,1,""],[5527,1,""],[5526,1,""],[5525,1,""],[5524,1,""],[5523,1,""],[5522,1,""],[5652,0," (Wh"],[5655,1,""],[5654,1,""],[5653,1,""],[5652,1,""],[5653,0," (What are all those Uint8Arrays doing all of t"],[5699,1,""],[5698,1,""],[5697,1,""],[5697,0,"ver the place?)"],[5655,0,"And "],[5659,1,""],[5659,0,"w"],[5716,0,"."],[5718,0,"\nThrough this po"],[5719,15,""],[5719,0,"We're going to go through a lot of different algri"],[5768,1,""],[5767,1,""],[5767,0,"orh"],[5769,1,""],[5769,0,"ithms here"],[5773,1,""],[5773,0,"ic app"],[5775,4,""],[5773,2,""],[5773,0,"s"],[5779,0,"."],[5780,1,""],[5780,0," To"],[5783,3,""],[5795,1,""],[5794,1,""],[5793,1,""],[5793,0," all of them"],[5781,24,""],[5781,0,"So t"],[5784,1,""],[5784,0,"for a simple benchmark"],[5784,3,""],[5784,0,"as"],[5810,0," going to"],[5819,6,""],[5819,0," use"],[5937,6,""],[5944,0," himself"],[5961,0," where"],[5962,21,""],[6001,1,""],[6000,1,""],[6000,0," aren't any"],[6011,3,""],[6046,1,""],[6051,0," ja"],[6053,1,""],[6052,1,""],[6052,0,"has edits from"],[6081,1,""],[6081,0,"."],[6083,1,""],[6083,0,"B"],[6106,1,""],[6106,0," -"],[6109,1,""],[6109,0,"u"],[6114,0," almost never "],[6127,1,""],[6128,13,""],[6128,0,"put their cursors a t"],[6148,1,""],[6147,1,""],[6147,0,"t exactly the same place and start "],[6188,43,""],[6188,0," at the same time."],[6127,0," actually"],[6197,18,""],[6197,0,"."],[6185,6,""],[6190,1,""],[6189,1,""],[6188,1,""],[6188,0,"e"],[6190,0," And I'm just counting the time from applying this trace *locally*. Not ideal, but eh. You want the good stuff, ou"],[6273,31,""],[6273,0,"good enough"],[6273,11,""],[6273,0,"eh."],[6273,3,""],[6273,0,"its "],[6276,1,""],[6275,1,""],[6274,1,""],[6274,0,"it"],[6275,1,""],[6274,1,""],[6274,0,"t'll do."],[3033,0,"nearly 5 minutes to run. "],[3058,20,""],[3131,1,""],[3130,1,""],[3129,1,""],[3132,0,"millin"],[3137,1,""],[3144,0,". 0.6"],[3148,1,""],[3148,0,"065 seconds"],[3392,3,""],[3392,0,"Wait, no."],[3401,10,""],[3401,0," First"],[3436,0," an"],[3437,2,""],[3436,1,""],[3434,0,"on earth "],[3798,0,"\n\nI"],[3800,1,""],[3800,0,"I don't recomend"],[3815,1,""],[3814,1,""],[3813,1,""],[3813,0,"mend using it. If you want a production grade CRDT implementation today, "],[3800,0,"("],[3818,0," actually"],[3801,0,"Just an aside: "],[3851,0," t"],[3852,1,""],[3851,1,""],[3851,0," yet - its not ready"],[3931,0,"https://github.com/yjs/yjs"],[3930,0," Yjs is the "],[3938,4,""],[3938,0,"currently the best in the business"],[3972,27,""],[3972,0,". Kevin "],[3979,1,""],[3979,0," Y"],[3980,1,""],[3980,0,"Jahns is a class act"],[3986,14,""],[3974,12,""],[3974,0,"Youl'"],[3978,1,""],[3977,1,""],[3977,0,"'ll see why soon!)"],[3849,2,""],[3849,0,"automerge"],[3938,0,"["],[3942,0,"]( https://github.com/yjs/yjs)"],[3944,1,""],[3974,10,""],[3859,4,""],[3858,1,""],[3858,0," at the moment."],[3873,3,""],[3873,0," I"],[3887,0," for prime time"],[3892,10,""],[3891,1,""],[3890,1,""],[3889,1,""],[3888,1,""],[3888,0,"yet"],[3988,24,""],[3988,0,"as "],[3990,1,""],[3989,1,""],[3989,0,"n easy recommendation. It "],[4014,1,""],[4013,1,""],[4012,1,""],[4011,1,""],[4010,1,""],[4023,3,""],[4023,0,"some of the reasons"],[3801,7,""],[3801,0,"Oh and a quick"],[4058,0,"Si "],[4060,1,""],[4059,1,""],[4059,0,"o "],[4058,3,""],[4073,0,"Yjs and other "],[4087,5,""],[4086,1,""],[4086,0,"s"],[4086,1,""],[4446,11,""],[4446,0,"We can draw this as a tree!"],[4954,0,"argh, "],[4968,0," actually"],[5006,1,""],[5006,0," because"],[5014,14,""],[5014,0," "],[4780,1,""],[4780,0,"X"],[4818,0," Hang on, which one goes first?"],[4828,0,"how do we figure out "],[4854,4,""],[4854,0," character shoul"],[4865,5,""],[4864,1,""],[4981,10,""],[4981,0," sorting them based on "],[5003,1,""],[5030,0,"then we'd end up with \"abXc\"."],[5059,118,""],[5060,3,""],[5060,0,"Automerge"],[5148,0,". The sequence number is bi"],[5173,2,""],[5173,0,"1 bigger than the biggest sequence number you've ever seen"],[5150,0,"When you make a change, "],[5174,1,""],[5174,0,"t"],[5159,15,""],[5159,0,"insert anything, you set "],[5204,2,""],[5204,0,"to"],[5207,0,"be "],[5268,1,""],[5268,0,". Yjs has a different approach, but its "],[5268,40,""],[5268,0,":"],[5270,0,"\n"],[5270,0,"\n(Yjs has a different approach to the e"],[5308,1,""],[5308,0,"sequence numner th"],[5317,9,""],[5317,0,"m"],[5317,1,""],[5317,0,"number thing, but the difference is "],[5335,18,""],[5335,0,"lets not get into that now)"],[5282,0,"slightly "],[5344,26,""],[5344,0,"whatever"],[5344,8,""],[5344,0,"its fine,"],[5352,1,""],[5344,8,""],[5344,0,"you"],[5271,77,""],[5270,1,""],[5269,1,""],[5082,0,"with a bit of a hack. It "],[5107,3,""],[5112,1,""],[5111,1,""],[5110,1,""],[5110,0,"s"],[5174,0,"ever"],[5211,0," new item's"],[5524,0,"\n\n(Wo "],[5529,1,""],[5526,4,""],[5525,1,""],[5525,0,"\n\n"],[5526,0,"> Wow I saw a sequence number, and it was *this big*!"],[5578,1,""],[5577,0,"!"],[5526,53,""],[5525,1,""],[5524,1,""],[5524,0,"\n\n> Wow I saw a sequence number, and it was *this big!*. Y"],[5581,1,""],[5581,0,"\""],[5581,1,""],[5581,0,"Yeah? Mine is *even bige"],[5604,1,""],[5604,0,"ger!*"],[5528,0,"\""],[5581,0,"\""],[5583,0,"\""],[5612,0,"\". Ahem."],[6180,0,"Uh, uhm, "],[6225,1,""],[6286,1,""],[6285,1,""],[6285,0," I think"],[6286,7,""],[6286,0,"Yes, the automerge library implements"],[6312,11,""],[6286,26,""],[6286,0,"Whta"],[6289,1,""],[6288,1,""],[6288,0,"atever. The automerge library implements"],[6318,10,""],[6318,0,"works by building a tree of items."],[6285,1,""],[6285,0,"\n\n"],[6286,1,""],[6285,1,""],[6285,0," "],[6286,8,""],[6285,3,""],[6285,0,"\n\n"],[6286,1,""],[6285,1,""],[6285,0," Any"],[6288,1,""],[6287,1,""],[6286,1,""],[6286,0,"Waht"],[6289,1,""],[6288,1,""],[6287,1,""],[6287,0,"hatever. "],[6035,0,"("],[6286,0,")"],[6356,61,""],[6356,0,"So how e"],[6363,1,""],[6363,0,"we"],[6364,1,""],[6363,1,""],[6363,0,"fas"],[6356,10,""],[6356,0,"How fast is it?"],[6372,4,""],[6372,0,"A"],[6408,3,""],[6408,0,"run"],[6408,3,""],[6408,0,"test it using"],[6432,0,"own "],[6436,15,""],[6423,0,"an editin "],[6432,1,""],[6432,0,"g trace "],[6446,20,""],[6446,0," himself made"],[6526,8,""],[6526,0," trace of"],[6542,8,""],[6550,1,""],[6549,1,""],[6549,0,"in"],[6550,1,""],[6549,1,""],[6543,6,""],[6543,0,"typing up"],[6552,15,""],[6552,0," "],[6356,16,""],[6356,0,"How fast is it? "],[6356,16,""],[6356,0,"For "],[6360,1,""],[6360,0,"a"],[6361,1,""],[6363,1,""],[6362,1,""],[6397,0," automerge"],[6407,3,""],[6656,22,""],[6736,0," anyawy"],[6742,1,""],[6741,1,""],[6740,1,""],[6740,0,"way"],[6745,4,""],[6748,5,""],[6748,0," only"],[6832,0," Kevin Jahns (the Yjs author) has a much better"],[6873,6,""],[6873,0,"more extensive benchmarking suite"],[6878,0,"["],[6907,0," here](https://github.com/dmonad/crdt-benchmarks). All the benchmarks here are done using Nodes"],[7001,1,""],[7001,0,"js 16.1 on my hc"],[7016,1,""],[7015,1,""],[7015,0,"chonky chonk ryzen 5800x workstation."],[7022,5,""],[7021,1,""],[6991,18,""],[7027,1,""],[7027,0,", with using Nodejs 16.1 "],[7034,6,""],[7046,0,"and rustc 1.52 when thats appropriate. Spoilers!"],[6525,2,""],[6525,0,"from"],[6613,40,""],[6613,0,","],[6615,1,""],[6615,0,"b"],[6711,0," also"],[6774,1,""],[6774,0,", which"],[6781,4,""],[6781,0," isn't"],[6793,1,""],[6821,4,""],[6927,0," if you're into that sort of thing"],[6967,3,""],[6967,0,"my"],[6967,2,""],[6967,0,"the"],[7090,0,"("],[7100,0,")"],[7075,1,""],[7075,0," becomes"],[7110,0,"Anyway, "],[7118,1,""],[7118,0,"a"],[7127,0," above"],[7233,0," "],[7244,35,""],[7108,0,"\n\nThe editing trace "],[7110,18,""],[7110,0,"M"],[7110,1,""],[7110,0,"The editing trace has 2800"],[7135,1,""],[7135,0," 000 edits, and the final document size is about 100kb."],[7188,0," "],[7188,1,""],[7187,0," "],[7188,2,""],[7188,0,"000 characters"],[7205,9,""],[7204,1,""],[7203,1,""],[7203,0," A"],[7203,1,""],[7203,0,"\n\n"],[7278,8,""],[7290,18,""],[7290,0,"by the time its donw"],[7309,1,""],[7309,0,"e, automerge uses"],[7341,0," Wow."],[7345,1,""],[7345,0,"!"],[7345,1,""],[7345,0,"!"],[7342,4,""],[7342,0,"Whoa! Thats 10kb f"],[7359,1,""],[7359,0,"of ram *per key press*."],[7384,54,""],[7384,0,"We can compare"],[7384,14,""],[7384,0,"W"],[7384,1,""],[7384,0,"If we just process that in javascript directly"],[7430,24,""],[7430,0,", using a"],[7457,39,""],[7457,0,", well "],[7463,1,""],[7463,0,", its much slower:"],[7467,1,""],[7467,0," might allow concurrent edits but its"],[7504,12,""],[7504,0," slow"],[7671,0," "],[7674,1,""],[7764,0," "],[7764,1,""],[7763,1,""],[7763,0," though?"],[8360,8,""],[8360,0,"that"],[8372,0," too"],[8438,0," The automerge team is working on a rust \"backend\""],[8487,1,""],[8479,1,""],[8486,0," for the algorithm, but it hasn't been merged yet."],[8474,0,"replacement "],[8490,16,""],[8490,0," implementation of the"],[8554,0," And in the meantime they haven't bothered making the javascript code fast because"],[8554,82,""],[8528,0,"at the time of writing "],[8579,118,""],[8578,0,"\n"],[8578,1,""],[8579,0,"There's an old saying with performance tuning:\n\n> You can't make a program faster. You can only make it do less work.\n"],[8386,3,""],[8386,0," automerge"],[8400,5,""],[8379,9,""],[8379,0,"A"],[8437,10,""],[8436,1,""],[8436,0,"ir "],[8546,17,""],[8546,0," landed yet."],[8661,2,""],[8661,0,"the computer"],[8560,0,"So how do"],[8560,9,""],[8689,4,""],[8689,0,"H"],[8778,0," from goin ght"],[8791,1,""],[8790,1,""],[8789,1,""],[8788,1,""],[8788,0,"g through the code and improving things"],[8832,0," I agree with the atuomer"],[8850,7,""],[8850,0,"automerge team:"],[8866,1,""],[8866,0,"W"],[8864,1,""],[8864,0,"."],[9005,19,""],[9005,0,"A"],[9074,0," Lets "],[9079,1,""],[9078,1,""],[9077,1,""],[9076,1,""],[9075,1,""],[9074,1,""],[9074,0," We can "],[9075,7,""],[9075,0,"LEts"],[9078,1,""],[9077,1,""],[9076,1,""],[9076,0,"ets \"Im"],[9082,1,""],[9081,1,""],[9081,0,"improve\" it."],[9080,9,""],[9080,0,"fix"],[9172,1,""],[9172,0,"."],[9174,5,""],[9174,0,"You can"],[9172,1,""],[9172,0,", which Ke"],[9180,2,""],[9174,6,""],[9174,0,"pioneered by"],[9186,55,""],[9227,5,""],[9227,0,"talking about"],[9261,1,""],[9260,1,""],[9260,0,","],[9260,1,""],[9281,0,"pretty "],[9334,0,"data structure \""],[9355,0,"\""],[9388,0,"in the field has "],[9461,0," automerge does"],[9476,5,""],[9753,0,"flat "],[10027,84,""],[10026,1,""],[10025,1,""],[10025,0,", bu"],[10028,1,""],[10027,1,""],[10026,1,""],[10026,0," "],[10035,1,""],[10034,1,""],[10034,0,"ll get there"],[10046,14,""],[9983,9,""],[10041,0,"With this structure, the way we insert items changes."],[10093,1,""],[10093,0," slightly. "],[10104,68,""],[10103,1,""],[10094,9,""],[10093,1,""],[10093,0,"."],[10110,3,""],[10110,0,"wi"],[10111,1,""],[10111,0,"e insert by"],[10122,10,""],[10122,0," answer is"],[10119,3,""],[10112,7,""],[10111,1,""],[10111,0,"i"],[10110,2,""],[10110,0,"the"],[10093,1,""],[10093,0," slightly. ?"],[10104,0,"The question is, how do you insert a new item into a list like this"],[10104,18,""],[10104,0,"H"],[10144,10,""],[10062,42,""],[10041,21,""],[10041,0,"That looks simple, but "],[10064,1,""],[10064,0,"h"],[10121,14,""],[10121,0,"its easy:"],[10213,18,""],[10213,0,", keeping the sor"],[10226,4,""],[10226,0,"m sorted."],[10213,1,""],[10213,0,". ("],[10216,8,""],[10216,0,"Keep"],[10213,20,""],[10188,0,"right location in the "],[10235,0,"."],[10235,1,""],[10245,0," tyj"],[10248,1,""],[10247,1,""],[10246,1,""],[10246,0,"yjs"],[10387,0,"where "],[10428,0,"And uh, "],[10436,1,""],[10436,0,"i"],[10428,9,""],[10428,0,"I"],[10434,9,""],[10434,0," it!"],[10440,33,""],[10440,0,"This is"],[10447,39,""],[10447,0," just a"],[10440,0,"Essentially, "],[10453,4,""],[10453,0,"this approach"],[10500,0,"It sounds sort of complicated, but "],[10535,1,""],[10535,0,"y"],[10603,0,"Here's a"],[10610,1,""],[10610,0,"the algorithm in "],[10627,3,""],[10635,45,""],[10635,0,", with lots o"],[10642,6,""],[10642,0,"comments"],[10869,0," CRDT"],[10837,0," lots of R"],[10846,1,""],[10846,0,"CRDTs like this."],[10894,0,"s all work, and y"],[10904,7,""],[10904,0,"\n2. Doing it this way lets you implement the semantics of multiple"],[10975,0,"s"],[10976,10,""],[11107,2,""],[11107,0,"s. "],[11110,2,""],[11110,0,"M"],[11116,0," you"],[11125,0," need to"],[11141,1,""],[11140,1,""],[11139,1,""],[11138,1,""],[11174,0,"s"],[11177,1,""],[11177,0,"3"],[11423,1,""],[11423,0,"4"],[11547,1,""],[11547,0,"5"],[11179,0," The algorithm iss"],[11196,1,""],[11196,0," super fast"],[11194,13,""],[11194,0,"only slows down when there are"],[11225,1,""],[11225,0,"c"],[11264,0,". u"],[11266,1,""],[11266,0,"But thats"],[11275,4,""],[11298,4,""],[11298,0," -"],[11360,85,""],[11360,0,"I"],[11387,1,""],[11387,0,"."],[11404,4,""],[11404,0,"the"],[11408,0,"*"],[11423,0,"*"],[11423,1,""],[11408,1,""],[11426,4,""],[11425,1,""],[11450,0," is"],[11478,0," to actual automerge, and yjs and sync9"],[11519,1,""],[11546,1,""],[11545,1,""],[11545,0,".)"],[11519,0,"("],[11520,21,""],[11520,0,"F"],[11526,0," verfi"],[11531,1,""],[11530,1,""],[11530,0,"ified (TM)"],[11520,0,"["],[11536,0,"](https://github.com/josephg/reference-crdts/blob/main/reference_test.ts)"],[11609,6,""],[11617,0," kind"],[11618,4,""],[11618,0,"also really"],[11630,4,""],[11630,0,"elegant"],[11639,0,"We "],[11642,1,""],[11642,0,"i"],[11675,1,""],[11675,0,"."],[11684,1,""],[11676,8,""],[11676,0," Genius!"],[11676,8,""],[11676,0," Genius!"],[11720,5,""],[11720,0,"ITs a"],[11724,1,""],[11723,1,""],[11722,1,""],[11721,1,""],[11721,0,"ts about"],[11777,37,""],[11777,0,":"],[12096,0,"Mind you, "],[12106,1,""],[12106,0,"s"],[12143,10,""],[12142,1,""],[12193,0," This "],[12194,5,""],[12194,0,"These "],[12194,6,""],[12194,0,"These are completely different codebases being tested."],[10235,0,"\n3. Uh"],[10239,2,""],[10239,0,"S"],[10239,1,""],[10239,0,"Traverse the tree"],[10248,8,""],[10248,0,"backwa"],[10248,6,""],[10248,0,"up the tree to figure out where "],[10274,6,""],[10274,0,"the insert position of th e"],[10300,1,""],[10300,0,"e"],[10300,1,""],[10299,1,""],[10299,0,"e new item, and update"],[10250,0," through"],[10329,0," our copy of the document. (Automerge also sto"],[10236,139,""],[10236,0,"3. Traverse up through the tree to figure out the insert position of the new item, and update our copy of the document. (Automerge also sto"],[10239,0,"("],[10239,1,""],[10318,4,""],[10318,0," so you can"],[10329,53,""],[10329,0," add "],[10333,1,""],[10329,4,""],[10329,0," update our copy of the document. (Automerge also sto"],[10337,12,""],[10349,21,""],[10349,0," in your editor / "],[10366,1,""],[10365,1,""],[10364,1,""],[10364,0,"."],[10341,0,"actual "],[10383,1,""],[10383,0,"Y"],[10666,0," (And it"],[10668,6,""],[10668,0,"and it si"],[10676,1,""],[10675,1,""],[10675,0,"is a bit hairy translating the semantics)"],[10716,1,""],[10716,0,"."],[10718,1,""],[10718,0,"B"],[10761,0," for automerge or yjs "],[10782,1,""],[10822,9,""],[10822,0,"insert function"],[10978,38,""],[10978,0,"This approach is pretty beautiful"],[11011,12,""],[10995,7,""],[10995,0,"pretty "],[10995,7,""],[11004,0," for lot sof reasons"],[11016,1,""],[11015,1,""],[11014,1,""],[11013,1,""],[11012,1,""],[11012,0,"s of "],[11820,0,"\n5. Its faster *and* simpler. Holy grail."],[11850,0,"Thats wal"],[11858,1,""],[11857,1,""],[11856,1,""],[11856,0,"always the "],[11867,1,""],[11867,0,"h"],[11850,28,""],[11850,0,"Holy grail, right there."],[11848,26,""],[11848,0,"."],[11849,28,""],[11931,10,""],[11931,0,"Its "],[11897,34,""],[11897,0,"This approach is about"],[11919,3,""],[11930,0,", and"],[11935,10,""],[12302,0,"se"],[12434,0,", so its"],[12436,6,""],[12435,1,""],[12434,1,""],[12434,0,". The performance difference is nevr j"],[12471,1,""],[12470,1,""],[12469,1,""],[12469,0,"er just one thing"],[12462,0,"s aren't"],[12470,9,""],[12434,1,""],[12434,0,", so"],[12439,1,""],[12439,0,"t"],[12479,0,"this "],[12484,4,""],[12281,0,"> Note: "],[12289,11,""],[12289,0,"S"],[12289,90,""],[12398,0," Some of these performance improvements come from the fact I'm also not using immutablejs. "],[12399,58,""],[12430,1,""],[12430,0," here"],[12434,1,""],[12433,1,""],[12432,1,""],[12431,1,""],[12430,1,""],[12429,1,""],[12429,0," here - which will also make a big performane "],[12474,1,""],[12473,1,""],[12473,0,"ce difference."],[12443,4,""],[12443,0,"is"],[12454,1,""],[12454,0,"ing"],[12464,11,""],[12464,0,"performance"],[12446,0,"probably "],[12473,11,""],[12473,0,"impact on performance"],[12494,12,""],[12494,0,"."],[12520,0,"\n"],[12520,0,"\nThis is better, but its still not *fast*."],[12673,0,"\n"],[12563,1,""],[12672,0,"\nThis is better, but its still not *fast*."],[12521,42,""],[12566,0," / abstraction"],[12525,0,"that "],[12546,6,""],[12546,0,"correct "],[12564,12,""],[12575,22,""],[12575,0,","],[12575,1,""],[12575,0," its time to "],[12588,12,""],[12587,1,""],[12591,0," our"],[12594,1,""],[12593,1,""],[12592,1,""],[12591,1,""],[12521,10,""],[12521,0,"W"],[12567,0,", "],[12568,1,""],[12567,1,""],[12566,1,""],[12566,0,", but the implementation iss"],[12593,1,""],[12593,0," still not *fast*. "],[12612,1,""],[12612,0,"I"],[12631,0," big"],[12656,1,""],[12656,0,"."],[12657,43,""],[12656,1,""],[12656,0,":"],[12692,0,","],[12648,8,""],[12648,0,"bottlenecks in this algorithm"],[12757,4,""],[12757,0,"W"],[12861,5,""],[13177,6,""],[13177,0,"I"],[13282,6,""],[13427,1,""],[13427,0,". We also need to figureout "],[13454,1,""],[13453,1,""],[13452,1,""],[13451,1,""],[13450,1,""],[13450,0," "],[13450,1,""],[13450,0,"e out the parent of thi"],[13472,1,""],[13472,0,"e new item."],[13483,41,""],[13445,0,"take a look at nearby operations to "],[13523,0,"th"],[13524,1,""],[13523,1,""],[13523,0," the user"],[13532,5,""],[13539,0,"s"],[13640,1,""],[13640,0,"."],[13687,7,""],[13687,0,"t"],[13684,4,""],[13684,0,"the cod d"],[13692,1,""],[13691,1,""],[13691,0,"e does this"],[13866,0," *after* the new item"],[13906,0," in the array"],[13965,6,""],[13964,1,""],[13963,1,""],[13963,0,"\n\n> T"],[13967,1,""],[13966,1,""],[13965,1,""],[13964,1,""],[13963,1,""],[13963,0," (I'm "],[13965,0,"Well, "],[13983,11,""],[13983,0," v8"],[13985,1,""],[13984,1,""],[13984,0,"V8"],[13986,9,""],[14012,13,""],[14012,0,"here"],[14016,1,""],[14016,0,"."],[14018,5,""],[14018,0,"W"],[13953,9,""],[13953,0,"its still probably slow when we're moving thousands of items"],[14016,6,""],[14016,0,"Well, "],[14016,4,""],[14016,0,"Aside:"],[14022,1,""],[14035,0," here that"],[14073,5,""],[14075,0,"u"],[14075,1,""],[14075,0,"gut"],[14077,1,""],[14076,1,""],[14075,1,""],[14075,0,"But "],[14079,1,""],[14079,0,"w"],[14116,5,""],[14116,0,"in th"],[14120,1,""],[14119,1,""],[14119,0,"th"],[14118,3,""],[14116,2,""],[14116,0,"there"],[13995,9,""],[13995,0,"a"],[13995,1,""],[13995,0,"so many"],[14002,3,""],[13938,9,""],[13938,0," in native code"],[14148,0," in"],[14126,25,""],[14126,0,"Every time we insert into a document with n items"],[14201,53,""],[14201,0,"n steps of work"],[14168,0,"*"],[14170,0,"*"],[14203,0,"*"],[14205,0,"*"],[14212,8,""],[14221,21,""],[14221,0,"ee"],[14222,1,""],[14222,0,"very time we insert into a document where there have"],[14287,0,"*n* items "],[14312,0," - d"],[14315,1,""],[14314,1,""],[14313,1,""],[14312,1,""],[14312,0,". D"],[14314,1,""],[14313,1,""],[14312,1,""],[14312,0,", because deleted items are never really removed"],[14366,0," algorithm"],[14422,1,""],[14422,0," "],[14124,0,"\n\nInsert "],[14132,1,""],[14132,0,"ing an item will tak"],[14144,8,""],[14144,0,"into a document"],[14159,38,""],[14174,35,""],[14174,0," "],[14174,1,""],[14174,0,", the computer does about *n* steps"],[14174,25,""],[14174,0," will take"],[14196,5,""],[14196,0,"Nope, its worse than that."],[14222,15,""],[14223,1,""],[14223,0,"I"],[14229,0,"ing"],[14276,1,""],[14266,1,""],[14266,0,"*"],[14276,0,"*"],[14287,16,""],[14221,0," beau"],[14225,1,""],[14224,1,""],[14224,0,"cause deleted items aren't really removed"],[14331,48,""],[14331,0," will take n steps"],[14342,0,"*"],[14344,0,"*"],[14414,0,"In Big-O notation, "],[14433,1,""],[14433,0,"i"],[14466,0,"*"],[14473,0,"*"],[14443,0,"*"],[14445,0,"*"],[14477,0,"\n"],[14498,0,"\n"],[14498,0,"\nCan we fix this? Yes we can!"],[14529,0,"We need t"],[14537,1,""],[14529,8,""],[14962,0,", without sliding "],[14972,8,""],[14972,0,"copying all the existing items around"],[15009,7,""],[15009,0,"."],[15011,1,""],[15011,0,"W"],[15067,0," - because linked lists allow inser"],[15091,11,""],[15091,0,"c"],[15091,1,""],[15091,0,"allow inserts in the middle in O(1) time"],[15134,0,"Well, "],[15140,1,""],[15140,0,"i"],[15132,79,""],[15137,0," adds"],[15142,4,""],[15180,18,""],[15180,0,"thing"],[15800,18,""],[15800,0,"Aaah "],[15805,1,""],[15805,0,"f"],[15895,0,". Coll"],[15897,4,""],[15897,0,"We can only collapse runs of items "],[15932,18,""],[15931,1,""],[15951,8,""],[15937,14,""],[15937,0,"the iD"],[15942,1,""],[15941,1,""],[15941,0,"IDs and parents are sequential"],[15976,0," the code"],[15985,6,""],[15990,0,"s"],[15996,0," tricky"],[16003,8,""],[16034,0,"again "],[16066,10,""],[16082,4,""],[16082,0," a"],[16084,9,""],[16095,26,""],[16094,1,""],[16094,0,"t "],[16096,2,""],[16130,5,""],[16130,0,"entries"],[16096,0,"for this editing trace, "],[16096,24,""],[16096,0,"in Martin's editing trace, "],[15885,10,""],[15885,0," into a single item"],[15853,0,"Note "],[15858,1,""],[15858,0,"w"],[15860,0," unfortunately"],[15946,13,""],[15946,0,"inserts"],[15978,4,""],[15978,0," line up"],[15979,7,""],[15979,0,"are"],[15979,3,""],[15979,0,"line up"],[15997,0,"ly"],[16001,5,""],[16001,0,"T"],[16009,0," also"],[16026,6,""],[16025,1,""],[16001,33,""],[16001,0,"We'll also sometimes need to"],[16068,6,""],[16093,0," one of our"],[16104,2,""],[16115,26,""],[16115,0," in Martin's editing trace"],[16115,26,""],[16115,0,", with this benchmark data"],[16233,29,""],[16233,0,"How fast is it now? Yjs"],[16256,10,""],[16270,0," than the reference-crdts implementation, and it only "],[16324,16,""],[16324,0,"uses"],[16743,0," and confused"],[16748,8,""],[16748,0,"b"],[16748,1,""],[16748,0,"b"],[16748,1,""],[16748,0,"confused"],[16747,9,""],[16743,4,""],[16785,4,""],[16785,0," some"],[16790,9,""],[16811,0," is"],[16819,1,""],[16818,1,""],[16818,0,"ing"],[16869,42,""],[16869,0,"Leaving "],[16876,1,""],[16869,7,""],[16869,0,"Everything is faster in Rust, with B-Trees"],[16869,42,""],[16869,0,"Its"],[16869,3,""],[16869,0,"Everything is faster in Rust, with B-Trees"],[16869,42,""],[16869,0,"Javascript"],[16869,10,""],[16869,0,"Faster than Javascript"],[16893,22,""],[16970,1,""],[16970,0,", and"],[16976,1,""],[16976,0,"i"],[16936,36,""],[16893,0,"Yjs is very well optimized already, and I doub"],[16935,4,""],[16935,0,"suspect "],[16943,1,""],[16943,0,"j"],[16954,5,""],[16954,0,"can't"],[16942,0," we can't make"],[16967,9,""],[16967,0," run"],[16984,9,""],[16984,0,"in this test"],[16998,5,""],[16998,0,"I"],[16997,1,""],[16997,0,"\n\n"],[16998,1,""],[16997,1,""],[16997,0," "],[17081,1,""],[17081,0," w"],[17082,1,""],[17082,0,"- which we can only do"],[17053,51,""],[17053,0,"more control over the memory layout - which we can only do in a lower"],[17117,5,""],[17117,0,"sst"],[17119,1,""],[17118,1,""],[17118,0,"ystems "],[17104,5,""],[17120,0,"language like Rust."],[17320,0," in memory"],[17344,0,"By the way, "],[17357,1,""],[17357,0,"y"],[17385,0,"Its "],[17388,1,""],[17387,1,""],[17386,1,""],[17385,1,""],[17385,0,"Its terrible because "],[17406,1,""],[17406,0,"a"],[17422,0,"fragmented - "],[17434,1,""],[17433,1,""],[17432,1,""],[17432,0,". Its all "],[17468,30,""],[17468,0," arrange data like this"],[17528,0," for each item"],[17529,0,"one by one "],[17605,5,""],[17611,0,"all of those "],[17624,14,""],[17624,0,"objects"],[17602,0,"extra data "],[17674,12,""],[17674,0,"ll "],[17699,1,""],[17699,0,"."],[17700,6,""],[17700,0," I"],[17723,0," in memory"],[17699,1,""],[17699,0,", and"],[17705,1,""],[17705,0,"i"],[17699,38,""],[17801,5,""],[17806,0," as well"],[17816,2,""],[17816,0,"If we"],[17821,4,""],[17858,26,""],[17904,1,""],[17904,0,","],[17906,19,""],[17905,1,""],[17930,0," about"],[17949,1,""],[17949,0," -"],[17950,1,""],[17949,1,""],[17949,0,"- "],[17969,1,""],[17971,0,"At t"],[17974,1,""],[17973,1,""],[17972,1,""],[17972,0,"nd at this speed, "],[17990,4,""],[18016,17,""],[18016,0," takes the computer"],[17971,0,"In comps"],[17978,1,""],[17978,0,"arons"],[17982,1,""],[17981,1,""],[17980,1,""],[17980,0,"ison, "],[17986,4,""],[17999,1,""],[18094,5,""],[18103,6,""],[18102,1,""],[18107,1,""],[18106,1,""],[18105,1,""],[18105,0,"iting"],[18168,0," shopping "],[18177,1,""],[18056,1,""],[18056,0,"\n\n"],[18127,1,""],[18127,0,"."],[18129,1,""],[18129,0,"B"],[18223,14,""],[18229,5,""],[18229,0," item in the scavenger hunt names"],[18262,6,""],[18289,33,""],[18288,1,""],[18287,1,""],[18286,1,""],[18286,0,", with a hiddne"],[18300,1,""],[18299,1,""],[18299,0,"en"],[18301,5,""],[18333,0,"or whatever "],[18351,41,""],[18351,0," "],[18351,1,""],[18351,0,"\n\nReading the whole list would take ages."],[18352,1,""],[18351,1,""],[18350,1,""],[18350,0," "],[18350,1,""],[18350,0,". Needless to say, "],[18369,1,""],[18369,0,"r"],[18391,0," takes the computer"],[18410,11,""],[18416,0," ("],[18417,1,""],[18416,1,""],[18415,1,""],[18415,0," (in computer time)."],[18675,0,"linked li"],[18665,19,""],[18665,0,"F"],[18665,1,""],[18665,0,"With linked lists "],[18688,2,""],[18688,0," that"],[18743,18,""],[18727,16,""],[18727,0,"between items, and we do that a lot"],[18740,22,""],[18777,12,""],[18777,0,"F"],[18812,0," need a lot of objects, "],[18836,27,""],[18835,1,""],[18835,0," so"],[18838,4,""],[18838,0," we"],[18834,1,""],[18834,0,". So there's"],[18836,10,""],[18826,0," weird"],[18840,1,""],[18840,0,", which willen"],[18853,1,""],[18852,1,""],[18852,0," end up"],[18859,32,""],[18840,0," (like fixed size ara"],[18860,1,""],[18860,0,"rays)"],[18865,1,""],[18865,0,". These"],[18867,5,""],[18867,0,"In javascript"],[18880,11,""],[18880,0," "],[18867,14,""],[18867,0,"And that makes fragmentation worse, even as we're making the "],[18903,25,""],[18902,1,""],[18901,1,""],[18901,0,". Its a "],[18902,45,""],[18902,0," "],[18901,0,", which makes"],[18909,5,""],[18909,0,"can make things slow, "],[18930,1,""],[18929,1,""],[18929,0,"er, not faster"],[18999,0,"even "],[19004,49,""],[19014,0," we don't have to use javascript any more"],[18986,1,""],[18985,1,""],[18985,0," "],[18496,10,""],[18496,0,"I want to"],[18534,1,""],[18533,1,""],[18533,0,"."],[18535,1,""],[18535,0,"A"],[18639,6,""],[18655,79,""],[18655,0," (With linked lists we do that scavenger hunt each time we move between items!)"],[18675,25,""],[18675,0,"you incur a memory read"],[18708,3,""],[18708,0," you"],[18858,3,""],[18858,0,"All those extra objects"],[18881,5,""],[18909,0,"so the result is often"],[18931,21,""],[18952,0,"This is "],[18960,3,""],[18959,1,""],[19000,8,""],[19067,11,""],[19067,0,"WebAssembly"],[19081,2,""],[19081,0,"To see how fast we can *really* go,"],[19268,0,"the "],[19275,0," implemen"],[19276,8,""],[19275,1,""],[19272,0,"previous "],[19272,9,""],[19268,4,""],[19241,30,""],[19241,0,"works the same as yjs"],[19262,1,""],[19262,0,","],[19264,1,""],[19264,0,"b"],[19309,0," internally"],[19740,9,""],[19740,0,"any item."],[19784,4,""],[19784,0,". Updates"],[19793,1,""],[19798,1,""],[19810,0,"so again"],[19818,8,""],[19832,0," and we're done"],[19889,0,"\n"],[19889,0,"\nWhen we"],[19890,7,""],[19890,0,"It doesn't compe"],[19905,1,""],[19904,1,""],[19904,0,"e into play here, but when merging remote edits we also need to find items by their ID ("],[19992,71,""],[20009,0," My rust implementation has an index to make this fast, too."],[20071,39,""],[20071,0,"I'm not using"],[20125,0," - which might make it "],[20128,20,""],[20128,0,"at least not yet"],[20148,0,"just "],[20166,10,""],[20166,0," it."],[20146,0,"Mayb eit w"],[20155,1,""],[20154,1,""],[20153,1,""],[20152,1,""],[20151,1,""],[20150,1,""],[20150,0,"e it would help? "],[20168,5,""],[20192,45,""],[20192,0," avoids "],[20199,1,""],[20192,7,""],[20192,0," lets us pack all the items tightly in memory"],[20192,45,""],[20192,0," gives us total control over the memory lat"],[20234,1,""],[20234,0,"yout, so we can pack everything in tightly"],[20309,0,"a run of "],[20328,28,""],[20328,0," "],[20328,1,""],[20328,0,", all packed"],[20334,6,""],[20334,0,"adjacent in RAM"],[20436,3,""],[20436,0,"Memcpy"],[20442,7,""],[20442,0," is always"],[20483,1,""],[20483,0," - its a few hearb"],[20500,1,""],[20500,0,"t beats. Not a scavenger hunt."],[20486,4,""],[20486,0,"its "],[20513,0,"the "],[20517,2,""],[20531,0," of a main memory lookup"],[20642,6,""],[20642,0,"we can now proces "],[20659,1,""],[20659,0,"s the whole trace in"],[20679,7,""],[20598,12,""],[20598,0,"Driven from "],[20621,7,""],[20621,0,"to"],[20598,25,""],[20598,0,"If we compile this code to"],[20636,0," and drive it from javascript"],[20723,0,"And if we compile it to native code and "],[20763,6,""],[20763,0,"call it"],[20828,0,"*"],[20844,0,"*"],[20845,1,""],[20845,0,":"],[20845,1,""],[20845,0,"."],[21353,0,"I've done "],[21363,8,""],[21377,10,""],[21352,0,"\n"],[21352,0,"\n---"],[21461,0," and I couldn't help myself"],[21490,0,"In this implementation, "],[21541,4,""],[21525,0," text"],[21577,0," The reason is that"],[21597,1,""],[21597,0,"w"],[21842,0," too"],[21772,1,""],[21772,0," don't think it"],[21787,8,""],[21792,0,"s"],[21859,3,""],[21859,0,"m"],[21859,1,""],[21856,3,""],[21856,0,"My"],[21917,28,""],[21917,0,"[i"],[21918,1,""],[21917,1,""],[21917,0,"Btree"],[21917,0,"<"],[21923,0," of {"],[21927,1,""],[21927,0,"[item, item item"],[21938,0,","],[21944,0,", ...]"],[21932,0," span"],[21943,0," span"],[21950,6,""],[21954,1,""],[21954,0,">,"],[16869,0,"Making it "],[16879,1,""],[16879,0,"f"],[21362,0,"\n"],[21362,0,"\nThi"],[21365,1,""],[21364,1,""],[21363,1,""],[21363,0,"This code is faster than using a raw javascript string."],[21388,0,"editing"],[21395,5,""],[21397,0," normal"],[21404,4,""],[21363,0,"Even from webassembly "],[21384,1,""],[21384,0,", "],[21368,4,""],[21368,0,"through"],[21389,1,""],[21389,0,"t"],[21401,0," 3x"],[21426,0," nai"],[21429,1,""],[21429,0,"tive"],[21433,7,""],[21458,0,"\nBut"],[21462,1,""],[21462,0," "],[21552,7,""],[21552,0," sounded"],[21622,5,""],[21622,0,"split out"],[21635,0," document's"],[21660,7,""],[22136,0,"I'm "],[22136,4,""],[21968,0," "],[21968,1,""],[21968,0," Its a \"struct of arrays\" rather than \"array of structs\" approach."],[21968,1,""],[21968,0,"\n\n"],[22037,0,"So "],[22040,1,""],[22040,0,"m"],[22036,1,""],[22035,1,""],[22035,0," "],[22036,4,""],[22036,0,"M"],[22034,1,""],[22034,0,", with"],[22041,1,""],[22041,0,"m"],[22074,1,""],[22074,0,"ing"],[22415,0,"So "],[22418,1,""],[22418,0,"l"],[23120,14,""],[23120,0,". Thats how you implement a CRDT."],[22595,0," Semantics | LAng"],[22611,1,""],[22610,1,""],[22609,1,""],[22609,0,"anguage | Data structure"],[22696,0," ---------"],[22769,0," AM"],[22771,1,""],[22770,1,""],[22770,0,"RGA"],[22836,0,"RGA"],[22838,1,""],[22837,1,""],[22836,1,""],[22836,0," RGA / YATA"],[22910,0," YATA"],[22978,0," (none)"],[23048,0," YATA"],[23116,0," YATA"],[23184,0," YATA"],[22706,0," "],[22634,73,""],[22634,0,"| --------------------------        | ---------- | --------- | ---------"],[22847,0," |"],[22773,0,"        |"],[22606,0," "],[22707,0,"--"],[22708,1,""],[22708,0," | --------"],[22795,0," Javascript"],[22796,10,""],[22796,0,"JS"],[22874,0," JS"],[22945,0,"       | JS"],[22596,23,""],[22595,1,""],[22674,21,""],[22674,0,"---------- | --------"],[22685,10,""],[22684,1,""],[22684,0,"-----|"],[22610,0," |"],[22756,15,""],[22756,0,"T"],[22756,1,""],[22756,0,"Naive-tree     |"],[22761,1,""],[22761,0," "],[22836,15,""],[22836,0,"Array          |"],[22916,15,""],[22916,0,"Linked list    |"],[22996,6,""],[22996,0,"(none)         |"],[23076,4,""],[23013,63,""],[23013,0,"| Rust (Called from JS via WASM)    | 0.20s      | ???       |"],[23002,0,"*"],[22996,0,"*"],[23004,2,""],[23075,0," B-Tree"],[23146,4,""],[23146,0,"B-Tree"],[23216,4,""],[23216,0,"B-Tree"],[23082,0,"         |"],[23162,0," "],[23093,70,""],[23093,0,"| Rust (native)                     | 0.065s     | 2.3 MB    | B-Tree         |"],[23242,0,"         |"],[22946,0,"*"],[22935,0,"*"],[22948,2,""],[23306,0,"\n\n\n"],[28386,64,""],[28386,0,"You can't tell from looking at this method, but insertionsAfter"],[24905,4073,""],[24694,211,""],[23308,0,"\n\n"],[7740,1,""],[9091,1,""],[12498,1,""],[14480,1,""],[14479,1,""],[16861,1,""],[16858,0,"\nBut we"],[16859,6,""],[16859,0,"We"],[16860,1,""],[16859,1,""],[16859,0,"But we can go faster"],[16859,5,""],[16859,0,"W"],[16859,16,""],[17144,0,"\n"],[16897,1,""],[17143,0,"\n## Making it faster than Javascript"],[16861,36,""],[17107,0,"\n"],[16860,1,""],[17106,0,"\n"],[16859,1,""],[16858,0,"\n"],[16858,0,"\nBut can we still go "],[16859,5,""],[16859,0,"C"],[16875,0,"faster?"],[16859,0,"But "],[16863,1,""],[16863,0,"c"],[16859,5,""],[16859,0,"C"],[16859,24,""],[16859,0,"Can we still go faster?"],[16859,270,""],[16859,0,"Can we still go faster? Yjs is very well optimized already, and I suspect we can't make javascript run much faster in this test. If we want to continue to improve performance, we need more control over the memory layout - which we can do in a systems language like Rust."],[17078,51,""],[17078,0,"."],[17085,11,""],[17085,0,"F"],[17043,0,"to go lower level. W"],[17062,1,""],[17061,1,""],[17061,0," We need"],[17069,4,""],[16988,113,""],[16859,129,""],[16859,0,"Can we still go faster? Yjs is very well optimized already, and I suspect we can't make javascript run much faster in this test."],[17016,0,"\nIf we want to continue to improve performance, we need to go lower level. We need control over the memory layout."],[16987,0," But maybe.. just maybe we can be"],[17020,1,""],[17104,6,""],[17104,0,"a "],[17117,0," language, and we need"],[17139,9,""],[17128,0,"so we"],[17133,11,""],[17133,0," can"],[17145,5,""],[17369,12,""],[17370,1,""],[17370,0,"Y"],[17398,3,""],[17398,0,"This is"],[17833,0,"How slow? "],[17681,1,""],[17680,1,""],[17680,0," "],[17831,1,""],[17831,0,"\n\n"],[17841,0," are main memory reads"],[17973,0," would"],[17984,1,""],[18002,8,""],[18002,0,". The omp"],[18010,1,""],[18009,1,""],[18008,1,""],[18008,0,"computer "],[18002,15,""],[18002,0," - about"],[18012,0," human"],[18060,4,""],[18060,0,"every"],[18087,0," wl"],[18089,1,""],[18089,0,"ill"],[18112,0,"almost "],[18128,1,""],[18128,0,"!"],[18131,0,"This is what we do do to"],[18154,1,""],[18154,0,"he "],[18150,7,""],[18150,0,"do"],[18151,1,""],[18150,1,""],[18150,0,"to the computer when it runs javascript. In "],[18194,9,""],[18193,1,""],[18193,0," Arranging"],[18193,1,""],[18190,3,""],[18178,12,""],[18173,5,""],[18170,3,""],[18165,5,""],[18156,9,""],[18152,4,""],[18150,2,""],[18150,0,"do"],[18150,2,""],[18150,0,"do the "],[18156,1,""],[18154,2,""],[18154,0,"o"],[18152,3,""],[18149,3,""],[18146,3,""],[18143,3,""],[18138,5,""],[18135,3,""],[18131,4,""],[18200,1,""],[18200,0,"."],[18129,0," Imagine instead of "],[18130,19,""],[18129,1,""],[18471,13,""],[16471,1,""],[16471,0,":"],[16459,1,""],[16459,0,":"],[22711,1,""],[21019,1,""],[16459,1,""],[12074,1,""],[7609,1,""],[22707,0,":"],[21016,0,":"],[16457,0,":"],[12073,0,":"],[7609,0,":"],[22723,1,""],[21031,1,""],[16471,1,""],[12086,1,""],[7621,1,""],[22719,0,":"],[21028,0,":"],[16469,0,":"],[12085,0,":"],[7621,0,":"],[16727,0,"Honestly "],[16747,0," and a little suspicious of"],[22992,1,""],[21249,1,""],[16653,1,""],[22990,0,"2"],[21248,0,"2"],[16653,0,"2"],[22992,1,""],[21249,1,""],[16653,1,""],[22990,0,"3"],[21248,0,"3"],[16653,0,"3"],[17084,0,"\n\n"],[17085,0,"I "],[17086,1,""],[17085,1,""],[17085,0,"When I told Kevin that h"],[17108,1,""],[17108,0,"I thought I could "],[17085,41,""],[17085,0,"When I told Kevin that I thought I could"],[17056,0,"..."],[17128,0," we "],[17121,11,""],[17121,0,"a good rust impleemntation"],[17133,14,""],[17133,0,"implementation would go faster"],[17121,0,"I could make a"],[17134,1,""],[17160,0," that went "],[17171,10,""],[17177,0," than yjs, he didn't believe me. EH"],[17211,1,""],[17210,1,""],[17210,0,"He said yjs was already so optimized, he"],[17134,11,""],[17134,0,"CRDT"],[17134,0,"a "],[17160,5,""],[17160,0," goes"],[17244,1,""],[17243,1,""],[17243,0,"he doubted i"],[17254,1,""],[17253,1,""],[17243,10,""],[17243,0,"there wasn't much "],[17243,18,""],[17243,0,"going even faster was going to be basically impossible."],[17264,0,"n't"],[17280,20,""],[17280,0,"possibe"],[17286,1,""],[17286,0,"l"],[17286,1,""],[17286,0,"le"],[17160,5,""],[17160,0,"s"],[17228,0,"well "],[17261,0," probably"],[17277,12,""],[17287,0,"\n\nBut I knew about"],[17300,5,""],[17300,0,"something he dd"],[17314,1,""],[17314,0,"idn't: The way the computer organizes memory and memory lookups"],[17321,0,"U"],[17321,1,""],[17321,0,"We can use rust to "],[17321,18,""],[17321,0,"If we can control"],[17338,8,""],[17342,0," way the"],[17321,74,""],[17289,32,""],[17289,0,"But I knew something he didn't:"],[17287,0," \"Maybe a little faster... but not a lot faster!\""],[17310,0," in "],[17313,1,""],[17312,1,""],[17312,0,"f you just port it to rust"],[17338,2,""],[17338,0,"."],[17338,1,""],[17334,1,""],[17334,0,"R"],[17340,1,""],[17340,0,"B"],[17162,0,"way "],[17165,1,""],[17165,0," "],[17348,4,""],[17348,0,"it won't go "],[17374,0,"."],[17374,1,""],[17397,2,""],[17397,0,"Kevin"],[17409,0," know"],[17415,0," I knew about memory fragmentation c"],[17450,1,""],[17450,0,"and cache coherent structures."],[17347,12,""],[17347,0," not"],[17213,1,""],[17213,0,"Y"],[17258,0," a little bit"],[17253,18,""],[17253,0," a lot"],[17367,0," V"],[17368,1,""],[17367,1,""],[17366,0," V8 is really fast these days!"],[17405,4,""],[17405,0,"know"],[17405,4,""],[17405,0,"knew"],[17490,1,""],[17490,0,"cy"],[17492,11,""],[17509,31,""],[17509,0,"keep making yjs"],[17520,4,""],[17520,0," our algorithms "],[17493,54,""],[17493,0," Rust isn't just *faster*. It "],[17522,1,""],[17522,0,"s also"],[17551,21,""],[17551,0,"and that gives us the tools we need to control allocations and the"],[17614,3,""],[17613,1,""],[16893,0," Apparently some parts of yjs have been rewritten about 11 tives"],[16956,1,""],[16955,1,""],[16954,1,""],[16954,0,"mes in order to make it go that fast"],[16977,13,""],[16977,0," work so well. "],[16991,1,""],[16991,0," ITs super"],[16992,9,""],[16992,0,"Its super impressive!"],[16923,9,""],[16923,0,"were"],[16923,4,""],[16923,0,"have been"],[16950,1,""],[16950,0,"2"],[16991,22,""],[16990,1,""],[16990,0,"!"],[16993,0,"But "],[16997,1,""],[16997,0,"c"],[16993,5,""],[16993,0,"C"],[17017,40,""],[16993,0,"But "],[16997,1,""],[16997,0,"c"],[17019,0," anyway"],[17028,0,"Honestly "],[17039,21,""],[17039,0,"doubt I can mae"],[17053,1,""],[17053,0,"ke"],[17071,14,""],[17070,1,""],[17080,0," any faster than Kevin did"],[17039,5,""],[17038,1,""],[17038,0,"'m nervous about running"],[17054,8,""],[17048,6,""],[17040,8,""],[17038,2,""],[17038,0," doubt"],[17056,0,"pure "],[17165,0,"Pure "],[17165,5,""],[17484,0,"!"],[17718,0,"\n\n(I k"],[17723,1,""],[17723,0,"sway"],[17726,1,""],[17725,1,""],[17724,1,""],[17724,0,"ay *n"],[17728,1,""],[17728,0,"knew"],[17731,1,""],[17731,0,"w* because Kevin h"],[17748,1,""],[17748,0,"is copying me right back, and ork"],[17780,1,""],[17779,1,""],[17778,1,""],[17778,0,"working on "],[17723,11,""],[17723,0,"use the past tense here "],[17802,0,"[Yrs](https://github.com/yjs/y-crdt) - a rust port"],[17841,2,""],[17841,0,"his own "],[17858,0," of Yjs that "],[17870,1,""],[17869,1,""],[17868,1,""],[17868,0,"at "],[17870,1,""],[17869,1,""],[17868,1,""],[17867,1,""],[17866,1,""],[17865,1,""],[17865,0,"!)"],[17720,0,"> "],[17722,1,""],[17867,1,""],[18072,0,"Bad news: "],[18456,7,""],[18456,0,"will often"],[18471,1,""],[18746,16,""],[18746,0,"A"],[18811,7,""],[18811,0," close to"],[18831,0,"\n\n> Interactive vis showing 100 seconds vs 0.5 seconds"],[18886,0,"\n"],[18886,0,"\nIts the difference between reading a piece of paper, and reading a piece of paper witha sca"],[18977,1,""],[18976,1,""],[18975,1,""],[18974,1,""],[18973,1,""],[18973,0," location in your house. Then you have to go there, search around and *then* you find a pi"],[19044,19,""],[19044,0,"there"],[19048,1,""],[19047,1,""],[19046,1,""],[19045,1,""],[19044,1,""],[19043,1,""],[19043,0,"there you find another"],[18923,0," note on a"],[18964,0,"scavenger hunt"],[18978,14,""],[18983,0," a"],[19009,7,""],[19009,0," Y"],[19065,0,"*"],[19073,0,"* piece of paper with the actual note on it."],[18886,231,""],[18885,1,""],[18956,5,""],[18956,0,", only"],[18974,0,"\"Cheese, Milk, Bread\", "],[18997,20,""],[18996,1,""],[19015,25,""],[19015,0," has"],[19018,1,""],[19017,1,""],[19016,1,""],[19016,0,"lists a series of"],[19048,0,"s"],[19061,28,""],[19084,1,""],[19084,0," - and only when you search around there will you find"],[19138,5,""],[19153,6,""],[19153,0,"which actually says you need"],[19188,30,""],[19236,5,""],[19237,3,""],[19251,0," ages"],[19312,0," so our data is all together in memory"],[19315,12,""],[19315,0," its"],[19344,3,""],[19343,1,""],[19345,0," also"],[19343,0,"\n\n\n"],[19343,0," This is why linked"],[19344,18,""],[19344,0,"There's a reason why alno"],[19368,1,""],[19367,1,""],[19367,0,"most nobody uses linked lists"],[18596,8,""],[18596,0,"everything t"],[18607,1,""],[18607,0,"your computer does"],[18625,8,""],[19029,5,""],[19029,0,"is"],[19066,4,""],[19066,0,"thin "],[19070,1,""],[19070,0,"g you need to buy"],[19061,22,""],[19061,0,"The name"],[19061,36,""],[19061,0,"Each item on your shopping list names somewhere in your house"],[19122,6,""],[19122,0,"."],[19124,1,""],[19124,0,"Y"],[19124,1,""],[19124,0,"O"],[19215,1,""],[19219,1,""],[19215,1,""],[19215,0,"m"],[19267,15,""],[19267,0,"you"],[19269,1,""],[19268,1,""],[19267,1,""],[19266,1,""],[19271,0," for your computer)"],[19272,0,"("],[19273,17,""],[19273,0,"relatively speaking"],[19293,0," ages"],[19297,1,""],[19296,1,""],[19295,1,""],[19294,1,""],[19293,1,""],[19353,7,""],[19353,0,"thecompu"],[19360,1,""],[19359,1,""],[19358,1,""],[19357,1,""],[19356,1,""],[19356,0," computer can fetch it all in one go"],[19392,19,""],[19446,0," and this is u"],[19459,1,""],[19459,0,"it - memory fragmentation su"],[19486,1,""],[19485,1,""],[19485,0,"ruins performance in the real world."],[19415,19,""],[19427,0," are almost never used in the real world"],[19523,18,""],[19526,2,""],[19568,24,""],[19568,0," because"],[19674,78,""],[19658,0,"those "],[19525,1,""],[19524,1,""],[19524,0," "],[19714,0,"The problem with "],[19731,1,""],[19731,0,"f"],[19767,0,"is that you end up "],[19790,0,"ing"],[19871,1,""],[19896,19,""],[19896,0,"as a result your programs often end up running"],[19949,12,""],[19949,0," anyway"],[19908,0,"of all that work "],[20018,0,", and why it han"],[20033,1,""],[20033,0,"sn't gotten faster in"],[20037,17,""],[20037,0," really gotten any faster"],[20502,0," And at l"],[20510,1,""],[20510,0,"each leaf, ew "],[20523,1,""],[20522,1,""],[20521,1,""],[20521,0,"we store 32 spans of inserts (!)"],[20549,0,", a"],[20551,1,""],[20550,1,""],[20549,1,""],[20530,0,"a chunk of "],[20560,0,", all congi"],[20570,1,""],[20569,1,""],[20569,0,"tiguous in memory"],[20587,1,""],[20586,1,""],[20587,1,""],[20543,9,""],[20550,1,""],[20550,0," spans"],[20872,0,"about "],[20972,0," after"],[21208,0," "],[21208,1,""],[21208,0," also"],[21212,1,""],[21211,1,""],[21210,1,""],[21209,1,""],[21208,1,""],[20502,81,""],[21357,32,""],[21357,0,"I'm storing an inline array"],[21384,4,""],[21398,0," in each leaf node"],[21379,0,"packed "],[21423,21,""],[21445,1,""],[21449,6,""],[21449,0," result in"],[21586,0,"Its "],[21590,1,""],[21590,0,"n"],[21584,0," per word"],[21595,4,""],[21594,1,""],[21593,1,""],[21593,0,", as opposed to "],[21609,4,""],[21567,26,""],[21567,0,"a few bytes per heartbeat"],[21611,0," epic "],[21616,1,""],[21946,0," Thats 4400"],[21956,1,""],[21955,1,""],[21954,1,""],[21954,0,"500x faster than the"],[21971,3,""],[21971,0,"where we started with automerge."],[22002,1,""],[22002,0,", or about 4.3 million p"],[22025,1,""],[22025,0,"operations every second."],[22003,1,""],[22002,1,""],[22002,0,". It can process"],[22018,2,""],[22019,6,""],[22023,0,"*"],[22031,0,"*"],[22376,0,"*"],[22388,0,"*"],[22389,2,""],[22660,511,""],[25386,0,"\nBut I've done one last thing. I don't know if its a good idea, but I did it anyway because it sounded clever and I couldn't help myself. In this implementation, I split out the document's text content into a separate data structure. The reason is that when you're actually doing collaborative editing, you probably want all the characters in your document to be stored in an actual array, or in VS Code's editor or something. I don't think it makes sense to duplicate the document's content in my library too.\n\n"],[22659,0,"\nThis implementation uses a"],[22686,6,""],[22705,0," approach"],[22754,0," for the string content."],[22778,9,""],[22778,0," The complete"],[22783,8,""],[22783,0,"whole"],[22783,5,""],[22782,1,""],[22808,8,""],[22808,0," looks"],[22852,9,""],[22852,0,"{}"],[22853,0,"id, parent, ..."],[22855,0," len"],[22858,1,""],[22857,1,""],[22856,1,""],[22855,1,""],[22855,0,", length"],[22871,5,""],[22874,9,""],[22874,0,"{id, length, parent}"],[22967,0,"\n"],[22967,0,"\nAll the tet"],[22978,1,""],[22978,0,"xt content itslef"],[22994,1,""],[22993,1,""],[22992,1,""],[22992,0,"elf is pulled out into a rope library "],[23029,1,""],[23029,0,". (Smart"],[23032,5,""],[23032,0,"Ropes are smart strings)"],[23055,0,". Get it?"],[23041,6,""],[23041,0," fancy"],[23065,2,""],[23065,0,". "],[23087,0," here"],[23147,1,""],[23146,1,""],[23146,0,", work"],[23151,1,""],[23150,1,""],[23149,1,""],[23149,0,"hich works great"],[23165,15,""],[23197,0," so fast that"],[23210,12,""],[23216,0," "],[23216,1,""],[23216,0," is actually dominating"],[23211,28,""],[23211,0,"most of the algorithm's time is spent in ropey"],[23249,0,"updating things "],[23274,97,""],[23275,1,""],[23275,0,"W"],[23307,4,""],[23307,0,"ropey"],[23275,0,"Its not "],[23275,8,""],[24101,0," 11 million operations / e"],[24126,1,""],[24126,0,"second."],[24138,1,""],[24138,0,", my friends, is"],[24182,0,"\n# Conco"],[24189,1,""],[24189,0,"liution"],[24195,1,""],[24194,1,""],[24193,1,""],[24192,1,""],[24191,1,""],[24190,1,""],[24190,0,"usion\n\nI'm really g"],[24201,8,""],[24201,0,"kind of grateful for that paper now. I'"],[24239,1,""],[24238,1,""],[24237,1,""],[24237,0," I mean, you don't lik"],[24237,22,""],[24227,0,"silly academic "],[24252,0," I used to think that academics were really clever, but it turns out there'"],[24326,1,""],[24325,1,""],[24324,1,""],[24324,0,"y're just like the rest of us."],[24334,0,"as myopic and obsessive as "],[24361,8,""],[24360,1,""],[24360,0," the"],[24376,0," (I'm no"],[24383,1,""],[24382,1,""],[24381,1,""],[24380,1,""],[24379,1,""],[24378,1,""],[24378,0,"Well not me - "],[24321,71,""],[24321,0,"that"],[24308,17,""],[24308,0,"apparenyl"],[24316,1,""],[24315,1,""],[24315,0,"tly being good at writing papers is a "],[24197,156,""],[24197,0,"I'm kind of grateful for that silly academic paper now. I used to think that academics were really clever, but apparently being good at writing papers is a"],[24100,0," than automerge"],[24317,50,""],[24317,0," (and maybe I'm not that"],[24333,0,"just "],[24342,4,""],[24342,0,"smart enough)"],[24354,0,"!"],[24356,0,"."],[24354,1,""],[24355,1,""],[24355,0,"!"],[24331,23,""],[24331,0,"ll just enver be"],[24339,8,""],[24339,0,"never be that smart"],[24360,0," Now I know that "],[24212,165,""],[24212,0,"I'm kind of grateful for that silly academic paper now. I used to think that academics were really clever (and maybe I'll just never be that smart)! Now I know that"],[24361,15,""],[24361,0,"But I'm starting to realise that t"],[24394,1,""],[24394,0,"they're just a "],[24408,1,""],[24408,0,"s "],[24407,3,""],[24407,0,"like the rest of us - obsessed "],[24427,1,""],[24426,1,""],[24426,0,". They're smart in one domain, and kinf "],[24465,1,""],[24464,1,""],[24464,0,"d of"],[24468,10,""],[24468,0," terrible"],[24299,18,""],[24299,0,"must be the smartest people around"],[24381,29,""],[24388,0," reaj"],[24392,1,""],[24392,0,"lly"],[24430,5,""],[24430,0,"great at"],[24438,3,""],[24442,7,""],[24442,0," obsession"],[24420,0," mugs"],[24443,0," theri"],[24448,1,""],[24447,1,""],[24447,0,"ir"],[24454,9,""],[24454,0,"special interest area"],[24497,0," everywhere else.\n\nInventing a CRDT al"],[24534,1,""],[24533,1,""],[24526,0,"the semantics for concurrent editing is really hard "],[24566,11,""],[24565,1,""],[24564,1,""],[24563,1,""],[24563,0,"sounds"],[24563,6,""],[24544,0,"per"],[24546,1,""],[24546,0,"er-to-peer "],[24576,0,"sounds terrifying"],[24516,85,""],[24516,0,"Inventing the semantics for peer-to-peer concurrent editing sounds terrifying a CRDT"],[24424,1,""],[24423,1,""],[24422,1,""],[24421,1,""],[24420,1,""],[24444,4,""],[24535,56,""],[24535,0,"a CRDT"],[24507,0,"I wasn't smart enough "],[24528,0," to figure out the semantics for "],[24561,29,""],[24507,0,"I really wa"],[24517,1,""],[24517,0,"anted list cRD"],[24530,1,""],[24529,1,""],[24528,1,""],[24528,0,"CRDTs "],[24507,9,""],[24507,0,"We really needed a "],[24526,7,""],[24535,1,""],[24535,0," "],[24284,5,""],[24293,5,""],[24293,0," were"],[24298,3,""],[24528,0,"on Wave"],[24528,7,""],[24527,1,""],[24499,0,"Google wave, all those years ago "],[24531,1,""],[24531,0,", really wa"],[24541,1,""],[24540,1,""],[24540,0,"needed"],[24546,16,""],[24548,0," high performance"],[24575,0,". I wasn't "],[24586,61,""],[24586,0,"smart enough to invent one"],[24577,0,"I li"],[24580,1,""],[24579,1,""],[24579,0,"think pretty highly of myself, but "],[24649,0," back then. "],[24660,1,""],[24660,0," So "],[24660,0," And because the academics didn't make CRDTs fast, I assumed nobd"],[24724,1,""],[24724,0,"ody could. "],[24734,5,""],[24734,0," I might"],[24735,0,"But, "],[24739,1,""],[24738,1,""],[24738,0," "],[24746,0," not me "],[24753,1,""],[24752,1,""],[24751,1,""],[24751,0,"be clever enough to in"],[24577,37,""],[24577,0,"And "],[24616,10,""],[24580,0," back then"],[24628,0,"I assumed that"],[24642,3,""],[24651,3,""],[24650,1,""],[24661,0,"couldn't "],[24670,7,""],[24674,0," their"],[24686,0," run"],[24697,10,""],[24710,1,""],[24710,0,"\n\n"],[24710,0," That was wrong - I "],[24729,1,""],[24728,1,""],[24728,0,"my forte isn't "],[24499,244,""],[24499,0,"Google wave, all those years ago, really needed a high performance list CRDT. And back then I wasn't smart enough to invent one. I assumed that because academics couldn't make their CRDTs run fast, nobody could. That was wrong - my forte isn't"],[24392,0," mugs"],[24477,8,""],[24477,0,"middling"],[24582,5,""],[24582,0,"B"],[24594,22,""],[24594,0,"didn't manage to"],[24623,0,"When papers like LOGOOT and WOOT came out and their algorithms ran really slowly, "],[24665,3,""],[24665,0,"I was exce"],[24674,1,""],[24674,0,"ited - but"],[24719,1,""],[24719,0,"."],[24744,0,"the "],[24757,0," involved"],[24553,17,""],[24553,0," good quality"],[24577,0," Our federation model was bonkers, and it would b"],[24625,1,""],[24625,0,"have been so simple with  a"],[24651,1,""],[24650,1,""],[24650,0,"a CRDT. But"],[24663,1,""],[24663,0,"b"],[24663,1,""],[24662,1,""],[24662,0,"ba"],[24658,45,""],[24658,0,"So "],[24661,1,""],[24661,0,"w"],[24705,3,""],[24705,0,"got"],[24758,0," And "],[24762,1,""],[24777,0," mea"],[24778,3,""],[24778,0,"meant the a"],[24773,16,""],[24773,0,"the aca"],[24773,7,""],[24773,0,"that was as fast as those algorithms could ever go, "],[24824,1,""],[24832,4,""],[24832,0," if"],[24845,0,"th"],[24846,1,""],[24845,1,""],[24836,0,"the "],[24849,9,""],[24899,1,""],[24899,0,"\n\n"],[24582,0,"wave "],[24582,0,"["],[24604,0,"]https://web.archive.org/web/20130330144116/http://www.waveprotocol.org/federation"],[24605,81,""],[24605,0,"(https://web.archive.org/web/20130330144116/http://www.waveprotocol.org/federation)"],[24604,84,""],[24582,1,""],[24616,0," "],[24616,1,""],[24616,0," and really buggy."],[24634,6,""],[24634,0," I"],[24621,6,""],[24621,0,"it never worked properly"],[24645,6,""],[24774,7,""],[24774,0," so "],[24777,8,""],[24777,0," slow they were unworkable"],[24647,21,""],[24647,0,"The whole thing would have been so much"],[24693,0,"r"],[24701,0," good"],[24713,4,""],[24713,0,"W"],[24578,135,""],[24578,0,"So "],[24581,1,""],[24581,0,"w"],[24578,19,""],[24578,0,"I got excited when"],[24621,16,""],[24597,0,"papers describing "],[24639,0,". But that excitemtn "],[24659,1,""],[24658,1,""],[24657,1,""],[24656,1,""],[24655,1,""],[24655,0,"ment "],[24650,10,""],[24650,0,"excitement turned to dust when I realised how slow and inefficient their algoirth"],[24723,8,""],[24723,0,"algi"],[24726,1,""],[24726,0,"orithms were"],[24738,21,""],[24738,0,". They"],[24777,1,""],[24777,0," - and"],[24783,74,""],[24821,9,""],[24820,1,""],[24819,1,""],[24818,1,""],[24818,0,"m "],[24819,1,""],[24855,0,"."],[24856,17,""],[24856,0," My gift to the world"],[24857,0,"Par t"],[24861,1,""],[24860,1,""],[24860,0,"t of "],[24865,1,""],[24865,0,"m"],[24857,9,""],[24857,0,"M"],[24877,0," isn't"],[24878,5,""],[24878,0,"might not be CRDT"],[24891,0,"inventing new classes of "],[24920,0,". But I do know how to make code run fast. And I was letting down the academics in turn b "],[25009,1,""],[25009,0,"y not showing up and doing my part.\n\n"],[24857,20,""],[24857,0,"I might have no idea how to "],[24885,14,""],[24893,1,""],[24892,1,""],[24891,1,""],[24891,15,""],[24896,0,"s"],[24933,0," really"],[24947,4,""],[24966,21,""],[24966,0,"everyone"],[24966,8,""],[24965,1,""],[24953,0,"quietly "],[24968,0," everyone"],[25018,1,""],[25018,0," in "],[25021,1,""],[25020,1,""],[25019,1,""],[25018,1,""],[25018,0," to m"],[25022,1,""],[25021,1,""],[25020,1,""],[25019,1,""],[25018,1,""],[25018,0," here."],[24222,1,""],[24221,1,""],[24220,1,""],[24219,1,""],[24218,1,""],[24217,1,""],[24216,1,""],[24216,0,"a little bit"],[24582,0," so"],[24584,1,""],[24583,1,""],[24583,0,"So"],[24605,0,"the "],[24615,11,""],[24615,0," for"],[24771,0," just"],[24793,0," I figured"],[24861,4,""],[24861,0,"But I"],[24886,19,""],[24886,0,"not be any good at"],[24911,0,"ing"],[24920,1,""],[24920,0,","],[24922,1,""],[24922,0,"b"],[24956,7,""],[24928,3,""],[24959,0," But I didn't even try to help out"],[24990,0,"those al"],[24997,1,""],[24997,0,"cademics "],[25009,0," and improve "],[25014,8,""],[25014,0,"fix up their algorithms."],[24978,0,"*"],[24982,0,"*"],[24982,1,""],[24978,1,""],[24966,0,"*"],[24982,0,"*"],[25029,10,""],[25029,0,"implementations"],[24520,22,""],[24509,0,"A decade ago "],[24533,7,""],[24566,3,""],[24566,0," So"],[24575,0," really"],[24610,0," the"],[24630,0," CRDTs"],[24773,4,""],[24773,0,"totally"],[24791,0," outside of the lab"],[24882,0," So I "],[24887,1,""],[24886,1,""],[24885,1,""],[24884,1,""],[24884,0,"o I ign'red them"],[24883,17,""],[24883,0,"And I ignored them."],[24970,0," do"],[24999,0," really"],[25061,20,""],[25061,0,"make good"],[25087,0," They were t"],[25098,1,""],[25098,0,"doing their part in this bi"],[25123,2,""],[25123,0,"dance, and I wasn't doing mine"],[25000,6,""],[25000,0,"stupidly"],[25000,8,""],[25000,0,"really"],[25016,0," here, in my own field,"],[25038,1,""],[25087,0," their"],[25093,5,""],[25109,0," work well"],[25186,0,"."],[25187,78,""],[25189,0,"I "],[25190,1,""],[25189,1,""],[25189,0,"I"],[25189,1,""],[25189,0,"I think the idea that everyone has some hiddne"],[25234,1,""],[25233,1,""],[25233,0,"en te"],[25237,1,""],[25237,0,"alent is tosh"],[25246,0,"a bit of "],[25246,9,""],[25250,0,". But I do think we all "],[25189,85,""],[25189,0,"I think the idea that everyone has some hidden talent is tosh. But I do think we all"],[24970,0," am prety"],[24978,1,""],[24978,0,"ty good at"],[24988,15,""],[24992,1,""],[24992,0,"ing"],[25004,7,""],[25011,3,""],[25011,0,"And"],[25036,0,","],[25036,1,""],[25036,0,","],[25082,10,""],[25082,0,"improve their"],[25111,10,""],[25265,0," have different proclivities and interests. We all have different songs to sing"],[25309,35,""],[25309,0,"Each of us a"],[25320,1,""],[25320,0,"has a song to sing over the city. A"],[25354,1,""],[25353,1,""],[25179,0," They figured out the semnatics"],[25201,9,""],[25201,0,"semantics, nut t"],[25216,1,""],[25215,1,""],[25214,1,""],[25213,1,""],[25212,1,""],[25212,0,"bnut t"],[25217,1,""],[25216,1,""],[25215,1,""],[25214,1,""],[25213,1,""],[25213,0,"ut the "],[25219,1,""],[25219,0,"y "],[24904,317,""],[24904,0,"But I was wrong. I might not be any good at inventing CRDTs, but I am pretty good at making code run fast. And here, in my own field, I *didn't even try* to help those academics improve their implementations. They were doing their part in this dance, and I wasn't doing mine. They figured out the semantics, but they"],[24615,0,"["],[24622,0,"](https://hal.inria.fr/inria-00432368/document)"],[24674,0,"["],[24679,0,"](https://hal.inria.fr/inria-00445975/document)"],[24741,0," 12 years ago"],[24996,0,"so "],[25177,46,""],[25213,0," strage"],[25219,1,""],[25218,1,""],[25217,1,""],[25216,1,""],[25216,0,"range"],[24507,0," (Is that a masis"],[24523,1,""],[24522,1,""],[24522,0,"sive"],[22655,3,""],[22655,0,"###"],[22657,1,""],[22657,0," Struct of arrays vs Array of structs"],[22695,0,"\n"],[22695,0,"\nI'm doing a slight of hand here - t"],[22730,1,""],[22729,1,""],[22728,1,""],[22727,1,""],[22727,0,". This implme"],[22739,1,""],[22738,1,""],[22738,0,"ementation isn't"],[22749,5,""],[22749,0,"has another small change - and I'm not sure ifI like"],[22793,8,""],[22793,0,"if I like it.\n\nIn javascript we have this:\n\n```\n{ item: 'hello', isDeleted: false, id: ['seph', 0], seq, parent: null },"],[22841,0,"doc = "],[22840,0,"javascript"],[22854,0,"."],[22854,1,""],[22857,0,"\n"],[22851,6,""],[22851,0,"doc ="],[22857,0,"["],[22857,1,""],[22856,1,""],[22856,0,"{"],[22856,1,""],[22856,0," {\n  content: [\n    "],[22872,0,"    { item: 'hello', isDeleted: false, id: ['seph', 0], seq, parent: null },\n"],[22962,5,""],[22962,0,"world"],[22981,5,""],[22981,0,"true"],[22993,4,""],[22993,0,"mike"],[23017,4,""],[23017,0,"['seph', 0]"],[23031,0,"\n    ...\n    "],[23040,4,""],[23040,0,"  ]\n  "],[23044,2,""],[23044,0,"}\n```\n\nIn rust I'm doing this:"],[22851,20,""],[22851,0,"doc = { content: ["],[22947,4,""],[22947,0,"  "],[22870,4,""],[22870,0,"  "],[23034,5,""],[23034,0,"] }"],[23035,1,""],[23060,0,"the equivalent of "],[23084,0,"\n"],[23084,0,"\n\n```javascript\ndoc = { content: [\n  { item: 'hello', isDeleted: false, id: ['seph', 0], seq, parent: null },\n  { item: 'world', isDeleted: true, id: ['mike', 0], seq, parent: ['seph', 0] },\n    ...\n]}\n```"],[23084,1,""],[23122,13,""],[23122,0,"length: 5"],[23133,18,""],[23175,13,""],[23175,0,"length: -5"],[23187,17,""],[23117,0,"\n  // No string content!"],[23106,1,""],[23106,0,"\n  "],[23258,4,""],[23258,0,"      "],[23197,2,""],[23197,0,"    "],[23144,2,""],[23144,0,"    "],[23120,2,""],[23120,0,"    "],[23264,6,""],[23264,0,"    "],[23271,1,""],[23271,0,"\n    "],[23272,4,""],[23272,0,"  "],[23275,0,"\n  "],[23276,2,""],[23275,0,",\n  \n  "],[23277,2,""],[23280,0,"textContent: 'hello' // Actually in a rope"],[23318,4,""],[23318,0,"Rope, not a string."],[23318,1,""],[23318,0,"r"],[23059,18,""],[23059,0," something l"],[23070,1,""],[23070,0,"more like"],[23108,0,"\n  clients: ['seph', 'mmi"],[23132,1,""],[23131,1,""],[23131,0,"ike'],\n  "],[23138,2,""],[23282,6,""],[23282,0,"0"],[23200,6,""],[23200,0,"0"],[23251,6,""],[23251,0,"1"],[23220,4,""],[23220,0,"[-1, -"],[23225,1,""],[23224,1,""],[23223,1,""],[23223,0,", 0]"],[23225,1,""],[23224,1,""],[23223,1,""],[23223,0,", -1"],[23231,0," // root "],[23232,8,""],[23231,1,""],[23141,7,""],[23141,0,"items"],[23148,0,"RangeTree "],[23322,0,"Rope "],[23334,37,""],[23326,0,"y Rope {"],[23342,0," }"],[23327,1,""],[23148,9,""],[23148,0,"BTree"],[23148,5,""],[23148,0,"RangeTree"],[23158,0,"{"],[23305,0,"}"],[23229,8,""],[23229,0,"NULL"],[23232,1,""],[23231,1,""],[23230,1,""],[23229,1,""],[23229,0,"null"],[23229,4,""],[23229,0,"ROOT"],[23341,0,"\n"],[23304,1,""],[23340,0,"\n  ]},"],[23298,6,""],[23334,0,"\n    ..."],[23290,8,""],[23326,0,"\n    { length: -5, id: [1, 0], seq, parent: [0, 0] },"],[23237,53,""],[23273,0,"\n    { length: 5, id: [0, 0], seq, parent: ROOT },"],[23187,50,""],[23223,0,"\n    // No string content!"],[23187,2,""],[23187,0,"    "],[23161,26,""],[23199,0,"\n  items: RangeTree {["],[23139,22,""],[23177,0,"\n"],[23138,5,""],[23138,0,"  "],[23174,0,","],[23137,0,"\n  "],[23138,2,""],[23137,1,""],[23175,0,"\n  clients: ['seph', 'mike'],"],[23109,29,""],[23146,0,"\n  "],[23147,2,""],[23342,1,""],[23349,0,"\n"],[23350,308,""],[23349,1,""],[23349,0,"\n"],[23349,0,"\nThere's a few tweaks here, but "],[23350,31,""],[23349,1,""],[23349,0,"\nNotice the tet"],[23363,1,""],[23363,0,"xt"],[23350,0,"There's a bunch of small tweaks here, but "],[23393,0,"t"],[23393,1,""],[23392,1,""],[23392,0,"n"],[23407,0," content? Its "],[23420,1,""],[23419,1,""],[23418,1,""],[23418,0," pulled it out into its own structure. The been"],[23464,1,""],[23463,1,""],[23463,0,"nefit "],[23457,12,""],[23457,0,"This is a tradeoff:\n\n- "],[23478,2,""],[23478,0,"-"],[23457,10,""],[23457,0,"Welom"],[23461,1,""],[23460,1,""],[23460,0,"come to "],[23438,7,""],[23438,0,"a separate data"],[23484,0," "],[23476,0,"the land of "],[23496,0,"s"],[23497,1,""],[23488,0,"Engineering "],[23500,1,""],[23500,0,"T"],[23480,1,""],[23480,0,"L"],[23650,43,""],[23650,0,"[Ropey](https://docs.rs/ropey/1.2.0/ropey/)"],[23463,0,"( "],[23464,1,""],[23464,0," "],[23464,1,""],[23463,1,""],[23463,0," ([Ropey](https://docs.rs/ropey/1.2.0/ropey/)"],[23465,0,"U"],[23465,1,""],[23465,0,"using a list"],[23476,1,""],[23475,1,""],[23474,1,""],[23473,1,""],[23472,1,""],[23472,0," rust library calle d"],[23492,1,""],[23491,1,""],[23491,0,"d "],[23536,0,")"],[23536,0,", which i "],[23545,1,""],[23545,0,"s *"],[23547,1,""],[23546,1,""],[23545,1,""],[23544,1,""],[23544,0,"implements *another* b-tree!"],[23623,0," Havin "],[23629,1,""],[23629,0,"g the texxt conte"],[23638,1,""],[23645,0,"nt self contained like this means the "],[23679,4,""],[23679,0,"ropey can do text-specific optimizations"],[23673,0,"allows "],[23680,6,""],[23685,0," to"],[23688,4,""],[23719,0,", like packing all the chara"],[23719,28,""],[23719,0,". So we use less ram.\n- "],[23741,2,""],[23741,0,"-"],[23721,19,""],[23721,0,"The biggest advantage is we use a lot less ram this way."],[23597,0," Uncomfortable"],[23793,0," But inserting into both"],[23798,19,""],[23798,0,"ei"],[23799,1,""],[23798,1,""],[23798,0,"with ech"],[23805,1,""],[23804,1,""],[23804,0,"ach insert we'"],[23817,1,""],[23817,0," need to update 2 data structures. Rop"],[23854,1,""],[23853,1,""],[23852,1,""],[23851,1,""],[23850,1,""],[23850,0," instead of 1, which makes everything more than"],[23871,0,"in this case "],[23910,0," "],[23910,1,""],[23910,0," twice as slow as it could be"],[23861,0," just"],[23875,13,""],[23892,19,""],[23897,0,"er"],[23899,15,""],[23899,0,"\n- "],[23900,2,""],[23900,0,"-"],[23399,3,""],[23399,0,"what I did with the"],[23431,1,""],[23431,0," here."],[23485,1,""],[23484,1,""],[23484,0,", "],[23557,1,""],[23557,0,". Ropey implements"],[23575,17,""],[23594,1,""],[23593,1,""],[23591,0," t"],[23592,1,""],[23591,1,""],[23592,0," "],[23592,1,""],[23592,0," to efficiently manage text inserts"],[23627,1,""],[23627,0,". This isn't a net win."],[23651,10,""],[23651,0,"We have unfortunately arrived at"],[23386,5,""],[23386,0,". But"],[23399,0,"in particular "],[23388,44,""],[23350,38,""],[23350,0,"One big "],[23357,1,""],[23070,10,""],[23070,0,"closer to "],[23350,26,""],[23350,0,"One "],[23353,1,""],[23352,1,""],[23351,1,""],[23350,1,""],[23350,0,"Note"],[23364,2,""],[23364,0,"the text"],[22766,0,", important"],[23361,5,""],[23361,0,"To "],[23363,1,""],[23362,1,""],[23361,1,""],[23379,0,"content "],[23712,10,""],[23792,6,""],[23918,0,"."],[23921,0," And the b"],[23926,5,""],[23926,0,"it doubles the compiled"],[23941,0,"size of the "],[23961,0," binary - with wasm "],[23968,7,""],[23968,0,", which matters on the web. The"],[24005,0,"bundle goes from 60kb to 120kb."],[24012,4,""],[24012,0,"increases"],[24040,1,""],[24040,0," when we depend on Ropey."],[23968,26,""],[24039,0,"\n- But it makes it way a"],[24062,1,""],[24062,0,"faster to read off "],[24042,5,""],[24042,0,"I"],[24044,0," also"],[24040,42,""],[24040,0,"- It also makes it way faster to read off"],[22818,234,""],[28308,0,"\nIn javascript we have this:\n\n```javascript\ndoc = { content: [\n  { item: 'hello', isDeleted: false, id: ['seph', 0], seq, parent: null },\n  { item: 'world', isDeleted: true, id: ['mike', 0], seq, parent: ['seph', 0] },\n    ...\n]}\n```\n"],[22847,9,""],[22847,0,"like "],[22851,1,""],[23122,12,""],[23122,0,"Notice te"],[23130,1,""],[23130,0,"he document's"],[23156,0," is "],[23159,1,""],[23158,1,""],[23157,1,""],[23157,0,"has been pulled"],[23207,0,". I'm"],[23212,1,""],[23212,0," "],[23212,1,""],[23463,47,""],[23463,0,"C"],[23463,1,""],[23463,0,"R"],[23468,0," can"],[23508,26,""],[23508,0,"W"],[23514,0," much"],[23515,4,""],[23514,1,""],[23539,10,""],[23539,0," when "],[23544,1,""],[23551,0,"ing"],[23601,5,""],[23603,1,""],[23603,0,". This"],[23609,6,""],[23637,6,""],[23637,0,"Depending on ropey"],[23676,3,""],[23676,0,"our"],[23741,25,""],[23741,0," - which is"],[23741,11,""],[23744,0,"Ropey "],[23750,8,""],[23781,0," the document's"],[23742,54,""],[23741,1,""],[24535,0,"| *JS baseline*                     | 0.61s      | 0.1 MB    | *(none)*       |\n"],[24618,2,""],[24618,0,"Ropey (rust)"],[24640,10,""],[24655,2,""],[24655,0,"029"],[24660,1,""],[24694,80,""],[24615,0,"| Rust (Called from JS via WASM)    | 0.20s      | ???       | B-Tree         |\n"],[24774,80,""],[24695,0,"| Rust (native)                     | 0.065s     | 2.3 MB    | B-Tree         |\n"],[24828,1,""],[24828,0,"2"],[22675,2,""],[22675,0,"or"],[22694,0,"?"],[23742,0,"."],[23742,1,""],[23744,217,""],[23747,6,""],[23747,0,"CRDT implementation "],[23766,1,""],[23777,0," at this point"],[23902,3,""],[23902,0," and"],[23742,0,"\n- Sometimes we "],[23743,15,""],[23742,1,""],[23742,0,"\n\nI'm still not sure "],[23744,19,""],[23744,0,"I'm still not sure if I like this change."],[23763,22,""],[23763,0,"whether I like this approach."],[23635,0," It also"],[23643,62,""],[23643,0," increases the size of the"],[23670,4,""],[23682,10,""],[23700,0,"."],[23644,9,""],[23644,0,"doubles"],[23537,5,""],[23537,0,"W"],[23695,0,"\n- We sometimes don't need the text content at all - like when"],[23698,59,""],[23698,0,"Most applications"],[23698,17,""],[23698,0,"There's a bunch of use cases where don"],[23735,1,""],[23734,1,""],[23733,1,""],[23733,0,"we don't "],[23696,46,""],[23696,0,"- There's a bunch of use cases where we don't"],[23157,0," doesn't live in the items"],[23178,5,""],[23178,0,"list of items anymore. Now its"],[23208,25,""],[23208,0," in "],[23211,1,""],[23263,0," for this"],[23359,0,"which ca"],[23366,1,""],[23365,1,""],[23364,1,""],[23363,1,""],[23362,1,""],[23361,1,""],[23360,1,""],[23359,1,""],[23358,1,""],[23358,0," "],[23288,34,""],[23288,0,"https://crates.io/crates/ropey"],[23358,12,""],[23339,0,"et "],[23341,1,""],[23340,1,""],[23339,1,""],[23339,0,"yet "],[23339,4,""],[23357,0," efficiently"],[23376,0," the document's"],[23396,8,""],[23396,0," content"],[23583,0," (Ropey only uses 200kb for the "],[23607,8,""],[23607,0,"to store the whole document - its way more efficient than"],[23645,19,""],[23645,0,"tighter than my code!)"],[23641,0,"apparently "],[23583,95,""],[23543,13,""],[23543,0,"packing"],[23543,0,"byte "],[23600,0,"like this "],[23764,10,""],[23764,0,"some"],[23793,0," care about the document's contents."],[23828,0," anyway"],[23753,83,""],[23805,0,"But "],[23809,1,""],[23809,0,"m"],[23967,0,"?"],[23968,12,""],[23968,0," How"],[23978,0,"can "],[24659,1,""],[24659,0,"R"],[24659,1,""],[24659,0,"r"],[24072,4,""],[24072,0,"CRDT"],[24925,0,"\n("],[24926,1,""],[24926,0,"(Why is it slower"],[24931,12,""],[24931,0,"d"],[24931,1,""],[24931,0,"is it slower"],[24937,6,""],[24937,0,"faster to "],[24931,16,""],[24931,0,"don't "],[24927,10,""],[24927,0,"Weird - 29ms + 23ms ! "],[24948,1,""],[24948,0,"= 65ms. I wonder if its "],[24971,1,""],[24971,0," "],[24956,16,""],[24956,0,"We're "],[24926,1,""],[24926,0,"Oh look"],[24933,5,""],[24926,37,""],[24926,0,"Oh look - 29ms + 23ms != 65ms. We're"],[24906,17,""],[24906,0," make the computer do less work"],[24938,0,"\n\nAnd just to "],[24940,12,""],[24939,1,""],[24938,1,""],[24976,0," probably fill"],[24971,19,""],[24971,0,"I "],[24971,2,""],[24971,0,"I'm probably thrashing the cPU c"],[25002,1,""],[25001,1,""],[25000,1,""],[24999,1,""],[24998,1,""],[24998,0,"CPU's cache inserting one character at a time"],[25010,0,"by processing "],[25024,10,""],[25027,10,""],[25027,0," edit"],[24970,72,""],[24970,0," It look"],[24971,7,""],[24971,0,"I can "],[24973,4,""],[24973,0,"smell more"],[24979,4,""],[24979,0,"faster performance "],[24979,19,""],[24979,0,"opppo"],[24983,1,""],[24982,1,""],[24982,0,"ortunities for even more performance."],[24979,27,""],[24979,0,"a batch_update() methods "],[25003,1,""],[25002,1,""],[25002,0," with faster"],[24971,9,""],[24971,0,"It looks like a"],[25009,4,""],[25009,0,"would have even"],[24971,16,""],[24971,0,"I smell a *"],[24996,0,"*"],[25004,0," in my future"],[25017,35,""],[25017,0," with *another* 20"],[25018,17,""],[25018,0,"which can process this trace in 52ms"],[25055,0,"\n"],[25046,0,", rope and all,"],[25272,5,""],[25292,1,""],[25292,0," -"],[25295,8,""],[25317,0,"ty"],[25319,14,""],[25358,19,""],[25380,1,""],[25380,0,"W"],[25385,6,""],[25385,0,"really needed"],[25425,3,""],[25431,6,""],[25431,0,"super"],[25465,0,"CRDTs started to emerge."],[25489,3,""],[25601,0," werea "],[25607,1,""],[25606,1,""],[25606,0," a big deal - and they're"],[25631,15,""],[25644,0," no1"],[25647,1,""],[25647,0,"w!"],[25649,1,""],[25617,31,""],[25602,4,""],[25602,0,"seemd"],[25606,1,""],[25606,0,"ed like"],[25741,0,"ly"],[25773,18,""],[25754,19,""],[25754,0,"pretty uni"],[25763,1,""],[25763,0,"usable for real world editing"],[25793,1,""],[25792,1,""],[25792,0,","],[25792,1,""],[25792,0,". "],[25795,1,""],[25794,1,""],[25794,0,"A"],[25799,0," made a "],[25800,7,""],[25799,1,""],[25799,0," made a big mistake - I"],[25823,7,""],[25823,0,"assumed"],[25887,5,""],[25887,0,"S"],[25924,48,""],[24970,0," The reason"],[24947,0," at those last three rows"],[24988,1,""],[24987,1,""],[24987,0,"is less than"],[24978,1,""],[24977,1,""],[24983,1,""],[24982,1,""],[24999,1,""],[24998,1,""],[24983,12,""],[24983,0,"<"],[24973,1,""],[24972,1,""],[24972,0,"!"],[24987,0," We're probably seeing t"],[24988,23,""],[24988,0,"There's "],[24988,8,""],[24988,0,"I'm probably thrashing the CPU cache."],[25024,0," w"],[25025,1,""],[25025,0,"by bouncing between thoses "],[25045,7,""],[25045,0,"these two B-trees"],[25064,11,""],[25158,0,"just "],[25158,4,""],[25157,1,""],[25045,5,""],[25045,0,"the"],[25059,1,""],[25059,0," i"],[25060,1,""],[25059,1,""],[25059,0,"s"],[25059,1,""],[25059,0," "],[25059,1,""],[25059,0,"s"],[26015,0,"It turns out "],[26029,0,"'m"],[26031,3,""],[26015,0,"I'm "],[26018,1,""],[26017,1,""],[26016,1,""],[26016,0," don't know who"],[26030,1,""],[26029,1,""],[26028,1,""],[26028,0,"'"],[26016,0,"'"],[26017,12,""],[26017,0,"m terib"],[26023,1,""],[26022,1,""],[26022,0,"rible at academic papers, but "],[26053,1,""],[26052,1,""],[26052,0,"i"],[26151,1,""],[26159,0,"*"],[26155,0,"use my skills and "],[26183,1,""],[26183,0," researchers"],[26239,0," of inventing CRDT semantics. But"],[26272,5,""],[26293,41,""],[26293,0," Oops!"],[26294,0,"And I "],[26299,1,""],[26298,1,""],[26298,0,"if I did, we could have f"],[26322,1,""],[26322,0,"had fast, workable CD"],[26342,1,""],[26342,0,"RDTs a decade ago. "],[26311,0,"might"],[26316,5,""],[26341,0,"te"],[26342,1,""],[26341,1,""],[26346,0," for text editing"],[26385,0,"For the record, "],[26513,14,""],[26467,11,""],[26470,4,""],[26470,0," do all"],[26506,0," We "],[26506,4,""],[26506,0," Different dharmas. "],[26525,1,""],[26541,1,""],[26541,0,"our own gift for the world"],[26567,27,""],[26567,0,", if we can find it"],[26587,0,"\n\nInstead of being frustrated at that paper, I shoud"],[26638,1,""],[26638,0,"ld n"],[26641,1,""],[26641,0,"have"],[26632,13,""],[26631,1,""],[26630,1,""],[26589,32,""],[26589,0,"T"],[26599,0," was a call to adventure "],[26623,1,""],[26623,0,". That was the world saying \"Your skills are rare\""],[26625,10,""],[26625,0,"T"],[26641,0," was sayinh"],[26651,1,""],[26651,0,"g"],[26670,4,""],[26670,0,"valuable. W"],[26680,1,""],[26679,1,""],[26678,1,""],[26678,0," an"],[26670,11,""],[26670,0,"needed here."],[26579,7,""],[26579,0,"figure out th"],[26591,1,""],[26590,1,""],[26590,0,"what that is"],[26605,4,""],[26605,0,"In this spirit,"],[26605,15,""],[26605,0,"That"],[26620,0,"really "],[26648,0,"It was "],[26655,3,""],[26654,1,""],[26654,0," the"],[26684,0,"He "],[26686,1,""],[26686,0,"y seph, "],[26688,1,""],[26688,0,"S"],[26694,27,""],[26694,0,"We "],[26696,1,""],[26695,1,""],[26694,1,""],[26694,0,"we need your help over here. You're holding a piece of the puzzle"],[26749,3,""],[26749,0,"this"],[26762,0," In my ou"],[26770,1,""],[26769,1,""],[26769,0,"youthn"],[26774,1,""],[26774,0,"ful "],[26726,3,""],[26726,0,"r skils"],[26732,1,""],[26732,0,"ls are"],[26738,8,""],[26761,0,", and we can't get it owrking"],[26783,7,""],[26783,0,"wi"],[26784,1,""],[26784,0,"orking without you"],[26820,0,"arrogance I "],[26605,227,""],[26605,0,"That paper was really a call to adventure. It was the world saying was saying \"Hey Seph, we need your help over here. Your skills are a piece of this puzzle, and we can't get it working without you.\" In my youthful arrogance I"],[26017,1,""],[26016,1,""],[26016,0," might be"],[26260,0,"P2P collaborative editing"],[26285,14,""],[26312,5,""],[26312,0,"I"],[26662,10,""],[26662,0,"The"],[26671,0," came knocking at my door"],[26703,11,""],[26705,4,""],[26778,5,""],[26779,1,""],[26778,1,""],[26778,0,". W"],[26788,4,""],[26788,0," "],[26789,3,""],[26789,0,"this"],[26842,0," turned away. "],[26855,1,""],[26854,1,""],[26854,0,". I di"],[26859,1,""],[26858,1,""],[26857,1,""],[26856,1,""],[26855,1,""],[26855,0," I didn't enter the dragon's cave, and didn't "],[26894,7,""],[26894,0,"it took me another decades"],[26919,1,""],[26919,0," to find the treat"],[26936,1,""],[26936,0,"sure inside.\n\nBut we've found it now. P2P"],[26974,3,""],[26974,0,"Realtime collaborative editing"],[26974,0,"Decentralized "],[26988,1,""],[26988,0,"r"],[27018,0,"? We're coming for you.\n\n\n"],[27044,45,""],[27044,0,"# Appending X"],[27056,1,""],[27056,0,"A: "],[27058,1,""],[27058,0," Lying with benchmarks\n\nI've odne a"],[27087,6,""],[27087,0,"done a few lgi"],[27100,1,""],[27099,1,""],[27098,1,""],[27098,0,"gliths "],[27098,7,""],[27098,0,"slights of hands"],[27082,11,""],[27082,0,"There are a"],[27113,1,""],[27113,0," above that I want to admit, justi"],[27142,5,""],[27142,0,"efe"],[27142,3,""],[27141,1,""],[27140,1,""],[27140,0," and defend"],[27135,6,""],[27135,0,"f"],[27135,1,""],[27135,0,"confe"],[27139,1,""],[27138,1,""],[27137,1,""],[27136,1,""],[27135,1,""],[27135,0,"'fess up to "],[27157,0,".\n\n1. I'"],[27164,1,""],[27163,1,""],[27163,0,"I've written this post b"],[27163,24,""],[27163,0,"I've played fast and loose with two CRDT algoir"],[27204,6,""],[27204,0,"semantics"],[27190,0,"directly comparing implementations which use "],[27235,4,""],[27234,1,""],[27239,0,"different "],[27263,0,": Y"],[27265,1,""],[27265,0,"RGA (automerge) and YARTA"],[27289,1,""],[27288,1,""],[27287,1,""],[27287,0,"TA (yjs + my rust code). This i"],[27317,1,""],[27316,1,""],[27315,1,""],[27314,1,""],[27313,1,""],[27312,1,""],[27312,0,"My claim "],[27312,9,""],[27312,0,"I'm making a "],[27324,1,""],[27324,0,"n assumption"],[27189,0," with numbers,"],[27319,4,""],[27319,0,"implementation"],[27347,3,""],[27347,0,"the "],[27361,0," that both algorithms are "],[27372,15,""],[27367,5,""],[27367,0,"the implementation speed is identical - because in my reference CRDT implementation "],[27450,1,""],[27450,0,", it is. A"],[27459,1,""],[27421,0,"["],[27436,0,"]"],[27436,1,""],[27451,0,"](https://github.com/josephg/reference-crdts)"],[27505,0,"With a "],[27511,1,""],[27510,1,""],[27510,0,"this editing trace, "],[27164,84,""],[27164,0,"'ve written th"],[27163,44,""],[27163,0,"I'm comp"],[27170,1,""],[27169,1,""],[27168,1,""],[27167,1,""],[27167,0,"directly comparing the performance of implementations im"],[27222,1,""],[27221,1,""],[27221,0,"of"],[27223,1,""],[27163,0,"Through this post "],[27297,0," interchangably"],[27308,0,"e"],[27314,0," This only makes sense if"],[27339,69,""],[27339,0," the algorithms are intern"],[27364,1,""],[27364,0,"changable"],[27369,0,"e"],[27315,59,""],[27315,0,"This rests on the assumption that both algorithms run just as fast as each other"],[27398,13,""],[27397,1,""],[27396,1,""],[27395,1,""],[27395,0,"."],[27314,0," YATA "],[27315,5,""],[27315,0,"When there are no concurrent edits, all CRDT"],[27355,0,"list "],[27364,0,"s "],[27315,51,""],[27314,1,""],[27329,3,""],[27329,0,"a"],[27329,1,""],[27329,0,"the"],[27354,10,""],[27354,0,"semantics "],[27349,5,""],[27349,0,"the "],[27362,0," are interchangable"],[27377,0,"e"],[27382,32,""],[27382,0,", and the performance"],[27388,15,""],[27388,0,"if you swap semantics, the perfomra"],[27422,1,""],[27421,1,""],[27420,1,""],[27420,0,"rmance won't change."],[27439,1,""],[27441,0,"I've demonstrated this interchangability in my "],[27464,18,""],[27464,0,"property "],[27441,0,"This is actually a bold l"],[27465,1,""],[27465,0,"claim - which "],[27497,14,""],[27578,34,""],[27578,0,". And "],[27580,4,""],[27580,0,"You "],[27580,4,""],[27580,0,"I believe you could use the same approach to modify yjs to impement"],[27639,8,""],[27639,0,"implement RGA semantics - you'd just have to change"],[27581,0,"'m convinced"],[27593,8,""],[27694,0," yjs's *integrate* method, and store *ma"],[27733,1,""],[27732,1,""],[27732,0,"se"],[27721,4,""],[27730,0,"q* isntead of"],[27733,10,""],[27733,0,"instead of *originRight* in *Item* and store *maxSeq*"],[27777,0," and update"],[27797,0," in the document. This "],[27815,5,""],[27815,0,"The"],[27580,15,""],[27580,0,"Y"],[27652,0," if you wanted"],[27667,1,""],[27666,1,""],[27666,0,"."],[27668,1,""],[27668,0,"Y"],[27666,0," to"],[27762,0," each"],[27774,0,","],[27775,4,""],[27817,0," and h"],[27822,1,""],[27822,0,"change the binary encoding format"],[27857,3,""],[27857,0,"I talked to Kevin about this and he doesn't see t"],[27905,1,""],[27905,0,"any point."],[27889,1,""],[27889,0,", while cool, "],[27927,0," in "],[27930,1,""],[27929,1,""],[27928,1,""],[27927,1,""],[27918,4,""],[27918,0,"the "],[27927,0," of making"],[27931,6,""],[27931,0,"addin"],[27931,5,""],[27931,0,"making yjs compatible"],[27927,25,""],[27918,4,""],[27918,0,"any "],[27387,0,"t aht"],[27391,1,""],[27390,1,""],[27389,1,""],[27388,1,""],[27387,1,""],[27387,0," that"],[27444,0," (at least for single user editing traces)"],[27506,0," kin"],[27509,1,""],[27508,1,""],[27507,1,""],[27506,1,""],[27506,5,""],[27506,0," noven"],[27511,1,""],[27510,1,""],[27509,1,""],[27509,0,"vel"],[27518,0,"."],[27520,8,""],[27537,0," that this is true"],[27637,0,", which has identical performance for yjs and automerge"],[27671,0,"when using "],[27682,3,""],[27681,1,""],[27686,3,""],[27686,0,"or"],[27698,0," a"],[27699,1,""],[27699,0,"semantics"],[27710,0,"And I think "],[27722,1,""],[27722,0,"y"],[27716,7,""],[27715,1,""],[27715,0,"'m confident y"],[27159,0,"\n\n"],[27160,0,"### Yjs ==="],[27164,7,""],[27164,0,"Are these CRDTs actull"],[27185,1,""],[27184,1,""],[27184,0,"ally the same?"],[27202,1,""],[27201,1,""],[27200,1,""],[27351,1,""],[27350,1,""],[27350,0,".\n\n"],[27404,16,""],[27404,0," bascai"],[27410,1,""],[27409,1,""],[27409,0,"i"],[27409,1,""],[27408,1,""],[27408,0,"ically the same"],[27547,0," big bold"],[27548,8,""],[27547,1,""],[27559,0,","],[27559,2,""],[27559,0,"!"],[27537,16,""],[27537,0,"a new"],[27542,6,""],[27542,0," idea tha"],[27550,1,""],[27549,1,""],[27548,1,""],[27547,1,""],[27547,0," and I think I "],[27548,14,""],[27548,0,"that I think I "],[27539,24,""],[27539,0,"novel idea that nobody "],[27555,0,"I think "],[27570,0,"has discovered before"],[27591,1,""],[27591,0,"."],[27592,1,""],[27592,0,"\n\n"],[27611,5,""],[27616,8,""],[27616,0,"proper"],[27621,1,""],[27620,1,""],[27619,1,""],[27618,1,""],[27617,1,""],[27616,1,""],[27616,0," property"],[27751,0," either"],[27775,0,"'s"],[27904,4,""],[27903,1,""],[27911,0,":\n\n-"],[27916,1,""],[27916,0,"C"],[27923,1,""],[27923,0,"Y"],[27947,0," (or make an alternative with at"],[27977,2,""],[27977,0,"auto"],[27972,9,""],[27971,1,""],[27971,0,") which used slightly different logic for concurrent edits"],[28029,3,""],[28029,0,"\n- S"],[28083,3,""],[28083,0,"\n- S"],[28092,11,""],[28116,0,", and keep it up to doa"],[28138,1,""],[28137,1,""],[28137,0,"ate"],[28144,1,""],[28144,0,"\n- "],[28147,1,""],[28147,0,"C"],[28154,0,"yjs's "],[28160,3,""],[28159,1,""],[28183,1,""],[28183,0,"\n\n"],[28255,0," "],[28255,1,""],[28255,0," in adding this hinge into his library"],[28294,0,"\n\nFor my rust code, I probably will at some point add a "],[28344,6,""],[28344,0,"make my CRDT implementation ha"],[28373,1,""],[28372,1,""],[28372,0,"accecpt a"],[28380,1,""],[28379,1,""],[28378,1,""],[28377,1,""],[28376,1,""],[28376,0,"e"],[28376,1,""],[28376,0,"pt a type parameter which switches between yjs and automerge semantics."],[27164,9,""],[27164,0,"Hang on - A"],[27174,1,""],[27174,0,"are these"],[28457,0,"\n\n### "],[28459,4,""],[28459,0,"###"],[27043,0,"\n"],[27043,0,"\n# Appending"],[27054,1,""],[27053,1,""],[27053,0,"x\n\n# Wh"],[27059,1,""],[27058,1,""],[27057,1,""],[27057,0,"#"],[27061,0,"#"],[27063,13,""],[27063,0,"Appending A: "],[27063,23,""],[27063,0,"More information on my"],[27058,0," What if I want to use"],[27059,21,""],[27059,0,"Thats coo"],[27059,9,""],[27059,0,"What now? I want to use a CRDT for my application. What should I do?\n\nUse yjs. Yjs has excellent performance"],[27129,0,"If you're building an application today you should "],[27180,1,""],[27180,0,"u"],[27218,0,", low memory usage, great support (+ paid support if ou want"],[27271,7,""],[27271,0,"you need"],[27236,1,""],[27236,0," and"],[27254,0,". Kevin "],[27256,6,""],[27256,0,"You can also get"],[27272,3,""],[27286,11,""],[27286,0,"if you need it"],[27269,3,""],[27269,0,"become a sponsor of yjs t"],[27293,29,""],[27293,0,"if you want - which g"],[27313,1,""],[27313,0,"(if Kevin has time) will"],[27256,81,""],[27256,0,"You "],[27259,1,""],[27258,1,""],[27257,1,""],[27256,1,""],[27256,0,"If you have money"],[27263,10,""],[27263,0,"want help imeplm"],[27278,1,""],[27277,1,""],[27276,1,""],[27275,1,""],[27275,0,"plementing yjs in your application, Kevin "],[27149,1,""],[27149,0," a"],[27150,1,""],[27150,0,"co"],[27151,1,""],[27150,1,""],[27150,0,"document based collaborative"],[27196,0,", and you want ti t"],[27214,1,""],[27213,1,""],[27212,1,""],[27211,1,""],[27211,0,"to do it on top of CRDTs"],[27384,0,"might be able to "],[27377,24,""],[27377,0," get in conte"],[27389,1,""],[27389,0,"act with Kevin Jahns"],[27378,20,""],[27378,0,"yjs"],[27380,1,""],[27379,1,""],[27378,1,""],[27377,1,""],[27377,0," "],[27389,0," accepts some paid work in exchange for "],[27425,4,""],[27424,1,""],[27413,11,""],[27413,0,"so ke"],[27417,1,""],[27416,1,""],[27416,0,"he can work on yjs ful "],[27438,1,""],[27438,0,"l time."],[27413,0,"to fund working"],[27428,14,""],[27435,0," (and adjacent p"],[27450,1,""],[27450,0,"work)"],[27466,0,"\n\nMy rust code is really fast, but it m"],[27504,1,""],[27504,0,"probably"],[27504,0,"will "],[27517,0," never turn into a reliable"],[27536,8,""],[27536,0,"useful r"],[27543,1,""],[27543,0,"general purpose CRDT library. I simply don't have"],[27573,0,"There's 100 other things that "],[27573,30,""],[27573,0,"To be compatible "],[27579,11,""],[27579,0,"able to compete with yjs there are "],[27604,10,""],[27604,0,"on functionality there are 100 other things "],[27648,19,""],[27648,0," it "],[27651,1,""],[27650,1,""],[27649,1,""],[27648,1,""],[27648,0,"it needs to do well. "],[27603,0,"'s"],[27605,3,""],[27667,1,""],[27666,1,""],[27666,0,", including binary encoding and "],[27694,4,""],[27693,1,""],[27693,0,", network protocols, support for non-list structures, presence (curos"],[27761,1,""],[27760,1,""],[27760,0,"sor positions) and so on."],[27571,0," like yjs"],[27613,1,""],[27612,1,""],[27612,0,","],[27613,14,""],[27779,0,"\n\nIf you want database like semantics for realtime editing, you na"],[27844,1,""],[27843,1,""],[27843,0,"can"],[27839,7,""],[27839,0,"nobody has m"],[27850,1,""],[27850,0,"done this well yet."],[27839,0,"as far as I know "],[27882,4,""],[27882,0,"on top of CRDTs yet. You can use Shared"],[27920,1,""],[27920,0,"DB"],[27915,0,"my "],[27915,3,""],[27922,0," (which I wrote yesr"],[27941,1,""],[27940,1,""],[27940,0,"ars ago, and has been continually improved by an army oc "],[27996,1,""],[27995,1,""],[27995,0,"f contributors since then). "],[27982,28,""],[27982,0," "],[27996,0,"I'm excited for Redwoor"],[28018,1,""],[28018,0,"d."],[27915,0,"["],[27923,0,"](https://github.com/share/sharedb/)."],[27961,7,""],[27962,0," "],[27962,1,""],[27969,0,"shard"],[27973,1,""],[27973,0,"edb "],[28032,1,""],[28033,1,""],[28033,0," Looking forward, "],[28067,0,"["],[28075,0,"](https://github.com/redwood/redwood)"],[28033,1,""],[28033,0,"\n\nIf you want P2P support "],[28035,24,""],[28113,1,""],[28113,0," - which promises "],[28122,9,""],[28122,0,"is impl"],[28122,7,""],[28122,0,"has planned full CRDT support."],[28122,0,"uses "],[28122,5,""],[28122,0,"supports p2p editing and "],[28131,3,""],[28131,0,"P2P"],[29597,0," "],[29594,4,""],[29594,0,"###"],[27408,7,""],[27408,0,"support"],[27390,25,""],[27390,0,"sometimes accepts money in exchann"],[27423,1,""],[27423,0,"ge for help integrate"],[27443,1,""],[27443,0,"ing yjs into various applications. He usess t"],[27487,1,""],[27486,1,""],[27486,0," "],[27486,1,""],[27485,1,""],[27485,0," this to"],[27498,11,""],[27498,0," working on"],[27701,5,""],[27701,0," lot "],[27705,1,""],[27705,0,"s of "],[29679,0," This is the wrong benchmark"],[29698,9,""],[29698,0,"measure of performance\n\nYes, I agree.\n\nThe "],[29737,4,""],[29737,0,"The"],[29728,0," know and I"],[29748,3,""],[29748,0,"Accepting incoming changes from the usero"],[29788,1,""],[29788,0," only needs to happen fast enough "],[29821,1,""],[29815,0,"*"],[29822,0,"*. Fingers simply don't type very fast - so once a cR"],[29874,1,""],[29873,1,""],[29873,0,"CRDT gets "],[29878,5,""],[29878,0,"can handle any user edit in "],[29893,0,"local "],[29912,0,"under 1ms, going faster probably doesn't matte."],[29958,1,""],[29958,0,"r.\n\nThe important metrics are:"],[29966,0,"more "],[29993,0,"\n\n- How long the document takes to load from disk\n- "],[30043,2,""],[30043,0,"-"],[30027,0," save and"],[30053,0," Howm"],[30057,1,""],[30057,0," much spae"],[30066,1,""],[30066,0,"ce the do"],[30069,6,""],[30069,0,"it takes to send and rev"],[30092,1,""],[30092,0,"ceive the document"],[30058,52,""],[30058,0,"many bytes a document takes over the wo"],[30096,1,""],[30096,0,"ire"],[30095,4,""],[30095,0,"network"],[30086,0,"to en"],[30090,1,""],[30089,1,""],[30089,0,"send "],[30089,5,""],[30089,0,"store or send "],[30119,0,"\n\nWe"],[30122,1,""],[30121,1,""],[30121,0,"I'm also "],[30121,9,""],[30121,0,"All of these "],[30121,13,""],[30121,0,"The editing trace I'm using here also only has a single user making edits - "],[30196,1,""],[30195,1,""],[30194,1,""],[30194,0,". There might "],[30202,6,""],[30202,0,"could be pathological cases lurking in the shadows"],[30224,0,"performance "],[30264,0," when concurrent edits happen here."],[29965,0," actually"],[29974,5,""],[30290,13,""],[30274,0,"users make "],[30301,0,"."],[27054,0," A:"],[27057,14,""],[28251,1,""],[28251,0," Appending B: Your benchmarks are wrong"],[28290,34,""],[28285,0,"weird / "],[28298,0," / misleading"],[28265,4,""],[28265,0,"These"],[28464,9,""],[28586,0,"I"],[28586,1,""],[28586,0,"Doing this"],[28596,4,""],[28596,0," "],[28596,1,""],[28640,0,"for YATA and RGA "],[28701,0," between CRDT"],[28754,42,""],[28690,3,""],[28693,0," can"],[28725,0," without change"],[28739,1,""],[28739,0,"ing your implementation, or your implementation performance"],[28798,30,""],[28845,10,""],[28845,0,"n"],[28845,1,""],[28845,0,"looked at"],[28865,3,""],[28865,0," feel confident in this claim because I"],[28923,9,""],[29049,7,""],[29038,0,"(and an i"],[29046,1,""],[29045,1,""],[29044,1,""],[29044,0," almost-identical codepath) "],[29112,0," There might be some performance chang"],[29145,5,""],[29145,0,"differences with conflict-heavy editing traces - but thats extremely rare in ra"],[29223,1,""],[29222,1,""],[29222,0,"practice."],[29232,4,""],[29231,1,""],[29231,0,"\n\n"],[29236,0," also"],[29261,25,""],[29316,0,", without changing yjs's pef"],[29343,1,""],[29343,0,"rformance"],[29340,0," resulting"],[29341,9,""],[29340,1,""],[29354,13,""],[29354,0,"I know how you'd do it, too"],[29687,0," he a"],[29691,1,""],[29690,1,""],[29689,1,""],[29688,1,""],[29687,1,""],[29686,1,""],[29685,1,""],[29684,1,""],[29683,1,""],[29683,0,"."],[29684,1,""],[29685,1,""],[29685,0,"W"],[29732,4,""],[29732,0,"RGA support"],[29743,11,""],[29743,0," into"],[29761,0," I sort of "],[29764,8,""],[29763,1,""],[29763,0," "],[29763,1,""],[29762,1,""],[29761,1,""],[29761,0," Its a lot of "],[29762,13,""],[29762,0,"Changing the binary format in particular is a lot of work - and there"],[29819,12,""],[29819,0,", and "],[29761,64,""],[29761,0," Its not a feature anyob"],[29784,1,""],[29783,1,""],[29783,0,"body actually asks for."],[30006,25,""],[30006,0,"\nYes, I know and I agree. This post only measure "],[30054,1,""],[30054,0,"s the time toa"],[30067,1,""],[30066,1,""],[30066,0,"aken to replac"],[30079,1,""],[30079,0,"y an "],[30081,3,""],[30081,0,"a local editing trace. There's lot o"],[30116,1,""],[30115,1,""],[30115,0,"s"],[30065,0,"and memory "],[30065,11,""],[30102,0,", and the resulting RAM usage"],[30145,0," of mo"],[30150,1,""],[30132,20,""],[30132,0," But arguably, "],[30147,1,""],[30147,0,"a"],[30145,1,""],[30364,0,"("],[30364,1,""],[30364,0,"*"],[30383,0,"*"],[30360,24,""],[30360,0,"B"],[30360,1,""],[30360,0,"The *actually important*"],[30702,0,"\n\nI did it this way becasue both "],[30722,13,""],[30722,0,"because my reference-crdts"],[30730,18,""],[30729,1,""],[30729,0,":\n\n- Yjs and automerge both impleemtn"],[30734,0,"The "],[30738,1,""],[30738,0,"y"],[30756,14,""],[30756,0,"libraries implement very fast"],[30781,4,""],[30781,0,"compact binary representations"],[30766,0,"both "],[30816,0,". Th"],[30818,2,""],[30818,0,"An existence proof is enough for me h"],[30854,1,""],[30853,1,""],[30853,0," - I think you could port those binary packing formats to any inm"],[30917,1,""],[30916,1,""],[30916,0,"mplementation"],[30731,0,"\n- My re"],[30738,1,""],[30737,1,""],[30736,1,""],[30735,1,""],[30734,1,""],[30734,0,"I don't "],[30732,10,""],[30731,1,""],[30730,1,""],[30729,1,""],[30729,0," I don't have a binary"],[30732,5,""],[30732,0,"haven't implemented"],[30765,0," format in my reference-crdts or rust"],[30795,0,"implementation "],[30812,0," my"],[30820,0," code.\n"],[30826,0," I think it would be roughly "],[30835,0,"the performance "],[30827,11,""],[30827,0,"If I didn"],[30835,1,""],[30835,0,", I'd copy yjs & automerge's binary formats (they're extremely compact)"],[30841,0,"probably "],[30915,0," - so size would be identical. And I think"],[30990,0,"in "],[30990,3,""],[30990,0,"proportional w"],[31003,1,""],[31003,0,"to the time taken to process this editing trace - "],[31052,1,""],[31051,1,""],[31050,1,""],[31032,18,""],[31032,0,"editing traces."],[31047,200,""],[31047,0,"\n\n"],[31047,0," But I've been wrong before"],[30831,0," wrote that code"],[30847,4,""],[30851,1,""],[30850,1,""],[30849,1,""],[30849,0,"it would"],[30851,6,""],[30849,2,""],[30849,0,"I'd"],[30847,0," did"],[30842,5,""],[30837,5,""],[30831,6,""],[30887,0," because"],[30895,9,""],[30895,0," they're so"],[30906,10,""],[30914,1,""],[30914,0,"."],[30916,3,""],[30916,0,"S"],[30918,0," I expect"],[30928,0,"the resulting "],[30965,0," between all of these implementations"],[31009,0," suspect (claim)"],[31017,14,""],[31030,0,"for loading and saving "],[31053,3,""],[31061,28,""],[31061,0," pretty similar to the"],[31121,0," Probab"],[31121,7,""],[31121,0," Probably a bit faster e"],[31144,1,""],[31144,0,"because you only have to pro"],[31152,20,""],[31152,0,"the "],[31152,4,""],[31152,0,"in this format the document is alread st"],[31191,1,""],[31190,1,""],[31189,1,""],[31189,0,"y stored in order."],[31122,86,""],[31148,0,".\n\nI "],[31152,1,""],[31151,1,""],[31151,0,"There's a few small differences"],[30316,0,"about "],[30364,0," "],[30364,1,""],[30364,0," "],[30364,1,""],[30364,0,"\n\nIt is really fun though."],[31188,26,""],[31188,0," is one difference which might matter - yjs's binary format does run-length encoding of the "],[31231,49,""],[31231,0," packa"],[31236,1,""],[31236,0,"s th"],[31239,1,""],[31238,1,""],[31238,0,"information about deleted eleemnts "],[31264,9,""],[31264,0,"elements"],[31232,40,""],[31232,0,"and automerge treat dele"],[31252,4,""],[31252,0,"informatoin ab"],[31252,14,""],[31252,0,"information about deleted items l"],[31284,1,""],[31284,0,"slightly differentlt."],[31304,1,""],[31303,1,""],[31303,0,"y. "],[31305,1,""],[31305,0," (Ys"],[31308,1,""],[31308,0,"hs"],[31309,1,""],[31308,1,""],[31308,0,"js packs"],[31311,5,""],[31311,0,"RLE-e"],[31315,1,""],[31314,1,""],[31313,1,""],[31312,1,""],[31311,1,""],[31311,0,"run-el"],[31316,1,""],[31315,1,""],[31315,0,"length-encodes them and packa"],[31343,1,""],[31343,0,"s that information into the version structure. "],[31389,1,""],[31388,1,""],[31388,0,". Automerge put a"],[31404,1,""],[31403,1,""],[31403,0,"s that into the operation log)"],[31405,5,""],[31405,0,"deletes "],[31435,0,"."],[31437,0," This probably has some real-world "],[31461,11,""],[31461,0,"implications in terms pf "],[31485,1,""],[31484,1,""],[31483,1,""],[31483,0,"of implementation, but whatever"],[31505,9,""],[31505,0," I'"],[31507,1,""],[30437,4,""],[30437,0,"muuc"],[30440,1,""],[30439,1,""],[30439,0,"ch time"],[30560,0,"\n- How much time the document takes to save and load from disk"],[30431,62,""],[30465,16,""],[30465,0,"on disk or"],[30544,10,""],[31489,7,""],[31489,0,", because for automerge you need to store *when* each delete happened. Not just i"],[31569,1,""],[31569,0,"*if* the item has been deleted."],[31599,0," ("],[31600,1,""],[31599,1,""],[31600,0,"\n\nThere'"],[31602,6,""],[31601,1,""],[31600,1,""],[30544,0,"\n- T"],[30547,1,""],[30547,0,"The time taken "],[30547,15,""],[30547,0,"The time taken to update a docuemn"],[30580,1,""],[30579,1,""],[30578,1,""],[30578,0,"ment at rest (assuming a document is infrequently editing"],[30634,1,""],[30633,1,""],[30632,1,""],[30632,0,"ed and living "],[30590,56,""],[30590,0," ("],[30590,2,""],[30590,0," (more below)"],[31660,0,"\n"],[31660,0,"\nThe question nobody in the community seems to be thinking about is updaintg"],[31735,1,""],[31734,1,""],[31733,1,""],[31732,1,""],[31732,0,"ting a document at rest. If I have a CRDT "],[31769,0,"list "],[31779,0,"stored in P"],[31789,1,""],[31789,0,"postgres, and its very infrequently wr"],[31807,17,""],[31807,0,"wr"],[31808,1,""],[31807,1,""],[31806,1,""],[31809,0,"itten to infrequently, a"],[31832,1,""],[31832,0,"yjs and automerge seem to assume the ri"],[31850,21,""],[31850,0,"are written to "],[31862,3,""],[31862,0,"assuming you wan t"],[31879,1,""],[31878,1,""],[31878,0," t"],[31879,1,""],[31878,1,""],[31878,0,"t to:\n\n1. Load the docuemn"],[31903,1,""],[31902,1,""],[31901,1,""],[31901,0,"ment into RAM\n2. Make your change\n3. Save thew "],[31947,1,""],[31946,1,""],[31946,0," "],[31935,12,""],[31935,0,"3. Save the"],[31897,0,"whole "],[31952,0," whole document back to disk again\n\nThis"],[31988,4,""],[31988,0,"We do this for "],[31988,15,""],[31988,0,"This is actually really inefficient"],[31660,0,"\n---\n"],[28265,5,""],[28265,0,"Your"],[28325,3,""],[28325,0,"couple of"],[32006,15,""],[32006,0,"extremely"],[32027,0,", n"],[32029,1,""],[32029,0,"and it matter "],[32042,1,""],[32042,0,"s for some "],[32047,6,""],[32047,0," reall appli"],[32052,1,""],[32058,0,"cations ("],[32066,1,""],[32065,1,""],[32065,0," if we "],[32066,6,""],[32065,1,""],[32036,0,"will "],[32047,1,""],[32069,0," if we want CRDTs to be anything"],[32093,8,""],[32093,0,"u"],[32093,1,""],[32093,0,"u"],[32093,1,""],[32093,0,"mo"],[32094,1,""],[32093,1,""],[32093,0,"useful outside the context of text editing."],[32073,0,"(like me) you"],[32086,2,""],[32035,5,""],[32042,0,"s"],[32082,0,"'re hoping we add collaborative editing to more applicatoins tha"],[32130,16,""],[32130,0,"a"],[32130,1,""],[32065,0,". Espe"],[32066,5,""],[32065,1,""],[32065,0,". Especially if w"],[32067,10,""],[32048,19,""],[32048,0,"all the "],[32048,8,""],[32048,0,"the 99% of applications a"],[32072,1,""],[32072,0,"out there which aren't collaborative text editi"],[32118,1,""],[32117,1,""],[32117,0,"o"],[32117,1,""],[32117,0,"tors."],[32087,0," might want concurrent"],[32099,0,"to support "],[32120,0," editing, but"],[32168,131,""],[32168,0,"\n\nAs far as I know, nobody is thinking about this problem at the moment.\n\nI'm "],[32242,4,""],[32242,0,"I'm"],[32241,0,"\n\n---"],[32241,1,""],[32245,0,"\n"],[32250,0," also not looking into pruning. CRDTs like this grow u"],[32303,1,""],[32303,0,"over time (since we keep toms"],[32331,1,""],[32331,0,"bstones from all deleted items). This i"],[32364,6,""],[32364,0,"There are some "],[32364,15,""],[32364,0,"T"],[32364,1,""],[32364,0,"We don't actually need"],[32364,22,""],[32364,0,"You don't "],[32364,10,""],[32364,0,"There are some algorithms fr"],[32391,1,""],[32391,0,"or fixing this "],[32405,1,""],[32405,0,", and trimming down the document size from time to time. But a"],[32364,103,""],[32364,0,"This can be fixed, but fixing this is orthogonal to o"],[32416,1,""],[32412,4,""],[32412,0,"."],[32387,6,""],[32386,1,""],[32386,0," its "],[32387,4,""],[32387,0,"these fixes"],[32381,0," (eg Yjs's GC algorithm or "],[32407,1,""],[32406,1,""],[32405,1,""],[32404,1,""],[32404,0,", or Antimatter)"],[32420,1,""],[32420,0,"."],[32422,1,""],[32422,0,"B"],[32409,0,"To"],[32410,1,""],[32409,1,""],[32438,4,""],[32438,0,"are"],[32441,3,""],[32452,0," to what I'm doing above"],[32432,5,""],[32432,0,"a"],[32432,1,""],[32432,0,"things should work with any of the approaches I've listed"],[32489,34,""],[32489,0," "],[32498,0,"\n### Appendig"],[32510,1,""],[32510,0,"x C: Holy cow, automerge is really slow!"],[32551,57,""],[32551,0,"\nI know!! Take a loook "],[32573,1,""],[32572,1,""],[32571,1,""],[32571,0,"k at "],[32561,15,""],[32561,0,"Iyd "],[32564,1,""],[32563,1,""],[32562,1,""],[32562,0,"ts really just"],[32565,11,""],[32565,0,"not even trying to be fast. Look at this code:\n"],[32564,0," e"],[32565,1,""],[32565,0,"really"],[33943,746,""],[32532,0,"'"],[32532,1,""],[32534,0,"'s javascript c"],[32548,1,""],[32547,1,""],[33955,0,"\nT"],[33956,1,""],[33956,0,"But this code is all going tobe re"],[33989,1,""],[33988,1,""],[33987,1,""],[33986,1,""],[33985,1,""],[33985,0," be replaced by [automerge-rs](https://github.com/automerge/automerge-rs), whene"],[34064,1,""],[34063,1,""],[34063,0,"ver"],[34065,1,""],[34064,1,""],[34063,1,""],[34062,1,""],[34062,0,"enever that finally lands. (Maybe this week"],[34090,15,""],[34089,1,""],[34089,0,"Its been \"real son"],[34106,1,""],[34106,0,"on now\" for months. Maybe its landed"],[33997,0," i"],[33998,1,""],[33997,1,""],[33959,0," in practice"],[34012,0," calls "],[34013,6,""],[34013,0,"WASM calls through to"],[34176,0," by the time you're reading this! How fast is au"],[34214,10,""],[34214,0,"does automerge-rs compare? Good ue"],[34247,1,""],[34246,1,""],[34246,0,"question - I'd lo"],[34257,6,""],[34257,0,"maybe "],[34257,6,""],[34257,0,"I'd love to know too. Run"],[34279,3,""],[34278,1,""],[34277,1,""],[34277,0,"!"],[0,0,"\n\n\n"],[1,0,"! "],[2,1,""],[1,1,""],[1,0,"# Autom"],[3,5,""],[3,0,"Making CRDTs go BRRR "],[23,1,""],[22,1,""],[21,1,""],[20,1,""],[19,1,""],[3,7,""],[12,0,"BRRR: Improving performance byt "],[43,1,""],[42,1,""],[42,0," 4000x"],[3211,5,""],[3211,0,"Its"],[3416,0,"I took "],[3416,7,""],[3422,1,""],[3422,0,"ing"],[7952,1,""],[7952,0,"I"],[7952,0,"["],[7965,0,"](https://immutable-js.github.io/)"],[7962,1,""],[8476,0,"just "],[9062,21,""],[9062,0,"when you can"],[9081,0," it"],[9070,0,"'"],[9070,1,""],[9062,12,""],[9062,0,"before"],[9074,1,""],[9074,0,"ing"],[9062,7,""],[9062,0,"and then "],[9078,1,""],[9077,1,""],[9076,1,""],[9076,0,"ing"],[9062,17,""],[9062,0,"before rewriting"],[9062,16,""],[9062,0,"when yuo're a"],[9067,8,""],[9067,0,"you're about to throw it away in a rewrite"],[9109,3,""],[9279,0," as fa"],[9284,1,""],[9283,1,""],[9282,1,""],[9281,1,""],[9280,1,""],[9279,1,""],[9301,0," is another (competing) CRDT algorithm n "],[9341,1,""],[9340,1,""],[9340,0,"on github"],[9330,10,""],[9330,0,"implementation "],[9354,0," made by J"],[9363,1,""],[9363,0,"H"],[9363,1,""],[9363,0,"Kevin Jahns. Ke"],[9377,1,""],[9376,1,""],[9376,0,"A"],[9376,1,""],[9376,0,"And its really fast, well dou"],[9404,1,""],[9404,0,"cumented and well made. Yjs"],[9517,6,""],[9517,0,"really"],[9517,6,""],[9517,0,"really"],[9517,6,""],[9517,0,"pretty"],[9427,1,""],[9427,0,"\n\n"],[10218,58,""],[10217,1,""],[10414,136,""],[10413,1,""],[10424,3,""],[10415,9,""],[10415,0,"But with this"],[10445,1,""],[10445,0," l"],[10446,1,""],[10445,1,""],[10445,0,"s more complicated"],[10620,0," (?)"],[10637,0," there, splicing into the array"],[10668,1,""],[10740,8,""],[10751,0," - how do you figure out where the new item should go?"],[10805,51,""],[10805,0," But it "],[10812,1,""],[10812,0,"s only complicated like *math*. The logic for ordering ends up being 2l"],[10882,1,""],[10882,0," "],[10881,2,""],[10881,0,"just a few if statements."],[10842,64,""],[10842,0," - the "],[10845,4,""],[10845,0,"once you f"],[10854,1,""],[10843,0,"is complicate."],[10856,1,""],[10856,0,"d."],[10858,11,""],[10859,8,""],[10859,0,"Its hard to understand, but when you do, you "],[11042,0," if you're interested"],[11408,2,""],[11408,0,"I made a"],[11414,2,""],[11414,0," a"],[11486,0," whivh"],[11491,1,""],[11490,1,""],[11490,0,"ch"],[11529,0," side-by-sided"],[11542,1,""],[11544,66,""],[11544,0,"For "],[11547,1,""],[11546,1,""],[11545,1,""],[11544,1,""],[11544,0,"You can (mostly) swap imle"],[11569,1,""],[11568,1,""],[11568,0,"plementations y"],[11582,1,""],[11582,0,"by just changing your inte"],[11607,1,""],[11606,1,""],[11605,1,""],[11604,1,""],[11604,0,"insertion function."],[11604,9,""],[11590,14,""],[11590,0,"sapp"],[11593,1,""],[11592,1,""],[11591,1,""],[11591,0,"wapping out your insertion"],[11644,5,""],[11644,0," does"],[11654,1,""],[11810,17,""],[11810,0,"I"],[11821,0,", its really fast"],[11810,0,"So "],[11813,1,""],[11813,0,"i"],[11824,1,""],[11824,0," "],[11824,1,""],[11989,0," (TM)"],[12097,46,""],[11194,10,""],[11194,0,"better "],[11220,0," "],[11177,0,"This approach is better for lots of reasons :\n"],[11177,46,""],[11220,1,""],[11200,1,""],[11194,6,""],[11194,0,"beautiful "],[12097,0," We implement a list CRDT with a list. Genius!"],[12097,46,""],[11194,10,""],[11194,0,"better "],[11220,0," "],[11177,0,"This approach is better for lots of reasons :\n"],[11177,46,""],[11221,0," We implement a list CRDT with a list. Genius!"],[11221,46,""],[11220,1,""],[11176,0,"\n We implement a list CRDT with a list. Genius!"],[11178,1,""],[11177,1,""],[11177,0,"W"],[11177,0,"In short"],[11177,8,""],[11222,0,"\n"],[10831,4,""],[10814,5,""],[10826,0,"like"],[10895,70,""],[10895,0,"you can do the whoel "],[10915,1,""],[10914,1,""],[10913,1,""],[10913,0,"le thing in about "],[11003,21,""],[11117,45,""],[10728,0," We implement a list CRDT with a list. Genius!"],[10731,0,"'re"],[10744,0,"ing"],[11169,1,""],[11168,1,""],[12085,1,""],[12085,0," - w"],[12088,1,""],[12087,1,""],[12086,1,""],[12085,1,""],[12085,0,". Moving the fronteir"],[12085,1,""],[12085,0,", which is the "],[12100,20,""],[12100,0,"kind of idea that makes you"],[12085,42,""],[12085,0," "],[12085,1,""],[12085,0,". These idae"],[12096,1,""],[12095,1,""],[12087,8,""],[12087,0,"Ideas which do this are golden."],[12111,0,"truly "],[12110,0," rare and"],[12119,6,""],[12119,0," truly"],[12134,0,"\n\n"],[12135,0,"I'"],[12136,1,""],[12136,0," "],[12135,2,""],[12135,0,"I"],[11396,220,""],[11395,1,""],[11395,0,", if you want to."],[11932,0," made"],[11932,5,""],[11408,4,""],[11403,5,""],[11399,4,""],[11396,3,""],[11395,1,""],[11395,0,", if you want to."],[11932,0," made"],[11000,0,"\n\n\n"],[11002,1,""],[11001,1,""],[11000,1,""],[10781,0,"\n"],[10781,0,"\nIn an eff"],[10782,9,""],[10782,0,"I implemented both Yjs and Automerge myself using this approach in a toy CRDT "],[10855,5,""],[10855,0,"codebase, so I could understand"],[10865,21,""],[10865,0," "],[10865,1,""],[10865,0,"to prove I could"],[10845,36,""],[10845,0,". The code"],[10851,0,"["],[10856,0," is here](https://github.com/josephg/reference-crdts)"],[10860,0,"all "],[10913,0," if you want to "],[10870,42,""],[10870,0,"https://github.com/josephg/reference-crdts/blob/main/crdts.ts"],[10948,0,"figure this out in m"],[10948,20,""],[10948,0,"understan "],[10957,1,""],[10957,0,"d this in more detail."],[11199,1,""],[11199,0,"\n\n\n"],[10979,1,""],[10782,0,"\n"],[10980,219,""],[10783,0,"It sounds complicated - how do you figure out where the new item should go? But its complicated like *math* is complicated. Its hard to understand, but when you do, you can do the whole thing in about 20 lines of code.\n"],[11199,1,""],[11002,0,"\n"],[10781,1,""],[11199,2,""],[11199,0," "],[11366,0," Both "],[11371,1,""],[11370,1,""],[11369,1,""],[11368,1,""],[11367,1,""],[11366,1,""],[11366,0," C"],[11367,1,""],[11367,0,"Automer"],[11367,7,""],[11367,0,"Implemented like this, all the e"],[11398,1,""],[11390,8,""],[11390,0,"the difference "],[11390,15,""],[11390,0,"the CRDT semantics "],[11390,0,"auot"],[11393,1,""],[11392,1,""],[11392,0,"tomerge and yjs's "],[11410,4,""],[11425,0,"are identical"],[11410,28,""],[11410,0,"performance"],[11389,0," the performance differences "],[11394,24,""],[11393,1,""],[11366,59,""],[12130,6,""],[12130,0," Implemented like this, the automerge and yjs's performance"],[12130,59,""],[12130,0,"I made"],[12130,6,""],[12129,1,""],[12129,0,"\n"],[12690,5,""],[12724,1,""],[12724,0," too."],[12130,0,"B"],[12130,1,""],[12130,0,"In this codebase I have an implementation of ys"],[12176,1,""],[12175,1,""],[12175,0,"both RGA (au"],[12186,1,""],[12185,1,""],[12184,1,""],[12175,0,"the sma"],[12181,1,""],[12180,1,""],[12180,0,"emantics of "],[12201,0,"(automerge) and yjs ("],[12221,1,""],[12220,1,""],[12219,1,""],[12218,1,""],[12217,1,""],[12217,0,"YATA (js"],[12224,1,""],[12223,1,""],[12223,0,"yjs). But "],[12229,4,""],[12229,0,"They have identical performance."],[12229,0,"But "],[12233,19,""],[12233,0,"the"],[12248,0," is identical anyway"],[12261,7,""],[12249,0,"in this test "],[12277,0,"How fast? "],[12277,10,""],[12990,19,""],[12990,0,"There are two"],[13040,9,""],[13040,0,"code"],[13122,0,"\n\nIts t"],[13128,1,""],[13127,1,""],[13126,1,""],[13125,1,""],[13124,1,""],[13123,1,""],[13122,1,""],[13044,0," we need to fix"],[13139,0,"L"],[13139,1,""],[13139,0,"Lets say "],[13148,1,""],[13148,0,"w"],[13194,33,""],[13194,0,"S"],[13193,45,""],[13489,0,"\n Some of those items might have been deleted:"],[13490,1,""],[13490,0,"\nNote that "],[13501,1,""],[13501,0,"s"],[13544,1,""],[13544,0,", so I've added an `isDeleted` flag to mark them s"],[13593,1,""],[13593,0,"as such."],[13579,22,""],[13579,0,"."],[13579,0," to mark which ones"],[13599,0," We can't just remove them from the array because other peers might insert a"],[13655,20,""],[13655,0,"inserts might depend on them. (Oops)"],[13690,0,"!"],[13686,0,"Dang"],[13690,4,""],[13692,0,". "],[13693,1,""],[13692,1,""],[13686,4,""],[13686,0,"Drat"],[13691,0," But lets not worry about that for now."],[13695,6,""],[13695,0," I'm "],[13721,7,""],[13721,0,"in this post"],[13491,11,""],[13491,0,"S"],[13873,0," in my array"],[13753,1,""],[13753,0,"5"],[13771,0,". M"],[13773,1,""],[13772,1,""],[13771,1,""],[13771,0,", representing 100 00 "],[13792,1,""],[13792,0,"0 items which haven't been deleted."],[13827,5,""],[13759,0," array"],[13800,5,""],[13800,0,"characters"],[13839,1,""],[13839,0,"If t"],[13898,0,"document "],[13898,0,"*"],[13916,0,"*"],[13925,1,""],[13925,0,","],[13927,1,""],[13927,0,"w"],[13932,9,""],[13945,1,""],[13944,1,""],[13944,0,"our document"],[13948,8,""],[13947,1,""],[13955,0,"To find out, "],[13968,1,""],[13968,0,"w"],[13972,1,""],[13971,1,""],[13970,1,""],[14043,24,""],[14043,0," the right array location"],[14069,91,""],[14071,0,"So "],[14074,1,""],[14074,0,"i"],[14147,5,""],[14146,1,""],[14160,0,"or something "],[14262,0,", which is double yikes"],[14347,14,""],[14375,1,""],[14375,0,"5"],[14983,20,""],[14983,0,"I"],[15691,23,""],[15690,5,""],[15694,0," extra optimizatoin"],[15713,11,""],[15712,1,""],[15711,1,""],[15710,1,""],[15710,0,"ion here"],[15685,5,""],[15685,0," does"],[15720,0,"Because "],[15728,1,""],[15728,0,"h"],[15761,1,""],[15761,0,","],[15763,1,""],[15763,0,"i"],[15763,4,""],[15763,0,"when we"],[15783,0," in a document"],[16409,0,"\n\nSemantically this is the s"],[16436,1,""],[16435,1,""],[16434,1,""],[16433,1,""],[16432,1,""],[16432,0,"equivalent to the expanded version above - but the p"],[16483,1,""],[16483,0,"id, seq and parents of the internal elements is implicif"],[16538,1,""],[16538,0,"c"],[16538,1,""],[16538,0,"t."],[16539,0," when "],[16544,1,""],[16543,1,""],[16542,1,""],[16541,1,""],[16540,1,""],[16539,1,""],[16540,9,""],[16540,0," So"],[16557,0," we"],[16609,0," or something like that"],[16709,1,""],[16709,0,"\n\n"],[16710,1,""],[16709,1,""],[16709,0," "],[16710,5,""],[16710,0,"Yjs"],[16733,0,"s"],[16809,3,""],[16809,0,"these"],[16820,0," - since the id and sequence numbesr won'"],[16849,12,""],[16849,0,"numbers "],[16856,1,""],[16856,0," won'tli"],[16863,1,""],[16862,1,""],[16862,0," line up"],[16871,1,""],[16871,0,"\n\n"],[16873,14,""],[16873,0,"In our"],[17652,10,""],[17652,0,"I "],[17653,1,""],[17652,1,""],[17652,0,"Kevin says"],[17701,5,""],[17700,1,""],[17721,0," find the fas"],[17722,12,""],[17722,0,"make this code run so fast"],[17748,22,""],[17748,0,"."],[17721,0," figure out "],[17722,11,""],[17721,1,""],[18480,33,""],[18479,1,""],[18485,0," knows this now too, and he's"],[18514,3,""],[18526,10,""],[18523,3,""],[18523,0,"my approach in turn."],[18543,1,""],[18543,0," He's now"],[18552,4,""],[18600,28,""],[18600,0," which "],[18601,6,""],[18601,0,"to see if he can beat me in perfora"],[18635,1,""],[18634,1,""],[18634,0,"rmance."],[18515,37,""],[18514,1,""],[18806,0," with all the parts separate "],[18834,1,""],[18834,0," "],[18834,1,""],[18834,0,"d by pointers"],[26293,0,"So "],[26631,0," much"],[26783,15,""],[26783,0,"That was a mistake"],[26847,12,""],[26846,1,""],[27342,0," we can give"],[27354,4,""],[27354,0," to"],[27403,0," Some people are great parents. I"],[27404,0,"("],[27404,1,""],[27436,0," lok"],[27439,1,""],[27438,1,""],[27438,0,"ike performance."],[27442,0,"ob"],[27443,1,""],[27442,1,""],[27442,0,"thinking about "],[27457,11,""],[27457,0,"software performance tuning"],[27441,16,""],[27441,0," "],[27442,21,""],[27448,0," software"],[27442,7,""],[27442,0,"making "],[27457,0," o"],[27458,1,""],[27458,0,"o"],[27458,1,""],[27458,0,"go really fast"],[27435,0,"Me? "],[27440,5,""],[27440,0," can"],[27450,1,""],[27449,1,""],[27448,1,""],[27448,0,"e"],[27435,4,""],[27435,0,"Thats great, but "],[27659,4,""],[27659,0,"making "],[27665,1,""],[27664,1,""],[27663,1,""],[27662,1,""],[27662,0,"e this"],[27675,1,""],[27674,1,""],[27673,1,""],[27673,0," fast"],[27693,24,""],[27693,0,"Instead of entering"],[27704,8,""],[27704,0,"doing that work"],[27721,0," "],[27721,1,""],[27720,1,""],[27719,1,""],[27719,0,", I was sbu"],[27729,1,""],[27728,1,""],[27728,0,"b"],[27728,1,""],[27727,1,""],[27727,0,"busy and"],[27840,0," and bring it back"],[27884,0," Practical "],[27896,1,""],[27895,1,""],[27895,0,"d"],[27940,1,""],[27940,0,"\n\n"],[27941,1,""],[27940,1,""],[27940,0," "],[27452,10,""],[27452,0,"check out hos"],[27464,1,""],[27464,0,"w fast I can mek"],[27479,1,""],[27478,1,""],[27478,0,"ake"],[27493,13,""],[27493,0,"!"],[27482,8,""],[27482,0,"CRDTs"],[27404,0,"("],[27492,0,")"],[27509,7,""],[27609,40,""],[28413,0," Yjs already runs fast and eventua"],[28440,7,""],[28440,0,"soon it will "],[28448,5,""],[28448,0,"should become even faster."],[28492,0,"*"],[28499,0,"*"],[28793,0," Kevin has got this."],[28993,1,""],[28993,0,", which does this stuff on top p"],[29024,1,""],[29024,0,"of OT."],[29312,0,"Yes, I know. "],[29325,5,""],[29325,0,"I've made a few gl"],[29342,1,""],[29341,1,""],[29341,17,""],[29356,11,""],[29356,0," which"],[33169,0," Ther "],[33174,1,""],[33174,0,"e are e"],[33180,1,""],[33180,0,"better aprpoa"],[33192,1,""],[33191,1,""],[33190,1,""],[33189,1,""],[33189,0,"proaches to doing this sort of thing on top of a database, but"],[33251,2,""],[33251,0," "],[33252,1,""],[33252,0,"a"],[33311,0,"all at "],[32999,36,""],[32999,0,"This is s"],[33007,1,""],[33007,0,"the workflow that "],[33025,17,""],[33025,0,"y"],[33025,1,""],[33011,0,"cure"],[33014,1,""],[33014,0,"rentl"],[33018,1,""],[33017,1,""],[33017,0,"t "],[33018,1,""],[33018,0,"ly recommended "],[33042,4,""],[33042,0,"for"],[33045,1,""],[33046,0,"the "],[33086,6,""],[33090,11,""],[33091,10,""],[33091,0,"collaborative"],[33124,14,""],[33051,1,""],[33051,0,"5"],[33167,48,""],[33166,1,""],[33166,0," -"],[33168,1,""],[33235,15,""],[33235,0,". Help!"],[33241,1,""],[33241,0," please!"],[33237,0,"We could use yur"],[33252,1,""],[33251,1,""],[33251,0,"our "],[33255,1,""],[33255,0,"h"],[33259,7,""],[25654,0," This is fast enough to saturate 100mb"],[25691,1,""],[25690,1,""],[25690,0," "],[25687,4,""],[25687,0,"me"],[25688,1,""],[25687,1,""],[25687,0,"100 megabit ethernet."],[25678,0,"be "],[25675,35,""],[25675,0,"that my h"],[25683,1,""],[25682,1,""],[25681,1,""],[25680,1,""],[25668,12,""],[25667,1,""],[25667,0,"er than the fiber ethernet comin "],[25699,1,""],[25699,0,"g into my apartment"],[25719,1,""],[25719,0,"\n\n"],[25783,0,"And "],[25787,1,""],[25787,0,"o"],[25789,0,"!"],[25789,0," look"],[25794,6,""],[25835,0,"It l"],[25838,1,""],[25837,1,""],[25836,1,""],[25835,1,""],[26003,0,"*"],[26008,0,"*"],[33468,5,""],[33468,0,"addressed"],[33517,0," Or ignored (eg g"],[33533,1,""],[33533,0,"Git)"],[33536,0," grows forever and nobody cares"],[33568,0,".\n\n"],[33571,4,""],[33571,0,"But thats orthogonal "],[33591,1,""],[33591,0," to everything"],[33605,52,""],[33521,0,"you could just ignore it like git does"],[33559,47,""],[33560,0," Nobody seems to mind too much."],[33560,31,""],[33536,0,"mostly "],[33566,0," - nobody seems to care that their git repos grow without bound, forever"],[33811,0,"Gosh, "],[33817,1,""],[33817,0,"l"],[0,1,""],[27,0,"list "],[17,30,""],[17,0,"Making collaborative editing "],[51,0," faster"],[1856,9,""],[1855,1,""],[1854,1,""],[1853,1,""],[1853,0,"OT"],[1853,2,""],[1853,0,"operational transform"],[1852,0," sompe"],[1857,1,""],[1856,1,""],[1856,0,"e particular"],[1891,0,"algorithm "],[2299,0," But were the academics using the slow version or th "],[2351,1,""],[2351,0,"e fast e"],[2358,1,""],[2358,0,"version"],[2299,1,""],[2299,0,"\n\n"],[2366,0,"? Were they "],[2368,10,""],[2368,0,"did "],[2368,4,""],[2368,0,"id"],[2369,1,""],[2368,1,""],[2368,0,"Did they have fast versions of some algorithms and slow versions of ther"],[2439,1,""],[2438,1,""],[2437,1,""],[2436,1,""],[2436,0,"others, which might mess up their results? Its impiss"],[2488,1,""],[2487,1,""],[2486,1,""],[2486,0,"ossible"],[2479,3,""],[2479,0,"Reading the "],[2479,12,""],[2479,0,"Its"],[2493,0," to tell1"],[2501,1,""],[2501,0,"!"],[2479,3,""],[2479,0,"From the paper, its"],[2917,1,""],[2917,0,"."],[23861,0,"T"],[23861,1,""],[23861,0,"See, i"],[23867,1,""],[23867,0,"i"],[23867,1,""],[23877,0," actually"],[24156,0," // negative = deleted."],[24178,1,""],[24178,0," content"],[24110,6,""],[24110,0,"l"],[24060,6,""],[24060,0,"l"],[24106,0,"e"],[24061,0,"e"],[24108,0,"n"],[24062,0,"n"],[24163,0,"len "],[24322,0,"For"],[24324,1,""],[24323,1,""],[24322,1,""],[24402,0," for this"],[24469,0,"just "],[24502,1,""],[24502,0,"\n\n"],[24516,4,""],[24516,0," "],[24516,1,""],[24515,1,""],[24515,0,"universally a"],[24663,25,""],[24663,0,"So using ropey"],[24666,6,""],[24666,0,"with "],[24676,0,", we use less RAM."],[24712,10,""],[24714,0," now"],[24788,0,"more "],[24792,1,""],[24791,1,""],[24790,1,""],[24789,1,""],[24788,1,""],[24788,0,"2+x"],[24790,1,""],[24789,1,""],[24788,1,""],[24788,0,"more than twice as "],[24813,0,","],[24813,1,""],[24812,1,""],[24811,1,""],[24811,0,", and it makes the wasm bundle"],[24841,50,""],[24841,0," twice as big ("],[24856,1,""],[24862,1,""],[24861,1,""],[24861,0,"->"],[24869,0,")"],[24873,0,"So "],[25936,0," This is kind of uselesss"],[25960,1,""],[25960,0,", but its now"],[26060,14,""],[26056,4,""],[26056,0,"my internet connection"],[26078,25,""],[26036,7,""],[26036,0,"I can process edits"],[26049,6,""],[26041,8,""],[26037,4,""],[26036,1,""],[26036,0,"This is"],[26036,7,""],[26036,0,"Its"],[26036,39,""],[26036,0,"This could saturate "],[26036,20,""],[26036,0,"I could saturate my internet connection and have CPU to spare."],[26076,0,"with this "],[26260,36,""],[26260,0," by interleaving b"],[26277,1,""],[26277,0,"the b-treeu "],[26288,1,""],[26287,1,""],[26287,0," updates"],[26330,57,""],[26330,0,"whic"],[26333,1,""],[26332,1,""],[26331,1,""],[26330,1,""],[26330,0," which should work"],[26351,0," just"],[26331,0,"in my future "],[26349,20,""],[26349,0,"brings "],[26355,1,""],[26354,1,""],[26353,1,""],[26352,1,""],[26351,1,""],[26350,1,""],[26349,1,""],[26349,0," brings that 54"],[26363,1,""],[26362,1,""],[26362,0,"65ms down to"],[27443,0," to invent"],[27453,35,""],[28101,13,""],[28206,0,"(super fast CRDTs) "],[28252,9,""],[28251,1,""],[28251,0," have "],[28264,0," "],[28264,1,""],[28264,0," S"],[28265,1,""],[28264,1,""],[28341,0," next"],[28493,4,""],[28496,34,""],[29223,5,""],[29233,21,""],[29233,0," instead of document semantics"],[29393,25,""],[29392,1,""],[29392,0," uss"],[29395,1,""],[29395,0,"es"],[31062,12,""],[31062,0,"And "],[31065,1,""],[31064,1,""],[31063,1,""],[31062,1,""],[31061,1,""],[31060,1,""],[31060,0,", and h"],[31066,1,""],[31139,9,""],[31139,0,"something"],[31131,0,"It would add complexity, but"],[31131,28,""],[33990,1,""],[33989,1,""],[34100,7,""],[34100,0,"L"],[0,0,"\n\n"],[0,0,"> R"],[2,1,""],[2,0,"DRAFT: Needs diagrams before publishing."],[23,0,", maybe some tidy up"],[62,0," Don't share the link too widelyp"],[94,1,""],[94,0," please! This isn't ready for N"],[124,1,""],[124,0,"HN."],[34114,0,"\n\n### on"],[34121,1,""],[34120,1,""],[34120,0,"All of thee "],[34131,1,""],[34130,1,""],[34130,0,"se benchmarks show the e"],[34153,1,""],[34153,0,"result from multip"],[34170,1,""],[34169,1,""],[34169,0,"iple changes\n\n"],[34119,0," This doesn't "],[34120,13,""],[34119,1,""],[34120,61,""],[34120,0,"You have too many variables changing"],[34115,0,"\n"],[34159,0,"Yeah, well spotted. Each of these tests changes multiple ve"],[34217,1,""],[34217,0,"ariables. Maybe my d"],[34236,1,""],[34236,0,"reference implementation is faster than automerge simply "],[34159,134,""],[34159,0,"Yeah, well spotted. Each of these tests changes multiple variables. Maybe my reference implementation is faster than automerge simply"],[33271,0," whole data "],[33282,1,""],[33282,0,"base full of"],[33294,5,""],[33299,0,"s"],[33300,7,""],[33314,0,"I want to be able to update a single itme"],[33354,1,""],[33353,1,""],[33353,0,"em quickly."],[33364,84,""],[33364,0," With yjs and automerge today you need to:"],[33510,0,"\nThis is going to be awuf"],[33534,1,""],[33533,1,""],[33533,0,"fully slow, "],[33544,1,""],[33543,1,""],[33364,0,"\n\n"],[33366,1,""],[33259,0," Most applications aren "],[33282,1,""],[33282,0,"'t collaborative text edti"],[33307,1,""],[33306,1,""],[33306,0,"itors."],[33416,1,""],[33312,0," "],[33312,1,""],[33312,0," Most aapps"],[33318,5,""],[33318,0,"apps have lots of small objects which are each "],[33360,5,""],[33360,0,"rarely written to."],[33313,65,""],[33312,1,""],[33311,0,", where there's one document l"],[33340,1,""],[33340,0,"you can load once, keep open and then e"],[33378,1,""],[33378,0,"save"],[33311,71,""],[33311,0,". Intea"],[33317,1,""],[33316,1,""],[33315,1,""],[33315,0,"stead they have ad"],[33332,1,""],[33331,1,""],[33331,0,"databases full"],[33321,0,"most apps "],[33331,5,""],[33350,0," of tiny objects, each of which is almost never"],[33385,12,""],[33385,0,"very rarely written to"],[33408,1,""],[33408,0,"\n\n"],[33410,104,""],[33409,1,""],[33408,1,""],[33408,0,"j"],[33408,1,""],[33408,0,"\n"],[33409,1,""],[33408,1,""],[33408,0," "],[33587,0,"."],[33588,140,""],[33616,0," than this"],[33681,8,""],[33661,14,""],[33661,0,"working on "],[33671,1,""],[33735,5,""],[33735,0," at"],[33746,0," here"],[31861,0," much"],[33172,0," other"],[33178,9,""],[33178,0," perof"],[33183,1,""],[33182,1,""],[33182,0,"formance measure"],[33252,0," how"],[33255,1,""],[33254,1,""],[33253,1,""],[33252,1,""],[33335,22,""],[33335,0,"Usually we"],[33343,2,""],[33343,0,"applications have"],[33391,1,""],[33391,0,". Each "],[33398,6,""],[33400,0," those objects"],[33414,6,""],[33441,1,""],[33441,0,"\n\nIf you want to update a single object in da "],[33486,1,""],[33485,1,""],[33485,0," "],[33485,1,""],[33484,1,""],[33484,0,"a data "],[33490,1,""],[33490,0,"base "],[33495,4,""],[33494,1,""],[33499,3,""],[33499,0,"or"],[33517,0,","],[33517,1,""],[34348,48,""],[34348,0,"Wh"],[34348,2,""],[34348,0,"Holy cow, automerge's javascript is really slow!"],[427,0," ("],[428,1,""],[427,1,""],[427,0," (wow"],[431,1,""],[430,1,""],[429,1,""],[429,0,"wow, "],[433,1,""],[432,1,""],[431,1,""],[430,1,""],[429,1,""],[429,0,"Wow, yess!)"],[248,1,""],[248,0,"\n\n"],[928,53,""],[928,0," - something was fishy here"],[929,0,"at the paper to see what was going on "],[969,0,"because "],[1003,0,"It turns out "],[1016,1,""],[1016,0,"w"],[1003,14,""],[1003,0,"In their paper w"],[1366,11,""],[1366,0," implementation"],[1362,4,""],[1362,0,"this particular"],[1362,4,""],[1362,0,"their"],[1395,0," Written in a "],[1404,5,""],[1404,0,"up as Science Paper"],[1410,0,"ub"],[1411,1,""],[1410,1,""],[1410,0,"PUbli"],[1414,1,""],[1413,1,""],[1412,1,""],[1411,1,""],[1411,0,"ublished "],[1433,0," it makes people think this"],[798,10,""],[798,0,"hang on -"],[807,1,""],[798,0,"- "],[881,6,""],[881,0,"W"],[937,24,""],[936,1,""],[1366,65,""],[1366,0,"\n"],[903,463,""],[903,0,"I took a closer look at the paper - because something was fishy here. In their paper when a user pasted a big chunk of text (say, 1000 characters), instead of creating 1 operation with 1000 characters, their code split the insert into 1000 operations. And each of those inserts needed to be processed separately. Duh - of course it'll be slow if you do that! This isn't a problem with the algorithm. This is just a problem with *their particular implementation*."],[1478,0," Written up as Published Science Paper it makes people think this\n"],[1479,0,"?Be"],[1481,1,""],[1480,1,""],[1479,1,""],[1479,0,"Because, "],[1488,1,""],[1488,0,"w"],[1552,0," is a Fact rather than a "],[1563,14,""],[1563,0,"Of The Universe rather than a "],[1592,1,""],[1592,0,"n implemetnation de"],[1594,17,""],[1594,0,"implementation detail of some "],[1367,257,""],[1367,0,"I wouldn't mind so much if I didn't have so many people flipping me a link to the paper and asking me about it. Because, written up as Published Science Paper it makes people think this is a Fact Of The Universe rather than an implementation detail of some"],[1623,1,""],[1623,0,"\n"],[1616,7,""],[1616,0,"in some "],[1616,8,""],[1616,0,"of some code write"],[1633,1,""],[1633,0,"ten by a "],[1641,1,""],[1641,0,"n overworked researcher."],[1666,0,"\n"],[1423,11,""],[1423,0,"sending"],[1423,10,""],[1427,0,"ing"],[1430,3,""],[1444,0," (pointedly)"],[1467,5,""],[1467,0,"what I think about"],[1490,10,""],[1490,0,"W"],[1669,0,"So, "],[1674,1,""],[1673,1,""],[1673,0,"n"],[1676,0," "],[1677,14,""],[1677,0,"the sci"],[1677,7,""],[1677,0,"The science isn't real! I'm"],[1703,1,""],[1702,1,""],[1701,1,""],[1700,1,""],[1695,5,""],[1695,0,"right! Please believe me!"],[1669,5,""],[1669,0,"N"],[1671,0,"oo"],[1693,5,""],[1693,0,"real"],[2349,13,""],[2362,0,"\n\nAnd differen"],[2375,1,""],[2375,0,"ent"],[2377,1,""],[2376,1,""],[2375,1,""],[2364,11,""],[2363,1,""],[2362,1,""],[2738,0," of this code"],[2938,1,""],[2950,49,""],[3018,0,"["],[3050,0,"]((https://josephg.com/blog/crdts-are-the-future/)). And maybe other kinds of f"],[3128,1,""],[3128,0,"sof"],[3113,18,""],[3113,0,"all our software - but I'm not ready to talk about that yet"],[3185,0,"today "],[3185,6,""],[3185,0,"you read about in academic papers "],[3799,0," "],[3799,1,""],[3799,0," Martin Kleppmann"],[4142,0," currently"],[4201,0,"ward"],[4245,4,""],[4245,0,"we need to "],[4255,1,""],[3799,17,""],[5034,0,"you "],[5045,9,""],[5045,0,"into th ed"],[5054,1,""],[5053,1,""],[5053,0,"e"],[5053,1,""],[5052,1,""],[5052,0,"e document"],[5896,0,", and the user *clearly* inserted before"],[5898,38,""],[5898,0,"even though the user inserted before the 'b'*"],[5939,0,"*"],[5940,1,""],[5941,1,""],[5890,1,""],[5890,0,"*"],[5895,1,""],[5895,0,"*"],[5943,1,""],[5943,0,"\n\n"],[6506,0,"\n"],[6506,0,"\nFor reference, Yjs "],[6507,15,""],[6507,0,"(Aside: "],[6519,0,"solves this with a *different* hack; but the difference isn't really importnat"],[6596,1,""],[6595,1,""],[6594,1,""],[6594,0,"ant)"],[6597,0,"."],[6581,6,""],[6581,0,"actually"],[6581,8,""],[6580,1,""],[6590,0," here"],[6518,0," is identical, except that it"],[6559,0," problem"],[6591,1,""],[6591,0,"."],[6592,6,""],[6592,0," T"],[6587,4,""],[6587,0,"tweak"],[6515,0,"If you're curious, "],[6550,1,""],[6550,0,","],[6515,19,""],[6587,5,""],[6587,0,"hack"],[6587,4,""],[6587,0,"trick"],[5974,13,""],[5974,0,"neat hack"],[6583,5,""],[6583,0,"hack"],[7457,0," wh"],[7459,1,""],[7459,0,"hile writing a p"],[7457,18,""],[7712,0,", so I'm no t"],[7724,1,""],[7723,1,""],[7723,0,"t too worried"],[7769,5,""],[7769,0," taken to "],[7778,1,""],[7786,1,""],[7785,1,""],[7784,1,""],[8504,0," not"],[8508,6,""],[8508,0," "],[8508,1,""],[8438,0," editing trace"],[8455,0," a javascript string"],[8475,11,""],[8484,33,""],[8486,0,"we can't merge concud"],[8506,1,""],[8506,0,"rrent edits but"],[8521,43,""],[8521,0," its "],[8525,1,""],[8521,4,""],[8521,0,"it might not concurrent edits but its slow:"],[8517,4,""],[8511,6,""],[8506,5,""],[8506,0,"d"],[8500,7,""],[8494,6,""],[8488,6,""],[8486,2,""],[8484,0,", using a javascript string, well"],[8475,0," javascript"],[8468,7,""],[8457,11,""],[8455,2,""],[8446,6,""],[8438,8,""],[8508,0," "],[8508,1,""],[8508,0," allow"],[8504,4,""],[7784,0,"ing"],[7784,3,""],[8504,0," not"],[8504,4,""],[8504,0," not"],[8508,6,""],[8508,0," "],[8508,1,""],[8438,0," editing trace"],[8455,0," a javascript string"],[8475,11,""],[8484,33,""],[8486,0,"we can't merge concud"],[8506,1,""],[8506,0,"rrent edits but"],[8521,43,""],[8521,0," its "],[8517,9,""],[8517,0,". But its a lt"],[8530,1,""],[8530,0,"ot faster:"],[8853,25,""],[8853,0,"A tree is "],[8862,1,""],[8855,9,""],[8855,0,"T"],[8853,3,""],[8853,0,"The d"],[8871,1,""],[8871,0," "],[8871,1,""],[8857,0,"tree based "],[8882,0," isn't very fast"],[9409,0," "],[9409,1,""],[9420,19,""],[9420,0," does that"],[8882,16,""],[8882,0," automerge uses gets big and slow"],[8906,14,""],[8903,3,""],[8903,0,"huge"],[9900,16,""],[9900,0,"the"],[9918,0," has the right approach"],[10016,0,". Fix the core algorihtm and"],[10031,13,""],[10031,0,"an"],[10032,1,""],[10032,0,"lgorithm and data "],[10049,1,""],[10049,0,"structures"],[10049,0," "],[10060,0,". Then "],[10062,5,""],[10062,0,"b"],[10062,1,""],[10061,1,""],[10060,1,""],[10060,0," before moving to optimizing individual methods"],[10137,4,""],[10137,0,"a function"],[10153,6,""],[10153,0,"it won't survive"],[10161,8,""],[10155,6,""],[10153,2,""],[10153,0,"you're"],[10195,0," anyway"],[10205,0,"But by far, "],[10292,7,""],[10292,0,"replaci"],[10298,1,""],[10298,0,"e it with something faster."],[12009,4,""],[12009,0,"in the same way"],[12076,4,""],[12076,0,"once"],[12085,2,""],[12085,0,"understand it"],[12108,2,""],[12108,0,"implement"],[12319,0,"'re curious and"],[12339,22,""],[12351,0,"s"],[12351,1,""],[12225,0,", both in the same"],[12225,18,""],[13286,4,""],[13286,0,"my reference-crdts"],[13342,16,""],[13341,1,""],[13427,0,"Its not exactly like-for-like - I'mn"],[13462,1,""],[13462,0," not impleenting "],[13459,20,""],[13459,0,"my o"],[13462,1,""],[13462,0,"implementi"],[13471,1,""],[13471,0,"ation also doe"],[13477,8,""],[13477,0,"doesn't use immutablejs. But"],[13505,4,""],[13505,0," my code, using t"],[13521,1,""],[13520,1,""],[13520,0," this"],[13534,0,","],[13536,3,""],[13536,0,"ends up "],[13560,1,""],[13560,0,". Its also"],[13570,9,""],[13911,215,""],[13459,0,"for example, "],[13573,0," than automerge"],[14107,0,"base"],[14760,0," going to"],[14782,17,""],[14782,0,"(*"],[14783,1,""],[14782,1,""],[14782,0,"("],[14782,1,""],[14782,0,"*jere"],[14786,1,""],[14785,1,""],[14784,1,""],[14783,1,""],[14783,0,"here*"],[14753,37,""],[14753,0,"thats a problem for another day.)"],[15209,1,""],[15208,1,""],[15208,0,"75"],[15826,0,"Wait, no - "],[15837,6,""],[15878,22,""],[15878,0," stick around"],[16011,0,"The a"],[16015,1,""],[16015,0,"system starts off fast, but it gets slower with every keystroke"],[16078,27,""],[16011,4,""],[16011,0,"This "],[16126,0,"\n\n"],[16127,1,""],[16127,0,"> Insert diagram"],[16136,0,"n^2 "],[16147,0,"?"],[16129,7,""],[16129,0,"Can has, "],[16737,0,". This is faster"],[16753,2,""],[16788,0," "],[16788,1,""],[16781,0,"you to "],[16794,15,""],[16197,0," And by we, I mean yjs has fixed these problems. So l"],[16249,1,""],[16249,0,"what did it do?"],[16246,17,""],[16246,0,"How did it mak"],[16257,3,""],[16257,0,"do that"],[16355,0,"Yjs "],[16359,7,""],[16364,0,"s"],[16437,0,"ever"],[16437,4,""],[16454,9,""],[16454,0,"the document"],[16477,0," try to"],[16478,6,""],[16477,1,""],[16485,0,"something later"],[16500,5,""],[16505,13,""],[16504,1,""],[16503,1,""],[16502,1,""],[16502,0,"they probably"],[16506,0,"'ll"],[16558,0,". So the system"],[16573,4,""],[16583,0,"s"],[16574,0,"usually "],[16593,6,""],[16619,5,""],[16619,0,"the cached location"],[16639,1,""],[16639,0,"\n\n"],[16640,1,""],[16639,1,""],[16639,0," "],[16670,0," (and it probably owu"],[16690,1,""],[16689,1,""],[16689,0,"wo"],[16690,1,""],[16689,1,""],[16689,0,"wo"],[16690,1,""],[16689,1,""],[16688,1,""],[16688,0,"wouldn't work as well for non-text-editing applications)"],[16745,1,""],[16744,1,""],[16744,0,". B"],[16747,1,""],[17740,0," \""],[17741,1,""],[17740,1,""],[17739,1,""],[17738,1,""],[17738,0,"\"run\" is"],[17742,1,""],[17738,1,""],[17720,42,""],[17720,0,"This is  j"],[17729,1,""],[17728,1,""],[17728,0,"just a compressed version of what we wrote"],[17770,17,""],[17776,0,"."],[17778,7,""],[17778,0,"T"],[17805,0,"all "],[17842,0," "],[17842,1,""],[17842,0,". ("],[17844,1,""],[17843,1,""],[17843,0," (We assume each parent is the"],[17855,18,""],[17855,0,"the ids got up"],[17868,1,""],[17867,1,""],[17866,1,""],[17865,1,""],[17865,0," up by 1 each time, and each item has thepre"],[17908,1,""],[17907,1,""],[17906,1,""],[17906,0," previous item as a"],[17898,27,""],[17898,0,"'s parent is the previous item)"],[18109,15,""],[18109,0,"needs"],[18201,1,""],[18200,1,""],[18200,0,","],[18201,49,""],[18201,0," "],[18157,0,"later "],[18208,0,"so the logic is a bit complex."],[18240,0,"But "],[18244,1,""],[18244,0,"i"],[18260,0,"ing"],[18247,4,""],[18247,0,"this "],[18269,0," set"],[18324,4,""],[18324,0,"array"],[18356,1,""],[18355,1,""],[18354,1,""],[18353,1,""],[18352,1,""],[18351,1,""],[18998,0,", but"],[19003,3,""],[19003,0," i"],[19958,4,""],[19958,0,"reclaim"],[19965,6,""],[19965,0," the"],[19958,11,""],[19958,0,"claim the "],[19967,1,""],[19979,0," crown back"],[21597,12,""],[21597,0,"so rarely"],[21647,0,"*"],[21686,0,"*"],[21789,0,". n"],[21791,1,""],[21790,1,""],[21790,0," And this code will be used"],[21805,12,""],[21805,0,"should be fast for intera"],[21824,6,""],[21824,0,"stuf "],[21828,1,""],[21824,4,""],[21824,0,"non-text e"],[21833,1,""],[21832,1,""],[21832,0,"-editing tasks."],[21847,5,""],[21847,0,"I"],[21848,2,""],[21869,0," have to"],[21880,0," one of"],[21899,5,""],[21899,0,"document "],[22150,4,""],[22150,0,"your"],[22208,0,", just from "],[22208,12,""],[22297,0," in the last few years"],[22324,16,""],[22365,0,", even we"],[22373,1,""],[22373,0,"hen making webpages"],[22356,10,""],[22356,0,"."],[22358,1,""],[22358,0,"E"],[22383,1,""],[22383,0,","],[22385,1,""],[22385,0,"w"],[22404,1,""],[22404,0,"!"],[23036,0," that means wec"],[23050,1,""],[23050,0," can find any ti"],[23065,1,""],[23064,1,""],[23064,0,"item in"],[23071,19,""],[23071,0," about"],[23085,0," from main memory"],[23102,17,""],[23115,3,""],[23158,0,"."],[23160,16,""],[23160,0,"Again,"],[23214,0,"shuffling everything in a "],[23240,5,""],[23554,1,""],[23553,1,""],[23552,1,""],[23551,1,""],[23551,0," it uet"],[23557,1,""],[23556,1,""],[23555,1,""],[23555,0,"yet."],[23651,0,"Each leaf noe"],[23663,1,""],[23663,0,"de in my b-tree "],[23679,4,""],[23685,1,""],[23684,1,""],[23683,1,""],[23683,0,"es"],[23685,26,""],[23696,18,""],[23696,0,", all "],[23696,6,""],[23686,0,"a block of "],[23707,0,", all packed together in memory"],[23898,9,""],[23898,0,"clock cycle"],[23909,1,""],[23909,0,". Not"],[23914,14,""],[27669,13,""],[27886,3,""],[27886,0,"but we're"],[27869,5,""],[27869,0,"our"],[27881,1,""],[27881,0,"ies"],[27889,6,""],[27869,4,""],[27869,0,"what we"],[27876,11,""],[27876,0," obsess over"],[27927,0," I can code p"],[27939,1,""],[27939,0,"well enough "],[27950,1,""],[27950,0,", but do't"],[27959,1,""],[27958,1,""],[27958,0,"n't"],[27956,5,""],[27956,0,"I still get zuccini and cucubmer "],[27988,1,""],[27987,1,""],[27986,1,""],[27985,1,""],[27984,1,""],[27984,0,"mber mixed up"],[27971,1,""],[27971,0,"h"],[27971,1,""],[27971,0,"c"],[27857,0,"."],[27859,1,""],[27859,0,"We're all"],[27882,0,"ever"],[27865,4,""],[28006,0,"."],[28333,9,""],[28329,4,""],[28329,0,"the algorithms were too "],[28364,22,""],[28364,0," for practical "],[28365,14,""],[28353,0,"slow and "],[28374,0,"to be practical"],[28390,74,""],[28380,9,""],[28380,0,"useful"],[28486,8,""],[28486,0,"dim"],[28488,1,""],[28488,0,"smissed "],[28545,0," writing (and"],[28557,1,""],[28556,1,""],[28555,1,""],[28554,1,""],[28553,1,""],[28546,0,"reading and "],[28543,2,""],[28543,0,"when it comes to"],[28559,20,""],[28737,6,""],[28737,0,"make"],[28767,0," work"],[29148,11,""],[29148,0,"I do well enough with my ne"],[29148,27,""],[29148,0,"But me? I don't mik"],[29166,1,""],[29166,0,"nd kids"],[29148,8,""],[29149,0,"'m ok at"],[29157,11,""],[29148,0,"M"],[29148,1,""],[29148,0,"Me? "],[29155,3,""],[29155,0," fine"],[29160,8,""],[29160,0," with kids"],[29175,0," -"],[29176,1,""],[29175,1,""],[29206,6,""],[29206,0,"p"],[29206,1,""],[29206,0,"software "],[29512,19,""],[29523,3,""],[29527,0," super fast CRDTs for the world"],[29488,8,""],[29488,0,"o"],[29488,1,""],[29488,0,"go looking for the"],[29522,0,". In th"],[29524,5,""],[29523,1,""],[29523,0," In this case,"],[29531,6,""],[29526,5,""],[29523,3,""],[29523,0," In th"],[29526,3,""],[29523,3,""],[29522,1,""],[29502,4,""],[29502,0," the"],[29522,0,"."],[29516,0,"of fast CRDTs "],[29529,54,""],[29499,0,"inside "],[28308,4,""],[28308,0,"ah"],[28309,1,""],[28309,0,"sh"],[28379,6,""],[28379,0,"practically useful"],[28492,3,""],[15839,0,"'"],[1143,0,"indivdiual "],[1143,11,""],[1143,0,"individual "],[1183,8,""],[1183,0," operations"],[1230,3,""],[1230,0,"Do'h"],[1565,0,"that these speed"],[1576,5,""],[1576,0,"benchmark s"],[1576,11,""],[1576,0,"published sp"],[1586,2,""],[1586,0,"algorithm speeds are "],[1607,7,""],[1606,1,""],[1718,0,"\""],[1767,0,"\""],[1747,0," everybody"],[1778,0,"-"],[1778,1,""],[1778,0," - but I didn't have a "],[1786,15,""],[1786,0," was nobody, "],[1798,1,""],[1797,1,""],[1797,0,"; "],[1798,1,""],[1797,1,""],[1797,0,". I didn't have a scientific "],[1815,11,""],[1815,0,"published paper justifying my claims. Just working code."],[1853,0,"("],[1872,0,"..)"],[1852,23,""],[1585,10,""],[1591,1,""],[1591,0," cmp"],[1594,1,""],[1593,1,""],[1593,0,"omparisons"],[1667,0,","],[1667,1,""],[1706,0,"university "],[1716,1,""],[1706,10,""],[3379,5,""],[3379,0,"a decade"],[3389,0,"'ve"],[3392,7,""],[3392,0," been"],[3404,1,""],[3403,1,""],[3403,0,"ing"],[3449,15,""],[3449,0,"CRDTs. That they were doomed to always be slow and unwor"],[3504,1,""],[3504,0,"rkable"],[3515,0," - and"],[3537,0," to admit"],[3048,18,""],[3048,0,"Making CRDTs"],[3048,12,""],[3048,0,"Mak"],[3050,1,""],[3049,1,""],[3048,1,""],[3048,0,"Imple"],[3046,7,""],[3045,1,""],[3044,1,""],[1438,7,""],[1438,0,"sending me links to"],[1531,0,"a "],[1556,0,","],[1557,9,""],[1673,3,""],[1673,0," in"],[1859,0," I had some "],[1866,5,""],[1866,0,"working code but - "],[1884,1,""],[1883,1,""],[1882,1,""],[1882,0," nobo"],[1883,4,""],[1883,0,"I"],[1883,1,""],[1883,0,"it felt like nobody cared about htat."],[1915,5,""],[1915,0,"that."],[1903,0,"really "],[1896,6,""],[1896,0,"none of the smart science people"],[1914,7,""],[1914,0,"computer sicnec"],[1928,1,""],[1927,1,""],[1926,1,""],[1925,1,""],[1924,1,""],[1924,0,"cience"],[1937,7,""],[1791,14,""],[1941,0," I was nobody. "],[1955,1,""],[1955,0,"\n\nAnd I "],[1960,3,""],[1960,0,", at some point around then, I dismissed CRDTs altogether. If the researchers involved "],[2038,9,""],[2038,0,"who invented them couldn't make them fast, who was I?"],[2093,0,"But "],[2097,1,""],[2097,0,"w"],[1962,20,""],[1962,0,"somewhere around that time"],[1988,6,""],[2092,0,"\n"],[2092,0,"\n---"],[2098,5,""],[2098,0,"W"],[1956,135,""],[1955,1,""],[2477,3,""],[2477,0,"show that"],[2502,22,""],[2502,0," "],[2502,1,""],[2534,12,""],[2534,0,"actually showing"],[2550,6,""],[2551,36,""],[2543,8,""],[2543,0,"proving? It seems like tests - you can prove the absence of bugs, but th"],[2614,1,""],[2613,1,""],[2592,7,""],[2592,0,"existence "],[2601,1,""],[2615,0,"not their absence. P"],[2634,1,""],[2634,0,"Benchmarks feel like that too - you can prove the "],[2680,4,""],[2680,0,"fast code is possible, but "],[2680,9,""],[2680,0,"speed ups"],[2689,3,""],[2689,0," are"],[2708,0,"you can't prove something is slow."],[2737,0,"inherently "],[3064,5,""],[3064,0,"W"],[2551,202,""],[3088,0,"\n\n It seems like tests - you can prove the existence of bugs, but not their absence. Benchmarks feel like that too - you can prove speed ups are possible, but you can't prove something is inherently slow."],[3090,14,""],[3090,0,"Maybe benchmarks"],[3090,16,""],[3090,0,"There's a rule with"],[3100,9,""],[3100,0,"saying about"],[3117,1,""],[3117,0,"ing:"],[3122,2,""],[3122,0,"\""],[3123,1,""],[3123,0,"Y"],[3160,7,""],[3159,1,""],[3158,1,""],[3158,0,". You can't "],[3123,0,"Tests can "],[3133,8,""],[3162,4,""],[3162,0,"They ca"],[3168,1,""],[3167,1,""],[3173,0,"prove"],[3192,0,"\""],[3220,4,""],[3281,29,""],[3281,0,"an algorithm will always be slow."],[3294,12,""],[3294,0,"has to "],[2477,4,""],[2477,0,"say"],[2486,15,""],[2486,0,"an"],[2477,3,""],[2476,1,""],[2475,1,""],[2474,1,""],[2474,0,"our implementation run s"],[2497,1,""],[2496,1,""],[2496,0,"s"],[2497,21,""],[2502,0,"ly"],[2537,10,""],[2538,0,"'ve"],[2556,0,"old "],[2650,3,""],[2650,0,"is"],[2683,11,""],[2682,1,""],[2705,0,"runs "],[2834,0,"\n"],[2834,0,"\nIf you ma"],[2835,9,""],[2835,0,"But if you made a chart of that \"Ot-text is fast, and ot-text is slow\""],[2835,31,""],[2835,0,"It would be silly making a chart showing how"],[2881,3,""],[2885,0,"-t"],[2886,1,""],[2886,0,"ot"],[2880,1,""],[2890,0," both"],[2900,16,""],[2900,0," and"],[2909,1,""],[2909,0,". The difference is in the implementation. And thats true here too - "],[2835,143,""],[2835,0,"It would be silly making a chart showing how text-ot is both fast and slow. The difference is in the implementation. And thats true here too -"],[1382,48,""],[1382,0,"The annoying part was when"],[1415,8,""],[1415,0," sent around"],[1427,3,""],[1463,6,""],[1463,0,"asked"],[1536,18,""],[1570,3,""],[1570,0,"seem like"],[1582,1,""],[1582,0,"f"],[1587,1,""],[1587,0,"o"],[1590,1,""],[1590,0,"t"],[1594,1,""],[1594,0,"u"],[1640,2,""],[1640,0,"of"],[1614,0," what they were"],[1628,1,""],[1627,1,""],[1626,1,""],[1625,1,""],[1625,0,"really wor"],[1634,1,""],[1633,1,""],[1633,0,"ere -"],[1672,0,"java "],[1681,0,","],[2176,5,""],[2176,0,"aspects"],[2467,66,""],[2467,0,"W"],[2467,1,""],[2467,0,"When our implementation runs slowly, what are we actually proving?"],[2504,29,""],[2504,0,"we "],[2506,1,""],[2505,1,""],[2504,1,""],[2504,0,"I don't know if t"],[2520,1,""],[2520,0,"wher"],[2523,1,""],[2522,1,""],[2521,1,""],[2521,0,"e're proving anything about the semantics."],[2553,0,"res"],[2555,1,""],[2554,1,""],[2553,1,""],[2562,0," involved"],[2504,68,""],[2504,0,"what does that mean?"],[2504,19,""],[2504,0,"is that meaningful"],[2504,18,""],[2504,0,"does that teach us anything"],[2504,27,""],[2504,0,"what should "],[2502,14,""],[2467,0,"What s"],[2472,1,""],[2472,0,"can we learn from "],[2490,23,""],[2490,0,"a slow"],[2496,12,""],[2496,0," implementation"],[2512,0," Maybe its like tests - a passing test suite doesn't prove the absence of bugs. It just proves you aren't l"],[2618,1,""],[2592,26,""],[2591,1,""],[2557,5,""],[2557,0,"cant"],[2560,1,""],[2589,0," And a slow implementation p"],[2616,1,""],[2616,0,"sa"],[2617,1,""],[2617,0,"uggests the semantics"],[2629,9,""],[2629,0,"system is slow - ut "],[2648,1,""],[2647,1,""],[2646,1,""],[2646,0,"but it only proves"],[2616,48,""],[2615,1,""],[2557,0,"suggests, but "],[2629,0," suggests, but can't prove the system will always be slow."],[2575,1,""],[2574,1,""],[2574,0," never"],[2652,1,""],[2652,0," "],[2652,1,""],[2651,1,""],[2651,0," never"],[2995,143,""],[2994,1,""],[3071,0,"Maybe its worse - maybe "],[3095,4,""],[3099,0," had"],[3103,5,""],[3178,0,"have "],[3187,0,"ed"],[3248,221,""],[1952,0,"\n"],[1952,0,"\na"],[1953,1,""],[1953,0,"Some time around then I "],[1953,24,""],[1952,1,""],[1951,1,""],[3555,0," an"],[3557,1,""],[3556,1,""],[3555,1,""],[3735,8,""],[3959,0,"And "],[3963,1,""],[3963,0,"w"],[4644,9,""],[4656,8,""],[4656,0,"?"],[5559,0,"  "],[5607,0,"    "],[5919,0,"  "],[5873,0,"  "],[5827,0,"  "],[5925,0,"  "],[6250,21,""],[6250,0,"we can't sort them bae"],[6271,1,""],[6271,0,"sed on their ID."],[6286,1,""],[6286,0,", because the X *has to* go before the b"],[6249,77,""],[6249,0," then the document might end up as"],[6802,1,""],[6801,1,""],[6801,0,"Its the algorithmic version of "],[6918,6,""],[6744,0,"  "],[6688,0,"  "],[6632,0,"  "],[6750,0,"  "],[7006,1,""],[6996,1,""],[6952,0," to RGA"],[6956,3,""],[6956,0,"a"],[6956,1,""],[6956,0,"a"],[6956,1,""],[6956,0,"RGA"],[6939,0," is im"],[6944,1,""],[6943,1,""],[6942,1,""],[6941,1,""],[6940,1,""],[6940,0,"implements a librar"],[6953,6,""],[6952,1,""],[6952,0," CRDT called YATA which"],[7038,0," slightly"],[6939,0," - which we'll see more of later -"],[7003,0,". YATA is"],[7012,9,""],[7568,0,"thats what automerge does"],[7593,2,""],[7593,0,"so"],[7588,5,""],[7578,10,""],[7573,5,""],[7568,5,""],[7801,1,""],[363,1,""],[362,1,""],[362,0,", using various "],[387,1,""],[405,2,""],[405,0,"."],[407,1,""],[407,0,"A"],[979,4,""],[978,1,""],[969,4,""],[974,0," was going on"],[986,1,""],[986,0,"n"],[1420,4,""],[1420,0,"that several"],[1444,7,""],[1444,0," me"],[1594,0,"ed"],[1624,0,". And not"],[1633,12,""],[1737,0,", rushing"],[1739,7,""],[1739,0,"who'"],[1742,1,""],[1742,0," has a bunch of im"],[1755,5,""],[1755,0,"more implementations to code up"],[1814,4,""],[1814,0,"right"],[1851,1,""],[1850,1,""],[1850,0,"."],[1852,1,""],[1852,0,"B"],[2006,0,"Who was I? "],[2031,0,"\n"],[2031,0,"\n"],[1799,0," peer reviewed"],[2046,1,""],[2045,1,""],[2673,0," quite"],[2763,0,"that this "],[2773,3,""],[2772,1,""],[2802,0,"But "],[2810,0," trie"],[2810,5,""],[2882,0,"The "],[2882,4,""],[2882,0,"I o"],[2884,1,""],[2884,0,"took the same semantis"],[2905,1,""],[2905,0,"cs, and the s"],[2917,2,""],[2917,0,"s"],[2931,0,"."],[2933,3,""],[2933,0,"B"],[3008,4,""],[3008,0,"ran"],[3221,1,""],[3221,0," was"],[3316,0," woiu"],[3320,1,""],[3319,1,""],[3318,1,""],[3318,0,"ould have totally"],[3335,11,""],[3359,1,""],[3359,0,"."],[3361,17,""],[3361,0,"I"],[3383,0," from just reading tha p"],[3406,1,""],[3405,1,""],[3404,1,""],[3404,0,"e paper"],[3414,3,""],[3414,0,"# Making CRDTs fast"],[3615,0," the future of"],[3633,4,""],[3764,5,""],[3764,0," I assumed"],[3774,19,""],[3767,0,"dismissed them, "],[3766,0," stop "],[3771,1,""],[3771,0,"ped reading papers and"],[3783,0,"academic "],[3859,10,""],[3858,1,""],[3858,0,". A GUID a"],[3867,1,""],[3867,0,"for every character? Madness!"],[3896,1,""],[3897,55,""],[3896,1,""],[4096,15,""],[4096,0," how to make those"],[4114,10,""],[4101,0,"the best way to "],[4117,14,""],[4118,15,""],[4118,0,"implement"],[4129,3,""],[6435,4,""],[6435,0,"if i"],[6438,1,""],[6438,0,"we do that"],[6481,1,""],[6482,0,"X"],[6531,0," That would be super wrong."],[6543,14,""],[6543,0,"really"],[6543,0,"be "],[6552,0," confusing"],[8248,21,""],[8248,0,"a record of"],[8250,0,"character by character "],[8273,6,""],[8273,0,"recording"],[8486,0," about that"],[8616,0,"'s"],[11050,5,""],[11050,0,"And we can "],[11190,2,""],[11190,0,"in"],[11429,0,", as we'll see soon"],[12916,8,""],[12916,0,"insert function in"],[12982,0,"'s "],[12984,1,""],[12984,0," cR"],[12986,1,""],[12985,1,""],[12985,0,"CRDT (YATA)"],[10388,0," I've been told its about 5x faster, but I haven't "],[10429,10,""],[10429,0,"I couldn't get the version in git working."],[10392,1,""],[10391,1,""],[10391,0,"m"],[10392,5,""],[1604,1,""],[1604,0,"F"],[1609,2,""],[1609,0,"bo"],[1610,1,""],[1609,1,""],[1609,0,"about"],[1609,18,""],[1609,0,"About The Universe"],[1661,3,""],[1682,0,"s"],[1715,1,""],[1715,0," probably"],[1724,11,""],[1724,0," overstretched"],[1749,1,""],[1749,0,". One of a "],[1760,11,""],[1765,5,""],[1765,0," of"],[1785,2,""],[1785,0,"they needed to"],[1760,0,"whole "],[2827,0," With time there's always"],[2828,5,""],[2828,0,"If you wait long enouu"],[2849,1,""],[2849,0,"gh "],[2851,1,""],[2851,0,", "],[2853,5,""],[2867,0," more bugs. And always bigger smart-arses with faster im"],[2909,14,""],[2909,0,"w"],[2909,1,""],[2909,0,"to "],[2890,22,""],[2890,0,"new ways to do "],[2890,15,""],[2890,0,"faster implementations."],[2915,4,""],[2991,15,""],[2991,0,"I"],[2991,1,""],[2991,0,"Each implementation has the same"],[3339,22,""],[3339,0,"M"],[3344,0,", without noticing,"],[3433,50,""],[3487,0,"\n"],[3486,0," Benchmarking is an art, not a sciecne"],[3523,1,""],[3522,1,""],[3521,1,""],[3487,34,""],[3486,1,""],[3630,1,""],[3676,1,""],[3890,1,""],[3890,0,". I"],[3902,6,""],[3902,0,"CRDTs had"],[3911,3,""],[3963,0,"Only "],[3968,1,""],[3968,0,"m"],[3975,0," comes from those tunnels"],[3993,7,""],[3993,0,"lands"],[4113,0," h"],[4114,1,""],[4114,0,"which described"],[4129,14,""],[4172,1,""],[4171,1,""],[4170,1,""],[4169,1,""],[4169,0,". And I"],[4184,1,""],[4183,1,""],[4182,1,""],[4182,0,"ed"],[4159,10,""],[4159,0,"systems"],[3963,4,""],[3963,0,"Naught but "],[3973,1,""],[3999,5,""],[3999,0,"strange lands"],[10541,42,""],[10535,6,""],[10535,0,". I ran an early benchmark and it was barely f"],[10569,12,""],[10569,0,"glig"],[10572,1,""],[10571,1,""],[10570,1,""],[10569,1,""],[10569,0,"slightly faster"],[10569,0,"only "],[10535,1,""],[10535,0,", but"],[10570,23,""],[10570,0,"performance was almost h"],[10593,1,""],[10593,0,"the same. I'm going to "],[10586,30,""],[10586,0,"remarkably close to the javascript version - so "],[10606,0,"that of "],[10636,6,""],[10636,0,"."],[10541,96,""],[10541,0,"performance in this test was almost the same as the JS version."],[10456,0," to run through wasm"],[10555,5,""],[10555,0,". I ran the "],[10555,0,", but I see similar "],[10575,12,""],[10574,1,""],[10567,8,""],[10561,0,"at the moment "],[10576,0,"'m "],[10578,1,""],[10582,0,"ing"],[10561,88,""],[10561,0,"I'm not seeing much improvement using it yet. I suspect thin"],[10620,1,""],[10619,1,""],[10619,0,"ey have some kinks to work out before its redad"],[10665,1,""],[10664,1,""],[10663,1,""],[10663,0,"ady for release."],[10616,5,""],[10616,0," it"],[10619,5,""],[10619,0," has"],[10561,44,""],[10561,0,"I couldn't"],[10563,8,""],[10562,1,""],[10561,1,""],[10561,0,"it ran slower than that in my tests"],[10568,0,"a fair bit "],[10677,1,""],[10677,0,"; and I'll hold off on adding benchmarks at"],[10719,1,""],[10718,1,""],[10718,0,"until then."],[10561,29,""],[10561,0,"d"],[10561,1,""],[10561,0,"it didn't run that fast"],[10584,5,""],[10608,2,""],[10608,0,"they"],[10613,4,""],[10613,0,"have "],[10669,1,""],[10669,0,","],[10689,3,""],[10695,0," them to my little table"],[10719,11,""],[10689,31,""],[10689,0,"adding b"],[10696,1,""],[10696,0,"them to my table "],[10707,5,""],[10707,0,"results table"],[10539,0," supposed to be"],[10554,6,""],[10564,0," or so"],[10663,14,""],[10670,62,""],[10671,0,"\n\n---"],[9733,0," Automerge stores st"],[9752,1,""],[9751,1,""],[9751,0,"too many objects "],[9767,1,""],[9744,0,"creates and "],[9779,0,"'"],[9743,0,"'"],[9744,36,""],[9744,0,"s data structure is slow"],[9768,1,""],[9768,0,"."],[9746,0,"core "],[9769,60,""],[9768,1,""],[9768,0,"n't "],[9771,1,""],[9770,1,""],[9769,1,""],[9768,1,""],[9768,0," too l"],[9773,1,""],[9773,0,"slow."],[9768,4,""],[9751,0,"tree based "],[9780,0,"hug"],[9780,3,""],[9777,3,""],[9777,0,"gets big and "],[9794,0," as the document grows"],[10701,5,""],[10741,6,""],[10740,1,""],[10740,0," tuning"],[10767,9,""],[10767,0,"the computer run"],[10809,4,""],[10809,0," it"],[10812,9,""],[10783,1,""],[10782,1,""],[10781,1,""],[10780,1,""],[10955,0," small"],[11017,25,""],[11017,0,"I"],[13618,0," The yjs version is slightly different"],[13638,18,""],[13638,0,"almost identical."],[13638,16,""],[13638,0,"in the same file, if you want to ah"],[13672,1,""],[13671,1,""],[13671,0,"have a look. They're almost identica"],[13699,8,""],[13699,0,"impossil"],[13706,1,""],[13706,0,"ble to tell apart"],[13699,24,""],[13699,0,"identical"],[13683,0," Despite being very diffi"],[13707,1,""],[13707,0,"erent papers, the implementations"],[13740,8,""],[13740,0," are"],[13725,15,""],[13725,0,"semantics are"],[13737,1,""],[13736,1,""],[13735,1,""],[13734,1,""],[13635,0,"of this function "],[13742,9,""],[13742,0,"lig"],[13744,1,""],[13743,1,""],[13743,0,"ogic is"],[13750,4,""],[13747,0," for inserting"],[14335,0,"the "],[14374,0," codebases"],[14375,9,""],[14375,0,"code"],[14651,8,""],[14651,0,"Their "],[14695,0," (And it will be until "],[14712,6,""],[14712,0,"eh"],[14713,1,""],[14712,1,""],[14712,0,"whenever users don't"],[14695,37,""],[14697,0,"Mode"],[14700,1,""],[14699,1,""],[14698,1,""],[14698,0,"y code is "],[14704,4,""],[14704,0,"base os ob"],[14713,1,""],[14712,1,""],[14711,1,""],[14710,1,""],[14709,1,""],[14709,0,"is obviousy"],[14719,1,""],[14719,0,"ly "],[14722,31,""],[14722,0,"very different from automerge."],[14753,1,""],[14753,0,"F"],[14765,26,""],[14765,0," I'm not using"],[14779,4,""],[14712,25,""],[14711,1,""],[14710,1,""],[14709,1,""],[14709,0,"has lots of differences "],[14737,0," the real"],[14756,0," library"],[14769,9,""],[14769,0," instance,"],[14769,10,""],[14769,0," example,"],[14756,8,""],[14741,5,""],[14737,4,""],[14732,1,""],[14720,12,""],[14717,3,""],[14712,5,""],[14709,3,""],[14709,0,"is obviously very different "],[14779,0," use"],[14773,6,""],[14769,4,""],[14765,4,""],[14765,0," my implementation doesn't"],[14753,1,""],[14753,0,"f"],[14741,11,""],[14736,5,""],[14726,10,""],[14722,4,""],[14722,0,"Its not exactly like-for-like -"],[14721,1,""],[14719,2,""],[14719,0,"y"],[14711,9,""],[14709,2,""],[14709,0,"os ob"],[14711,3,""],[14708,3,""],[14704,4,""],[14704,0," is "],[14707,1,""],[14704,3,""],[14699,5,""],[14698,1,""],[14698,0,"ode"],[14697,92,""],[15120,0,"\nBut a lot of that difference really is immutablejs.\n"],[15121,0,"("],[15121,1,""],[15121,0,"(But bear in mind there's only so much we can conclude from this. "],[15186,1,""],[15185,1,""],[15185,0," about the data"],[15121,79,""],[15121,0,"I wish I could take full c "],[15136,11,""],[15136,0,"give Kevin's approach"],[15135,22,""],[15135,0," attribute all of that to this sweet data structure. "],[15187,1,""],[15238,0," gumming up th eworke"],[15258,1,""],[15252,6,""],[15252,0,"e works"],[15205,0," performance"],[15271,0," "],[15271,1,""],[15205,12,""],[15259,0," for automerge"],[14770,0,", and 30x more"],[14784,15,""],[15156,0," diffee"],[15162,1,""],[15162,0,"rence"],[15175,0," super"],[15182,5,""],[15182,0,"simple"],[15176,12,""],[15176,0,"sweet and simple"],[15260,24,""],[15259,1,""],[15259,0," making"],[15267,0,"everything "],[15287,0," does slower"],[15298,1,""],[15297,1,""],[15287,10,""],[15267,11,""],[15276,0," slow"],[15267,0,"all of "],[15283,0,"'s code"],[15295,0,"dow"],[15297,1,""],[15296,1,""],[15295,1,""],[15295,0," down"],[15299,1,""],[15298,1,""],[15297,1,""],[15296,1,""],[15295,1,""],[15145,0,"*"],[15149,0,"*"],[15249,0," just"],[15240,10,""],[15257,35,""],[15257,0,"slow"],[15257,0,"being "],[15240,4,""],[15240,0,"is probably attributat"],[15261,1,""],[15260,1,""],[15260,0,"able to"],[15279,11,""],[15279,0," alone"],[15240,27,""],[15240,0,"can probably"],[15244,8,""],[15240,4,""],[15240,0,"is just"],[15247,18,""],[15247,0," automerge's lack of "],[15260,8,""],[15260,0," im"],[15262,1,""],[15261,1,""],[15261,0,"implementations"],[15275,1,""],[15260,1,""],[15274,0," (and immutablejs)"],[15224,4,""],[15224,0,"the"],[15238,0," here"],[15247,5,""],[15247,0,"probably just quirks of "],[15297,0,"."],[15300,0,"Oh, "],[15260,10,""],[15260,0," due to "],[15267,1,""],[15247,9,""],[15247,0,"probabl "],[15254,1,""],[15254,0,"y "],[15260,0," little microoptimizations"],[15286,34,""],[15288,22,""],[15288,0,"My code ex"],[15297,1,""],[15296,1,""],[15295,1,""],[15294,1,""],[15293,1,""],[15292,1,""],[15291,1,""],[15291,0,"implementation executes less code, and "],[15288,42,""],[15287,1,""],[15256,30,""],[15256,0,"from immutablejs"],[15256,4,""],[15256,0,"just"],[15272,0," gumming things up"],[15316,0,"Now that "],[15325,1,""],[15325,0,"w"],[15337,3,""],[15337,0,"a fast"],[15343,8,""],[15339,0,"clean and "],[15316,10,""],[15316,0,"W"],[15355,0," "],[15355,1,""],[15366,0," now"],[20491,0," If there was a programming "],[20507,12,""],[20507,0,"programmer version of speedrunning"],[20529,0,"the "],[20545,0," community, Kevin would be there with bells on."],[20557,34,""],[20557,0,"they would adore KEv"],[20576,1,""],[20575,1,""],[20575,0,"evin"],[20405,4,""],[20405,0,"he rewrote"],[20428,20,""],[20408,0,"wrote and "],[20474,4,""],[20474,0," run"],[20488,14,""],[20488,0,"If there was a"],[22875,0,"would "],[22885,1,""],[22885,0," you"],[22875,0,"like that "],[22904,22,""],[22987,16,""],[22987,0,"as much as possible with each rae"],[23019,1,""],[23018,1,""],[23018,0,"ead to main ma"],[23031,1,""],[23031,0,"emory"],[23273,0," I wannt"],[23280,1,""],[23279,1,""],[23279,0,"t"],[23291,6,""],[23291,0,"to"],[23329,0," "],[23342,0," it"],[23356,7,""],[23355,1,""],[23359,6,""],[23358,1,""],[23768,22,""],[23744,24,""],[23744,0,"been able to improve its performance"],[23736,0,"s"],[23737,33,""],[23737,0," "],[23749,0," ahs"],[23752,1,""],[23751,1,""],[23750,1,""],[23750,0,"hasn't improved"],[23851,0," We "],[23854,1,""],[23853,1,""],[23852,1,""],[23851,1,""],[23766,1,""],[23766,0,"\n\n"],[23851,1,""],[23851,0," these days. We can d"],[23871,1,""],[23871,0,"coe t"],[23875,1,""],[23874,1,""],[23873,1,""],[23873,0,"de this is "],[23883,1,""],[23882,1,""],[23882,0,"n anything."],[23892,0,"*"],[23884,0,"*"],[23881,2,""],[23881,0,"up in"],[24065,0," also"],[24069,1,""],[24068,1,""],[24068,0,"most"],[24060,13,""],[24060,0,"is almos ti"],[24070,1,""],[24069,1,""],[24068,1,""],[24068,0,"t identical to"],[24082,11,""],[24258,1,""],[24258,0,", w"],[24260,1,""],[24260,0,"so we can qui"],[24270,3,""],[24270,0,"find anything "],[24258,26,""],[24258,0,"."],[24172,4,""],[24172,0,"E"],[24204,3,""],[24210,0,"s"],[24629,0," We update a leaf, then its parent, and its parent, all the way up to th eroo"],[24705,1,""],[24704,1,""],[24703,1,""],[24702,1,""],[24701,1,""],[24701,0,"e root"],[24707,22,""],[24708,0," A"],[24709,1,""],[24709,0,"So"],[24712,1,""],[24712,0,"a"],[24653,0,"the"],[24655,1,""],[24654,1,""],[24653,1,""],[24653,0,"the character oun"],[24669,1,""],[24668,1,""],[24667,1,""],[24667,0,"counts at "],[24742,0," after"],[24763,3,""],[24762,1,""],[24837,37,""],[24837,0,"W"],[24837,1,""],[24837,0,"It doesn't come into play here, but w"],[24837,0,"We never merge edits from remote peers in this test,"],[24889,35,""],[24889,0," but I made that fast too anyway."],[24923,1,""],[24923,0,"W"],[24989,0,"eg "],[25049,20,""],[25049,0,"search by ID."],[25039,1,""],[25038,1,""],[25037,1,""],[25037,0,"little "],[25060,0,"the b-tree "],[25154,20,""],[25154,0,"It might help -"],[25171,0," just"],[25602,0," I picked 32 by trying a few numbers"],[25631,0,"different numbers and benchmarking "],[25665,1,""],[25665,0,"."],[25666,7,""],[25666,0," Higher"],[25667,6,""],[25667,0,"T"],[25667,1,""],[25667,0,"32 seems"],[25674,1,""],[25674,0,"ed pretty good."],[25618,35,""],[25630,0," the system with a few different sizes"],[25679,0," to work"],[25694,5,""],[25694,0," well"],[25635,0,"whole "],[26747,33,""],[27673,0,"But "],[27677,1,""],[27677,0,"w"],[27694,4,""],[27902,5,""],[27902,0,"M"],[28002,6,""],[28002,0,"the document"],[28024,0," Ropey on its own takes 29ms to process this string"],[28069,6,""],[28069,0,"docu"],[28069,4,""],[28069,0,"editing trace."],[29220,0," -"],[29222,4,""],[29222,0," "],[29222,1,""],[29222,0," "],[29244,0," are *weird*"],[29325,11,""],[29332,0," in the two b-trees"],[29406,0,"should "],[29418,1,""],[29802,1,""],[29802,0," - to the "],[29802,10,""],[29802,0,"."],[30289,0," turned my back on academia i"],[30317,1,""],[30317,0,"and"],[31178,0," figure out how to"],[31206,5,""],[31237,15,""],[31237,0,"turning toward th"],[31251,3,""],[31244,7,""],[31237,7,""],[31237,0,"doing that work"],[31237,15,""],[31237,0,"answering that call"],[31340,2,""],[31340,0,"start"],[31353,7,""],[31353,0," to a"],[31357,1,""],[31357,0,"make"],[31361,25,""],[31367,0," fast"],[31373,0," And return with the treat"],[31398,1,""],[31398,0,"sure of these algirh"],[31417,1,""],[31416,1,""],[31416,0,"o"],[31416,1,""],[31415,1,""],[31415,0,"orithms. (Well, it took a decade and *k"],[31453,1,""],[31453,0,"Kevin*)"],[31459,0,"."],[31447,0,", some hard work"],[31476,0," Thanks dude!"],[31477,12,""],[31468,0,"some great ideas from"],[31489,1,""],[31489,0," "],[31495,1,""],[31495,0," and Martin"],[31496,0,"Jahns "],[31512,0," Kleppmann"],[31523,1,""],[31423,1,""],[31423,0,"\n\n"],[31425,1,""],[31523,1,""],[31523,0," I couln"],[31530,1,""],[31530,0,"dn't have done it "],[31524,24,""],[31524,0,"Automerge's run-"],[31536,4,""],[31536,0,"document encoding system is fantastic - and "],[31576,4,""],[31575,1,""],[31574,1,""],[31573,1,""],[31573,0,"."],[31524,12,""],[31524,0,"The "],[31552,0," Martin made for Automerge"],[31591,0,", and was the inpsi"],[31609,1,""],[31608,1,""],[31607,1,""],[31607,0,"spiration for Yjs's "],[31621,0,"the euqu"],[31628,1,""],[31627,1,""],[31626,1,""],[31626,0,"quivalent in "],[31644,1,""],[31643,1,""],[31642,1,""],[31643,0," And "],[31644,4,""],[31644,0,"Using incrementing sequence numbers"],[31489,0," a bunch of clever people."],[31515,34,""],[31551,0," Kell"],[31555,1,""],[31554,1,""],[31553,1,""],[31553,0,"leppmann"],[31646,0,"The system of "],[31660,5,""],[31660,0,"using"],[31695,0," instead of UUIDs"],[31696,11,""],[31696,0,"to save storing "],[31704,0,"generating an d"],[31717,1,""],[31718,0," "],[31678,0," (agent id,"],[31698,8,""],[31698,0,") tuples"],[31709,0," avoid"],[31715,5,""],[31744,0," is genius. And"],[31501,0,"other "],[31604,0," it"],[31765,3,""],[31765,0,"I have no idea who came up with that. And Kevin's list approach I describe here is the sort of obvious j"],[31868,1,""],[31860,0,"fantastic, "],[31879,0,"idea that 100 smart p"],[31893,7,""],[31893,0,"p"],[31893,1,""],[31893,0,"smart pp"],[31900,1,""],[31900,0,"eople have surely walked tirhg "],[31925,6,""],[31925,0,"right past without noticing it."],[31501,5,""],[31500,1,""],[31507,7,""],[31507,0," folks"],[31624,4,""],[31624,0," its"],[31592,5,""],[31592,0,"."],[31594,1,""],[31594,0,"I"],[31594,50,""],[31561,4,""],[31561,0,"in"],[31562,1,""],[31561,1,""],[31551,10,""],[31551,0,"invented for"],[31564,4,""],[31753,0,"representi"],[31762,1,""],[31762,0,"ation "],[31768,9,""],[31768,0,"approach "],[31768,9,""],[31845,0,"must "],[31900,0," I don't know"],[31901,12,""],[31901,0,"I don't know that I wouldn't "],[31929,1,""],[31928,1,""],[31927,1,""],[31926,1,""],[31926,0," have thouhg"],[31909,29,""],[31909,0,"think I woul"],[31903,18,""],[31903,0,"think I wouldn't"],[31918,1,""],[31917,1,""],[31916,1,""],[31916,0," have walked right past that "],[31902,43,""],[31902,0," wouldn't have thought of that either."],[31519,8,""],[31519,0,"binary"],[31575,9,""],[31575,0,"brilliant"],[31647,0,"in order "],[31665,23,""],[31670,0," everywhere"],[31691,1,""],[31691,0,", and"],[31738,0," of course,"],[31750,7,""],[31750,0,"The"],[31752,1,""],[31751,1,""],[31750,1,""],[31750,0,"the"],[31773,0," + insertion approack"],[31793,1,""],[31793,0,"h"],[31750,0,"Kevin's "],[31758,3,""],[31757,1,""],[31886,7,""],[31920,3,""],[31922,39,""],[31922,0,"I wouldn"],[31929,1,""],[31929,0," n"],[31930,1,""],[31930,0,"have "],[31929,6,""],[31929,0,"n't have thought of that either."],[31924,8,""],[31924,0,"don't think I would "],[31943,1,""],[31817,12,""],[31827,1,""],[31827,0,". Its the"],[31829,25,""],[31829,0,"I bet"],[31879,0," that iea"],[31887,1,""],[31886,1,""],[31886,0,"dea over the last decade"],[31918,0," any of them"],[31939,0," it"],[31982,11,""],[31982,0,"it either"],[37968,9,""],[37968,0,"Why is"],[37998,15,""],[37998,0,"so slow?"],[38008,9,""],[38019,0,"just "],[38027,5,""],[37968,0,"I don't get it - "],[37985,1,""],[37985,0,"w"],[39399,1,""],[39398,1,""],[39397,1,""],[39396,1,""],[39395,1,""],[39394,1,""],[39394,0,"Im "],[39396,1,""],[39395,1,""],[39395,0,"'m dying."],[39404,5,""],[39403,1,""],[39403,0,"!"],[39394,0,"Stop - "],[39442,4,""],[39545,66,""],[39555,1,""],[39555,0," already has been replaced with w"],[39587,1,""],[39587,0,"automerge-rs"],[39599,8,""],[39599,0," "],[39632,0," So itd "],[39639,1,""],[39638,1,""],[39638,0," doesn' "],[39645,1,""],[39645,0,"t matter"],[39653,70,""],[39653,0,".\n"],[39654,0," Try not to think about it. *Twitch*"],[39683,1,""],[39683,0,"t"],[39689,0,"."],[39681,0," Definitely don't submit any PRs to fi"],[39682,37,""],[39681,1,""],[39681,0," Definitely don't submit any PRs to fix all the low hanging fruit."],[37885,0," Moving from automerge to au"],[37912,1,""],[37911,1,""],[37911,0,"reference-crdts"],[37911,0,"my "],[37929,66,""],[37929,0," changes:\n\n- Core"],[37942,4,""],[37942,0,"The core data structure (list -> "],[37974,1,""],[37973,1,""],[37972,1,""],[37971,1,""],[37967,4,""],[37967,0,"tree to list)\n- Removed immutablejs\n- Removed automerge's frontend / backend protocol\n- Use d"],[38059,1,""],[38058,1,""],[38058,0,"d a different javascript style\n\nWhich "],[38090,6,""],[38090,0,"Which"],[37930,0,"resulted in changes to"],[37952,7,""],[38110,0," of these changes made the"],[38105,31,""],[38105,0,"W"],[38105,1,""],[38105,0,"How can "],[38105,8,""],[38105,0,"The change from reference-crdts to yjs is"],[38145,1,""],[38144,1,""],[38143,1,""],[38143,0,", and yjs to my rust code "],[38115,0,"s"],[38150,0,"from "],[38175,0,"are similarly big. "],[38193,1,""],[38193,0," Its possible I'm mi"],[38194,0,"So "],[38197,1,""],[38197,0,"i"],[38216,0,"sattributing the performance"],[38216,0,"s"],[38216,1,""],[38233,0,"speedups"],[38241,11,""],[38241,0," here; wheras "],[38246,9,""],[38246,0,".\n\nI suppose to answer that"],[38103,0,"\n\nTh"],[38106,1,""],[38105,1,""],[38105,0,"My code"],[38105,7,""],[38105,0,"We got 10x performance from this change. How "],[38146,4,""],[38146,0,"But which ch"],[38156,2,""],[38156,0,"part of this"],[38150,18,""],[38150,0,"to what should we attribute the speedup?"],[38067,0,". And all the Uint8Arrays that appeared"],[38098,8,""],[38098,0,"pop up throughout automerge's "],[38127,1,""],[38126,1,""],[38125,1,""],[38125,0," for whatever reason."],[38229,40,""],[38229,0,"I don't *really* know how to attribute that speedup amongst all the changes."],[38395,54,""],[38391,4,""],[38391,0,"monolo"],[38396,1,""],[38396,0,"ithic."],[38404,24,""],[38404,0,"And yes, this is a reasonabile"],[38433,1,""],[38432,1,""],[38431,1,""],[38431,0,"le criticism of this appar"],[38456,1,""],[38455,1,""],[38455,0,"roach. I covered too much territory here."],[38495,0," to be thorough"],[38502,0,"as "],[38513,0," as I'd like. We"],[38527,2,""],[38527,0,"I did benchmakr "],[38542,1,""],[38541,1,""],[38540,1,""],[38540,0,"rk 4 different CRDT implementations - 2 of which I wrote myself from scratch"],[38575,0," here"],[38258,10,""],[38258,0,"distribute "],[38305,0," that happened"],[38417,0," Maybe rust is just that much faster than javascript, and all my discussion"],[38469,0," for this sort of thing"],[38515,0," of pointers is just made up?"],[38543,1,""],[38543,0,"."],[38546,5,""],[38546,0,"Y"],[38549,1,""],[38549,0,"."],[38551,1,""],[38551,0,"T"],[38760,0," And this post is "],[38546,232,""],[38546,0,"Yes. This is a reasonable criticism of this approach. I covered too much territory here to be as thorough as I'd like. I did benchmark 4 different CRDT implementations here - 2 of which I wrote myself from scratch. And this post is nearly 7000 words already."],[38149,8,""],[38149,0,"A"],[38149,1,""],[38149,0,"Tje"],[38151,1,""],[38150,1,""],[38150,0,"he"],[38152,8,""],[38169,0," is totally different ("],[38191,1,""],[38190,1,""],[38190,0,". (FP javascript -> imperitive)"],[38215,1,""],[38215,0,"a"],[38270,5,""],[38269,1,""],[38269,0,"'m only guessing"],[38285,14,""],[38293,10,""],[38293,0,"assign t"],[38300,1,""],[38299,1,""],[38351,0," And for what its worth - I ssu"],[38381,1,""],[38380,1,""],[38380,0,"uspect just removing immutablejs and tidying up automerge"],[38416,0," doing some obvious"],[38435,21,""],[38435,0," "],[38435,1,""],[38435,0," tidying up automerge"],[38427,8,""],[38422,5,""],[38416,6,""],[38427,10,""],[38424,3,""],[38416,8,""],[38412,4,""],[38400,12,""],[38391,9,""],[38386,5,""],[38380,6,""],[38380,0,"su"],[38378,4,""],[38376,2,""],[38374,2,""],[38368,6,""],[38364,4,""],[38359,5,""],[38355,4,""],[38351,4,""],[38455,0,"my "],[38462,0," code"],[38470,5,""],[38504,22,""],[38504,0,"because rust is fast"],[38512,12,""],[38512,0,"of"],[38512,2,""],[38512,0,"the rust omp"],[38523,1,""],[38522,1,""],[38521,1,""],[38521,0,"compiler"],[38512,0,"of"],[38514,3,""],[38528,0," specifics"],[38529,9,""],[38529,0,"stuff"],[38573,12,""],[38573,0,"fake news"],[38573,9,""],[38573,0,"invented"],[38834,7,""],[38833,1,""],[38834,0," So I suppose"],[38835,12,""],[38835,0,"If this bothers you, please do those benchmarks. I'd love to "],[38866,6,""],[38866,0,"more detailed "],[38584,320,""],[38584,0,"Yes. This is a reasonable criticism of this approach. I covered too much territory here to be as thorough as I'd like. I did benchmark 4 different CRDT implementations here - 2 of which I wrote myself from scratch. And this post is nearly 7000 words. If this bothers you, please do more detailed benchmarks. I'd love to"],[38059,8,""],[38059,0,"malarky"],[38059,7,""],[38059,0,"protocol"],[38068,0," And"],[38072,4,""],[38077,3,""],[38077,0,"those"],[38147,0," are gone too, obviously"],[38610,0,"And, "],[38615,1,""],[38615,0,"y"],[38669,161,""],[38669,0,"I "],[38670,1,""],[38670,0,"f this bothers, "],[38685,1,""],[38684,1,""],[38684,0," you'"],[38688,1,""],[38688,0,", I'd *love* to "],[38701,3,""],[38701,0,"for someone to pull apart each of these changes and "],[38741,12,""],[38741,0,"performance differences and show me"],[38768,8,""],[38768,0," publish a more detailed guide. I'd read the heck out of that."],[38830,104,""],[38765,0,"between implementations I show here "],[38866,0,"\n\n\n### You haven't published"],[38873,21,""],[38873,0,"Where is the code to re-run your benchmarks?"],[38873,0,"I don't believe you. "],[38873,21,""],[38917,0," I want to verify &"],[38935,1,""],[38935,0,"t"],[38935,1,""],[38934,1,""],[38928,6,""],[38928,0,"play\n\nThe benchmark code for yjs and automerge I'm running is [here](https://gist.github.com/josephg/13efc1444660c07870fcbd0b3e917638). For my rust implementation I'm benchmarking [this code](https://github.com/josephg/text-crdt-rust/tree/ba20b6386c0472958f33024ce0b806e75470e1ca). Run it with `car"],[38991,4,""],[38991,0,"in this github gist"],[39078,1,""],[39078,0,"\n\n"],[39242,0,"go criterion yjs` or `cargo criterion ropey` for the ropey baseline. Turn on oa"],[39320,1,""],[39319,1,""],[39319,0,"and off the inline rope updates in "],[39351,3,""],[39351,0,"near the o"],[39360,1,""],[39350,10,""],[39350,0," my commenting out lines near the top of src/universal/doc.rs."],[38956,0," javascript"],[38957,10,""],[38957,0,"my JS string baseline,"],[38998,12,""],[39089,0," Its a mess."],[39100,1,""],[39100,0,"; but messy is better than missing."],[39111,0," links"],[39112,5,""],[39112,0,"code"],[39139,0," code"],[39326,0," "],[39326,1,""],[39354,3,""],[39354,0,"to isolate"],[39486,0,"\n\nI haven't uploaded my wasm wrapper anywhere."],[39510,0,"rust "],[39514,0," crdt"],[39486,0," You can add `--features memusage` to print out memory allocator statistics. (T"],[39564,1,""],[39563,1,""],[39562,1,""],[39561,1,""],[39561,0,". (This is how I'm generating "],[39580,11,""],[39580,0,"figurout "],[39588,1,""],[39587,1,""],[39586,1,""],[39585,1,""],[39585,0,"ing out how much r"],[39602,1,""],[39602,0,"RAM I'm using)."],[39563,1,""],[39614,1,""],[39561,1,""],[39561,0," - which is"],[39572,8,""],[39145,0," "],[39145,1,""],[38918,14,""],[38917,1,""],[38872,0," IS thi"],[38878,1,""],[38877,1,""],[38876,1,""],[38875,1,""],[38874,1,""],[38874,0,"s this reproducable?"],[38881,12,""],[38881,0,"reproducable"],[38912,27,""],[38912,0," that e"],[38918,1,""],[38918,0,"generated these benchmark results?"],[38895,57,""],[38895,0,"Show me the code"],[38907,0,"benchmarking "],[38924,0," please"],[38924,7,""],[38924,0,"!"],[33461,7,""],[33461,0,"sleights"],[31273,0,"I got frustrated with academia a"],[31304,1,""],[31304,0,"on the whole and "],[31353,1,""],[31353,0,"."],[31355,5,""],[31355,0,"I"],[31294,0," c"],[31295,1,""],[31295,0,"disappointing app"],[31311,1,""],[31310,1,""],[31309,1,""],[31309,0,"app"],[31311,1,""],[31310,1,""],[31309,1,""],[31308,1,""],[31308,0," papers and"],[31341,0,","],[31424,2,""],[31424,0,"at how we can"],[31458,0," to"],[31455,6,""],[31454,47,""],[31454,0," And bring us to this point."],[31455,27,""],[31454,1,""],[31454,0," "],[31454,1,""],[31453,1,""],[31453,0," and no time at all to arrive at these performance numbers."],[31688,0," avoiding UUIDs by"],[31753,36,""],[31753,0," "],[31764,4,""],[31763,1,""],[31763,0,"."],[31801,0,", but its brilliant"],[31807,13,""],[31807,0,"I love it"],[31897,13,""],[31897,0," makes everything si"],[31916,1,""],[31916,0,"o much simpler"],[32049,11,""],[32049,0,"doubt"],[32103,2,""],[32103,0,"fast CRDTs"],[32102,6,""],[32102,0," the formula for fast "],[32129,0,", "],[32130,1,""],[32129,1,""],[32123,1,""],[32123,0,", lightwa"],[32131,1,""],[32131,0,"eight "],[32141,1,""],[32141,0," implementations"],[32094,0,", after a decade of waiting,"],[32190,1,""],[32190,0,"\n\n"],[32191,1,""],[32190,1,""],[32190,0," "],[39104,740,""],[39045,59,""],[39044,1,""],[33694,0,"\n\nIf you want to play with any of the benchmarks yourself, the "],[33753,4,""],[33753,0,"here's "],[33751,9,""],[33751,0,":\n\n\nThe benchmark code for my JS string baseline, yjs and automerge is [in this github gist](https://gist.github.com/josephg/13efc1444660c07870fcbd0b3e917638). Its a mess; but messy code is better than missing code.\n\nFor my rust implementation I'm benchmarking [this code](https://github.com/josephg/text-crdt-rust/tree/ba20b6386c0472958f33024ce0b806e75470e1ca). Run it with `cargo criterion yjs` or `cargo criterion ropey` to isolate the ropey baseline. Turn on and off the inline rope updates my commenting out lines near the top of src/universal/doc.rs. You can add `--features memusage` to print out memory allocator statistics - which is how I'm figuring out how much RAM I'm using.\n\nI haven't uploaded my rust crdt wasm wrapper anywhere."],[33753,1,""],[33752,1,""],[33751,1,""],[33751,0,", most of t"],[33751,11,""],[33751,0,":\n"],[33742,0," I ran"],[33757,0,", everything is a bit of a hodge b"],[33790,1,""],[33790,0,"podge"],[33695,0,"\n\n"],[33696,0,"### You haven't published the code which generated your results"],[33860,1,""],[33860,0,". But its almost all online."],[34129,0," results"],[34318,0,"if you want "],[34593,0," You'll need `automerge-paper.json.gz` from [this repositor"],[34643,9,""],[34643,0,"repository"],[34593,1,""],[34593,0,"\n\n"],[34654,0,"](https://github.com/josephg/crdt-benchmarks) for most of these tests."],[34602,0,"also "],[34705,3,""],[34705,0,"in order to run"],[34101,0,"\n\nThe reference "],[34116,1,""],[34116,0,"-crdts benchmark is in th"],[34133,8,""],[34133,0,"code is [in thi"],[34147,1,""],[34147,0,"e repository here](https://github.com/josephg/reference-crdts/blob/main/bench.ts). You ca"],[34230,6,""],[34230,0,"If you want to measuer m"],[34253,1,""],[34252,1,""],[34251,1,""],[34250,1,""],[34250,0,"re memory usage you can use the same approach as I did i"],[34305,1,""],[34103,202,""],[34103,0,"The reference-crdts benchmark code is [in the repository here](https://github.com/josephg/reference-crdts/blob/main/bench.ts). If you want to measure memory usage you can use the same approach as I did"],[33913,3,""],[33913,0,"the "],[33954,0," tests"],[34152,3,""],[34152,0,"its"],[34166,5,""],[34166,0," here"],[34311,0,"'"],[34276,0,"'"],[34277,35,""],[34277,0,"ll need to add"],[34291,1,""],[34291,0," queries"],[34272,27,""],[34272,0,", follow the approach from the gist and "],[34307,5,""],[34307,0,". You can run tihs code "],[34321,10,""],[34321,0,"this code with `node --loader ts-node/esm --expose-gc bench.ts`"],[34307,0," of printing out"],[33940,4,""],[33940,0,","],[33951,0," and reference-crdts"],[33980,0," all jammed into"],[33998,3,""],[33985,11,""],[33985,0,"in"],[34166,2,""],[34166,0,"needs"],[34131,295,""],[34165,4,""],[34165,0," come from"],[34435,2,""],[34435,0,"by"],[34449,25,""],[34449,0,"editing the global c"],[34461,8,""],[34461,0,"constant at the top of"],[34581,0,"while benchmarking "],[34602,12,""],[34602,0,"thats how"],[34642,9,""],[34642,0,"its using. (Note you can't measure memory using "],[34684,6,""],[34684,0,"su"],[34685,1,""],[34684,1,""],[34684,0,"usage during tests because test mode changes the memory"],[34702,37,""],[34702,0,")"],[34668,0," accurately"],[34701,7,""],[34701,0,"in the unit testing environment"],[34732,5,""],[34882,0," The reference-crdts implementation depends on ["],[34902,15,""],[34902,0," benchmarks"],[34912,1,""],[34925,0,"crdts.ts]("],[34934,1,""],[34933,0," from this repository"],[34955,0,"(https://github.com/josephg/reference-crdts/tree/fed747255df9d457e11f36575de555b39f07e909)"],[34954,0,", at this version"],[34199,0,", at this version"],[33699,60,""],[33699,0," How do I reproduce your results?"],[33709,22,""],[33709,0,"re-run your benchmark results"],[33699,0," I don't believe you"],[33699,20,""],[33709,3,""],[33727,0,"s myself"],[33735,8,""],[33713,4,""],[33713,0,"these"],[38416,53,""],[38416,0,"we need to take a lot more seriously is how we"],[38470,1,""],[38469,1,""],[38468,1,""],[38468,0,"e"],[38648,1,""],[38648,0," - so the model of \"load an objet"],[38680,1,""],[38680,0,"ct, keep it in ram for "],[38699,4,""],[38699,0,"while its open and then save it"],[38723,0,"eventually "],[38741,0,"\" doesn't work."],[38751,4,""],[38751,0,"apply"],[39104,0,"\n\n"],[39105,1,""],[39104,1,""],[39104,0,"\n\n> Edit: Kevin says there are "],[39125,10,""],[39125,0,"you can do this "],[39133,8,""],[39133,0,"adapt Yjs's providers to implement this in a reasonable way. Id"],[39195,1,""],[39195,0,"'d"],[39194,3,""],[39194,0,"I"],[39194,1,""],[39194,0,"Kevin is usually right; but I'd sure love to see that in action."],[39194,64,""],[39193,1,""],[39193,0," I'd love to see that in action."],[39194,31,""],[39193,1,""],[39193,0," I'd ove"],[39200,1,""],[39199,1,""],[39198,1,""],[39198,0,"love to see that in action."],[40111,4,""],[40111,0,"I can "],[40129,1,""],[40128,1,""],[40127,1,""],[40146,0," 10x"],[40171,0,"of "],[40185,14,""],[40178,7,""],[40178,0,"differences"],[40288,0,"How much f"],[40297,1,""],[40297,0,"of the speed difference beween"],[40321,6,""],[40321,0,"between my"],[40331,8,""],[40341,0," and yjs is simply due to"],[40366,67,""],[40360,6,""],[40360,0,"thnks"],[40364,1,""],[40363,1,""],[40362,1,""],[40362,0,"anks to the rust compiler?"],[40388,48,""],[40349,0," has nothing to do with memory layout, and everything to do wtih"],[40412,1,""],[40411,1,""],[40410,1,""],[40410,0,"ith"],[40413,20,""],[40432,0," I don't know."],[40432,1,""],[40432,0,"\n\n"],[40449,3,""],[40449,0,"So"],[40446,1,""],[40446,0,"!"],[40643,7,""],[40643,0,"tease apart"],[40708,0," I love benhc"],[40720,1,""],[40719,1,""],[40719,0,"chmarking stories. That "],[40742,1,""],[40742,0,"s normal, right?"],[948,39,""],[959,6,""],[959,0,"implementation "],[1333,5,""],[1333,0,"yout"],[1336,1,""],[1336,0,"r"],[1531,9,""],[1530,1,""],[2203,3,""],[2202,1,""],[2201,1,""],[2200,1,""],[2199,1,""],[2198,1,""],[2198,0," RGA is an"],[2209,1,""],[2209,0,"A"],[2401,20,""],[2401,0,"What are the rules?"],[2419,1,""],[2419,0," which describe the system's behaviour?"],[2585,0,"When "],[2585,5,""],[2585,0,"If my "],[2591,24,""],[2591,0,"implementation runs"],[2615,0,"ly,"],[2618,15,""],[2618,0," what can we infer from that"],[2631,0,"really s"],[2638,1,""],[2624,29,""],[2624,0,"does that actul"],[2638,1,""],[2638,0,"ally tll"],[2645,1,""],[2644,1,""],[2644,0,"ell us"],[2673,1,""],[2672,1,""],[2672,0,"."],[2674,1,""],[2674,0,"A"],[2719,6,""],[2728,0,"re are no more"],[2742,11,""],[2738,4,""],[2737,1,""],[2725,0,"that "],[2897,0,", maybe,"],[2905,7,""],[2905,0," writes"],[3305,5,""],[3305,0,"testing"],[3487,13,""],[3837,6,""],[3837,0,"a "],[3845,0," or so "],[3851,1,""],[3850,1,""],[3849,1,""],[3848,1,""],[3847,1,""],[3846,1,""],[3846,0,"ago"],[3851,0," decided to"],[3869,1,""],[3868,1,""],[3867,1,""],[4071,0,"I think "],[5241,0,"i nThe "],[5247,1,""],[5246,1,""],[5245,1,""],[5244,1,""],[5243,1,""],[5242,1,""],[5241,1,""],[5241,0,"in The Literature "],[5244,15,""],[5244,0,"the academic literature "],[5267,1,""],[5256,11,""],[5247,9,""],[5244,3,""],[5244,0,"The Literature "],[5244,15,""],[5244,0,"the academic literature "],[5267,1,""],[5256,11,""],[5247,9,""],[5244,3,""],[5243,1,""],[5242,1,""],[5241,1,""],[5282,0,"n academic"],[7310,8,""],[7508,1,""],[7471,0," But"],[7476,1,""],[7476,0,"t"],[7496,0," really"],[29306,1,""],[29306,0,"&lt;"],[29248,240,""],[29248,0,"\nAnd oh look - those last three rows are *weird*! 29 and 23 don't add up to 65. I'm probably thrashing the CPU cache by interleaving updates in the two b-trees. Looks like a *batch_update()* method would bring that 65ms down to *52ms*.\n"],[33600,46,""],[33600,0,"Benchmarks"],[33600,0,"All "],[33604,1,""],[33604,0,"b"],[33614,0," are lies"],[33628,0," yes"],[33634,80,""],[33634,0,"very clever."],[33632,14,""],[33625,7,""],[33625,0,"Yes yes, very clever."],[33791,27,""],[33791,0," I'm not sorry  "],[33806,1,""],[33806,0,"- writing "],[33805,11,""],[33805,0,"."],[33799,0," even"],[33647,43,""],[33647,0,"\n### How do I run these benchmarks myself?\n"],[33799,5,""],[33805,1,""],[33805,0," - writing "],[33815,1,""],[33807,8,""],[33806,1,""],[33806,0," "],[33806,1,""],[33805,1,""],[33799,6,""],[33795,4,""],[33791,4,""],[33791,0," But its almost all online."],[33638,8,""],[33634,4,""],[33634,0,"I know. I've made a few sleights of hand which I want to 'fess up to and defend."],[33628,4,""],[33618,5,""],[33614,4,""],[33604,1,""],[33604,0,"B"],[33603,1,""],[33600,13,""],[33600,0,"Your benchmarks are weird / wrong / misleading"],[33600,46,""],[33600,0,"Benchmarks"],[33600,0,"All "],[33604,1,""],[33604,0,"b"],[33614,0," are lies"],[33628,0," yes"],[33634,80,""],[33634,0,"very clever."],[33791,27,""],[33791,0," I'm not sorry  "],[33806,1,""],[33806,0,"- writing "],[33805,11,""],[33805,0,"."],[33799,0," even"],[33647,43,""],[33600,23,""],[33600,0,"Your benchmarks are weird / wrong / misleading"],[33600,46,""],[33600,0,"We need to talk about ben"],[33600,25,""],[33600,0,"These benchmarks "],[33600,17,""],[33600,0,"B"],[33600,1,""],[33600,0,"These benchmarks "],[33616,1,""],[33605,11,""],[33600,5,""],[33600,0,"We need to talk about ben"],[33621,4,""],[33600,21,""],[33600,0,"Tge"],[33602,1,""],[33601,1,""],[33601,0,"hese bencmkar"],[33613,1,""],[33612,1,""],[33611,1,""],[33610,1,""],[33610,0,"h"],[33600,11,""],[33600,0,"Are the be"],[33609,1,""],[33609,0,"enchmarks"],[33603,15,""],[33603,0," these benchmarking"],[33621,1,""],[33620,1,""],[33619,1,""],[33619,0,"s for real?"],[33584,0,"\n"],[33636,18,""],[33636,0,"; though its"],[33645,3,""],[33645,0,"there's a few slippery sleights of hands "],[33685,1,""],[33684,1,""],[33684,0," doing"],[33689,1,""],[33688,1,""],[33687,1,""],[33686,1,""],[33685,1,""],[33685,0,"going on here."],[33636,8,""],[33636,0,"B"],[33636,1,""],[33636,0," "],[33636,1,""],[33636,0,". But"],[33641,8,""],[33641,0," there are a"],[33652,1,""],[33651,1,""],[33800,20,""],[33800,0," I'm not even sorry."],[33799,21,""],[33799,0," mess."],[34107,9,""],[34107,0,"josehpg/te"],[34107,10,""],[34107,0,"josephg/text-crdt-rust"],[34238,6,""],[34238,0,"Benchmakr"],[34246,1,""],[34245,1,""],[34245,0,"rk by running"],[34258,5,""],[34307,0,","],[34352,17,""],[34352,0,"T"],[34367,0," structure"],[34385,0," can be enabled or disabled"],[34416,11,""],[34480,0," also"],[34571,8,""],[34571,0,"."],[34573,45,""],[34652,0,". I've been running the benchmarks with that flag, c"],[34703,1,""],[34703,0,"then CT"],[34709,1,""],[34709,0,"c"],[34709,1,""],[34708,1,""],[34708,0,"ctl_"],[34711,1,""],[34710,1,""],[34710,0,"rl+C as"],[34716,1,""],[34715,1,""],[34714,1,""],[34713,1,""],[34712,1,""],[34711,1,""],[34708,3,""],[34708,0,"killing the benchmarks as soon as "],[34729,13,""],[34729,0," run as soon as numbers start coming out."],[34769,1,""],[34822,15,""],[34822,0,"josephg/crdt-benchmarks"],[34984,15,""],[34984,0,"my reference"],[34984,12,""],[34984,0,"josephg/reference-crdts"],[40800,0,"'"],[39603,0,"'"],[35983,0,"'"],[26041,0,"'"],[20874,0,"'"],[16160,0,"'"],[14164,0,"'"],[9304,0,"'"],[3265,0,"'"],[3985,1,""],[3985,0,"o"],[188,0,"\n\n"],[189,0,"<seph-foo />"],[199,1,""],[198,1,""],[199,0,"</seph-foo>"],[199,11,""],[198,0," /"],[198,2,""],[199,0,"</seph-foo>"],[199,0,"oh hai"],[216,0," -->"],[189,0,"<!-- "],[206,0,"dsfdsdf"],[206,7,""],[221,4,""],[189,5,""],[217,0,"\n"],[217,1,""],[195,3,""],[195,0,"time-btn"],[217,3,""],[217,0,"time-btn"],[203,0," timeM"],[208,1,""],[208,0,"Ms=1000"],[209,1,""],[208,1,""],[208,0,"-ms"],[208,3,""],[208,0,"ms"],[209,1,""],[208,1,""],[208,0,"Ms"],[208,0,"-"],[209,1,""],[209,0,"m"],[209,1,""],[209,0,"M"],[208,1,""],[209,1,""],[208,1,""],[204,4,""],[204,0,"ms"],[205,1,""],[205,0,"illisect"],[212,1,""],[212,0,"onds"],[244,0," -->"],[189,0,"<!-- "],[249,4,""],[189,5,""],[26592,0,"**"],[26624,0,"**"],[26626,4,""],[26668,0,"*"],[26655,0,"*"],[26669,0,"*"],[26656,0,"*"],[26672,4,""],[20202,0,"*"],[20199,0,"*"],[20203,0,"*"],[20200,0,"*"],[20206,4,""],[15128,0,"*"],[15095,0,"*"],[15129,0,"*"],[15096,0,"*"],[9662,0,"*"],[9636,0,"*"],[9663,0,"*"],[9637,0,"*"],[9394,0,"\n"],[9394,0,"\nI'm comparing it here to a baseline where all the edits are just applied directly to a javascript string."],[9499,0,", which should be the theori"],[9526,1,""],[9526,0,"etical "],[9499,34,""],[9460,7,""],[9460,0,"spliced "],[9467,1,""],[9477,0,"into "],[9482,3,""],[9395,3,""],[9395,0,"We can "],[9395,7,""],[9395,0,"As a baseline"],[9395,13,""],[9395,0,"To get a sense of how fast"],[9417,4,""],[9417,0,"inefficient that is, we can"],[9453,1,""],[9452,1,""],[9451,1,""],[9451,0,"e"],[9455,0," "],[9456,6,""],[9541,0," Splicing into a string directly can't "],[9542,38,""],[9542,0,"T"],[9542,1,""],[9541,1,""],[9540,1,""],[9540,0,". ("],[9542,1,""],[9541,1,""],[9453,3,""],[9453,0,"the "],[9453,4,""],[9453,0,"this "],[9471,0," benchmark"],[9552,1,""],[9552,0,"; which shoulw"],[9565,1,""],[9564,1,""],[9564,0,"ws"],[9565,1,""],[9564,1,""],[9563,1,""],[9563,0,"ws about how fast h"],[9581,1,""],[9581,0,"javascript"],[9559,32,""],[9559,0," gives us a se "],[9573,1,""],[9573,0,"se "],[9575,1,""],[9574,1,""],[9573,1,""],[9573,0,"nse of how fast javascript could go, if it wasn't loaded down with all our code."],[9653,128,""],[9653,0,"\n"],[9653,0," (Sp"],[9656,1,""],[9655,1,""],[9654,1,""],[9654,0,"And "],[9657,1,""],[9657,0,", javascript"],[9659,0,"raw "],[9673,0," is very fast."],[9659,14,""],[9659,0,"javascript runnign"],[9676,1,""],[9675,1,""],[9675,0,"ng on v8"],[9681,1,""],[9681,0,"V"],[20389,0," @ 13.5.5"],[20400,9,""],[20389,9,""],[20389,0," (v13.5.5)"],[20269,1,""],[20268,1,""],[20268,0,"(v"],[20284,0,")"],[20285,1,""],[20411,1,""],[26991,0,"\n\n"],[26992,0,"\n(I have no idea how to measure memory usage in "],[27024,16,""],[27024,0,"wasm memory usage. It should be the same as the native version)"],[27086,0,"."],[26992,96,""],[26991,1,""],[26990,1,""],[26990,0,". (!)"],[20127,1,""],[20127,0,". Its *300x faster than automerge*!"],[20161,1,""],[20160,0,"!"],[20162,0,"."],[27029,1,""],[27028,1,""],[27027,1,""],[27026,1,""],[27025,1,""],[27025,0,"!"],[27025,0," directly, and its doing way more "],[27050,9,""],[27050,0,"a whole lot of extra work to support c"],[27087,1,""],[27087,0,"collaborative editing too"],[26496,1,""],[26496,0,":"],[26496,1,""],[26496,0," "],[28659,1,""],[26496,1,""],[20229,1,""],[15149,1,""],[9756,1,""],[28655,0,":"],[26493,0,":"],[20227,0,":"],[15148,0,":"],[9756,0,":"],[29329,0,"*"],[29300,0,"*"],[29330,0,"*"],[29301,0,"*"],[29334,4,""],[29870,0,"\n\n"],[29871,0,"That academic paper made claims "],[29896,0,"benchmarking "],[29896,13,""],[29903,0,"about how "],[29891,22,""],[29891,0,"claimed to know how fast t"],[29916,1,""],[29916,0,"various CRDTs run, but its performance measuer"],[29961,1,""],[29960,1,""],[29960,0,"res were off by "],[29891,15,""],[29891,0,"m"],[29891,1,""],[29875,0," silly"],[29897,0,"I real"],[29902,1,""],[29902,0,"d all tohse "],[29913,1,""],[29912,1,""],[29911,1,""],[29910,1,""],[29909,1,""],[29909,0,"hose years ago made claims about"],[29929,0,"some bol"],[29929,8,""],[29968,1,""],[29968,0,". But"],[29973,4,""],[29989,22,""],[29989,0," numbers o"],[29998,1,""],[29998,0,"were "],[29969,0," And because its *published science* we "],[30006,3,""],[30005,1,""],[30005,0,", everyone believed the researchers."],[30004,1,""],[29986,1,""],[30073,0,"off by thou"],[30080,4,""],[30080,0,"3 orders of magnitude."],[30072,0,"n't just wrong. They were wrong by a factor"],[30115,30,""],[30107,8,""],[30107,0,"thousa"],[30112,1,""],[30111,1,""],[30111,0,"sands of times."],[30107,19,""],[30107,0,"several orders of magnitude."],[29970,43,""],[29970,0,"And we all"],[30005,0,", because "],[29974,6,""],[29974,0,"everyone"],[29924,17,""],[29924,0,"tried "],[29924,6,""],[29924,0,"told us all"],[30011,0,"it was published sciec"],[30032,1,""],[30032,0,"nce"],[30041,3,""],[30041,0,"the"],[30132,0," Who knows what the paper would have concluded if they "],[30133,54,""],[30132,1,""],[30132,0," It turns out, the paper wasn't written by gods."],[30132,1,""],[30132,0,"\n\n"],[29924,0,"claimed to "],[29935,4,""],[29935,0,"tell"],[29938,1,""],[29938,0,"l"],[30001,11,""],[30001,0,"paper"],[30108,29,""],[30108,0," sa"],[30110,1,""],[30109,1,""],[30109,0,"thousands of times."],[30129,0,"\nBut thats ok."],[30143,50,""],[30143,0," Actually "],[30156,0," sort of"],[30157,7,""],[30157,0,"weirdly"],[30314,14,""],[30314,0,"this whole thing made me learn something that "],[30339,21,""],[30339,0,"realise something that should have been obvious a"],[30387,1,""],[30387,0,"dea"],[30389,1,""],[30389,0,"cades ago. "],[30399,1,""],[30399,0," Scientists aren't gods. They're"],[30422,0,", sent from the heavens to bring Truth to mortals"],[30473,0,"No, "],[30477,1,""],[30477,0,"t"],[30511,0,"Great"],[30516,11,""],[29924,27,""],[29924,0,"proported to tell us all how "],[29924,9,""],[29924,0,"tried"],[30126,0," They were wrong like a billionare "],[30160,1,""],[30159,1,""],[30158,1,""],[30158,0,"ire guessing ab"],[30172,1,""],[30172,0," banana"],[30137,5,""],[30137,0,"as accurate as"],[30151,5,""],[30183,0," costs $1000."],[30137,0,"about "],[30207,0," you know?"],[30218,1,""],[30218,0,"T"],[30227,0," Thats human, and"],[30244,9,""],[30265,34,""],[30239,26,""],[30251,47,""],[30251,0,"feel sort of inadequate with academics - "],[30292,5,""],[30291,1,""],[30303,5,""],[30322,1,""],[30371,22,""],[30378,13,""],[30378,0,":"],[30425,1,""],[30424,1,""],[30424,0,"s with the gift of"],[30442,8,""],[30448,11,""],[30631,533,""],[42881,0,"\n\n\n\n\n\n\n\n---\n\n\n\nA decade ago Google Wave really needed a good quality list CRDT. So I got super excited when the papers for CRDTs started to emerge. [LOGOOT](https://hal.inria.fr/inria-00432368/document) and [WOOT](https://hal.inria.fr/inria-00445975/document) seemed like a big deal! But that excitement turned to ash when I realised the algorithms were too slow and inefficient to be practically useful. And I made a big mistake - I assumed if the academics couldn't make them fast, nobody could. I turned my back on academia and dismissed them.\n"],[30631,0,"\n"],[30631,0,"\nAnd its important to know that, because the best collaborations "],[30672,0,"sometimes "],[30706,0,"don't come from two chefs working together. They come"],[30706,53,""],[30706,0,"come from "],[30706,10,""],[30706,0,"lok"],[30708,1,""],[30708,0,"ok like Gilbert & Sullivan. M"],[30736,1,""],[30736,0,"O"],[30736,1,""],[30736,0,"The same love, and the same dream"],[30735,0," Or Jobs and Wozniak."],[30790,0," but different skill sets. Different perspectives headed toward the same goal."],[43134,532,""],[43133,1,""],[43132,1,""],[43131,1,""],[43130,1,""],[43129,1,""],[43128,1,""],[43127,1,""],[43126,1,""],[43125,1,""],[43124,1,""],[43123,1,""],[43122,1,""],[43121,1,""],[30635,4,""],[30635,0," thats"],[30659,5,""],[30703,0,"aren't between two "],[30718,4,""],[30718,0,"peers. Instead they "],[30826,0," tto"],[30829,1,""],[30828,1,""],[30828,0,"otally"],[30857,9,""],[30857,0,"Two "],[30857,4,""],[30857,0,"Many minds"],[30862,5,""],[30862,0,"different"],[30871,13,""],[30871,0," minds"],[30877,14,""],[30877,0," s"],[30872,7,""],[30872,0,"strengths fighting for"],[30909,0,"\n\nA decade ago Google Wave really needed a good quality list CRDT. So I got super excited when the papers for CRDTs started to emerge. [LOGOOT](https://hal.inria.fr/inria-00432368/document) and [WOOT](https://hal.inria.fr/inria-00445975/document) seemed like a big deal! But that excitement turned to ash when I realised the algorithms were too slow and inefficient to be practically useful. And I made a big mistake - I assumed if the academics couldn't make them fast, nobody could. I turned my back on academia and dismissed them.\n"],[31442,1,""],[30976,3,""],[31197,20,""],[31197,0,"died when I"],[31288,4,""],[31377,49,""],[31389,0," big"],[31455,0," - ( *"],[31460,1,""],[31459,1,""],[31459,0,"I *H"],[31462,1,""],[31462,0,"hate* reading them) "],[31481,1,""],[31459,0,"to my eternal shame "],[31501,1,""],[31501,0,"."],[31503,3,""],[31503,0,"But"],[31458,1,""],[31458,0,"I haven't written any and "],[31484,42,""],[31484,0,"I'll do almost anything to avoid reading them"],[31576,5,""],[31576,0,"H"],[31455,74,""],[31502,0,"And "],[31506,1,""],[31506,0,"h"],[31763,1,""],[31762,1,""],[31762,0,"s."],[31763,1,""],[31763,0,"!"],[30202,0," It"],[30204,1,""],[30203,1,""],[30202,1,""],[30126,0," It turns out we cah"],[30145,1,""],[30145,0,"n make fast CRDTs."],[30152,5,""],[30157,0," which a"],[30158,7,""],[30157,1,""],[30152,0,"small and fast "],[30172,0,", if we're willing to be a bit clever about it"],[30220,4,""],[30220,0,"And that ma"],[30230,1,""],[30230,0,"eaks"],[30233,1,""],[30232,1,""],[30232,0,"ns that aca"],[30220,23,""],[30220,0,"That"],[30151,15,""],[30157,0," as f"],[30158,4,""],[30158,0,"work almost as fast as a string"],[30181,2,""],[30181,0,"editing a "],[30197,1,""],[30197,0,"."],[30199,46,""],[30199,0,"So that paper "],[30213,10,""],[30213,0,"was "],[30126,73,""],[30039,0," It turns out we can make CRDTs work almost as fast as editing a string. "],[30040,0,"But "],[30044,1,""],[30044,0,"i"],[30075,39,""],[30075,0,"fast. We can make them crazy fast - lik"],[30111,3,""],[30111,0,"about"],[30108,8,""],[30108,0,". We can make them about as fast as native string operations"],[30170,4,""],[30170,0,"So"],[30196,0," in that paper"],[30231,38,""],[30231,0,"They were"],[30240,17,""],[30250,8,""],[30250,0,"wrong"],[30317,0," what"],[30567,0," people"],[30683,5,""],[30683,0," pretty well"],[30695,7,""],[30743,0," "],[30743,1,""],[30743,0," And thats ok."],[30756,1,""],[30756,0,", no matter what "],[30756,17,""],[30756,0,"."],[30759,36,""],[30759,0,"And"],[30949,0," brought together brought together to achieve something none of us could achieve on our own"],[31005,4,""],[31005,0,"no one"],[31043,53,""],[31422,0," And in that moment"],[31532,24,""],[31532,0,"But, even though "],[31550,0,"'m"],[31552,9,""],[31562,16,""],[31562,0,"at"],[31580,1,""],[31580,0,","],[31582,4,""],[31887,334,""],[31886,1,""],[32922,3,""],[32922,0,"And now"],[33020,4,""],[31650,46,""],[31650,0,"I left the researchers to it."],[31535,1,""],[31651,0,"didn't try "],[31648,0," with a task I really wanted,"],[31690,0," to help."],[31699,28,""],[31686,0," even"],[31649,29,""],[31625,0," yet"],[31862,0," Collaborative editing needed a collaboration."],[31907,0," between all of us"],[31927,5,""],[31926,1,""],[31863,0,"Oops! It turned out "],[31883,1,""],[31883,0,"c"],[31912,0,"to e "],[31916,1,""],[31915,1,""],[31915,0,"be "],[31953,458,""],[30021,1,""],[30021,0,"P"],[30031,1,""],[30031,0,"S"],[30056,0," the a"],[30061,1,""],[30061,0,"paer"],[30064,1,""],[30063,1,""],[30063,0,"per was wrong."],[30078,1,""],[30078,0,"W"],[30119,0,"*"],[30130,0,"*"],[30150,41,""],[30150,0,"run so fast you'd think you were using native strings"],[30205,4,""],[30205,0,"T"],[30355,0," I'm sort of "],[30357,11,""],[30357,0," sort of appreciate that paper now."],[30392,6,""],[30392,0," Its"],[30393,3,""],[30393,0,"Their mistake is"],[30414,5,""],[30414,0,"Its"],[30418,0,"*"],[30424,0,"*"],[30828,0,"despite what I've been told, "],[30841,14,""],[30836,5,""],[30836,0,"some"],[30836,4,""],[30836,0,"what some people think"],[30853,0,"seem to "],[30841,0,"*"],[30853,0,"*"],[30881,286,""],[31367,0,"\nAnd sometimes the best collaborations aren't between peers. Instead they look like Gilbert & Sullivan. Or Jobs and Wozniak. The same love, and the same dream but totally different skill sets brought together brought together to achieve something no one of us could achieve on our own.\n\n"],[31653,1,""],[31368,0,"But the truth is"],[31384,3,""],[31403,0," work needs a"],[31430,1,""],[31430,0,". And those collaborations can work best when they"],[31503,14,""],[31503,0,"L"],[31507,5,""],[31507,0," al"],[31509,1,""],[31509,0,"t"],[31529,0," - one guy did the music, the other the lyrics"],[31596,0," - on "],[31601,1,""],[31601,0,"e guy was the storyteller, the other the engineer"],[31652,0,"They shared"],[31663,3,""],[31663,0," "],[31664,19,""],[31664,0,"a"],[31665,5,""],[31676,0,"needed "],[31683,8,""],[31703,0," to be"],[31726,17,""],[31737,49,""],[31737,0," it. Together they made something no no"],[31775,1,""],[31774,1,""],[31774,0,"one of them could make along"],[31801,1,""],[31801,0,"e."],[31805,5,""],[31805,0,"E"],[31891,7,""],[31891,0,"But"],[31891,3,""],[31891,0,"And yet"],[32221,0," Who could have guessed!"],[32656,0,"faster and "],[32773,4,""],[32773,0,"us"],[32773,2,""],[32773,0,"them"],[32873,0," finally "],[32881,1,""],[30081,0,"*"],[30085,0,"*"],[29941,12,""],[29941,0,"that lots of"],[29953,8,""],[29959,0," are pretty slow"],[29975,4,""],[30279,9,""],[30284,0," like"],[30289,3,""],[30279,12,""],[30278,1,""],[30278,0," a"],[30322,0," kind of wrong"],[30650,0,"*"],[30657,0,"*. They're"],[30859,7,""],[30859,0," people"],[31524,0,"["],[31543,0,"](https://en.wikipedia.org/wiki/Gilbert_and_Sullivan)"],[31669,12,""],[31730,0," that dream"],[31772,34,""],[31772,0,"b"],[31772,1,""],[31772,0," be achieved"],[32225,5,""],[32224,1,""],[9472,9,""],[9471,1,""],[9478,0,"instea "],[9484,1,""],[9484,0,"d of stro"],[9492,1,""],[9491,1,""],[9491,0,"oring information "],[9497,12,""],[9497,0,"all the exta"],[9508,1,""],[9508,0,"ra information to make collaborative editing work, we just"],[9566,22,""],[9573,1,""],[9572,1,""],[9572,0,"e all the content"],[9623,0,"."],[9624,1,""],[9417,11,""],[9417,0,"much overhead there"],[9436,5,""],[9481,80,""],[9480,1,""],[9546,0," This obviu"],[9556,1,""],[9556,0,"ously won'"],[9565,1,""],[9564,1,""],[9564,0,"uldn't"],[9552,18,""],[9552,0,"throws away all the infroma"],[9578,1,""],[9577,1,""],[9576,1,""],[9575,1,""],[9575,0,"ormation we need for a"],[9596,1,""],[9596,0,"collaborait"],[9606,1,""],[9605,1,""],[9604,1,""],[9604,0,"ative editing, but it"],[9625,6,""],[9572,0,"extra "],[9598,3,""],[9598,0,"to make"],[9627,0," work"],[9681,5,""],[9681,0,"can"],[9687,44,""],[9689,6,""],[9689,0,"J"],[9726,1,""],[9726,0,":"],[9466,0,"["],[9475,0,"](https://gist.github.com/josephg/13efc1444660c07870fcbd0b3e917638#file-js_baseline-js-L37-L41)"],[9475,0," benchmark"],[9475,10,""],[9569,1,""],[9477,92,""],[9475,2,""],[9466,1,""],[9571,6,""],[9683,0,"It turns out "],[9696,1,""],[9696,0,"j"],[9723,5,""],[9724,0,"*"],[9729,0,"*"],[15247,26,""],[15247,0,"automerge (v1.0.0-preview2)"],[9849,26,""],[9849,0,"automerge (v1.0.0-preview2)"],[15276,1,""],[9877,1,""],[10870,86,""],[10870,0,"I"],[10870,59,""],[10869,1,""],[10868,1,""],[10868,0,", and the code"],[10868,1,""],[10868,0,"."],[10751,0,"["],[10751,1,""],[10763,0,"["],[10800,0,"](https://github.com/automerge/automerge-rs/)"],[10916,12,""],[10916,0,"On this test the code"],[10933,4,""],[10933,0,"rust code performs l"],[10952,1,""],[10952,0,"almost "],[10665,294,""],[10665,0,"Automerge was just never written with performance in mind. Their team is working on a replacement [rust implementation of the algorithm](https://github.com/automerge/automerge-rs/) to run through wasm, but at the time of writing it hasn't landed yet. On this test the rust code performs almost"],[9877,0,"*"],[10944,15,""],[10944,0,"is br"],[10948,1,""],[10948,0,"arely faster than the javascript."],[10946,0," only"],[10975,0,"equivalent "],[10975,11,""],[10916,70,""],[10916,0," I got the master branch working, but they obviously have some kinks to work out - its barely faster than"],[10999,0,"on this test "],[11034,0," the javascript equiva"],[11055,1,""],[11054,1,""],[11035,19,""],[11035,0,"automerge's javascript code."],[11064,0,"]"],[11064,1,""],[11064,0,"\n\n"],[11065,0,"---"],[11614,6,""],[11613,1,""],[11616,5,""],[11616,0,"B"],[30001,35,""],[30001,0,"said CRDTs and OT algorithms"],[30033,7,""],[30001,4,""],[30001,0,"says"],[30110,13,""],[30218,27,""],[30218,0,"we can compete with the performance of "],[30341,0,"\""],[30385,0,"\""],[30341,1,""],[30341,0,"*"],[30385,1,""],[30385,0,"*"],[30385,1,""],[30385,0,"\""],[30341,1,""],[30341,0,"\""],[30356,8,""],[30356,0,"guesses"],[30356,7,""],[30356,0,"guessing"],[30508,8,""],[30519,4,""],[30519,0,"around"],[30718,7,""],[30718,0,"And in that regard, they're"],[30932,27,""],[30927,5,""],[30927,0,"being sometimes laughed at"],[30954,0," "],[30954,1,""],[30953,1,""],[30953,0,","],[30943,0,"rudely "],[30943,7,""],[31348,14,""],[31347,1,""],[31527,3,""],[31527,0,"sometimes"],[31660,0,"(t"],[31661,1,""],[31661,0,"they're famous for"],[31661,18,""],[31661,0,"they made a bunch of famous musicals). "],[31700,3,""],[31700,0,"O"],[31700,0,"But they w"],[31709,1,""],[31700,9,""],[31708,3,""],[31708,0,"wrote"],[31665,8,""],[31665,0," wrote a "],[31921,12,""],[31921,0,"body"],[31932,4,""],[31932,0,"do"],[32354,23,""],[32354,0,"Ironic!"],[32354,7,""],[32354,0,"Who could have guessed!"],[32354,0,"How ironic! "],[32388,1,""],[32388,0,"?!"],[244,0," -->"],[188,0,"<!-- "],[249,4,""],[188,62,""],[378,4,""],[377,1,""],[803,1,""],[22542,3,""],[22572,10,""],[22572,0," to human scale"],[22635,0,"we can imagine "],[22530,5,""],[22530,0,"The numbers s"],[22542,1,""],[22542,0,"are t"],[22546,1,""],[22530,16,""],[22529,1,""],[22531,38,""],[22531,0,"At a"],[22594,1,""],[22593,1,""],[22593,0," "],[22594,15,""],[22613,5,""],[22613,0,"might"],[22641,0,"."],[22612,17,""],[22612,0," takes"],[22631,0," And"],[22635,49,""],[22635,0," every"],[22640,1,""],[22639,1,""],[22638,1,""],[22637,1,""],[22636,1,""],[22636,0,"a "],[22660,23,""],[22660,0,"takes"],[22671,0,"r"],[22671,1,""],[22685,0," T"],[22686,1,""],[22686,0,"It "],[22688,1,""],[22688,0,"s the difference between a single heart beat, and the time taken to brush your teeth."],[27782,9,""],[29652,0," They should add"],[29653,15,""],[29653,0,"The bottom two rows should add up to our rust performance - but"],[29720,3,""],[29720,0,"+"],[29725,15,""],[29725,0,"iss "],[29728,1,""],[29727,1,""],[29727,0," less than"],[29652,0," The rust impleem"],[29668,1,""],[29667,1,""],[29667,0,"menet"],[29671,1,""],[29670,1,""],[29670,0,"tation "],[29653,24,""],[29652,1,""],[29591,0," a lot"],[29674,4,""],[29674,0,"entries"],[29659,22,""],[29659,0,"The rust performance (65ms) is the "],[29687,7,""],[29687,0,"should be the sum of the time spent in ropey (29ms) + the time spent in "],[29756,3,""],[29756,0,"updat "],[29761,1,""],[29761,0,"ing my b-tree (23ms). But its not"],[29794,69,""],[29794,0,"."],[29796,0,"The difference is probably caused by"],[29832,13,""],[29832,0," "],[29856,43,""],[29856,0," or something"],[29920,4,""],[29920,0,"my per"],[29925,1,""],[29924,1,""],[29923,1,""],[29922,1,""],[29927,0," performance all the way"],[29871,0,"It "],[29874,1,""],[29874,0,"l"],[29871,0,"If I'm writ"],[29881,1,""],[29880,1,""],[29879,1,""],[29878,1,""],[29878,0,"right "],[29884,13,""],[29883,1,""],[29435,0," Remember, these perfora"],[29458,1,""],[29458,0,"mance t"],[29464,1,""],[29464,0,"numbers describe how much time it take s"],[29503,1,""],[29502,1,""],[29502,0,"s to process 27"],[29516,1,""],[29516,0,"60 000 operations. S"],[29535,1,""],[29534,1,""],[29515,0,"a "],[29516,1,""],[29515,1,""],[29533,0," from a single user"],[29553,0," "],[29533,19,""],[29515,0,"an editing trace of "],[29436,120,""],[29435,0," We're processing 260 000 operations in 23ms, or "],[29483,1,""],[29481,2,""],[29481,0,"which is"],[29512,1,""],[29512,0,"per"],[29543,0," home"],[29574,4,""],[29574,0,"edits"],[29583,5,""],[29580,3,""],[29580,0,"I'd still ahve"],[29593,1,""],[29592,1,""],[29591,1,""],[29590,1,""],[29590,0,"have"],[29731,0,"full "],[29753,0," "],[29753,1,""],[29753,0,"benchmark "],[29866,11,""],[29866,0,"But those numbers don't addu "],[29894,1,""],[29893,1,""],[29893,0," up!"],[29897,1,""],[29958,13,""],[29972,0,","],[29934,14,""],[29944,0," thrashing, because all the up"],[29972,2,""],[29972,0,"b-tree updates are interleaved"],[29954,48,""],[22960,12,""],[22960,0," a"],[22977,1,""],[22958,2,""],[22958,0,"first requires"],[22939,4,""],[22939,0,"figuring out your"],[23004,37,""],[23004,0,"You just have a list of places"],[23034,11,""],[23034,0," "],[23048,0," - \"Under the couch\", \"On top of the r"],[23085,1,""],[23085,0,"fridge\", and so on."],[23104,1,""],[23105,96,""],[23105,0,"And you have to "],[23105,16,""],[23105,0,"On top of your fridge is a little note saying you need toothpaste."],[23144,6,""],[23144,0,"mentioning"],[23158,0," actually"],[23209,0," through your"],[23202,20,""],[23202,0,"its going to take you a long time to"],[23238,46,""],[23238,0," "],[23238,1,""],[23238,0," go "],[23239,3,""],[23239,0,"figure out what to uy"],[23259,1,""],[23258,1,""],[23258,0,"buy."],[22939,38,""],[22939,0,"your shopping list "],[22958,8,""],[22958,0,"describes"],[22958,9,""],[22958,0,"invol"],[22958,5,""],[22958,0,"is"],[22534,1,""],[22533,1,""],[22684,3,""],[22684,0,"This is"],[22723,11,""],[22723,0," beat of your heart"],[22756,0," it takes"],[22765,6,""],[22724,0,"heart"],[22733,14,""],[22962,2,""],[22962,0,"actually"],[22962,0,"is "],[22965,8,""],[22964,1,""],[22964,0," actually"],[22990,48,""],[22990,0,":"],[23046,14,""],[23046,0,"Under the couch "],[23062,8,""],[23093,9,""],[23128,59,""],[23128,0,"going to tho"],[23139,1,""],[23139,0,"e "],[23128,13,""],[23128,0,"doing the grocery shopping will be a chore."],[23170,1,""],[23128,5,""],[23128,0,"this makes doing "],[23144,1,""],[23166,8,""],[22871,7,""],[22871,0,"would be like"],[22953,9,""],[23163,7,""],[23163,0,"a laot of "],[23172,1,""],[23171,1,""],[23170,1,""],[23169,1,""],[23168,1,""],[23167,1,""],[23166,1,""],[23166,0,"ot of work"],[23177,0," We "],[23180,1,""],[23179,1,""],[23178,1,""],[23177,1,""],[23177,0," "],[23177,1,""],[23177,0," We can fix this"],[22908,1,""],[22908,0,". But"],[22914,5,""],[23177,15,""],[23176,1,""],[23308,0," (So when I pick up my grocery list, it has all the information I need)."],[23381,22,""],[23381,0,"L"],[23397,3,""],[23427,0," for this reason"],[23432,11,""],[23432,0,"exactly this reason"],[23451,15,""],[23637,1,""],[23637,0," "],[23634,16,""],[23634,0,"h"],[23634,1,""],[23634,0,"things other than text editing"],[23664,6,""],[23679,2,""],[23679,0,"the progrm"],[23688,1,""],[23688,0,"am"],[23313,18,""],[23313,0,"a single read of my "],[23345,0," tells me"],[23354,8,""],[23381,0," to know"],[23609,4,""],[23609,0,"And "],[23607,0,", which in yjs has linear performance"],[23626,0,"a "],[23646,0," cost"],[23653,0,"This doesn't happe "],[23671,1,""],[23671,0,"n num"],[23675,1,""],[23674,1,""],[23673,1,""],[23673,0,"much in a text docu"],[23678,14,""],[23678,0,"when text editing, but "],[23701,4,""],[23728,35,""],[23728,0," in other cases too"],[23784,2,""],[23784,0,"need"],[23346,5,""],[23346,0,"would con"],[23352,3,""],[23352,0,"tell us"],[23359,25,""],[23357,2,""],[23357,0,"me"],[23358,1,""],[23357,1,""],[23357,0,"us everything we"],[38705,5,""],[39950,9,""],[39966,0," "],[39966,1,""],[39950,0,"database using "],[31793,20,""],[31792,1,""],[31792,0,"'re be"],[31797,1,""],[31796,1,""],[31795,1,""],[31794,1,""],[31793,1,""],[31792,1,""],[31792,0," involve people with different skillsets"],[31831,1,""],[31830,1,""],[31829,1,""],[32452,8,""],[32452,0,"maybe we would"],[5329,258,""],[5328,0,"\n\nMartin explains i"],[5330,17,""],[5330,0,"Martin explains Automerge"],[5346,1,""],[5346,0,"a"],[5355,0," far better than I will in this talk:\n\n<iframe width=\"560\" height=\"315\" src=\"https://www.youtube-nocookie.com/embed/x7drE24geUw?start=1237\" title=\"YouTube video player\" frameborder=\"0\" allow=\"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture\" allowfullscreen></iframe>"],[5374,0,"v"],[5374,1,""],[5374,0,"ev"],[5375,1,""],[5374,1,""],[5391,0," from 2020"],[5891,1,""],[5891,0,"\n\nImagine I"],[5902,7,""],[5913,1,""],[5913,0,"."],[5913,1,""],[5913,0," into an empty document."],[5939,0,"A"],[5939,1,""],[5938,1,""],[5938,0,"A"],[6135,15,""],[6135,0,"<img src=\"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB2ZXJzaW9uPSIxLjEiIHdpZHRoPSIxOTFweCIgaGVpZ2h0PSIxNjFweCIgdmlld0JveD0iLTAuNSAtMC41IDE5MSAxNjEiPjxkZWZzLz48Zz48cGF0aCBkPSJNIDUwIDYwIEwgMjAgNjAgTCAyMCA0Ni4zNyIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjMjQyNDI0IiBzdHJva2UtbWl0ZXJsaW1pdD0iMTAiIHBvaW50ZXItZXZlbnRzPSJzdHJva2UiLz48cGF0aCBkPSJNIDIwIDQxLjEyIEwgMjMuNSA0OC4xMiBMIDIwIDQ2LjM3IEwgMTYuNSA0OC4xMiBaIiBmaWxsPSIjMjQyNDI0IiBzdHJva2U9IiMyNDI0MjQiIHN0cm9rZS1taXRlcmxpbWl0PSIxMCIgcG9pbnRlci1ldmVudHM9ImFsbCIvPjxyZWN0IHg9IjUwIiB5PSI0MCIgd2lkdGg9IjQwIiBoZWlnaHQ9IjQwIiBmaWxsPSIjZmZmZmZmIiBzdHJva2U9IiMwMDAwMDAiIHBvaW50ZXItZXZlbnRzPSJhbGwiLz48ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgtMC41IC0wLjUpIj48c3dpdGNoPjxmb3JlaWduT2JqZWN0IHN0eWxlPSJvdmVyZmxvdzogdmlzaWJsZTsgdGV4dC1hbGlnbjogbGVmdDsiIHBvaW50ZXItZXZlbnRzPSJub25lIiB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiByZXF1aXJlZEZlYXR1cmVzPSJodHRwOi8vd3d3LnczLm9yZy9UUi9TVkcxMS9mZWF0dXJlI0V4dGVuc2liaWxpdHkiPjxkaXYgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGh0bWwiIHN0eWxlPSJkaXNwbGF5OiBmbGV4OyBhbGlnbi1pdGVtczogdW5zYWZlIGNlbnRlcjsganVzdGlmeS1jb250ZW50OiB1bnNhZmUgY2VudGVyOyB3aWR0aDogMzhweDsgaGVpZ2h0OiAxcHg7IHBhZGRpbmctdG9wOiA2MHB4OyBtYXJnaW4tbGVmdDogNTFweDsiPjxkaXYgc3R5bGU9ImJveC1zaXppbmc6IGJvcmRlci1ib3g7IGZvbnQtc2l6ZTogMDsgdGV4dC1hbGlnbjogY2VudGVyOyAiPjxkaXYgc3R5bGU9ImRpc3BsYXk6IGlubGluZS1ibG9jazsgZm9udC1zaXplOiAxMnB4OyBmb250LWZhbWlseTogSGVsdmV0aWNhOyBjb2xvcjogIzAwMDAwMDsgbGluZS1oZWlnaHQ6IDEuMjsgcG9pbnRlci1ldmVudHM6IGFsbDsgd2hpdGUtc3BhY2U6IG5vcm1hbDsgd29yZC13cmFwOiBub3JtYWw7ICI+YTwvZGl2PjwvZGl2PjwvZGl2PjwvZm9yZWlnbk9iamVjdD48dGV4dCB4PSI3MCIgeT0iNjQiIGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJIZWx2ZXRpY2EiIGZvbnQtc2l6ZT0iMTJweCIgdGV4dC1hbmNob3I9Im1pZGRsZSI+YTwvdGV4dD48L3N3aXRjaD48L2c+PHBhdGggZD0iTSAxMDAgMTAwIEwgNzAgMTAwIEwgNzAgODYuMzciIGZpbGw9Im5vbmUiIHN0cm9rZT0iIzI0MjQyNCIgc3Ryb2tlLW1pdGVybGltaXQ9IjEwIiBwb2ludGVyLWV2ZW50cz0ic3Ryb2tlIi8+PHBhdGggZD0iTSA3MCA4MS4xMiBMIDczLjUgODguMTIgTCA3MCA4Ni4zNyBMIDY2LjUgODguMTIgWiIgZmlsbD0iIzI0MjQyNCIgc3Ryb2tlPSIjMjQyNDI0IiBzdHJva2UtbWl0ZXJsaW1pdD0iMTAiIHBvaW50ZXItZXZlbnRzPSJhbGwiLz48cmVjdCB4PSIxMDAiIHk9IjgwIiB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIGZpbGw9IiNmZmZmZmYiIHN0cm9rZT0ibm9uZSIgcG9pbnRlci1ldmVudHM9ImFsbCIvPjxnIHRyYW5zZm9ybT0idHJhbnNsYXRlKC0wLjUgLTAuNSkiPjxzd2l0Y2g+PGZvcmVpZ25PYmplY3Qgc3R5bGU9Im92ZXJmbG93OiB2aXNpYmxlOyB0ZXh0LWFsaWduOiBsZWZ0OyIgcG9pbnRlci1ldmVudHM9Im5vbmUiIHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIHJlcXVpcmVkRmVhdHVyZXM9Imh0dHA6Ly93d3cudzMub3JnL1RSL1NWRzExL2ZlYXR1cmUjRXh0ZW5zaWJpbGl0eSI+PGRpdiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94aHRtbCIgc3R5bGU9ImRpc3BsYXk6IGZsZXg7IGFsaWduLWl0ZW1zOiB1bnNhZmUgY2VudGVyOyBqdXN0aWZ5LWNvbnRlbnQ6IHVuc2FmZSBjZW50ZXI7IHdpZHRoOiAzOHB4OyBoZWlnaHQ6IDFweDsgcGFkZGluZy10b3A6IDEwMHB4OyBtYXJnaW4tbGVmdDogMTAxcHg7Ij48ZGl2IHN0eWxlPSJib3gtc2l6aW5nOiBib3JkZXItYm94OyBmb250LXNpemU6IDA7IHRleHQtYWxpZ246IGNlbnRlcjsgIj48ZGl2IHN0eWxlPSJkaXNwbGF5OiBpbmxpbmUtYmxvY2s7IGZvbnQtc2l6ZTogMTJweDsgZm9udC1mYW1pbHk6IEhlbHZldGljYTsgY29sb3I6ICMwMDAwMDA7IGxpbmUtaGVpZ2h0OiAxLjI7IHBvaW50ZXItZXZlbnRzOiBhbGw7IHdoaXRlLXNwYWNlOiBub3JtYWw7IHdvcmQtd3JhcDogbm9ybWFsOyAiPmI8L2Rpdj48L2Rpdj48L2Rpdj48L2ZvcmVpZ25PYmplY3Q+PHRleHQgeD0iMTIwIiB5PSIxMDQiIGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJIZWx2ZXRpY2EiIGZvbnQtc2l6ZT0iMTJweCIgdGV4dC1hbmNob3I9Im1pZGRsZSI+YjwvdGV4dD48L3N3aXRjaD48L2c+PHBhdGggZD0iTSAxNTAgMTQwIEwgMTIwIDE0MCBMIDEyMCAxMjYuMzciIGZpbGw9Im5vbmUiIHN0cm9rZT0iIzI0MjQyNCIgc3Ryb2tlLW1pdGVybGltaXQ9IjEwIiBwb2ludGVyLWV2ZW50cz0ic3Ryb2tlIi8+PHBhdGggZD0iTSAxMjAgMTIxLjEyIEwgMTIzLjUgMTI4LjEyIEwgMTIwIDEyNi4zNyBMIDExNi41IDEyOC4xMiBaIiBmaWxsPSIjMjQyNDI0IiBzdHJva2U9IiMyNDI0MjQiIHN0cm9rZS1taXRlcmxpbWl0PSIxMCIgcG9pbnRlci1ldmVudHM9ImFsbCIvPjxyZWN0IHg9IjE1MCIgeT0iMTIwIiB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIGZpbGw9IiNmZmZmZmYiIHN0cm9rZT0ibm9uZSIgcG9pbnRlci1ldmVudHM9ImFsbCIvPjxnIHRyYW5zZm9ybT0idHJhbnNsYXRlKC0wLjUgLTAuNSkiPjxzd2l0Y2g+PGZvcmVpZ25PYmplY3Qgc3R5bGU9Im92ZXJmbG93OiB2aXNpYmxlOyB0ZXh0LWFsaWduOiBsZWZ0OyIgcG9pbnRlci1ldmVudHM9Im5vbmUiIHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIHJlcXVpcmVkRmVhdHVyZXM9Imh0dHA6Ly93d3cudzMub3JnL1RSL1NWRzExL2ZlYXR1cmUjRXh0ZW5zaWJpbGl0eSI+PGRpdiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94aHRtbCIgc3R5bGU9ImRpc3BsYXk6IGZsZXg7IGFsaWduLWl0ZW1zOiB1bnNhZmUgY2VudGVyOyBqdXN0aWZ5LWNvbnRlbnQ6IHVuc2FmZSBjZW50ZXI7IHdpZHRoOiAzOHB4OyBoZWlnaHQ6IDFweDsgcGFkZGluZy10b3A6IDE0MHB4OyBtYXJnaW4tbGVmdDogMTUxcHg7Ij48ZGl2IHN0eWxlPSJib3gtc2l6aW5nOiBib3JkZXItYm94OyBmb250LXNpemU6IDA7IHRleHQtYWxpZ246IGNlbnRlcjsgIj48ZGl2IHN0eWxlPSJkaXNwbGF5OiBpbmxpbmUtYmxvY2s7IGZvbnQtc2l6ZTogMTJweDsgZm9udC1mYW1pbHk6IEhlbHZldGljYTsgY29sb3I6ICMwMDAwMDA7IGxpbmUtaGVpZ2h0OiAxLjI7IHBvaW50ZXItZXZlbnRzOiBhbGw7IHdoaXRlLXNwYWNlOiBub3JtYWw7IHdvcmQtd3JhcDogbm9ybWFsOyAiPmM8L2Rpdj48L2Rpdj48L2Rpdj48L2ZvcmVpZ25PYmplY3Q+PHRleHQgeD0iMTcwIiB5PSIxNDQiIGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJIZWx2ZXRpY2EiIGZvbnQtc2l6ZT0iMTJweCIgdGV4dC1hbmNob3I9Im1pZGRsZSI+YzwvdGV4dD48L3N3aXRjaD48L2c+PHJlY3QgeD0iMCIgeT0iMCIgd2lkdGg9IjQwIiBoZWlnaHQ9IjQwIiBmaWxsPSIjZmZmZmZmIiBzdHJva2U9IiMwMDAwMDAiIHBvaW50ZXItZXZlbnRzPSJhbGwiLz48ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgtMC41IC0wLjUpIj48c3dpdGNoPjxmb3JlaWduT2JqZWN0IHN0eWxlPSJvdmVyZmxvdzogdmlzaWJsZTsgdGV4dC1hbGlnbjogbGVmdDsiIHBvaW50ZXItZXZlbnRzPSJub25lIiB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiByZXF1aXJlZEZlYXR1cmVzPSJodHRwOi8vd3d3LnczLm9yZy9UUi9TVkcxMS9mZWF0dXJlI0V4dGVuc2liaWxpdHkiPjxkaXYgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGh0bWwiIHN0eWxlPSJkaXNwbGF5OiBmbGV4OyBhbGlnbi1pdGVtczogdW5zYWZlIGNlbnRlcjsganVzdGlmeS1jb250ZW50OiB1bnNhZmUgY2VudGVyOyB3aWR0aDogMzhweDsgaGVpZ2h0OiAxcHg7IHBhZGRpbmctdG9wOiAyMHB4OyBtYXJnaW4tbGVmdDogMXB4OyI+PGRpdiBzdHlsZT0iYm94LXNpemluZzogYm9yZGVyLWJveDsgZm9udC1zaXplOiAwOyB0ZXh0LWFsaWduOiBjZW50ZXI7ICI+PGRpdiBzdHlsZT0iZGlzcGxheTogaW5saW5lLWJsb2NrOyBmb250LXNpemU6IDEycHg7IGZvbnQtZmFtaWx5OiBIZWx2ZXRpY2E7IGNvbG9yOiAjMDAwMDAwOyBsaW5lLWhlaWdodDogMS4yOyBwb2ludGVyLWV2ZW50czogYWxsOyBmb250LXN0eWxlOiBpdGFsaWM7IHdoaXRlLXNwYWNlOiBub3JtYWw7IHdvcmQtd3JhcDogbm9ybWFsOyAiPihyb290KTwvZGl2PjwvZGl2PjwvZGl2PjwvZm9yZWlnbk9iamVjdD48dGV4dCB4PSIyMCIgeT0iMjQiIGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJIZWx2ZXRpY2EiIGZvbnQtc2l6ZT0iMTJweCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1zdHlsZT0iaXRhbGljIj4ocm9vdCk8L3RleHQ+PC9zd2l0Y2g+PC9nPjwvZz48c3dpdGNoPjxnIHJlcXVpcmVkRmVhdHVyZXM9Imh0dHA6Ly93d3cudzMub3JnL1RSL1NWRzExL2ZlYXR1cmUjRXh0ZW5zaWJpbGl0eSIvPjxhIHRyYW5zZm9ybT0idHJhbnNsYXRlKDAsLTUpIiB4bGluazpocmVmPSJodHRwczovL3d3dy5kaWFncmFtcy5uZXQvZG9jL2ZhcS9zdmctZXhwb3J0LXRleHQtcHJvYmxlbXMiIHRhcmdldD0iX2JsYW5rIj48dGV4dCB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LXNpemU9IjEwcHgiIHg9IjUwJSIgeT0iMTAwJSI+Vmlld2VyIGRvZXMgbm90IHN1cHBvcnQgZnVsbCBTVkcgMS4xPC90ZXh0PjwvYT48L3N3aXRjaD48L3N2Zz4=\" />\n"],[6135,6616,""],[6135,0,"<svg xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" version=\"1.1\" width=\"192px\" viewBox=\"-0.5 -0.5 192 162\" style=\"max-width:100%;max-height:162px;\"><defs/><g><path d=\"M 51 61 L 21 61 L 21 47.37\" fill=\"none\" stroke=\"#242424\" stroke-miterlimit=\"10\" pointer-events=\"stroke\"/><path d=\"M 21 42.12 L 24.5 49.12 L 21 47.37 L 17.5 49.12 Z\" fill=\"#242424\" stroke=\"#242424\" stroke-miterlimit=\"10\" pointer-events=\"all\"/><rect x=\"51\" y=\"41\" width=\"40\" height=\"40\" fill=\"#ffffff\" stroke=\"#808080\" stroke-width=\"2\" pointer-events=\"all\"/><g transform=\"translate(-0.5 -0.5)\"><switch><foreignObject style=\"overflow: visible; text-align: left;\" pointer-events=\"none\" width=\"100%\" height=\"100%\" requiredFeatures=\"http://www.w3.org/TR/SVG11/feature#Extensibility\"><div xmlns=\"http://www.w3.org/1999/xhtml\" style=\"display: flex; align-items: unsafe center; justify-content: unsafe center; width: 38px; height: 1px; padding-top: 61px; margin-left: 52px;\"><div style=\"box-sizing: border-box; font-size: 0; text-align: center; \"><div style=\"display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; \">a</div></div></div></foreignObject><text x=\"71\" y=\"65\" fill=\"#000000\" font-family=\"Helvetica\" font-size=\"12px\" text-anchor=\"middle\">a</text></switch></g><path d=\"M 101 101 L 71 101 L 71 87.37\" fill=\"none\" stroke=\"#242424\" stroke-miterlimit=\"10\" pointer-events=\"stroke\"/><path d=\"M 71 82.12 L 74.5 89.12 L 71 87.37 L 67.5 89.12 Z\" fill=\"#242424\" stroke=\"#242424\" stroke-miterlimit=\"10\" pointer-events=\"all\"/><rect x=\"101\" y=\"81\" width=\"40\" height=\"40\" fill=\"#ffffff\" stroke=\"#808080\" stroke-width=\"2\" pointer-events=\"all\"/><g transform=\"translate(-0.5 -0.5)\"><switch><foreignObject style=\"overflow: visible; text-align: left;\" pointer-events=\"none\" width=\"100%\" height=\"100%\" requiredFeatures=\"http://www.w3.org/TR/SVG11/feature#Extensibility\"><div xmlns=\"http://www.w3.org/1999/xhtml\" style=\"display: flex; align-items: unsafe center; justify-content: unsafe center; width: 38px; height: 1px; padding-top: 101px; margin-left: 102px;\"><div style=\"box-sizing: border-box; font-size: 0; text-align: center; \"><div style=\"display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; \">b</div></div></div></foreignObject><text x=\"121\" y=\"105\" fill=\"#000000\" font-family=\"Helvetica\" font-size=\"12px\" text-anchor=\"middle\">b</text></switch></g><path d=\"M 151 141 L 121 141 L 121 127.37\" fill=\"none\" stroke=\"#242424\" stroke-miterlimit=\"10\" pointer-events=\"stroke\"/><path d=\"M 121 122.12 L 124.5 129.12 L 121 127.37 L 117.5 129.12 Z\" fill=\"#242424\" stroke=\"#242424\" stroke-miterlimit=\"10\" pointer-events=\"all\"/><rect x=\"151\" y=\"121\" width=\"40\" height=\"40\" fill=\"#ffffff\" stroke=\"#808080\" stroke-width=\"2\" pointer-events=\"all\"/><g transform=\"translate(-0.5 -0.5)\"><switch><foreignObject style=\"overflow: visible; text-align: left;\" pointer-events=\"none\" width=\"100%\" height=\"100%\" requiredFeatures=\"http://www.w3.org/TR/SVG11/feature#Extensibility\"><div xmlns=\"http://www.w3.org/1999/xhtml\" style=\"display: flex; align-items: unsafe center; justify-content: unsafe center; width: 38px; height: 1px; padding-top: 141px; margin-left: 152px;\"><div style=\"box-sizing: border-box; font-size: 0; text-align: center; \"><div style=\"display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; \">c</div></div></div></foreignObject><text x=\"171\" y=\"145\" fill=\"#000000\" font-family=\"Helvetica\" font-size=\"12px\" text-anchor=\"middle\">c</text></switch></g><rect x=\"1\" y=\"1\" width=\"40\" height=\"40\" fill=\"#ffffff\" stroke=\"#808080\" stroke-width=\"2\" pointer-events=\"all\"/><g transform=\"translate(-0.5 -0.5)\"><switch><foreignObject style=\"overflow: visible; text-align: left;\" pointer-events=\"none\" width=\"100%\" height=\"100%\" requiredFeatures=\"http://www.w3.org/TR/SVG11/feature#Extensibility\"><div xmlns=\"http://www.w3.org/1999/xhtml\" style=\"display: flex; align-items: unsafe center; justify-content: unsafe center; width: 38px; height: 1px; padding-top: 21px; margin-left: 2px;\"><div style=\"box-sizing: border-box; font-size: 0; text-align: center; \"><div style=\"display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; font-style: italic; white-space: normal; word-wrap: normal; \">(root)</div></div></div></foreignObject><text x=\"21\" y=\"25\" fill=\"#000000\" font-family=\"Helvetica\" font-size=\"12px\" text-anchor=\"middle\" font-style=\"italic\">(root)</text></switch></g></g><switch><g requiredFeatures=\"http://www.w3.org/TR/SVG11/feature#Extensibility\"/><a transform=\"translate(0,-5)\" xlink:href=\"https://www.diagrams.net/doc/faq/svg-export-text-problems\" target=\"_blank\"><text text-anchor=\"middle\" font-size=\"10px\" x=\"50%\" y=\"100%\">Viewer does not support full SVG 1.1</text></a></switch></svg>"],[6134,5033,""],[6134,0,"\n\n"],[6135,0,"> automerge1.drawio.svg"],[6433,12,""],[6433,0,"automerge2.draio"],[6448,1,""],[6447,1,""],[6447,0,"wio.svg"],[6505,58,""],[6581,1,""],[6581,0,". Hang on, how do we figure out which character goes first? "],[6641,6,""],[6641,0,"W"],[6583,0,"But "],[6587,1,""],[6587,0,"h"],[6543,12,""],[6542,1,""],[6635,3,""],[6635,0,"could just picked"],[6651,1,""],[6650,1,""],[6547,0," concurrently"],[6581,0," in the document"],[6675,49,""],[6675,0,"sort by their "],[6689,4,""],[6689,0,"u"],[6689,1,""],[6689,0,"agent"],[6698,0," or something"],[6515,10,""],[6587,0,", o"],[6589,1,""],[6588,1,""],[6587,1,""],[6592,9,""],[6661,2,""],[6661,0,"using"],[6734,5,""],[6734,0,"could"],[6770,17,""],[6770,0,"m"],[6770,1,""],[6770,0,"Mike inserted *X*"],[6963,8,""],[6963,0,"sometin"],[6969,1,""],[6968,1,""],[6968,0,"hing"],[6846,0," (RGA)"],[7431,0," "],[7431,1,""],[7431,0," The rule is that the bigge"],[7449,9,""],[7449,0,"whenever"],[7449,8,""],[7449,0,"children are sorted first based on theisr"],[7489,1,""],[7488,1,""],[7487,1,""],[7487,0,"r"],[7487,1,""],[7487,0,"ir sequence numbers (bug"],[7510,1,""],[7509,1,""],[7509,0,"igger sequence number first). Then they're "],[7539,13,""],[7539,0,"On"],[7540,1,""],[7539,1,""],[7539,0,"If the sequence numbers match, they get"],[7539,3,""],[7539,0,"Only if "],[7583,0," sorted based on their "],[7539,6,""],[7539,0,"I"],[7569,0," they must be concurrent changes. In that case"],[7632,0,"arbitrarily "],[7659,0,"agent IDs."],[7431,1,""],[7431,0,"\n\n"],[7571,4,""],[7571,0,"the changes"],[7601,8,""],[7616,8,""],[7616,0,"we"],[7618,7,""],[7618,0," sort them"],[7619,0,"can "],[7670,0," (We do this because we"],[7692,1,""],[7691,1,""],[7691,0,"all peers"],[7691,9,""],[7691,0,"its important all peers ne"],[7716,1,""],[7715,1,""],[7715,0,"end up with the same document)"],[7744,0,"."],[7677,0," it this way"],[7689,5,""],[7690,21,""],[7690,0,"so"],[7723,0," resulting"],[9521,1,""],[9521,0,"6"],[9819,2,""],[9819,0,"I'm"],[9822,4,""],[9829,1,""],[9829,0,"ing"],[9821,11,""],[9821,0,"ll compare"],[9879,8,""],[9879,0," edits"],[9937,4,""],[9964,5,""],[9964,0," do"],[9989,5,""],[11635,0,"from microoptimizations - "],[11645,0,"-"],[11635,27,""],[11699,1,""],[11699,0,"."],[11701,1,""],[11701,0,"B"],[11686,0," lots of"],[12342,0," If I werwe"],[12352,1,""],[12351,1,""],[12351,0,"e going to build col"],[12368,3,""],[12368,0,"c"],[12368,1,""],[12368,0,"software which supporte"],[12390,1,""],[12390,0,"s collaborative editing today, I'd build it on yjs."],[12437,1,""],[12437,0,"Y"],[12425,12,""],[12425,0,"use "],[10325,0,"\nWe"],[10327,1,""],[10326,1,""],[10326,0,"This is a chart of automerge's "],[10326,31,""],[10326,0,"Automerge"],[10326,9,""],[10326,0,"This is a chart of automerge\n\n<svg class=\"plot\" fill=\"currentColor\" text-anchor=\"middle\" width=\"700\" height=\"400\" viewBox=\"0 0 700 400\"><g transform=\"translate(40,0)\" fill=\"none\" text-anchor=\"end\"><g class=\"tick\" opacity=\"1\" transform=\"translate(0,370.5)\"><line stroke=\"currentColor\" x2=\"-6\"></line><line stroke=\"currentColor\" x2=\"600\" stroke-opacity=\"0.1\"></line><text fill=\"currentColor\" x=\"-9\" dy=\"0.32em\">0.0</text></g><g class=\"tick\" opacity=\"1\" transform=\"translate(0,322.49637377865497)\"><line stroke=\"currentColor\" x2=\"-6\"></line><line stroke=\"currentColor\" x2=\"600\" stroke-opacity=\"0.1\"></line><text fill=\"currentColor\" x=\"-9\" dy=\"0.32em\">0.5</text></g><g class=\"tick\" opacity=\"1\" transform=\"translate(0,274.4927475573099)\"><line stroke=\"currentColor\" x2=\"-6\"></line><line stroke=\"currentColor\" x2=\"600\" stroke-opacity=\"0.1\"></line><text fill=\"currentColor\" x=\"-9\" dy=\"0.32em\">1.0</text></g><g class=\"tick\" opacity=\"1\" transform=\"translate(0,226.48912133596485)\"><line stroke=\"currentColor\" x2=\"-6\"></line><line stroke=\"currentColor\" x2=\"600\" stroke-opacity=\"0.1\"></line><text fill=\"currentColor\" x=\"-9\" dy=\"0.32em\">1.5</text></g><g class=\"tick\" opacity=\"1\" transform=\"translate(0,178.48549511461982)\"><line stroke=\"currentColor\" x2=\"-6\"></line><line stroke=\"currentColor\" x2=\"600\" stroke-opacity=\"0.1\"></line><text fill=\"currentColor\" x=\"-9\" dy=\"0.32em\">2.0</text></g><g class=\"tick\" opacity=\"1\" transform=\"translate(0,130.48186889327476)\"><line stroke=\"currentColor\" x2=\"-6\"></line><line stroke=\"currentColor\" x2=\"600\" stroke-opacity=\"0.1\"></line><text fill=\"currentColor\" x=\"-9\" dy=\"0.32em\">2.5</text></g><g class=\"tick\" opacity=\"1\" transform=\"translate(0,82.47824267192972)\"><line stroke=\"currentColor\" x2=\"-6\"></line><line stroke=\"currentColor\" x2=\"600\" stroke-opacity=\"0.1\"></line><text fill=\"currentColor\" x=\"-9\" dy=\"0.32em\">3.0</text></g><g class=\"tick\" opacity=\"1\" transform=\"translate(0,34.47461645058467)\"><line stroke=\"currentColor\" x2=\"-6\"></line><line stroke=\"currentColor\" x2=\"600\" stroke-opacity=\"0.1\"></line><text fill=\"currentColor\" x=\"-9\" dy=\"0.32em\">3.5</text></g><text fill=\"currentColor\" transform=\"translate(-40,20)\" dy=\"-1em\" text-anchor=\"start\"> time per txn (ms)</text></g><g transform=\"translate(0,370)\" fill=\"none\" text-anchor=\"middle\"><g class=\"tick\" opacity=\"1\" transform=\"translate(40.5,0)\"><line stroke=\"currentColor\" y2=\"6\"></line><line stroke=\"currentColor\" y2=\"-350\" stroke-opacity=\"0.1\"></line><text fill=\"currentColor\" y=\"9\" dy=\"0.71em\">0</text></g><g class=\"tick\" opacity=\"1\" transform=\"translate(155.98322028809213,0)\"><line stroke=\"currentColor\" y2=\"6\"></line><line stroke=\"currentColor\" y2=\"-350\" stroke-opacity=\"0.1\"></line><text fill=\"currentColor\" y=\"9\" dy=\"0.71em\">50,000</text></g><g class=\"tick\" opacity=\"1\" transform=\"translate(271.46644057618425,0)\"><line stroke=\"currentColor\" y2=\"6\"></line><line stroke=\"currentColor\" y2=\"-350\" stroke-opacity=\"0.1\"></line><text fill=\"currentColor\" y=\"9\" dy=\"0.71em\">100,000</text></g><g class=\"tick\" opacity=\"1\" transform=\"translate(386.94966086427644,0)\"><line stroke=\"currentColor\" y2=\"6\"></line><line stroke=\"currentColor\" y2=\"-350\" stroke-opacity=\"0.1\"></line><text fill=\"currentColor\" y=\"9\" dy=\"0.71em\">150,000</text></g><g class=\"tick\" opacity=\"1\" transform=\"translate(502.43288115236857,0)\"><line stroke=\"currentColor\" y2=\"6\"></line><line stroke=\"currentColor\" y2=\"-350\" stroke-opacity=\"0.1\"></line><text fill=\"currentColor\" y=\"9\" dy=\"0.71em\">200,000</text></g><g class=\"tick\" opacity=\"1\" transform=\"translate(617.9161014404607,0)\"><line stroke=\"currentColor\" y2=\"6\"></line><line stroke=\"currentColor\" y2=\"-350\" stroke-opacity=\"0.1\"></line><text fill=\"currentColor\" y=\"9\" dy=\"0.71em\">250,000</text></g><text fill=\"currentColor\" transform=\"translate(700,30)\" dy=\"-0.32em\" text-anchor=\"end\">txns </text></g><g fill=\"none\" stroke=\"purple\" stroke-width=\"1.5\" stroke-miterlimit=\"1\" transform=\"translate(0.5,0.5)\"><path d=\"M42.30966440576184,334.968453217152L44.61932881152369,347.3297060008833L46.92899321728553,352.3034286308774L49.238657623047374,353.85148461209457L51.54832202880921,353.99288937369545L53.85798643457106,353.119184685576L56.1676508403329,353.5882125643014L58.47731524609475,353.94662789479634L60.78697965185658,354.0068946236547L63.096644057618434,354.1490683078529L65.40630846338027,353.5765641960213L67.71597286914212,353.6863778677001L70.02563727490396,353.28293398339684L72.3353016806658,352.9293209351293L74.64496608642764,352.9794113749642L76.9546304921895,350.64519971937096L79.26429489795132,347.5166021671373L81.57395930371317,346.34497410983045L83.88362370947502,346.06483080366127L86.19328811523685,329.7538633679724L88.5029525209987,341.20606687397316L90.81261692676054,344.17714897508205L93.12228133252239,344.02096322473784L95.43194573828421,339.15071317905466L97.74161014404606,337.4161803915942L100.05127454980791,345.529651911968L102.36093895556976,334.43219213151616L104.6706033613316,332.6128071740481L106.98026776709344,329.1433388486094L109.28993217285529,330.72351626400473L111.59959657861712,327.0967618490162L113.90926098437896,329.89010082727265L116.21892539014081,339.2226639901794L118.52858979590265,331.50890378474145L120.8382542016645,325.2647309122023L123.14791860742633,324.43846311967076L125.45758301318818,323.29314824950376L127.76724741895003,324.4245276667778L130.07691182471186,297.0018474059277L132.3865762304737,327.2634034611283L134.69624063623556,318.67958991494424L137.0059050419974,320.79089999648323L139.31556944775923,317.08631403777366L141.62523385352108,317.1262170522847L143.93489825928293,315.5594217036104L146.24456266504478,313.9409277935827L148.55422707080663,315.99555768979025L150.86389147656845,313.1872971679967L153.1735558823303,311.8466137798146L155.48322028809213,311.6192958724972L157.79288469385398,312.18679733346215L160.10254909961583,275.0526459267001L162.41221350537768,307.67335132936387L164.7218779111395,312.81199444924806L167.03154231690135,312.0217097908432L169.3412067226632,319.40058767560174L171.65087112842502,303.2904382256132L173.96053553418687,306.0601856298547L176.27019993994872,323.22592646787865L178.57986434571058,338.4754829397754L180.8895287514724,324.0422604860777L183.19919315723425,311.7291642678771L185.5088575629961,317.5852446235697L187.81852196875795,325.754799163999L190.1281863745198,273.2218301538354L192.43785078028165,307.0379464344723L194.74751518604347,308.3675182314111L197.0571795918053,305.8125952144778L199.36684399756714,315.50578542817016L201.676508403329,310.0300645885391L203.98617280909085,304.62440782643097L206.29583721485267,302.907305923881L208.60550162061452,300.7181531616053L210.91516602637637,309.3549651114627L213.22483043213822,334.854562309457L215.53449483790007,256.6764747401852L217.8441592436619,306.02416966122115L220.1538236494237,310.3887761981957L222.46348805518556,303.43580943104564L224.77315246094741,297.79652458815247L227.08281686670927,300.0300648629319L229.39248127247112,331.8233899414033L231.70214567823297,308.30299991729026L234.01181008399482,294.57287976030636L236.32147448975667,306.4273207234548L238.63113889551846,250.2423452782171L240.9408033012803,299.7219722136838L243.25046770704216,310.1519343708049L245.560132112804,298.3395931638715L247.86979651856586,296.9839028824633L250.17946092432769,294.8186880886822L252.48912533008954,315.4002676011884L254.7987897358514,328.7540567058032L257.10845414161327,296.1958934037708L259.41811854737506,285.1752623706938L261.7277829531369,223.7808467136446L264.0374473588987,293.1937300104379L266.3471117646606,289.9869132376882L268.65677617042246,291.6462404722998L270.96644057618425,289.42647291779764L273.27610498194616,288.73305852091545L275.58576938770796,285.40769612092686L277.8954337934698,211.52907397574947L280.20509819923166,296.8787805094819L282.5147626049935,282.295329170959L284.82442701075536,280.7163715275385L287.1340914165172,272.5731189417396L289.443755822279,275.0129783224233L291.75342022804085,276.9126581770053L294.0630846338027,189.08334506829772L296.37274903956455,269.75095167386496L298.6824134453264,267.29315698612555L300.9920778510882,265.8590805276817L303.30174225685005,264.501607487239L305.6114066626119,269.3548107729358L307.92107106837375,268.8816247241124L310.23073547413566,202.03719512981164L312.54039987989745,283.08538581221364L314.8500642856593,286.0625855919234L317.15972869142115,285.31391182056876L319.469393097183,283.6213318017489L321.7790575029448,191.616563149324L324.0887219087067,279.98515686757565L326.3983863144685,289.1524945249947L328.70805072023035,263.5754665180542L331.0177151259922,266.8788627463574L333.32737953175405,255.23313406131842L335.6370439375159,153.86730210866077L337.9467083432777,301.99399449969684L340.2563727490396,290.8151097199587L342.5660371548014,271.37666532881445L344.8757015605633,243.9075814030077L347.1853659663251,247.42484492269904L349.49503037208694,143.05820126289254L351.80469477784874,241.84426073806134L354.1143591836106,239.0242903080998L356.4240235893725,292.0706584851939L358.7336879951343,320.2314768731976L361.04335240089614,320.6956649302387L363.353016806658,320.0829015220471L365.66268121241984,321.2679022376054L367.9723456181817,322.1500064081641L370.2820100239436,279.7812966036057L372.59167442970534,150.62350929459564L374.90133883546713,257.0801537460953L377.21100324122904,255.46705246774198L379.5206676469909,248.08051474050524L381.83033205275274,318.5028032163361L384.1399964585146,276.7833899801005L386.44966086427644,152.70123680729728L388.75932527003823,256.6348536760652L391.06898967580014,245.0570589547315L393.378654081562,270.61816627165695L395.6883184873238,291.8337743186176L397.99798289308563,280.8975785923264L400.3076472988474,253.8488537800058L402.61731170460934,147.2092245933975L404.92697611037113,267.5180237332205L407.23664051613304,269.12887056904947L409.54630492189483,263.69664792804076L411.8559693276567,261.98689326829947L414.16563373341853,139.71486284935736L416.4752981391804,261.370087858105L418.78496254494223,255.87257318100725L421.0946269507041,251.42154830828582L423.40429135646593,131.12237322332066L425.7139557622277,249.9432022329065L428.02362016798963,256.1754197061827L430.3332845737514,254.50504213301897L432.64294897951333,146.26343237985773L434.9526133852751,315.7184830632591L437.2622777910369,302.10868524317397L439.57194219679883,255.69386672151452L441.8816066025606,256.41916570277965L444.19127100832253,248.13793562231044L446.5009354140843,114.02454935610312L448.8105998198462,287.79113971980667L451.120264225608,312.85080038886963L453.42992863136993,247.3359109086496L455.7395930371317,243.34848556827768L458.04925744289346,257.7248076918354L460.35892184865537,119.47206998493448L462.6685862544172,265.91938940330715L464.97825066017907,242.72561048392126L467.2879150659409,282.8106164159161L469.5975794717028,107.43905265210508L471.90724387746457,262.2833716323476L474.2169082832265,252.86015026091383L476.5265726889883,269.4731244463173L478.8362370947501,233.83269544419872L481.14590150051197,100.98776160576477L483.45556590627376,244.24007151106983L485.76523031203567,301.8079308123864L488.07489471779746,92.276266478406L490.38455912355937,244.46197624194338L492.6942235293212,310.48604681001416L495.003887935083,312.8078811147665L497.31355234084486,313.28568309617674L499.6232167466067,314.5272652056339L501.93288115236857,314.03204683685385L504.2425455581304,314.7672865055629L506.55220996389227,314.0681960634063L508.86187436965406,314.9782533216905L511.17153877541597,278.2343911738366L513.4812031811778,103.58778921321984L515.7908675869396,256.7088159354081L518.1005319927015,252.40193097464996L520.4101963984633,310.27312490170635L522.7198608042252,313.89856161738174L525.029525209987,117.09933023463333L527.3391896157488,250.46510226563396L529.6488540215107,252.63180133148424L531.9585184272726,281.29381511586587L534.2681828330344,97.4889116048936L536.5778472387963,254.0046295795242L538.887511644558,268.9243289417631L541.1971760503199,236.43463906860703L543.5068404560817,243.32870538611743L545.8165048618436,84.21007881810141L548.1261692676054,248.48442243559901L550.4358336733673,235.82050822847495L552.7454980791291,250.43728877275638L555.055162484891,81.18646414056792L557.3648268906528,257.0717637683346L559.6744912964147,253.72565890605804L561.9841557021764,249.73066156932813L564.2938201079384,254.28819573630133L566.6034845137001,78.48691944732096L568.9131489194621,224.2537264993702L571.2228133252238,239.2663311199341L573.5324777309856,232.68035053927576L575.8421421367475,69.11175796229507L578.1518065425093,250.54871478950017L580.4614709482713,267.08943890964383L582.771135354033,249.6621817083864L585.0807997597949,47.52002115006532L587.3904641655568,217.37818785303227L589.7001285713186,203.3479695705606L592.0097929770805,60.56641231392514L594.3194573828423,232.57566269516408L596.629121788604,228.98581452406694L598.938786194366,214.00566179434387L601.2484506001277,100.80896576366655L603.5581150058896,203.38959245872059L605.8677794116514,260.22470453529644L608.1774438174134,282.70516752262176L610.4871082231753,20L612.796772628937,219.03020807171086L615.106437034699,238.11778445410738L617.4161014404607,58.48072724002276L619.7257658462227,291.5684325466767L622.0354302519844,306.4843494155757L624.3450946577461,297.73916524730816L626.6547590635081,260.0212592150145L628.9644234692698,209.87775537831772L631.2740878750318,29.030959931952616L633.5837522807935,287.9655590713959L635.8934166865554,262.31117053219054L638.2030810923173,271.11027026144575L640,274.7612139915496\"></path></g><g stroke=\"currentColor\" transform=\"translate(0,0.5)\"><line x1=\"40\" x2=\"640\" y1=\"370\" y2=\"370\"></line></g></svg>"],[10356,13540,""],[10354,0,"'s performance "],[10342,27,""],[10342,0,"showing how long each in"],[10350,16,""],[10350,0,"the time taken d"],[10365,1,""],[10365,0,"for each chunk of 10"],[10384,1,""],[10384,0,"000 operations while running the test. "],[10359,9,""],[10359,0,"spent processing"],[10406,13,""],[10406,0,"during"],[10423,0," "],[10423,1,""],[10423,0,"There's a lot going on here. "],[10423,29,""],[10423,0,"I think those spikes h"],[10444,1,""],[10444,0,"are the garbage "],[10448,4,""],[10448,0,"V8's "],[10461,0,"collector trying to free up memory. The spikes get both slower and more frequent as the "],[10326,223,""],[10326,0,"This is a chart showing the time spent processing each chunk of 1000 operations during the test. I think those spikes are V8's garbage collector trying to free up memory. The spikes get both slower and more frequent as the"],[10550,0,"> am_perf1.svg"],[10511,5,""],[10543,0," document grows."],[10359,5,""],[10359,0,"taken to"],[10409,6,""],[10409,0,"throughout"],[10429,0," T"],[10430,1,""],[10430,0,"(The times show average"],[10435,5,""],[10435,0,"y"],[10435,1,""],[10435,0,"Y axis shows"],[10453,0,"*"],[10461,0,"* time "],[10429,39,""],[10377,1,""],[10376,1,""],[10375,1,""],[10375,19,""],[10375,0," each"],[10390,1,""],[10410,0,", "],[10411,1,""],[10410,1,""],[10410,0,", bucketed into groups of 1000 operations"],[10412,8,""],[10412,0,"averaged"],[10421,4,""],[10421,0,"in"],[10547,40,""],[10547,0,"as the test "],[10524,35,""],[13430,0,":"],[13383,0,":"],[13336,0,":"],[13433,0," "],[13385,0," "],[13337,0," "],[13436,0,"["],[13387,0,"["],[13338,0,"["],[13439,0,"."],[13389,0,"."],[13339,0,"."],[13442,0,"."],[13391,0,"."],[13340,0,"."],[13445,0,"]"],[13393,0,"]"],[13341,0,"]"],[13301,0,": 0"],[13450,1,""],[13397,1,""],[13344,1,""],[13149,1,""],[13103,1,""],[13056,1,""],[13444,1,""],[13392,1,""],[13340,1,""],[13146,1,""],[13101,1,""],[13055,1,""],[13438,1,""],[13387,1,""],[13336,1,""],[13143,1,""],[13099,1,""],[13054,1,""],[13432,1,""],[13382,1,""],[13332,1,""],[13140,1,""],[13097,1,""],[13053,1,""],[13426,1,""],[13377,1,""],[13328,1,""],[13137,1,""],[13095,1,""],[13052,1,""],[13420,1,""],[13372,1,""],[13324,1,""],[13134,1,""],[13093,1,""],[13051,1,""],[15078,0," a bit"],[15080,4,""],[15078,2,""],[13415,0,": [..]"],[13368,0,": [..]"],[13321,0,": [..]"],[13132,0,": [..]"],[13092,0,": [..]"],[13051,0,": [..]"],[13445,6,""],[13392,6,""],[13339,6,""],[13144,6,""],[13098,6,""],[13051,6,""],[15078,0," a bit"],[15079,6,""],[15133,0," in the document"],[15246,4,""],[15246,0,"I"],[15539,0," We're moving the Pareto fronteir "],[15572,1,""],[15571,1,""],[15570,1,""],[15569,1,""],[15569,0,"ier."],[15538,1,""],[15538,0,", which moves"],[15551,13,""],[15563,0,"efficieny "],[15568,1,""],[15568,0,"i"],[15571,0,"c"],[15556,0,"["],[15583,0,"](https://en.wikipedia.org/wiki/Pareto_efficiency)"],[10524,0," That big spike? A group of 1000 edits took 3"],[10568,1,""],[10568,0,"over 3.5"],[10524,52,""],[10540,0,"\n\n That big spike? A group of 1000 edits took over 3.5"],[10542,1,""],[10593,0," seconds to process.\n"],[10613,0," Oof."],[18703,23,""],[18703,0,"We can "],[18703,7,""],[18703,0,"If we s"],[18709,1,""],[18709,0,"zoom in on the diagram above"],[18703,2,""],[18703,0,"You can see this if"],[18754,0,". Th"],[18757,1,""],[18756,1,""],[18755,1,""],[18755,0," The amount of ti"],[18756,16,""],[18755,1,""],[18755,0,"\n\n> ref_perf3.svg"],[18755,0," There's a lot going on here because the insert cursor moves all over the place, and shuffi"],[18845,1,""],[18845,0,"ling elements in an array "],[18834,37,""],[18834,0," during this trace, but you "],[18858,4,""],[18858,0,"the"],[18741,0,"referencer"],[18750,1,""],[18750,0,"-crdts part of the "],[18889,0,"'re s a"],[18895,1,""],[18894,1,""],[18893,1,""],[18892,1,""],[18891,1,""],[18890,1,""],[18889,1,""],[18889,0,"e'"],[18890,1,""],[18889,1,""],[18889,0,"'e s"],[18892,1,""],[18891,1,""],[18890,1,""],[18889,1,""],[18889,0,"re's a strong trend *up and to the right*."],[18903,0,"linear "],[18734,30,""],[18734,0,"on"],[18792,23,""],[18792,0,"inserts are"],[18822,18,""],[18858,0,"during this "],[18857,13,""],[18857,0," "],[18880,0," I assume the section at thee"],[18908,1,""],[18908,0," end was martin "],[18917,7,""],[18917,0,"Martin coming back trhoguh the d"],[18936,13,""],[18935,1,""],[18916,0," when"],[18880,60,""],[18792,0,"the "],[18792,4,""],[18792,0,"martin"],[18792,6,""],[18792,0,"Martin's "],[18808,0," are"],[18792,43,""],[18792,0,"inserts happened all over the place"],[18840,0," obviously"],[18873,22,""],[18873,0,"upwards."],[18873,7,""],[18873,0,"up and to the right"],[18911,0,"\n"],[20517,20,""],[20517,0," the same information"],[21082,0,"the resulting "],[21096,4,""],[22019,0,"\n\n> yjs_perf3"],[22031,1,""],[22031,0,"4.svg"],[22019,0,"\n\nMy reference-crdts implmeention"],[22040,12,""],[22040,0,"implementation gets "],[22021,39,""],[22021,0,"Yjs is a"],[22028,1,""],[22028,0,"basically a line at the "],[22021,31,""],[22021,0,"You can't really tell anything about yjs if we put it on the same scale as "],[22021,75,""],[22021,0,"I can't really put yjs on the same scale as the other algoir"],[22080,1,""],[22079,1,""],[22079,0,"rithms because its so fast."],[22105,1,""],[22105,0,":"],[22124,0,"\n"],[22124,0,"\nBut if we isolate yjs, you can see it (m"],[22164,1,""],[22163,1,""],[22163,0,"(mostly) having linear "],[22179,7,""],[22179,0,"constnat per"],[22179,12,""],[22179,0,"constant performance for any"],[22204,3,""],[22179,8,""],[22179,0,"flat"],[22172,28,""],[22172,0,"performing just as well at the start of the test and at the end."],[22235,1,""],[22235,0,":\n\n> <svg class=\"plot\" fill=\"currentColor\" text-anchor=\"middle\" width=\"700\" height=\"400\" viewBox=\"0 0 700 400\" style=\"background: white none repeat scroll 0% 0%;\"><g transform=\"translate(40,0)\" fill=\"none\" text-anchor=\"end\"><g class=\"tick\" opacity=\"1\" transform=\"translate(0,370.5)\"><line stroke=\"currentColor\" x2=\"-6\"></line><line stroke=\"currentColor\" x2=\"600\" stroke-opacity=\"0.1\"></line><text fill=\"currentColor\" x=\"-9\" dy=\"0.32em\">0.000</text></g><g class=\"tick\" opacity=\"1\" transform=\"translate(0,330.51486076085445)\"><line stroke=\"currentColor\" x2=\"-6\"></line><line stroke=\"currentColor\" x2=\"600\" stroke-opacity=\"0.1\"></line><text fill=\"currentColor\" x=\"-9\" dy=\"0.32em\">0.002</text></g><g class=\"tick\" opacity=\"1\" transform=\"translate(0,290.5297215217089)\"><line stroke=\"currentColor\" x2=\"-6\"></line><line stroke=\"currentColor\" x2=\"600\" stroke-opacity=\"0.1\"></line><text fill=\"currentColor\" x=\"-9\" dy=\"0.32em\">0.004</text></g><g class=\"tick\" opacity=\"1\" transform=\"translate(0,250.5445822825633)\"><line stroke=\"currentColor\" x2=\"-6\"></line><line stroke=\"currentColor\" x2=\"600\" stroke-opacity=\"0.1\"></line><text fill=\"currentColor\" x=\"-9\" dy=\"0.32em\">0.006</text></g><g class=\"tick\" opacity=\"1\" transform=\"translate(0,210.5594430434178)\"><line stroke=\"currentColor\" x2=\"-6\"></line><line stroke=\"currentColor\" x2=\"600\" stroke-opacity=\"0.1\"></line><text fill=\"currentColor\" x=\"-9\" dy=\"0.32em\">0.008</text></g><g class=\"tick\" opacity=\"1\" transform=\"translate(0,170.57430380427223)\"><line stroke=\"currentColor\" x2=\"-6\"></line><line stroke=\"currentColor\" x2=\"600\" stroke-opacity=\"0.1\"></line><text fill=\"currentColor\" x=\"-9\" dy=\"0.32em\">0.010</text></g><g class=\"tick\" opacity=\"1\" transform=\"translate(0,130.58916456512665)\"><line stroke=\"currentColor\" x2=\"-6\"></line><line stroke=\"currentColor\" x2=\"600\" stroke-opacity=\"0.1\"></line><text fill=\"currentColor\" x=\"-9\" dy=\"0.32em\">0.012</text></g><g class=\"tick\" opacity=\"1\" transform=\"translate(0,90.60402532598107)\"><line stroke=\"currentColor\" x2=\"-6\"></line><line stroke=\"currentColor\" x2=\"600\" stroke-opacity=\"0.1\"></line><text fill=\"currentColor\" x=\"-9\" dy=\"0.32em\">0.014</text></g><g class=\"tick\" opacity=\"1\" transform=\"translate(0,50.61888608683553)\"><line stroke=\"currentColor\" x2=\"-6\"></line><line stroke=\"currentColor\" x2=\"600\" stroke-opacity=\"0.1\"></line><text fill=\"currentColor\" x=\"-9\" dy=\"0.32em\">0.016</text></g><text fill=\"currentColor\" transform=\"translate(-40,20)\" dy=\"-1em\" text-anchor=\"start\"> avg time per txn (ms)</text></g><g transform=\"translate(0,370)\" fill=\"none\" text-anchor=\"middle\"><g class=\"tick\" opacity=\"1\" transform=\"translate(40.5,0)\"><line stroke=\"currentColor\" y2=\"6\"></line><line stroke=\"currentColor\" y2=\"-350\" stroke-opacity=\"0.1\"></line><text fill=\"currentColor\" y=\"9\" dy=\"0.71em\">0</text></g><g class=\"tick\" opacity=\"1\" transform=\"translate(155.98322028809213,0)\"><line stroke=\"currentColor\" y2=\"6\"></line><line stroke=\"currentColor\" y2=\"-350\" stroke-opacity=\"0.1\"></line><text fill=\"currentColor\" y=\"9\" dy=\"0.71em\">50,000</text></g><g class=\"tick\" opacity=\"1\" transform=\"translate(271.46644057618425,0)\"><line stroke=\"currentColor\" y2=\"6\"></line><line stroke=\"currentColor\" y2=\"-350\" stroke-opacity=\"0.1\"></line><text fill=\"currentColor\" y=\"9\" dy=\"0.71em\">100,000</text></g><g class=\"tick\" opacity=\"1\" transform=\"translate(386.94966086427644,0)\"><line stroke=\"currentColor\" y2=\"6\"></line><line stroke=\"currentColor\" y2=\"-350\" stroke-opacity=\"0.1\"></line><text fill=\"currentColor\" y=\"9\" dy=\"0.71em\">150,000</text></g><g class=\"tick\" opacity=\"1\" transform=\"translate(502.43288115236857,0)\"><line stroke=\"currentColor\" y2=\"6\"></line><line stroke=\"currentColor\" y2=\"-350\" stroke-opacity=\"0.1\"></line><text fill=\"currentColor\" y=\"9\" dy=\"0.71em\">200,000</text></g><g class=\"tick\" opacity=\"1\" transform=\"translate(617.9161014404607,0)\"><line stroke=\"currentColor\" y2=\"6\"></line><line stroke=\"currentColor\" y2=\"-350\" stroke-opacity=\"0.1\"></line><text fill=\"currentColor\" y=\"9\" dy=\"0.71em\">250,000</text></g><text fill=\"currentColor\" transform=\"translate(700,30)\" dy=\"-0.32em\" text-anchor=\"end\">txns </text></g><g fill=\"none\" stroke=\"blue\" stroke-width=\"1.5\" stroke-miterlimit=\"1\" transform=\"translate(0.5,0.5)\"><path d=\"M42.30966440576184,331.3045814071602L44.61932881152369,331.3281726513708L46.92899321728553,317.2031623359376L49.238657623047374,320.30996767031394L51.54832202880921,324.5561494998344L53.85798643457106,318.80054861881143L56.1676508403329,322.17045619910107L58.47731524609475,317.9318914709247L60.78697965185658,322.536120335409L63.096644057618434,320.6676347178808L65.40630846338027,318.42368870722214L67.71597286914212,325.6765331047233L70.02563727490396,320.6674348185915L72.3353016806658,324.34220899853125L74.64496608642764,320.00146236735725L76.9546304921895,321.81180946626955L79.26429489795132,318.92290314557437L81.57395930371317,323.10450901416675L83.88362370947502,320.64124458570836L86.19328811523685,320.2583868017046L88.5029525209987,323.0325358113214L90.81261692676054,317.763134167238L93.12228133252239,326.08038306978705L95.43194573828421,324.9763932920026L97.74161014404606,325.2328780819742L100.05127454980791,303.1731166207364L102.36093895556976,313.42500655935237L104.6706033613316,322.56730864634795L106.98026776709344,319.5774598876221L109.28993217285529,322.68466509505504L111.59959657861712,318.30173405351576L113.90926098437896,320.89694951522637L116.21892539014081,309.4595202730632L118.52858979590265,320.2042069444228L120.8382542016645,318.2851401781658L123.14791860742633,316.12078462065284L125.45758301318818,298.8351689520023L127.76724741895003,291.3212414850521L130.07691182471186,297.56706021924L132.3865762304737,287.8023693119221L134.69624063623556,323.15089183095284L137.0059050419974,320.82577590953804L139.31556944775923,321.2006366792788L141.62523385352108,324.31483918109416L143.93489825928293,320.1688201525851L146.24456266504478,325.1025264664701L148.55422707080663,320.0064804055508L150.86389147656845,325.4477981195858L153.1735558823303,319.86935142956924L155.48322028809213,323.3210286184828L157.79288469385398,321.120466413925L160.10254909961583,319.88972380366755L162.41221350537768,323.44298327218917L164.7218779111395,318.79135205985676L167.03154231690135,321.3613568994709L169.3412067226632,290.84303926237556L171.65087112842502,324.6245240686047L173.96053553418687,315.76869546334996L176.27019993994872,270.62895196043087L178.57986434571058,204.0013745776499L180.8895287514724,262.0046372681377L183.19919315723425,317.71955038736985L185.5088575629961,276.9875287148924L187.81852196875795,288.72382690772554L190.1281863745198,297.9105325553182L192.43785078028165,320.5408818109297L194.74751518604347,324.52656053216555L197.0571795918053,321.20223602254885L199.36684399756714,289.9629463706867L201.676508403329,305.4076661731511L203.98617280909085,325.24769252594626L206.29583721485267,321.27600861690973L208.60550162061452,326.00778998550203L210.91516602637637,301.6272712117183L213.22483043213822,238.40504823043395L215.53449483790007,318.3081316500306L217.8441592436619,308.71399736343693L220.1538236494237,300.18526715281536L222.46348805518556,317.24952504362983L224.77315246094741,324.93220981426674L227.08281686670927,320.8783564235497L229.39248127247112,299.5511028194817L231.70214567823297,320.8437692288689L234.01181008399482,321.686636016929L236.32147448975667,314.55818535727093L238.63113889551846,310.9775361111746L240.9408033012803,316.84569518766L243.25046770704216,309.83596035145825L245.560132112804,320.4817038755921L247.86979651856586,323.59332734887266L250.17946092432769,319.6206438689118L252.48912533008954,307.6216033084685L254.7987897358514,287.8947550325755L257.10845414161327,305.25092442547464L259.41811854737506,319.6879988321421L261.7277829531369,316.2449384644532L264.0374473588987,310.47672225507415L266.3471117646606,319.4948905328851L268.65677617042246,326.31307656730263L270.96644057618425,323.49054559905113L273.27610498194616,326.7847012543128L275.58576938770796,324.0901427723198L277.8954337934698,302.22207013174227L280.20509819923166,243.24856808823785L282.5147626049935,319.4276955486686L284.82442701075536,322.8252128404381L287.1340914165172,321.6952527636756L289.443755822279,325.2934754959085L291.75342022804085,317.5032308312992L294.0630846338027,325.47760702115966L296.37274903956455,321.3213917882935L298.6824134453264,321.39014619550466L300.9920778510882,326.1225673311962L303.30174225685005,320.41552842243766L305.6114066626119,322.7730322739611L307.92107106837375,315.57716662170344L310.23073547413566,324.18250838387917L312.54039987989745,323.83101899892216L314.8500642856593,327.1049822937151L317.15972869142115,323.63111330457184L319.469393097183,322.67107015591233L321.7790575029448,327.1557433071173L324.0887219087067,323.0679226776373L326.3983863144685,318.1496105454543L328.70805072023035,279.397792945101L331.0177151259922,324.4581859633952L333.32737953175405,322.0938846423003L335.6370439375159,321.9853250284475L337.9467083432777,324.1815087384768L340.2563727490396,326.59757079285436L342.5660371548014,336.09354164371956L344.8757015605633,336.34304880153394L347.1853659663251,338.5556065274863L349.49503037208694,335.47819026148954L351.80469477784874,337.3090698624702L354.1143591836106,332.5620940625089L356.4240235893725,308.5890437735233L358.7336879951343,306.7671609811643L361.04335240089614,299.8325782231667L363.353016806658,305.57436423114183L365.66268121241984,294.0060236703604L367.9723456181817,289.4551551058633L370.2820100239436,308.44829612885104L372.59167442970534,325.80506536857416L374.90133883546713,330.6798136065485L377.21100324122904,327.5802056148002L379.5206676469909,332.6212720723246L381.83033205275274,207.6065946787434L384.1399964585146,284.108602092771L386.44966086427644,325.4592139032503L388.75932527003823,316.9858431344646L391.06898967580014,332.191431773667L393.378654081562,316.76372567974687L395.6883184873238,262.98145415682063L397.99798289308563,262.72876812364757L400.3076472988474,319.2657557491691L402.61731170460934,324.8604364362326L404.92697611037113,320.5371032377032L407.23664051613304,324.3348317912298L409.54630492189483,322.29161118117236L411.8559693276567,322.34859000089403L414.16563373341853,321.89257942949104L416.4752981391804,325.9654057503255L418.78496254494223,321.66526399742827L421.0946269507041,322.2050433193038L423.40429135646593,325.1463301802433L425.7139557622277,322.11967507660495L428.02362016798963,326.14152030117594L430.3332845737514,319.83094566690846L432.64294897951333,235.32461306809228L434.9526133852751,75.91829753787508L437.2622777910369,166.21079974512585L439.57194219679883,324.22787152064717L441.8816066025606,319.73820014243006L444.19127100832253,326.10955220426155L446.5009354140843,322.6142912354799L448.8105998198462,176.58686333872367L451.120264225608,83.42800656378876L453.42992863136993,311.36719129027165L455.7395930371317,312.4791580477033L458.04925744289346,298.11045820980615L460.35892184865537,312.8952034334508L462.6685862544172,310.59487830093826L464.97825066017907,325.9474125054728L467.2879150659409,299.280983170092L469.5975794717028,324.93938712227896L471.90724387746457,316.1473747265925L474.2169082832265,316.7793198352163L476.5265726889883,322.8709958104003L478.8362370947501,322.93777103590054L481.14590150051197,325.76707943910765L483.45556590627376,321.23782286263213L485.76523031203567,308.2479705268284L488.07489471779746,320.70002272246745L490.38455912355937,317.4416736922379L492.6942235293212,278.8441986756996L495.003887935083,157.1250764558391L497.31355234084486,84.79489853924105L499.6232167466067,71.64552552793683L501.93288115236857,65.63359998491238L504.2425455581304,76.58820854134962L506.55220996389227,76.58103123333747L508.86187436965406,86.7671455173775L511.17153877541597,220.09323392010714L513.4812031811778,323.38780376950496L515.7908675869396,319.9820894897051L518.1005319927015,320.7833916743615L520.4101963984633,48.230647902170475L522.7198608042252,20L525.029525209987,234.41697034533672L527.3391896157488,318.8339362688006L529.6488540215107,326.0302016451587L531.9585184272726,306.1575675028279L534.2681828330344,322.95836334390395L536.5778472387963,325.42042830214876L538.887511644558,306.96326806767235L541.1971760503199,320.13823146503574L543.5068404560817,274.2893515642087L545.8165048618436,269.0293464528473L548.1261692676054,280.27104844694315L550.4358336733673,277.58808553880993L552.7454980791291,322.2740376950358L555.055162484891,316.5819931694009L557.3648268906528,279.9989695015021L559.6744912964147,249.68333656105924L561.9841557021764,309.12944297683856L564.2938201079384,276.3615414094514L566.6034845137001,298.3803579252909L568.9131489194621,311.3117918536824L571.2228133252238,304.58599161439633L573.5324777309856,292.6017456122655L575.8421421367475,276.9658967667332L578.1518065425093,282.3808443087335L580.4614709482713,303.58716279015715L582.771135354033,305.0545974050616L585.0807997597949,320.97050217568227L587.3904641655568,310.4371569424752L589.7001285713186,324.76027370969933L592.0097929770805,316.59958661567515L594.3194573828423,321.7128262498121L596.629121788604,282.7173392360888L598.938786194366,308.06443877392303L601.2484506001277,188.83277207355542L603.5581150058896,308.9111241299632L605.8677794116514,286.98589280499056L608.1774438174134,281.5791622111582L610.4871082231753,323.5951267403882L612.796772628937,291.2160806059849L615.106437034699,233.74921853720272L617.4161014404607,214.3130421494712L619.7257658462227,55.90869424962041L622.0354302519844,62.69273295716713L624.3450946577461,52.62697390908525L626.6547590635081,183.19672675685553L628.9644234692698,313.11612134347683L631.2740878750318,318.630012032703L633.5837522807935,107.19075490582142L635.8934166865554,200.7048397186645L638.2030810923173,216.57058317375066L640,273.51763834722107\"></path></g><g text-anchor=\"start\" transform=\"translate(0.5,0.5)\"><text dx=\"3\" dy=\"0.32em\" x=\"640\" y=\"273.51763834722107\">yjs</text></g><g stroke=\"currentColor\" transform=\"translate(0,0.5)\"><line x1=\"40\" x2=\"640\" y1=\"370\" y2=\"370\"></line></g></svg>"],[22240,13966,""],[22240,0,"yjs_pef"],[22246,1,""],[22246,0,"rf5.svg"],[22181,1,""],[22180,1,""],[22179,1,""],[22179,0,"s"],[22219,3,""],[22219,0,"or"],[22172,61,""],[22172,0,"takes constant time"],[22163,28,""],[22163,0,"has mostly flat performance. Its almost always fast:"],[22233,0,"\n"],[22233,0,"\n(Though I have no idea what"],[22234,1,""],[22260,0," those spikes are "],[22277,1,""],[22277,0,". Kevin thinks it might be from "],[22278,31,""],[22278,0," "],[22234,7,""],[22272,0," "],[22272,1,""],[22272,0,"Remen"],[22276,1,""],[22276,0,"mber, the "],[22234,52,""],[22234,0,"I have no idea what those spikes are. Remember, the"],[22167,0,"*"],[22174,0,"*"],[22216,0,", and it des"],[22227,1,""],[22226,1,""],[22226,0,"oesn't get slower over time"],[22194,29,""],[22194,0,"I"],[22215,0," "],[22215,1,""],[22225,0," in this test"],[22225,13,""],[22194,0,"Unlike the other algorithms, "],[22223,1,""],[22223,0,"i"],[22310,15,""],[22310,0,". But remember, the scale here is "],[22310,34,""],[22310,0," hou"],[22313,1,""],[22312,1,""],[22311,1,""],[22311,0,"though. They're pretty small in absolute terms, but its stilla "],[22373,1,""],[22372,1,""],[22372,0," a bit weird."],[22373,12,""],[22373,0,"pretty curious!"],[22380,7,""],[22380,0,"weird"],[22373,7,""],[22367,6,""],[22367,0,"still "],[22381,5,""],[22381,0,"C"],[21837,182,""],[21836,1,""],[21838,0,"Kevin says he wrote and rewrote parts of yjs 12 times in order to make this code run so fast. If there was a programmer version of the speedrunning community, they would adore Kevin. "],[22028,7,""],[22028,0," even"],[22029,4,""],[22028,1,""],[22118,5,""],[22118,0,"I"],[22243,0,", as the document grows"],[22391,0," Maybe that"],[22401,1,""],[22400,1,""],[22400,0,"ey happen when the user moves their cursor a long way"],[22443,10,""],[22443,0,"around the document? Or when the user deletes chunks of "],[22495,4,""],[22495,0,"? I have on idea"],[22504,7,""],[22504,0,"no idea."],[22514,0,"The real question is: "],[22543,6,""],[22545,0," even"],[22546,0,"*"],[22558,0,"*"],[22559,7,""],[22619,3,""],[22619,0,"mu"],[22619,2,""],[22619,0,"any"],[22641,3,""],[22641,0,"managed here"],[23514,0,"; 5"],[23458,0,"item = "],[23458,0,"var "],[23471,4,""],[23471,0,"content"],[23528,1,""],[23528,0,":"],[23611,48,""],[23611,0,"mem-frag.drawio.svg"],[23572,0,"is "],[23583,16,""],[23583,0," a mess like this"],[24393,54,""],[24906,40,""],[24906,0,"des"],[24906,3,""],[24906,0,"would tell us everything we need to know"],[25752,0," much"],[25758,0," The v8"],[25764,1,""],[25763,1,""],[25763,0,"V8 optimizer does "],[25617,0,","],[25777,5,""],[25777,0,"helps a lot here - small string inlining "],[25782,6,""],[25777,35,""],[25777,0,"does a"],[25777,6,""],[25777,0,"has a lot of tricks"],[25782,0,"n awful l"],[25790,1,""],[25789,1,""],[25803,0," "],[25803,1,""],[25803,0,". But its not magic."],[25803,0," "],[25803,1,""],[25804,0," (Small stringi "],[25819,1,""],[25818,1,""],[25818,0," inling wou"],[25819,10,""],[25819,0,"inlining would help here)."],[25850,3,""],[25850,0,"V8 isn't"],[25858,4,""],[25853,5,""],[25853,0,"will "],[25857,1,""],[25853,4,""],[25853,0,"isn't"],[25496,0,"small, "],[25496,7,""],[25805,41,""],[25804,1,""],[25803,1,""],[25803,0,", "],[25805,1,""],[25805,0,"b"],[25824,0," It doesn't actually un"],[25825,22,""],[25824,1,""],[25823,1,""],[25823,0," and its tricks only get us so far."],[26350,19,""],[26350,0,"btree.drawio.svg"],[26566,19,""],[26566,0,"Martin's editing trace"],[26618,3,""],[26618,0," which"],[26624,5,""],[26743,0,"update "],[28889,0,"\n"],[28889,0,"\nTh"],[28891,1,""],[28891,0,"ecnhi"],[28895,1,""],[28894,1,""],[28893,1,""],[28893,0,"hnically this is O(log n)"],[28912,0,"n * "],[28922,0,". Teach "],[28924,6,""],[28924,0,"Each insert should "],[28936,0,"*"],[28943,0,"*"],[28936,9,""],[28936,0,"takes "],[28924,18,""],[28924,0,"Inserts slowly "],[28932,7,""],[28932,0,"get gradually slower as our document grows. But in reality, its fast"],[28980,20,""],[28980,0,"ec"],[28981,1,""],[28980,1,""],[28980,0,"because the whole thing fits in CPU cache, it "],[29025,1,""],[29024,1,""],[29023,1,""],[29023,0,"you c"],[29027,1,""],[29027,0,"honestly can't tell in th eb"],[29054,1,""],[29053,1,""],[29052,1,""],[29052,0,"e bne"],[29056,1,""],[29055,1,""],[29055,0,"enhcm"],[29059,1,""],[29058,1,""],[29057,1,""],[29057,0,"chmark data."],[29027,9,""],[29037,22,""],[29027,10,""],[29027,0,"wouldn't know"],[29041,0,"\n\n> rust_perf6.svg"],[28907,25,""],[28890,126,""],[28890,0,"Performance is also smooth as butter. Because "],[28928,8,""],[28928,0,"From rust"],[28928,9,""],[28928,0,"Rust doesn't need a grab"],[28951,1,""],[28950,1,""],[28949,1,""],[28949,0,"arbage collector to track allocations, so "],[28974,0," memory"],[28905,5,""],[28890,103,""],[28890,0,"Performance is smooth as butter. Rust doesn't need a garbage collector to track memory allocations, so"],[28888,0,"\n\nI have no idea how to track "],[28890,28,""],[28889,1,""],[28888,1,""],[28990,2,""],[28990,0,"so there's no big GC spikes. Usin"],[29019,4,""],[29019,0,"Because da"],[29028,1,""],[29027,1,""],[29027,0,"each b-tree node is"],[29019,27,""],[29019,0,"The entire "],[29019,11,""],[29019,0,"I'm not sure what those spikes are. They aren't "],[29055,12,""],[29054,1,""],[29053,1,""],[29049,0," in the time char"],[29057,9,""],[29057,0,"e"],[29057,1,""],[29057,0,"performance"],[29018,54,""],[29037,0,"\n I'm not sure what those spikes in the performance are"],[29039,1,""],[29038,1,""],[29038,0,"I"],[29069,2,""],[29069,0,"are in"],[29075,20,""],[29075,0," "],[29075,1,""],[29074,1,""],[29073,1,""],[29038,35,""],[29038,0,"I'm not sure what those spikes are"],[29037,0,"\n"],[29037,0,"\nNote I'm only g"],[29052,1,""],[29052,0,"showing the WASM version of this code, called from javascript. T"],[29115,1,""],[29115,0,"Performance is 3x better"],[29115,24,""],[29115,0,"I simply haven't written the code"],[29144,4,""],[29144,0,"ntaiv"],[29148,1,""],[29147,1,""],[29146,1,""],[29145,1,""],[29145,0,"ative code"],[29144,7,""],[29132,16,""],[29132,0,"implemented"],[29132,11,""],[29132,0,"instrumented my rust code"],[29148,0,"native "],[29164,0,"."],[29201,0,"\n"],[29166,1,""],[29200,0,"\nNote I'm only showing the WASM version of this code, called from javascript. I simply haven't instrumented my native rust code."],[29038,128,""],[29072,0,"\n"],[29037,1,""],[29071,1,""],[29037,0,"\n"],[29072,128,""],[29038,0,"Note I'm only showing the WASM version of this code, called from javascript. I simply haven't instrumented my native rust code.\n"],[29200,1,""],[29166,0,"\n"],[29089,0," here"],[29038,5,""],[29064,25,""],[29064,0,"performance here"],[29107,7,""],[29185,0,"."],[29175,0,"sml"],[29177,1,""],[29177,0,"all "],[29192,0," They're stable between runs.\n"],[29197,24,""],[29197,0," v"],[29198,1,""],[29198,0,"overlap perfecte"],[29213,1,""],[29213,0,"ly between subsequent runs."],[29107,0," simply"],[29107,7,""],[29107,0," simply"],[29158,23,""],[29158,0,"I wonder what those"],[29194,1,""],[29194,0,"?"],[29158,36,""],[29158,0,"What are those small spikes"],[29209,19,""],[29200,9,""],[29200,0,"perfectly"],[29200,9,""],[29192,8,""],[29192,0,"line up perfectly between "],[29217,1,""],[29218,0,"benchmark "],[29158,27,""],[29158,0,"I wonder what those spikes are"],[29018,0," Actually this entire data set only needs 414"],[29062,1,""],[29061,1,""],[29061,0,"100 allocations"],[29049,0,"(all 260000"],[29057,0," "],[29061,0,") operations "],[29090,0,"em"],[29091,1,""],[29090,1,""],[29090,0,"memory "],[29108,0," in total durin"],[29118,5,""],[29117,1,""],[29117,0,"."],[29063,11,""],[29028,0,"pro"],[29028,3,""],[29019,9,""],[29019,0,"Processing "],[29070,5,""],[29070,0,"calls malloc"],[29087,29,""],[29087,0," times."],[29069,0," ends "],[29070,5,""],[29069,1,""],[29447,6,""],[29447,0,"I"],[32256,0,"\n\nWe can put all the"],[32269,7,""],[32269,0,"a lot of this stuff on one graph, but i"],[32258,50,""],[32258,0,"If I "],[32262,1,""],[32260,2,""],[32258,2,""],[32258,0,"We can put a lot of this stuff on one graph, but i"],[32258,2,""],[32258,0,"I"],[32258,1,""],[32258,0,"We"],[32301,7,""],[32301,0," if it a"],[32308,1,""],[32308,0,"has a log scale, though its pretty min"],[32345,1,""],[32344,1,""],[32323,21,""],[32323,0,"."],[32305,2,""],[32305,0,"I give it"],[32314,4,""],[32327,0," Its re"],[32333,1,""],[32332,1,""],[32332,0,"pretty meaningless, but ou "],[32358,1,""],[32357,1,""],[32356,1,""],[32258,98,""],[32258,0,"We can put a lot of this stuff on one graph if I give it a log scale. Its pretty meaningless, but"],[32356,0,"\n> all_perf.svg"],[32355,0," you can see some features"],[32350,31,""],[32338,0,". And pretty"],[32362,0,"!"],[32338,1,""],[32338,0,", but"],[32343,4,""],[32340,23,""],[32340,0,"nobo"],[32340,4,""],[32340,0,"bugl"],[32343,1,""],[32342,1,""],[32342,0,"t log scales are seriously meaning"],[32359,17,""],[32359,0,"meaningless to humans."],[31680,11,""],[31680,0,". Thats "],[31772,0,"CRDT "],[31782,0," and"],[32338,0,"really "],[32338,7,""],[32344,0," "],[32338,7,""],[32338,0,"remarkable how neatly they stack up like this"],[32359,5,""],[32359,0," it"],[32313,7,""],[32313,0,"use"],[32364,0,"s"],[32368,10,""],[32354,1,""],[32353,1,""],[32353,0," it looks"],[32362,13,""],[32405,0," If"],[32407,1,""],[32406,1,""],[32405,1,""],[32422,0,"\n\n"],[32423,0,"If I use a normal linear scale, yjs and my "],[32463,3,""],[32463,0,"the rust implementation are just "],[32423,73,""],[32422,1,""],[32421,1,""],[32263,158,""],[32262,1,""],[31884,0,"\n"],[31884,0,"\n"],[31884,1,""],[31883,1,""],[32263,0,"\n"],[32263,0,"\n\nWe can put a lot of this stuff on one graph if I use a log scale. Its remarkable how neat it looks, but log scales are meaningless to humans.\n\n> all_perf.svg"],[32263,1,""],[32302,5,""],[32302,0,"chart"],[32274,23,""],[32274,0," everything on"],[31937,5,""],[36730,7,""],[36730,0,"/Sh"],[36732,1,""],[36731,1,""],[36730,1,""],[36730,0,"ShareDB"],[36753,0,"it "],[36765,12,""],[36760,5,""],[36768,0," by leaps"],[36759,18,""],[36759,0," been maintained by a di"],[36782,1,""],[36782,0,"edicated team"],[36795,12,""],[36795,0,"."],[36764,0," ac"],[36756,11,""],[36755,1,""],[36755,0,"s still well used and well"],[36792,21,""],[36792,0," by the people"],[36753,3,""],[36752,1,""],[36752,0," well used, "],[36763,1,""],[36762,1,""],[36762,0," and battle tested"],[36780,50,""],[36780,0,"."],[36753,0,"its "],[36766,0,", well maintained "],[36783,1,""],[38593,0,"out"],[38609,1,""],[38609,0,"ve been"],[39385,0," Yjs's semantics also take slightly morememory"],[39421,10,""],[39421,0,"more memory in practice."],[39385,60,""],[41168,0,"binary "],[41292,0,"mirror the benchmarks I showed above"],[41328,61,""],[41328,0,","],[41328,1,""],[41333,0," I'd like to know"],[41329,21,""],[41352,0,", and it would be fun to find out"],[41401,0,"semantic "],[41420,19,""],[41420,0," worth mentioning."],[41438,2,""],[41439,1,""],[41439,0,"Y"],[41517,1,""],[41598,1,""],[41598,0,", wheras"],[41604,0,"e"],[41654,1,""],[41727,4,""],[41736,0," stores"],[41743,18,""],[43888,0," Although"],[43889,8,""],[43888,1,""],[43888,0,"\n\n"],[43889,1,""],[43888,1,""],[43888,0," I have "],[43889,7,""],[43888,1,""],[43888,0," "],[43888,1,""],[43888,0,"\n\n"],[43889,1,""],[43888,1,""],[43888,0," We'll "],[43888,7,""],[127,0,"\n\n> automerge1.drawio.svg"],[130,1,""],[129,1,""],[129,0,"<img src="],[159,0,">"],[129,31,""],[128,1,""],[127,1,""],[6135,0,"<img src=automerge1.drawio.svg>"],[6166,23,""],[6438,0,"\n<img src=automerge1.drawio.svg>"],[6457,1,""],[6457,0,"2"],[6471,24,""],[10541,0,"\n<img src=automerge1.drawio.svg>"],[10551,17,""],[10551,0,"am_perf1"],[10565,15,""],[18918,0,"\n<img src=automerge1.drawio.svg>"],[18928,17,""],[18928,0,"ref_perf3"],[18943,16,""],[22132,0,"\n<img src=automerge1.drawio.svg>"],[22142,17,""],[22142,0,"yjs_perf4"],[22157,15,""],[22156,1,""],[22309,15,""],[22309,0,"<img src=yjs_perf4.svg>"],[22326,1,""],[22326,0,"5"],[23660,0,"\n<img src=yjs_perf4.svg>"],[23670,17,""],[23689,0,">"],[26403,0,"\n<img src=yjs_perf4.svg>"],[26413,17,""],[26429,0,">"],[29159,0,"\n<img src=yjs_perf4.svg>"],[29169,17,""],[29183,0,">"],[32464,0,"\n<img src=yjs_perf4.svg>"],[32474,17,""],[32486,0,">"],[5329,0,"\n\n"],[5330,1,""],[5329,1,""],[5329,0,"\n\n"],[5331,1,""],[5331,0,"\n"],[5330,1,""],[5329,1,""],[7282,0,"*"],[7222,0,"*"],[7164,0,"*"],[7111,0,"*"],[6401,0,"*"],[6351,0,"*"],[6303,0,"*"],[6260,0,"*"],[6068,0,"*"],[6018,0,"*"],[5975,0,"*"],[7293,0,"*"],[7232,0,"*"],[7173,0,"*"],[7119,0,"*"],[6408,0,"*"],[6357,0,"*"],[6308,0,"*"],[6264,0,"*"],[6071,0,"*"],[6020,0,"*"],[5976,0,"*"],[7303,1,""],[7241,1,""],[7181,1,""],[7126,1,""],[6414,1,""],[6362,1,""],[6312,1,""],[6267,1,""],[6073,1,""],[6021,1,""],[5976,1,""],[7296,0,"*"],[7235,0,"*"],[7176,0,"*"],[7122,0,"*"],[6411,0,"*"],[6360,0,"*"],[6311,0,"*"],[6267,0,"*"],[6074,0,"*"],[6023,0,"*"],[5979,0,"*"],[10665,0,"\n<img src=am_perf1.svg>"],[10683,0,"_smooth"],[10665,0,"\nThe chart is a bit easier to read when we smooth everything "],[10708,18,""],[10708,0,"average everythign out "],[10716,15,""],[10716,0,"everything out a bit - but "],[10736,7,""],[10736,0,". Clearly performance is slowly "],[10761,7,""],[10761,0,"gradually getting wo"],[10761,20,""],[10761,0,"getting gradu"],[10773,1,""],[10773,0,"ually worse over time.\n"],[10738,9,""],[10738,0,"P"],[10749,11,""],[10749,0," gets"],[10132,0,"\n\n\n| Test                              | Time taken | RAM usage |\n|:--------------------------        | ----------:| ---------:|\n| automerge (v1.0.0-preview2)       |  291s      | 880 MB    |\n| **reference-crdts (automerge / yjs)** |   31s      |  28 MB    |\n| JS baseline                       | 0.61s      | 0.1 MB    |"],[10263,0,"**"],[10292,0,"**"],[10328,66,""],[10327,1,""],[10391,229,""],[10390,1,""],[10590,0,"\n\n"],[10591,1,""],[10590,1,""],[10133,1,""],[9809,0,"\n\nThe "],[9811,4,""],[9811,0,"Processing "],[9811,11,""],[9810,1,""],[9809,1,""],[9711,0," Thats about "],[9718,6,""],[9718,0,"just shy of 900 edits per seoc"],[9747,1,""],[9746,1,""],[9746,0,"cond, which is honestly fine"],[9761,13,""],[9761,0,"probably fine. But"],[9779,4,""],[9812,4,""],[9812,0,"is using"],[10774,1,""],[10773,1,""],[10773,4,""],[10825,0," and zoom in"],[10913,0,"\n\n(Note the y "],[10915,12,""],[10914,1,""],[10913,1,""],[10835,2,""],[10835,0,"the Y axis"],[10873,0," (roughly linearly)"],[12823,0,"["],[12827,0,"](https://github.com/yjs/yjs)"],[12904,10,""],[12885,0,"opensource "],[12937,5,""],[12937,0,"I"],[12940,7,""],[15466,0,"\n3. Its much faster, because"],[15470,24,""],[15470,0,"Th"],[15470,2,""],[15470,0,"We can use a much simpler data structure, which makes the algorithm much faster."],[15483,67,""],[15483,0,"flat array to store all the"],[15503,7,""],[15503,0,"everything, rather than a "],[15528,1,""],[15528,0," weird tree."],[15529,5,""],[15529,0,"sp"],[15530,1,""],[15529,1,""],[15528,1,""],[15534,0," This makes "],[15528,0,"n unbalanced"],[15558,0,"everything smaller and faster for the compilt"],[15602,1,""],[15601,1,""],[15600,1,""],[15600,0,"uter to process."],[15844,236,""],[15617,0,"4. Even though the implementation is different, this approach is *semantically* identical to the actual automerge, and yjs and sync9 code. ([Fuzzer verified (TM)](https://github.com/josephg/reference-crdts/blob/main/reference_test.ts))\n"],[16080,171,""],[15853,0,"5. Its faster *and* simpler, which moves the [Pareto efficiency frontier](https://en.wikipedia.org/wiki/Pareto_efficiency). Ideas which do this are rare and truly golden.\n"],[16251,1,""],[16024,0,"\n"],[16252,0,"\n"],[16024,1,""],[16023,0,"\n\n"],[15616,0,"\n2. Doing it this way lets you implement the semantics of multiple CRDTs in the same codebase, if you want to."],[15357,110,""],[15506,0,"\n1. You can implement lots of CRDTs like this. Yjs, Automerge, Sync9 and others all work"],[15269,89,""],[15269,0,"1"],[15418,0,"\n2. The code s"],[15431,1,""],[15431,0,"is i"],[15434,1,""],[15434,0,"simple"],[15434,0,"really "],[15434,7,""],[15434,0,"m"],[15434,1,""],[15434,0,"really "],[15447,0,"."],[15886,10,""],[15886,0,"Being faster"],[15886,169,""],[15883,3,""],[15882,1,""],[15448,0," Being faster *and* simpler, which moves the [Pareto efficiency frontier](https://en.wikipedia.org/wiki/Pareto_efficiency). Ideas which do this are rare and truly golden."],[15476,6,""],[15475,1,""],[15612,1,""],[15612,0,"3"],[15700,110,""],[15699,0,". You can implement ment"],[15722,1,""],[15721,1,""],[15720,1,""],[15720,0,"m"],[15720,1,""],[15720,0,"any lo"],[15725,1,""],[15725,0,"ist CRDT "],[15733,1,""],[15733,0,"s in the same codebase."],[15757,236,""],[15221,0," And even though the code is very different, the Even though the implementation is different, this approach is *semantically* identical to the actual automerge, and yjs and sync9 code. ([Fuzzer verified (TM)](https://github.com/josephg/reference-crdts/blob/main/reference_test.ts))\n"],[15269,44,""],[15266,4,""],[15265,1,""],[15355,0,"bases"],[15459,1,""],[15994,1,""],[15995,3,""],[15995,0,"It does"],[16002,13,""],[15995,7,""],[15995,0,"Ther"],[15998,1,""],[15997,1,""],[15997,0,"ore"],[15999,1,""],[15998,1,""],[15997,1,""],[15997,0,"eoretically this algorithm"],[16122,5,""],[16122,0,"really"],[16024,5,""],[16028,0,"s"],[16203,13,""],[16203,0,"I"],[16218,0," in practice"],[16024,0,"can "],[16032,1,""],[14763,0," in a "],[14767,2,""],[14767,0,"my *reference-crdts*"],[14770,22,""],[14769,1,""],[14771,16,""],[14771,0,"reference-crdts"],[14850,0," codebase."],[14860,40,""],[14769,0," proot "],[14775,1,""],[14774,1,""],[14774,0,"f of concept"],[14770,16,""],[14770,0,"experimental"],[14864,8,""],[14864,0,"library"],[14864,7,""],[14864,0,"codebase"],[14784,0,"*"],[14800,0,"*"],[16363,14,""],[16363,0,"I"],[16363,1,""],[16363,0,"YU"],[16364,1,""],[16363,1,""],[16363,0,"U"],[16383,0," my implementation of automerge's algorithm is"],[16429,8,""],[16451,0," the real"],[16470,1,""],[16470,0,". And its"],[16479,4,""],[16989,9,""],[16989,0,"automerge up"],[17002,0,"\n\nIts a lot faster than "],[17004,22,""],[17003,1,""],[17003,0,"\nIts a lot faster than automerge:\n\nref_vs_am_perf.svg"],[17038,0,"<img src="],[17065,0,">"],[17037,0,"\n![]"],[17041,10,""],[17041,0,"("],[17060,1,""],[17060,0,")"],[17040,0,"Automerge is much slower than reference-crdts"],[33045,9,""],[33045,0,"!"],[29740,9,""],[29740,0,"!"],[26984,9,""],[26984,0,"!"],[24241,9,""],[24241,0,"!"],[22889,9,""],[22889,0,"!"],[22713,9,""],[22713,0,"!"],[19499,9,""],[19499,0,"!"],[10911,9,""],[10911,0,"!"],[10659,9,""],[10659,0,"!"],[6453,9,""],[6453,0,"!"],[6141,9,""],[6141,0,"!"],[32966,0,"["],[29669,0,"["],[26921,0,"["],[24186,0,"["],[22842,0,"["],[22674,0,"["],[19468,0,"["],[10888,0,"["],[10644,0,"["],[6446,0,"["],[6142,0,"["],[32977,0,"]"],[29679,0,"]"],[26930,0,"]"],[24194,0,"]"],[22849,0,"]"],[22680,0,"]"],[19473,0,"]"],[10892,0,"]"],[10647,0,"]"],[6448,0,"]"],[6143,0,"]"],[32988,0,"("],[29689,0,"("],[26939,0,"("],[24202,0,"("],[22856,0,"("],[22686,0,"("],[19478,0,"("],[10896,0,"("],[10650,0,"("],[6450,0,"("],[6144,0,"("],[33011,1,""],[29713,1,""],[26964,1,""],[24229,1,""],[22876,1,""],[22705,1,""],[19496,1,""],[10919,1,""],[10665,1,""],[6473,1,""],[6166,1,""],[33001,0,")"],[29704,0,")"],[26956,0,")"],[24222,0,")"],[22870,0,")"],[22700,0,")"],[19492,0,")"],[10916,0,")"],[10663,0,")"],[6472,0,")"],[6166,0,")"],[10651,0,"automm"],[10656,1,""],[10655,1,""],[10655,0,"moe"],[10657,1,""],[10656,1,""],[10656,0,"erge performance chart"],[10925,0,"automerge performance chart smoothed u"],[10962,1,""],[10962,0,"out"],[6143,0,"treee"],[6147,1,""],[6147,0," with \"abc\" inserts"],[6473,0,"tree with \"aXbc\""],[19587,0,"reference crdts implmentation zoomed in"],[19531,9,""],[19530,1,""],[19539,7,""],[19566,0," Perofr"],[19572,1,""],[19571,1,""],[19570,1,""],[19570,0,"formance gets better near tha "],[19599,1,""],[19598,1,""],[19598,0,"e end when Martin star"],[19616,4,""],[19616,0,"went back to the start of his paper and started editing it."],[19664,8,""],[19664,0,"making edits"],[19676,3,""],[19676,0,"."],[19663,7,""],[19668,1,""],[19668,0,"ing"],[19780,25,""],[19780,0,"Kevin "],[19785,1,""],[19806,0," in Yjs"],[19780,0,"And by \"we\", I mean "],[19856,0,"eK"],[19857,1,""],[19856,1,""],[19856,0,"Kevin solved this problem by thinking about how p"],[19904,1,""],[19904,0,"humans actually edit documents. "],[19949,7,""],[19949,0,"we"],[19951,3,""],[19958,0,"'"],[19951,0,"'"],[19952,7,""],[19952,0,"re typing"],[19961,1,""],[19963,4,""],[19963,0,"we"],[19944,4,""],[19944,0,"while"],[19994,3,""],[19994,0,"a "],[19995,1,""],[19924,0," text"],[20161,5,""],[20160,1,""],[20160,0," later"],[20168,0,"the new "],[20134,0,"The next edit will probably be pretty close to the previous edit"],[20198,98,""],[20198,0,", so Kevin just scans from "],[20220,5,""],[20220,0,"forwards or backwards from the last position"],[20266,80,""],[20265,1,""],[20265,0,"\n\n"],[20266,1,""],[20265,1,""],[20265,0," "],[20296,0," to me"],[20297,5,""],[20296,1,""],[20296,0," to me, b"],[20304,1,""],[20303,1,""],[20302,1,""],[20302,0," - wouldn't Yjs ha"],[20305,15,""],[20304,1,""],[20303,1,""],[20302,1,""],[20303,7,""],[20303,0,"- I mean, thats a big assumption!"],[20336,67,""],[20340,0," apparen"],[20341,7,""],[20340,1,""],[20335,0," to make"],[20376,0,"\n\n(And I'm simplif"],[20378,16,""],[20378,0,"(And I'm simplifying a bit here - Yjs actualy"],[20422,1,""],[20422,0,"ly stores i"],[20432,1,""],[20432,0,"a whole set of cach"],[20378,73,""],[20378,0,"And w"],[20378,5,""],[20378,0,"What i"],[20378,6,""],[20377,1,""],[20376,1,""],[20376,0,"\n\n(And what if two users are editing different parts of a document? Yjs cac"],[20448,3,""],[20448,0,"stores a whole set of cache locations, so there's usually a cached marker location nearby.)"],[20498,0,"almost always "],[20512,7,""],[20511,1,""],[20526,1,""],[20526,0,"cur"],[20521,8,""],[20521,0,"cursor"],[20379,5,""],[20379,0,"W"],[20444,0,"actually "],[20439,0," "],[20439,1,""],[20439,0," I"],[20440,1,""],[20439,1,""],[20439,0," I'm simplifying here -"],[20513,5,""],[20513,0," "],[20513,1,""],[20513,0,". "],[20515,1,""],[20515,0,"T"],[20568,0," no matter where users make changes in the document"],[20706,2,""],[20706,0,"Yjs does that"],[20719,12,""],[21868,6,""],[21868,0,"The algorithm can"],[21953,0," - but that happens any time"],[21960,21,""],[21960,0,"c"],[21960,1,""],[21960,0,"that happens whenever a user types a series of characters without moving their cursor"],[21997,6,""],[21997,0,"run"],[22048,5,""],[22140,5,""],[22140,0,"runs"],[22328,0,"This blows me away but - "],[22352,1,""],[22351,1,""],[22347,4,""],[22347,0,"- "],[22372,4,""],[22372,0,"my "],[22411,0,"thanks to the spans approach "],[23494,0,". Ch"],[23497,1,""],[23496,1,""],[23495,1,""],[23494,1,""],[23517,0,"But "],[23558,6,""],[23558,0,"near the end"],[23604,0,"*"],[23596,0,"*"],[24053,3,""],[24053,0,"Yjs"],[24713,1,""],[24713,0,"\n  "],[24797,1,""],[24797,0,"\n  "],[24798,2,""],[24733,1,""],[24733,0,"\n  "],[24753,1,""],[24753,0,"\n  "],[24773,1,""],[24773,0,"\n  "],[24783,1,""],[24783,0,"\n  "],[24651,9,""],[24651,0,"one of our document items"],[24676,10,""],[27020,0," in the decade since it was released"],[24874,0,"javascript objects fragmented in memory"],[23328,0,"yjs performance a"],[23344,1,""],[23344,0,"vs other oa"],[23354,1,""],[23353,1,""],[23353,0,"alogi"],[23357,1,""],[23356,1,""],[23355,1,""],[23355,0,"gorithms"],[23534,0,"yjs performance isolated"],[27746,0,"b-tree diagram"],[27659,0," This isn't a btreemap"],[27673,8,""],[27672,1,""],[27672,0," "],[27672,1,""],[27671,1,""],[27671,0,"you"],[27673,1,""],[27672,1,""],[27671,1,""],[27671,0,"a "],[27672,1,""],[27672,0,"n ordinera"],[27681,1,""],[27680,1,""],[27679,1,""],[27678,1,""],[27677,1,""],[27677,0,"inary b-tree. Instead of storing offsets,"],[27719,1,""],[27719,0,"e"],[27801,0," This i"],[27807,1,""],[27807,0,"lets u"],[27812,1,""],[27812,0,"the "],[27812,4,""],[27812,0,"us resize children"],[27822,0,"a node's "],[27839,0," with *log n*"],[27849,1,""],[27849,0,"("],[27851,0,")"],[27822,1,""],[27822,0,"the"],[27822,3,""],[27822,0,"any ti"],[27827,1,""],[27826,1,""],[27826,0,"item"],[27830,7,""],[27853,0," mo"],[27855,1,""],[27854,1,""],[27853,1,""],[27845,0,"just "],[27858,0," edits. (We just walk up the "],[27865,22,""],[28222,0," In practice, most of these reads will already be in your CPU's cache."],[28780,0," That codepath doesn't get benchmarked here though - you'll have to tam"],[28850,1,""],[28850,0,"ke my word for it."],[28832,1,""],[28831,1,""],[28830,1,""],[28830,0,". Its fast but for now "],[28904,3,""],[28904,0,"Yjs"],[28935,0," edit"],[28984,1,""],[28983,1,""],[28983,0,"."],[29418,0,"Why 32? "],[29426,14,""],[29426,0,"I ran my"],[29446,1,""],[29445,1,""],[29444,1,""],[29444,18,""],[29444,0," "],[29471,1,""],[29471,0," and"],[29615,0," like in the other tests"],[29670,0,"editing "],[29686,0," just"],[29709,0," This is faster than editing a string in javascript."],[29761,1,""],[29761,0,"\n\n"],[29846,0,"all 260k edits in "],[29885,0," just"],[30564,140,""],[30528,36,""],[30528,0,"Even through webassembly, this code"],[30527,36,""],[29715,46,""],[29715,0,"is 3x faster than editing a native javascript string directly, and its doing a whole lot of extra work to support collaborative editing too!"],[29776,1,""],[29776,0,"!"],[29778,1,""],[29778,0,"A"],[30621,1,""],[30735,0," mysterious"],[30746,4,""],[30758,0,"And because memory is packed in, "],[30780,0,"so "],[30789,3,""],[30791,1,""],[30791,0,"p"],[31039,1,""],[31010,0," have no idea"],[31023,7,""],[31045,0,"."],[31093,0," Maybe the allocator?"],[30782,0," tightly"],[30757,0," We don't care where inserts happen - this system si fas"],[30807,6,""],[30807,0,"is uniformly fast no matter"],[30825,9,""],[30825,0,"across the whole document."],[30758,94,""],[30655,0,"We don't care where inserts happen - this system is uniformly fast across the whole document. "],[30655,0,"The b-tree gives us *log "],[30679,1,""],[30679,0,"(n) p"],[30683,1,""],[30682,1,""],[30682,0," "],[30682,1,""],[30682,0,"* performance for every edit, no matter"],[30655,68,""],[30655,0,"A b-tree doesn't"],[30671,6,""],[30683,7,""],[30683,0,"edits"],[30697,1,""],[30696,1,""],[30695,1,""],[30695,0,". "],[30697,1,""],[30697,0,"T"],[30977,0,"rust per"],[30982,3,""],[30982,0,"implementation in was "],[31003,1,""],[31003,0,"m vs yjs"],[31148,0," But I expect the r"],[31149,18,""],[31149,0,"I expect the rust implementation to look the same "],[31162,37,""],[31162,0,"only change will be the "],[31148,38,""],[31148,0," I don't "],[31149,8,""],[31149,0,"The rust version of this code"],[31149,0,"I don't know why "],[31166,1,""],[31166,0,"t"],[31195,0," is 3x faster. Is it the javascript / WASM i"],[31238,1,""],[31238,0,"bounary"],[31238,7,""],[31238,0,"boundary? Or are the re"],[31260,1,""],[31259,1,""],[31258,1,""],[31258,0,"re optimizations"],[31251,9,""],[31251,0,"does"],[31248,7,""],[31248,0,"Does LLVM make"],[31258,4,""],[31258,0,"have more tricks when"],[31280,13,""],[31280,0,"optimizing native x65"],[31300,1,""],[31299,1,""],[31298,1,""],[31298,0,"x75"],[31300,1,""],[31299,1,""],[31299,0,"65"],[31300,1,""],[31299,1,""],[31299,0,"86 code? Or"],[31147,0,", though I assume its just the same but 3x "],[31147,43,""],[31213,0,"the performance costc "],[31234,1,""],[31233,1,""],[31233,0," coming from "],[31246,3,""],[31261,1,""],[31261,0,"-"],[31261,1,""],[31260,1,""],[31260,0,"-to-"],[31264,1,""],[31341,0," is the s"],[31349,1,""],[31349,0,"wasm virtual machine"],[31345,24,""],[31345,0,"it all the bounds checks wasm needs"],[31370,10,""],[31370,0,"the WASM VM needs? A"],[31389,1,""],[31389,0,"In an"],[31389,5,""],[31389,0,"No matter - its lightning"],[31413,1,""],[31412,1,""],[31412,0,"ng fast."],[31405,0,"truly "],[31405,6,""],[31419,0," anyway"],[31429,0,"And "],[31429,4,""],[31431,34,""],[31431,0,"wonder what those spikes are"],[32290,0,"\n\n"],[32291,1,""],[32290,1,""],[32290,0,"\n\nI figure this is better for mo"],[32321,1,""],[32320,1,""],[32320,0,"lots of use cases, "],[32338,1,""],[32337,1,""],[32337,0," anyway - for e"],[32337,15,""],[32337,0,". For example, if the "],[32355,4,""],[32355,0,"you're editing text in VS Code, the VS Vode "],[32394,5,""],[32394,0,"Code editing i"],[32407,1,""],[32407,0,"environment will need "],[32424,5,""],[32424,0,"have a copy of the document anyway, so there's no i"],[32474,1,""],[32474,0,"need to duplicate everything in the b-tree."],[32506,3,""],[32506,0,"my"],[31812,9,""],[31812,0,"BTree"],[31812,0,"Spanning"],[31819,1,""],[31818,1,""],[31817,1,""],[31816,1,""],[31812,4,""],[32286,226,""],[32478,0,"\n- Lots of use cases will store the co"],[32515,1,""],[32514,1,""],[32514,0,"document content somewhere "],[32541,177,""],[32479,0,"- But when inserting we need to update 2 data structures instead of 1. This makes everything more than twice as slow, and it makes the wasm bundle twice as big (60kb -> 120kb).\n"],[32718,0,"\n- But when inserting we need to update 2 data structures instead of 1. This makes everything more than twice as slow, and it makes the wasm bundle twice as big (60kb -> 120kb)."],[32479,177,""],[32541,0,"else anyway. Eg, if you're using VS c"],[32577,1,""],[32577,0,"Code"],[32564,3,""],[32564,0," hook this up to"],[32580,6,""],[32588,0,", the text content doesn't need to be stored in the CRDT at all."],[32607,0,"probably "],[32642,2,""],[32642,0,"by"],[32664,5,""],[32664,0,"W"],[32834,0,"\n- Lots of use cases will store the document content somewhere else anyway. Eg, if you hook this up to VS Code, the text content probably doesn't need to be stored by the CRDT at all."],[32479,183,""],[32834,0," In that case, its"],[32835,17,""],[32835,0,"Implemented like this, it'd be really east to "],[32880,1,""],[32879,1,""],[32878,1,""],[32877,1,""],[32876,1,""],[32876,0,"y to just turn that code off."],[32891,13,""],[32891,0,"the "],[32886,9,""],[32886,0,"stop storing the content at all"],[32762,0," vs code has"],[32771,3,""],[32771,0,"will have a cop o"],[32787,1,""],[32786,1,""],[32786,0,"y of the document at all times anyway. So"],[32827,34,""],[32827,0," there's no need to "],[32847,12,""],[32852,1,""],[32851,1,""],[32851,0,"e the document in the "],[32873,8,""],[32869,4,""],[32869,0,"my "],[32876,0," structures as well"],[32895,7,""],[32896,84,""],[32896,0," Implemented like this, it'd be really easy to just stop storing the content at all."],[33035,0,"But whatever. "],[33049,1,""],[33049,0,"M"],[33035,14,""],[33147,0," contents"],[34827,2,""],[34827,0,"in a pre"],[34832,3,""],[34832,0,"single, pretty"],[34846,4,""],[34954,0,"all data in one chart"],[34990,0,"\n\nI"],[34992,1,""],[34991,1,""],[34990,1,""],[34990,0,"\n\nRemember "],[35000,1,""],[35000,0,", log scales trick your brain. The data actually looks like this:\n\ntype: 'log', domain: [0.0005, 4], tickFormat: ',',"],[35067,50,""],[35067,0,"![all data in one chart](all_perf.svg)"],[35100,0,"_linear"],[35090,0,", with a linear sscale"],[35106,1,""],[35064,1,""],[35064,0,". Automerge makes everything look fast."],[35066,37,""],[35065,1,""],[35064,1,""],[35064,0,":"],[35064,1,""],[35064,0,". In comparison"],[35065,14,""],[35064,1,""],[35064,0,":"],[34804,0,"\n"],[34804,0,"\n#["],[34806,1,""],[34805,1,""],[34805,0,"@"],[34805,1,""],[34805,0,"#["],[34806,1,""],[34805,1,""],[34805,0,"![](totals.svg)"],[41222,0,"\n"],[41222,0,"\n"],[41222,1,""],[41221,1,""],[41221,0,"\n\nYou can play with the charts"],[41250,1,""],[41250,0,"ing "],[41223,31,""],[41223,0,"The charts were made using Obj"],[41252,1,""],[41252,0,"servableHQ's "],[41264,1,""],[41263,1,""],[41262,1,""],[41244,5,""],[41244,0,"on"],[41247,0,"["],[41260,0,"](https://observablehq.com/@josephg/crdt-algorithm-performance-benchmarks)."],[42054,0,"n"],[42062,1,""],[42062,0," "],[42366,28,""],[42366,0,"You would just need to:"],[42805,0," And "],[42809,1,""],[42808,1,""],[42807,1,""],[42806,1,""],[42805,1,""],[42805,0," "],[42805,1,""],[42805,0," And "],[42806,4,""],[42805,1,""],[42805,0," And RGA has slightly worse ordering semantics in some"],[42818,41,""],[42818,0,"an interleaving problem when prefixing"],[42841,15,""],[42841,0," th"],[42843,1,""],[42842,1,""],[42842,0,"in "],[42844,1,""],[42843,1,""],[42842,1,""],[42842,0,"when pre"],[42821,0,"["],[42842,0,"](https://www.cl.cam.ac.uk/~arb33/papers/KleppmannEtAl-InterleavingAnomalies-PaPoC2019.pdf)"],[42942,0,"fixing"],[42819,1,""],[42818,1,""],[42817,1,""],[42832,7,""],[42832,0,"anomolies"],[42832,9,""],[42832,0,"no"],[42833,1,""],[42832,1,""],[42832,0,"anomalies"],[42947,0,"p"],[42947,1,""],[42938,9,""],[42938,0,"prepending text "],[42953,1,""],[42953,0," "],[42953,1,""],[42953,0,"."],[42817,0," weird"],[42838,9,""],[42838,0,"problems"],[42813,0," can have"],[42822,4,""],[42842,9,""],[42950,4,""],[42950,0,"items"],[42977,56,""],[42977,0," make my code"],[43015,6,""],[43015,0,"for "],[43026,1,""],[43025,1,""],[43025,0,"ing"],[43054,0,"'as"],[43056,1,""],[43055,1,""],[43055,0,"s"],[43073,0,"Your performance "],[43078,12,""],[43078,0,"benchmarks"],[43088,40,""],[43088,0," measure the wron "],[43105,1,""],[43105,0,"g thing"],[43068,0,"\n"],[43210,5,""],[43210,0,". And I' m"],[43219,1,""],[43218,1,""],[43218,0,"m measuring"],[43254,6,""],[43254,0," A"],[43379,3,""],[43378,1,""],[43377,1,""],[43376,1,""],[43376,0,". "],[43378,1,""],[43378,0,"O"],[43483,0," (And automerge is basically"],[43499,12,""],[43499,0,"usually performacn"],[43516,1,""],[43515,1,""],[43514,1,""],[43514,0,"s that well)"],[43525,0,"."],[43525,0," already"],[43536,26,""],[43593,0,"does "],[43613,1,""],[43658,0,"does "],[43680,1,""],[43700,3,""],[43700,0,"How much time it takes"],[43722,11,""],[43743,0," stored"],[44841,6,""],[44863,0," as a community"],[46057,0," Any pruning system should work with all of the algorithms I've shown here."],[46139,17,""],[46139,0,"Each ste"],[46144,3,""],[46144,0,"improvement changes too many"],[46182,9,""],[46962,0," LLVM?"],[46968,19,""],[46983,0," (Although"],[46983,10,""],[47373,12,""],[47369,4,""],[47369,0,"Because its "],[49099,1,""],[49098,1,""],[31166,32,""],[31166,0,"this code runs"],[31184,6,""],[31184,0,"slower through WASM"],[31208,36,""],[31208,0,"it the"],[31211,0,"because "],[31219,3,""],[31218,1,""],[31229,4,""],[31229,0," calls to the "],[31247,9,""],[31247,0," VM are  slo"],[31258,1,""],[31257,1,""],[31256,1,""],[31255,1,""],[31255,0,"slow"],[31271,21,""],[31271,0,"simply"],[31287,1,""],[31286,1,""],[31285,1,""],[31285,0,"e"],[31302,0," better,"],[31309,1,""],[31309,0,", since it can use"],[31309,18,""],[31286,0," & vectorize"],[31414,0," also"],[31455,17,""],[31455,0,"stea"],[31458,1,""],[31457,1,""],[31457,0,"ay put"],[31471,0," subsequent"],[31460,3,""],[31455,5,""],[31454,1,""],[31454,0,"'re "],[31455,3,""],[31455,0,"d"],[31455,1,""],[31454,1,""],[31454,0," don't move between"],[31473,29,""],[31478,0,"s"],[31478,1,""],[31455,10,""],[31455,0,"have exactly the same shape"],[31490,0," benchmark"],[31513,0,"its "],[31520,0," memory"],[31964,1,""],[31963,1,""],[31962,1,""],[31961,1,""],[31960,1,""],[31960,0,"ative"],[31971,8,""],[31979,0," was deleted"],[31971,1,""],[31970,1,""],[31970,0," m"],[31971,1,""],[31970,1,""],[31970,0,"means the "],[31868,0," "],[35071,0,"i"],[35071,1,""],[35071,0,"With a linear scale "],[35091,1,""],[35091,0,"t"],[35100,8,""],[35099,1,""],[34843,0,"\n\nI'"],[34846,1,""],[34845,1,""],[34845,0,"I've been resisting listing op"],[34874,1,""],[34873,1,""],[34872,1,""],[34872,0," the "],[34845,32,""],[34845,0,"But remember, t"],[34859,1,""],[34859,0,"automerge au"],[34870,1,""],[34869,1,""],[34869,0,"and ref-crdts "],[34859,0,"the "],[34887,0,"impleemntations w"],[34887,17,""],[34887,0,"implementations aren't consistentl"],[34920,1,""],[34920,0,". These numbers change a lot "],[34845,0,"I've been generally rse"],[34867,1,""],[34866,1,""],[34866,0,"eiss"],[34869,1,""],[34868,1,""],[34867,1,""],[34867,0,"sisting showing perfomrance n"],[34883,13,""],[34883,0,"performance numbers like this because "],[34921,17,""],[34920,1,""],[34961,17,""],[34961,0,"get slower over time"],[34983,27,""],[34983,0,"They'd be "],[34988,5,""],[34988,0,"re much faster than this with small dco"],[35026,1,""],[35025,1,""],[35025,0,"ocuments, and slower with large n"],[35057,1,""],[35057,0,"documents."],[34845,75,""],[34845,0,"But these totals for"],[34889,37,""],[34889,0," are entirel "],[34893,9,""],[34893,0," extreml"],[34900,1,""],[34900,0,"ely benchmark dependant"],[34926,3,""],[34926,0,"he algorithms are"],[34943,8,""],[34950,15,""],[34950,0," with"],[34994,0,"r"],[34961,0,"er"],[12023,10,""],[12050,0," before its ready."],[12069,3,""],[12069,0,"O"],[12082,3,""],[12082,0,"the code is "],[12091,3,""],[12091,0,"performs nearly the"],[12100,10,""],[12100,0,"almost the same as"],[12118,19,""],[12146,1,""],[12146,0,":\n\n#"],[12149,1,""],[12149,0,"@"],[12149,1,""],[12149,0,"![](am_vs_amrs.svg)"],[12069,78,""],[12069,0,"W"],[12069,1,""],[12069,0,"Swict"],[12073,1,""],[12072,1,""],[12072,0,"tching to this "],[12082,5,""],[12082,0,"the rust back"],[12086,9,""],[12086,0,"automerge-rs backend doesn't make any "],[12120,4,""],[12120,0,"this test any faster."],[12141,21,""],[12141,0," (Though it does use 3x less R"],[12170,1,""],[12170,0,"memory)"],[12141,36,""],[19853,6,""],[19853,0,"does Yjs"],[19861,3,""],[19861,0," "],[19861,6,""],[19861,0," solve the"],[19849,23,""],[19849,0,"How did he manage that?\n\nSo remember, there are two problems"],[19876,33,""],[19876,0," t"],[19877,1,""],[19877,0,"remember, there are two problems to fix:\n\n- How do we find"],[19921,14,""],[19921,0,"If a user inserted at position 100 in the document, how do we find "],[19921,67,""],[19921,0,"How do we find a specific insert position "],[19962,1,""],[19962,0,"?\n- How do we insert content at that location in a fast way?"],[19975,0," efficiently"],[20019,14,""],[19919,1,""],[19919,0,"1."],[19966,1,""],[19966,0,"2"],[19966,1,""],[19965,1,""],[19965,0,"2. "],[20037,4,""],[20037,0,"the first "],[20046,1,""],[20160,11,""],[20160,0,"bounce around"],[20196,0,"Rather than scanning the document each time an edit hape"],[20251,1,""],[20251,0,"pens, "],[20260,31,""],[20267,1,""],[20266,1,""],[20265,1,""],[20265,0,"es"],[20316,0," mae an"],[20322,1,""],[20321,1,""],[20320,1,""],[20319,1,""],[20319,0,"de an"],[20330,1,""],[20329,1,""],[20329,13,""],[20452,0," editing"],[20550,0,"What if edits happn"],[20568,1,""],[20568,0,"en randomly?!"],[20580,1,""],[20580,0," "],[20580,1,""],[20579,1,""],[20579,0,"?! "],[20581,0," But people don't actually edit documents randomly, so "],[20636,5,""],[20727,23,""],[20777,1,""],[20777,0,", so"],[20782,1,""],[20782,0,"t"],[20829,6,""],[20829,0,"near each user"],[20860,5,""],[20860,0,"they're"],[20871,1,""],[20871,0,"ing"],[20725,0," at the same time"],[20784,0,"d"],[20920,0,"Once yjs finds the target insert location, it needs to"],[20974,15,""],[20925,1,""],[20925,0,"Y"],[21033,7,""],[21039,4,""],[21039,0,"solves "],[21045,1,""],[21153,0,"*"],[21158,0,"*"],[21153,6,""],[21153,0,"constnat"],[21160,1,""],[21159,1,""],[21158,1,""],[21158,0,"tan"],[21160,1,""],[21159,1,""],[21158,1,""],[21158,0,"ant"],[21173,0,"has an extra bonus"],[21191,14,""],[21849,4,""],[21849,0,"So"],[21897,0," too"],[21911,29,""],[21932,0,", just stored more compactly"],[22077,0," internal"],[22124,4,""],[22124,0,"U"],[22165,5,""],[22165,0," o"],[22166,1,""],[22166,0,"document"],[22193,0," using t"],[22200,1,""],[22199,1,""],[22198,1,""],[22197,1,""],[22196,1,""],[22195,1,""],[22194,1,""],[22193,1,""],[22216,0," using this trick"],[22327,0,"conveniently "],[22423,0," And that happens a lot."],[22809,0," in this test"],[22822,1,""],[22822,0,"."],[22824,3,""],[22824,0,"And"],[22828,6,""],[22828,0,"because"],[22828,30,""],[36732,26,""],[36732,0,"what some of my fie"],[36750,1,""],[36749,1,""],[36749,0,"riends"],[36732,23,""],[36732,0,"what some friends would"],[36742,0,"of my "],[36732,29,""],[36732,0,"the reactions of some of my friends"],[36735,0," ridicule"],[36744,13,""],[36744,0," from"],[38902,0," list"],[38912,15,""],[38912,0," implementation"],[39527,0,"\n\nAutomerge is also in the process of dramatically improving performance based on "],[39529,0,"The "],[39533,1,""],[39533,0,"a"],[39542,0," team is also fantastic. They've been receptive to a lo"],[39567,30,""],[39567,0,"I've chatted with them about a lot of these issues and they're "],[39630,9,""],[39683,9,""],[39683,0,"using these tricks. I"],[39703,1,""],[39703,0,"By the time your ea"],[39703,19,""],[39703,0,"In a "],[39703,5,""],[39702,1,""],[39702,0," Performance might have impro"],[39726,5,""],[39726,0,"dramatically"],[39703,0,"Automerge "],[39713,1,""],[39713,0,"p"],[39748,0," improved by the time"],[39758,11,""],[39758,0,"between whe"],[39768,1,""],[39767,1,""],[39766,1,""],[39766,0,"time time I"],[39766,11,""],[39766,0,"the time I wrote this and"],[39758,33,""],[39758,0,"by the time you're reading this too."],[39572,33,""],[39572,0,"had some great conversations with them about "],[39629,0,". They care about '"],[39635,0,"'"],[39636,12,""],[39636,0,"re making performance then "],[39662,1,""],[39661,1,""],[39661,0," #1 issue of 2021 "],[39679,2,""],[39691,18,""],[39691,0,"planning on using a lot of these tricks to "],[39734,53,""],[39734,0,"make the"],[39739,3,""],[39739,0,"automerge fast."],[39753,1,""],[39755,55,""],[39755,0,"It might already be much faster "],[39819,3,""],[39818,1,""],[39856,0,"there's a lot of work that"],[39856,26,""],[39856,0,"I'll probably"],[39869,16,""],[39932,0," and automerge"],[40138,0,", editor bindings"],[40167,19,""],[40166,1,""],[39880,0," it"],[39950,0," Good CRDT libraries need a "],[39951,27,""],[39951,0,"There's "],[39958,1,""],[39957,1,""],[39956,1,""],[39956,0," is a lot more that goes into a good CRDT library than speed."],[40017,84,""],[40017,0," CRDT libraries also need to support"],[40053,10,""],[40090,12,""],[40098,0," data"],[40655,0,"all benchmarks are lies"],[40678,55,""],[40678,0,", and I'm not immune"],[40646,0,"Well, "],[40652,1,""],[40652,0,"y"],[40660,0," "],[40660,1,""],[40661,44,""],[40646,15,""],[40646,0,"Well, yes. But"],[40613,31,""],[40613,0," Lies, damned lies and benchmarks"],[40648,14,""],[40647,1,""],[40646,1,""],[40646,0,"\n\nIs this for real? Yes, but .."],[40676,1,""],[40675,1,""],[40674,1,""],[40674,0,"..."],[40678,0,"\nFirst, "],[40686,2,""],[40686,0,"i"],[40669,0,". And hopefully this is all reproducable."],[40710,1,""],[40711,1,""],[40711,0,"B"],[40670,47,""],[40670,0," But I'm not telling the full picture here."],[40675,0,"pefo"],[40678,1,""],[40677,1,""],[40677,0,"rofmr"],[40681,1,""],[40680,1,""],[40679,1,""],[40678,1,""],[40678,0,"formance is complicated and "],[40816,0,"you can but "],[42356,11,""],[42356,0,"A"],[42351,0,"\n"],[42357,3,""],[42357,0,"Is it fair"],[42357,10,""],[42357,0,"Are CRDT and "],[42361,9,""],[42361,0,"Yjs "],[42361,0,"Automerge and "],[42379,31,""],[42379,0,"doing the same thing? IS it"],[42405,1,""],[42404,1,""],[42403,1,""],[42402,1,""],[42401,1,""],[42400,1,""],[44077,20,""],[44472,0,", a"],[44474,1,""],[44474,0,"barring some unlucky GC pauses"],[45624,3,""],[45624,0,"an"],[45606,4,""],[45606,0,"stores"],[45644,63,""],[45644,0,"The result is that"],[45662,8,""],[45749,0," This uses extra RAM, that none o "],[45782,1,""],[45782,0,"f the other"],[45769,24,""],[45769,0," for a sweet feature, which none of the other implementations"],[45644,0,"As a "],[45649,4,""],[45655,0,","],[45656,8,""],[45725,0," in question"],[45775,61,""],[45775,0,"."],[45761,0,"justifyable "],[45772,1,""],[45771,1,""],[45770,1,""],[45770,0,"ly "],[45767,1,""],[45767,0,"i"],[45794,0,"\nThere's a performance mesa"],[45820,1,""],[45819,1,""],[45819,0,"ausre"],[45817,7,""],[45817,0,"measure nobody is taking seriously enough at the moment. And ti"],[45879,1,""],[45878,1,""],[45878,0,"that is, "],[45886,1,""],[45885,1,""],[45885,0,", "],[45795,92,""],[45795,0,"There's a performance measure nobody is taking seriously enough at the moment. And that is,"],[45886,80,""],[45886,0," "],[45919,0," (in a database)"],[45990,0,"And "],[45994,1,""],[45994,0,"u"],[46015,0,"are actually interat"],[46034,1,""],[46034,0,"cting with "],[46045,4,""],[46044,1,""],[46219,13,""],[46219,0,"isn't very"],[46225,4,""],[46225,0,"often useful"],[46124,0,"."],[46126,6,""],[46126,0,"T"],[46221,13,""],[46221,0,"how we should interact wti"],[46246,1,""],[46245,1,""],[46245,0,"ith this sort of data."],[46125,142,""],[47052,11,""],[47052,0,"step in this sto"],[47065,3,""],[47065,0,"journey"],[47213,0,"implementation "],[47228,12,""],[47234,1,""],[47234,0,"d"],[47235,3,""],[47560,11,""],[47560,0,"all of thes"],[47567,4,""],[47567,0,"t"],[47564,4,""],[47564,0,"this"],[47574,10,""],[47574,0,"I'm "],[47577,1,""],[47582,1,""],[47582,0,"sing"],[47590,11,""],[47590,0," "],[47607,0," should be distributed"],[47641,19,""],[47641,0," those changes"],[47884,0,"'s optimizer"],[47912,0," (Though if "],[47920,4,""],[47920,0," the fact automerge-rs is still pretty so"],[47960,1,""],[47960,0,"low"],[47945,18,""],[47945,0,"n't any faster than automerge gives me some confidence)"],[47999,0,"."],[47999,0," that its not just rust"],[47914,8,""],[47914,0,"T"],[47914,102,""],[47898,0,"\nThe fact automerge-rs isn't any faster than automerge gives me some confidence that its not just rust."],[47907,0," that"],[47931,4,""],[48002,0," But honestly"],[48015,1,""],[48015,0," "],[48031,1,""],[48030,1,""],[48029,1,""],[48028,1,""],[48028,0,"."],[40823,0,". "],[40824,1,""],[40823,1,""],[40823,0,": (Though"],[40878,1,""],[40878,0,")"],[40861,12,""],[40866,0,"."],[40832,4,""],[40823,1,""],[40823,0,"."],[40826,6,""],[40826,0,"But"],[40825,1,""],[40859,1,""],[1327,4,""],[1327,0,"their"],[1362,28,""],[1362,0,"S"],[1369,0," smart"],[1369,6,""],[1369,0," smart"],[1369,6,""],[1362,1,""],[1362,0,"s"],[1362,0,"The annoying part was that "],[1365,9,""],[1365,0," infuriating"],[2903,0," someone out "],[2874,6,""],[2866,8,""],[2866,0,"somebody will find"],[2920,0,"there will write a"],[2938,7,""],[2960,1,""],[4708,3,""],[4708,0,"Thats"],[21087,25,""],[21087,0,"using "],[21106,0," instead of an array"],[21128,24,""],[21128,0,"L"],[21147,7,""],[21153,0,"s"],[21128,0,"Ao lo"],[21132,1,""],[21131,1,""],[21130,1,""],[21129,1,""],[21128,1,""],[21128,0,"so lon"],[21128,6,""],[21128,0,"So long as we have an insert position, "],[21167,1,""],[21167,0,"l"],[21186,8,""],[21186,0,"us to insert "],[21186,6,""],[21192,0,"s"],[21094,0," bidirectional"],[21200,0,"th"],[21201,1,""],[21200,1,""],[21231,36,""],[21231,0,"does one more thing to makep"],[21258,1,""],[21254,4,""],[21254,0,"improve perofrman"],[21262,9,""],[21262,0,"performance"],[21273,1,""],[21273,0,"."],[21275,9,""],[21275,0,"H"],[21281,0," usually"],[21316,1,""],[21316,0,"."],[21318,1,""],[21318,0,"W"],[21317,0," So"],[21320,2,""],[21320,0," w"],[21916,4,""],[21916,0,"F"],[22026,161,""],[22025,1,""],[22229,13,""],[22336,133,""],[22338,5,""],[22338,0,"I"],[22346,12,""],[22345,1,""],[22356,4,""],[22356,0,"using space"],[22366,1,""],[22365,1,""],[22365,0,"ns"],[22367,7,""],[22398,16,""],[22397,1,""],[22390,0,"array "],[22403,6,""],[23072,0," oni "],[23076,1,""],[23075,1,""],[23074,1,""],[23073,1,""],[23073,0,"in this test"],[23153,1,""],[23153,0,"."],[23155,3,""],[23154,1,""],[23155,1,""],[23155,0,"I"],[23124,9,""],[23355,0," Look -"],[23370,0," even"],[23356,7,""],[23881,16,""],[23881,0,"Kevin"],[23881,5,""],[23881,0,"Or when the user"],[23931,0,"Bu"],[23932,1,""],[23931,1,""],[23931,0,"This is neat, but "],[23949,1,""],[23949,0,"t"],[26311,19,""],[26311,0,"more information"],[26343,2,""],[26343,0,"of"],[26360,0,"We want"],[26367,2,""],[26401,5,""],[26401,0,"to"],[26702,42,""],[26702,0,"thats "],[26702,6,""],[26702,0,"Thats probably no "],[26719,1,""],[26719,0,"t a big ea"],[26728,1,""],[26727,1,""],[26727,0,"deal in text editing"],[26789,0," use"],[26851,4,""],[26851,0,"slow"],[26855,9,""],[26986,6,""],[26986,0,"exotic "],[27304,20,""],[27304,0,"is very clever"],[27318,6,""],[27323,0," its not "],[27332,10,""],[27342,3,""],[27342,0,"microoptimization"],[27342,17,""],[27342,0,"small"],[27342,5,""],[27342,0,"clever"],[27412,0," at all"],[27413,6,""],[27412,1,""],[27401,0,"'"],[27383,0,"'"],[27384,18,""],[27384,0,"re not limited to"],[27401,1,""],[27412,0," here"],[27412,5,""],[27449,0,"'"],[27449,1,""],[27770,3,""],[27770,0,"the"],[27780,1,""],[27780,0,"\n\nUsually when people talk about b-trees they meana  "],[27832,1,""],[27831,1,""],[27830,1,""],[27830,0," a BTreeMap "],[27841,1,""],[27841,0,". But my implementation"],[27864,4,""],[27864,0," insn"],[27868,1,""],[27867,1,""],[27866,1,""],[27866,0,"sn't"],[27870,6,""],[27842,0," Thats not what I'm doing here."],[27873,48,""],[27893,7,""],[27893,0,"keys"],[27980,0," (recursively)"],[28009,34,""],[28009,0,"do insertions and delete"],[28032,1,""],[28032,0,"ions in"],[28049,6,""],[28049,0,"time, while updating the position of every character in the wole docu"],[28109,9,""],[28109,0,"whole document. It "],[28127,1,""],[28126,1,""],[28125,1,""],[28124,1,""],[27833,0,"["],[27842,0,"](https://doc.rust-lang.org/std/collections/struct.BTreeMap.html)"],[28009,21,""],[28009,0,"number of characters in that"],[28053,14,""],[28009,0,"totall "],[28015,1,""],[28014,1,""],[28014,0," "],[28118,71,""],[28118,0,"."],[28073,0," find any imt"],[28085,1,""],[28084,1,""],[28084,0,"tem by characte"],[28074,25,""],[28074,0,"look up any item by b"],[28094,1,""],[28094,0,"character position,"],[28113,3,""],[28123,1,""],[28122,1,""],[28121,1,""],[28120,1,""],[28120,0," or"],[28120,0,","],[28120,1,""],[28124,3,""],[28123,1,""],[28132,1,""],[28131,1,""],[28130,1,""],[28129,1,""],[28129,0,"e"],[28035,0," (recursively)"],[28075,4,""],[28075,0,"So we can"],[28084,8,""],[28101,0," in the document"],[28140,0," or"],[28161,0,"all "],[28160,0," anywhere in th edocument"],[28175,1,""],[28176,0," "],[28186,4,""],[28241,0,"\n"],[28241,0,"\n> Does this have a name? I've been calling it a \"range tree\", but that name see"],[28318,3,""],[28318,0,"is ["],[28321,1,""],[28321,0,"[taken by another al"],[28339,2,""],[28339,0,"data structure](https://en.wikipedia.org/wiki/Range_tree)"],[28308,0,"I think "],[28315,1,""],[28314,1,""],[28313,1,""],[28312,1,""],[28311,1,""],[28310,1,""],[28309,1,""],[28308,1,""],[28308,4,""],[28308,0,"I think that"],[35329,0,"\n"],[35329,0,"\nThe total "],[35330,10,""],[35330,0,"I"],[35330,1,""],[35330,0,"In this benchmark the average"],[35330,29,""],[35330,0,"The number of operations per second looks like this"],[35330,3,""],[35330,0,"In this benchn"],[35343,1,""],[35343,0,"mark the"],[35362,10,""],[35362,0,"edits each algorithm can process"],[35421,0,":"],[35444,0," reem"],[35448,1,""],[35447,1,""],[35447,0,"member,"],[35455,17,""],[35445,10,""],[35445,0,"particularly for "],[35485,0,", these perorman"],[35493,8,""],[35493,0,"performance numbers"],[35563,3,""],[35563,0,"run"],[35631,0," "],[35631,1,""],[35631,0," And in the case of automerge, it may be able to do about 900 edits per second"],[35680,2,""],[35680,0,"process"],[35714,0," *on average*, but the slowest edit during this benchmark took "],[35772,5,""],[35772,0,"stalle "],[35778,1,""],[35778,0,"d the jav"],[35780,7,""],[35780,0,"javascript for 1.8 *"],[35799,1,""],[35799,0,"seconds."],[35780,10,""],[35780,0,"V8"],[35772,0,"entirely "],[35772,9,""],[35772,0,"completely "],[35546,1,""],[35546,0," because"],[35554,4,""],[35554,0," the"],[35570,45,""],[35570,0,"slow down as the document grows"],[35601,22,""],[35632,0," although"],[35644,15,""],[35644,0," can"],[35697,4,""],[35736,0," run"],[35740,11,""],[35768,0," In a res"],[35776,1,""],[35776,0,"al usage "],[35778,7,""],[35778,0," appli"],[35774,10,""],[35774,0,"web application this woudl"],[35799,1,""],[35798,1,""],[35798,0,"ld make the whole webpage hang "],[35828,1,""],[35828,0,"."],[35816,8,""],[35816,0,"app"],[35818,1,""],[35817,1,""],[35816,1,""],[35816,0,"web app "],[10839,4,""],[10838,1,""],[10838,0," Its "],[10839,4,""],[10839,0,"This chart averaes"],[10856,1,""],[10855,1,""],[10855,0,"ges over "],[10767,97,""],[10767,0,"That big spike? A group of 1000 edits took over 3.5 seconds to process. This chart averages over"],[10783,80,""],[10783,0,"It happened because a single edit took *1.2"],[10825,1,""],[10825,0,"8 seconds* to process. (Presumably"],[10849,10,""],[10848,1,""],[10847,1,""],[10817,4,""],[10817,0,"was processing for"],[10849,12,""],[10849,0,". Of"],[10852,1,""],[10852,0,"f"],[10852,1,""],[10852,0,"of. In a real application that would feel like the whole website freezing up for a couple of seconds hli"],[10955,1,""],[10954,1,""],[10953,1,""],[10953,0,"while you're trying "],[10966,7,""],[10966,0,"in the middle of typing."],[10783,21,""],[10783,0,"A"],[10863,33,""],[10863,0,"means the whole applicatoin"],[10889,1,""],[10888,1,""],[10887,1,""],[10887,0,"ion would"],[10904,1,""],[10903,1,""],[10902,1,""],[10902,0,"e"],[10903,3,""],[10862,6,""],[10862,0," would translate to"],[10863,6,""],[10872,0,"s"],[10898,6,""],[10904,1,""],[10904,0,"ing up"],[10863,11,""],[10863,0,"would translate to "],[10879,3,""],[10863,22,""],[10863,0,"would result in the"],[10863,15,""],[10863,0,"means"],[10890,0," would"],[10904,1,""],[10903,1,""],[10902,1,""],[10901,1,""],[10901,0,"e"],[10901,1,""],[10901,0,"ze"],[10930,0," sometimes"],[10954,17,""],[10879,11,""],[10879,0,"app"],[10883,0,"("],[10883,1,""],[10883,0,"(or browser tab) "],[10939,10,""],[10952,0," in the middle of"],[10939,0," sometimes"],[11075,0,"We can see the "],[11090,1,""],[11090,0,"p"],[11090,0,"average "],[10858,11,""],[35486,19,""],[35486,0,"T"],[35489,0," average"],[35540,0," in this test"],[35489,24,""],[35489,0," speed of processing edits"],[35496,3,""],[35496,0,"each algorithm "],[35520,1,""],[35519,1,""],[35518,1,""],[35518,0,"es"],[35526,51,""],[35565,0," remember -"],[35566,0,"these numbers are misleading. "],[35596,29,""],[35596,0,"In a"],[35596,0,"Remember, "],[35606,1,""],[35606,0,"i"],[35606,3,""],[35629,84,""],[35630,0,"gradually "],[35673,46,""],[35673,0,"Automerge can "],[35735,0," but"],[35673,0,"And even though "],[35689,1,""],[35689,0,"a"],[35826,61,""],[35486,0,"A"],[35486,1,""],[35486,0,"We can make a chart showing "],[35514,1,""],[35514,0,"t"],[35554,16,""],[35641,0," aren't steady. They"],[35661,10,""],[35661,0,"'re fast at first "],[35678,1,""],[35678,0,", then "],[35684,1,""],[35797,3,""],[35796,1,""],[35854,0," a full"],[35808,0," single"],[35808,7,""],[35801,7,""],[35800,1,""],[35800,0,"re was an"],[35806,3,""],[35802,4,""],[35800,2,""],[35800,0," slowest"],[35518,0,"average "],[35803,0," (wh"],[35806,1,""],[35805,1,""],[35804,1,""],[35804,0,"(which f"],[35811,1,""],[35811,0,"is fast enough that users's "],[35838,1,""],[35837,1,""],[35836,1,""],[35835,1,""],[35835,0,"s won't notice)"],[35929,0," "],[35929,1,""],[35851,0," memory usage pac"],[35867,1,""],[35866,1,""],[35866,0,"eaked at 2.6GB and"],[9939,0," The peak memory usage is "],[9940,25,""],[9940,0,"At peak, automerge u"],[9959,1,""],[9949,10,""],[9949,0,"the benchmark used 2.6 GB of RAM."],[9962,5,""],[9962,0," needed"],[9534,0,"v"],[9534,1,""],[9534,0,"v"],[9550,0,"v"],[9550,1,""],[9548,1,""],[9549,0,"v"],[9549,1,""],[35897,0,"in this test "],[35936,0," "],[36021,0," I "],[36023,1,""],[36022,1,""],[36022,0,"My test be"],[36031,1,""],[36030,1,""],[36025,5,""],[36025,0,"workstation has CPU and RAM for days, but your users w"],[36078,1,""],[36078,0,"w"],[36078,1,""],[36078,0,"don't."],[36021,63,""],[35897,47,""],[36316,0,"\n"],[37233,0," write "],[37234,6,""],[37234,0,"optimize"],[37320,26,""],[37320,0,"wa"],[37321,1,""],[37321,0,"hat "],[37311,25,""],[37318,2,""],[37318,0,"normal"],[37325,0," (Howls o"],[37327,7,""],[37327,0,"l"],[37327,1,""],[37327,0,"Laughter of my friends notwithstanding)"],[37365,0,"."],[37318,6,""],[37318,0,"ok"],[37323,38,""],[37323,0,"Despite what my feien"],[37343,1,""],[37342,1,""],[37341,1,""],[37340,1,""],[37340,0,"riends would have you think"],[37367,1,""],[37367,0,"!"],[37366,1,""],[37365,1,""],[37364,1,""],[37363,1,""],[37362,1,""],[37361,1,""],[37360,1,""],[37359,1,""],[37358,1,""],[37357,1,""],[37356,1,""],[37355,1,""],[37354,1,""],[37353,1,""],[37352,1,""],[37351,1,""],[37350,1,""],[37349,1,""],[37348,1,""],[37347,1,""],[37347,0,"think"],[37890,0," between wp"],[37900,1,""],[37899,1,""],[37899,0,"people with "],[37911,76,""],[37910,1,""],[38907,0,". Fr"],[38910,1,""],[38910,0,"or all O"],[38917,1,""],[38917,0,"of Kevin's "],[38909,19,""],[38909,0,"Kevin is "],[38909,9,""],[38909,0,"For all of Kevin's "],[38909,19,""],[38909,0,"Yjs is excellent in part because"],[38909,32,""],[38909,0,"Kevin adapt"],[38915,5,""],[38914,1,""],[38913,1,""],[38912,1,""],[38911,1,""],[38910,1,""],[38909,1,""],[38908,1,""],[38907,1,""],[38908,0," k"],[38909,1,""],[38909,0,"Kevin"],[38909,5,""],[38909,0,"Yjs's "],[38914,1,""],[38913,1,""],[38912,1,""],[38912,0," owes its serialization"],[38913,22,""],[38913,0,"adapted"],[38912,8,""],[38909,0,"Kevin copied it "],[38909,19,""],[38908,1,""],[31851,0," Remember, the WASM version s"],[31879,1,""],[31879,0,"(shown here) is "],[31895,33,""],[31905,12,""],[31895,0,"still "],[31911,0,"than how"],[31916,3,""],[31916,0,"the speed this code runs nativelay"],[31949,1,""],[31948,1,""],[31948,0,"y"],[31950,0," I wonder why?"],[31965,13,""],[31965,0,"Are th"],[31970,1,""],[31969,1,""],[31968,1,""],[32000,4,""],[32119,13,""],[32119,0,"I"],[32119,1,""],[32119,0,"No matter - i"],[32283,0," requesting morem"],[32299,1,""],[32299,0," memory form "],[32311,1,""],[32310,1,""],[32309,1,""],[32308,1,""],[32308,0,"rom "],[32259,5,""],[32259,0,"t"],[32280,0,"is "],[32253,58,""],[32253,0,"I suse"],[32258,1,""],[32258,0,"pect its the"],[32263,7,""],[32263,0,"the memory allocator"],[32273,10,""],[32266,7,""],[32263,3,""],[32263,0,"its the"],[32266,4,""],[32262,4,""],[32258,4,""],[32258,0,"e"],[32254,5,""],[32253,1,""],[32253,0,"Maybe the memory allocator is requesting more memory from "],[32282,1,""],[32280,2,""],[32259,1,""],[32259,0,"its t"],[32311,1,""],[32308,3,""],[32308,0,"orm "],[32311,1,""],[32306,5,""],[32299,7,""],[32299,0,"m"],[32294,6,""],[32283,11,""],[32000,0," are"],[32000,4,""],[32253,5,""],[32253,0,"Its probably"],[32265,4,""],[32286,1,""],[32286,0,"."],[31951,10,""],[31951,0,"W"],[31753,0," performance through"],[31778,17,""],[31778,0," in the"],[31784,1,""],[31784,0,"is chart"],[31869,0,"And "],[31873,1,""],[31873,0,"r"],[31883,79,""],[31883,0,"this is the slow version. The code runs 3x faster "],[31923,0,"another "],[31951,0,"But "],[31955,1,""],[31955,0,"w"],[32114,11,""],[32114,0,"I"],[32115,2,""],[32114,0,"Mayb "],[32118,1,""],[32118,0,"e it doesn't matter too much - "],[32149,1,""],[32149,0,"i"],[32271,0,"I assume its"],[32283,12,""],[32271,10,""],[32271,0,"I"],[32274,0," probably"],[31909,3,""],[31909,0,"When I run this benchmark natively it"],[31946,5,""],[31969,9,""],[31952,7,""],[31951,1,""],[31961,0," again"],[31962,5,""],[31961,1,""],[31961,0," than this"],[32171,3,""],[32171,0,"the code is"],[31652,5,""],[31652,0,"needs"],[31657,7,""],[31662,0," calls to malloc"],[31678,6,""],[31652,5,""],[31652,0,"makes"],[32638,0,"Note: "],[33483,0,"For "],[33487,1,""],[33487,0,"l"],[33504,5,""],[33504,0," we'll end up"],[33522,1,""],[33522,0,"ing"],[33483,3,""],[33483,0,"In"],[33483,2,""],[33483,0,"For"],[33570,2,""],[33570,0,"For example"],[33599,0," CRDT"],[33620,7,""],[33620,0,"the editor"],[33636,4,""],[33636,0,"keep"],[33755,0,", at all"],[33765,83,""],[33765,0,"This implementation approach makes it easy to just turn that part of the code off."],[33902,0,"But regardless, "],[33918,1,""],[33918,0,"m"],[19104,0,"'"],[19945,0,"w"],[19945,1,""],[19945,0,"e"],[2658,0,"'"],[3489,0,"'"],[4739,0,"'"],[5084,0,"'"],[5249,0,"'"],[5247,4,""],[5247,0,"Automerge is"],[7427,3,""],[7427,0,"This is"],[8152,3,""],[8152,0,"i'"],[8153,1,""],[8153,0,"t's"],[9874,0,"'"],[12313,0,"'"],[12727,0,"'"],[12998,0,"'"],[12998,1,""],[12998,0,"'"],[12998,1,""],[12727,1,""],[12727,0,"'"],[12727,1,""],[12313,1,""],[12313,0,"'"],[12727,0,"'"],[13294,0,"'"],[13505,0,"'"],[14303,0,"'"],[14448,0,"'"],[14868,0,"'"],[14924,0,"'"],[16554,0,"'"],[16840,0,"'"],[17369,0,"'"],[22821,0,"'"],[23382,0,"'"],[23664,0,"'"],[24030,0,"'"],[24827,0,"'"],[24834,0," a"],[25463,0,"'"],[27567,0,"'"],[29578,0,"'"],[30079,0,"'"],[30530,0,"'"],[32350,0,"'"],[32957,0,"'"],[35076,0,"'"],[36252,0,"'"],[36252,1,""],[36252,0,"'"],[36275,2,""],[36275,0,"this"],[36270,4,""],[36270,0,"tiy"],[36272,1,""],[36272,0,"dy"],[37073,0,"'"],[41132,0,"'"],[41775,0,"'"],[44440,0,"'"],[48705,0,"'"],[49145,0,"'"],[12999,0,"  "],[13000,1,""],[12999,1,""],[28446,0,"\n"],[28446,0,"\nIn "],[28447,3,""],[28447,0,"This example shows a docuen"],[28473,1,""],[28472,1,""],[28472,0,"ment with 1000 charat"],[28492,1,""],[28492,0,"cters"],[28477,0,"which currently has "],[28497,5,""],[28512,0,"."],[28512,1,""],[28512,0,":"],[28466,0,"the tree storing "],[28841,4,""],[28841,0,"5"],[28892,0," In th e"],[28899,1,""],[28898,1,""],[28898,0,"e examlpe abo"],[28900,11,""],[28900,0,"example above, we "],[28841,1,""],[28841,0,"2"],[28915,3,""],[28915,0,"the item with position 200 must be in the "],[28938,3,""],[28938,0,"345"],[28940,1,""],[28939,1,""],[28939,0,"50"],[28957,0,"middle node in the in"],[28964,14,""],[28964,0,"leaf node here."],[29079,0," in this benchmark"],[30036,0," Unlike in the diagram,"],[30060,1,""],[30060,0,"e"],[30287,10,""],[30287,0,"CPUs can copy several"],[30332,0,"Its "],[30336,1,""],[30336,0,"n"],[30395,0," entries"],[30411,2,""],[30411,0,"this"],[30447,0,"bucket "],[30697,0," Thats 5x faster than yjs, and"],[30727,8,""],[30727,0," m"],[30728,1,""],[30728,0,"remarkably"],[30788,10,""],[30788,0,", "],[30789,1,""],[30788,1,""],[30788,0,"."],[30722,1,""],[30722,0,"."],[30724,4,""],[30724,0,"And "],[30754,0,"our baseline test "],[30806,1,""],[30806,0,", despite"],[30815,9,""],[30822,36,""],[30822,0,"all the work to support"],[30867,4,""],[30870,5,""],[30870,0,"I"],[30870,1,""],[30870,0,"And i"],[30870,5,""],[30870,0,"I"],[30884,2,""],[30884,0,"this benchmark"],[30918,0,"["],[30945,0,"](https://github.com/josephg/text-crdt-rust/blob/ba20b6386c0472958f33024ce0b806e75470e1ca/benches/yjs.rs)"],[36122,12,""],[36122,0,"calculate"],[36131,8,""],[36344,5,""],[36344,0,"E"],[37087,0," As Ive"],[37093,1,""],[37092,1,""],[37092,0,"'ve shown,"],[37103,1,""],[37103,0,"w"],[10831,14,""],[10831,0,"In the big spike"],[10831,16,""],[10831,0,"In the slowest spike near the end,"],[10865,1,""],[10866,1,""],[10866,0,"a"],[10880,18,""],[10880,0,"took"],[10898,0," to process"],[10937,0,","],[12412,0," (Although it does smooth out pre"],[12444,1,""],[12443,1,""],[12443,0,"erformance)"],[12431,0,"halve memory usage and "],[12477,0,"."],[12477,1,""],[12476,0,"."],[12391,9,""],[12391,0,"average perofma"],[12405,1,""],[12404,1,""],[12403,1,""],[12402,1,""],[12402,0,"formance in this test"],[45279,5,""],[47003,1,""],[47003,0,"one other"],[47033,0,"I think "],[47206,5,""],[47206,0,"U"],[47599,4,""],[47599,0,"for"],[47817,0,"There's another per"],[47835,1,""],[47834,1,""],[47833,1,""],[47833,0,"aprp"],[47836,1,""],[47835,1,""],[47835,0,"proach to making CRDTs fast, which is pruning. Essentially, "],[47881,52,""],[47881,0," "],[47869,0," I haven't mentioned here at all and that"],[47914,0,"*"],[47922,0,"*"],[47925,0,"By e"],[47928,1,""],[47928,0,"default, list "],[47953,4,""],[47953,0,"e"],[47953,1,""],[47953,0,"these"],[47959,0,"only ever "],[47993,0," m"],[47994,1,""],[47994,0,"have to"],[48018,4,""],[48018,0,"for"],[48041,0," There are a few apr"],[48060,1,""],[48060,0,"proaches which pull"],[48041,0," Storing and"],[48042,11,""],[48042,0,"A lot of the performance and memory cost of CRDTs coem"],[48095,1,""],[48094,1,""],[48094,0,"mes from storing"],[48103,0,"loading, "],[48119,0," and searching that growing data set."],[48194,0," this data out entirely."],[48218,22,""],[48219,1,""],[48219,0,"Fo"],[48220,1,""],[48219,1,""],[48167,5,""],[48167,0,"some"],[48216,0,", and "],[48216,6,""],[48218,0,"For example, "],[48231,3,""],[48264,1,""],[48254,0,"["],[48265,0,"](https://braid.org/antimatter)"],[48189,0,"solve this problem by finding ways to "],[48227,9,""],[48227,0,"discard this"],[48244,5,""],[48244,0," "],[48227,7,""],[48227,0,"hs"],[48228,1,""],[48227,1,""],[48227,0,"shed"],[48232,0,"some of "],[48339,0," That said,"],[48350,40,""],[48354,0," just has its "],[48355,13,""],[48355,0,"repositories have tehi"],[48376,1,""],[48375,1,""],[48374,1,""],[48374,0,"heir data "],[48368,16,""],[48368,0,"only grow over time"],[48373,0,"ever "],[48392,5,""],[48392,0," and"],[48396,2,""],[48422,45,""],[48422,0,". So maaby"],[48431,1,""],[48430,1,""],[48429,1,""],[48429,0,"ybe"],[48424,8,""],[48424,0,"Maybe it doesn't matter so long as the underlying system is fast enough?"],[48418,0,"about "],[48410,18,""],[48410,0,"mind too much"],[48503,6,""],[48503,0,"pruning is"],[48557,4,""],[48557,0," A"],[48575,0,"also "],[48574,0," should also"],[48586,17,""],[48586,0," be abl"],[48590,3,""],[48590,0,"applicable to"],[48603,9,""],[48603,0," any"],[48642,0," Maybe thats how "],[48648,11,""],[48648,0," ruthlessly pruning & archiving old dta"],[48686,1,""],[48685,1,""],[48685,0,"ata is how "],[48692,4,""],[48692,0,"the patch"],[48700,1,""],[48699,1,""],[48699,0,"t"],[48699,1,""],[48698,1,""],[48698,0,"th to getting another 5x "],[48712,11,""],[48712,0,"evebn "],[48717,1,""],[48716,1,""],[48715,1,""],[48715,0,"b "],[48716,1,""],[48715,1,""],[48715,0,"m "],[48716,1,""],[48715,1,""],[48715,0,"n better performance, yet "],[48735,6,""],[48735,0,"."],[48558,1,""],[48558,0,"Any good"],[48593,17,""],[48593,0," work with"],[48603,4,""],[48603,0," all"],[48631,0,"talk a"],[48636,1,""],[48635,1,""],[48635,0,"ed about"],[48643,5,""],[48649,94,""],[48713,1,""],[48712,1,""],[48712,0,"s"],[48712,1,""],[48712,0,"ah"],[48735,14,""],[48735,0,"step in this optimization ho"],[48762,1,""],[48761,1,""],[48761,0,"jui"],[48763,1,""],[48762,1,""],[48762,0,"ourney involves"],[48785,0," to "],[48788,1,""],[48809,0,"For example, "],[48822,1,""],[48822,0,"m"],[48807,0," and I'm not isolating them"],[48830,4,""],[48830,0,"those changes"],[49265,1,""],[49264,1,""],[49263,1,""],[49263,0,"I can only"],[49281,1,""],[49280,1,""],[49279,1,""],[49361,1,""],[49355,6,""],[49355,0,"jump"],[49485,0,"yjs and "],[49485,8,""],[49698,9,""],[49700,0,"hoest"],[49704,1,""],[49703,1,""],[49702,1,""],[49702,0,"nestly "],[49765,5,""],[49765,0,"my "],[49785,0," problem"],[49852,5,""],[49852,0,"the"],[49948,5,""],[49948,0,"bread"],[49952,1,""],[49952,0,"kdown"],[50059,0,"still "],[50164,0,"["],[50164,1,""],[50164,0,"["],[50164,1,""],[50173,0," [from automerge:"],[50189,1,""],[50189,0,"](https://github.com/automerge/automerge/blob/d2e7ca2e141de0a72f540ddd738907bcde234183/backend/op_set.js#L649-L659)"],[15151,0," If yo're "],[15152,9,""],[15152,0,"It looks "],[15152,9,""],[15152,0,"Autom"],[15152,5,""],[15152,0,"Comp"],[15152,4,""],[15152,0,"Compacted, automerge looks like this:"],[15152,12,""],[15152,0,"A"],[15178,0,"\n\n"],[15179,0,"\n```javascript\n\n\n```"],[15194,1,""],[15194,0,"const integrateAutomergeSmol = <T>(doc: Doc<T>, newItem: Item<T>) => {\n  const {id} = newItem\n  doc.version[id[0]] = id[1]\n\n  let parent = findItem(doc, newItem.originLeft)\n\n  let i\n\n  // Scan to find the insert location\n  for (i = parent + 1; i < doc.content.length; i++) {\n    let o = doc.content[i]\n    let oparent = findItem(doc, o.originLeft)\n\n    // Should we insert here?\n    if (oparent < parent\n      || (oparent === parent\n        && (newItem.seq === o.seq)\n        && id[0] < o.id[0])\n    ) break\n  }\n\n  // We've found the position. Insert at position *i*.\n  doc.content.splice(i, 0, newItem)\n  doc.maxSeq = Math.max(doc.maxSeq, newItem.seq)\n}"],[15183,10,""],[15183,0,"typescript"],[15221,1,""],[15220,1,""],[15219,1,""],[15218,1,""],[15320,0,"i, "],[15366,9,""],[15842,1,""],[15562,0," (Thisi s "],[15571,1,""],[15570,1,""],[15569,1,""],[15568,1,""],[15564,4,""],[15564,0,"Black magic incoming)"],[15584,0,"!"],[15584,1,""],[15316,5,""],[15316,0,"let"],[15319,1,""],[15316,3,""],[15316,0,"const"],[15365,0,"  let i"],[15372,38,""],[15365,0,"  // Scan to find the insert location\n"],[15364,0,"\n  "],[15365,2,""],[15618,63,""],[15618,0,"      || (oparent === parent && (newItem.seq === o.seq)"],[15618,83,""],[15618,0,"      || (oparent === parent && (newItem.seq === o.seq) && id[0] < o.id[0])"],[15618,75,""],[15618,0,"      || (oparent === parent && (newItem.seq === o.seq)\n        && id[0] < o.id[0])"],[15618,55,""],[15618,0,"      || (oparent === parent\n        && (newItem.seq === o.seq)"],[15618,63,""],[15618,0,"      || (oparent === parent && (newItem.seq === o.seq)"],[15618,83,""],[15618,0,"      || (oparent === parent && (newItem.seq === o.seq) && id[0] < o.id[0])"],[15618,75,""],[15618,0,"      || (oparent === parent && (newItem.seq === o.seq)\n        && id[0] < o.id[0])"],[15618,55,""],[15618,0,"      || (oparent === parent\n        && (newItem.seq === o.seq)"],[15571,0,"Warning: "],[15591,9,""],[15580,0,"Deep sourcery"],[15593,11,""],[15593,0,"Black magic"],[15584,9,""],[15580,4,""],[15591,0,"."],[15591,1,""],[15152,10,""],[15152,0,"Written this way, automerge "],[15382,0," /** "],[15386,1,""],[15385,1,""],[15384,1,""],[15384,0,"/ SLOW"],[15382,8,""],[15160,8,""],[15160,0,"in thi"],[15160,6,""],[15160,0,"in thi s"],[15167,1,""],[15166,1,""],[15166,0,"s style"],[15184,11,""],[15184,0," turns into"],[14892,2,""],[14892,0,"This"],[15154,49,""],[15154,0,"Specifically, these 20 lines of code:"],[15551,0,"\n        if (newItem.seq > o.seq) break\n"],[15552,8,""],[15552,0,"      "],[15552,6,""],[15552,0,"    "],[15586,1,""],[15586,0,"\n    let oparent = findItem(doc, o.originLeft)"],[15506,46,""],[15540,0," // Optimizatin"],[15554,1,""],[15553,1,""],[15553,0,"on"],[15554,1,""],[15553,1,""],[15553,0,"ion for non-concurrent editing case"],[15556,32,""],[15556,0," only"],[15556,5,""],[15544,0,"This is just an "],[15560,1,""],[15560,0,"o"],[15572,0,".\n    "],[15574,4,""],[15544,29,""],[15544,0,"Optimization."],[15544,0,"Unnecessary "],[15556,1,""],[15556,0,"o"],[15296,29,""],[15296,0,"x"],[15298,0,"z"],[15298,1,""],[15296,1,""],[15296,0,"\n  doc.version[id[0]] = id[1]"],[15296,30,""],[15865,0,"\n  \n  doc.version[id[0]] = id[1]"],[15866,2,""],[15866,0,"\n// "],[15869,1,""],[15868,1,""],[15867,1,""],[15867,0,"  // And s"],[15876,1,""],[15876,0,"assorted bookkeeping."],[15876,0,"do "],[15879,8,""],[15879,0,"various"],[15173,3,""],[15179,8,""],[15152,0,", like this"],[15163,28,""],[15163,0,":"],[15956,0,"\n\n<video controls>\n  <source src=https://invisiblecollege.s3-us-west-1.amazonaws.com/braid-meeting-10.mp4'"],[15989,0,"'"],[16062,0,"#t-"],[16064,1,""],[16064,0,"=270"],[16069,0,"\n  </div"],[16076,1,""],[16075,1,""],[16074,1,""],[16074,0,"video>"],[16070,2,""],[16069,0,">"],[16069,0," type=video/mp4"],[15973,0," height=400"],[16076,3,""],[16076,0,"300"],[15209,1,""],[15208,1,""],[15207,1,""],[15218,1,""],[15217,1,""],[15216,1,""],[15233,1,""],[15232,1,""],[15231,1,""],[15478,13,""],[15478,0,"O"],[15152,12,""],[15152,0,". Automerge looks like this, "],[15180,1,""],[15179,1,""],[15179,0,", though there's probably"],[15187,17,""],[15187,0," the people who understand this code probably fit in a small room, so don't or"],[15264,1,""],[15263,1,""],[15263,0,"worry"],[15253,1,""],[15252,1,""],[15252,0,". "],[15254,4,""],[15254,0,"D"],[15265,0," if this looks like"],[15274,10,""],[15274,0,"makes nose "],[15284,1,""],[15283,1,""],[15282,1,""],[15282,0," sense."],[16105,78,""],[16061,70,""],[16060,1,""],[15154,25,""],[15154,0,"H"],[15154,1,""],[15154,0,"This is what it actually looks lik e"],[15189,1,""],[15188,1,""],[15188,0,"e in practice, but"],[15206,23,""],[15206,0," don't worry if it makes no sense. The"],[15244,21,""],[15244,0," set of people who do understand this code"],[15287,9,""],[15307,36,""],[15241,0,"I think "],[15249,1,""],[15249,0,"t"],[15304,0,"s"],[15304,1,""],[16845,0,". If you'"],[16853,1,""],[16853,0,"wan"],[16855,1,""],[16854,1,""],[16853,1,""],[16853,0," want to learn more, I gave a "],[16876,0,"["],[16884,0,"talk](https://invisiblecollege.s3-us-west-1.amazonaws.com/braid-meeting-10.mp4#t=300)"],[16888,0," a few weeks ago about this approach"],[17005,0,"."],[17005,1,""],[16883,0,"n informal"],[17015,0,", going into alot m"],[17033,1,""],[17032,1,""],[17031,1,""],[17030,1,""],[17029,1,""],[17029,0," lot more detail about how and *why "],[17064,1,""],[17064,0,"* CRDTs work li"],[17078,1,""],[17077,1,""],[17077,0,"this way."],[15678,10,""],[15678,0,"p"],[15451,10,""],[15451,0,"p"],[15670,0,"a"],[15452,0,"a"],[15672,0,"r"],[15453,0,"r"],[15674,0,"e"],[15454,0,"e"],[15676,0,"n"],[15455,0,"n"],[15678,0,"t"],[15456,0,"t"],[15378,4,""],[15378,0,"{}"],[15379,0,"P"],[15379,1,""],[15379,0,"parent"],[15379,0,"Id, "],[15389,0,", content"],[15379,1,""],[15379,0,"i"],[15382,0," seq,"],[15448,0,"Idx"],[15548,0,"Idx"],[15788,0,"Idx"],[15820,0,"Idx"],[15683,0,"Idx"],[15782,0,"IDx"],[15783,1,""],[15783,0,"d"],[15815,0,"Idx"],[15239,0," to you"],[15248,9,""],[15248,0,"T"],[15269,3,""],[15290,0," probably"],[15251,7,""],[15248,14,""],[15248,0,"We could probably fit everyone who"],[15293,0,"s"],[15304,13,""],[16346,27,""],[16346,0," with a few more comments"],[16690,0," "],[16690,1,""],[16664,3,""],[16664,0,"my"],[16884,1,""],[16884,0,"\n\n"],[16911,0," about all of this, and where those black magic "],[16941,18,""],[16941,0,"that black magic logic came from"],[16978,4,""],[16977,0,"gave "],[16983,1,""],[17116,0," at a braidjs meeting. In my talk I went"],[17156,8,""],[17156,0," "],[16912,62,""],[16911,1,""],[16911,0,","],[17060,0,"["],[17067,1,""],[17066,1,""],[17074,0,"](https://braid.org/)"],[17067,7,""],[17066,1,""],[17087,0," meeting"],[16921,16,""],[16921,0,"a talk"],[16927,16,""],[17069,0," a few weeks ago"],[17168,0," But"],[15384,26,""],[15383,1,""],[15382,1,""],[15368,5,""],[15326,10,""],[15326,0,"javascript"],[16313,6,""],[16313,0,", with "],[16339,1,""],[16475,8,""],[16475,0,"code"],[16475,4,""],[16475,0,"function"],[15343,18,""],[15343,0,"automergeInsert"],[16143,7,""],[17125,4,""],[16849,0,"'re interested in"],[16866,8,""],[16872,0,"ing"],[17055,82,""],[17057,0,"Bu"],[17058,1,""],[17057,1,""],[17057,0,"The important point is, "],[17081,1,""],[17081,0,"t"],[17108,5,""],[17108,0," a few"],[17114,3,""],[17079,1,""],[15307,0,"to"],[15308,1,""],[15307,1,""],[15278,0," on the planet"],[15329,0," meeting"],[15324,6,""],[15322,9,""],[15322,0,"my k"],[15325,1,""],[15325,0,"lounge"],[15331,1,""],[15331,0," "],[15325,6,""],[15325,0,"k"],[15324,2,""],[15322,2,""],[15322,0,"a meeting"],[16023,78,""],[15995,0," ..."],[15998,1,""],[15865,0,"newItem."],[15397,22,""],[15396,1,""],[15974,1,""],[15486,7,""],[15485,1,""],[15485,0,"\n  let i"],[15629,1,""],[15881,1,""],[15446,1,""],[15446,0,"\n  "],[15447,2,""],[15881,0,"\n  "],[15882,2,""],[15881,1,""],[15972,0,"\n  "],[15973,2,""],[15727,0," part"],[17032,18,""],[17450,0,"probably lots of "],[17473,4,""],[17473,0," all"],[17466,1,""],[17463,3,""],[17458,5,""],[17450,8,""],[17457,4,""],[17731,4,""],[17731,0,"Ths "],[17734,1,""],[17733,1,""],[17733,0,"is algorithm is"],[17775,141,""],[17518,0," In my reference-crdts codebase I have an implementation of both RGA (automerge) and YATA (yjs). Their performance in this test is identical.\n"],[17659,1,""],[17614,0," They share most of their code (ex"],[17647,1,""],[17647,0,"verything except this one function) and "],[17688,1,""],[17687,1,""],[17687,0,"t"],[17687,6,""],[17687,0,"their "],[17987,1,""],[17943,43,""],[15674,0," "],[15674,1,""],[15446,0," // SLOW"],[15453,1,""],[15452,1,""],[15451,1,""],[15450,1,""],[15450,0,"(slow)"],[15987,0," // (slow)"],[18986,0,"\n\nIe, the two lines I marked *"],[19015,1,""],[19015,0,"`*"],[19016,1,""],[19016,0,"(slow`"],[19021,1,""],[19021,0,")` in the code listing above."],[19835,6,""],[19835,0,"what index th"],[19847,1,""],[19846,1,""],[19846,0,"does that correspond to"],[19869,7,""],[20000,4,""],[20000,0,"I"],[20063,0,"linearly "],[21175,0," - which "],[21183,1,""],[21150,0,"linear "],[21190,0," is what we expect for "],[21209,4,""],[21209,0,"when "],[21182,32,""],[21269,11,""],[21269,0,"to"],[21278,1,""],[21277,1,""],[21276,1,""],[21343,12,""],[21343,0,"F"],[21343,1,""],[21343,0,"Changing data structures"],[21343,24,""],[21343,0,"Faster "],[21343,7,""],[21343,0,"F"],[21343,1,""],[21343,0,"Fix"],[21343,3,""],[21343,0,"Changing the data structure"],[15323,0," "],[15323,1,""],[15245,1,""],[15244,1,""],[15243,1,""],[15242,1,""],[15241,1,""],[15240,1,""],[15239,1,""],[15152,1,""],[15152,0,":"],[15154,176,""],[15153,1,""],[15153,0,"\n\n(But don't be alarmed if this makes"],[15185,5,""],[15185,0,"looks d"],[15191,1,""],[15191,0,"confusing - everyone who ca"],[15216,2,""],[15216,0,"understands this code "],[15203,35,""],[15203,0,"the peole"],[15211,1,""],[15210,1,""],[15210,0,"ple who understnad th"],[15218,13,""],[15218,0,"understand this code fit around a sm"],[15239,15,""],[15239,0,"today fit in a small meeting room.)"],[15245,0,"probably "],[16762,13,""],[16762,0,"goind e"],[16768,1,""],[16767,1,""],[16766,1,""],[16766,0,"g deeper on this"],[15203,0,"we could probably fit everyone"],[15233,10,""],[15248,0,"s"],[15265,13,""],[15234,0,"on the planet "],[15273,6,""],[15273,0," today"],[15282,0,"to"],[15421,4,""],[15421,0,"1"],[15959,4,""],[15959,0,"2"],[18915,0,"(&*"],[18917,1,""],[18916,1,""],[18915,1,""],[18915,0," (*1)"],[18919,1,""],[18918,1,""],[18917,1,""],[18916,1,""],[18915,1,""],[18959,17,""],[18959,0,"These are thw "],[18972,1,""],[18971,1,""],[18971,0,"e"],[18959,14,""],[18959,0,"These are the linkes"],[18959,64,""],[18959,0,"(These linesa re"],[18974,1,""],[18973,1,""],[18972,1,""],[18971,1,""],[18971,0," are marked (1) and (2) in the code listing above)."],[18983,0,"*"],[18987,0,"*"],[18996,0,"*"],[18993,0,"*"],[19028,0,"To understand why these lines are en"],[19063,1,""],[19062,1,""],[19046,16,""],[19046,0,"this is needed, "],[19062,1,""],[19062,0,"l"],[19051,0,"code "],[19058,7,""],[19058,0," necessary"],[19422,0,"Note, "],[19428,1,""],[19428,0,"s"],[19471,1,""],[19471,0,"."],[19473,3,""],[19422,4,""],[19422,0,"And"],[19425,1,""],[19522,0,"(Unfortunately "],[19537,1,""],[19537,0,"w"],[19403,1,""],[19402,1,""],[19402,0,"'seph', 1"],[20041,0,"So "],[20044,1,""],[20044,0,"i"],[21382,0,"\n\n"],[21383,0,"Why does the graph have this shape? Here's the "],[21396,5,""],[21396,0,"chart"],[21430,0,"graph of the e"],[21443,1,""],[21443,0,"ins"],[21443,3,""],[21443,0,"edit position for every change"],[21467,6,""],[21466,1,""],[21465,1,""],[21465,0,"y keyt"],[21470,1,""],[21470,0,"stroke."],[21476,1,""],[21476,0,", with the same averaging "],[21492,10,""],[21492,0,"bucketing and smoothing applied:"],[21525,0,"\n![reference crdts implementation zoomed in](ref_perf3.svg)"],[21570,9,""],[21570,0,"inspos"],[21528,40,""],[21528,0,"Editin"],[21533,1,""],[21532,1,""],[21532,0," position throughout document "],[21561,1,""],[21417,0," in particular"],[21392,3,""],[21392,0,"this"],[21434,0,"If we "],[21440,11,""],[21445,7,""],[21445,0," where"],[21452,0,"each "],[21461,29,""],[21461,0," happened throguhout"],[21471,10,""],[21471,0,"throughout the editing trace"],[21500,0," and use"],[21508,5,""],[21542,7,""],[21541,1,""],[21541,0,", the reusl"],[21551,1,""],[21550,1,""],[21549,1,""],[21549,0,"sult is remarkably familiar"],[21433,0," Thats "],[21433,7,""],[20241,23,""],[20241,0,", which "],[20248,1,""],[20242,6,""],[20241,1,""],[20241,0,", which is double yikes"],[20573,23,""],[20575,0," is actually super fast at this, so maybe its not"],[20624,8,""],[20624,0," using an"],[20650,0,"?"],[20651,49,""],[20651,0," Who knows!"],[20650,0," to implement an arra"],[20664,7,""],[20664,0,"Arras"],[20668,1,""],[20668,0,"ys"],[20588,0,"suspiciously "],[20601,6,""],[20613,0," part"],[20629,3,""],[20629,0,"v8 isn't"],[20637,4,""],[20698,0,"But the general rule is, "],[20723,1,""],[20723,0,"i"],[20702,0,"in fe"],[20706,1,""],[20705,1,""],[20705,0,"general"],[20712,19,""],[20773,0,"about "],[20976,32,""],[20975,1,""],[20974,1,""],[20974,0,"."],[20976,1,""],[20976,0,"I"],[21112,0,"The time taken to perform each insert looks "],[21155,1,""],[21155,0," like this. "],[21166,1,""],[21165,1,""],[21165,0,":"],[21166,221,""],[20959,15,""],[20959,0,"is reasonably fast, but"],[20981,2,""],[20981,0,"t"],[20983,1,""],[20983,0,"i"],[20983,1,""],[20983,0,"i"],[21172,1,""],[21119,53,""],[21119,0,"There's a lot going on here because inserts happened all over the document"],[21155,38,""],[21155,0,"Martin's editign ps"],[21173,1,""],[21172,1,""],[21171,1,""],[21170,1,""],[21169,1,""],[21169,0,"ng position bounced around the docuen"],[21205,1,""],[21204,1,""],[21204,0,"ment. But there's a l"],[21224,1,""],[21224,0,"strong linear trend up and to thr "],[21257,1,""],[21256,1,""],[21256,0,"e right, which is what we would expect for a"],[21299,1,""],[21298,1,""],[21297,1,""],[21296,1,""],[21295,1,""],[21295,0,"when each insert takes ("],[21318,1,""],[21318,0,"O(n) time ."],[21328,1,""],[21327,1,""],[21327,0,"."],[21318,0,"*"],[21323,0,"*"],[21300,5,""],[21306,0,"s"],[21312,1,""],[21324,1,""],[21324,0,":"],[21396,0,"performance get better near the end? And why"],[21440,15,""],[21472,0," simply"],[21486,0,"*"],[21492,0,"*"],[21543,3,""],[21543,0,"with"],[21547,4,""],[21433,33,""],[21432,1,""],[21387,0,"And why this shape in particular? And "],[21425,1,""],[21425,0,"w"],[21600,11,""],[21600,0,"eerily "],[38425,16,""],[38425,0,"are junk food for your inu"],[38450,1,""],[38450,0,"tuition"],[38404,9,""],[38404,0,"But"],[38453,0,"Remember, "],[38463,1,""],[38463,0,"w"],[38453,11,""],[38453,0,"W"],[38482,0,"still "],[21586,20,""],[21586,0,"we end up with the same cur"],[21601,12,""],[21601,0,"a very"],[21616,0," curve"],[39064,0," How we implement our alog"],[39089,1,""],[39088,1,""],[39088,0,"gorithms mat"],[39082,18,""],[39082,0,"things matters, "],[39097,1,""],[39096,1,""],[39096,0,"."],[39082,15,""],[39082,0,"our algorithms matters."],[39064,41,""],[39064,0," How we implement our algorithms matters."],[39064,1,""],[39064,0,"\n\n"],[39066,42,""],[38850,0," if we get creative with implementation"],[38875,0,"our "],[38893,0," strategies"],[38906,0,"With the right approach, "],[38931,1,""],[38931,0,"w"],[38942,0," CRDTs"],[38948,9,""],[38957,0,"that "],[38460,0,"The same data on "],[38477,4,""],[38476,1,""],[38474,2,""],[38474,0,"with"],[38494,15,""],[38411,5,""],[38411,0,"L"],[38469,5,""],[38469,0," on"],[38647,0,"some "],[39681,32,""],[39680,1,""],[39670,0,", no matter how "],[39682,4,""],[39682,0,"the e"],[39686,1,""],[39686,0,"teasing from my friends,"],[39693,0," I get"],[9982,6,""],[9982,0,"was using"],[9972,9,""],[9968,4,""],[9968,0,"nodejs"],[9998,1,""],[9998,0,"!"],[9979,6,""],[9979,0,"sitting on "],[9968,21,""],[9968,0,"tho"],[9970,1,""],[9970,0,"is code was using"],[9968,9,""],[9968,0,"automerge"],[10071,0,"["],[10082,0," benchmark](https://gist.github.com/josephg/13efc1444660c07870fcbd0b3e917638#file-js_baseline-js)"],[10267,3,""],[10267,0,"all the"],[10371,3,""],[10371,0,"is caa"],[10376,1,""],[10376,0,"pable of going"],[10390,3,""],[21788,0,"\n"],[21788,0,"\nThis te"],[21789,7,""],[21789,0,"So editing performance is dominated"],[21792,0,"the time spent applying changes"],[21823,19,""],[21836,0," by the time spent scanning f"],[21864,1,""],[21863,1,""],[21863,0," our document array."],[21864,3,""],[21864,0,"the"],[21876,0,"'s item"],[21879,5,""],[21836,0," (1) -"],[21842,3,""],[21841,1,""],[21840,1,""],[21839,1,""],[21838,1,""],[21837,1,""],[21836,1,""],[21836,0," by"],[21849,5,""],[21849,0,"it takes to"],[21868,1,""],[21867,1,""],[21866,1,""],[21865,1,""],[21865,0," through"],[21700,14,""],[21700,0,"the result is"],[21710,3,""],[21710,0," is"],[18801,17,""],[18801,0,"Death by 1000 scans"],[21790,6,""],[21790,0,"It looks like the"],[21907,0," Edits at the end of the document are much slower than edits at the start "],[21907,74,""],[1008,4,""],[1008,0,"like"],[1286,0," Operational Transformation"],[1299,1,""],[1299,0,"o"],[1299,1,""],[1299,0,"t"],[1287,1,""],[1287,0,"p"],[1287,1,""],[1287,0,"o"],[1774,0," that"],[2267,1,""],[2266,1,""],[2266,0," are"],[2305,0," black-box"],[2331,29,""],[2331,0,"concurrent end"],[2344,1,""],[2343,1,""],[2343,0,"dits"],[2354,10,""],[2354,0,"twp cli"],[2360,1,""],[2359,1,""],[2358,1,""],[2357,1,""],[2356,1,""],[2356,0,"o clients"],[2370,1,""],[2370,0," the same region of text at the e"],[2402,1,""],[2402,0,"same time,"],[2412,45,""],[2427,57,""],[2427,0,"Are they merged? Do they conflict"],[2444,0,"How? "],[2442,7,""],[2442,0,", or do the"],[2442,11,""],[2442,0,"? "],[2460,0,"? "],[2461,1,""],[2461,0," What are the rules?"],[2442,0,", na"],[2445,1,""],[2444,1,""],[2444,0,"and if so in what order"],[2469,18,""],[2495,0," white-box"],[2522,0," of the system"],[2542,0," programming"],[2609,29,""],[2609,0,"does it perform in different editing"],[2637,8,""],[2627,10,""],[2624,3,""],[2616,8,""],[2613,3,""],[2609,4,""],[2609,0,"optimized is it, and for what"],[2621,3,""],[2621,0," the code"],[2630,24,""],[2744,0,"*"],[2753,0,"*"],[2770,0,"*"],[2776,0,"*"],[2802,0,"Likewise "],[2811,1,""],[2811,0,"a"],[2811,4,""],[2833,0,"*"],[2842,0,"*"],[2859,0,"*"],[2865,0,"*"],[2872,11,""],[2872,0,"all"],[2872,3,""],[2872,0,"every implementation"],[2897,7,""],[2893,0," o"],[2894,1,""],[2893,1,""],[2893,0,"of the system "],[2921,48,""],[2921,0,"No mate"],[2927,1,""],[2927,0,"ter "],[2921,10,""],[2920,7,""],[2801,0," But no m"],[2802,8,""],[2802,0,"No matter how many tests you write, there are a"],[2838,11,""],[2838,0,"given enough time someone usually finds anohter"],[2878,7,""],[2878,0,"more bugs. And"],[2888,4,""],[2882,6,""],[2878,4,""],[2878,0,"anohter"],[2877,8,""],[2871,6,""],[2863,8,""],[2855,8,""],[2850,5,""],[2843,7,""],[2838,5,""],[2838,0,"there are a"],[2847,2,""],[2843,4,""],[2837,6,""],[2830,7,""],[2826,4,""],[2820,6,""],[2815,5,""],[2811,4,""],[2804,7,""],[2802,2,""],[2802,0,"But no m"],[2808,2,""],[2805,3,""],[2801,4,""],[2920,0," bugs."],[2920,0," No matter "],[2930,1,""],[2927,3,""],[2927,0,"e"],[2923,5,""],[2921,2,""],[2921,0,"If you wait long enough, somebody will find more"],[3006,12,""],[3006,0,"can design a"],[4284,9,""],[4284,0,"b"],[3152,9,""],[3152,0,"b"],[2317,9,""],[2317,0,"b"],[4269,0,"e"],[3145,0,"e"],[2318,0,"e"],[4272,0,"h"],[3147,0,"h"],[2319,0,"h"],[4275,0,"a"],[3149,0,"a"],[2320,0,"a"],[4278,0,"v"],[3151,0,"v"],[2321,0,"v"],[4281,0,"i"],[3153,0,"i"],[2322,0,"i"],[4284,0,"o"],[3155,0,"o"],[2323,0,"o"],[4287,0,"u"],[3157,0,"u"],[2324,0,"u"],[4290,0,"r"],[3159,0,"r"],[2325,0,"r"],[4284,9,""],[4284,0,"semantics"],[3152,9,""],[3152,0,"semantics"],[2317,9,""],[2317,0,"semantics"],[4284,9,""],[4284,0,"b"],[3152,9,""],[3152,0,"b"],[2317,9,""],[2317,0,"b"],[4269,0,"e"],[3145,0,"e"],[2318,0,"e"],[4272,0,"h"],[3147,0,"h"],[2319,0,"h"],[4275,0,"a"],[3149,0,"a"],[2320,0,"a"],[4278,0,"v"],[3151,0,"v"],[2321,0,"v"],[4281,0,"i"],[3153,0,"i"],[2322,0,"i"],[4284,0,"o"],[3155,0,"o"],[2323,0,"o"],[4287,0,"u"],[3157,0,"u"],[2324,0,"u"],[4290,0,"r"],[3159,0,"r"],[2325,0,"r"],[2833,1,""],[2841,1,""],[2857,1,""],[2862,1,""],[4770,0,"Thats "],[4789,1,""],[4789,0,"."],[4791,7,""],[4791,0,"N"],[4790,1,""],[4789,1,""],[4789,0,", which is "],[4800,1,""],[4800,0,"n"],[7598,1,""],[7630,1,""],[8175,9,""],[8175,0,"hebavi"],[8175,6,""],[8175,0,"behaviour"],[8186,3,""],[8186,0,"is defined by this algorithm"],[8261,1,""],[8855,0,")"],[25190,11,""],[25190,0,"P"],[18561,11,""],[18561,0,"P"],[10744,11,""],[10744,0,"P"],[25171,0,"l"],[18552,0,"l"],[10745,0,"l"],[25174,0,"a"],[18554,0,"a"],[10746,0,"a"],[25177,0,"i"],[18556,0,"i"],[10747,0,"i"],[25180,0,"n"],[18558,0,"n"],[10748,0,"n"],[25183,0," "],[18560,0," "],[10749,0," "],[25186,0,"s"],[18562,0,"s"],[10750,0,"s"],[25189,0,"t"],[18564,0,"t"],[10751,0,"t"],[25192,0,"r"],[18566,0,"r"],[10752,0,"r"],[25195,0,"i"],[18568,0,"i"],[10753,0,"i"],[25198,0,"n"],[18570,0,"n"],[10754,0,"n"],[25201,0,"g"],[18572,0,"g"],[10755,0,"g"],[25204,0," "],[18574,0," "],[10756,0," "],[25207,0,"e"],[18576,0,"e"],[10757,0,"e"],[25210,0,"d"],[18578,0,"d"],[10758,0,"d"],[25213,0,"i"],[18580,0,"i"],[10759,0,"i"],[25216,0,"t"],[18582,0,"t"],[10760,0,"t"],[25219,0,"s"],[18584,0,"s"],[10761,0,"s"],[25222,0," "],[18586,0," "],[10762,0," "],[25225,0,"i"],[18588,0,"i"],[10763,0,"i"],[25228,0,"n"],[18590,0,"n"],[10764,0,"n"],[25231,0," "],[18592,0," "],[10765,0," "],[25234,0,"J"],[18594,0,"J"],[10766,0,"J"],[25237,0,"S"],[18596,0,"S"],[10767,0,"S"],[25240,1,""],[18598,1,""],[10768,1,""],[25238,1,""],[18597,1,""],[10768,1,""],[25236,1,""],[18596,1,""],[10768,1,""],[25234,1,""],[18595,1,""],[10768,1,""],[25232,1,""],[18594,1,""],[10768,1,""],[25230,1,""],[18593,1,""],[10768,1,""],[25228,1,""],[18592,1,""],[10768,1,""],[25226,1,""],[18591,1,""],[10768,1,""],[25224,1,""],[18590,1,""],[10768,1,""],[25222,1,""],[18589,1,""],[10768,1,""],[25220,1,""],[18588,1,""],[10768,1,""],[25218,1,""],[18587,1,""],[10768,1,""],[25216,1,""],[18586,1,""],[10768,1,""],[17821,3,""],[17821,0,"Y"],[16853,3,""],[16853,0,"Y"],[16579,3,""],[16579,0,"Y"],[17818,0,"j"],[16852,0,"j"],[16580,0,"j"],[17821,0,"s"],[16854,0,"s"],[16581,0,"s"],[18525,3,""],[18525,0,"Yjs"],[25093,3,""],[25093,0,"Yjs"],[25902,3,""],[25902,0,"Y"],[25763,3,""],[25763,0,"Y"],[25696,3,""],[25696,0,"Y"],[25625,3,""],[25625,0,"Y"],[25466,3,""],[25466,0,"Y"],[25315,3,""],[25315,0,"Y"],[25893,0,"j"],[25756,0,"j"],[25691,0,"j"],[25622,0,"j"],[25465,0,"j"],[25316,0,"j"],[25899,0,"s"],[25761,0,"s"],[25695,0,"s"],[25625,0,"s"],[25467,0,"s"],[25317,0,"s"],[28925,1,""],[28925,0,"Y"],[29951,1,""],[29951,0,"Y"],[32737,0,"Y"],[32737,1,""],[32736,1,""],[32736,0,"Y"],[34155,3,""],[34155,0,"Y"],[33481,3,""],[33481,0,"Y"],[34154,0,"j"],[33482,0,"j"],[34156,0,"s"],[33483,0,"s"],[36906,0,"Yjs"],[36909,3,""],[44141,3,""],[44141,0,"Y"],[43164,3,""],[43164,0,"Y"],[42664,3,""],[42664,0,"Y"],[42601,3,""],[42601,0,"Y"],[42507,3,""],[42507,0,"Y"],[42405,3,""],[42405,0,"Y"],[44132,0,"j"],[43157,0,"j"],[42659,0,"j"],[42598,0,"j"],[42506,0,"j"],[42406,0,"j"],[44138,0,"s"],[43162,0,"s"],[42663,0,"s"],[42601,0,"s"],[42508,0,"s"],[42407,0,"s"],[46529,3,""],[46529,0,"Y"],[46463,3,""],[46463,0,"Y"],[46276,3,""],[46276,0,"Y"],[45730,3,""],[45730,0,"Y"],[46524,0,"j"],[46460,0,"j"],[46275,0,"j"],[45731,0,"j"],[46528,0,"s"],[46463,0,"s"],[46277,0,"s"],[45732,0,"s"],[46813,1,""],[46813,0,"Y"],[48288,3,""],[48288,0,"Y"],[47220,3,""],[47220,0,"Y"],[48287,0,"j"],[47221,0,"j"],[48289,0,"s"],[47222,0,"s"],[49416,3,""],[49416,0,"Yjs"],[51403,3,""],[51403,0,"Yjs"],[51521,3,""],[51521,0,"Y"],[51417,3,""],[51417,0,"Y"],[51520,0,"j"],[51418,0,"j"],[51522,0,"s"],[51419,0,"s"],[27509,0,"\n\n> And yes, I know, V9"],[27531,1,""],[27531,0,"8 d"],[27533,1,""],[27533,0,"tries its harr"],[27546,1,""],[27546,0,"dest to prevent this. But its not magic."],[27580,0,"made of "],[27566,0," sor t"],[27571,1,""],[27570,1,""],[27570,0,"t o fthi"],[27577,1,""],[27576,1,""],[27575,1,""],[27574,1,""],[27573,1,""],[27573,0,"f thing when it can"],[27606,8,""],[40084,0,"h"],[44228,0,"plain "],[44240,0," editing"],[47358,9,""],[47358,0,"b"],[46602,9,""],[46602,0,"b"],[46413,9,""],[46413,0,"b"],[46026,9,""],[46026,0,"b"],[45940,9,""],[45940,0,"b"],[47327,0,"e"],[46579,0,"e"],[46398,0,"e"],[46019,0,"e"],[45941,0,"e"],[47332,0,"h"],[46583,0,"h"],[46401,0,"h"],[46021,0,"h"],[45942,0,"h"],[47337,0,"a"],[46587,0,"a"],[46404,0,"a"],[46023,0,"a"],[45943,0,"a"],[47342,0,"v"],[46591,0,"v"],[46407,0,"v"],[46025,0,"v"],[45944,0,"v"],[47347,0,"i"],[46595,0,"i"],[46410,0,"i"],[46027,0,"i"],[45945,0,"i"],[47352,0,"o"],[46599,0,"o"],[46413,0,"o"],[46029,0,"o"],[45946,0,"o"],[47357,0,"u"],[46603,0,"u"],[46416,0,"u"],[46031,0,"u"],[45947,0,"u"],[47362,0,"r"],[46607,0,"r"],[46419,0,"r"],[46033,0,"r"],[45948,0,"r"],[45940,0,"merging "],[45940,0,"concurrent "],[46246,5,""],[46246,0," it"],[46618,0,"'s"],[30073,6,""],[30073,0,"range tree"],[30073,0,"["],[30084,0,"](https://en.wikipedia.org/wiki/Range_tree)"],[30190,0," "],[30190,1,""],[30190,0," "],[30190,1,""],[30192,0,"A "],[30193,1,""],[30192,1,""],[30192,0,"My range"],[30192,8,""],[30192,0,"And "],[30192,4,""],[30192,0,"I'm "],[30194,2,""],[30193,1,""],[30192,1,""],[30190,0," Inter"],[30191,5,""],[30191,0,"The range tree internl"],[30212,1,""],[30212,0,"ally uses a "],[30191,33,""],[30190,1,""],[30192,0,"The range tree is really"],[30192,24,""],[30192,0,"Under the hood, my range tree s "],[30223,1,""],[30222,1,""],[30222,0,"is acutall"],[30231,1,""],[30230,1,""],[30229,1,""],[30228,1,""],[30227,1,""],[30227,0,"ually j"],[30225,9,""],[30225,0,"actually just a b-tree. But "],[30253,1,""],[30253,0,"u"],[30241,0,"slightly modified "],[30266,4,""],[30267,1,""],[30267,0,"But u"],[30816,163,""],[30815,1,""],[30815,0,"\n> Does this have a name? I've been calling it a \"range tree\", but I think that name is [taken by another data structure](https://en.wikipedia.org/wiki/Range_tree)\n"],[30818,160,""],[30818,0,"I'm sure I didn't"],[30818,17,""],[30818,0,"I k"],[30820,1,""],[30819,1,""],[30818,1,""],[30818,0,"That wikipedia ari"],[30835,1,""],[30835,0,"ticle "],[30818,0,"This is a range tree, right? "],[30870,0,"its pretty"],[30870,0,"on range trees "],[30885,10,""],[30885,0,"is a pretty poor mat"],[30904,1,""],[30903,1,""],[30902,1,""],[30902,0,"description of what I'm doing here."],[30847,4,""],[30847,0,"The"],[30851,0,"["],[30884,0,"](https://en.wikipedia.org/wiki/Range_tree)"],[30940,4,""],[30940,0,"bad"],[30940,3,""],[30940,0,"weak"],[31295,1,""],[31295,0,"4"],[31377,1,""],[31377,0,"4"],[31632,1,""],[31632,0,"4"],[24677,0,"62"],[24678,1,""],[24677,1,""],[24676,1,""],[24675,1,""],[24675,0,"62"],[24653,0," by 3x,"],[24661,1,""],[24660,1,""],[24659,1,""],[24659,0,". ("],[24662,4,""],[24680,0,"k down to "],[24690,5,""],[24689,1,""],[24688,1,""],[24687,1,""],[24686,1,""],[24686,0," from 180"],[24694,1,""],[24693,1,""],[24692,1,""],[24691,1,""],[24690,1,""],[24689,1,""],[24688,1,""],[24687,1,""],[24686,1,""],[24685,1,""],[24684,1,""],[24683,1,""],[24682,1,""],[24681,1,""],[24666,3,""],[24665,1,""],[24665,0,"k down"],[24671,5,""],[24678,0,")."],[24667,0,"entries "],[33817,11,""],[33817,0,"Plain string edits in JS"],[33842,21,""],[33842,0,"        "],[25196,0,"*"],[18561,0,"*"],[10744,0,"*"],[25223,0,"*"],[18587,0,"*"],[10769,0,"*"],[25226,1,""],[18589,1,""],[10770,1,""],[25224,1,""],[18588,1,""],[10770,1,""],[37276,11,""],[37276,0,"Plain string edits in JS"],[37301,21,""],[37301,0,"        "],[34360,0,"![rust implementation in wasm vs Yjs](rust_perf6.svg)\n"],[34413,0,"\n"],[34462,1,""],[34462,0,"7"],[37541,1,""],[33993,1,""],[37539,1,""],[33992,1,""],[37537,1,""],[33991,1,""],[37536,0,"1"],[33991,0,"1"],[37538,0,"."],[33992,0,"."],[37540,0,"1"],[33993,0,"1"],[33368,2,""],[33368,0,"56"],[33392,0," over"],[33398,4,""],[33398,0,"1"],[33398,1,""],[33398,0,"5000"],[33466,1,""],[33466,0,"5"],[33466,1,""],[33466,0,"6"],[32935,0,"under "],[33929,1,""],[33928,1,""],[33928,0,"12"],[33929,1,""],[33929,0,"0"],[33929,1,""],[33929,0,"9"],[32930,14,""],[32930,0,"193"],[29972,42,""],[29972,0,"https://github.com/josephg/diamond-types"],[29970,0," a"],[29971,1,""],[29970,1,""],[29940,1,""],[29969,0," called D"],[29977,1,""],[29977,0,"[Diamond types"],[29978,1,""],[29978,0,"d"],[29978,1,""],[29978,0,"D"],[30036,19,""],[30036,0,"Diamond"],[30237,9,""],[32371,4,""],[32377,0," in an array"],[32389,9,""],[32382,1,""],[32382,0," fixed size"],[32411,16,""],[32411,0,"T"],[32411,1,""],[32411,0,"Inserting like t"],[32421,4,""],[32421,0,"with a structure like"],[32447,5,""],[32454,0,"s"],[32459,4,""],[32459,0,"a little bit of"],[32675,0,"And "],[32679,1,""],[32679,0,"w"],[32772,7,""],[32772,0,"reasonably "],[32634,10,""],[32665,0,"\n"],[32200,465,""],[32200,0,"Rust gives us total control over the memory layout, so we can pack everything in tightly. Unlike in the diagram, each leaf node in my b-tree stores a block of 32 entries, packed in a fixed size array in memory. Inserting with a structure like this results in a little bit of memcpy-ing, but a little bit of memcpy is fine. Memcpy is always faster than I think it will be - CPUs can copy several bytes per clock cycle. Its not the epic hunt of a main memory lookup."],[32665,0,"\n"],[32665,1,""],[32664,1,""],[32664,0,"\n\n"],[32779,0," I don't know "],[32779,14,""],[32666,0,"("],[32780,0,")"],[32666,1,""],[32779,1,""],[32779,0," I have no idea why thats "],[32780,25,""],[32779,1,""],[32778,1,""],[32778,0," on my computer."],[32785,8,""],[32785,0,"hardware"],[32774,4,""],[32774,0,"fast"],[31299,1,""],[31299,0,"3"],[31381,1,""],[31381,0,"3"],[31636,1,""],[31636,0,"3"],[33242,102,""],[33242,0,"https://github.com/josephg/diamond-types/blob/yjs-style/benches/yjs.rs"],[33165,0,"It gets even faster if we "],[33191,19,""],[33191,0,"skip wasm and "],[33165,21,""],[33165,0,"I"],[33180,0," and run this"],[33193,4,""],[33204,0," "],[33204,1,""],[33204,0,"th"],[33205,1,""],[33204,1,""],[33204,3,""],[33210,0,"ly"],[33212,9,""],[33214,26,""],[33213,1,""],[33212,1,""],[33204,0,"["],[33165,0,"It gets even faster "],[33185,1,""],[33185,0,"i"],[33196,0,"javascript and "],[33224,4,""],[33224,0,"the"],[33320,1,""],[33320,0,". Like t"],[33322,6,""],[33322,0,"Running natively"],[33247,0," through rust"],[33168,4,""],[33168,0,"goes"],[33215,0,"."],[33217,21,""],[33217,0,"The benchmark "],[33221,10,""],[33221,0,"same benchmark ported"],[33244,21,""],[33244,0,"to rust"],[33243,1,""],[33236,0,"["],[33324,21,""],[175,5,""],[175,0,"5000x"],[137,50,""],[131,0,"5000x faster "],[150,0,":"],[150,1,""],[149,1,""],[149,0,": A case study in optimization"],[131,13,""],[136,0," that go 5000 "],[149,1,""],[149,0,"x faster"],[131,0,"Making "],[143,8,""],[143,0," go"],[162,14,""],[162,0,"n"],[176,0," "],[176,1,""],[176,0," adventure"],[131,6,""],[131,0,"How I made a"],[148,4,""],[143,1,""],[142,1,""],[146,0,"s go"],[168,13,""],[131,4,""],[173,0," in optimization"],[9,54,""],[4639,0,"["],[4658,0,"](https://github.com/josephg/diamond-types)"],[4746,1,""],[4745,1,""],[4745,0,"54"],[4746,1,""],[4746,0,"6"],[4746,1,""],[4746,0,"4"],[4745,2,""],[4745,0,"65"],[4745,2,""],[4745,0,"54"],[4746,1,""],[4746,0,"6"],[4772,1,""],[4771,1,""],[4771,0,"45"],[4772,1,""],[4771,1,""],[4771,0,"56"],[4791,7,""],[4791,0," over"],[10703,1,""],[10702,1,""],[10701,1,""],[10700,1,""],[24670,1,""],[24669,1,""],[24669,0,"12"],[24643,1,""],[24643,0,"14"],[32672,0," I have no idea."],[32717,3,""],[32717,0,"bunch of"],[32756,0,"just "],[32768,18,""],[32756,12,""],[32756,0,"seemed "],[32762,1,""],[32756,7,""],[32756,0,"happened to be "],[32756,35,""],[32756,0,"ran the fastest."],[32673,16,""],[32756,0," I have no idea. "],[32772,1,""],[32771,1,""],[32771,0," why thats the best"],[32780,10,""],[32780,0," worked out to be the best."],[32743,4,""],[32750,1,""],[32749,1,""],[32748,1,""],[32740,8,""],[32740,0,"worked well"],[32851,0,"["],[32884,0,"](https://github.com/josephg/diamond-js)"],[33215,21,""],[33215,0,"I"],[33215,0,"Javascript and WASM is now a bottleneck. "],[33266,20,""],[33266,0," all that and run"],[33283,5,""],[33283,0," the"],[33320,70,""],[33320,0,"https://github.com/josephg/diamond-types/blob/42a8bc8fb4d44671147ccaf341eee18d77b2d532/benches/yjs.rs"],[33267,8,""],[33267,0,"javascd"],[33273,1,""],[33273,0,"ript"],[33289,5,""],[33301,9,""],[33301,0,"directly in rust"],[33426,0,", we"],[33443,3,""],[33443,0,"the"],[33443,3,""],[33443,0,"all"],[34463,4,""],[34463,0,"1394"],[34457,6,""],[34457,0,"results in "],[34599,0," -->"],[34546,0,"<!-- "],[34604,4,""],[34546,5,""],[34545,0,"\n"],[34545,0,"\nHm, lets zoom in a bit there and just "],[34546,8,""],[34546,0,"Oh, its so fast you can barely see it next to yjs ("],[34596,1,""],[34596,0,"*fleexxxx*. Lets"],[34636,6,""],[34635,1,""],[34634,1,""],[34633,1,""],[34633,0,"and bask in that flat line:"],[34549,0," what a pity."],[34563,1,""],[34563,0,"I"],[34570,0,"consistently "],[34622,0,"("],[34633,0,")"],[34719,7,""],[34687,1,""],[34687,0,":"],[34687,1,""],[34687,0,":"],[34736,0,"\n\nWell, nearly flat line. I have no idea what the jitteryness is "],[34800,1,""],[34797,3,""],[34777,4,""],[34777,0,"why its a bit"],[34790,4,""],[34801,1,""],[34800,1,""],[34799,1,""],[34798,1,""],[34798,0,"."],[34798,1,""],[34798,0," - though the s"],[34798,15,""],[34798,0,". Its probab"],[34800,10,""],[34800,0,"Maybe deletes are faster than inserts or something."],[34818,0,"slightly "],[34818,9,""],[34818,0,"marginally "],[34861,1,""],[34861,0,", so we're seeing the insert / delete ratio aga"],[34907,1,""],[34906,1,""],[34905,1,""],[34904,1,""],[34904,0,"."],[34904,0," pop out of the timing data"],[34849,12,""],[34848,1,""],[35140,1,""],[35140,0,"~4"],[35151,9,""],[35151,0,"again"],[34762,24,""],[34762,0,"I wonder if the"],[34777,4,""],[34785,0,"ness"],[34789,1,""],[34789,0," shows"],[34790,5,""],[34790,0,"is showing"],[34800,6,""],[34793,8,""],[34835,0," or something?"],[34849,71,""],[34744,0,"a "],[34737,114,""],[34736,1,""],[34736,0,"\n\nWell, a nearly flat line. I wonder if the jitteryness is deletes are marginally faster than inserts or something?"],[34773,78,""],[34773,0,"what that k"],[34783,1,""],[34783,0,"jitteryness is about?"],[34803,1,""],[34803,0,"..?"],[34808,0,"And remember ,this is"],[34820,1,""],[34821,0," "],[34829,0," "],[34830,9,""],[34866,14,""],[34880,10,""],[34880,0,"nodejs"],[34889,7,""],[34808,15,""],[34808,0,"T"],[34917,4,""],[34917,0," So"],[34943,0,"*"],[34948,0,"*"],[34959,4,""],[34959,0,"If"],[34994,0,"s"],[34996,4,""],[34996,0,"another"],[35083,7,""],[35092,0,"("],[35104,0,")"],[35121,0," that much"],[35156,0," memory"],[35197,16,""],[35197,0,"Eh, I "],[35196,60,""],[35198,131,""],[36323,0," "],[37654,1,""],[34108,1,""],[37652,1,""],[34107,1,""],[37651,0,"5"],[34107,0,"5"],[37653,0,"6"],[34108,0,"6"],[37825,1,""],[37824,1,""],[37823,1,""],[37823,0,"1.1"],[38175,374,""],[38174,0,"\n---\n"],[38715,43,""],[38715,0,":"],[38758,0,"But "],[38762,1,""],[38762,0,"l"],[38807,15,""],[38807,0,"O"],[38824,0," the data"],[44423,14,""],[44423,0,"diamond-types"],[44455,87,""],[44455,0,"https://github.com/josephg/diamond-types/tree/42a8bc8fb4d44671147ccaf341eee18d77b2d532"],[44566,0," RUSTFLAGS='-C target-cpu=native' "],[44620,70,""],[44694,0,"["],[44742,0,"](https://github.com/josephg/diamond-types/blob/42a8bc8fb4d44671147ccaf341eee18d77b2d532/src/list/doc.rs#L15)"],[44726,9,""],[44726,0,"list"],[44856,8,""],[44856,0,"look at memory statistics by running"],[44894,19,""],[44894,0,"cargo run --release --features memusage --example stats"],[44950,60,""],[44951,199,""],[45411,20,""],[45411,0,"M"],[45446,0,"\nMy rust crdt wasm wrapper anywhere."],[45446,36,""],[45446,0,"\n"],[45410,1,""],[45445,0,"\nThe charts were made on [ObservableHQ](https://observablehq.com/@josephg/crdt-algorithm-performance-benchmarks)."],[45297,113,""],[45332,0,"\n"],[45296,1,""],[45331,0,"\nYou'll also need `automerge-paper.json.gz` from [josephg/crdt-benchmarks](https://github.com/josephg/crdt-benchmarks) in order to run most of these tests. The reference-crdts benchmark depends on [crdts.ts from josephg/reference-crdts, at this version](https://github.com/josephg/reference-crdts/tree/fed747255df9d457e11f36575de555b39f07e909)"],[44953,343,""],[44988,0,"\n"],[44952,1,""],[44987,0,"\nFor my rust implementation results come from benchmarking [josephg/diamond-types, at this version](https://github.com/josephg/diamond-types/tree/42a8bc8fb4d44671147ccaf341eee18d77b2d532). Benchmark by running ` RUSTFLAGS='-C target-cpu=native' cargo criterion yjs`. The inline rope structure updates can be enabled or disabled by editing [the constant at the top of src/list/doc.rs](https://github.com/josephg/diamond-types/blob/42a8bc8fb4d44671147ccaf341eee18d77b2d532/src/list/doc.rs#L15). You can look at memory statistics by running `cargo run --release --features memusage --example stats`."],[44356,596,""],[44391,0,"\n"],[44355,1,""],[44390,1,""],[44355,0,"\n"],[44391,596,""],[44356,0,"For my rust implementation results come from benchmarking [josephg/diamond-types, at this version](https://github.com/josephg/diamond-types/tree/42a8bc8fb4d44671147ccaf341eee18d77b2d532). Benchmark by running ` RUSTFLAGS='-C target-cpu=native' cargo criterion yjs`. The inline rope structure updates can be enabled or disabled by editing [the constant at the top of src/list/doc.rs](https://github.com/josephg/diamond-types/blob/42a8bc8fb4d44671147ccaf341eee18d77b2d532/src/list/doc.rs#L15). You can look at memory statistics by running `cargo run --release --features memusage --example stats`.\n"],[44987,1,""],[44952,0,"\n"],[44988,0,"\n"],[44956,4,""],[44956,0,"diamond"],[44963,5,""],[44356,34,""],[44356,0,"My diamond benchmarking result"],[44386,23,""],[44386,0,"s were generated from"],[44356,51,""],[44356,0,"Diamond's benchmarks come from this repo"],[44386,10,""],[44926,33,""],[44926,0,"[This repository](https://github.com/josephg/diamond-js/tree/6e8a95670b651c0aaa7701a1a763778d3a486b0c) contains d"],[45038,1,""],[45038,0,"the diamond-js wrapp"],[45042,16,""],[45042,0,"wasm wrapper"],[44926,0,"Diamond is compiled"],[44937,8,""],[44937,0,"wrapped"],[44937,7,""],[44937,0,"compiled & "],[44947,1,""],[44946,1,""],[44946,0,"to wasm using "],[44961,4,""],[44961,0,"this"],[44966,10,""],[44966,0,"project"],[45059,0,", o"],[45061,1,""],[45061,0,"though I've bee"],[45061,15,""],[45061,0,"hardcoded to point to a local copy of diamond-types from git"],[45121,26,""],[45121,0,"."],[45466,0,"\n"],[45123,1,""],[45465,0,"\nDiamond is compiled to wasm using [this project](https://github.com/josephg/diamond-js/tree/6e8a95670b651c0aaa7701a1a763778d3a486b0c), hardcoded to point to a local copy of diamond-types from git."],[44926,197,""],[45268,0,"\n"],[44925,1,""],[45267,0,"\nDiamond's benchmarks come from [josephg/diamond-types, at this version](https://github.com/josephg/diamond-types/tree/42a8bc8fb4d44671147ccaf341eee18d77b2d532). Benchmark by running ` RUSTFLAGS='-C target-cpu=native' cargo criterion yjs`. The inline rope structure updates can be enabled or disabled by editing [the constant at the top of src/list/doc.rs](https://github.com/josephg/diamond-types/blob/42a8bc8fb4d44671147ccaf341eee18d77b2d532/src/list/doc.rs#L15). You can look at memory statistics by running `cargo run --release --features memusage --example stats`."],[44356,569,""],[44698,0,"\n"],[44355,1,""],[44697,1,""],[44355,0,"\n"],[44698,0,".\n"],[45467,1,""],[45311,7,""],[45311,0,"wrapper"],[45467,0," The bench"],[45471,6,""],[45471,0," wasm bundle is optimized with was"],[45502,3,""],[45502,0,"b"],[45502,1,""],[45502,0,"wasm-opt."],[45487,0,"also "],[45487,5,""],[45625,1,""],[43059,12,""],[43059,0,"Diamond"],[43089,0,"there's a lot of work before its "],[43118,4,""],[43118,0,"I have feature parity with "],[43145,76,""],[43153,1,""],[43153,0,"A"],[43224,0,"operation "],[43394,0," And they need to be optimized for"],[43404,0,"also "],[43433,0," loading and saving documents from "],[43394,74,""],[43394,0," And they also need to be optimized for loading and saving documents from "],[43394,74,""],[43394,0," Diamond is "],[43403,3,""],[43403,0,"does almost none of this "],[43395,0,"So far"],[43401,1,""],[43401,0," d"],[43434,1,""],[43434,0,"."],[43434,1,""],[43434,0," "],[43434,1,""],[43434,0," thankless work."],[43435,14,""],[43434,1,""],[43395,6,""],[43395,0,"At the time of writing,"],[47365,0,"\n\n"],[47366,0,"That said, there is one way in which Yjs has a definite edge over the other implemtn"],[47449,1,""],[47448,1,""],[47447,1,""],[47447,0,"mentations: Yjs doesn'st "],[47471,1,""],[47470,1,""],[47469,1,""],[47469,0,"t store "],[47442,15,""],[47432,10,""],[47432,0,"automerge"],[47447,14,""],[47447,0,"treats deletes"],[47447,14,""],[47447,0,"doesn't store which items in a document have been deleted. Only that they have"],[47521,0,"*"],[47526,0,"* b"],[47528,1,""],[47527,1,""],[47526,1,""],[47526,0," been* deleted. This is "],[47547,3,""],[47547,0,"has some weird implications:\n\n- "],[47577,2,""],[47577,0,"-"],[47259,12,""],[47259,0,"diamond"],[47359,0," I'm still"],[47364,5,""],[47364,0,"not sure if I want to. Kevin is probably right - I don't think this is something people ask for."],[47461,0,"\n---\n"],[47467,12,""],[47467,0,"T"],[47467,0,"Well, "],[47473,1,""],[47473,0,"t"],[47537,0,".Its n"],[47542,1,""],[47541,1,""],[47540,1,""],[47539,1,""],[47538,1,""],[47537,1,""],[47537,0,". And it has nothing to do with "],[47539,30,""],[47538,1,""],[47537,1,""],[47557,16,""],[47557,0,"*when* each item in a"],[47587,5,""],[47587,0," has"],[47678,0," Yjs needs to store much less information. Storing when "],[47721,13,""],[47721,0,"It takes about 500kb"],[47679,62,""],[47679,0,"Storing when each delete happened is weirdly large. Diamond's memory usage increases from 1.12mb to 2.34mb when I also to"],[47799,1,""],[47798,1,""],[47798,0,"store delet"],[47786,23,""],[47785,1,""],[47785,0,"."],[47731,0,"Thsi in"],[47737,1,""],[47736,1,""],[47735,1,""],[47734,1,""],[47734,0,"is"],[47735,1,""],[47734,1,""],[47733,1,""],[47733,0,"is increases"],[47745,1,""],[47745,0," d"],[47768,10,""],[47791,0,"\n"],[47731,4,""],[47731,0,"Adding this data"],[47803,0," I think I can optimize that further, but its not t"],[47853,1,""],[47853,0,"nothing."],[47845,3,""],[47845,0,"it aint"],[47852,4,""],[47862,0,"- Storing when each delete"],[47864,24,""],[47862,2,""],[47862,0,"-"],[47641,0," (Deletes are a "],[47643,14,""],[47643,0,"Yjs stores deletes as a state CRDT, not as a "],[47687,1,""],[47687,0,"n operation-based CRDT)."],[47818,9,""],[47818,0,"to"],[47808,4,""],[47808,0,"temporal deletes"],[47824,5,""],[47836,1,""],[47835,1,""],[47835,0," increases"],[47882,8,""],[47931,0," And it'll also have an impact on fil"],[47965,3,""],[47965,0,"storage"],[47965,0,"on-disk "],[47980,0," size."],[47988,0," Yjs can't do character-by-character repl"],[48025,4,""],[48025,0,"editing replays."],[47998,43,""],[47998,0," replay editing sessions"],[47999,0,"give you pretty time slider style "],[48033,7,""],[48048,1,""],[48048,0," replays. "],[48057,1,""],[48057,0," (Do people want that? I"],[48080,1,""],[48079,1,""],[48059,20,""],[48058,1,""],[48058,0,"(Maybe people don't want that, but its cool)"],[48101,0,"."],[48103,0,"\n- Yjs's "],[48111,1,""],[48110,1,""],[48109,1,""],[48109,0," needs to embed information about "],[48119,24,""],[48119,0,"RLE"],[48121,1,""],[48120,1,""],[48119,1,""],[48119,0,"run-length encode the deletes"],[48137,4,""],[48137,0,"information about which items have been "],[48183,1,""],[48182,1,""],[48182,0,"ed into the version field. In diamond, versions are small ("],[48240,1,""],[48239,1,""],[48234,5,""],[48234,0,"a few bytes. In yjs, versions are 4kb."],[48268,0,"~"],[48273,0," And thet"],[48281,1,""],[48281,0,"y grow over time."],[48297,0," "],[48297,1,""],[48297,0," as the document grows"],[48320,0," (B"],[48322,1,""],[48321,1,""],[48320,1,""],[48319,0,", and more items are "],[48319,21,""],[48321,0,"\n"],[48321,0,"\nThe master branch of diamond does"],[48351,4,""],[48351,0,"adds this information back"],[47883,0,"'m going to"],[47894,4,""],[47928,0,"'"],[47940,5,""],[47940,0,"T"],[47940,1,""],[47940,0,"I"],[47950,18,""],[47950,0," increase"],[47882,34,""],[47882,0,"There's room for more optimization"],[47942,3,""],[47956,0,"s the"],[47996,21,""],[47996,0,"do "],[47999,28,""],[47999,0,"per-keystroke editing"],[48028,0," or anything fancy like that"],[48058,45,""],[48057,1,""],[48190,3,""],[48189,1,""],[48188,1,""],[48187,1,""],[48187,0,"t"],[48187,1,""],[48187,0," tens of"],[48312,21,""],[48312,0,"tempo"],[48312,5,""],[48312,0,"del"],[48312,3,""],[48312,0,"temporal deletes, "],[48329,1,""],[48328,1,""],[48328,0,". I've been benchmarking out of a branch"],[48362,0,"special "],[48376,0," with this stuff disabled, to make the comparison "],[48411,0,"a fair"],[48417,3,""],[48429,0,"with yjs. But diamond"],[48443,0,"f"],[48443,1,""],[48443,0,"the released version of "],[48474,0," might end up a little bigger."],[48503,0," than you would expect"],[48509,16,""],[48509,0,"these benchmarks suggest"],[48534,0," I haven'd"],[48543,1,""],[48543,0,"t decided if it should be confi"],[48535,39,""],[48534,1,""],[48534,0," This is not diamond's final form."],[48535,33,""],[48534,1,""],[47801,6,""],[47801,0,"When I add"],[47839,0," "],[47839,1,""],[47839,0,", it"],[47841,13,""],[47853,0," increases"],[47882,1,""],[47882,0,"4"],[47895,0,"lots of "],[47911,5,""],[47911,0," further"],[47938,2,""],[47938,0,"this"],[47958,23,""],[47958,0,"O"],[47978,0," also increases"],[47958,0,"This will also impact "],[47980,1,""],[47980,0,"o"],[48000,16,""],[48000,0,". I won't be able to match"],[48001,25,""],[47555,1,""],[47554,1,""],[47553,1,""],[47552,1,""],[47551,1,""],[47551,0,"record"],[47644,0,"Aka, "],[47789,3,""],[47789,0,"has a "],[47808,0," impact on memory usage"],[47833,8,""],[47833,0,"A"],[47836,0,"ing"],[47867,1,""],[47867,0," b"],[47868,1,""],[47868,0,"pushes"],[47888,10,""],[47868,6,""],[47868,0,"increases"],[47912,1,""],[47912,0,"!"],[47913,115,""],[47831,0," and on-disk storage size"],[47941,0,"Without temporal deletes, "],[47977,2,""],[47977,0,"implement"],[48020,8,""],[48020,0,"other"],[48031,0," stuff"],[48048,0," (Maybe people "],[48056,7,""],[48056,0,"thats what people want?)"],[48079,0," Is it weird to have every keystroke recorded?"],[48105,0," errent "],[48112,1,""],[48111,1,""],[48110,1,""],[48109,1,""],[48109,0,"ant"],[48166,0," the"],[48149,11,""],[48155,4,""],[48213,0,"*"],[48221,0,"*"],[48343,0," This is still pretty s"],[48344,22,""],[48344,0,"Kevin assures me that deletes"],[48366,7,""],[48366,0,"this information is always small in practice, ubt "],[48415,1,""],[48414,1,""],[48413,1,""],[48412,1,""],[48412,0,"but I don't like"],[48416,12,""],[48416,0,"it still gives"],[48425,5,""],[48425,0,"makes me nervous."],[48417,1,""],[48416,1,""],[48415,1,""],[48415,0,"t"],[48415,1,""],[48415,0," this"],[48498,27,""],[48498,0,"This blos"],[48506,1,""],[48506,0,"g post is writte"],[48498,24,""],[48498,0,"All benchmarks in this blog post use "],[48535,4,""],[48535,0,"a"],[48552,0,"of diamond-types "],[48535,1,""],[48535,0,"the [yjs-style]"],[48550,8,""],[48549,1,""],[48556,0,"](https://github.com/josephg/diamond-types/tree/yjs-style)"],[48615,16,""],[48614,1,""],[48556,0," of diamond-types"],[48631,0,", where"],[48638,5,""],[48638,0," t"],[48639,1,""],[48638,1,""],[48650,0,"has been "],[48667,1,""],[48667,0,". This makes for"],[48683,8,""],[48690,0,"er"],[48712,1,""],[48712,0,", but"],[48717,4,""],[48721,0," final"],[48727,9,""],[48760,46,""],[48753,7,""],[48753,0,"be a little bigger than I've suggested above. YMMV."],[48798,6,""],[48798,0," Eh."],[48798,4,""],[47612,21,""],[47612,0,"whether each ti"],[47626,1,""],[47625,1,""],[47625,0,"item has been"],[47646,0," or not"],[47654,74,""],[47653,1,""],[47830,9,""],[47830,0,"doubles"],[38757,0,"\n"],[38757,0,"\nI"],[38758,1,""],[38758,0,"> Its cool"],[38760,8,""],[38760,0,"Huh - the jitterny"],[38777,1,""],[38776,1,""],[38776,0,"yness of yjs and rust-wasm kind of line up."],[38802,8,""],[38811,0," Periods when yjs is slow, rust-wasm gets faster. And vice versa. I wonder what thats "],[38896,1,""],[38895,1,""],[38895,0," is !?"],[38900,1,""],[38899,1,""],[38898,1,""],[38898,0,"!"],[38766,0," "],[38766,1,""],[38766,0,"look at the bottom two lines around 200 0"],[38806,1,""],[38805,1,""],[38805,0,",000. "],[38811,1,""],[38811,0,"T"],[38848,7,""],[38848,0,"mirror each other"],[38914,1,""],[38914,0,"."],[38915,15,""],[38914,1,""],[38929,0,"s"],[38930,8,""],[38930,0," going on there"],[38913,1,""],[38912,1,""],[38105,68,""],[39039,0,"\n\nThat, my friends, is how you make the computer do a lot less work."],[39039,1,""],[39040,0,"\n"],[39040,1,""],[39107,0,"\n"],[39985,0,"beautiful, flawed "],[40011,29,""],[40036,0," mooks"],[40041,1,""],[40041,0,"s"],[40733,13,""],[40733,0," I guess"],[40733,8,""],[40757,0," comes out of"],[40770,6,""],[40825,376,""],[41035,4,""],[41035,0,"And "],[41040,0," just thumbed my nose at them all and kept using O"],[41083,7,""],[41083,0,"work in"],[41089,1,""],[41088,1,""],[41087,1,""],[41087,0,"ing on Operational Tranform"],[41114,18,""],[41110,0,"s"],[41121,0," helped out"],[41132,4,""],[41210,0,"So"],[41211,1,""],[41210,1,""],[41918,0," U"],[41919,1,""],[41918,1,""],[41918,0," My contribution is using b-trees and pu"],[41957,1,""],[41956,1,""],[41955,1,""],[41943,0," RLE-"],[41948,1,""],[41947,1,""],[41947,0," "],[41944,4,""],[41944,0,"run-length encoded "],[41971,3,""],[41970,1,""],[41970,0," alongisde a "],[41971,12,""],[41971,0,"and rare-"],[41979,1,""],[41979,0,"ly-"],[41981,1,""],[41981,0," all"],[41975,10,""],[41974,1,""],[41974,0," clever indexing. And showing Kevin's list representation can be adapted to ang"],[42052,1,""],[42052,0," "],[42052,1,""],[42052,0,"y algorithm. I don't"],[42054,9,""],[42054,0,"CRDT algorithm"],[42070,7,""],[42070,0,"Nobody has noticed"],[42070,18,""],[42070,0,"I don't think anyone noticed that before."],[42012,0,"fast "],[42165,20,""],[42165,0,"figureou"],[42172,1,""],[42171,1,""],[42171,0,"d out how to make"],[42233,0," Gawsh."],[42234,7,""],[34763,43,""],[34770,2,""],[34770,0,"chart shows"],[34781,12,""],[34794,7,""],[34793,1,""],[34782,0,"javascript "],[34804,0,", called"],[34806,6,""],[34806,0,"calling into rust via"],[34832,20,""],[34781,0," the slow version. "],[34765,0,"And "],[34769,1,""],[34769,0,"t"],[34804,0,"This is"],[34809,2,""],[34809,0,"includes"],[34808,9,""],[34808,0," benchmark is run "],[34804,22,""],[34804,0,"For fairness this char"],[34804,22,""],[34804,0,"This chart is j"],[34818,1,""],[34818,0,"generea"],[34824,1,""],[34823,1,""],[34823,0,"ated via"],[34828,3,""],[34828,0,"from"],[34844,11,""],[34843,1,""],[34863,3,""],[34863,0,"through"],[34877,44,""],[34768,0," remember,"],[34800,0,"*"],[34805,0,"*"],[34888,41,""],[34952,4,""],[34952,0,"I wonder "],[34964,0," the gap is so big"],[35036,0,"know how to "],[35056,14,""],[35093,14,""],[35093,0," does WASM's"],[35126,19,""],[35126,0," slow it down that much?"],[35127,0,"reall"],[35131,1,""],[35130,1,""],[35129,1,""],[35128,1,""],[35127,1,""],[35019,0," really that"],[34965,17,""],[34965,0,"wasm is so much slower than native"],[34951,1,""],[34951,0,"\n\n"],[34953,17,""],[34953,0,"Why is WASM"],[34964,3,""],[34984,0," when I run it"],[35005,0,"ly"],[37816,1,""],[37815,1,""],[37814,1,""],[37814,0,"0.0"],[37816,1,""],[37816,0,"96"],[37822,1,""],[42468,0,"["],[42472,0,"](https://github.com/yjs/yjs)"],[42511,9,""],[42511,0,"o"],[42511,1,""],[42511,0,"solid"],[48464,3,""],[48464,0,"For now, the"],[48502,4,""],[48502,0,"has"],[48502,3,""],[48502,0,"includes"],[48529,0,"But "],[48533,1,""],[48533,0,"a"],[48570,3,""],[48570,0,"a"],[48666,34,""],[48666,0,"which works similarly to yhs"],[48693,1,""],[48692,1,""],[48692,0,"js"],[48678,12,""],[48678,0,"like"],[48686,0," intea"],[48691,1,""],[48690,1,""],[48689,1,""],[48689,0,"stead"],[48683,1,""],[48683,0,"Y"],[48780,18,""],[48780,0,"work differently"],[47955,1,""],[47955,0,", and makes the system about 20"],[47985,1,""],[47984,1,""],[47984,0,"10% slower."],[47985,1,""],[47984,1,""],[47984,0,"3"],[47984,1,""],[47984,0,"5"],[48710,10,""],[48710,0,"matches how"],[48725,0," works"],[48790,77,""],[48790,0,"these benchmarks might not be indicitive of diamond 1.0"],[48820,10,""],[48820,0,"indicative"],[48846,0," "],[48846,1,""],[48790,44,""],[48801,0," might be different"],[48811,9,""],[48811,0,"not m"],[48808,8,""],[48808,0,"not match"],[48808,9,""],[48808,0,"have a lisg"],[48818,1,""],[48817,1,""],[48816,1,""],[48815,1,""],[48815,0,"slightly different me"],[48835,1,""],[48834,1,""],[48834,0,"performance profile"],[48854,0," Eh."],[48854,4,""],[48854,0," Its "],[48854,5,""],[48854,0," (I"],[48856,1,""],[48855,1,""],[48855,0,"(E"],[48856,1,""],[48856,0,"There's plenty of puns here about diamond not being polished yet, but I'm not sharp enough for any of those"],[48947,16,""],[48947,0,"to make"],[48947,7,""],[48947,0,"for those right now)"],[48966,0,"."],[50313,413,""],[50312,1,""],[49964,7,""],[49964,0,"dim"],[49966,1,""],[49966,0,"amond yet"],[49975,5,""],[50113,9,""],[50113,0,"similar"],[50158,1,""],[50157,1,""],[50157,0,", an d"],[50162,1,""],[50161,1,""],[50160,1,""],[50159,1,""],[50159,0,"and "],[50163,14,""],[50198,5,""],[50198,0,"will probably appx"],[50215,1,""],[50215,0,"roximately"],[50264,0,"Maybe. "],[50270,0," Or maybe I'm wrong."],[50313,1,""],[50313,0,"."],[50315,5,""],[50315,0,"I"],[50158,0," modulo d"],[50166,1,""],[50166,0,"delete operations. "],[50184,1,""],[50159,6,""],[50159,0,"except for"],[50189,3,""],[50189,0,"And per"],[50195,1,""],[50194,1,""],[50193,1,""],[50192,1,""],[50189,5,""],[50189,0,"O"],[50189,1,""],[50189,0,"P"],[52645,5,""],[52645,0,"'m "],[52658,0,"ing"],[37525,30,""],[37525,0,"D"],[34007,30,""],[34007,0,"D"],[37497,0,"i"],[34008,0,"i"],[37499,0,"a"],[34009,0,"a"],[37501,0,"m"],[34010,0,"m"],[37503,0,"o"],[34011,0,"o"],[37505,0,"n"],[34012,0,"n"],[37507,0,"d"],[34013,0,"d"],[37509,0," "],[34014,0," "],[37511,0,"("],[34015,0,"("],[37513,0,"w"],[34016,0,"w"],[37515,0,"a"],[34017,0,"a"],[37517,0,"s"],[34018,0,"s"],[37519,0,"m"],[34019,0,"m"],[37520,1,""],[34019,1,""],[37518,1,""],[34018,1,""],[37517,0,"s"],[34018,0,"s"],[37519,0,"m"],[34019,0,"m"],[37521,0," "],[34020,0," "],[37523,0,"v"],[34021,0,"v"],[37525,0,"i"],[34022,0,"i"],[37527,0,"a"],[34023,0,"a"],[37529,0," "],[34024,0," "],[37531,0,"n"],[34025,0,"n"],[37533,0,"o"],[34026,0,"o"],[37535,0,"d"],[34027,0,"d"],[37537,0,"e"],[34028,0,"e"],[37539,0,"j"],[34029,0,"j"],[37541,0,"s"],[34030,0,"s"],[37543,0,")"],[34031,0,")"],[37545,0," "],[34032,0," "],[37547,0," "],[34033,0," "],[37549,0," "],[34034,0," "],[37551,0," "],[34035,0," "],[37553,0," "],[34036,0," "],[34032,5,""],[34034,0,"     "],[37605,13,""],[37605,0,"D"],[34070,13,""],[34070,0,"D"],[37594,0,"i"],[34071,0,"i"],[37596,0,"a"],[34072,0,"a"],[37598,0,"m"],[34073,0,"m"],[37600,0,"o"],[34074,0,"o"],[37602,0,"n"],[34075,0,"n"],[37604,0,"d"],[34076,0,"d"],[37606,0," "],[34077,0," "],[37608,0,"("],[34078,0,"("],[37610,0,"n"],[34079,0,"n"],[37612,0,"a"],[34080,0,"a"],[37614,0,"t"],[34081,0,"t"],[37616,0,"i"],[34082,0,"i"],[37618,0,"v"],[34083,0,"v"],[37620,0,"e"],[34084,0,"e"],[37622,0,")"],[34085,0,")"],[37625,3,""],[34090,3,""],[37767,4,""],[37767,0,"a"],[37767,1,""],[37767,0,"Diamond"],[37786,4,""],[37786,0," doc"],[37122,0," Lang"],[37126,1,""],[37125,1,""],[37124,1,""],[37123,1,""],[37123,0,"Language |"],[37213,0," -------- |"],[37304,0," JS       |"],[37395,0," JS       |"],[37486,0," JS       |"],[37577,0," JS       |"],[37668,0," JS       | JS       |"],[37679,11,""],[37759,0," JS       |"],[37850,0," JS       |"],[37944,0," JS       |"],[37913,1,""],[37912,1,""],[37911,1,""],[37669,2,""],[37669,0,"Rust/wasm"],[37677,1,""],[37676,1,""],[37675,1,""],[37674,1,""],[37674,0,"WASM"],[37678,6,""],[37761,2,""],[37761,0,"Rust"],[37765,1,""],[37673,1,""],[37673,0,"+"],[37678,0,"+JS"],[37673,5,""],[37676,0," "],[37767,1,""],[37851,2,""],[37851,0,"Rust"],[37855,2,""],[37942,2,""],[37942,0,"Rust"],[37946,2,""],[37673,1,""],[37673,0," iva"],[37676,1,""],[37675,1,""],[37674,1,""],[37674,0,"via "],[37130,1,""],[37129,1,""],[37128,1,""],[37127,1,""],[37127,0,"    "],[37106,14,""],[37106,0,"Data storage"],[37110,8,""],[37110,0,"          "],[37110,11,""],[37110,0," structure "],[33318,4,""],[33317,1,""],[34565,12,""],[34564,1,""],[34947,33,""],[34947,0,"4x slower than"],[34969,1,""],[34968,1,""],[34968,0," execution"],[35054,1,""],[35053,1,""],[35052,1,""],[35051,1,""],[35050,1,""],[35049,1,""],[35048,1,""],[35047,1,""],[35046,1,""],[35045,1,""],[35044,1,""],[35043,1,""],[35078,1,""],[35077,1,""],[35076,1,""],[35075,1,""],[35074,1,""],[35073,1,""],[35072,1,""],[35071,1,""],[35070,1,""],[35069,1,""],[35083,1,""],[35082,1,""],[35132,1,""],[35131,1,""],[35130,1,""],[35129,1,""],[35128,1,""],[35127,1,""],[35126,1,""],[35125,1,""],[35124,1,""],[35123,1,""],[37610,7,""],[37610,0,"+wasm"],[37610,5,""],[37610,0," via JS"],[37613,1,""],[37612,1,""],[37611,1,""],[37611,0,"+"],[38102,10,""],[38102,0,"keystrokes"],[38767,14,""],[38766,1,""],[38842,1,""],[38841,1,""],[38841,0,"gets"],[38850,0,"er"],[38873,0,"er"],[38905,1,""],[38904,1,""],[38903,1,""],[38902,1,""],[38901,1,""],[38901,0,"there"],[38854,9,""],[38854,0,"d"],[38795,9,""],[38795,0,"d"],[38847,0,"i"],[38796,0,"i"],[38849,0,"a"],[38797,0,"a"],[38851,0,"m"],[38798,0,"m"],[38853,0,"o"],[38799,0,"o"],[38855,0,"n"],[38800,0,"n"],[38857,0,"d"],[38801,0,"d"],[49011,4,""],[49011,0,"These"],[52128,20,""],[47921,19,""],[47921,0,"this data"],[47930,8,""],[47938,0," diamond's"],[48025,0,"Because it doesn't store "],[48050,8,""],[48025,43,""],[48029,0,"doen'"],[48033,1,""],[48032,1,""],[48032,0,"esn't "],[48037,1,""],[48036,1,""],[48035,1,""],[48034,1,""],[48033,1,""],[48032,1,""],[48032,0,"sn't store enough information to "],[48065,6,""],[48474,0,"basically "],[48508,1,""],[48508,0,". He might be right"],[48551,0," weirldy"],[48556,1,""],[48557,0,"l"],[52836,12,""],[52836,0,"diamond"],[52911,12,""],[52911,0,"diamond"],[53094,0," r"],[53095,1,""],[53095,0,"diamond's performance i"],[53117,1,""],[53116,1,""],[53117,4,""],[53117,0,"isn't just thanks to"],[53137,9,""],[31884,22,""],[31884,0,"Diamond"],[77,58,""],[77,0,"5000x faster CRDTs: An adventure in optimization"],[0,75,""],[50,0," -->"],[0,0,"<!-- "],[55,4,""],[0,5,""],[50,0,"\n\n<span class=m="],[65,1,""],[64,1,""],[64,0,"post-meta>July 31 2021</span>"],[21,1,""],[20,1,""],[20,0,"\n\n## "],[24,0,"$$"],[25,1,""],[24,1,""],[24,0,"##"],[26,1,""],[25,1,""],[24,1,""],[23,1,""],[22,1,""],[21,1,""],[20,1,""],[20,0,": "],[22,17,""],[22,0,"O"],[34,0," Adventures"],[34,11,""],[22,1,""],[22,0,"An adventure in o"],[38,1,""],[38,0,"O"],[25,1,""],[25,0,"A"],[55374,0,"\n\n---\n\nJoseph Gentle\n\n"],[55395,1,""],[55381,0,"["],[55395,0,"](https://josephg.com/)"],[55379,0,"\n<footer>"],[55428,0,"\n</fi"],[55432,1,""],[55432,0,"ooter>"],[55375,4,""],[55386,0,"Wri"],[55388,1,""],[55387,1,""],[55386,1,""],[55386,0,"By "],[55390,6,""],[55390,0,"Seph"],[55386,3,""],[55385,0,"\nSeph Gentle\n"],[55400,11,""],[55400,0,"https://josephg.com/"],[55399,0,"[https://josephg.com/](https://josephg.com/)\n\n"],[55454,11,""],[55454,0,"gt"],[55455,1,""],[55455,0,"ithub.com"],[55465,0,"josephg/"],[55475,20,""],[55475,0,"https://github.com/josephg/"],[55386,11,""],[55389,20,""],[55389,0,"Seph Gentle"],[55386,1,""],[55385,1,""],[55387,0,"2021 "],[37076,1,""],[37076,0,":"],[37833,1,""],[37742,1,""],[37651,1,""],[37560,1,""],[37467,1,""],[37376,1,""],[37285,1,""],[37194,1,""],[37103,1,""],[37012,1,""],[37823,1,""],[37733,1,""],[37643,1,""],[37553,1,""],[37461,1,""],[37371,1,""],[37281,1,""],[37191,1,""],[37101,1,""],[37011,1,""],[37813,1,""],[37724,1,""],[37635,1,""],[37546,1,""],[37455,1,""],[37366,1,""],[37277,1,""],[37188,1,""],[37099,1,""],[37010,1,""],[37803,1,""],[37715,1,""],[37627,1,""],[37539,1,""],[37449,1,""],[37361,1,""],[37273,1,""],[37185,1,""],[37097,1,""],[37009,1,""],[37793,1,""],[37706,1,""],[37619,1,""],[37532,1,""],[37443,1,""],[37356,1,""],[37269,1,""],[37182,1,""],[37095,1,""],[37008,1,""],[37783,1,""],[37697,1,""],[37611,1,""],[37525,1,""],[37437,1,""],[37351,1,""],[37265,1,""],[37179,1,""],[37093,1,""],[37007,1,""],[37773,1,""],[37688,1,""],[37603,1,""],[37518,1,""],[37431,1,""],[37346,1,""],[37261,1,""],[37176,1,""],[37091,1,""],[37006,1,""],[37763,1,""],[37679,1,""],[37595,1,""],[37511,1,""],[37425,1,""],[37341,1,""],[37257,1,""],[37173,1,""],[37089,1,""],[37005,1,""],[37753,1,""],[37670,1,""],[37587,1,""],[37504,1,""],[37419,1,""],[37336,1,""],[37253,1,""],[37170,1,""],[37087,1,""],[37004,1,""],[37743,1,""],[37661,1,""],[37579,1,""],[37497,1,""],[37413,1,""],[37331,1,""],[37249,1,""],[37167,1,""],[37085,1,""],[37003,1,""],[37733,1,""],[37652,1,""],[37571,1,""],[37490,1,""],[37407,1,""],[37326,1,""],[37245,1,""],[37164,1,""],[37083,1,""],[37002,1,""],[37483,1,""],[37482,1,""],[55262,0,"\n# Acknowledgements"],[55262,0,"\n"],[55283,0,"\n"],[55283,0,"\nTa"],[55285,1,""],[55285,0,"hanks fo"],[55292,1,""],[55291,1,""],[55291,0,"to everyone who gave "],[55284,28,""],[55284,0,"This work was made possible thanks to "],[55312,10,""],[55312,0,"as part of [braid](b"],[55331,1,""],[55331,0,"https:"],[55331,6,""],[55331,0,"https://braid.org/)"],[55323,0,"the "],[55328,1,""],[55328,0,"B"],[55333,0," project"],[55311,15,""],[55294,17,""],[55294,0,"is part of the"],[55344,0,", ufn"],[55348,1,""],[55347,1,""],[55346,1,""],[55345,1,""],[55344,1,""],[55344,0,", f"],[55346,1,""],[55345,1,""],[55344,1,""],[55344,0," and funded by the [Invisible College](https://invisible.college/).\n\nThankyou to everyone who gave feedback before ths"],[55461,1,""],[55460,1,""],[55460,0,"i"],[55460,1,""],[55460,0,"his post went live."],[55413,0,"Huge "],[55418,1,""],[55418,0,"t"],[55483,1,""],[55483,0,". And Parti"],[55489,5,""],[55489,0,"Martin and Kevin for "],[55506,4,""],[55505,1,""],[55489,0,"special thakns to "],[55497,10,""],[55497,0,"thanks to "],[55513,0," L"],[55514,1,""],[55514,0,"Kleppmann "],[55524,1,""],[55533,0," Jahns for their work on Automerge and Yjs. Diamond "],[55577,8,""],[55577,0,"This wouldn'"],[55582,7,""],[55582,0,"works "],[55587,1,""],[55586,1,""],[55289,4,""],[55289,0,"post"],[55411,0," We're hiring"],[55412,0,"If this is the sort of work you want to contribute towards, "],[55472,1,""],[55472,0,"w"],[55472,0," g"],[55473,1,""],[55472,1,""],[55472,0,"get in touch. "],[55486,1,""],[55486,0,"W"],[55498,0,"."],[55501,6,""],[55501,0,"T"],[55567,1,""],[55567,0,"\n\n"],[55661,9,""],[55661,0,"My CRDT is g"],[55672,1,""],[55672,0,"i"],[55672,1,""],[55672,0,"great because"],[55669,16,""],[55669,0,"is standing on the shoulders of ch"],[55702,1,""],[55701,1,""],[55701,0,"giants."],[55669,11,""],[55669,0,"stands"],[55703,0,"\n"],[55661,7,""],[55661,0,"Diamond"],[5490,25,""],[5490,0,"width=\"560\" height=\"315\" "],[5490,0,"min"],[5492,1,""],[5491,1,""],[5490,1,""],[5490,0,"max-"],[5506,0,"max-"],[5506,4,""],[5490,4,""],[5490,0,"min"],[5490,3,""],[5489,0," max-width: 10"],[5502,1,""],[5501,1,""],[5500,1,""],[5499,1,""],[5499,0,"=100\""],[5500,0,"\""],[5490,40,""],[5490,0,"class=\"typ"],[5499,1,""],[5498,1,""],[5497,1,""],[5497,0,"youtube\""],[5504,0,"-"],[5504,1,""],[3510,0,"#"],[5033,0,"#"],[11458,0,"#"],[38962,0,"#"],[42173,0,"##"],[43828,0,"##"],[45622,0,"#"],[45622,1,""],[43830,1,""],[42173,1,""],[53322,0,"#"],[55262,0,"#"],[250,0,"realtime "],[259,10,""],[259,0,"collaborative"],[280,0," (like google docs)"],[287,1,""],[287,0,"G"],[294,1,""],[294,0,"D"],[299,1,""],[299,0,". They implemented lots of algorithms ("],[338,15,""],[349,11,""],[349,0,")"],[349,0," stuff"],[356,0," and they"],[365,10,""],[378,0,"them "],[386,8,""],[386,0,"to see"],[391,1,""],[390,1,""],[389,1,""],[388,1,""],[387,1,""],[386,1,""],[386,0," to see how they perform"],[412,13,""],[412,0,"(Cool!!) "],[338,0,"["],[343,0,"](https://en.wikipedia.org/wiki/Conflict-free_replicated_data_type)"],[409,1,""],[345,64,""],[343,2,""],[338,1,""],[342,0,"s"],[337,1,""],[337,0," -"],[338,1,""],[337,1,""],[337,0,"- "],[351,0," algorithms and"],[372,1,""],[372,0,"."],[374,3,""],[374,0,"And"],[1712,10,""],[1712,0,"grad student"],[2078,0,"["],[2084,0,"](https://en.wikipedia.org/wiki/Conflict-free_replicated_data_type)"],[2078,0,"Conflict-Free"],[2078,13,""],[2151,0," (thats Conf-"],[2163,1,""],[2163,0,"lict-Free Replicated d"],[2184,1,""],[2184,0,"Data types"],[2057,0,"\nCRDTs are Conflict-Free Replicate D"],[2092,1,""],[2091,1,""],[2091,0,"d Data types. Basically, special algoit"],[2129,1,""],[2128,1,""],[2128,0,"rithms "],[2124,11,""],[2124,0,"constructions wihc"],[2141,1,""],[2140,1,""],[2140,0,"ch "],[2142,1,""],[2141,1,""],[2140,1,""],[2139,1,""],[2139,0,"i"],[2139,1,""],[2139,0,"hich let mutl"],[2151,1,""],[2150,1,""],[2150,0,"ltiple users "],[2148,15,""],[2148,0,"l"],[2148,1,""],[2148,0,"multiple computers / users all edit some data and "],[2194,4,""],[2194,0,"locally without "],[2202,8,""],[2202,0,"nee"],[2202,3,""],[2184,0,"the same data"],[2197,17,""],[2197,0," at the same time, and "],[2219,1,""],[2218,1,""],[2214,4,""],[2214,0,". Once the compuer"],[2231,1,""],[2230,1,""],[2230,0,"ters tell "],[2235,5,""],[2235,0,"share their changes with each other, they"],[2272,4,""],[2272,0,"everyone's copy "],[2215,73,""],[2215,0," "],[2215,1,""],[2214,1,""],[2214,0," without worrying about locking or \n"],[2058,191,""],[2058,0,"CRDTs are Conflict-Free Replicated Data types. Basically, special constructions which let multiple computers / users all edit the same data at the same time without worrying about locking or"],[2249,1,""],[2215,33,""],[2214,1,""],[2214,0,", without worrying about editing conflicts. They "],[2258,5,""],[2257,1,""],[2286,66,""],[2068,0,"["],[2104,0,"]((https://en.wikipedia.org/wiki/Conflict-free_replicated_data_type))"],[2172,1,""],[2105,1,""],[2347,1,""],[2352,45,""],[2352,0," "],[2325,0," They let you build peer-to-peer google docs, or "],[2331,3,""],[2331,0,"can let us"],[2341,4,""],[2377,0,"database replication without"],[2377,0,"make eventuallyc"],[2392,1,""],[2392,0,"-consistent "],[2412,0,"s"],[2413,20,""],[2413,0,"."],[2416,0,"But "],[2420,1,""],[2420,0,"w"],[2347,0," a"],[2384,0,"fast, "],[2184,0,"they're "],[2192,21,""],[2192,0,"fancy programming tricks"],[2235,12,""],[2241,4,""],[2286,0," s"],[2287,1,""],[2287,0,"locking or"],[2369,59,""],[2369,0,"realtime document editing. Or "],[2396,3,""],[2396,0,"So we can take google out of google docs, or "],[2431,0,"'s computers ou "],[2446,1,""],[2446,0,"t of google"],[2467,0,"add collaborative editing to Git."],[2496,1,""],[2496,0,"g"],[2210,6,""],[2210,0,"tools"],[2466,32,""],[2466,0,"do master-master replication without PAXOS"],[2494,14,""],[2483,0,"database "],[2503,0," was "],[2507,1,""],[2506,1,""],[2506,0,"y faster"],[2405,44,""],[2405,0,"do"],[2419,0," without google"],[2439,48,""],[2439,0,"add pair programming to git"],[2404,3,""],[2404,0," build"],[2437,0,"'s computers"],[2331,151,""],[2330,1,""],[2293,0,", without servers"],[2302,8,""],[2294,8,""],[2293,1,""],[2330,0," And "],[2334,1,""],[2334,0,", maybe, without servers."],[2351,0,"some "],[2362,1,""],[2362,0," in control over "],[2378,1,""],[2377,1,""],[2376,1,""],[2375,1,""],[2375,0,"f everything"],[2366,7,""],[2366,0,"charge"],[2336,5,""],[2336,0,"hopefully"],[2359,0," FAANG"],[2355,10,""],[2355,0,"somebody else's compue"],[2376,1,""],[2376,0,"ter (\"the cloud)"],[2391,1,""],[2391,0,"\")"],[2393,20,""],[2393,0," controlling"],[2394,0,"witnessing and "],[2394,14,""],[2394,0,"needing to"],[2405,11,""],[2405,0,"coordinate"],[2173,0,"Th"],[2174,1,""],[2173,1,""],[2058,0,"For the unitn"],[2070,1,""],[2069,1,""],[2069,0,"nitiated, "],[2079,10,""],[2079,0,"CRDTS "],[2086,0,"("],[2122,0,")"],[2190,20,""],[2190,0," are"],[2219,5,""],[2219,0,"to allow"],[2227,4,""],[2242,0," to"],[2219,2,""],[2219,0,"which let"],[2228,6,""],[2282,1,""],[2282,0,". And we can do it"],[2309,0,"worrying about "],[2331,0,", "],[2332,1,""],[2331,1,""],[2334,15,""],[2352,0,", or b"],[2357,1,""],[2357,0,"e"],[2357,1,""],[2356,1,""],[2355,1,""],[2354,1,""],[2353,1,""],[2352,1,""],[2352,0,". People don't even need to be online to "],[2352,41,""],[2352,0," or spotty internet connections"],[2356,0,"lag & "],[2360,1,""],[2360,0,"from"],[2394,23,""],[2394,0,"The best part of CRDT "],[2415,1,""],[2415,0,"s is you can do all that without needing"],[2494,8,""],[2497,0," monitor and"],[2324,11,""],[2445,1,""],[2445,0,"S"],[2454,1,""],[2454,0,"E"],[2461,1,""],[2461,0,"C"],[2445,25,""],[2445,0,"any central computer on "],[2466,2,""],[2466,0,"in"],[2469,1,""],[2480,1,""],[2496,10,""],[2496,0,"control"],[2244,3,""],[2284,3,""],[2284,0," they do it"],[2295,10,""],[2303,0," needing to"],[2322,1,""],[2321,1,""],[2320,1,""],[2347,0," locking or"],[2395,0," an"],[2397,1,""],[2396,1,""],[2396,0,"or anything like that"],[2444,0," that they"],[2454,8,""],[2290,6,""],[2290,0,"work "],[2302,23,""],[2281,112,""],[2281,0,"They let you work locally without the internet"],[2313,1,""],[2312,1,""],[2311,1,""],[2311,0," no lag (you don't even have to be online)"],[2353,13,""],[2354,0," And when you do sync up with other users / devices, everything is "],[2418,3,""],[2418,0,"just mai"],[2425,1,""],[2425,0,"gically"],[2418,0,"should "],[2418,7,""],[2432,0," syncs up and becomes eventually consistent."],[2532,0," even"],[2545,4,""],[2545,0," a"],[2568,1,""],[2577,1,""],[2555,0,"ized"],[2512,0," can"],[2620,0," (Like google) "],[2627,1,""],[2627,0,"G"],[2633,0," Docs"],[2622,0,"Ahem, "],[2628,4,""],[2620,22,""],[2318,0,"."],[2321,1,""],[2321,0,"Y"],[2397,1,""],[2397,0,"&"],[2372,4,""],[2372,0,"connect"],[2383,4,""],[2383,0,"to"],[2383,2,""],[2383,0,"with"],[2372,7,""],[2372,0,"sync"],[2621,0," Think, google docs without goog.e"],[2654,1,""],[2653,1,""],[2653,0,"le."],[2629,1,""],[2629,0,"G"],[2636,1,""],[2636,0,"D"],[2649,1,""],[2649,0,"G"],[2649,1,""],[2649,0,"g"],[2656,0," Or master-master replication without "],[2674,0,"database "],[2058,645,""],[2058,0,"For the uninitiated, CRDTS [(Conflict-Free Replicated Data types)](https://en.wikipedia.org/wiki/Conflict-free_replicated_data_type) are fancy programming tools which let multiple users edit the same data at the same time. They let you work locally with no lag. (You don't even have to be online). And when you do sync up with other users & devices, everything just magically syncs up and becomes eventually consistent. The best part of CRDTs is that they can do all that without even needing a centralized computer in the cloud to monitor and control everything. Think, Google Docs without google. Or master-master database replication without lag. Or seamless "],[2621,1,""],[2621,0,"\n\n"],[2623,98,""],[2623,0,"Think, Google Docs without google. Or master-master database replication without lag. Or seamless cross-device application data, with no startup"],[2760,0,"dodgy "],[2773,0,"'s servers "],[2745,5,""],[2745,0,"s"],[2752,0,"out"],[2756,8,""],[2756,0,"worrying that some"],[2793,0,"are going to go offline"],[2809,7,""],[2809,0,"dark in a couple years."],[2756,76,""],[2756,0,"relying on a flakey startup "],[2783,1,""],[2783,0,"'s sta"],[2788,1,""],[2787,1,""],[2787,0,"ervers to still be around in a decade."],[2817,0,"nother"],[2832,0,"\n"],[2832,0,"\nBut they're famously slow."],[2854,0,"really "],[2865,0,", so nobody really"],[2870,13,""],[2870,0,"basl"],[2873,1,""],[2873,0,"re"],[2874,1,""],[2873,1,""],[2872,1,""],[2872,0,"rely anyone use "],[2887,1,""],[2887,0,"s them"],[2894,0," Wel"],[2897,1,""],[2896,1,""],[2895,1,""],[2894,1,""],[2894,0," Well, "],[2895,6,""],[2895,0,"But they don't have to be!\n\nBut before we can even talk about that, "],[2923,40,""],[2923,0,"But before we can even talk about that,"],[2962,71,""],[2767,1,""],[2767,0,"some"],[2836,11,""],[2836,0,"For text editing they're"],[2836,0,"But "],[2840,1,""],[2840,0,"f"],[2623,6,""],[2623,0,"I want"],[2658,51,""],[2660,22,""],[2660,0," my"],[2664,12,""],[2664,0,"apps to seamlessly work "],[2683,5,""],[2683,0,"share data between all my devices"],[2725,0," me needing to"],[2746,1,""],[2745,1,""],[2744,1,""],[2658,5,""],[2658,0,"I want my"],[2757,0,"["],[2772,0,"](https://ourincrediblejourney.tumblr.com/)"],[2865,3,""],[2865,0,"For"],[2868,4,""],[2888,1,""],[2887,1,""],[2887,0,"ve been"],[2915,0," for a de"],[2923,1,""],[2922,1,""],[2921,1,""],[2920,1,""],[2920,0,"years"],[2881,0," (and other rel"],[2895,1,""],[2895,0,"al application data)"],[2881,34,""],[2915,0," "],[2915,1,""],[2915,0," and clunky"],[2966,26,""],[2966,0,"Well, until now. "],[2982,1,""],[2083,1,""],[2083,0,"s"],[2058,925,""],[2057,1,""],[3589,0,"\n\nFor the uninitiated, CRDTs [(Conflict-Free Replicated Data types)](https://en.wikipedia.org/wiki/Conflict-free_replicated_data_type) are fancy programming tools which let multiple users edit the same data at the same time. They let you work locally with no lag. (You don't even have to be online). And when you do sync up with other users & devices, everything just magically syncs up and becomes eventually consistent. The best part of CRDTs is that they can do all that without even needing a centralized computer in the cloud to monitor and control everything.\n\nI want Google Docs without google. I want my apps to seamlessly share data between all my devices, without me needing to rely on some [flakey startup](https://ourincrediblejourney.tumblr.com/)'s servers to still be around in another decade.\n\nFor text editing they've been famously really slow and clunky for years, so barely anyone uses them. Well, until now.\n\n"],[4584,1,""],[4584,0,"\n\n\n"],[4584,0,"\n"],[4518,1,""],[4583,0,"\n"],[4517,1,""],[4582,0,"\n"],[4516,1,""],[4581,0,"\nFor text editing they've been famously really slow and clunky for years, so barely anyone uses them. Well, until now."],[4398,118,""],[4463,0,"\n"],[4397,1,""],[4462,0,"\nI want Google Docs without google. I want my apps to seamlessly share data between all my devices, without me needing to rely on some [flakey startup](https://ourincrediblejourney.tumblr.com/)'s servers to still be around in another decade."],[4156,241,""],[4221,0,"\n"],[4155,1,""],[4220,0,"\nFor the uninitiated, CRDTs [(Conflict-Free Replicated Data types)](https://en.wikipedia.org/wiki/Conflict-free_replicated_data_type) are fancy programming tools which let multiple users edit the same data at the same time. They let you work locally with no lag. (You don't even have to be online). And when you do sync up with other users & devices, everything just magically syncs up and becomes eventually consistent. The best part of CRDTs is that they can do all that without even needing a centralized computer in the cloud to monitor and control everything."],[3591,564,""],[3656,1,""],[3656,0," "],[4464,118,""],[4468,1,""],[4467,1,""],[4466,1,""],[4465,1,""],[4464,1,""],[4647,1,""],[4647,0,"\n\nBut "],[4653,1,""],[4653,0,"m"],[4712,6,""],[4712,0,". "],[4714,1,""],[4714,0,"A"],[4648,0,"\n"],[4648,0,"\n"],[4648,1,""],[4647,1,""],[5195,0,"\n\n\n"],[2058,42,""],[2058,0,"Even talking about this we"],[2082,0,"stuff "],[2591,2,""],[2591,0,"somebody's"],[2602,14,""],[2602,0,"code"],[2992,4,""],[2992,0,"Years ago I"],[3375,3,""],[3375,0,"a"],[4215,241,""],[4215,0,"I want Google Docs without google. I want my apps to seamlessly share data between all my devices, without me needing to rely on some [flakey startup](https://ourincrediblejourney.tumblr.com/)'s servers to still be around in another decade."],[4215,424,""],[4215,0,"I want Google Docs without google. I want my apps to seamlessly share data between all my devices, without me needing to rely on some [flakey startup](https://ourincrediblejourney.tumblr.com/)'s servers to still be around in another decade. I think they're the [future of collaborative editing](https://josephg.com/blog/crdts-are-the-future/). And maybe the future of all software - but I'm not ready to talk about that yet."],[5189,1,""],[5188,1,""],[5187,1,""],[2591,8,""],[2591,0,"some academic"],[2649,4,""],[2649,0,"teach"],[5895,0,"\n"],[56432,0," "],[56432,1,""],[56432,0," "],[56432,1,""],[35738,0,"Aside: "],[35738,7,""],[35927,0," "],[35927,1,""],[35927,0," I'm so curious!"],[56585,0,"\n[Discuss on HN](https://news.ycombinator.com/item?id=28017204)"],[56594,0,"ion"],[56601,2,""],[56601,0,"Hacker News"],[56596,1,""],[56595,1,""],[56594,1,""],[56593,1,""],[56593,0,"s"],[56587,9,""],[56587,0,"O"],[56587,1,""],[56587,0,"Discuss o"],[56657,1,""],[56586,0,"\n"],[56658,9,""],[56587,0,"<footer>\n"],[56667,1,""],[56596,0,"\n"],[56668,41,""],[56597,0,"[2021 Seph Gentle](https://josephg.com/)\n"],[56709,1,""],[56638,0,"\n"],[56710,59,""],[56639,0,"[https://github.com/josephg/](https://github.com/josephg/)\n"],[56769,1,""],[56698,0,"\n"],[56770,0,"\n"],[56700,7,""],[56700,0,"W"],[56700,1,""],[56700,0,"See al"],[56769,0,"\n"],[56698,1,""],[56768,0,"\n[https://github.com/josephg/](https://github.com/josephg/)"],[56639,59,""],[56709,0,"\n"],[56638,1,""],[56708,0,"\n[2021 Seph Gentle](https://josephg.com/)"],[56597,41,""],[56667,0,"\n"],[56596,1,""],[56666,0,"\n<footer>"],[56587,9,""],[56657,0,"\n"],[56586,1,""],[56768,1,""],[56587,9,""],[56587,0,"S"],[56587,1,""],[56587,0,"And lots "],[56587,9,""],[56587,0,"Read feedback on"],[56587,6,""],[56587,0,"F"],[56587,1,""],[56587,0,"Read f"],[56587,6,""],[56587,0,"F"],[56595,0," is"],[56587,0,"Lots of "],[56587,23,""],[56587,0,"Comments on "],[16813,1,""],[16834,1,""],[27613,10,""],[27613,0,"s"],[20654,1,""],[20698,0,"t"],[20698,1,""],[20698,0,"n"],[20698,1,""]],"_dtSpan":[0,1104627]}]}
